{"createdAt":"2025-10-18T21:11:42.749Z","updatedAt":"2025-10-20T00:58:57.706Z","id":"6mhPJfmzP0N7PjKy","name":"MASTER - REFACTORIZACION","active":false,"isArchived":true,"nodes":[{"parameters":{"dataToSave":{"values":[{"key":"conversationId","value":"={{ $json.body.id }}"},{"key":"contactNumber","value":"={{ $json.body.contact_inbox.source_id }}"}]}},"type":"n8n-nodes-base.executionData","typeVersion":1,"position":[-6880,1440],"id":"1e7a032f-11a5-4928-bd64-81eded7e4621","name":"Execution Data1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"057155d2-7320-48de-8ed5-bf00dcc72b38","leftValue":"={{ $json.body.messages[0].sender.phone_number }}","rightValue":"+5492213994411","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"d0c07208-2eca-4ffc-ae49-063a0363cf6e","leftValue":"={{ $json.body.messages[0].sender.phone_number }}","rightValue":"+595985624358","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"c20fad56-f470-4653-b327-8ce2b684deaa","leftValue":"={{ $json.body.messages[0].sender.phone_number }}","rightValue":"+5492254596618","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"41ecf46b-61e9-4d1b-9bc9-9ed63e9817e3","leftValue":"={{ $json.body.messages[0].sender.phone_number }}","rightValue":"+34629235015","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"or"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[-6880,1632],"id":"dc41800a-de5d-4ad4-8a16-ba74dda65b9f","name":"Filtrar nÃºmeros de prueba","disabled":true},{"parameters":{"assignments":{"assignments":[{"id":"16d8fd1f-7293-45ec-ba41-6041979d7964","name":"accountId","value":"={{ $json.body.messages[0].account_id }}","type":"number"},{"id":"a8eb17ea-8fda-42e5-9f1c-444826a21e51","name":"message","value":"={{ $json.body.messages[0].content }}","type":"string"},{"id":"3fe92852-b569-426e-bef7-b755cf44ddc9","name":"inboxId","value":"={{ $json.body.contact_inbox.inbox_id }}","type":"number"},{"id":"96fa0ac2-a17b-452c-bf67-cc0f3bd5d4a2","name":"contactId","value":"={{ $json.body.messages[0].sender.id }}","type":"number"},{"id":"0d77d8b4-ec6d-42e0-8a5b-fdf1b78b454d","name":"contactName","value":"={{ $json.body.messages[0].sender.name }}","type":"string"},{"id":"25487cfb-897d-4000-9ad6-99745966c526","name":"contactNumber","value":"={{ $json.body.messages[0].sender.phone_number }}","type":"string"},{"id":"1e1b0044-b199-44e0-927b-c2cabe2a281b","name":"agentId","value":"=","type":"number"},{"id":"ad5ef314-70d7-4790-b82e-ea96a340ae12","name":"agentName","value":"=","type":"string"},{"id":"f4bc6964-862e-4168-8bae-94e6c6ad8321","name":"eventType","value":"={{ $json.body.event }}","type":"string"},{"id":"ef4c85e4-0029-4d70-ade1-0de74711b804","name":"conversationId","value":"={{ $json.body.id }}","type":"number"},{"id":"be91191b-7e8a-4406-af97-0a18e8100e7f","name":"multimedia","value":"={{ $json?.body?.messages?.[0]?.attachments?.[0]?.file_type ? true : false }}","type":"boolean"},{"id":"a3202993-c215-4502-bf56-e7e644b35a88","name":"humano","value":"={{ $json.body.custom_attributes.humano }}","type":"boolean"},{"id":"3da45859-4092-4b0c-bba3-c8898b649491","name":"messagesId","value":"={{ $json.body.messages[0].id }}","type":"number"},{"id":"24592e90-360f-4a9c-8271-1119ba300be1","name":"timestamp","value":"={{ $json.body.timestamp }}","type":"number"},{"id":"e01eb0b6-2e60-4ade-a4ba-949e30df02a5","name":"multimediaUrl","value":"={{ $json.body.messages[0].attachments[0].data_url }}","type":"string"},{"id":"1225af59-1b61-42dc-8052-296978708c1a","name":"agenteBotTokenWhatsapp","value":"JFi43nzvEPDBCaxaFrkhVvdM","type":"string"},{"id":"2e74ddde-5f26-4b0c-a6dc-32eb8e83874f","name":"chatwootUrl","value":"https://chatw.automatizaciones.ai","type":"string"},{"id":"f6ac5f40-5ce8-43a8-b07a-44c1453e86bf","name":"content_type","value":"={{ $('Entrada').first().json.body.messages[0].content_type }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-6640,1632],"id":"fa3b665c-f78a-4e03-b347-0b99312bee6b","name":"variables","onError":"continueRegularOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"0db9a125-ce45-48fe-b722-efbed0fc42a4","leftValue":"={{ $json.body.messages[0].sender.type }}","rightValue":"agent_bot","operator":{"type":"string","operation":"notEquals"}},{"id":"7d71d302-596d-4330-b68c-1b0502f6c7cd","leftValue":"={{ $json.body.event }}","rightValue":"message_created","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"12a51caa-5e4c-46f3-a067-79f0a52ca94b","leftValue":"={{ $json.body.messages[0].attachments[0].file_type }}","rightValue":"=file","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"or"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[-6064,1776],"id":"4c7edbe0-5c90-467e-a369-6c885c94f0bc","name":"Filter1"},{"parameters":{"httpMethod":"POST","path":"66a17f0c-9e2d-4d8e-87ca-1a8baf6f15ed","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-7104,1536],"id":"f1a0c279-6382-4abe-9ad9-22700c89d157","name":"Entrada","webhookId":"66a17f0c-9e2d-4d8e-87ca-1a8baf6f15ed"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"*ðŸ“ REGISTRO DE NUEVO PACIENTE*\\n\\n*AL SER TU PRIMERA VEZ, NECESITAMOS TUS DATOS:*\\n\\nâ†’ NOMBRE Y APELLIDO\\nâ†’ DNI\\nâ†’ OBRA SOCIAL\\nâ†’ TELÃ‰FONO\\nâ†’ DOMICILIO\\n\\n*ðŸ“‹ FORMATO:*\\nENVIÃ TUS DATOS EN UN SOLO MENSAJE, ASÃ:\\n\\n_JUAN PEREZ_\\n_35946257_\\n_OSDE_\\n_2214567890_\\n_CALLE 50 NÂ°123, LA PLATA_\\n\\nðŸ‘‡ *ESCRIBÃ TUS DATOS Y ENVIALOS*\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"volver-atras\",\n            \"title\": \"VOLVER ATRAS\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[720,2912],"id":"9027235f-a311-44ed-85a2-94517610c33a","name":"Primera vez INS.","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[-5776,3040],"id":"085278ef-2e4c-4ef2-8715-b9c50279079d","name":"When clicking â€˜Execute workflowâ€™"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').item.json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"list\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ðŸ«€ INSTITUTO DE CARDIOLOGÃA LA PLATA\"\n    },\n    \"body\": {\n      \"text\": \"ðŸ“‹ MENÃš PRINCIPAL\\n\\nPRESIONÃ 'ABRIR MENÃš' Y ELEGÃ UNA OPCIÃ“N:\\n\\nâ†’ ðŸ• HORARIOS DE ATENCIÃ“N\\n\\nâ†’ ðŸ“ UBICACIÃ“N DE LA CLÃNICA\\n\\nâ†’ ðŸ’» PORTAL DE PACIENTES\\n\\nâ†’ ðŸ“§ SOLICITAR RECETAS\\n\\nâ†’ ðŸ‘¨â€âš•ï¸ NUESTROS MÃ‰DICOS\\n\\nâ†’ ðŸ©º ESPECIALIDADES MÃ‰DICAS\"\n    },\n    \"footer\": {\n      \"text\": \"ðŸ“… LUN-VIE 8-20HS\"\n    },\n    \"action\": {\n      \"button\": \"ABRIR MENÃš\",\n      \"sections\": [\n        {\n          \"title\": \"ELEGÃ UNA OPCIÃ“N ðŸ‘‡\",\n          \"rows\": [\n            {\n              \"id\": \"horarios\",\n              \"title\": \"ðŸ• HORARIOS\",\n              \"description\": \"â†’ HORARIOS DE ATENCIÃ“N\"\n            },\n            {\n              \"id\": \"direccion\",\n              \"title\": \"ðŸ“ DIRECCIÃ“N\",\n              \"description\": \"â†’ UBICACIÃ“N ICLP\"\n            },\n            {\n              \"id\": \"portal-paciente\",\n              \"title\": \"ðŸ’» PORTAL PACIENTES\",\n              \"description\": \"â†’ ACCESO AL PORTAL\"\n            },\n            {\n              \"id\": \"email-recetas\",\n              \"title\": \"ðŸ“§ EMAIL RECETAS\",\n              \"description\": \"â†’ SOLICITAR RECETAS\"\n            },\n            {\n              \"id\": \"medicos\",\n              \"title\": \"ðŸ‘¨â€âš•ï¸ MÃ‰DICOS\",\n              \"description\": \"â†’ VER ESPECIALISTAS\"\n            },\n            {\n              \"id\": \"especialidades\",\n              \"title\": \"ðŸ©º ESPECIALIDADES\",\n              \"description\": \"â†’ LISTA COMPLETA\"\n            }\n          ]\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[720,672],"id":"20d87d23-48af-48c8-8357-4bfe41a55358","name":"â„¹ï¸ Info General","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').item.json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ðŸ«€ INSTITUTO DE CARDIOLOGÃA LA PLATA\"\n    },\n    \"body\": {\n      \"text\": \"ðŸ¢ ADMINISTRACIÃ“N\\n\\nTE CONECTAREMOS CON UNA RECEPCIONISTA PARA:\\n\\nâœ… REPROGRAMAR UN TURNO\\nâœ… CONSULTAS O RECLAMOS URGENTES\\nâœ… DERIVACIÃ“N URGENTE\\n\\nâ° HORARIO DE RESPUESTA:\\nLUNES A VIERNES: 8-20HS | SÃBADO 8-13HS\\n\\nðŸ’¡ SI NECESITÃS:\\n- AGENDAR UN TURNO NUEVO â†’ USÃ EL BOT (MÃS RÃPIDO)\\n- CANCELAR UN TURNO â†’ USÃ EL BOT\\n- INFO GENERAL â†’ USÃ EL BOT\\n\\nðŸ“ž OTRO MEDIO DONDE PODÃ‰S RECIBIR ASISTENCIA:\\n221 4906310\\n\\nÂ¿QUERÃ‰S CONTINUAR?\"\n    },\n    \"footer\": {\n      \"text\": \"LUN-VIE 8-20HS\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"si-confirmo\",\n            \"title\": \"SI, CONFIRMO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"volver-atras\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[720,896],"id":"72aa2e4d-6a20-4a59-b4b7-3a8eaeac28ef","name":"ðŸ¢ AdministraciÃ³n","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Filter1').first().json.contactNumber }}","value":"ADMINISTRACION=1","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[944,896],"id":"5bbaf07a-f680-4f57-9487-d7c5dc0f073f","name":"â±ï¸ STATUS MENU","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"status","key":"=status:{{ $json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-5632,1552],"id":"d4e70885-0cab-48dc-980f-58a32a959c59","name":"â±ï¸ YA SE ACTIVO MENU?","retryOnFail":false,"credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}},"onError":"continueRegularOutput"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').item.json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"image\",\n      \"image\": {\n        \"link\": \"https://i.imgur.com/cSVuheF.png\"\n      }\n    },\n    \"body\": {\n      \"text\": \"ðŸ‘‹ Â¡HOLA! BIENVENIDO AL ICLP\\n\\nðŸ¤– BOT: DISPONIBLE 24/7\\n\\nðŸ“ž ATENCIÃ“N TELEFÃ“NICA Y ADMINISTRATIVA:\\nLUNES A VIERNES 8-20HS | SÃBADO 8-13HS\\n\\nSELECCIONÃ UNA OPCIÃ“N:\\n\\nðŸ“… TURNOS (BOT)\\n- AGENDAR, CONSULTAR O CANCELAR\\n\\nâ„¹ï¸ INFO GENERAL (BOT)\\n- HORARIOS, UBICACIÃ“N Y MÃS\\n\\nðŸ¢ ADMINISTRACIÃ“N (PERSONAL ADMINISTRATIVO)\\n* CONSULTAS Y RECLAMOS\\n* RESPUESTA EN HORARIO DE ATENCIÃ“N\"\n    },\n    \"footer\": {\n      \"text\": \"SELECCIONÃ UNA OPCIÃ“N ðŸ‘‡\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"turnos\",\n            \"title\": \"ðŸ“… TURNOS\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"info-general\",\n            \"title\": \"â„¹ï¸ INFO GENERAL\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"administracion\",\n            \"title\": \"ðŸ¢ ADMINISTRACION\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[720,1120],"id":"02f256db-87c2-44e1-887f-a3cf2c6b6394","name":"Menu Principal = MENU=1","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"delete","key":"status:+5492254596618"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-5552,3040],"id":"f2db51e5-35c6-4461-9857-ba3958e50ef7","name":"DELETE - STATUS MENU","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"contador:+5492254596618"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-5328,3040],"id":"1fd45e2f-8bdd-4c17-9b88-6466cdf59083","name":"DELETE - CONTADOR","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Filter1').first().json.contactNumber }}","value":"MENU=1","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[944,1120],"id":"0a70a57c-c487-4255-8420-17b8f788f05b","name":"â±ï¸ STATUS MENU1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Filter1').first().json.contactNumber }}","value":"DATOS=1","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[944,2912],"id":"dc14941a-0ab7-44cb-879d-282985cfa93d","name":"â±ï¸ STATUS PRIMERA VEZ","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"068a964d-25b6-4a1f-8e05-c47dd2fea4b7","leftValue":"={{ $json.output.ERROR }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1632,-768],"id":"db429597-5008-459b-b9a6-187c2737b5e1","name":"Error informacion de usuario"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').first().json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"âš ï¸ {{ $json.output.ERROR_MESSAGE }}\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1856,-864],"id":"f3a568d9-7ad1-45e7-8b9c-4158ed2f39c3","name":"âš ï¸ DATOS INCORRECTOS","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"4d4f5d9a-5ad9-495c-82f0-043f7f0ef5d6","leftValue":"={{ $json.output.status_verificacion }}","rightValue":"encontrado","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2080,-672],"id":"7b7caff7-381f-4cb6-93b5-9c18543a62fc","name":"Exito"},{"parameters":{"operation":"set","key":"=status:{{ $('Filter1').first().json.contactNumber }}","value":"ESPECIALIDADES=1","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1392,2464],"id":"b542febb-8073-4fb3-81b0-c50f28e00274","name":"ESPECIALIDADES","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.recipient_type }}"},{"name":"to","value":"={{ $json.to }}"},{"name":"type","value":"={{ $json.type }}"},{"name":"interactive","value":"={{ $json.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1168,2464],"id":"c34ad63c-5766-422c-9fa5-0068aa89b9c9","name":"ðŸ©» ESPECIALIDADES","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"jsCode":"// Obtener todas las especialidades del input\nconst items = $input.all();\n\n// Crear el array de rows dinÃ¡micamente\nconst rows = items.map(item => {\n  const especialidad = item.json.Especialidad;\n  const codigo = item.json.Codigo;\n  \n  // Convertir a mayÃºsculas\n  let nombreEspecialidad = especialidad.toUpperCase();\n  \n  // Si tiene parÃ©ntesis, tomar solo lo que estÃ¡ antes\n  if (nombreEspecialidad.includes('(')) {\n    nombreEspecialidad = nombreEspecialidad.split('(')[0].trim();\n  }\n  \n  // Si tiene barra, tomar solo la primera parte\n  if (nombreEspecialidad.includes('/')) {\n    nombreEspecialidad = nombreEspecialidad.split('/')[0].trim();\n  }\n  \n  // Si tiene mÃºltiples palabras, tomar solo la primera palabra\n  if (nombreEspecialidad.includes(' ')) {\n    nombreEspecialidad = nombreEspecialidad.split(' ')[0];\n  }\n  \n  // Crear el title con formato: ESPECIALIDAD-CODIGO\n  let title = `${nombreEspecialidad}-${codigo}`;\n  \n  // Si aÃºn es muy largo, cortar a 24 caracteres\n  if (title.length > 24) {\n    title = title.substring(0, 21) + '...';\n  }\n  \n  // Crear descripciÃ³n completa\n  let description = especialidad;\n  \n  // WhatsApp permite MÃXIMO 72 caracteres en ROW_DESCRIPTION\n  if (description.length > 72) {\n    description = description.substring(0, 69) + '...';\n  }\n  \n  return {\n    id: codigo,\n    title: title,\n    description: description\n  };\n});\n\n// Agregar botÃ³n \"VER MÃS\" al final de la lista\nrows.push({\n  id: \"ver-mas\",\n  title: \"ðŸ“‹ VER MÃS\",\n  description: \"VER MÃS OPCIONES Y ESPECIALIDADES DISPONIBLES\"\n});\n\n// Retornar el JSON completo con la estructura de WhatsApp\nreturn [{\n  json: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: $('Filter1').first().json.contactNumber,\n    type: \"interactive\",\n    interactive: {\n      type: \"list\",\n      header: {\n        type: \"text\",\n        text: \"ðŸ©º ESPECIALIDADES\"\n      },\n      body: {\n        text: \"*ðŸ“‹ Â¿CÃ“MO FUNCIONA?*\\n\\n*1ï¸âƒ£ ELEGÃ LA ESPECIALIDAD*\\nPRESIONÃ EL BOTÃ“N Y SELECCIONÃ LA ESPECIALIDAD MÃ‰DICA QUE NECESITÃS\\n\\n*2ï¸âƒ£ ELEGÃ EL MÃ‰DICO*\\nLUEGO PODRÃS VER Y SELECCIONAR LOS PROFESIONALES DISPONIBLES EN ESA ESPECIALIDAD\\n\\nðŸ‘‡ *PRESIONÃ PARA COMENZAR*\"\n      },\n      footer: {\n        text: \"ðŸ“… LUN-VIE 8-20HS\"\n      },\n      action: {\n        button: \"VER ESPECIALIDADES\",\n        sections: [\n          {\n            title: \"ELEGIR UNA OPCIÃ“N\",\n            rows: rows\n          }\n        ]\n      }\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[944,2464],"id":"57e1ac79-24a5-4cde-a604-a7bae4e1410b","name":"LISTA"},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"mi8p2u7tvuplzt5","limit":9,"options":{}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[720,2464],"id":"a592c8f2-974a-48cf-88de-77f3cf7b90a8","name":"Get_Especialidades","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"jsCode":"// Obtener el mensaje completo\nconst mensaje = $('Filter1').first().json.message;\n\n// Extraer solo el cÃ³digo (despuÃ©s del guiÃ³n)\nconst codigo = mensaje.split('-').pop();\n\n// Retornar el resultado\nreturn [{\n  json: {\n    codigo: codigo\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[944,3360],"id":"fe338804-1718-41e4-ab5e-bd763cf1d087","name":"Code1"},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"mhwp4qt6r2d7ymm","limit":9,"options":{"fields":[]}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[1424,3152],"id":"2838d675-5cdd-4dd5-a405-44bcc6bf6f77","name":"get_medicos","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"operation":"get","propertyName":"=Datos","key":"=DNI:{{ $('Filter1').item.json.contactNumber.replace('+', '') }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[720,3808],"id":"b359d28b-269e-4429-bee2-37e68bcaaa48","name":"get_datos_usuario","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"// Obtener datos del nodo get_datos_usuario\nconst inputData = $('get_datos_usuario').first().json;\n\nconsole.log('Input completo:', JSON.stringify(inputData, null, 2));\n\n// Intentar diferentes rutas para encontrar el DNI\nlet dni = null;\n\n// OpciÃ³n 1: Datos.paciente_dni\nif (inputData.Datos && inputData.Datos.paciente_dni) {\n  dni = Number(inputData.Datos.paciente_dni);\n  console.log('DNI encontrado en Datos.paciente_dni:', dni);\n}\n// OpciÃ³n 2: paciente_dni directo\nelse if (inputData.paciente_dni) {\n  dni = Number(inputData.paciente_dni);\n  console.log('DNI encontrado en paciente_dni:', dni);\n}\n// OpciÃ³n 3: Datos como string que hay que parsear\nelse if (typeof inputData.Datos === 'string') {\n  const datosParsed = JSON.parse(inputData.Datos);\n  dni = Number(datosParsed.paciente_dni);\n  console.log('DNI encontrado parseando Datos:', dni);\n}\n\nconsole.log('DNI final:', dni);\n\n// Obtener el mensaje que contiene NOMBRE-MATRICULA\nconst mensaje = $('Filter1').first().json.message;\n\n// Extraer solo la MATRICULA (nÃºmero despuÃ©s del guiÃ³n)\nconst matricula = Number(mensaje.split('-').pop().trim());\n\n// Obtener la fecha actual en formato yyyyMMdd\nconst fecha = Number(DateTime.now()\n  .setZone('America/Argentina/Buenos_Aires')\n  .toFormat('yyyyMMdd'));\n\n// Retornar el resultado\nreturn [{\n  json: {\n    dni: dni,\n    matricula: matricula,\n    fecha: fecha\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[944,3808],"id":"b50764d1-6a8d-42d7-90f9-bfbbaf73ec0b","name":"Code"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.recipient_type }}"},{"name":"to","value":"={{ $json.to }}"},{"name":"type","value":"={{ $json.type }}"},{"name":"interactive","value":"={{ $json.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1872,3152],"id":"0b956e28-37f8-4bfd-8339-dd90d44f752e","name":"Medicos","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"leftValue":"={{ $('Filter1').item.json.message === 'ðŸ“… TURNOS' &&  $json.status === 'MENU=1'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true},"id":"aacee385-95a8-41d2-9c7e-547318a25143"}],"combinator":"and"},"renameOutput":true,"outputKey":"=ðŸ“… Turnos "},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"4acbe828-86be-4b90-8aec-6b8b842269c1","leftValue":"={{ $('Filter1').item.json.message === 'â„¹ï¸ INFO GENERAL'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"â„¹ï¸ Info General"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"78546a36-a7a9-435c-8932-4778ab0c5959","leftValue":"={{ $('Filter1').item.json.message === 'ðŸ¢ ADMINISTRACION'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ðŸ¢ AdministraciÃ³n"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"6394527f-2e97-4fe0-b78c-0d944b995fa3","leftValue":"={{ ($json.status == null || $json.status === '') && !['â„¹ï¸ INFO GENERAL', 'ðŸ“… TURNOS', 'ðŸ¢ ADMINISTRACION'].includes($('Filter1').item.json.message) }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"Menu principal"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"44d5c148-338e-4039-a0fe-7b16fffdf96e","leftValue":"={{ $json.status === 'ADMINISTRACION=1' && $('Filter1').item.json.message === 'SI, CONFIRMO' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"SI, CONFIRMO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"83b82f32-93f7-43ac-863c-5d97343541ab","leftValue":"={{ ($json.status === 'ADMINISTRACION=1' || $json.status === 'TURNOS=1' || $json.status === 'MENU=1' ) && $('Filter1').item.json.message === 'MENU PRINCIPAL' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"MENU PRINCIPAL"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"2df6674f-a46b-489f-9644-1143b04e73cd","leftValue":"={{ $json.status === 'DATOS=1' && $('Filter1').item.json.message === 'VOLVER ATRAS'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"VOLVER MENU PRMERA VEZ"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"afa7d5a4-b19e-4f00-861d-4fabcb8b365c","leftValue":"={{ $json.status === 'DATOS=1' && $('Filter1').item.json.message === 'MENU PRINCIPAL'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"VUELVE MENU PRINCIPAL"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"efd790d6-e09f-47ec-b9f3-fae3857853be","leftValue":"={{ $json.status === 'DATOS=1' && $('Filter1').item.json.message === 'TURNOS CONSULTORIO'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"TURNOS CONSULTORIO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"fa55ec2d-16fc-4430-b1e5-215d7a599092","leftValue":"={{ $json.status === 'DATOS=1' && $('Filter1').item.json.message.trim() === 'TURNOS CONSULTORIO' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"TURNOS CONSULTORIO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"fbd8b46d-0856-4057-9d98-5e7ebda62949","leftValue":"={{ $json.status === 'MENU=1' && $('Filter1').item.json.message === 'NUEVO PACIENTE' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"Primera vez"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"101afc22-c553-4d38-bd69-816f4bf666c0","leftValue":"={{ $json.status === 'DATOS=1' && $('Filter1').item.json.message.trim() !== 'VOLVER ATRAS' &&  $('Filter1').item.json.message !== 'CON ESPECIALIDAD' && $('Filter1').item.json.message !== 'CONTINUAR'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"DATOS PACIENTE"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"f46dd242-17b3-46e9-830f-7c579acc1bbb","leftValue":"={{ $json.status === 'ESPECIALIDADES=1' && $('Filter1').item.json.message !== 'ðŸ“‹ VER MÃS' && $('Filter1').item.json.message !== 'ðŸ“‹ VOLVER ATRAS'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ESPECIALIDADES"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"df533638-b2e2-48ee-aa06-de32ec45bdbe","leftValue":"={{ $json.status === 'MEDICOS=1' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"MEDICOS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"e3130b37-608b-4661-8d88-d870473e46dd","leftValue":"={{ $json.status === 'HORARIOS=1' &&  $('Filter1').item.json.message !== 'â¬…ï¸ VOLVER ATRAS'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"CONFIRMAR-TURNO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"038f4f66-b969-46d1-808c-f5e3e22369bf","leftValue":"={{ $json.status === 'TURNO-CONFIRMADO' && $('Filter1').item.json.message ==='SÃ, CONFIRMO' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"TURNO CONFIRMADO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"b8141077-7181-4146-be92-9057da0af435","leftValue":"={{ $json.status === 'MENU=1' &&  $('Filter1').item.json.message === 'PACIENTE REGISTRADO' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"PACIENTE REGISTRADO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"06d618bd-eae8-4b42-bc33-0ddc48516cf1","leftValue":"={{ $json.status === 'PACIENTE=1' &&  $('Filter1').item.json.message !== 'VOLVER ATRÃS'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"BUSCAR DNI"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"4163376b-0a76-4a3d-8c4d-5d7902cc4f48","leftValue":"={{ $json.status.startsWith('DNI:') && $('Filter1').item.json.message === 'MIS TURNO/S'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"MIS TURNOS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"8c49825d-31d8-4120-9ffa-f906cb44bb1b","leftValue":"={{ $json.status.startsWith('DNI:') && $('Filter1').item.json.message === 'VOLVER ATRÃS'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"MIS TURNOS-VOLVER ATRAS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"79743b31-9d7c-48de-8ea3-f0dbaeddbe71","leftValue":"={{ $json.status.startsWith('DNI:') && $('Filter1').item.json.message === 'CANCELAR TURNO'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"CANCELAR TURNO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"558feafc-71ef-42ec-8e71-341549deb019","leftValue":"={{ $json.status.startsWith('DNI:') && $('Filter1').item.json.message === 'ðŸ  MENU PRINCIPAL'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"menu principal"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"a725236c-9399-42ab-a059-026c5d5f0f17","leftValue":"={{ $json.status.startsWith('DNI:') && $('Filter1').item.json.message === 'TOMAR TURNO'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"TOMAR TURNO - YA REGISTRADO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"459206f5-daa4-4933-8869-0be854165d4a","leftValue":"={{ $json.status.startsWith('DNI:') && $('Filter1').item.json.message === 'TURNOS CONSULTORIO'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"TURNOS CONSULTORIO - PACIENTE REGISTRADO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"273275e4-41c6-45c2-a1aa-52581eed6719","leftValue":"={{ $json.status.startsWith('ESPECIALIDADES=1') && $('Filter1').item.json.message === 'ðŸ“‹ VER MÃS'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ESPECIALIDADES-VER MAS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"92c8caf5-317f-4fab-ad94-9ec99357a056","leftValue":"={{ $json.status.startsWith('ESPECIALIDADES=1') && $('Filter1').item.json.message === 'ðŸ“‹ VOLVER ATRAS'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"VOLVER ATRAS-ESPECIALIDADES"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"b7e03e2e-be29-448e-bec1-cfbd7dabecb1","leftValue":"={{ $json.status.startsWith('ESPECIALIDADES=1') && $('Filter1').item.json.message === 'VOLVER ATRÃS'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"VOLVER ATRAS-TOMAR TURNO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"4b9e3939-9475-4e16-a8ab-36bb28537ae2","leftValue":"={{ $json.status.startsWith('DNI:') && $('Filter1').item.json.message === 'TURNOS ESTUDIO'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"turnos estudio"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"376dbfb4-85e7-4cad-a4e2-0439bae9952d","leftValue":"={{ $json.status === 'HORARIOS=1' &&  $('Filter1').item.json.message === 'â¬…ï¸ VOLVER ATRAS'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"volver atras - horarios"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"98d949f7-5f64-4473-81fe-0d00aa1c922f","leftValue":"={{ $json.status === 'TURNO-CONFIRMADO' && $('Filter1').item.json.message === 'VOLVER ATRÃS' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"VOLVER ATRAAS - TURNO CONFIRMADO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"77eaa7b5-ce78-435b-8829-75fadc40f48e","leftValue":"={{ $json.status.startsWith('DNI:') && /^[A-Z]+(-\\d{2}){2}-\\d{4}$/.test($('Filter1').item.json.message) }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ðŸš« DELETE TURNO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"c620e48b-fa9a-45a1-b715-93a557d4a417","leftValue":"={{ $json.status === 'TURNO-CONFIRMADO' && $('Filter1').item.json.message === 'MENU PRINCIPAL'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"=TURNO-CONFIRMADO - MENU PRINCIPAL"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"ffc31ac1-767a-4385-820d-4de70ce019d7","leftValue":"={{ $('Filter1').item.json.message === 'ðŸ• HORARIOS' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ðŸ• HORARIOS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"812bae76-edd6-4893-85bb-a5438e1795b9","leftValue":"={{ $('Filter1').item.json.message === 'ðŸ“ DIRECCIÃ“N'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ðŸ“ DIRECCIÃ“N"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"e703712c-1f80-4bdf-925a-d0b772b7c952","leftValue":"={{ $('Filter1').item.json.message === 'ðŸ’» PORTAL PACIENTES' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ðŸ’» PORTAL PACIENTES"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"642ded3f-e61d-4393-8a68-a477dba1da2b","leftValue":"={{ $('Filter1').item.json.message === 'ðŸ“§ EMAIL RECETAS' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ðŸ“§ EMAIL RECETAS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"b9cc8543-dce1-4d14-82cb-122960e0445d","leftValue":"={{ $('Filter1').item.json.message === 'ðŸ‘¨â€âš•ï¸ MÃ‰DICOS' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ðŸ‘¨â€âš•ï¸ MÃ‰DICOS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"36d911cd-1dc7-45e7-9fca-4a0f007816d4","leftValue":"={{ $('Filter1').item.json.message === 'ðŸ©º ESPECIALIDADES' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ðŸ©º ESPECIALIDADES"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"78250097-f228-4d14-aa2a-32a1f643dff0","leftValue":"={{ $json.status.startsWith('DNI:') && $('Filter1').item.json.message === 'CONTINUAR'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"CONTINUAR"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"fca1c410-2105-42ad-878f-c4c96a3c227c","leftValue":"={{ $json.status.startsWith('DNI:') && $('Filter1').item.json.message === 'MENU PRINCIPAL'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"MENU PRINCIPAL"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"019f7999-5d5d-407a-ad50-2ed43983585b","leftValue":"={{ $json.status === 'DATOS=1' && $('Filter1').item.json.message === 'CONTINUAR' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"CONTINUAR"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"3c5de5cb-95ff-49fa-a3d1-dfd7bad2d3c0","leftValue":"={{ $('Filter1').item.json.message === 'SACAR TURNO' &&  $json.status === 'MENU=1'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"SACAR TURNO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"95d44411-d152-4d3d-b933-3f4d50b1140b","leftValue":"={{ $('Filter1').item.json.message === 'VOLVER ATRÃS' && $json.status === 'PACIENTE=1' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"VOLVER ATRÃS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"4c5bcc71-179a-48cb-be5a-14d61759d32c","leftValue":"={{ $json.status === 'ESPECIALIDADES=1'&& $('Filter1').item.json.message === 'MENU PRINCIPAL'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"MENU PRINCIPAL"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"066d73f1-dfab-42ea-880f-bb79a726382a","leftValue":"={{ $json.status === 'MENU=1' && /^\\d{7,8}$/.test($('Filter1').item.json.message) }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"DNI USUARIO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"ab3b68c3-a8fb-4d15-84dd-4e766ac9e4ef","leftValue":"={{ $json.status === 'HORARIOS=1' && $('Filter1').item.json.message === 'VOLVER ATRAS'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"VOLVER ATRAS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"87509c74-02fd-49b5-8e07-a9fd3f7c2623","leftValue":"={{ $('Entrada').item.json.body.labels[0] === 'turnos-estudios' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ETIQUETA=turnos-estudios"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"7461aa78-e23f-4d64-b78e-58a713ab4e5b","leftValue":"={{ $json.status === 'ESPECIALIDADES=1' && $('Filter1').item.json.message === 'VOLVER'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"VOLVER"}]},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-4672,1248],"id":"3414f6d0-6de7-4458-ab49-ab978a9be15e","name":"MENU PRINCIPAL","alwaysOutputData":false,"onError":"continueRegularOutput"},{"parameters":{"workflowId":{"__rl":true,"value":"kmoVJGP4RL3PTi16","mode":"list","cachedResultName":"Turno-medico-mas-proximo"},"workflowInputs":{"mappingMode":"defineBelow","value":{"matricula":"={{ $json.matricula }}","dni":"={{ $json.dni }}","fechaDesde":"={{ $json.fecha }}"},"matchingColumns":[],"schema":[{"id":"matricula","displayName":"matricula","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"fechaDesde","displayName":"fechaDesde","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[1168,3808],"id":"7dc2a6ff-6a57-4809-b776-d02ab3d8b97a","name":"ðŸ“… Horarios Proximos"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.recipient_type }}"},{"name":"to","value":"={{ $json.to }}"},{"name":"type","value":"={{ $json.type }}"},{"name":"interactive","value":"={{ $json.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1616,3808],"id":"597c354e-4ef4-4196-a2d9-0df4494757d6","name":"ðŸ• Fechas disponibles ","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"jsCode":"// Obtener todos los horarios del input\nconst fechasLibres = $input.first().json.fechas_libres;\n\n// Si no hay fechas disponibles, devolver mensaje con botones\nif (!fechasLibres || fechasLibres.length === 0) {\n  return [{\n    json: {\n      messaging_product: \"whatsapp\",\n      recipient_type: \"individual\",\n      to: $('Filter1').first().json.contactNumber,\n      type: \"interactive\",\n      interactive: {\n        type: \"button\",\n        body: {\n          text: \"âŒ Lo sentimos, no hay turnos disponibles en este momento.\\n\\nPor favor, intentÃ¡ mÃ¡s tarde o contactanos directamente al 221-4906310.\"\n        },\n        action: {\n          buttons: [\n            {\n              type: \"reply\",\n              reply: {\n                id: \"volver-atras\",\n                title: \"VOLVER ATRAS\"\n              }\n            },\n            {\n              type: \"reply\",\n              reply: {\n                id: \"menu-principal\",\n                title: \"MENU PRINCIPAL\"\n              }\n            }\n          ]\n        }\n      }\n    }\n  }];\n}\n\n// Limitar a mÃ¡ximo 9 horarios\nconst fechasLimitadas = fechasLibres.slice(0, 9); // ðŸ‘ˆ LIMITAR A 9\n\n// Crear el array de rows dinÃ¡micamente\nconst rows = fechasLimitadas.map(item => {\n  // Obtener la fecha y hora del formato \"2025-10-14,\\n 11:20\"\n  const fechaHoraRaw = item.fecha_y_hora;\n  \n  // Limpiar y separar fecha y hora\n  const [fecha, hora] = fechaHoraRaw.replace(/\\n/g, '').split(',').map(s => s.trim());\n  \n  // Crear objeto DateTime\n  const dt = DateTime.fromISO(`${fecha}T${hora}`, { \n    zone: 'America/Argentina/Buenos_Aires' \n  });\n  \n  // Obtener dÃ­a de la semana en espaÃ±ol\n  const diasSemana = ['DOM', 'LUN', 'MAR', 'MIÃ‰', 'JUE', 'VIE', 'SÃB'];\n  const diaSemana = diasSemana[dt.weekday % 7];\n  \n  // Formatear fecha como DD/MM\n  const fechaFormateada = dt.toFormat('dd/MM');\n  \n  // Crear el title: DÃA DD/MM - HH:MM\n  let title = `${diaSemana} ${fechaFormateada} - ${hora}`;\n  \n  // Si aÃºn es muy largo, cortar a 24 caracteres\n  if (title.length > 24) {\n    title = title.substring(0, 21) + '...';\n  }\n  \n  // Crear descripciÃ³n completa\n  let description = `${diaSemana} ${dt.toFormat('dd/MM/yyyy')} a las ${hora}hs`;\n  \n  // WhatsApp permite MÃXIMO 72 caracteres en ROW_DESCRIPTION\n  if (description.length > 72) {\n    description = description.substring(0, 69) + '...';\n  }\n  \n  // ID Ãºnico: combinar fecha y hora sin separadores\n  const id = `${fecha.replace(/-/g, '')}-${hora.replace(/:/g, '')}`;\n  \n  return {\n    id: id,\n    title: title,\n    description: description\n  };\n});\n\n// Retornar el JSON completo con la estructura de WhatsApp\nreturn [{\n  json: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: $('Filter1').first().json.contactNumber,\n    type: \"interactive\",\n    interactive: {\n      type: \"list\",\n      header: {\n        type: \"text\",\n        text: \"ðŸ“… Turnos Disponibles\"\n      },\n      body: {\n        text: \"SeleccionÃ¡ el dÃ­a y horario que prefieras\"\n      },\n      footer: {\n        text: \"ðŸ• Horarios disponibles\"\n      },\n      action: {\n        button: \"VER HORARIOS\",\n        sections: [\n          {\n            title: \"ELEGIR TURNO\",\n            rows: rows\n          }\n        ]\n      }\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1392,3808],"id":"c74a3c73-89d6-4820-83ec-535ee40cf4d9","name":"ðŸ• LISTA-HORARIOS"},{"parameters":{"operation":"set","key":"=status:{{ $('Filter1').first().json.contactNumber }}","value":"MEDICOS=1","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2096,3152],"id":"bb49f940-6fdf-4814-aecf-01720e19b488","name":"ðŸ©º MEDICOS","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"// Obtener todos los mÃ©dicos del input\nconst items = $input.all();\n\n// Crear el array de rows dinÃ¡micamente\nconst rows = items.map(item => {\n  const medico = item.json.Medico;\n  const matricula = item.json.Matricula;\n  \n  // Convertir a mayÃºsculas\n  let nombreMedico = medico.toUpperCase();\n  \n  // Si tiene parÃ©ntesis, tomar solo lo que estÃ¡ antes\n  if (nombreMedico.includes('(')) {\n    nombreMedico = nombreMedico.split('(')[0].trim();\n  }\n  \n  // Si tiene barra, tomar solo la primera parte\n  if (nombreMedico.includes('/')) {\n    nombreMedico = nombreMedico.split('/')[0].trim();\n  }\n  \n  // Si tiene mÃºltiples palabras, tomar solo la primera palabra\n  if (nombreMedico.includes(' ')) {\n    nombreMedico = nombreMedico.split(' ')[0];\n  }\n  \n  // Crear el title con formato: NOMBRE-MATRICULA\n  let title = `${nombreMedico}-${matricula}`;\n  \n  // Si aÃºn es muy largo, cortar a 24 caracteres\n  if (title.length > 24) {\n    title = title.substring(0, 21) + '...';\n  }\n  \n  // Crear descripciÃ³n completa\n  let description = medico;\n  \n  // WhatsApp permite MÃXIMO 72 caracteres en ROW_DESCRIPTION\n  if (description.length > 72) {\n    description = description.substring(0, 69) + '...';\n  }\n  \n  return {\n    id: matricula,\n    title: title,\n    description: description\n  };\n});\n\n// Solo agregar \"VER MÃS\" si hay 9 o mÃ¡s mÃ©dicos\nif (items.length >= 9) {\n  rows.push({\n    id: \"ver-mas\",\n    title: \"ðŸ“‹ VER MÃS\",\n    description: \"Ver mÃ¡s mÃ©dicos disponibles\"\n  });\n}\n\n// Retornar el JSON completo con la estructura de WhatsApp\nreturn [{\n  json: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: $('Filter1').first().json.contactNumber,\n    type: \"interactive\",\n    interactive: {\n      type: \"list\",\n      header: {\n        type: \"text\",\n        text: \"ðŸ‘¨â€âš•ï¸ MÃ©dicos\"\n      },\n      body: {\n        text: \"SeleccionÃ¡ el mÃ©dico con quien querÃ©s tu turno\"\n      },\n      footer: {\n        text: \"ðŸ“… Lun-Vie 8-20hs\"\n      },\n      action: {\n        button: \"VER MÃ‰DICOS\",\n        sections: [\n          {\n            title: \"ELEGIR MÃ‰DICO\",\n            rows: rows\n          }\n        ]\n      }\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1648,3152],"id":"738ffb64-35e8-4555-9b05-546f689fd79a","name":"ðŸ©º LISTA-MEDICOS "},{"parameters":{"operation":"set","key":"=status:{{ $('Filter1').first().json.contactNumber }}","value":"HORARIOS=1","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1840,3808],"id":"03df1370-9c80-4e2c-bf0b-0c4908687bbf","name":"ðŸ©º MEDICOS1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"=Datos","key":"=DNI:{{ $('Filter1').item.json.contactNumber.replace('+', '') }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[720,4256],"id":"ba9e3f08-7066-415d-808f-11a514dcf037","name":"get_datos_usuario1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[1168,-544],"id":"97e2a44d-28bf-46a4-a7fe-57f2cc420f86","name":"OpenRouter Chat Model2","credentials":{"openRouterApi":{"id":"ZlcbniUoDvrFqCIJ","name":"OpenRouter ICLP"}}},{"parameters":{"jsCode":"// Obtener los datos de entrada\nconst inputData = $('get_datos_usuario1').first().json;\nconsole.log('Input completo:', JSON.stringify(inputData, null, 2));\n\n// Parsear los datos si vienen como string\nlet datos;\nif (typeof inputData.Datos === 'string') {\n  datos = JSON.parse(inputData.Datos);\n  console.log('Datos parseados:', datos);\n} else {\n  datos = inputData.Datos;\n}\n\nconst filterData = $('Filter1').first().json;\nconst medicoMatricula = $input.first().json.matricula;\n\n// Separar nombre del mÃ©dico y matrÃ­cula\nconst [nombreMedico, matricula] = medicoMatricula.split('-');\n\n// Parsear el mensaje - AGREGAR VALIDACIÃ“N\nconst mensaje = filterData?.message;\n\n// VALIDAR que el mensaje exista\nif (!mensaje) {\n  throw new Error('No se encontrÃ³ el mensaje en filterData');\n}\n\nconsole.log('Mensaje recibido:', mensaje);\n\n// Extraer fecha y hora usando split\nconst partes = mensaje.split(' - ');\n\n// VALIDAR que el split funcionÃ³ correctamente\nif (partes.length < 2) {\n  throw new Error(`Formato de mensaje incorrecto: \"${mensaje}\". Se esperaba formato \"DÃA DD/MM - HH:MM\"`);\n}\n\nconst fechaParte = partes[0]; // \"MIÃ‰ 22/10\"\nconst horaParte = partes[1]; // \"13:00\"\n\n// Extraer dÃ­a y mes de la fecha\nconst fechaMatch = fechaParte.match(/(\\d{1,2})\\/(\\d{1,2})/);\n\n// VALIDAR que se encontrÃ³ el patrÃ³n de fecha\nif (!fechaMatch) {\n  throw new Error(`No se pudo extraer la fecha de: \"${fechaParte}\"`);\n}\n\nconst dia = fechaMatch[1].padStart(2, '0');\nconst mes = fechaMatch[2].padStart(2, '0');\n\n// Determinar el aÃ±o\nconst aÃ±o = \"2025\";\nconst fecha = `${aÃ±o}${mes}${dia}`;\n\n// Convertir hora\nconst hora = horaParte.replace(':', '');\n\n// Crear timestamp Unix\nconst fechaUnix = new Date(`${aÃ±o}-${mes}-${dia}T00:00:00-03:00`).getTime();\n\n// Extraer el DNI correctamente\nconst dni = Number(datos.paciente_dni);\nconsole.log('DNI extraÃ­do:', dni);\n\n// Construir el objeto de datos del turno\nconst datosTurno = {\n  dni: dni,\n  fecha: Number(fecha),\n  fechaUnix: fechaUnix,\n  matricula: matricula,\n  nombreMedico: nombreMedico,\n  hora: hora,\n  nombre_completo: datos.paciente_nombre,\n  celular_paciente: datos.paciente_celular,\n  obraSocial: datos.obraSocial || datos.obra_social,\n  direccion: datos.direccion || \"Sin direcciÃ³n\"\n};\n\nconsole.log('Datos del turno completos:', datosTurno);\n\nreturn [{ \n  json: {\n    turno: datosTurno,\n    turnoJson: JSON.stringify(datosTurno)\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1168,4256],"id":"072a00a6-eb5e-4761-bdd1-a6a13429acd1","name":"Code2"},{"parameters":{"operation":"set","key":"=MEDICO:{{ $('Filter1').first().json.contactNumber.replace('+', '') }}","value":"={{ $('Filter1').item.json.message }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2064,3808],"id":"6c41fc27-74ed-4e42-a2d4-fab8dcfd01be","name":"Matricula medico","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"matricula","key":"=MEDICO:{{ $('Filter1').first().json.contactNumber.replace('+', '') }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[944,4256],"id":"82ddec2c-9cef-4868-88a6-8e77284f217b","name":"MATRICULA","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').item.json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"âœ… CONFIRMAR TURNO\"\n    },\n    \"body\": {\n      \"text\": \"Perfecto, el turno con el Dr. {{ $('Datos para confirmar turno').item.json.turno.nombreMedico }}:\\n\\n- Fecha: {{ DateTime.fromMillis($('Datos para confirmar turno').item.json.turno.fechaUnix).setZone('America/Argentina/Buenos_Aires').toFormat('dd/MM/yyyy') }}\\n- Hora: {{ $('Datos para confirmar turno').item.json.turno.hora.slice(0,2) + ':' + $('Datos para confirmar turno').item.json.turno.hora.slice(2,4) }}\\n\\nÂ¿Esta informaciÃ³n es correcta? Te pido que confirmes el turno\"\n    },\n    \"footer\": {\n      \"text\": \"ðŸ“… Lun-Vie 8-20hs\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"si-confirmo\",\n            \"title\": \"SÃ, CONFIRMO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"volver-atras\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1616,4256],"id":"ae7751b7-a3c0-4cd4-9270-0f8f140376de","name":"ðŸ“… Confirmar turno","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=turno:{{ $('Filter1').first().json.contactNumber }}","value":"={{ $json.turnoJson }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1392,4256],"id":"3ccf3f71-4f17-45c2-9df3-6ba21ae54e3b","name":"Datos para confirmar turno","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Filter1').first().json.contactNumber }}","value":"TURNO-CONFIRMADO","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1840,4256],"id":"72b3e7f1-442d-442c-91f0-fb688c0a4711","name":"Redis","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"datos","key":"=turno:{{ $('Filter1').first().json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[720,4704],"id":"49f3bf8a-c8de-44b2-b406-c4a9960f3f73","name":"Datos para confirmar turno1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"workflowId":{"__rl":true,"value":"e7UD4t6GrwYxGW6Q","mode":"list","cachedResultName":"ICLP - Subflujo_Tomar_Turno_listas"},"workflowInputs":{"mappingMode":"defineBelow","value":{"dni":"={{ $json.datos.parseJson().dni }}","fecha":"={{ $json.datos.parseJson().fechaUnix }}","hora":"={{ $json.datos.parseJson().hora }}","nombre_completo":"={{ $json.datos.parseJson().nombre_completo }}","celular_paciente":"={{ $json.datos.parseJson().celular_paciente }}","matricula":"={{ $json.datos.parseJson().matricula }}"},"matchingColumns":[],"schema":[{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"fecha","displayName":"fecha","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"hora","displayName":"hora","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"nombre_completo","displayName":"nombre_completo","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"celular_paciente","displayName":"celular_paciente","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"matricula","displayName":"matricula","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false}],"attemptToConvertTypes":true,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[944,4704],"id":"d5035fee-4dc7-4be2-89b1-51e8fb8effb0","name":"EJECUTAR TURNO"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').first().json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"âœ… *Turno confirmado* \\nðŸ“ DirecciÃ³n: 6 entre 36 y 37, La Plata\\n\\nðŸ’³ *RecordÃ¡ traer:*\\nâ€¢ DNI\\nâ€¢ Credencial de obra social\\nâ€¢ Estudios previos (si tenÃ©s)\\n\\nðŸ“ž Para cancelar o reprogramar, llamÃ¡ al 221-4906310 o espera 10 minutos luego de haber tomado el turno\\n\\nÂ¡Te esperamos! ðŸ«€  \"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1168,4704],"id":"d0f83861-ffb3-4e49-b47d-99b53700c0c1","name":"ðŸ“… Confirmar turno1","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"delete","key":"status:+5492213994411"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-5552,3232],"id":"74bc65ab-aaf8-4b04-8d6b-a41131b422f3","name":"DELETE - STATUS MENU1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"contador:+5492213994411"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-5328,3232],"id":"0cc727b5-a360-479f-96ba-59ae36f5e043","name":"DELETE - CONTADOR1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"5492213994411"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-5104,3232],"id":"d3df9c4f-6184-4c32-a727-fcda33f50470","name":"DELETE - DATOS=","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"promptType":"define","text":"={{ $('Filter1').first().json.message }}","hasOutputParser":true,"options":{"systemMessage":"=# ROL\nSos un colector/validador de datos clÃ­nicos. Siempre devolvÃ©s UN Ãºnico objeto JSON. Sin texto extra ni markdown. No uses comillas en nÃºmeros.\n\n# CONTEXTO\n$OBRAS_SOCIALES := {{ JSON.stringify($json.obrasociales) }}  // usar EXCLUSIVAMENTE este listado\nCada item: { obrasocial: string, nombre_obrasocial: string }\n\n# CONTRATO DE SALIDA\n{\n  \"status\": \"ASK\" | \"FINAL\",\n  \"ask\": \"string\",                      // UNA pregunta breve, natural y amigable por el dato que falta o hay que corregir\n  \"missing\": [\"NOMBRE\",\"DNI\",\"OBRA_SOCIAL\",\"DIRECCION\",\"TELEFONO\"],\n  \"data\": {\n    \"NOMBRE\": \"string\",\n    \"DNI\": number,\n    \"OBRA_SOCIAL\": \"string\",\n    \"NOMBRE_OBRA_SOCIAL\": \"string\",\n    \"DIRECCION\": \"string\",\n    \"TELEFONO\": number\n  },\n  \"ERROR\": true | false,\n  \"ERROR_MESSAGE\": \"string\"\n}\n\n# REGLAS DE CONVERSACIÃ“N (ORDEN)\nValidÃ¡/pedÃ­ en este orden: NOMBRE â†’ DNI â†’ OBRA_SOCIAL â†’ DIRECCION â†’ TELEFONO.\n\n# REGLAS DE ERROR Y MENSAJES\n- En status=\"ASK\":\n  A) **Si existe algÃºn dato invÃ¡lido YA PROVISTO** (segÃºn el orden), entonces:\n     - ERROR=true\n     - ERROR_MESSAGE = mensaje natural y conversacional del primer invÃ¡lido\n     - ask = pregunta amigable para **corregir ese mismo dato** (no avanzar)\n  B) **Si NO hay invÃ¡lidos, pero faltan datos**, entonces:\n     - ERROR=true\n     - ERROR_MESSAGE = mensaje natural indicando quÃ© datos faltan\n     - ask = pregunta amigable por el **prÃ³ximo** dato faltante (siguiendo el orden)\n- En status=\"FINAL\":\n  - EjecutÃ¡ validaciones estrictas. Si algo falla â†’ ERROR=true y ERROR_MESSAGE natural con **solo** el primer error; si todo ok â†’ ERROR=false y ERROR_MESSAGE=\"\"\n\n# VALIDACIONES (estrictas, SOLO aplican cuando el campo YA fue provisto; en FINAL se aplican a todos)\n1) NOMBRE: al menos dos palabras alfabÃ©ticas\n   - error natural: \"Necesito su nombre completo (nombre y apellido) para registrarlo en el sistema\"\n   \n2) DNI: ^\\\\d{7,8}$ (solo nÃºmeros, sin puntos/espacios)\n   - error natural: \"El DNI que me pasÃ³ no es vÃ¡lido. Por favor, envÃ­eme solo los nÃºmeros, sin puntos ni espacios (ejemplo: 35946257)\"\n   \n3) OBRA_SOCIAL:\n   - \"no/sin obra social/particular\" â‡’ OBRA_SOCIAL=\"PART\", NOMBRE_OBRA_SOCIAL=\"PARTICULAR\"\n   - nombre informado â‡’ normalizar y buscar en $OBRAS_SOCIALES (exacto o inclusiÃ³n); si no hay match â†’ \"Disculpe, la obra social que mencionÃ³ no figura en nuestro sistema. Â¿PodrÃ­a verificar el nombre o indicar si es particular?\"\n   - si no se informÃ³ â‡’ se considera **faltante** (no invÃ¡lido)\n   \n4) DIRECCION: debe incluir calle y **al menos un dÃ­gito**\n   - error natural: \"Me falta la direcciÃ³n completa. Por favor, indÃ­queme calle y nÃºmero (ejemplo: Calle 50 NÂ°123)\"\n   \n5) TELEFONO: ^\\\\d{10}$ (solo nÃºmeros)\n   - error natural: \"El telÃ©fono debe tener 10 dÃ­gitos. Por favor, envÃ­elo completo con cÃ³digo de Ã¡rea, solo nÃºmeros (ejemplo: 2214567890)\"\n\n# TONO DE LOS MENSAJES\n- UsÃ¡ tratamiento formal (usted) pero amigable\n- SÃ© conversacional, no robÃ³tico\n- RecordÃ¡ y reconocÃ© los datos que ya tenÃ©s (\"Perfecto, ya tengo su nombre...\")\n- Cuando pidas el siguiente dato, podÃ©s hacer referencia a lo que ya obtuviste\n- Los mensajes deben ser breves pero claros\n\n# FORMATO\n- Strings faltantes = \"\" ; nÃºmeros faltantes = 0\n- ERROR = true si falta o estÃ¡ invÃ¡lido **cualquier** campo. ERROR=false solo si los 5 estÃ¡n completos y vÃ¡lidos\n\n# EJEMPLOS (NO IMPRIMIR)\n\n## Caso: usuario solo envÃ­a NOMBRE (\"Hector miralles\")\n{\n  \"status\":\"ASK\",\n  \"ask\":\"Perfecto, Hector. Ahora necesito su DNI, por favor (7 u 8 dÃ­gitos, sin puntos)\",\n  \"missing\":[\"DNI\",\"OBRA_SOCIAL\",\"DIRECCION\",\"TELEFONO\"],\n  \"data\":{\"NOMBRE\":\"Hector miralles\",\"DNI\":0,\"OBRA_SOCIAL\":\"\",\"NOMBRE_OBRA_SOCIAL\":\"\",\"DIRECCION\":\"\",\"TELEFONO\":0},\n  \"ERROR\": true,\n  \"ERROR_MESSAGE\": \"AÃºn faltan algunos datos: DNI, obra social, direcciÃ³n y telÃ©fono\"\n}\n\n## Caso: DNI provisto pero con puntos (\"12.345.678\")\n{\n  \"status\":\"ASK\",\n  \"ask\":\"Disculpe, necesito el DNI sin puntos. Â¿Puede enviarlo solo con nÃºmeros? Por ejemplo: 12345678\",\n  \"missing\":[\"OBRA_SOCIAL\",\"DIRECCION\",\"TELEFONO\"],\n  \"data\":{\"NOMBRE\":\"Hector miralles\",\"DNI\":0,\"OBRA_SOCIAL\":\"\",\"NOMBRE_OBRA_SOCIAL\":\"\",\"DIRECCION\":\"\",\"TELEFONO\":0},\n  \"ERROR\": true,\n  \"ERROR_MESSAGE\": \"El DNI que me pasÃ³ no es vÃ¡lido. Por favor, envÃ­eme solo los nÃºmeros, sin puntos ni espacios (ejemplo: 35946257)\"\n}\n\n## Caso: Ya tenemos nombre y DNI vÃ¡lido, pedimos obra social\n{\n  \"status\":\"ASK\",\n  \"ask\":\"Excelente. Â¿Tiene obra social o es particular?\",\n  \"missing\":[\"OBRA_SOCIAL\",\"DIRECCION\",\"TELEFONO\"],\n  \"data\":{\"NOMBRE\":\"Hector Miralles\",\"DNI\":12345678,\"OBRA_SOCIAL\":\"\",\"NOMBRE_OBRA_SOCIAL\":\"\",\"DIRECCION\":\"\",\"TELEFONO\":0},\n  \"ERROR\": true,\n  \"ERROR_MESSAGE\": \"Me faltan los siguientes datos: obra social, direcciÃ³n y telÃ©fono\"\n}\n\n## Caso: Obra social no encontrada\n{\n  \"status\":\"ASK\",\n  \"ask\":\"Disculpe, la obra social 'Medicus Plus' no figura en nuestro sistema. Â¿PodrÃ­a verificar el nombre exacto o indicarme si es particular?\",\n  \"missing\":[\"DIRECCION\",\"TELEFONO\"],\n  \"data\":{\"NOMBRE\":\"Hector Miralles\",\"DNI\":12345678,\"OBRA_SOCIAL\":\"\",\"NOMBRE_OBRA_SOCIAL\":\"\",\"DIRECCION\":\"\",\"TELEFONO\":0},\n  \"ERROR\": true,\n  \"ERROR_MESSAGE\": \"Disculpe, la obra social que mencionÃ³ no figura en nuestro sistema. Â¿PodrÃ­a verificar el nombre o indicar si es particular?\"\n}\n\n## FINAL OK (todo completo y vÃ¡lido)\n{\n  \"status\":\"FINAL\",\n  \"ask\":\"\",\n  \"missing\":[],\n  \"data\":{\"NOMBRE\":\"Hector Miralles\",\"DNI\":12345678,\"OBRA_SOCIAL\":\"1\",\"NOMBRE_OBRA_SOCIAL\":\"Ioma\",\"DIRECCION\":\"Calle 50 123\",\"TELEFONO\":2215551234},\n  \"ERROR\": false,\n  \"ERROR_MESSAGE\":\"\"\n}\n\n## Caso: Usuario envÃ­a todo junto pero direcciÃ³n incompleta\n{\n  \"status\":\"ASK\",\n  \"ask\":\"Casi listo. Me falta el nÃºmero de su direcciÃ³n. Â¿En quÃ© nÃºmero de la Calle 50 vive?\",\n  \"missing\":[\"TELEFONO\"],\n  \"data\":{\"NOMBRE\":\"Hector Miralles\",\"DNI\":12345678,\"OBRA_SOCIAL\":\"1\",\"NOMBRE_OBRA_SOCIAL\":\"Ioma\",\"DIRECCION\":\"\",\"TELEFONO\":0},\n  \"ERROR\": true,\n  \"ERROR_MESSAGE\": \"Me falta la direcciÃ³n completa. Por favor, indÃ­queme calle y nÃºmero (ejemplo: Calle 50 NÂ°123)\"\n}"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[1232,-768],"id":"8d33bb45-dd62-4432-806e-f1a65f9cb792","name":"AI Agent"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').item.json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"*ðŸ“‹ PACIENTE REGISTRADO*\\n\\n*PARA CONTINUAR CON SU TURNO, NECESITO SU DNI:*\\n\\n*ðŸ“ FORMATO:*\\nENVÃE SOLO SU NÃšMERO DE DNI (SIN PUNTOS NI ESPACIOS)\\n\\n*EJEMPLO:*\\n_35987654_\\n\\nðŸ‘‡ *ESCRIBA SU DNI Y ENVÃELO*\"\n    },\n    \"footer\": {\n      \"text\": \"ðŸ“… LUN-VIE 8-20HS\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"volver-atras\",\n            \"title\": \"VOLVER ATRÃS\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[720,5152],"id":"e2327f3f-73f4-4636-9a98-f11cbcb2bcec","name":"SOLICITAR DNI PACIENTE","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Filter1').item.json.contactNumber }}","value":"PACIENTE=1","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[944,5152],"id":"a12f7e12-95c2-4bf3-b913-48876a2fc4cf","name":"PACIENTE REGISTRADO","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"068a964d-25b6-4a1f-8e05-c47dd2fea4b7","leftValue":"={{ $json.output.ERROR }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1632,-112],"id":"b8350eea-b08b-4f44-8ab9-ebf705ec7e8b","name":"Error informacion de usuario1"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').first().json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"âš ï¸ {{ $json.output.ERROR_MESSAGE }}\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1872,-240],"id":"f61821d7-5dea-4178-afc1-695535442d99","name":"âš ï¸ DATOS INCORRECTOS1","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"4d4f5d9a-5ad9-495c-82f0-043f7f0ef5d6","leftValue":"={{ $json.output.esta_empadronado }}","rightValue":"verificacion_exitosa","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2080,-16],"id":"1a0ff631-d730-4392-b3be-3d5e89f134eb","name":"Exito1"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[1056,-256],"id":"d7b1ec31-25c1-4fc2-9cf2-7687c25ee47d","name":"OpenRouter Chat Model","credentials":{"openRouterApi":{"id":"ZlcbniUoDvrFqCIJ","name":"OpenRouter ICLP"}}},{"parameters":{"jsonSchemaExample":"{  \n  \"DNI\": \"string\",  \n  \"ERROR\": false,\n  \"ERROR_MESSAGE\": \"\"\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[1472,-288],"id":"95d1ec07-e7cf-40df-8f38-e918aa795460","name":"Structured Output Parser"},{"parameters":{"promptType":"define","text":"=dni usuario :{{ $('Filter1').first().json.message }}","hasOutputParser":true,"options":{"systemMessage":"=# TAREA\n\n- Analizar el contido que llega y ordenarlo en un objeto JSON\n\n{\n  \n  \"DNI\":\"\"\n \n}\n\n# IMPORTANTE\n\n- Debes analizar si el dni esta bien escrito, debe contener entre 7 y 8 digitos ya que los usuarios mayores poseen 7 digitos y los mas actuales 8 digitos.\n- No deben contener espacios"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[1232,-112],"id":"ca10d9df-9480-408e-946a-b8b3bff4c268","name":"AI Agent1"},{"parameters":{"workflowId":{"__rl":true,"value":"oB7pjyME2Gvo5moH","mode":"list","cachedResultName":"SUB - GET_PACIENTE"},"workflowInputs":{"mappingMode":"defineBelow","value":{"dni":"={{ $json.output.DNI || $('DNI').item.json.status.replace('DNI:', '') ||$('â±ï¸ YA SE ACTIVO MENU?').item.json.status.replace('DNI:', '')  }}","telefono":"={{ $('Filter1').first().json.contactNumber }}"},"matchingColumns":["dni"],"schema":[{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"telefono","displayName":"telefono","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[1888,112],"id":"4e4a5dc9-dc5c-4c8a-a439-3381b70c9a1d","name":"Get_Paciente"},{"parameters":{"operation":"set","key":"=status:{{ $('Filter1').first().json.contactNumber }}","value":"=DNI:{{ $('Get_Paciente').first().json.output.paciente_dni }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2640,-176],"id":"a44cab3a-2110-45a8-8176-5bf32a817dd6","name":"DNI","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"url":"http://iclp.ddns.net:7080/ws-turnos-rest-simple/api/turnos/lista-turnos-actuales","sendQuery":true,"queryParameters":{"parameters":[{"name":"usuario","value":"WSTRRED"},{"name":"password","value":"Y2xpb25lcw"},{"name":"dni","value":"={{ $('â±ï¸ YA SE ACTIVO MENU?').item.json.status.replace('DNI:', '') }}"},{"name":"fecha","value":"={{ $now.setZone('America/Argentina/Buenos_Aires').toFormat('yyyyLLdd') }}"}]},"options":{"response":{"response":{"neverError":true,"responseFormat":"json"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[720,5376],"id":"2cfac190-c11e-4d39-b824-7b965e96c787","name":"get_turnos_agendados"},{"parameters":{"assignments":{"assignments":[{"id":"8c6cf375-6158-46f1-8b42-593cf42fff40","name":"lista","value":"={{ $json.lista[0] }}","type":"object"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[944,5376],"id":"ef7157d3-d3d1-436b-aab7-14a4f71e6954","name":"datos"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.recipient_type }}"},{"name":"to","value":"={{ $json.to }}"},{"name":"type","value":"={{ $json.type }}"},{"name":"interactive","value":"={{ $json.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1392,5376],"id":"58dcf560-0ab4-4585-926f-3089221f456a","name":"MIS TURNOS","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"url":"http://iclp.ddns.net:7080/ws-turnos-rest-simple/api/turnos/lista-turnos-actuales","sendQuery":true,"queryParameters":{"parameters":[{"name":"usuario","value":"WSTRRED"},{"name":"password","value":"Y2xpb25lcw"},{"name":"dni","value":"={{ $('â±ï¸ YA SE ACTIVO MENU?').item.json.status.replace('DNI:', '') }}"},{"name":"fecha","value":"={{ $now.setZone('America/Argentina/Buenos_Aires').toFormat('yyyyLLdd') }}"}]},"options":{"response":{"response":{"neverError":true,"responseFormat":"json"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[720,5600],"id":"1ffc5654-fb32-49f9-b77e-9e35ece7e6ed","name":"get_turnos_agendados1"},{"parameters":{"assignments":{"assignments":[{"id":"8c6cf375-6158-46f1-8b42-593cf42fff40","name":"lista","value":"={{ $json.lista[0] }}","type":"object"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[944,5600],"id":"c750126f-e14f-4a9c-b60d-b42bf7b0c038","name":"datos1"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.recipient_type }}"},{"name":"to","value":"={{ $json.to }}"},{"name":"type","value":"={{ $json.type }}"},{"name":"interactive","value":"={{ $json.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1392,5600],"id":"5b80b1ac-f04c-4e9d-a377-4f4f2f8e3f8e","name":"MIS TURNOS1","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"jsCode":"// Obtener la lista de turnos\nconst turnos = $input.all();\n\n// FunciÃ³n para validar si un turno tiene datos vÃ¡lidos\nfunction turnoValido(turno) {\n  const datos = turno.json.lista || turno.json;\n  \n  // Verificar que tenga al menos fecha y hora vÃ¡lidas\n  const tieneFecha = datos.fechaString && datos.fechaString !== 'Sin fecha' && datos.fechaString.length > 0;\n  const tieneHora = datos.hora5digitos && datos.hora5digitos !== 'Sin hora' && datos.hora5digitos.length > 0;\n  const tieneNombre = datos.nombreMedico && datos.nombreMedico !== 'Sin nombre' && datos.nombreMedico.length > 0;\n  \n  return tieneFecha && tieneHora && tieneNombre;\n}\n\n// Filtrar solo turnos vÃ¡lidos\nconst turnosValidos = turnos.filter(turnoValido);\n\n// Verificar si hay turnos vÃ¡lidos\nif (!turnosValidos || turnosValidos.length === 0) {\n  return [{\n    json: {\n      messaging_product: \"whatsapp\",\n      recipient_type: \"individual\",\n      to: $('Filter1').first().json.contactNumber,\n      type: \"interactive\",\n      interactive: {\n        type: \"button\",\n        body: {\n          text: \"âŒ NO TENÃ‰S TURNOS PROGRAMADOS EN ESTE MOMENTO\"\n        },\n        footer: {\n          text: \"ðŸ“… Lun-Vie 8-20hs\"\n        },\n        action: {\n          buttons: [\n            {\n              type: \"reply\",\n              reply: {\n                id: \"menu-principal\",\n                title: \"ðŸ  MENU PRINCIPAL\"\n              }\n            }\n          ]\n        }\n      }\n    }\n  }];\n}\n\n// Crear rows para la lista de turnos\nconst rows = [];\n\nfor (let i = 0; i < turnosValidos.length; i++) {\n  const turno = turnosValidos[i].json.lista || turnosValidos[i].json;\n  \n  const fechaString = turno.fechaString;\n  const hora5digitos = turno.hora5digitos;\n  const nombreMedico = turno.nombreMedico;\n  const matricula = turno.matricula || '';\n  \n  // Separar apellido del mÃ©dico y tipo de estudio\n  const partes = nombreMedico.split(' ');\n  const apellido = partes.length > 1 ? partes[partes.length - 1] : nombreMedico;\n  const tipoEstudio = partes.length > 1 ? partes.slice(0, -1).join(' ') : 'CONSULTA';\n  \n  // Formatear fecha de \"20251016\" a \"16-10-2025\"\n  let fechaFormateada = fechaString;\n  if (fechaString.length === 8) {\n    const aÃ±o = fechaString.substring(0, 4);\n    const mes = fechaString.substring(4, 6);\n    const dia = fechaString.substring(6, 8);\n    fechaFormateada = `${dia}-${mes}-${aÃ±o}`;\n  }\n  \n  // Crear title corto (mÃ¡ximo 24 caracteres)\n  let title = `${apellido}-${fechaFormateada}`;\n  if (title.length > 24) {\n    title = title.substring(0, 21) + '...';\n  }\n  \n  // Crear description (mÃ¡ximo 72 caracteres)\n  let description = `${tipoEstudio} - ${hora5digitos}`;\n  if (description.length > 72) {\n    description = description.substring(0, 69) + '...';\n  }\n  \n  // ID Ãºnico para el turno (fecha + hora + matricula)\n  const id = `turno-${fechaString}-${hora5digitos.replace(':', '')}-${matricula}`;\n  \n  rows.push({\n    id: id,\n    title: title,\n    description: description\n  });\n}\n\n// Limitar a 9 turnos mÃ¡ximo\nconst rowsLimitados = rows.slice(0, 9);\n\n// Retornar lista interactiva\nreturn [{\n  json: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: $('Filter1').first().json.contactNumber,\n    type: \"interactive\",\n    interactive: {\n      type: \"list\",\n      header: {\n        type: \"text\",\n        text: \"ðŸ—‘ï¸ CANCELAR TURNO\"\n      },\n      body: {\n        text: \"SELECCIONÃ EL TURNO QUE QUERÃ‰S CANCELAR\"\n      },\n      footer: {\n        text: \"ðŸ“… Lun-Vie 8-20hs\"\n      },\n      action: {\n        button: \"VER TURNOS\",\n        sections: [\n          {\n            title: \"TUS TURNOS\",\n            rows: rowsLimitados\n          }\n        ]\n      }\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1168,5600],"id":"a138841c-b026-4a50-a48d-103f8f5bad09","name":"ðŸš« CANCELAR TURNO"},{"parameters":{"jsCode":"// Obtener el objeto lista (que es un objeto, no un array)\nconst turno = $input.first().json.lista;\n\n// Verificar si existe el turno\nif (!turno || Object.keys(turno).length === 0) {\n  return [{\n    json: {\n      messaging_product: \"whatsapp\",\n      recipient_type: \"individual\",\n      to: $('Filter1').first().json.contactNumber,\n      type: \"interactive\",\n      interactive: {\n        type: \"button\",\n        body: {\n          text: \"âŒ NO TENÃ‰S TURNOS PROGRAMADOS EN ESTE MOMENTO\"\n        },\n        footer: {\n          text: \"ðŸ“… Lun-Vie 8-20hs\"\n        },\n        action: {\n          buttons: [\n            {\n              type: \"reply\",\n              reply: {\n                id: \"volver-atras\",\n                title: \"VOLVER ATRÃS\"\n              }\n            }\n          ]\n        }\n      }\n    }\n  }];\n}\n\n// Extraer datos del turno\nconst fechaString = turno.fechaString || 'Sin fecha'; // Ejemplo: \"20251016\"\nconst hora5digitos = turno.hora5digitos || 'Sin hora'; // Ejemplo: \"10:20\"\nconst nombreMedico = turno.nombreMedico || 'Sin nombre'; // Ejemplo: \"ERGOMETRIA BARBIERI\"\nconst matricula = turno.matricula || 'Sin matrÃ­cula'; // Ejemplo: \"139\"\n\n// Separar apellido del mÃ©dico y tipo de estudio\n// Ejemplo: \"ERGOMETRIA BARBIERI\" -> apellido=\"BARBIERI\", estudio=\"ERGOMETRIA\"\nconst partes = nombreMedico.split(' ');\nconst apellido = partes.length > 1 ? partes[partes.length - 1] : nombreMedico;\nconst tipoEstudio = partes.length > 1 ? partes.slice(0, -1).join(' ') : 'CONSULTA';\n\n// Formatear fecha de \"20251016\" a \"16-10-2025\"\nlet fechaFormateada = fechaString;\nif (fechaString.length === 8) {\n  const aÃ±o = fechaString.substring(0, 4);\n  const mes = fechaString.substring(4, 6);\n  const dia = fechaString.substring(6, 8);\n  fechaFormateada = `${dia}-${mes}-${aÃ±o}`;\n}\n\n// Construir el mensaje con formato mejorado\nconst mensajeTurnos = `ðŸ“‹ *TUS TURNOS PROGRAMADOS:*\\n\\nðŸ‘¨â€âš•ï¸ *Turno con:* Dr. ${apellido} | MatrÃ­cula ${matricula}\\nðŸ©º *Tipo de estudio:* ${tipoEstudio}\\nðŸ“… *Fecha:* ${fechaFormateada} a las ${hora5digitos}`;\n\n// Retornar el mensaje con botÃ³n\nreturn [{\n  json: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: $('Filter1').first().json.contactNumber,\n    type: \"interactive\",\n    interactive: {\n      type: \"button\",\n      body: {\n        text: mensajeTurnos\n      },\n      footer: {\n        text: \"ðŸ“… Lun-Vie 8-20hs\"\n      },\n      action: {\n        buttons: [\n          {\n            type: \"reply\",\n            reply: {\n              id: \"volver-atras\",\n              title: \"VOLVER ATRÃS\"\n            }\n          }\n        ]\n      }\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1168,5376],"id":"396aa2fd-9db5-48a2-a43d-8d152f275ab0","name":"ðŸ“‹ LISTAR TURNOS"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ðŸ«€ INSTITUTO DE CARDIOLOGÃA LA PLATA\"\n    },\n    \"body\": {\n      \"text\": \"Recuerda que MOMENTÃNEAMENTE SOLO DAMOS LOS TURNOS MÃS PRÃ“XIMOS\\n\\nSi necesita una fecha mÃ¡s lejana elija la opciÃ³n de administraciÃ³n\"\n    },\n    \"footer\": {\n      \"text\": \"ðŸ“… Lun-Vie 8-20hs\"\n    },\n    \"action\": {\n      \"buttons\": [\n              {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"con-consultorio\",\n            \"title\": \"TURNOS CONSULTORIO\"\n          }\n        },\n      {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"con-estudio\",\n            \"title\": \"TURNOS ESTUDIO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"volver-atras\",\n            \"title\": \"VOLVER ATRÃS\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[720,1568],"id":"6b9f6176-61b0-41a9-9e47-baaaca9fa68f","name":"BUSCAR ESPECIALIDAD","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"content":"### ESPECIALIDADES","height":224,"width":976,"color":4},"type":"n8n-nodes-base.stickyNote","position":[624,2400],"typeVersion":1,"id":"f1651d78-d4e8-42d1-936c-074a481787c7","name":"Sticky Note"},{"parameters":{"operation":"set","key":"=status:{{ $('Filter1').first().json.contactNumber }}","value":"ESPECIALIDADES=1","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1392,2016],"id":"dedd4511-7bec-43d3-a00d-7413f70becfb","name":"ESPECIALIDADES1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.recipient_type }}"},{"name":"to","value":"={{ $json.to }}"},{"name":"type","value":"={{ $json.type }}"},{"name":"interactive","value":"={{ $json.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1168,2016],"id":"a51e806f-4dca-4f48-b987-05fa6bc2673e","name":"ðŸ©» ESPECIALIDADES1","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"jsCode":"// Obtener todas las especialidades del input\nconst items = $input.all();\n\n// Crear el array de rows dinÃ¡micamente\nconst rows = items.map(item => {\n  const especialidad = item.json.Especialidad;\n  const codigo = item.json.Codigo;\n  \n  // Convertir a mayÃºsculas\n  let nombreEspecialidad = especialidad.toUpperCase();\n  \n  // Si tiene parÃ©ntesis, tomar solo lo que estÃ¡ antes\n  if (nombreEspecialidad.includes('(')) {\n    nombreEspecialidad = nombreEspecialidad.split('(')[0].trim();\n  }\n  \n  // Si tiene barra, tomar solo la primera parte\n  if (nombreEspecialidad.includes('/')) {\n    nombreEspecialidad = nombreEspecialidad.split('/')[0].trim();\n  }\n  \n  // Si tiene mÃºltiples palabras, tomar solo la primera palabra\n  if (nombreEspecialidad.includes(' ')) {\n    nombreEspecialidad = nombreEspecialidad.split(' ')[0];\n  }\n  \n  // Crear el title con formato: ESPECIALIDAD-CODIGO\n  let title = `${nombreEspecialidad}-${codigo}`;\n  \n  // Si aÃºn es muy largo, cortar a 24 caracteres\n  if (title.length > 24) {\n    title = title.substring(0, 21) + '...';\n  }\n  \n  // Crear descripciÃ³n completa\n  let description = especialidad;\n  \n  // WhatsApp permite MÃXIMO 72 caracteres en ROW_DESCRIPTION\n  if (description.length > 72) {\n    description = description.substring(0, 69) + '...';\n  }\n  \n  return {\n    id: codigo,\n    title: title,\n    description: description\n  };\n});\n\n// Agregar botÃ³n \"VER MÃS\" al final de la lista\nrows.push({\n  id: \"ver-mas\",\n  title: \"VOLVER\",\n  description: \"VER MÃS OPCIONES Y ESPECIALIDADES DISPONIBLES\"\n});\n\n// Retornar el JSON completo con la estructura de WhatsApp\nreturn [{\n  json: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: $('Filter1').first().json.contactNumber,\n    type: \"interactive\",\n    interactive: {\n      type: \"list\",\n      header: {\n        type: \"text\",\n        text: \"ðŸ©º ESPECIALIDADES\"\n      },\n      body: {\n        text: \"*ðŸ“‹ Â¿CÃ“MO FUNCIONA?*\\n\\n*1ï¸âƒ£ ELEGÃ LA ESPECIALIDAD*\\nPRESIONÃ EL BOTÃ“N Y SELECCIONÃ LA ESPECIALIDAD MÃ‰DICA QUE NECESITÃS\\n\\n*2ï¸âƒ£ ELEGÃ EL MÃ‰DICO*\\nLUEGO PODRÃS VER Y SELECCIONAR LOS PROFESIONALES DISPONIBLES EN ESA ESPECIALIDAD\\n\\nðŸ‘‡ *PRESIONÃ PARA COMENZAR*\"\n      },\n      footer: {\n        text: \"ðŸ“… LUN-VIE 8-20HS\"\n      },\n      action: {\n        button: \"VER ESPECIALIDADES\",\n        sections: [\n          {\n            title: \"ELEGIR UNA OPCIÃ“N\",\n            rows: rows\n          }\n        ]\n      }\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[944,2016],"id":"73045f57-0b6f-4a14-b5cd-3f0bdffbfe53","name":"LISTA1"},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"mi8p2u7tvuplzt5","limit":3,"options":{"sort":{"property":[{"field":"Especialidad","direction":"desc"}]}}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[720,2016],"id":"4b3eb6ff-0b6e-43c7-b3c9-694e741f3218","name":"Get_Especialidades1","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"content":"###  VER MAS ESPECIALIDADES","height":224,"width":976,"color":5},"type":"n8n-nodes-base.stickyNote","position":[624,1952],"typeVersion":1,"id":"1f1cb1e9-5fcb-44f3-9d25-53ce94356d04","name":"Sticky Note1"},{"parameters":{"workflowId":{"__rl":true,"value":"gsbUq8JFSpw8U7yR","mode":"list","cachedResultName":"Etiqueta_Consulta_Reclamo"},"workflowInputs":{"mappingMode":"defineBelow","value":{"humano":true,"accountId":"={{ $('Filter1').first().json.accountId }}","conversationId":"={{ $('Filter1').item.json.conversationId.toString() }}","contactId":"={{ $('Filter1').item.json.contactId.toString() }}","message":"={{ $('Filter1').item.json.message }}","inboxId":"={{ $('Filter1').item.json.inboxId.toString() }}","chatwootUrlBase":"={{ $('Filter1').item.json.chatwootUrl }}","tokenChatwoot":"={{ $('Filter1').item.json.agenteBotTokenWhatsapp }}","tipoIntencion":"consultas-reclamos"},"matchingColumns":[],"schema":[{"id":"accountId","displayName":"accountId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"conversationId","displayName":"conversationId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"contactId","displayName":"contactId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"message","displayName":"message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"inboxId","displayName":"inboxId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"humano","displayName":"humano","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"boolean"},{"id":"chatwootUrlBase","displayName":"chatwootUrlBase","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"tokenChatwoot","displayName":"tokenChatwoot","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"tipoIntencion","displayName":"tipoIntencion","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[720,1344],"id":"b9fac2ac-d95f-4555-924c-2c0dadfac731","name":"ETIQUETA CONSULTA-RECLAMO"},{"parameters":{"workflowId":{"__rl":true,"value":"xBZYzq5pKXYbUGV7","mode":"list","cachedResultName":"SUB - Etiqueta_Turno_Estudio"},"workflowInputs":{"mappingMode":"defineBelow","value":{"humano":true,"accountId":"={{ $('Filter1').item.json.accountId }}","conversationId":"={{ $('Filter1').item.json.conversationId.toString() }}","contactId":"={{ $('Filter1').item.json.contactId.toString() }}","message":"={{ $('Filter1').item.json.message }}","inboxId":"={{ $('Filter1').item.json.inboxId.toString() }}","chatwootUrlBase":"={{ $('Filter1').item.json.chatwootUrl }}","tokenChatwoot":"={{ $('Filter1').item.json.agenteBotTokenWhatsapp }}","tipoIntencion":"turnos-estudios"},"matchingColumns":[],"schema":[{"id":"accountId","displayName":"accountId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"conversationId","displayName":"conversationId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"contactId","displayName":"contactId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"message","displayName":"message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"inboxId","displayName":"inboxId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"humano","displayName":"humano","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"boolean"},{"id":"chatwootUrlBase","displayName":"chatwootUrlBase","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"tokenChatwoot","displayName":"tokenChatwoot","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"tipoIntencion","displayName":"tipoIntencion","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[720,1792],"id":"5a6505d2-5f3f-4d2e-b3c7-69e76edaa6b8","name":"TURNOS ESTUDIO"},{"parameters":{"operation":"set","key":"=CODIGO_ESPECIALIDAD:{{ $('Filter1').first().json.contactNumber }}","value":"={{ $('Filter1').first().json.message }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2288,3808],"id":"5dfe7463-7a2e-49f4-baeb-75830e2bbab4","name":"ESPECIALIDAD-USADO PARA VOLVER ATRAS","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"medicos_volver_atras","key":"=CODIGO_ESPECIALIDAD:{{ $('Filter1').first().json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[720,3360],"id":"e589f971-46e9-493d-b724-5c509e24d099","name":"get_codigo_especialidad","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=DATOS_MEDICO:{{ $('Filter1').item.json.contactNumber }}","value":"={{ JSON.stringify($('datos1').item.json.lista) }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1616,5600],"id":"f8ca6e53-1baf-4e4d-9ebb-e0e2f2ba79aa","name":"Datos turnos","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"delete","key":"=DATOS_MEDICO:{{ $('Filter1').first().json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[720,2224],"id":"84943511-a0c6-45c5-9d24-4393b77272e7","name":"Redis1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"workflowId":{"__rl":true,"value":"54erSSiJNvNSRnpK","mode":"list","cachedResultName":"BETA_PROD - DELETE TURNO"},"workflowInputs":{"mappingMode":"defineBelow","value":{"matricula":"={{ $json.delete.parseJson().matricula }}","fecha":"={{ $json.delete.parseJson().fechaString.toNumber() }}","hora":"={{ $json.delete.parseJson().hora.toNumber() }}","num_conver":"={{ $('Filter1').first().json.conversationId }}"},"matchingColumns":[],"schema":[{"id":"matricula","displayName":"matricula","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"fecha","displayName":"fecha","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"hora","displayName":"hora","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"num_conver","displayName":"num_conver","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[944,2224],"id":"b73c9abc-fd34-44b1-ac8a-220d12131aa7","name":"Execute Workflow1"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').item.json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"âœ… *TURNO CANCELADO EXITOSAMENTE*\\n\\nðŸ—“ï¸ Tu turno ha sido cancelado correctamente.\\n\\nðŸ“‹ *Detalles de la cancelaciÃ³n:*\\nâ€¢ MÃ©dico: Dr./Dra. {{ $json.nombreMedico }}\\nâ€¢ Fecha: {{ $json.fecha }}\\nâ€¢ Hora: {{ $json.hora }}hs\\n\\nðŸ’¡ *Â¿NecesitÃ¡s reagendar?*\\nPodÃ©s solicitar un nuevo turno cuando lo necesites.\\n\\n*TambiÃ©n podÃ©s contactarnos:*\\nâ€¢ TelÃ©fono: (0221) 4906310\\nâ€¢ Horarios: Lunes a Viernes 8:00-20:00hs\\n\\nÂ¡Esperamos verte pronto! â¤ï¸\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1392,2224],"id":"6e141017-e6ef-439a-afcb-aa10a0a6fb1e","name":"ðŸš« TURNO-CANCELADO","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"jsCode":"// Parsear el JSON que viene como string\nconst deleteData = JSON.parse($('Redis1').item.json.delete);\n\n// Convertir fecha Unix (milisegundos) a formato legible DD/MM/YYYY\nconst fechaUnix = deleteData.fecha;\nconst fechaObj = new Date(fechaUnix);\nconst dia = String(fechaObj.getDate()).padStart(2, '0');\nconst mes = String(fechaObj.getMonth() + 1).padStart(2, '0'); // Los meses empiezan en 0\nconst aÃ±o = fechaObj.getFullYear();\nconst fechaLegible = `${dia}/${mes}/${aÃ±o}`;\n\n// Convertir hora de \"1540\" a \"15:40\"\nconst horaString = deleteData.hora;\nconst horaLegible = horaString.slice(0, 2) + ':' + horaString.slice(2);\n\n// Retornar todos los datos formateados\nreturn [{\n  json: {\n    matricula: deleteData.matricula,\n    fechaOriginal: deleteData.fecha,\n    fecha: fechaLegible, // \"14/11/2025\"\n    horaOriginal: deleteData.hora,\n    hora: horaLegible, // \"15:40\"\n    horasDigitos: deleteData.horasDigitos,\n    fechaString: deleteData.fechaString,\n    nombreMedico: deleteData.nombreMedico,\n    nombrePaciente: deleteData.nombrePaciente,\n    celular: deleteData.celular,\n    especialidad: deleteData.especialidad,\n    dni: deleteData.dni,\n    obraSocial: deleteData.obraSocial\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1168,2224],"id":"33f0c477-ce85-4e06-a01f-9d334125d8a2","name":"Code3"},{"parameters":{"operation":"delete","key":"=status:{{ $('Filter1').item.json.contactNumber }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1616,2224],"id":"4b70fe29-6e73-472b-aba4-891b19f98d3a","name":"DELETE - STATUS MENU2","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"status:+5492254596618"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1392,4704],"id":"bab69048-fa0f-4eaa-953e-6801a6ea71f0","name":"DELETE - STATUS MENU3","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').item.json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"ðŸ•’ *HORARIO DE ATENCIÃ“N*\\n\\nðŸ“… *Nuestros horarios son:*\\nâ€¢ Lunes a Viernes: 08:00 - 20:00hs\\nâ€¢ SÃ¡bados: 08:00 - 13:00hs\\nâ€¢ Domingos: CERRADO\\n\\nðŸ“ž *Contacto:*\\nTelÃ©fono: (0221) 4906310\\n\\nÂ¡Te esperamos! ðŸ’™\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[720,2688],"id":"5a150fe7-cf0a-44c8-8ea7-dedd5d8d114c","name":"HORARIOS","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').item.json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": true,\n    \"body\": \"ðŸ“ *UBICACIÃ“N*\\n\\nðŸ¥ *INSTITUTO DE CARDIOLOGÃA LA PLATA*\\n\\nðŸ“Œ *DirecciÃ³n:*\\nCalle 6 NÂ°212 (entre 36 y 37)\\nLa Plata, Buenos Aires\\n\\nðŸ—ºï¸ *Ver en Google Maps:*\\nhttps://maps.app.goo.gl/ij23zZscf3vTKQV56\\n\\nðŸ“ž *TelÃ©fono:*\\n(0221) 4906310\\n\\nÂ¡Te esperamos! ðŸ’š\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[720,3136],"id":"e1567ce3-8e4d-48c8-841f-b1ddd7497cea","name":"UBICACION","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').item.json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": true,\n    \"body\": \"ðŸ’» *PORTAL DEL PACIENTE*\\n\\nðŸŒ *Acceso:*\\nwww.iclp.com.ar â†’ \\\"PORTAL PACIENTES\\\"\\n\\nðŸ” *Tus datos de acceso:*\\nâ€¢ Usuario: [TU DNI] (sin puntos)\\nâ€¢ ContraseÃ±a: p + Ãºltimos 5 nÃºmeros del DNI\\n\\nðŸ“ *Ejemplo:*\\nDNI 12345678 â†’ ContraseÃ±a: p45678\\n\\nÂ¿NecesitÃ¡s ayuda? Â¡Contactanos! ðŸ’™\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[720,3584],"id":"0c9c9050-ccff-4f95-8e2a-80dac0572c9e","name":"PORTAL GENERAL","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').item.json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"ðŸ’Š *RECETAS MÃ‰DICAS*\\n\\nâœ¨ Â¡Te explico cÃ³mo pedir tus recetas!\\n\\nðŸ“§ *MANERA MÃS FÃCIL - POR EMAIL*\\nâœ‰ï¸ Correo: recetas@iclpsrl.com.ar\\n\\nðŸ“ *Envianos:*\\nâ€¢ Apellido y nombre\\nâ€¢ Obra social\\nâ€¢ NÃºmero de afiliado\\nâ€¢ Nombre del mÃ©dico\\n\\nðŸš¨ *ATENCIÃ“N ESPECIAL - Dr. FabiÃ¡n Barba*\\nðŸ“² Sus recetas solo por WhatsApp:\\n2216810260\\n\\nÂ¿NecesitÃ¡s ayuda? Â¡Estamos para ayudarte! ðŸ’š\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[720,4032],"id":"5a2bc869-c53a-4c37-9ca4-db44f322545c","name":"EMAIL RECETAS","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').first().json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": {{ JSON.stringify($json.mensaje) }}\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1168,4928],"id":"68bb499c-0e1f-4b50-956a-08bae338ac8a","name":"ESPECIALIDADES2","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=datos_recolectados:{{ $('Filter1').first().json.contactNumber }}","value":"={{ JSON.stringify($('AI Agent').item.json.output) }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2080,-864],"id":"b26b34d0-080d-4919-954d-42d3bed63c20","name":"DATOS RECOLECTADOS","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ðŸ«€ ICLP - GESTIÃ“N DE TURNOS\"\n    },\n    \"body\": {\n      \"text\": \"*HOLA {{ $json.output.paciente_nombre }} âœ…*\\n\\n*ðŸ“‹ SUS DATOS EN NUESTRO SISTEMA:*\\n\\nðŸ‘¤ *NOMBRE:* *{{ $json.output.paciente_nombre }}*\\n\\nðŸ†” *DNI:* *{{ $json.output.paciente_dni }}*\\n\\nðŸ“ž *TELÃ‰FONO:* *{{ $json.output.paciente_celular }}*\\n\\nâœ… *SI LOS DATOS SON CORRECTOS, PRESIONE CONTINUAR*\\n\\nâš ï¸ *Â¿HAY ALGÃšN ERROR?*\\nCOMUNÃQUESE CON ADMINISTRACIÃ“N:\\nðŸ“ž (0221) 490-6310\"\n    },\n    \"footer\": {\n      \"text\": \"ðŸ“… LUN-VIE 8-20HS\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"CONTINUAR\",\n            \"title\": \"CONTINUAR\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"MENU-PRINCIPAL\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2352,-176],"id":"0454d737-c31b-40f4-932e-5bbb168ac0fe","name":"âœ… DATOS VALIDADOS2","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"m1kjf7ed0befl04","returnAll":true,"options":{}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[720,-112],"id":"2afb56ae-bece-4abd-955c-6a4253d3a7a7","name":"obra_social","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"m1kjf7ed0befl04","returnAll":true,"options":{}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[720,-768],"id":"b9c8fc64-3b8a-41ce-abba-24290ee01cf4","name":"obrasociales","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"jsCode":"return {\n    total: $input.all().length,\n    obrasociales: $input.all().map(item => ({\n        Id_os: item.json.Id,\n        nombre_obrasocial: item.json.nombre_obrasocial,\n        obrasocial: item.json.obrasocial\n    }))\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[944,-768],"id":"35f07495-9d3e-4d4f-85b6-3fbf12b06d7c","name":"Code6"},{"parameters":{"jsCode":"return {\n    total: $input.all().length,\n    obrasociales: $input.all().map(item => ({\n        Id_os: item.json.Id,\n        nombre_obrasocial: item.json.nombre_obrasocial,\n        obrasocial: item.json.obrasocial\n    }))\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[944,-112],"id":"8c1faab6-87cd-41b4-b833-f47049da3e9f","name":"Code7"},{"parameters":{"jsonSchemaExample":"{\n  \"NOMBRE\": \"Juan PÃ©rez\",\n  \"DNI\": 0,\n  \"OBRA_SOCIAL\": \"724\",\n  \"NOMBRE_OBRA_SOCIAL\": \"Osde\",\n  \"DIRECCION\": \"Calle 50 N 123\",\n  \"TELEFONO\": 2215551234,\n  \"ERROR\": true,\n  \"ERROR_MESSAGE\": \"DNI invÃ¡lido. Debe tener 7 u 8 dÃ­gitos sin puntos (ej: 12345678). Por favor, proporcionÃ¡ tu DNI sin puntos.\"\n}","autoFix":true},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[1456,-560],"id":"3ca3a4a9-8554-4840-bc5b-585a0a5a8e8d","name":"Structured Output Parser1"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ðŸ«€ ICLP - GESTIÃ“N DE TURNOS\"\n    },\n    \"body\": {\n      \"text\": \"ðŸ«€ *Â¡PERFECTO!*\\n\\nAL PARECER YA ESTÃ REGISTRADO EN NUESTRO SISTEMA.\\n\\nðŸ’“ *SUS DATOS REGISTRADOS:*\\n\\nðŸ‘¤ NOMBRE: {{ $json.output.paciente_nombre }}\\nðŸ†” DNI: {{ $json.output.paciente_dni }}\\nðŸ“ž TELÃ‰FONO: {{ $json.output.paciente_celular }}\\nðŸ©º OBRA SOCIAL: {{ $json.output.obraSocial || 'PARTICULAR' }}\\n\\nâœ… SI LOS DATOS SON CORRECTOS, PRESIONE CONTINUAR PARA GESTIONAR SU TURNO CARDIOLÃ“GICO\\n\\nâš ï¸ Â¿DETECTÃ“ ALGÃšN ERROR?\\nCOMUNÃQUESE CON ADMINISTRACIÃ“N:\\nðŸ“ž (0221) 490-6310\"\n    },\n    \"footer\": {\n      \"text\": \"ðŸ«€ ICLP - LUN-VIE 8-20HS\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"CONTINUAR\",\n            \"title\": \"CONTINUAR\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"MENU-PRINCIPAL\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2320,-752],"id":"43df8c3d-ce90-4194-a267-4fdf1dea92c8","name":"âœ… DATOS VALIDADOS3","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Filter1').first().json.contactNumber }}","sessionTTL":600,"contextWindowLength":10},"type":"@n8n/n8n-nodes-langchain.memoryRedisChat","typeVersion":1.5,"position":[1296,-416],"id":"b1335817-e1dd-4fc1-bd9d-1a3ed4685eb8","name":"Redis Chat Memory","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"content":"## INFO GENERAL - MEDICOS","height":224,"width":992,"color":5},"type":"n8n-nodes-base.stickyNote","position":[640,4432],"typeVersion":1,"id":"b9281829-8b88-4795-8f4a-febd28182302","name":"Sticky Note2"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').first().json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": {{ JSON.stringify($json.mensaje) }}\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1168,4496],"id":"9ff9ab39-e42d-40b9-8161-f3d70f665632","name":"MEDICOS","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"jsCode":"// Obtener todos los mÃ©dicos\nconst items = $input.all();\n\n// Crear un objeto para agrupar mÃ©dicos por especialidad\nconst medicosPorEspecialidad = {};\n\nitems.forEach(item => {\n  const medico = item.json.Medico;\n  const especialidad = item.json.Especialidad;\n  \n  if (!medicosPorEspecialidad[especialidad]) {\n    medicosPorEspecialidad[especialidad] = [];\n  }\n  \n  // Evitar duplicados\n  if (!medicosPorEspecialidad[especialidad].includes(medico)) {\n    medicosPorEspecialidad[especialidad].push(medico);\n  }\n});\n\n// Ordenar especialidades alfabÃ©ticamente\nconst especialidadesOrdenadas = Object.keys(medicosPorEspecialidad).sort();\n\n// Crear el listado formateado\nlet listadoMedicos = '';\nespecialidadesOrdenadas.forEach(especialidad => {\n  listadoMedicos += `\\nðŸ“Œ *${especialidad}*\\n`;\n  \n  // Ordenar mÃ©dicos alfabÃ©ticamente\n  const medicos = medicosPorEspecialidad[especialidad].sort();\n  \n  medicos.forEach(medico => {\n    listadoMedicos += `   â€¢ Dr./Dra. ${medico}\\n`;\n  });\n});\n\n// Crear el mensaje completo con las nuevas instrucciones\nconst mensaje = `ðŸ‘¨â€âš•ï¸ *NUESTROS PROFESIONALES*\\n\\nðŸ¥ *CONTAMOS CON LOS SIGUIENTES MÃ‰DICOS ESPECIALISTAS:*${listadoMedicos}\\n\\nðŸ“ž *CONTACTO:*\\n(0221) 4906310\\nLUNES A VIERNES: 8:00-20:00HS`;\n\n// Mensaje para botÃ³n interactivo\nconst mensajeBoton = `ðŸ“‹ IR AL MENÃš PRINCIPAL O DIRECTAMENTE SACAR TURNO`;\n\n// Retornar el resultado en JSON\nreturn [{\n  json: {\n    listadoMedicos: listadoMedicos.trim(),\n    mensaje: mensaje,\n    mensajeBoton: mensajeBoton,\n    medicosPorEspecialidad: medicosPorEspecialidad,\n    totalEspecialidades: especialidadesOrdenadas.length,\n    totalMedicos: items.length,\n    // Estructura completa para mensaje interactivo\n    interactive_body: mensajeBoton,\n    interactive_button_id: \"menu_principal\",\n    interactive_button_title: \"MENU PRINCIPAL\"\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[944,4496],"id":"4af4901c-9872-4a9c-8ecf-73649190b705","name":"Msg preparado"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').item.json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ðŸ«€ INSTITUTO DE CARDIOLOGÃA LA PLATA\"\n    },\n    \"body\": {\n      \"text\": \"ðŸ“‹ PARA SACAR UN TURNO, SELECCIONÃ:\\n\\nðŸ†• NUEVO PACIENTE\\nâ†’ Si es tu primera vez\\n\\nðŸ‘¤ PACIENTE REGISTRADO\\nâ†’ Si ya tenÃ©s historial con nosotros\\n\\nðŸ  MENÃš PRINCIPAL\\nâ†’ Ver horarios, ubicaciÃ³n y mÃ¡s info\"\n    },\n    \"footer\": {\n      \"text\": \"LUN-VIE 8-20HS\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"primera-vez\",\n            \"title\": \"NUEVO PACIENTE\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"ya-atendido\",\n            \"title\": \"PACIENTE REGISTRADO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"volver-atras\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-3072,240],"id":"ee7bef81-40fe-4fdf-b2ea-3df699b44ae1","name":"ðŸ“… Turnos - PACIENTE NUEVO - PACIENTE REGISTRADO - ","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"mhwp4qt6r2d7ymm","returnAll":true,"options":{}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[720,4496],"id":"217e4207-065d-42bb-b34a-f092715ae984","name":"get_medicos1","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"mi8p2u7tvuplzt5","returnAll":true,"options":{}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[720,4928],"id":"782e5da3-242d-45e2-ae8f-5cf8a0510c5f","name":"get_especialidades","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"jsCode":"// Obtener todas las especialidades\nconst items = $input.all();\n\n// Extraer las especialidades y eliminar duplicados\nconst especialidades = [...new Set(items.map(item => item.json.Especialidad))];\n\n// Ordenar alfabÃ©ticamente\nespecialidades.sort();\n\n// Crear el listado formateado para WhatsApp\nconst listadoEspecialidades = especialidades\n  .map((esp, index) => `${index + 1}. ${esp.toUpperCase()}`)\n  .join('\\n');\n\n// Crear el mensaje completo en mayÃºsculas\nconst mensaje = `ðŸ¥ *ESPECIALIDADES DISPONIBLES*\\n\\nðŸ“‹ *CONTAMOS CON LAS SIGUIENTES ESPECIALIDADES:*\\n\\n${listadoEspecialidades}\\n\\nðŸ‘‡ *PRESIONE SI QUIERE SACAR UN TURNO Y SIGA LAS INDICACIONES*\\n\\nðŸ“ž *CONTACTO:*\\n(0221) 4906310\\nLUNES A VIERNES: 8:00-20:00HS`;\n\n// Mensaje para botÃ³n interactivo\nconst mensajeBoton = `ðŸ“‹ SACAR UN TURNO O IR AL  MENU PRINCIPAL`;\n\n// Retornar tanto el array como el mensaje\nreturn [{\n  json: {\n    especialidades: especialidades,\n    total: especialidades.length,\n    listadoEspecialidades: listadoEspecialidades,\n    mensaje: mensaje,\n    mensajeBoton: mensajeBoton,\n    // Estructura completa para mensaje interactivo\n    interactive_body: mensajeBoton,\n    interactive_button_id: \"menu_principal\",\n    interactive_button_title: \"MENU PRINCIPAL\"\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[944,4928],"id":"e4ae68a4-dcaa-4b98-925c-4e7555e6dae8","name":"Msg preparado1"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"{{ $('Msg preparado1').item.json.mensajeBoton }}\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"sacar_turno\",\n            \"title\": \"SACAR TURNO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"menu_principal\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1424,4928],"id":"cda40d5a-4a49-49bf-ad39-8d97672e3853","name":"ENVIA-> MENU-SACAR TURNO","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"{{ $('Msg preparado').item.json.mensajeBoton }}\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"sacar_turno\",\n            \"title\": \"SACAR TURNO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"menu_principal\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1376,4496],"id":"0815b559-25b1-4bd1-9c5b-bb4f5dba6d8a","name":"ENVIA-> MENU-SACAR TURNO1","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"content":"## INFO GENERAL - ESPECIALIDADES","height":224,"width":992,"color":5},"type":"n8n-nodes-base.stickyNote","position":[624,4880],"typeVersion":1,"id":"9b2304cd-bfa7-4fc6-bd1f-593611f40c0f","name":"Sticky Note3"},{"parameters":{"workflowId":{"__rl":true,"value":"5yeTNub4mGFgBUpp","mode":"list","cachedResultName":"SUB - POST_PACIENTE"},"workflowInputs":{"mappingMode":"defineBelow","value":{"dni":"={{ $json.output.DNI.toString() }}","paciente":"={{ $json.output.NOMBRE }}","direccion":"={{ $json.output.DIRECCION }}","celular":"={{ $json.output.TELEFONO.toString() }}","obraSocial":"={{ $json.output.OBRA_SOCIAL }}"},"matchingColumns":[],"schema":[{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"paciente","displayName":"paciente","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"direccion","displayName":"direccion","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"celular","displayName":"celular","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"obraSocial","displayName":"obraSocial","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[1856,-672],"id":"58b0f7ce-bc3a-43d0-ada7-3c7a231b5b4f","name":"AGENTE PADRON"},{"parameters":{"operation":"delete","key":"5492254596618"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-5120,3040],"id":"5829b054-cf48-46a2-a799-06f6b8494642","name":"DELETE - DATOS=2","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"={{ $('Filter1').first().json.contactNumber }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2576,-752],"id":"9d45ae54-6a7c-4d47-8a4c-d75dccffbaa9","name":"ðŸ¤– RESET AGENTE","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ðŸ«€ ICLP - GESTIÃ“N DE TURNOS\"\n    },\n    \"body\": {\n      \"text\": \"*ðŸ“‹ GESTIÃ“N DE TURNOS*\\n\\n*Â¿QUÃ‰ DESEA HACER?*\\n\\n*ðŸ“… TOMAR TURNO*\\nâ†’ AGENDAR UNA NUEVA CONSULTA CON NUESTROS ESPECIALISTAS\\n\\n*âŒ CANCELAR TURNO*\\nâ†’ ANULAR UN TURNO YA PROGRAMADO\\n\\n*ðŸ“ MIS TURNO/S*\\nâ†’ VER SUS PRÃ“XIMAS CITAS AGENDADAS\\n\\nðŸ‘‡ *SELECCIONE UNA OPCIÃ“N PARA CONTINUAR*\"\n    },\n    \"footer\": {\n      \"text\": \"ðŸ“… LUN-VIE 8-20HS\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"tomar-turno\",\n            \"title\": \"TOMAR TURNO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"cancelar-turno\",\n            \"title\": \"CANCELAR TURNO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"mis-turnos\",\n            \"title\": \"MIS TURNO/S\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[752,368],"id":"2a7d799d-7ebf-4ba3-8664-8685bd535885","name":"TOMAR TURNO","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"delete","key":"=status:{{ $('Filter1').first().json.contactNumber }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-2832,224],"id":"b0da3014-204c-4e10-977a-6815904f2f1d","name":"Redis2","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Filter1').first().json.contactNumber }}","value":"MENU=1","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-2592,224],"id":"688131ef-99e5-4c0b-831e-93dad9c9732b","name":"â±ï¸ STATUS MENU2","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').first().json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"âŒ *LO SENTIMOS*\\n\\nEL DNI QUE NOS PROPORCIONÃ“ NO SE ENCUENTRA REGISTRADO EN NUESTRO SISTEMA.\\n\\nâœ… *Â¿QUÃ‰ PUEDE HACER?*\\n\\n*1ï¸âƒ£ VERIFIQUE EL DNI*\\nASEGÃšRESE DE HABERLO INGRESADO CORRECTAMENTE (SIN PUNTOS NI ESPACIOS)\\n\\n*2ï¸âƒ£ REGÃSTRESE COMO NUEVO PACIENTE*\\nSI ES SU PRIMERA VEZ, VUELVA AL MENÃš PRINCIPAL Y SELECCIONE LA OPCIÃ“N *NUEVO PACIENTE* PARA COMPLETAR SU REGISTRO\\n\\nðŸ“ž *Â¿NECESITA AYUDA?*\\nCOMUNÃQUESE CON ADMINISTRACIÃ“N:\\n(0221) 490-6310\\nLUN-VIE 8-20HS\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2368,64],"id":"d81c4fde-2a6c-4e81-87c9-6dd26744322e","name":"âœ… DATOS VALIDADOS","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').first().json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"âš ï¸ {{ $json.output.ERROR_MESSAGE }}\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-3328,5328],"id":"0bcf0242-5c0b-423f-a03f-2d661be5101f","name":"âš ï¸ DATOS INCORRECTOS2","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"4d4f5d9a-5ad9-495c-82f0-043f7f0ef5d6","leftValue":"={{ $json.output.esta_empadronado }}","rightValue":"verificacion_exitosa","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-2160,5200],"id":"d74f00bb-8aa6-45e3-ac94-ff7b97b8ac98","name":"Exito2"},{"parameters":{"workflowId":{"__rl":true,"value":"oB7pjyME2Gvo5moH","mode":"list","cachedResultName":"SUB - GET_PACIENTE"},"workflowInputs":{"mappingMode":"defineBelow","value":{"dni":"={{ $('Filter1').first().json.message }}","telefono":"={{ $('Filter1').first().json.contactNumber }}"},"matchingColumns":["dni"],"schema":[{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"telefono","displayName":"telefono","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-2368,5200],"id":"f727c7da-1d38-4ad1-b6a3-473945848ffd","name":"Get_Paciente1"},{"parameters":{"operation":"set","key":"=status:{{ $('Filter1').first().json.contactNumber }}","value":"=DNI:{{ $('Get_Paciente1').first().json.output.paciente_dni }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-1664,5040],"id":"28d3f8b1-db09-44a6-8ee3-b4e294aee743","name":"DNI1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ðŸ«€ ICLP - GESTIÃ“N DE TURNOS\"\n    },\n    \"body\": {\n      \"text\": \"*HOLA {{ $json.output.paciente_nombre }} âœ…*\\n\\n*ðŸ“‹ SUS DATOS EN NUESTRO SISTEMA:*\\n\\nðŸ‘¤ *NOMBRE:* *{{ $json.output.paciente_nombre }}*\\n\\nðŸ†” *DNI:* *{{ $json.output.paciente_dni }}*\\n\\nðŸ“ž *TELÃ‰FONO:* *{{ $json.output.paciente_celular }}*\\n\\nâœ… *SI LOS DATOS SON CORRECTOS, PRESIONE CONTINUAR*\\n\\nâš ï¸ *Â¿HAY ALGÃšN ERROR?*\\nCOMUNÃQUESE CON ADMINISTRACIÃ“N:\\nðŸ“ž (0221) 490-6310\"\n    },\n    \"footer\": {\n      \"text\": \"ðŸ“… LUN-VIE 8-20HS\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"CONTINUAR\",\n            \"title\": \"CONTINUAR\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"MENU-PRINCIPAL\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1888,5040],"id":"69e87809-a244-480b-8e8f-bdd4b45cf40d","name":"âœ… DATOS VALIDADOS4","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').first().json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"âŒ *LO SENTIMOS*\\n\\nEL DNI QUE NOS PROPORCIONÃ“ NO SE ENCUENTRA REGISTRADO EN NUESTRO SISTEMA.\\n\\nâœ… *Â¿QUÃ‰ PUEDE HACER?*\\n\\n*1ï¸âƒ£ VERIFIQUE EL DNI*\\nASEGÃšRESE DE HABERLO INGRESADO CORRECTAMENTE (SIN PUNTOS NI ESPACIOS)\\n\\n*2ï¸âƒ£ REGÃSTRESE COMO NUEVO PACIENTE*\\nSI ES SU PRIMERA VEZ, VUELVA AL MENÃš PRINCIPAL Y SELECCIONE LA OPCIÃ“N *NUEVO PACIENTE* PARA COMPLETAR SU REGISTRO\\n\\nðŸ“ž *Â¿NECESITA AYUDA?*\\nCOMUNÃQUESE CON ADMINISTRACIÃ“N:\\n(0221) 490-6310\\nLUN-VIE 8-20HS\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1872,5280],"id":"e2058571-9ef9-4deb-b872-141db842f7b0","name":"âœ… DATOS VALIDADOS1","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[1600,-368],"id":"620f82f9-0498-4c02-b0d4-32be034fb0ea","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"mE1IL02M9AnIg3tD","name":"OpenAi Credenciales ICLP"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').first().json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"ðŸ«€ *Â¡PERFECTO!*\\n\\nAL PARECER YA ESTÃN SUS DATOS EN NUESTRO SISTEMA.\\n\\nðŸ’“ *SUS DATOS REGISTRADOS:*\\n\\nðŸ‘¤ *NOMBRE:* {{ $json.output.paciente_nombre }}\\nðŸ†” *DNI:* {{ $json.output.paciente_dni }}\\nðŸ“ž *TELÃ‰FONO:* {{ $json.output.paciente_celular }}\\nðŸ©º *OBRA SOCIAL:* {{ $json.output.obraSocial || 'PARTICULAR' }}\\n\\nâœ… *Â¿LOS DATOS SON CORRECTOS?*\\nPUEDE CONTINUAR CON LA GESTIÃ“N DE SU TURNO CARDIOLÃ“GICO\\n\\nâš ï¸ *Â¿HAY ALGÃšN ERROR?*\\nCOMUNÃQUESE CON ADMINISTRACIÃ“N PARA ACTUALIZAR SUS DATOS:\\nðŸ“ž (0221) 490-6310\\nðŸ«€ ICLP - LUN-VIE 8-20HS\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2336,-560],"id":"097c9073-b1f1-4f4d-a53b-cf96bfb5ba30","name":"âœ… DATOS VALIDADOS5","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c8df2d50-2e61-4b46-b8a5-bbdefbb98378","leftValue":"={{ $json.codigo === 'VOLVER' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1152,3360],"id":"d99a2be5-2404-4646-8759-37d2efcf8f5f","name":"If"},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"mhwp4qt6r2d7ymm","limit":9,"options":{"fields":[],"where":"=(Codigo,eq,{{ $json?.codigo }})&limit=9&offset=0&sort=Medico"}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[1424,3472],"id":"d1c67cc5-6f89-46b1-8567-cb84274981da","name":"get_medicos2","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.recipient_type }}"},{"name":"to","value":"={{ $json.to }}"},{"name":"type","value":"={{ $json.type }}"},{"name":"interactive","value":"={{ $json.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1872,3472],"id":"2da57cb2-cbc5-4ddc-ba28-9910b6a07e70","name":"Medicos1","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Filter1').first().json.contactNumber }}","value":"MEDICOS=1","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2096,3472],"id":"2cb047dd-eef8-4c83-a3a8-a4cd630a5aa8","name":"ðŸ©º MEDICOS2","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"// Obtener todos los mÃ©dicos del input\nconst items = $input.all();\n\n// Crear el array de rows dinÃ¡micamente\nconst rows = items.map(item => {\n  const medico = item.json.Medico;\n  const matricula = item.json.Matricula;\n  \n  // Convertir a mayÃºsculas\n  let nombreMedico = medico.toUpperCase();\n  \n  // Si tiene parÃ©ntesis, tomar solo lo que estÃ¡ antes\n  if (nombreMedico.includes('(')) {\n    nombreMedico = nombreMedico.split('(')[0].trim();\n  }\n  \n  // Si tiene barra, tomar solo la primera parte\n  if (nombreMedico.includes('/')) {\n    nombreMedico = nombreMedico.split('/')[0].trim();\n  }\n  \n  // Si tiene mÃºltiples palabras, tomar solo la primera palabra\n  if (nombreMedico.includes(' ')) {\n    nombreMedico = nombreMedico.split(' ')[0];\n  }\n  \n  // Crear el title con formato: NOMBRE-MATRICULA\n  let title = `${nombreMedico}-${matricula}`;\n  \n  // Si aÃºn es muy largo, cortar a 24 caracteres\n  if (title.length > 24) {\n    title = title.substring(0, 21) + '...';\n  }\n  \n  // Crear descripciÃ³n completa\n  let description = medico;\n  \n  // WhatsApp permite MÃXIMO 72 caracteres en ROW_DESCRIPTION\n  if (description.length > 72) {\n    description = description.substring(0, 69) + '...';\n  }\n  \n  return {\n    id: matricula,\n    title: title,\n    description: description\n  };\n});\n\n// Solo agregar \"VER MÃS\" si hay 9 o mÃ¡s mÃ©dicos\nif (items.length >= 9) {\n  rows.push({\n    id: \"ver-mas\",\n    title: \"ðŸ“‹ VER MÃS\",\n    description: \"Ver mÃ¡s mÃ©dicos disponibles\"\n  });\n}\n\n// Retornar el JSON completo con la estructura de WhatsApp\nreturn [{\n  json: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: $('Filter1').first().json.contactNumber,\n    type: \"interactive\",\n    interactive: {\n      type: \"list\",\n      header: {\n        type: \"text\",\n        text: \"ðŸ‘¨â€âš•ï¸ MÃ©dicos\"\n      },\n      body: {\n        text: \"SeleccionÃ¡ el mÃ©dico con quien querÃ©s tu turno\"\n      },\n      footer: {\n        text: \"ðŸ“… Lun-Vie 8-20hs\"\n      },\n      action: {\n        button: \"VER MÃ‰DICOS\",\n        sections: [\n          {\n            title: \"ELEGIR MÃ‰DICO\",\n            rows: rows\n          }\n        ]\n      }\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1648,3472],"id":"a4613da5-d5ad-4f79-b7e4-ed5944f707db","name":"ðŸ©º LISTA-MEDICOS 1"},{"parameters":{"operation":"set","key":"=status:{{ $('Filter1').first().json.contactNumber }}","value":"=DNI:{{ $('Get_Paciente').first().json.output.paciente_dni }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2816,-752],"id":"e8a00709-5ed1-40bd-93da-d8befa9e326f","name":"DNI2","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Filter1').first().json.contactNumber }}","value":"=DNI:{{ $('Get_Paciente').first().json.output.paciente_dni }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2576,-560],"id":"1b0447c1-15fa-4e83-9ca6-1e1fd8f0a16c","name":"DNI3","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Filter1').first().json.contactNumber }}","value":"=DNI:{{ $('Get_Paciente').first().json.output.paciente_dni }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2640,64],"id":"05e8e501-69cb-44cd-bed4-afd09c89dd3a","name":"DNI4","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.multimedia }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true},"id":"e7a9ef75-11df-4262-8ec0-c63644980c5e"}],"combinator":"and"},"renameOutput":true,"outputKey":"tieneMultimedia"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"839f4006-0caa-456b-b044-28ae16cd1ab4","leftValue":"={{ $json.humano }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"tieneHumano"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"579505b2-6063-4333-9c73-476c450aee99","leftValue":"={{ $json.message }}","rightValue":"Texto","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"tieneTexto"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-6400,1616],"id":"b43e1f26-a7db-447f-b8e0-809d6d7f2ace","name":"Switch"},{"parameters":{"operation":"set","key":"=DNI:{{ $('Filter1').first().json.contactNumber }}","value":"={{ $('MENU PRINCIPAL').item.json.status }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[960,368],"id":"7d7587eb-2618-4e77-9e2b-0129802b4f7c","name":"Redis3","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}}],"connections":{"Filtrar nÃºmeros de prueba":{"main":[[{"node":"variables","type":"main","index":0}]]},"variables":{"main":[[{"node":"Switch","type":"main","index":0}]]},"Filter1":{"main":[[{"node":"â±ï¸ YA SE ACTIVO MENU?","type":"main","index":0}]]},"Entrada":{"main":[[{"node":"Execution Data1","type":"main","index":0},{"node":"Filtrar nÃºmeros de prueba","type":"main","index":0}]]},"Primera vez INS.":{"main":[[{"node":"â±ï¸ STATUS PRIMERA VEZ","type":"main","index":0}]]},"When clicking â€˜Execute workflowâ€™":{"main":[[{"node":"DELETE - STATUS MENU","type":"main","index":0},{"node":"DELETE - STATUS MENU1","type":"main","index":0}]]},"ðŸ¢ AdministraciÃ³n":{"main":[[{"node":"â±ï¸ STATUS MENU","type":"main","index":0}]]},"â±ï¸ YA SE ACTIVO MENU?":{"main":[[{"node":"MENU PRINCIPAL","type":"main","index":0}]]},"Menu Principal = MENU=1":{"main":[[{"node":"â±ï¸ STATUS MENU1","type":"main","index":0}]]},"DELETE - STATUS MENU":{"main":[[{"node":"DELETE - CONTADOR","type":"main","index":0}]]},"DELETE - CONTADOR":{"main":[[{"node":"DELETE - DATOS=2","type":"main","index":0}]]},"Error informacion de usuario":{"main":[[{"node":"âš ï¸ DATOS INCORRECTOS","type":"main","index":0}],[{"node":"AGENTE PADRON","type":"main","index":0}]]},"âš ï¸ DATOS INCORRECTOS":{"main":[[{"node":"DATOS RECOLECTADOS","type":"main","index":0}]]},"Exito":{"main":[[{"node":"âœ… DATOS VALIDADOS3","type":"main","index":0}],[{"node":"âœ… DATOS VALIDADOS5","type":"main","index":0}]]},"ðŸ©» ESPECIALIDADES":{"main":[[{"node":"ESPECIALIDADES","type":"main","index":0}]]},"LISTA":{"main":[[{"node":"ðŸ©» ESPECIALIDADES","type":"main","index":0}]]},"Get_Especialidades":{"main":[[{"node":"LISTA","type":"main","index":0}]]},"Code1":{"main":[[{"node":"If","type":"main","index":0}]]},"get_medicos":{"main":[[{"node":"ðŸ©º LISTA-MEDICOS ","type":"main","index":0}]]},"get_datos_usuario":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"ðŸ“… Horarios Proximos","type":"main","index":0}]]},"Medicos":{"main":[[{"node":"ðŸ©º MEDICOS","type":"main","index":0}]]},"MENU PRINCIPAL":{"main":[[{"node":"ðŸ“… Turnos - PACIENTE NUEVO - PACIENTE REGISTRADO - ","type":"main","index":0}],[{"node":"â„¹ï¸ Info General","type":"main","index":0}],[{"node":"ðŸ¢ AdministraciÃ³n","type":"main","index":0}],[{"node":"Menu Principal = MENU=1","type":"main","index":0}],[{"node":"ETIQUETA CONSULTA-RECLAMO","type":"main","index":0}],[{"node":"Menu Principal = MENU=1","type":"main","index":0}],[{"node":"ðŸ“… Turnos - PACIENTE NUEVO - PACIENTE REGISTRADO - ","type":"main","index":0}],[{"node":"Menu Principal = MENU=1","type":"main","index":0}],[],[{"node":"Get_Especialidades","type":"main","index":0}],[{"node":"Primera vez INS.","type":"main","index":0}],[{"node":"obrasociales","type":"main","index":0}],[{"node":"get_codigo_especialidad","type":"main","index":0}],[{"node":"get_datos_usuario","type":"main","index":0}],[{"node":"get_datos_usuario1","type":"main","index":0}],[{"node":"Datos para confirmar turno1","type":"main","index":0}],[{"node":"SOLICITAR DNI PACIENTE","type":"main","index":0}],[{"node":"obra_social","type":"main","index":0}],[{"node":"get_turnos_agendados","type":"main","index":0}],[{"node":"Get_Paciente","type":"main","index":0}],[{"node":"get_turnos_agendados1","type":"main","index":0}],[{"node":"Menu Principal = MENU=1","type":"main","index":0}],[{"node":"BUSCAR ESPECIALIDAD","type":"main","index":0}],[{"node":"Get_Especialidades","type":"main","index":0}],[{"node":"Get_Especialidades1","type":"main","index":0}],[{"node":"Get_Especialidades","type":"main","index":0}],[{"node":"Get_Paciente","type":"main","index":0}],[{"node":"TURNOS ESTUDIO","type":"main","index":0}],[],[{"node":"get_datos_usuario","type":"main","index":0}],[{"node":"Redis1","type":"main","index":0}],[{"node":"Menu Principal = MENU=1","type":"main","index":0}],[],[{"node":"UBICACION","type":"main","index":0}],[{"node":"PORTAL GENERAL","type":"main","index":0}],[{"node":"EMAIL RECETAS","type":"main","index":0}],[{"node":"get_medicos1","type":"main","index":0}],[{"node":"get_especialidades","type":"main","index":0}],[{"node":"TOMAR TURNO","type":"main","index":0}],[{"node":"Menu Principal = MENU=1","type":"main","index":0}],[{"node":"BUSCAR ESPECIALIDAD","type":"main","index":0}],[{"node":"ðŸ“… Turnos - PACIENTE NUEVO - PACIENTE REGISTRADO - ","type":"main","index":0}],[{"node":"ðŸ“… Turnos - PACIENTE NUEVO - PACIENTE REGISTRADO - ","type":"main","index":0}],[{"node":"Menu Principal = MENU=1","type":"main","index":0}],[{"node":"Get_Paciente1","type":"main","index":0}],[],[{"node":"Redis1","type":"main","index":0}],[{"node":"BUSCAR ESPECIALIDAD","type":"main","index":0}]]},"ðŸ“… Horarios Proximos":{"main":[[{"node":"ðŸ• LISTA-HORARIOS","type":"main","index":0}]]},"ðŸ• Fechas disponibles ":{"main":[[{"node":"ðŸ©º MEDICOS1","type":"main","index":0}]]},"ðŸ• LISTA-HORARIOS":{"main":[[{"node":"ðŸ• Fechas disponibles ","type":"main","index":0}]]},"ðŸ©º LISTA-MEDICOS ":{"main":[[{"node":"Medicos","type":"main","index":0}]]},"ðŸ©º MEDICOS1":{"main":[[{"node":"Matricula medico","type":"main","index":0}]]},"get_datos_usuario1":{"main":[[{"node":"MATRICULA","type":"main","index":0}]]},"OpenRouter Chat Model2":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"Code2":{"main":[[{"node":"Datos para confirmar turno","type":"main","index":0}]]},"Matricula medico":{"main":[[{"node":"ESPECIALIDAD-USADO PARA VOLVER ATRAS","type":"main","index":0}]]},"MATRICULA":{"main":[[{"node":"Code2","type":"main","index":0}]]},"ðŸ“… Confirmar turno":{"main":[[{"node":"Redis","type":"main","index":0}]]},"Datos para confirmar turno":{"main":[[{"node":"ðŸ“… Confirmar turno","type":"main","index":0}]]},"Datos para confirmar turno1":{"main":[[{"node":"EJECUTAR TURNO","type":"main","index":0}]]},"EJECUTAR TURNO":{"main":[[{"node":"ðŸ“… Confirmar turno1","type":"main","index":0}]]},"ðŸ“… Confirmar turno1":{"main":[[{"node":"DELETE - STATUS MENU3","type":"main","index":0}]]},"DELETE - STATUS MENU1":{"main":[[{"node":"DELETE - CONTADOR1","type":"main","index":0}]]},"DELETE - CONTADOR1":{"main":[[{"node":"DELETE - DATOS=","type":"main","index":0}]]},"AI Agent":{"main":[[{"node":"Error informacion de usuario","type":"main","index":0}]]},"SOLICITAR DNI PACIENTE":{"main":[[]]},"Error informacion de usuario1":{"main":[[{"node":"âš ï¸ DATOS INCORRECTOS1","type":"main","index":0}],[{"node":"Get_Paciente","type":"main","index":0}]]},"Exito1":{"main":[[{"node":"âœ… DATOS VALIDADOS2","type":"main","index":0}],[{"node":"âœ… DATOS VALIDADOS","type":"main","index":0}]]},"OpenRouter Chat Model":{"ai_languageModel":[[{"node":"AI Agent1","type":"ai_languageModel","index":0}]]},"Structured Output Parser":{"ai_outputParser":[[{"node":"AI Agent1","type":"ai_outputParser","index":0}]]},"AI Agent1":{"main":[[{"node":"Error informacion de usuario1","type":"main","index":0}]]},"Get_Paciente":{"main":[[{"node":"Exito1","type":"main","index":0}]]},"get_turnos_agendados":{"main":[[{"node":"datos","type":"main","index":0}]]},"datos":{"main":[[{"node":"ðŸ“‹ LISTAR TURNOS","type":"main","index":0}]]},"get_turnos_agendados1":{"main":[[{"node":"datos1","type":"main","index":0}]]},"datos1":{"main":[[{"node":"ðŸš« CANCELAR TURNO","type":"main","index":0}]]},"MIS TURNOS1":{"main":[[{"node":"Datos turnos","type":"main","index":0}]]},"ðŸš« CANCELAR TURNO":{"main":[[{"node":"MIS TURNOS1","type":"main","index":0}]]},"ðŸ“‹ LISTAR TURNOS":{"main":[[{"node":"MIS TURNOS","type":"main","index":0}]]},"ðŸ©» ESPECIALIDADES1":{"main":[[{"node":"ESPECIALIDADES1","type":"main","index":0}]]},"LISTA1":{"main":[[{"node":"ðŸ©» ESPECIALIDADES1","type":"main","index":0}]]},"Get_Especialidades1":{"main":[[{"node":"LISTA1","type":"main","index":0}]]},"ETIQUETA CONSULTA-RECLAMO":{"main":[[]]},"get_codigo_especialidad":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Redis1":{"main":[[{"node":"Execute Workflow1","type":"main","index":0}]]},"Execute Workflow1":{"main":[[{"node":"Code3","type":"main","index":0}]]},"ðŸš« TURNO-CANCELADO":{"main":[[{"node":"DELETE - STATUS MENU2","type":"main","index":0}]]},"Code3":{"main":[[{"node":"ðŸš« TURNO-CANCELADO","type":"main","index":0}]]},"âœ… DATOS VALIDADOS2":{"main":[[{"node":"DNI","type":"main","index":0}]]},"obra_social":{"main":[[{"node":"Code7","type":"main","index":0}]]},"obrasociales":{"main":[[{"node":"Code6","type":"main","index":0}]]},"Code6":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"Code7":{"main":[[{"node":"AI Agent1","type":"main","index":0}]]},"Structured Output Parser1":{"ai_outputParser":[[{"node":"AI Agent","type":"ai_outputParser","index":0}]]},"Redis Chat Memory":{"ai_memory":[[{"node":"AI Agent","type":"ai_memory","index":0},{"node":"AI Agent1","type":"ai_memory","index":0}]]},"MEDICOS":{"main":[[{"node":"ENVIA-> MENU-SACAR TURNO1","type":"main","index":0}]]},"Msg preparado":{"main":[[{"node":"MEDICOS","type":"main","index":0}]]},"ESPECIALIDADES2":{"main":[[{"node":"ENVIA-> MENU-SACAR TURNO","type":"main","index":0}]]},"get_medicos1":{"main":[[{"node":"Msg preparado","type":"main","index":0}]]},"get_especialidades":{"main":[[{"node":"Msg preparado1","type":"main","index":0}]]},"Msg preparado1":{"main":[[{"node":"ESPECIALIDADES2","type":"main","index":0}]]},"AGENTE PADRON":{"main":[[{"node":"Exito","type":"main","index":0}]]},"âœ… DATOS VALIDADOS3":{"main":[[{"node":"ðŸ¤– RESET AGENTE","type":"main","index":0}]]},"ðŸ“… Turnos - PACIENTE NUEVO - PACIENTE REGISTRADO - ":{"main":[[{"node":"Redis2","type":"main","index":0}]]},"Redis2":{"main":[[{"node":"â±ï¸ STATUS MENU2","type":"main","index":0}]]},"Exito2":{"main":[[{"node":"âœ… DATOS VALIDADOS4","type":"main","index":0}],[{"node":"âœ… DATOS VALIDADOS1","type":"main","index":0}]]},"Get_Paciente1":{"main":[[{"node":"Exito2","type":"main","index":0}]]},"âœ… DATOS VALIDADOS4":{"main":[[{"node":"DNI1","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"Structured Output Parser1","type":"ai_languageModel","index":0}]]},"If":{"main":[[{"node":"get_medicos","type":"main","index":0}],[{"node":"get_medicos2","type":"main","index":0}]]},"get_medicos2":{"main":[[{"node":"ðŸ©º LISTA-MEDICOS 1","type":"main","index":0}]]},"Medicos1":{"main":[[{"node":"ðŸ©º MEDICOS2","type":"main","index":0}]]},"ðŸ©º LISTA-MEDICOS 1":{"main":[[{"node":"Medicos1","type":"main","index":0}]]},"ðŸ©º MEDICOS2":{"main":[[]]},"ðŸ¤– RESET AGENTE":{"main":[[{"node":"DNI2","type":"main","index":0}]]},"âœ… DATOS VALIDADOS5":{"main":[[{"node":"DNI3","type":"main","index":0}]]},"âœ… DATOS VALIDADOS":{"main":[[{"node":"DNI4","type":"main","index":0}]]},"Switch":{"main":[[],[],[{"node":"Filter1","type":"main","index":0}]]},"TOMAR TURNO":{"main":[[{"node":"Redis3","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","timezone":"America/Argentina/Buenos_Aires","callerPolicy":"workflowsFromSameOwner"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Entrada":[{"json":{"headers":{"host":"hooks.autoclinicas.com","user-agent":"rest-client/2.1.0 (linux-musl x86_64) ruby/3.4.4p34","content-length":"2117","accept":"application/json","accept-encoding":"gzip;q=1.0,deflate;q=0.6,identity;q=0.3","content-type":"application/json","x-forwarded-for":"206.81.1.93","x-forwarded-host":"hooks.autoclinicas.com","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"f2c799d0c305","x-real-ip":"206.81.1.93"},"params":{},"query":{},"body":{"additional_attributes":{},"can_reply":true,"channel":"Channel::Whatsapp","contact_inbox":{"id":11730,"contact_id":6099,"inbox_id":13,"source_id":"5492254596618","created_at":"2025-10-06T23:09:25.001Z","updated_at":"2025-10-06T23:09:25.001Z","hmac_verified":false,"pubsub_token":"72kqoh9Mvmbyd7NJRvsQTtnR"},"id":8308,"inbox_id":13,"messages":[{"id":106524,"content":"CUELI-19721","account_id":2,"inbox_id":13,"conversation_id":8308,"message_type":0,"created_at":1760820260,"updated_at":"2025-10-18T20:44:20.432Z","private":false,"status":"sent","source_id":"wamid.HBgNNTQ5MjI1NDU5NjYxOBUCABIYIEE1NDdFRTdGRUNFREUzMTlCNjc2RDAzMDI4NjYwMUMyAA==","content_type":"text","content_attributes":{"in_reply_to_external_id":null,"in_reply_to":null},"sender_type":"Contact","sender_id":6099,"external_source_ids":{},"additional_attributes":{},"processed_message_content":"CUELI-19721","sentiment":{},"conversation":{"assignee_id":null,"unread_count":10,"last_activity_at":1760820260,"contact_inbox":{"source_id":"5492254596618"}},"sender":{"additional_attributes":{"city":"","country":"","description":"","company_name":"","country_code":"","social_profiles":{}},"custom_attributes":{},"email":null,"id":6099,"identifier":null,"name":"Fer ðŸ¤–","phone_number":"+5492254596618","thumbnail":"","blocked":false,"type":"contact"}}],"labels":[],"meta":{"sender":{"additional_attributes":{"city":"","country":"","description":"","company_name":"","country_code":"","social_profiles":{}},"custom_attributes":{},"email":null,"id":6099,"identifier":null,"name":"Fer ðŸ¤–","phone_number":"+5492254596618","thumbnail":"","blocked":false,"type":"contact"},"assignee":null,"team":{"id":1,"name":"recepcionistas"},"hmac_verified":false},"status":"open","custom_attributes":{},"snoozed_until":null,"unread_count":10,"first_reply_created_at":null,"priority":null,"waiting_since":1760819117,"agent_last_seen_at":0,"contact_last_seen_at":0,"last_activity_at":1760820260,"timestamp":1760820260,"created_at":1760819117,"updated_at":1760820260.435732,"applied_sla":null,"sla_events":[],"sla_policy_id":null,"event":"automation_event.message_created"},"webhookUrl":"https://hooks.autoclinicas.com/webhook/agentes/v1/iclp","executionMode":"production"}}]},"versionId":"4b5c5575-1db9-4387-aace-c3dff00c231f","triggerCount":1,"shared":[{"createdAt":"2025-10-18T21:11:42.749Z","updatedAt":"2025-10-18T21:11:42.749Z","role":"workflow:owner","workflowId":"6mhPJfmzP0N7PjKy","projectId":"R66ikVn5xqf0nYcA"}],"tags":[{"createdAt":"2025-10-18T05:48:24.047Z","updatedAt":"2025-10-18T05:48:24.047Z","id":"9MPkCQDvT4HFCUIK","name":"ClinicAI-v1.33"}]}