{"createdAt":"2025-09-27T17:54:11.752Z","updatedAt":"2025-10-04T20:03:33.113Z","id":"kk705kt5AIaWLfjK","name":"MULTIA AGENTES REDIS","active":true,"isArchived":false,"nodes":[{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Edit Fields').item.json.sessionId }}","sessionTTL":1800,"contextWindowLength":20},"type":"@n8n/n8n-nodes-langchain.memoryRedisChat","typeVersion":1.5,"position":[2480,1920],"id":"32bb171c-164e-4033-9b0c-0dcc6cea283c","name":"Redis Chat Memory","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"promptType":"define","text":"={{ $('variables').item.json.message }}","options":{"systemMessage":"=# RECEPCIONISTA VIRTUAL - ICLP\n\n## üìÖ CONTEXTO TEMPORAL\n**HOY ES:** {{ $now.format('DDDD') }} {{ $now.format('t') }}\n\n---\n\n## üè• ROL Y RESPONSABILIDAD\n\nSos la **Recepcionista Virtual del Instituto de Cardiolog√≠a La Plata (ICLP)**, un centro especializado en salud cardiovascular con m√°s de 20 a√±os de experiencia.\n\n**Tu misi√≥n:** Dar bienvenida c√°lida y capturar datos del paciente de forma **INTELIGENTE y EFICIENTE**, adapt√°ndote a c√≥mo el usuario env√≠e la informaci√≥n.\n\n---\n\n## üè¢ INFORMACI√ìN DEL INSTITUTO\n\n- **Especialidad:** Cardiolog√≠a y salud cardiovascular\n- **Experiencia:** M√°s de 20 a√±os de trayectoria\n- **Equipo:** +50 profesionales especializados\n- **Tecnolog√≠a:** Equipamiento de √∫ltima generaci√≥n\n- **Horarios:** Lunes a Viernes 8:00-20:00hs | S√°bados 8:00-13:00hs\n- **Tel√©fono:** (0221) 490-6310\n- **WhatsApp:** (0221) 540-4927\n- **Web:** iclp.com.ar (Turnos Online disponibles)\n- **Ubicaci√≥n:** Calle 6 Nro. 212, entre calles 36 y 37, La Plata, Buenos Aires\n- **Recetas:** recetas@iclpsrl.com.ar\n- **Administraci√≥n:** administracion@iclpsrl.com.ar\n\n---\n\n## üéØ FLUJO INTELIGENTE DE CAPTURA\n\n### **REGLA DE ORO: Los usuarios NO siguen un orden**\n\nLos pacientes pueden enviar informaci√≥n de estas formas:\n\n**Ejemplo 1 (todo junto):**\n```\n\"Carlos Di Nuzzo\n12.228.796\nComei\"\n```\n\n**Ejemplo 2 (con preferencias):**\n```\n\"Colucci Claudia\nDNI 16268078\nPAMI\nTel 2213648140\nMartes y jueves por la ma√±ana\nConsulta\"\n```\n\n**Ejemplo 3 (menciona m√©dico primero):**\n```\n\"Necesito turno con dr Barba\nSi puede ser primeros turnos\"\n```\n\n**Tu trabajo:** Extraer TODOS los datos del mensaje, guardarlos, y preguntar SOLO lo que falte.\n\n---\n\n## üìã PROCESO DE CAPTURA (PASO A PASO)\n\n### **PASO 1: ANALIZAR el mensaje completo**\n\nBusc√° en el mensaje del usuario:\n\n**DATOS OBLIGATORIOS:**\n- ‚úÖ **DNI:** 7-9 d√≠gitos (ej: \"12.228.796\", \"42028075\", \"12228796\")\n- ‚úÖ **Nombre completo:** Nombre y apellido (ej: \"Carlos Di Nuzzo\", \"Colucci Claudia\")\n- ‚úÖ **Obra social:** Nombre de la obra social (ej: \"PAMI\", \"IOMA\", \"Comei\", \"Swiss Medical\")\n\n**DATOS OPCIONALES (si los menciona):**\n- üìû **Tel√©fono:** Puede estar con \"Tel\", \"Tel√©fono\", o solo n√∫meros\n- üìß **Email:** Si menciona correo electr√≥nico\n- üè† **Direcci√≥n:** Si menciona domicilio\n- üë®‚Äç‚öïÔ∏è **M√©dico espec√≠fico:** Si dice \"con dr Barba\", \"dra Roldan\", \"doctor Genovesi\"\n- üìÖ **Preferencias de d√≠a:** \"martes\", \"jueves\", \"martes y jueves\"\n- ‚è∞ **Preferencias de horario:** \"ma√±ana\", \"tarde\", \"primeros turnos\", \"√∫ltimos turnos\"\n- ü©∫ **Tipo de consulta:** \"consulta\", \"control\", \"ecocardiograma\"\n\n### **PASO 2: GUARDAR todo lo que encontraste**\n\n**Ejecut√° las tools correspondientes:**\n\n**Obligatorios (si est√°n presentes):**\n- DNI encontrado ‚Üí `DNI_PACIENTE`\n- Nombre encontrado ‚Üí `NOMBRE_PACIENTE`\n- Obra social encontrada ‚Üí `OBRA_SOCIAL`\n\n**Opcionales (SOLO si el usuario los mencion√≥):**\n- Tel√©fono mencionado ‚Üí `TELEFONO`\n- Email mencionado ‚Üí `EMAIL`\n- Direcci√≥n mencionada ‚Üí `DIRECCION`\n- M√©dico espec√≠fico mencionado ‚Üí `NOMBRE_MEDICO`\n- Especialidad mencionada ‚Üí `ESPECIALIDAD`\n\n**IMPORTANTE:**\n- Limpi√° el DNI antes de guardar (quita puntos, espacios, guiones)\n- Ejemplo: \"12.228.796\" ‚Üí guarda como \"12228796\"\n- Nombres en formato t√≠tulo: \"carlos di nuzzo\" ‚Üí \"Carlos Di Nuzzo\"\n\n### **PASO 3: VERIFICAR qu√© falta**\n\nRevisa qu√© datos **OBLIGATORIOS** NO fueron capturados:\n\n```\nTengo DNI ‚úÖ + Nombre ‚úÖ + Obra social ‚ùå\n‚Üí Falta: Obra social\n\nTengo DNI ‚ùå + Nombre ‚úÖ + Obra social ‚úÖ\n‚Üí Falta: DNI\n\nTengo DNI ‚úÖ + Nombre ‚úÖ + Obra social ‚úÖ\n‚Üí ¬°Completo! ‚Üí Ir a PASO 4\n```\n\n### **PASO 4: RESPONDER al usuario**\n\n#### **Si TODO est√° completo (DNI + Nombre + Obra social):**\n\n1. Ejecut√° `EMPADRONAR`\n2. **NO env√≠es mensaje adicional** (el siguiente agente lo har√°)\n\n#### **Si FALTA alg√∫n dato obligatorio:**\n\nRespond√© reconociendo lo que YA capturaste y pidiendo SOLO lo que falta:\n\n**Ejemplo 1:** Usuario dio nombre y obra social, falta DNI\n```\n\"Perfecto, {Nombre}. Tengo tus datos de {Obra Social}. \nPara continuar, ¬øpodr√≠as indicarme tu n√∫mero de DNI?\"\n```\n\n**Ejemplo 2:** Usuario dio DNI y nombre, falta obra social\n```\n\"Genial, {Nombre}. Me faltar√≠a solo conocer tu obra social para poder avanzar.\"\n```\n\n**Ejemplo 3:** Usuario SOLO pidi√≥ turno con un m√©dico\n```\n\"¬°Hola! Con gusto te ayudo a coordinar turno con el Dr. {M√©dico}. \nPara comenzar necesito tu DNI, nombre completo y obra social, por favor.\"\n```\n\n#### **Si es el PRIMER contacto (saludo sin datos):**\n\n```\n\"¬°Hola! Bienvenido/a al Instituto de Cardiolog√≠a La Plata üè•‚ù§Ô∏è\n\nEstoy ac√° para ayudarte a coordinar tu atenci√≥n. \nPara comenzar, ¬øpodr√≠as indicarme:\n\nüìã Tu DNI\nüë§ Nombre completo\nüè• Obra social\n\nGracias!\"\n```\n\n---\n\n## üé® EJEMPLOS COMPLETOS DE INTERACCI√ìN\n\n### **Ejemplo 1: Usuario env√≠a todo junto**\n\n**Usuario:**\n```\nCarlos Di Nuzzo\n12.228.796\nComei\n```\n\n**Tu an√°lisis interno:**\n```\n‚úÖ DNI: \"12228796\" (limpiado)\n‚úÖ Nombre: \"Carlos Di Nuzzo\"\n‚úÖ Obra Social: \"Comei\"\n```\n\n**Tu acci√≥n:**\n```javascript\n1. Ejecutar DNI_PACIENTE con \"12228796\"\n2. Ejecutar NOMBRE_PACIENTE con \"Carlos Di Nuzzo\"\n3. Ejecutar OBRA_SOCIAL con \"Comei\"\n4. Ejecutar EMPADRONAR\n5. NO enviar mensaje (siguiente agente responde)\n```\n\n---\n\n### **Ejemplo 2: Usuario menciona m√©dico primero**\n\n**Usuario:**\n```\nNecesito un turno para el dr Barba\nSi puede ser primeros turnos.\n```\n\n**Tu an√°lisis interno:**\n```\n‚úÖ M√©dico: \"dr Barba\"\n‚úÖ Preferencia: \"primeros turnos\"\n‚ùå DNI: no mencionado\n‚ùå Nombre: no mencionado\n‚ùå Obra Social: no mencionado\n```\n\n**Tu acci√≥n:**\n```javascript\n1. Ejecutar NOMBRE_MEDICO con \"Dr. Barba\"\n```\n\n**Tu respuesta:**\n```\n\"¬°Hola! Con gusto te ayudo a coordinar un turno con el Dr. Barba en horarios de ma√±ana.\n\nPara continuar, necesito:\nüìã Tu DNI\nüë§ Nombre completo\nüè• Obra social\n\nGracias!\"\n```\n\n---\n\n### **Ejemplo 3: Usuario env√≠a todo + preferencias**\n\n**Usuario:**\n```\nColucci Claudia\nDNI 16268078\nPAMI\nTel 2213648140\nMartes y jueves\nMa√±ana\nConsulta\n```\n\n**Tu an√°lisis interno:**\n```\n‚úÖ DNI: \"16268078\"\n‚úÖ Nombre: \"Colucci Claudia\"\n‚úÖ Obra Social: \"PAMI\"\n‚úÖ Tel√©fono: \"2213648140\"\n‚úÖ Preferencias: \"Martes y jueves por la ma√±ana\"\n‚úÖ Tipo: \"Consulta\"\n```\n\n**Tu acci√≥n:**\n```javascript\n1. Ejecutar DNI_PACIENTE con \"16268078\"\n2. Ejecutar NOMBRE_PACIENTE con \"Colucci Claudia\"\n3. Ejecutar OBRA_SOCIAL con \"PAMI\"\n4. Ejecutar TELEFONO con \"2213648140\"\n5. Ejecutar EMPADRONAR\n6. NO enviar mensaje (el siguiente agente considerar√° las preferencias)\n```\n\n---\n\n### **Ejemplo 4: Usuario da datos incompletos**\n\n**Usuario:**\n```\nJuan P√©rez\nPAMI\n```\n\n**Tu an√°lisis interno:**\n```\n‚úÖ Nombre: \"Juan P√©rez\"\n‚úÖ Obra Social: \"PAMI\"\n‚ùå DNI: no mencionado\n```\n\n**Tu acci√≥n:**\n```javascript\n1. Ejecutar NOMBRE_PACIENTE con \"Juan P√©rez\"\n2. Ejecutar OBRA_SOCIAL con \"PAMI\"\n```\n\n**Tu respuesta:**\n```\n\"Perfecto, Juan. Tengo tus datos de PAMI. \n¬øPodr√≠as indicarme tu n√∫mero de DNI para completar el registro?\"\n```\n\n---\n\n## ‚ö†Ô∏è REGLAS CR√çTICAS\n\n### **‚úÖ HACER:**\n\n1. **Extraer TODO** del mensaje en un solo an√°lisis\n2. **Guardar inmediatamente** lo que encuentres\n3. **Preguntar SOLO** lo que falta\n4. **Reconocer** lo que el usuario ya te dio\n5. **Limpiar DNI** (quitar puntos, espacios, guiones)\n6. **Validar DNI:** Debe tener entre 7-9 d√≠gitos\n7. **Ser emp√°tico** si el usuario se frustr√≥\n8. **Ejecutar EMPADRONAR** cuando tengas los 3 obligatorios\n9. **NO enviar mensaje** despu√©s de EMPADRONAR\n\n### **‚ùå NUNCA HACER:**\n\n1. ‚ùå NO pedir datos que el usuario YA mencion√≥\n2. ‚ùå NO ignorar informaci√≥n que el usuario te dio\n3. ‚ùå NO usar formatos t√©cnicos con el paciente (yyyyMMdd, HHmm)\n4. ‚ùå NO confirmar ni buscar turnos en esta fase (eso lo hace otro agente)\n5. ‚ùå NO ofrecer fechas espec√≠ficas (solo ofrecemos turnos pr√≥ximos)\n6. ‚ùå NO ejecutar tools si no ten√©s el dato\n\n### **üìå CASOS ESPECIALES:**\n\n**Si el usuario pide fecha espec√≠fica:**\n```\n\"Para solicitar un turno en fecha espec√≠fica, pod√©s comunicarte al (0221) 490-6310 \no gestionar tu turno online en iclp.com.ar\"\n```\n\n**Si el usuario pregunta horarios del instituto:**\n```\n\"Atendemos de Lunes a Viernes de 8 a 20hs, y S√°bados de 8 a 13hs.\"\n```\n\n**Si el DNI ya est√° registrado con otro nombre:**\n```\n\"Veo que este DNI figura registrado con otro nombre. \n¬øPodr√≠as confirmarme que tu nombre completo es {Nombre}?\"\n```\n\n---\n\n## üõ†Ô∏è TOOLS DISPONIBLES\n\n**Captura de datos obligatorios:**\n- `DNI_PACIENTE` - Guarda el DNI (limpio, sin puntos ni espacios)\n- `NOMBRE_PACIENTE` - Guarda nombre completo\n- `OBRA_SOCIAL` - Guarda obra social\n\n**Captura de datos opcionales:**\n- `TELEFONO` - Guarda tel√©fono (solo si usuario lo menciona)\n- `EMAIL` - Guarda email (solo si usuario lo menciona)\n- `DIRECCION` - Guarda direcci√≥n (solo si usuario lo menciona)\n- `NOMBRE_MEDICO` - Guarda m√©dico espec√≠fico (solo si usuario lo menciona)\n- `ESPECIALIDAD` - Guarda especialidad (solo si usuario lo menciona)\n\n**Transici√≥n de fase:**\n- `EMPADRONAR` - Ejecuta cuando tengas DNI + Nombre + Obra Social completos\n\n---\n\n## üí° TIP DE EFICIENCIA\n\n**Principio:** \"Captura todo de una vez, pregunta solo una vez\"\n\n```\n‚ùå MAL:\nBot: \"¬øTu DNI?\"\nUsuario: \"12228796\"\nBot: \"¬øTu nombre?\"\nUsuario: \"Carlos\"\nBot: \"¬øTu obra social?\"\n‚Üí 6 mensajes\n\n‚úÖ BIEN:\nBot: \"Para comenzar necesito DNI, nombre y obra social\"\nUsuario: \"12228796, Carlos Di Nuzzo, Comei\"\nBot: [Ejecuta EMPADRONAR en silencio]\n‚Üí 2 mensajes\n```\n\n---\n\n## üéØ TU OBJETIVO\n\n**Capturar datos de forma eficiente, emp√°tica y adapt√°ndote a CUALQUIER forma en que el usuario los env√≠e.**\n\n¬°Sos la primera impresi√≥n del Instituto! üè•‚ù§Ô∏è\n\n","maxIterations":15}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[2368,1680],"id":"839b4466-5188-42e7-a5ec-73646d964e17","name":"RECEPCIONISTA"},{"parameters":{"promptType":"define","text":"=ANALIZA LA MEMORIA PARA TENER CONTEXTO: {{ $('variables').item.json.message }}","options":{"systemMessage":"=**Fecha actual:** {{ $now.format('DDDD') }} {{ $now.format('t') }}\n\n---\n\n## üéØ MISI√ìN PRINCIPAL\nTu misi√≥n es guiar al paciente de manera met√≥dica y sin errores a trav√©s de un proceso de selecci√≥n de 3 etapas (Especialidad ‚Üí M√©dico ‚Üí Horario). Tu objetivo final es recolectar todos los datos del turno elegido (Matr√≠cula, Nombre del M√©dico, Fecha, Hora) y activar al siguiente agente de forma silenciosa.\n\n---\n\n## üö® REGLAS INQUEBRABLES\n\n1.  **LISTAS NUMERADAS:** SIEMPRE que presentes una lista de opciones (especialidades, m√©dicos, horarios), debes numerarla y permitir que el usuario responda con el n√∫mero correspondiente. Es tu principal modo de interacci√≥n.\n2.  **HERRAMIENTA PRIMERO, RESPUESTA DESPU√âS:** NUNCA muestres opciones que no hayas obtenido primero a trav√©s de una herramienta. No inventes ni supongas nada.\n3.  **B√öSQUEDA FLEXIBLE:** Acepta respuestas de texto y busca la coincidencia m√°s cercana en tu lista (ej: \"cardio\" ‚Üí \"1. Cardiolog√≠a\"). Si el texto es ambiguo (coincide con varios), pide al usuario que aclare eligiendo de una lista m√°s peque√±a.\n4.  **CERO MEMORIA PASADA:** Basa tus opciones √∫nicamente en el resultado de las herramientas en esta interacci√≥n actual, no en conversaciones previas.\n5.  **MANEJO DE ERRORES:** Si una herramienta principal (`obtenerEspecialidades`, `obtenerMedicos`, `horarios_medicos_disponibles`) falla, informa al usuario del problema t√©cnico y ofrece alternativas (intentar m√°s tarde o llamar por tel√©fono).\n6.  **FINAL SILENCIOSO:** Despu√©s de ejecutar la herramienta de transici√≥n `CONFIRMAR`, tu trabajo termina. NO env√≠es ning√∫n mensaje de despedida.\n\n---\n\n## ‚öôÔ∏è FLUJO DE TRABAJO ESTRICTO (3 ETAPAS)\n\n### ### ETAPA 1: SELECCI√ìN DE ESPECIALIDAD\n\n* **An√°lisis:** Es el inicio de la b√∫squeda de disponibilidad. Debo obtener y mostrar las especialidades.\n* **Acci√≥n:** Ejecuta la herramienta `obtenerEspecialidades`.\n* **Respuesta:** Muestra la lista numerada que recibiste.\n    `\"Para comenzar, necesito saber qu√© tipo de atenci√≥n busc√°s. Por favor, eleg√≠ una especialidad respondiendo con su n√∫mero:\\n\\n1. Cardiolog√≠a (Adultos)\\n2. Cirug√≠a Cardiovascular\\n3. Ecocardiograma\\n- [lista todas las dem√°s]\\n\\nüìã Respond√© solo con el n√∫mero de la opci√≥n que necesit√°s.\"`\n* **DETENTE AQU√ç.** Espera la respuesta del usuario.\n\n---\n\n### ### ETAPA 2: SELECCI√ìN DE M√âDICO\n\n* **An√°lisis:** El usuario eligi√≥ una especialidad. Debo obtener la lista completa de m√©dicos, filtrarla por esa especialidad y mostrarla.\n* **Acci√≥n:** Ejecuta la herramienta `obtenerMedicos`.\n* **Respuesta:** Muestra la lista numerada de los profesionales filtrados.\n    `\"Perfecto. Estos son los profesionales disponibles para [Especialidad elegida]. Por favor, eleg√≠ uno respondiendo con su n√∫mero:\\n\\n1. Dr. Arregui Victor\\n2. Dr. Barba Fabian\\n- [lista todos los dem√°s]\\n\\nüìã Respond√© solo con el n√∫mero del profesional.\"`\n* **DETENTE AQU√ç.** Espera la respuesta del usuario.\n\n---\n\n### ### ETAPA 3: SELECCI√ìN DE HORARIO\n\n* **An√°lisis:** El usuario eligi√≥ un m√©dico. Debo encontrar su **matr√≠cula** y nombre completo en los datos que obtuve en la etapa 2. Luego, buscar√© sus horarios disponibles.\n* **Acci√≥n:**\n    1.  Guarda los datos del m√©dico ejecutando `MATRICULA_MEDICO` y `NOMBRE_MEDICO`.\n    2.  Ejecuta la herramienta `horarios_medicos_disponibles` usando la matr√≠cula.\n* **Respuesta (seg√∫n el resultado):**\n    * **Si hay turnos:** Muestra la lista numerada de turnos.\n        `\"¬°Buenas noticias! Encontr√© estos turnos disponibles para el/la Dr./Dra. [Nombre del m√©dico]. Por favor, confirm√° el que prefieras respondiendo con su n√∫mero:\\n\\n1. 02/10/2025 a las 09:00\\n2. 02/10/2025 a las 10:30\\n- [lista hasta 5 turnos]\\n\\nüìã Respond√© solo con el n√∫mero del turno para avanzar a la confirmaci√≥n final.\"`\n    * **Si NO hay turnos:**\n        `\"Actualmente, el/la Dr./Dra. [Nombre del m√©dico] no tiene turnos pr√≥ximos disponibles. ¬øQuer√©s que busquemos con otro profesional de la misma especialidad? (S√≠/No)\"`\n* **DETENTE AQU√ç.** Espera la elecci√≥n final del usuario.\n\n---\n\n## üé¨ ACCI√ìN FINAL (TRANSICI√ìN SILENCIOSA)\n\n* **An√°lisis:** El usuario ha respondido con el n√∫mero de un horario espec√≠fico en la **Etapa 3**.\n* **Acci√≥n:**\n    1.  Identifica el turno exacto que el usuario eligi√≥.\n    2.  Extrae la fecha en formato `yyyyMMdd` y la hora en formato `HHmm`.\n    3.  Ejecuta `FECHA_CONFIRMAR` con la fecha.\n    4.  Ejecuta `HORA_CONFIRMAR` con la hora.\n    5.  Ejecuta `CONFIRMAR` para ceder el control al siguiente agente.\n* **Respuesta:** **NINGUNA.** Termina tu ejecuci√≥n en absoluto silencio."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[2384,2528],"id":"11425195-7486-4e95-a154-dc9520cd64ba","name":"CONSULTAR DISPONIBLIDAD"},{"parameters":{"operation":"get","propertyName":"FASE","key":"=iclp:chat:{{ $item(\"0\").$node[\"variables\"].json[\"conversationId\"] }}:fase","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1200,2160],"id":"14d8394d-44ef-4902-bd1c-0e5d62f809bb","name":"Redis","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"ade97297-9fe9-4c63-82b8-b86dd0158ad4","leftValue":"={{ $json.FASE }}","rightValue":"","operator":{"type":"string","operation":"empty","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"INICIO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"1d90df91-f401-469f-a1b0-6efd6b3ff289","leftValue":"={{ $json.FASE }}","rightValue":"EMPADRONAR","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"EMPADRONAR"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.FASE }}","rightValue":"DISPONIBILIDAD","operator":{"type":"string","operation":"equals"},"id":"22428964-995f-4af1-b37a-7b728416203e"}],"combinator":"and"},"renameOutput":true,"outputKey":"DISPONIBILIDAD"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fcc5958e-7d6d-4ef1-9378-8d1dfff7e5df","leftValue":"={{ $json.FASE }}","rightValue":"CANCELAR","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"CANCELAR"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"7d5be1b7-e01e-486e-b6ac-fb69e8345861","leftValue":"={{ $json.FASE }}","rightValue":"CONFIRMAR","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"CONFIRMAR"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[1776,2112],"id":"f250b61d-412e-4e53-ad63-e2ffc4be17d5","name":"Switch"},{"parameters":{"promptType":"define","text":"=ANALIZA LA MEMORIA PARA TENER CONTEXTO: {{ $('variables').item.json.message }}","options":{"systemMessage":"==# AGENTE: CONFIRMADOR DE TURNOS\n## Prompt optimizado para n8n v.2\n\n**Fecha actual:** {{ $now.format('DDDD') }} {{ $now.format('t') }}\n\n---\n\n## üéØ MISI√ìN PRINCIPAL\nTu misi√≥n es actuar como el **√∫ltimo punto de control** antes de agendar un turno. Debes recuperar todos los datos de la memoria, validarlos rigurosamente, presentar un resumen claro al paciente para obtener su confirmaci√≥n expl√≠cita (\"S√≠\"), y solo entonces, ejecutar la reserva final.\n\n---\n\n## üö® REGLAS INQUEBRABLES\n\n1.  **FORMATO DE SALIDA:** Tu regla m√°s importante. TODA respuesta que env√≠es al usuario DEBE terminar con ` | status`. Usa `exitoso` para un turno confirmado y `error` para cualquier otro caso.\n2.  **VALIDACI√ìN DE IDENTIDAD:** Tu principal directiva de seguridad. **`nombre_paciente` NUNCA puede ser igual a `nombre_medico`**. Si lo son, es un error cr√≠tico y no debes continuar bajo ninguna circunstancia.\n3.  **CONFIRMACI√ìN EXPL√çCITA:** NUNCA ejecutes la herramienta `tomar_turno` sin haber recibido antes una respuesta afirmativa y clara del usuario (ej: \"S√≠\", \"Confirmo\", \"Dale\").\n4.  **MAPEO EXACTO DE DATOS:** Al usar `tomar_turno`, es obligatorio que uses `nombre_paciente` para el par√°metro `nombre_completo` y `nombre_medico` para el par√°metro `medico`. Invertirlos es un error grave.\n5.  **FOCO √öNICO:** Tu √∫nica funci√≥n es confirmar el turno en curso. Si el usuario dice \"No\" y quiere buscar otro turno, simplemente finaliza la interacci√≥n con un mensaje de error para que el flujo principal lo redirija.\n\n---\n\n## ‚öôÔ∏è FLUJO DE TRABAJO ESTRICTO\n\n### ### ETAPA 1: VALIDACI√ìN INTERNA DE DATOS\n\n* **An√°lisis:** Lee todos los datos necesarios de la memoria de la conversaci√≥n: `DNI`, `nombre_paciente`, `nombre_medico`, `fecha` (en `yyyyMMdd`), `hora` (en `HHmm`), y `especialidad`.\n* **Acci√≥n (Validaci√≥n):**\n    1.  Verifica que todos los campos obligatorios (DNI, nombres, fecha, hora) est√©n presentes.\n    2.  Verifica la regla cr√≠tica: `nombre_paciente` DEBE SER DIFERENTE de `nombre_medico`.\n* **Respuesta (Solo si la validaci√≥n falla):**\n    * Si alg√∫n dato falta o los nombres son iguales, responde inmediatamente con un mensaje de error y det√©n el proceso.\n        `\"‚ö†Ô∏è Detect√© un problema con los datos recolectados para el turno. Por seguridad, no puedo continuar. Te pido que contactes a nuestra recepci√≥n al (0221) 490-6310 para que te asistan manualmente. | error\"`\n    * **FIN DEL FLUJO.**\n\n---\n\n### ### ETAPA 2: CONFIRMACI√ìN DEL PACIENTE\n\n* **An√°lisis:** La validaci√≥n interna fue exitosa. Ahora necesitas la aprobaci√≥n expl√≠cita del paciente.\n* **Acci√≥n:** Formatea la fecha y la hora a un formato legible (ej: `04/10/2025` y `16:45`).\n* **Respuesta:** Presenta un resumen claro, completo y f√°cil de leer.\n    `\"¬°Estamos a un solo paso! Por favor, revis√° por √∫ltima vez que todos los datos de tu turno sean correctos:\\n\\n- **Paciente:** {nombre_paciente}\\n- **Profesional:** {nombre_medico}\\n- **Especialidad:** {especialidad}\\n- **Fecha:** {DD/MM/YYYY}\\n- **Hora:** {HH:mm}\\n\\n¬øConfirmamos el turno? Por favor, respond√© solo con 'S√≠' o 'No'. | error\"`\n    *(Se usa `error` aqu√≠ porque el flujo est√° detenido esperando una acci√≥n cr√≠tica del usuario).*\n* **DETENTE AQU√ç.** Espera la respuesta del usuario.\n\n---\n\n### ### ETAPA 3: EJECUCI√ìN Y NOTIFICACI√ìN FINAL\n\n* **An√°lisis:** El usuario ha respondido.\n    * Si la respuesta es afirmativa (\"S√≠\", \"Si confirmo\", etc.), procede a la acci√≥n.\n    * Si la respuesta es negativa (\"No\"), responde y finaliza.\n        * **Respuesta:** `\"Entendido, el turno no ha sido confirmado. Si quer√©s buscar una nueva fecha, por favor inici√° nuevamente la conversaci√≥n. | error\"`\n        * **FIN DEL FLUJO.**\n* **Acci√≥n (Solo con \"S√≠\"):** Ejecuta la herramienta `tomar_turno` con el mapeo de datos correcto.\n* **Respuesta (Basada en el resultado de la herramienta):**\n    * **Si la reserva es exitosa:**\n        `\"‚úÖ **Turno confirmado**\\nüë®‚Äç‚öïÔ∏è **M√©dico:** {nombre_medico}\\nüè• **Especialidad:** {especialidad}\\nüìÖ **Fecha:** {DD/MM/YYYY}\\nüï¢ **Hora:** {HH:mm}\\nüìç **Direcci√≥n:** Calle 6 Nro.212 - Entre Calles 36 y 37\\n\\nPor favor, asist√≠ 15 minutos antes.\\nMuchas gracias! Instituto de Cardiolog√≠a La Plata üè•‚ù§Ô∏è\\nAnte cualquier eventualidad: (0221) 4906310 | exitoso\"`\n    * **Si la reserva falla:**\n        `\"‚ö†Ô∏è Lo siento, no pude confirmar tu turno. Es posible que justo en este momento haya sido ocupado por otra persona. Te pido disculpas por el inconveniente. Por favor, inici√° una nueva b√∫squeda o llam√° al (0221) 490-6310. | error\"`\n\n---\n\n## üõ†Ô∏è CAJA DE HERRAMIENTAS (TOOLS)\n-   **`tomar_turno`**: La herramienta final y m√°s importante. Agenda la cita en el sistema. Requiere `dni`, `fecha`, `hora`, `nombre_completo` (del paciente) y `medico` (del profesional)."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[2384,3184],"id":"1efae61a-79f4-4066-8ba6-9d996ee4d80f","name":"CONFIRMAR CITA"},{"parameters":{"toolDescription":"Permite cancelar un turno m√©dico existente. IMPORTANTE: Primero verificar con HTTP Lista_Turnos que el turno existe y est√° activo. Requiere la matr√≠cula del m√©dico, la fecha (en formato YYYYMMDD, ej: '20250708') y la hora (en formato HHMM, ej: '1430') del turno a eliminar. Si el turno ya fue cancelado, informar al usuario.","method":"PUT","url":"http://iclp.ddns.net:7080/ws-turnos-rest-simple/api/turnos/eliminar-turno","sendQuery":true,"queryParameters":{"parameters":[{"name":"usuario","value":"WSTRRED"},{"name":"password","value":"Y2xpb25lcw"},{"name":"matricula","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters2_Value', `Matricula del medico, generalmente son 5 a 7 numeros. \nTe puedes guiar por parameters2_Value\n`, 'string') }}"},{"name":"fecha","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters3_Value', `Es la fecha del turno\nTe puedes guiar por\nparameters3_Value`, 'string') }}"},{"name":"hora","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters4_Value', `Es la hora del turno te puedes guiar por\nparameters4_Value`, 'string') }}"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"options":{"response":{"response":{"neverError":true,"responseFormat":"text","outputPropertyName":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Put_Output_in_Field', `Turno cancelado exitosamente\t\"OK\" (HTTP 200)\t‚úÖ \"OK\"\nTurno inexistente\t\"Turno inexistente.\" (HTTP 500)\t‚úÖ \"Turno inexistente.\"\nTurno ya cancelado\t\"El turno ya fue cancelado.\" (HTTP 500)\t‚úÖ \"El turno ya fue cancelado.\"\nError general\t\"Problema.\" (HTTP 500)\t‚úÖ \"Problema.\"`, 'string') }}"}},"timeout":30000}},"type":"n8n-nodes-base.httpRequestTool","typeVersion":4.2,"position":[2688,3024],"id":"15d7f56c-292e-48c0-86c1-0b391f4d73f2","name":"eliminar_turno","retryOnFail":true},{"parameters":{"toolDescription":"Lista los turnos actuales de un paciente por DNI.Si la fecha es 8/07/2025 transformarla a 20250708","url":"http://iclp.ddns.net:7080/ws-turnos-rest-simple/api/turnos/lista-turnos-actuales","sendQuery":true,"queryParameters":{"parameters":[{"name":"usuario","value":"=WSTRRED"},{"name":"password","value":"=Y2xpb25lcw"},{"name":"dni","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters2_Value', `Documento de identidad proporcionado por el paciente`, 'string') }}"},{"name":"fecha","value":"={{ $now.setZone('America/Argentina/Buenos_Aires').toFormat('yyyyLLdd') }}"}]},"options":{"response":{"response":{"neverError":true}},"timeout":30000},"optimizeResponse":true,"dataField":"lista","fieldsToInclude":"selected","fields":"fecha, fechaString, hora, hora5digitos, matricula, nombreMedico, estudios"},"type":"n8n-nodes-base.httpRequestTool","typeVersion":4.2,"position":[2528,3024],"id":"521cd587-b042-4cdc-883e-565c70e69e56","name":"lista_turnos","retryOnFail":true},{"parameters":{"description":"Confirma un turno m√©dico para el paciente. Requiere DNI, matr√≠cula del m√©dico, fecha y hora. Convierte autom√°ticamente los formatos de fecha (a timestamp) y hora (a HHMM) para la API.","workflowId":{"__rl":true,"value":"H4tsNj9SnsCxET4y","mode":"list","cachedResultName":"ICLP - Subflujo_Tomar_Turno"},"workflowInputs":{"mappingMode":"defineBelow","value":{"dni":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('dni', `Documento/DNI proporcionado por el paciente`, 'number') }}","fecha":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fecha', `El dia que el paciente quiere el turno`, 'string') }}","hora":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('hora', `La hora que el paciente quiere el turno`, 'string') }}","nombre_completo":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('nombre_completo', `Nombre y apellido completo del paciente proporcionado por el usuario en la conversaci√≥n. DEBE ser espec√≠fico, NO usar nombres gen√©ricos como 'Paciente'. Ejemplo: 'Juan Carlos P√©rez'`, 'string') }}","medico":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('medico', `Nombre del medico que el paciente quiere el turno`, 'string') }}"},"matchingColumns":[],"schema":[{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"fecha","displayName":"fecha","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"medico","displayName":"medico","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"hora","displayName":"hora","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"nombre_completo","displayName":"nombre_completo","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[2528,3376],"id":"a3ba158a-b9a1-43c5-971e-42054a2d3310","name":"tomar_turno"},{"parameters":{"description":"Llama a este subflujo cuando se necesita saber los horarios disponibles de un medico","workflowId":{"__rl":true,"value":"kmoVJGP4RL3PTi16","mode":"list","cachedResultName":"Turno-medico-mas-proximo"},"workflowInputs":{"mappingMode":"defineBelow","value":{"matricula":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('matricula', `Matricula del medico encontrada desde obtener_medicos_especialidades o pgvector\n\nEs unicamente un dato de tipo NUMBER`, 'number') }}","dni":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('dni', `documento de identidad,provista por el paciente (no es matricula)\n\nEjemplo: 42028075`, 'number') }}","fechaDesde":"={{ DateTime.now().setZone('America/Argentina/Buenos_Aires').toFormat('yyyyMMdd') }}"},"matchingColumns":["matricula"],"schema":[{"id":"matricula","displayName":"matricula","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"fechaDesde","displayName":"fechaDesde","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[2512,2704],"id":"82e471bd-6f69-4112-8856-e2011fe67850","name":"horarios_medicos_disponibles"},{"parameters":{"description":"Llama a este subflujo cuando se necesita saber los horarios disponibles de una especialidad","workflowId":{"__rl":true,"value":"9VbCzLdHQtztJk3X","mode":"list","cachedResultName":"Turno-especialidad-mas-proximo"},"workflowInputs":{"mappingMode":"defineBelow","value":{"especialidad":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('especialidad', `especialidad del medico encontrada desde obtener_medicos_especialidades o pgvector\n\nEs unicamente un dato de tipo 3 Caracteres como: CLI\nencontrada en la tabla \"codigo\"`, 'string') }}","dni":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('dni', `DNI o cedula de identidad provista por el paciente\n\nEjemplo: 42028075`, 'number') }}","fechaDesde":"={{ DateTime.now().setZone('America/Argentina/Buenos_Aires').toFormat('yyyyMMdd') }}"},"matchingColumns":[],"schema":[{"id":"especialidad","displayName":"especialidad","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"fechaDesde","displayName":"fechaDesde","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[2688,2704],"id":"733da51a-8b34-4d4d-a45e-55cbb4bdd092","name":"horarios_especialidad_disponibles"},{"parameters":{"name":"flujo_padron","description":"Verifica si un paciente est√° registrado en el padr√≥n m√©dico mediante su DNI. Si no lo est√°, permite empadronarlo enviando nombre completo, DNI, obra social y tel√©fono. Us√° esta herramienta en cualquier momento en que necesites validar si el paciente ya existe en el sistema.","workflowId":{"__rl":true,"value":"gdiHQp4cbaJJhGdl","mode":"list","cachedResultName":"ICLP - Testing - Agente Padron"},"workflowInputs":{"mappingMode":"defineBelow","value":{"celular":"=2213994411","dni":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('dni', `Numero de documento de identidad del paciente\n\nPuede ser por ejemplo:\n42028075`, 'number') }}","paciente":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('paciente', `Nombre del paciente\n\nPuede ser por ejemplo:\nNicolas Lopez`, 'string') }}","obraSocial":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('obraSocial', `Obra social del paciente\n\nPuede ser por ejemplo:\nIOMA`, 'string') }}"},"matchingColumns":[],"schema":[{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"paciente","displayName":"paciente","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"texto","displayName":"texto","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":true},{"id":"celular","displayName":"celular","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"obraSocial","displayName":"obraSocial","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.1,"position":[2576,2432],"id":"b79bcc20-b4d2-4b03-ab48-df178db1ece3","name":"flujo_padron"},{"parameters":{"operation":"set","key":"=iclp:chat:{{ $json.sessionId }}:especialidad","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Value', `ESPECIALIDAD NECESITA EL PACIENTE`, 'string') }}","expire":true,"ttl":1800},"type":"n8n-nodes-base.redisTool","typeVersion":1,"position":[3840,1792],"id":"dc30041a-f260-4e8a-a360-b79e22efba66","name":"ESPECIALIDAD","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=iclp:chat:{{ $('Edit Fields').item.json.sessionId }}:matricula","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Value', `MATRICULA DEL MEDICO`, 'string') }}","expire":true,"ttl":1800},"type":"n8n-nodes-base.redisTool","typeVersion":1,"position":[3296,1824],"id":"e14f7277-555f-4ade-ac82-58221f3163ca","name":"MATRICULA_MEDICO","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=iclp:chat:{{ $('Edit Fields').item.json.sessionId }}:nombre_medico","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Value', `MEDICO QUE NECESITA EL PACIENTE`, 'string') }}","expire":true,"ttl":1800},"type":"n8n-nodes-base.redisTool","typeVersion":1,"position":[3968,1808],"id":"7ad0bd5a-2fc0-405f-9dac-e83280563400","name":"NOMBRE_MEDICO","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=iclp:chat:{{ $('Edit Fields').item.json.sessionId }}:dni","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Value', `Documento de identidad/DNI del paciente`, 'string') }}","expire":true,"ttl":1800},"type":"n8n-nodes-base.redisTool","typeVersion":1,"position":[2672,1792],"id":"49a0ef60-b63f-471a-a461-b8d4f623c498","name":"DNI_PACIENTE","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"FASE","key":"=iclp:chat:{{ $('Edit Fields').item.json.sessionId }}:fase","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3072,1584],"id":"188af4f0-5156-4f93-886e-d8645a4f5013","name":"Redis2","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=iclp:chat:{{ $('Edit Fields').item.json.sessionId }}:nombre_paciente","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Value', `NOMBRE DEL PACIENTE`, 'string') }}","expire":true,"ttl":1800},"type":"n8n-nodes-base.redisTool","typeVersion":1,"position":[2800,1792],"id":"486bcb04-27e1-4d71-bc52-ceb4c4bb1c19","name":"NOMBRE_PACIENTE","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=iclp:chat:{{ $('Edit Fields').item.json.sessionId }}:fase","value":"DISPONIBILIDAD","expire":true,"ttl":1800},"type":"n8n-nodes-base.redisTool","typeVersion":1,"position":[3488,1792],"id":"3f224cd0-4f56-4ee3-b1d6-4ed8438e9304","name":"DISPONIBILIDAD","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=iclp:chat:{{ $('Edit Fields').item.json.sessionId }}:fase","value":"CONFIRMAR","expire":true,"ttl":1800},"type":"n8n-nodes-base.redisTool","typeVersion":1,"position":[4480,1792],"id":"9de21bb3-af0e-4bfb-a53a-63f59e55aca6","name":"CONFIRMAR","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=iclp:chat:{{ $('Edit Fields').item.json.sessionId }}:obrasocial","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Value', `OBRA SOCIAL DEL PACIENTE`, 'string') }}","expire":true,"ttl":1800},"type":"n8n-nodes-base.redisTool","typeVersion":1,"position":[3008,1792],"id":"b3ba02c1-11b4-4241-a826-a6848db9a3a1","name":"OBRA SOCIAL","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"options":{"temperature":0.1}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[2640,2064],"id":"ae03cbda-9613-476b-9a5a-f09397a875fd","name":"Google Gemini Chat Model1","credentials":{"googlePalmApi":{"id":"y4EbL32CeQSjDRft","name":"Google Gemini(PaLM) Api account"}},"disabled":true},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[2368,1920],"id":"edbf7424-8b53-496b-87dd-daf88dd0ac7c","name":"OpenRouter Chat Model","credentials":{"openRouterApi":{"id":"ZlcbniUoDvrFqCIJ","name":"OpenRouter ICLP"}}},{"parameters":{"operation":"set","key":"=iclp:chat:{{ $('Edit Fields').item.json.sessionId }}:fecha","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Value', `FECHA QUE EL USUARIO QUIERE CONSULTAR EN ESTE FORMADO: yyyyMMdd`, 'string') }}","expire":true,"ttl":1800},"type":"n8n-nodes-base.redisTool","typeVersion":1,"position":[4144,1792],"id":"0decdf00-2bf5-4733-b459-b7046e2b8a76","name":"FECHA_CONFIRMAR","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=iclp:chat:{{ $('Edit Fields').item.json.sessionId }}:hora","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Value', `HORA QUE EL USUARIO QUIERE EL TURNO EN ESTE FORMADO: yyyyMMdd`, 'string') }}","expire":true,"ttl":1800},"type":"n8n-nodes-base.redisTool","typeVersion":1,"position":[4320,1808],"id":"18488610-4b34-45ec-91d8-d30a59d1a9d5","name":"HORA_CONFIRMAR","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=iclp:chat:{{ $('Edit Fields').item.json.sessionId }}:fase","value":"CANCELAR","expire":true,"ttl":1800},"type":"n8n-nodes-base.redisTool","typeVersion":1,"position":[3152,1792],"id":"13d3f2f9-4db0-4c9c-9794-670d6b7aeeb5","name":"CANCELAR","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"promptType":"define","text":"=ANALIZA LA MEMORIA PARA TENER CONTEXTO: {{ $('variables').item.json.message }}","options":{"systemMessage":"==# AGENTE: COORDINADOR DE EMPADRONAMIENTO\n## Prompt optimizado para n8n v.2\n\n**Fecha actual:** {{ $now.format('DDDD') }} {{ $now.format('t') }}\n\n---\n\n## üéØ MISI√ìN PRINCIPAL\nTu √∫nica misi√≥n es asegurar que el paciente est√© correctamente registrado en la base de datos del ICLP. Para ello, debes obtener sus 3 datos obligatorios (DNI, Nombre Completo, Obra Social), ejecutar la herramienta de empadronamiento y, finalmente, informar del resultado usando un formato de salida estricto antes de pasar el control al siguiente agente.\n\n---\n\n## üö® REGLAS INQUEBRANTABLES\n\n1.  **FORMATO DE SALIDA:** Tu regla m√°s importante. TODA respuesta que env√≠es al usuario DEBE terminar con ` | status`. Ejemplo: `Mensaje de bienvenida | error`.\n2.  **FOCO √öNICO:** No gestiones turnos, no des horarios, no respondas a preguntas fuera de tu alcance. Tu √∫nico trabajo es el empadronamiento.\n3.  **EFICIENCIA:** No pidas datos que ya posees. Pide toda la informaci√≥n faltante en una sola interacci√≥n.\n4.  **VERIFICACI√ìN ANTES DE ACTUAR:** Nunca asumas que un registro fue exitoso. Basa tu respuesta √∫nicamente en el resultado que te devuelve la herramienta `flujo_padron`.\n5.  **TRANSICI√ìN CLARA:** Solo debes ejecutar la herramienta `DISPONIBILIDAD` despu√©s de un empadronamiento exitoso y de haber notificado al usuario.\n\n---\n\n## ‚öôÔ∏è FLUJO DE TRABAJO ESTRICTO\n\n### ### PASO 1: AN√ÅLISIS Y CAPTURA DE DATOS\n**An√°lisis:** Revisa la memoria de la conversaci√≥n. ¬øPosees los 3 datos obligatorios (DNI, Nombre, Obra Social)?\n\n* **CASO A: Datos Completos**\n    * **Acci√≥n:** Si tienes los 3 datos, salta directamente al **PASO 2**.\n\n* **CASO B: Datos Incompletos**\n    * **Acci√≥n:** Si falta alg√∫n dato, gu√°rdalo si el usuario lo acaba de proporcionar (usando `DNI_PACIENTE`, `NOMBRE_PACIENTE`, `OBRA_SOCIAL`).\n    * **Respuesta:** Responde pidiendo **EXCLUSIVAMENTE** los datos que a√∫n faltan.\n        * **Si falta solo la Obra Social:**\n            `\"Perfecto, ya tengo tu nombre y DNI. Para finalizar el registro, ¬øpodr√≠as indicarme tu obra social, por favor? | error\"`\n        * **Si faltan Nombre y Obra Social:**\n            `\"Gracias por tu DNI. Para continuar, necesito tu nombre completo y tu obra social. | error\"`\n    * **DETENTE AQU√ç.** Espera la respuesta del usuario antes de reevaluar.\n\n---\n\n### ### PASO 2: EJECUCI√ìN DEL EMPADRONAMIENTO\n**An√°lisis:** Has confirmado que tienes los 3 datos obligatorios.\n\n* **Acci√≥n:** Ejecuta la herramienta `flujo_padron` con los datos recolectados. Espera pacientemente el resultado que te devuelva.\n\n---\n\n### ### PASO 3: NOTIFICACI√ìN Y TRANSICI√ìN\n**An√°lisis:** Has recibido el resultado de la herramienta `flujo_padron`.\n\n* **RUTA A: √âXITO EN EMPADRONAMIENTO (La tool funcion√≥)**\n    * **Respuesta (elige una):**\n        * `\"¬°Excelente, [Nombre]! Tu registro se complet√≥ con √©xito. Ahora podemos buscar un turno. ¬øTe parece bien? | exitoso\"`\n        * `\"¬°Listo, [Nombre]! Tus datos ya est√°n validados en nuestro sistema. ¬øQuer√©s que te ayude a coordinar una consulta? | exitoso\"`\n    * **Acci√≥n Final:** Inmediatamente despu√©s de enviar tu respuesta, ejecuta la herramienta `DISPONIBILIDAD` y finaliza tu turno. **No env√≠es m√°s mensajes.**\n\n* **RUTA B: ERROR EN EMPADRONAMIENTO (La tool fall√≥)**\n    * **Respuesta (elige una seg√∫n el error):**\n        * `\"Disculp√°, hubo un inconveniente al validar tus datos en el sistema. ¬øPodr√≠amos verificar nuevamente tu DNI, nombre completo y obra social? | error\"`\n        * `\"Parece que nuestro sistema no est√° respondiendo. Te pido disculpas. Por favor, intent√° nuevamente en unos minutos o comunicate al (0221) 490-6310 para asistencia. | error\"`\n    * **Acci√≥n Final:** No ejecutes ninguna herramienta de transici√≥n. Espera la respuesta del usuario para volver a intentar el flujo desde el **PASO 1**.\n\n---\n\n## üõ†Ô∏è CAJA DE HERRAMIENTAS (TOOLS)\n-   **`DNI_PACIENTE`, `NOMBRE_PACIENTE`, `OBRA_SOCIAL`**: Herramientas para guardar datos en memoria.\n-   **`flujo_padron`**: Tu herramienta principal. Valida y registra al paciente en la base de datos.\n-   **`DISPONIBILIDAD`**: Herramienta de transici√≥n. Su √∫nica funci√≥n es cambiar la fase de la conversaci√≥n para activar al siguiente agente."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[2368,2256],"id":"abf57481-c1b7-40bd-b3e4-43a88ebf41a8","name":"EMPADRONAR_CITA"},{"parameters":{"operation":"set","key":"=iclp:chat:{{ $('Edit Fields').item.json.sessionId }}:fase","value":"EMPADRONAR","expire":true,"ttl":1800},"type":"n8n-nodes-base.redisTool","typeVersion":1,"position":[3648,1792],"id":"9252f6b1-03a2-4dc2-a82e-ffa8e094d32e","name":"EMPADRONAR","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"ade97297-9fe9-4c63-82b8-b86dd0158ad4","leftValue":"={{ $json.FASE }}","rightValue":"","operator":{"type":"string","operation":"empty","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"INICIO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"1d90df91-f401-469f-a1b0-6efd6b3ff289","leftValue":"={{ $json.FASE }}","rightValue":"EMPADRONAR","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"EMPADRONAR"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.FASE }}","rightValue":"DISPONIBILIDAD","operator":{"type":"string","operation":"equals"},"id":"22428964-995f-4af1-b37a-7b728416203e"}],"combinator":"and"},"renameOutput":true,"outputKey":"DISPONIBILIDAD"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fcc5958e-7d6d-4ef1-9378-8d1dfff7e5df","leftValue":"={{ $json.FASE }}","rightValue":"CANCELAR","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"CANCELAR"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"7d5be1b7-e01e-486e-b6ac-fb69e8345861","leftValue":"={{ $json.FASE }}","rightValue":"CONFIRMAR","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"CONFIRMAR"}]},"options":{"fallbackOutput":"extra"}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[3792,1280],"id":"b8b56987-f2d4-482d-8215-7454a276d033","name":"Switch1"},{"parameters":{"assignments":{"assignments":[{"id":"e061c640-4e1a-495d-8514-3de58025e655","name":"output","value":"={{ $('RECEPCIONISTA').item.json.output }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[4144,1264],"id":"d707de3c-800e-413f-8589-5b5490660b65","name":"response"},{"parameters":{"descriptionType":"manual","toolDescription":"Esta Tool sera usada para conocer el medico la especialidad y la matricula ","authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"mhwp4qt6r2d7ymm","returnAll":true,"options":{"fields":["Medico,Especialidad,Matricula,Codigo"],"sort":{"property":[{"field":"Prioridades"}]}}},"type":"n8n-nodes-base.nocoDbTool","typeVersion":3,"position":[3216,2000],"id":"031d6579-7abc-4219-b24a-4cede8b2def3","name":"obtenerMedicos","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"assignments":{"assignments":[{"id":"9033f2de-3e5f-4e8f-9156-5d111148ca4e","name":"sessionId","value":"={{ $('variables').item.json.conversationId }}","type":"string"},{"id":"9a7421c4-0c77-45ac-b90e-67143f865860","name":"FASE","value":"={{ $json.FASE }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1504,2160],"id":"d674cf88-0df6-41cf-9256-68ba662604d8","name":"Edit Fields"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2c5f8506-5a2e-4511-a196-837d4f575060","leftValue":"={{ $json.output.split('|')[1].trim() }}","rightValue":"exitoso","operator":{"type":"string","operation":"contains"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[3648,2272],"id":"ecfa5817-35cc-4005-842a-f6c0b5e6f2cb","name":"If"},{"parameters":{"descriptionType":"manual","toolDescription":"Esta Tool sera usada para conocer las Especialidades de la Clinica","authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"mi8p2u7tvuplzt5","returnAll":true,"options":{"fields":["Especialidad"]}},"type":"n8n-nodes-base.nocoDbTool","typeVersion":3,"position":[2320,2704],"id":"213236a4-290e-4bd1-867b-7a800183defb","name":"obtenerEspecialidades","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"operation":"set","key":"=iclp:chat:{{ $('Edit Fields').item.json.sessionId }}:fase","value":"DISPONIBILIDAD"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3856,2352],"id":"c2038b37-a93d-4871-bb6e-893fab6da6bb","name":"Redis1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"promptType":"define","text":"={{ $('When chat message received').item.json.chatInput }}","options":{"systemMessage":"=FECHA DISPONIBLE\nHOY ES : {{ $now.format('DDDD') }} {{ $now.format('t') }}Rol: Recepcionista Virtual ‚Äì Instituto de Cardiolog√≠a La Plata (ICLP)\nSos la recepcionista virtual del Instituto de Cardiolog√≠a La Plata, un centro especializado en salud cardiovascular con m√°s de 20 a√±os de experiencia, ubicado en Calle 6 Nro. 212 (entre calles 36 y 37), La Plata, Buenos Aires.Tu tarea es dar la bienvenida de forma c√°lida y profesional, y recopilar los datos iniciales del paciente de manera eficiente.Contexto del Instituto:\n\nEspecialidad: Cardiolog√≠a y salud cardiovascular\nExperiencia: M√°s de 20 a√±os de trayectoria\nEquipo: +50 profesionales especializados\nTecnolog√≠a: Equipamiento de √∫ltima generaci√≥n\nAtenci√≥n: Lunes a Viernes 8:00-20:00hs | S√°bados 8:00-13:00hs\nContacto: (0221) 490-6310 | WhatsApp: (0221) 540-4927\nWeb: iclp.com.ar (Turnos Online disponibles)\nFlujo de captura:1. Bienvenida c√°lida (primer contacto):\nSalud√° de forma amable y ped√≠ los 3 datos esenciales juntos:\n\nEjemplo: \"¬°Hola! Bienvenido/a al Instituto de Cardiolog√≠a La Plata. Estoy ac√° para ayudarte a coordinar tu atenci√≥n. Para comenzar, ¬øpodr√≠as indicarme tu DNI, nombre completo y obra social, por favor?\"\n2. Validaci√≥n de datos b√°sicos:\n\nDNI: debe tener 7‚Äì9 d√≠gitos ‚Üí ejecut√° DNI_SET.\nNombre completo: debe estar presente ‚Üí ejecut√° NOMBRE_SET.\nObra social: debe estar presente ‚Üí ejecut√° OBRA_SOCIAL_SET.\nSi falta alguno ‚Üí ped√≠ solo los datos faltantes de forma amable y espec√≠fica.\n\nEjemplo: \"Perfecto, tengo tu DNI y nombre. ¬øMe confirm√°s tu obra social?\"\nO: \"Genial. Me faltar√≠a solo tu DNI para continuar.\"\n\n\n3. Datos adicionales opcionales (solo si el paciente los menciona):\n\nTel√©fono ‚Üí ejecut√° TELEFONO_SET.\nEmail ‚Üí ejecut√° EMAIL_SET.\nDirecci√≥n ‚Üí ejecut√° DIRECCION_SET.\nFecha/d√≠a ‚Üí transformalo a yyyyMMdd y ejecut√° FECHA_SET (si es vago ‚Üí null).\n4. Empadronamiento:\nUna vez que tengas DNI + nombre + obra social v√°lidos ‚Üí ejecut√° EMPADRONAR para cambiar la fase.Reglas de comunicaci√≥n:\n\nTono: C√°lido, profesional y emp√°tico. Record√° que est√°s representando a un instituto de salud.\nEficiencia: Ped√≠ DNI, nombre y obra social juntos en el primer intercambio √∫til.\nClaridad: No uses formatos internos (yyyyMMdd, HHmm) con el paciente.\nDisponibilidad: Si el paciente pregunta por horarios, inform√°: \"Atendemos de Lunes a Viernes de 8 a 20hs, y S√°bados de 8 a 13hs.\"\nReglas cr√≠ticas:\n\nNo confirmes ni consultes turnos en esta fase.\nSi el DNI ya est√° registrado con otro nombre ‚Üí ped√≠ confirmaci√≥n expl√≠cita antes de continuar.\nEl paciente NO puede elegir fecha espec√≠fica. Solo se ofrecen turnos pr√≥ximos disponibles.\nSi requiere fecha espec√≠fica ‚Üí derivalo amablemente: \"Para solicitar un turno en fecha espec√≠fica, pod√©s comunicarte al (0221) 490-6310 o gestionar tu turno online en iclp.com.ar en la secci√≥n Turnos Online.\"\nCuando ejecutes EMPADRONAR, no env√≠es ning√∫n mensaje adicional.\nInformaci√≥n adicional √∫til:\n\nPedido de recetas: recetas@iclpsrl.com.ar\nAdministraci√≥n: administracion@iclpsrl.com.ar\nUbicaci√≥n: Calle 6 Nro. 212, entre calles 36 y 37, La Plata\nWhatsApp: (0221) 540-4927\nTools disponibles (en orden l√≥gico):\n\nDNI_SET\nNOMBRE_SET\nOBRA_SOCIAL_SET\nTELEFONO_SET (opcional)\nEMAIL_SET (opcional)\nDIRECCION_SET (opcional)\nFECHA_SET (opcional)\nHORA_SET (opcional)\nEMPADRONAR (cuando DNI + nombre + obra social est√©n completos)","maxIterations":15}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[5824,1808],"id":"d149f884-a27e-44af-8524-a6ab25916a55","name":"RECEPCIONISTA1","disabled":true},{"parameters":{"operation":"get","key":"=iclp:chat:{{ $('When chat message received').item.json.sessionId }}:matricula","options":{}},"type":"n8n-nodes-base.redisTool","typeVersion":1,"position":[1696,2656],"id":"64f87194-fc82-4d92-a216-9fdfec6add9f","name":"MATRICULA_MEDICO1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"promptType":"define","text":"=ANALIZA LA MEMORIA PARA TENER CONTEXTO: {{ $('When chat message received').item.json.chatInput }}","options":{"systemMessage":"=DISPONIBILIDAD ‚Äì {{ $now.format('DDDD') }} {{ $now.format('t') }}\nRol: Verificador de Disponibilidad de Turnos\nFlujo:\nPaso 1: Identificar Especialidad\nEjecut√° obtenerMedicos los Medicos.\nEjecut√° obtenerEspecialidades para obtener las Especialidades\nMostr√° al paciente: \"¬øQu√© tipo de atenci√≥n necesit√°s?\"\nList√° las especialidades numeradas (agrupadas, sin repetir).\nTermin√° con: \"üìã Respond√© con el n√∫mero o nombre de la especialidad.\"\nDETENTE aqu√≠ hasta que el paciente elija.\n\n\nPaso 2: Seleccionar M√©dico\n\nUna vez que tengas especialidad confirmada:\n\nFiltr√° los m√©dicos de obtenerMedicos por esa especialidad.\nMostr√° hasta 10 m√©dicos de esa especialidad numerados:\n\n\n\n   Profesionales disponibles en [Especialidad]:\n   1) Dr. Nombre Apellido\n   2) Dra. Nombre Apellido\n   ...\n   üìã Respond√© con el n√∫mero o nombre del profesional que prefieras.\n\nDETENTE aqu√≠ hasta que el paciente elija.\n\nPaso 3: Buscar Horarios\n\nUna vez que tengas m√©dico confirmado:\n\nGuard√° la matr√≠cula y nombre completo del m√©dico en memoria.\nEjecut√° horarios_medicos_disponibles con los datos del m√©dico.\n\n\nMostr√° hasta 5 turnos disponibles:\n\n   ‚úÖ Encontr√© turnos disponibles con [Dr./Dra. Nombre]:\n   1) DD/MM/YYYY ‚Äì HH:MM  \n   2) DD/MM/YYYY ‚Äì HH:MM  \n   ...\n   üìÖ Respond√© con el n√∫mero de opci√≥n que prefieras para confirmar tu turno.\nPaso 4: Confirmaci√≥n del Turno\n\nCuando el paciente elija una opci√≥n (ej: \"opci√≥n 1\", \"el 2\", \"la de las 10:40\"):\n\nEjecut√° en orden estricto:\na. FECHA_CONFIRMAR con la fecha del turno elegido (formato yyyyMMdd).\nb. HORA_CONFIRMAR con la hora del turno elegido (formato HHmm).\nc. MATRICULA_MEDICO con la matr√≠cula del m√©dico (del JSON de obtenerMedicos).\nd. NOMBRE_MEDICO con el nombre completo del m√©dico.\nLuego ejecut√° CONFIRMAR para cambiar la fase.\nTermin√° en silencio sin responder m√°s al usuario.\n\n\n\n\nReglas\n‚ùå No inventes horarios, m√©dicos ni especialidades.\n‚ùå No confirmes turnos vos mismo.\n‚ùå No busques horarios sin tener m√©dico Y especialidad claros.\n‚úÖ Si no hay disponibilidad ‚Üí ofrec√© 2 fechas alternativas o indic√° llamar al 221 4906310 o usar iclp.com.ar.\n‚úÖ Si el paciente escribe algo ambiguo (\"cuando haya\", \"por la tarde\"), busc√° la franja m√°s pr√≥xima v√°lida.\n‚úÖ Formato interno: yyyyMMdd para fecha y HHmm para hora (nunca los muestres al paciente).\n‚úÖ Formato al paciente: DD/MM/YYYY ‚Äì HH:MM\n‚úÖ Us√° la matr√≠cula exacta del JSON de obtenerMedicos (puede haber m√©dicos con la misma matr√≠cula en distintas especialidades).\n\n\n\nüìã Respond√© con el n√∫mero o nombre de la especialidad.\nEjemplo 2: Usuario elige especialidad\nPaciente: \"2\" o \"Cirugia Cardiovascular\"\nBot filtra m√©dicos y responde:\nProfesionales disponibles en Cirugia Cardiovascular:\n\n1) Dr. Luciano Honaine\n2) Dr. Claudio Maina\n\nüìã Respond√© con el n√∫mero o nombre del profesional que prefieras.\nEjemplo 3: Usuario elige m√©dico\nPaciente: \"1\" o \"Honaine\"\nBot ejecuta: horarios_medicos_disponibles (con matr√≠cula 114788)\nBot responde:\n‚úÖ Encontr√© turnos disponibles con el Dr. Luciano Honaine:\n\n1) 02/10/2025 ‚Äì 09:00  \n2) 02/10/2025 ‚Äì 10:30  \n3) 03/10/2025 ‚Äì 14:00  \n\nüìÖ Respond√© con el n√∫mero de opci√≥n que prefieras para confirmar tu turno.\nEjemplo 4: Usuario confirma turno\nPaciente: \"La 2\"\nBot ejecuta internamente:\nxml<FECHA_CONFIRMAR>20251002</FECHA_CONFIRMAR>\n<HORA_CONFIRMAR>1030</HORA_CONFIRMAR>\n<MATRICULA_MEDICO>114788</MATRICULA_MEDICO>\n<NOMBRE_MEDICO>Dr. Luciano Honaine</NOMBRE_MEDICO>\n<CONFIRMAR>\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[5824,2048],"id":"720782c0-6fa4-4221-bfc4-820bcdcd4ee8","name":"CONSULTAR DISPONIBLIDAD1","disabled":true},{"parameters":{"promptType":"define","text":"=ANALIZA LA MEMORIA PARA TENER CONTEXTO: {{ $('When chat message received').item.json.chatInput }}","options":{"systemMessage":"=FECHA DISPONIBLE\nHOY ES : {{ $now.format('DDDD') }} {{ $now.format('t') }}\n\nRol: Coordinador de Empadronamiento ‚Äì Instituto de Cardiolog√≠a La Plata (ICLP)\n\nTu tarea es verificar o registrar al paciente en nuestro padr√≥n de forma amable y profesional, asegurando que toda su informaci√≥n est√© correctamente cargada en el sistema.\n\nContexto:\nSos parte del equipo del Instituto de Cardiolog√≠a La Plata, un centro con m√°s de 20 a√±os cuidando la salud cardiovascular. Tu rol es fundamental para garantizar que cada paciente tenga una experiencia fluida desde el primer contacto.\n\nFlujo de Empadronamiento:\n\n1. Verificaci√≥n de datos completos:\nAntes de empadronar, asegurate de tener:\n‚úÖ DNI (7-9 d√≠gitos)\n‚úÖ Nombre completo\n‚úÖ Obra social\n\nSi falta la obra social, pedila de forma amable:\nEjemplo: \"Para poder registrarte correctamente en nuestro sistema, necesito que me indiques tu obra social, por favor.\"\nEjecut√° OBRA_SOCIAL_SET cuando la recibas.\n\n2. Proceso de empadronamiento:\nEjecut√° flujo_padron con los datos: DNI, nombre, obra social (y celular/texto si est√°n disponibles).\n\n3. Respuesta seg√∫n resultado:\n\n‚úÖ Si el empadronamiento es EXITOSO (empadronado: true):\nConfirm√° con un mensaje c√°lido y natural que invite a continuar.\n\nFORMATO OBLIGATORIO DE RESPUESTA EXITOSA:\nDebes responder EXACTAMENTE con este formato (elige una opci√≥n y agrega | exito al final):\n\n\"¬°Perfecto, [Nombre]! ¬øTe gustar√≠a que te ayude a coordinar un turno para una consulta o estudio? | exito\"\n\nO:\n\n\"¬°Listo! ¬øQuer√©s sacar un turno? | exito\"\n\nO:\n\n\"Excelente, [Nombre]. Ya est√°s registrado/a en el Instituto. ¬øNecesit√°s agendar alguna consulta o estudio? | exito\"\n\n‚ùå Si hay ERROR en el empadronamiento:\n\nFORMATO OBLIGATORIO DE RESPUESTA CON ERROR:\nDebes responder EXACTAMENTE terminando con | error\n\nEjemplos:\n\"Parece que hubo un inconveniente al registrar tu informaci√≥n. ¬øPodr√≠as confirmarme nuevamente tu DNI, nombre completo y obra social para intentarlo otra vez? | error\"\n\nO:\n\n\"El sistema indica que [descripci√≥n del error]. ¬øPodr√≠as verificar que los datos sean correctos? | error\"\n\n‚ö†Ô∏è REGLA CR√çTICA DE FORMATO:\nTODAS tus respuestas despu√©s de ejecutar flujo_padron DEBEN terminar con \" | exito\" o \" | error\" (con un espacio antes del pipe).\nNO omitas este sufijo bajo ninguna circunstancia.\n\nReglas de comunicaci√≥n:\n- Tono: Profesional, c√°lido y orientado a la acci√≥n\n- Claridad: Explic√° brevemente qu√© est√°s haciendo\n- Proactividad: Siempre ofrec√© el siguiente paso despu√©s de empadronar exitosamente\n- No confirmes turnos en esta fase, solo invit√° a coordinarlos\n\nReglas cr√≠ticas:\n- Despu√©s de empadronar exitosamente, SIEMPRE invit√° al paciente a continuar con la gesti√≥n de turnos\n- SIEMPRE termina tu respuesta con \" | exito\" o \" | error\"\n- No uses formatos internos (yyyyMMdd, HHmm) con el paciente\n- Manten√© un tono emp√°tico, especialmente si hay errores en el sistema\n\nTools disponibles:\n- OBRA_SOCIAL_SET (si falta obra social)\n- flujo_padron (dni, paciente, obraSocial, celular, texto)"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[5808,2288],"id":"591b8070-5176-472c-a4a3-7a4b20ad045c","name":"EMPADRONAR_CITA1","disabled":true},{"parameters":{"assignments":{"assignments":[{"id":"16d8fd1f-7293-45ec-ba41-6041979d7964","name":"accountId","value":"={{ $json.body.messages[0].account_id }}","type":"number"},{"id":"a8eb17ea-8fda-42e5-9f1c-444826a21e51","name":"message","value":"={{ $json.body.messages[0].content }}","type":"string"},{"id":"3fe92852-b569-426e-bef7-b755cf44ddc9","name":"inboxId","value":"={{ $json.body.contact_inbox.inbox_id }}","type":"number"},{"id":"96fa0ac2-a17b-452c-bf67-cc0f3bd5d4a2","name":"contactId","value":"={{ $json.body.messages[0].sender.id }}","type":"number"},{"id":"0d77d8b4-ec6d-42e0-8a5b-fdf1b78b454d","name":"contactName","value":"={{ $json.body.messages[0].sender.name }}","type":"string"},{"id":"25487cfb-897d-4000-9ad6-99745966c526","name":"contactNumber","value":"={{ $json.body.messages[0].sender.phone_number }}","type":"string"},{"id":"1e1b0044-b199-44e0-927b-c2cabe2a281b","name":"agentId","value":"=","type":"number"},{"id":"ad5ef314-70d7-4790-b82e-ea96a340ae12","name":"agentName","value":"=","type":"string"},{"id":"f4bc6964-862e-4168-8bae-94e6c6ad8321","name":"eventType","value":"={{ $json.body.event }}","type":"string"},{"id":"ef4c85e4-0029-4d70-ade1-0de74711b804","name":"conversationId","value":"={{ $json.body.id }}","type":"number"},{"id":"be91191b-7e8a-4406-af97-0a18e8100e7f","name":"multimedia","value":"={{ $json?.body?.messages?.[0]?.attachments?.[0]?.file_type ? true : false }}","type":"boolean"},{"id":"a3202993-c215-4502-bf56-e7e644b35a88","name":"humano","value":"={{ $json.body.custom_attributes.humano }}","type":"boolean"},{"id":"3da45859-4092-4b0c-bba3-c8898b649491","name":"messagesId","value":"={{ $json.body.messages[0].id }}","type":"number"},{"id":"24592e90-360f-4a9c-8271-1119ba300be1","name":"timestamp","value":"={{ $json.body.timestamp }}","type":"number"},{"id":"e01eb0b6-2e60-4ade-a4ba-949e30df02a5","name":"multimediaUrl","value":"={{ $json.body.messages[0].attachments[0].data_url }}","type":"string"},{"id":"1225af59-1b61-42dc-8052-296978708c1a","name":"agenteBotTokenWhatsapp","value":"MMPtfQJpJNaMoq1P5somrYqA","type":"string"},{"id":"2e74ddde-5f26-4b0c-a6dc-32eb8e83874f","name":"chatwootUrl","value":"https://chatw.automatizaciones.ai","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[832,2160],"id":"1a6e4fbf-682e-4e08-bc1a-e133b1d38e22","name":"variables"},{"parameters":{"httpMethod":"POST","path":"0986","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[416,2160],"id":"78dfe7d3-b4d0-48df-879f-f8a9c60e9eb5","name":"Webhook","webhookId":"c051b701-b177-483f-b4a1-1c9af942e52b"},{"parameters":{"method":"POST","url":"=https://chatw.automatizaciones.ai/api/v1/accounts/{{ $('variables').item.json.accountId }}/conversations/{{ $('variables').item.json.conversationId }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('variables').item.json.agenteBotTokenWhatsapp }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"content","value":"={{ $json.output }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[4336,1264],"id":"a92d399f-1d44-4262-869d-bc7dcf17415f","name":"SendText"},{"parameters":{"httpMethod":"POST","path":"7684a347-c0eb-4040-8d15-16202dc265e7","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[432,2400],"id":"4c14e903-465f-4bd0-85db-698c83165e37","name":"Webhook1","webhookId":"7684a347-c0eb-4040-8d15-16202dc265e7"},{"parameters":{"method":"POST","url":"https://flows.autoclinicas.com/webhook-test/0986","sendBody":true,"contentType":"raw","rawContentType":"application/json","body":"={{$json.body}}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[832,2400],"id":"2c79ea29-ce2a-482b-9c84-6fa5fd9936cb","name":"HTTP Request"},{"parameters":{"operation":"get","propertyName":"FASE","key":"=iclp:chat:7020:fase","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1200,2336],"id":"18470ded-6a9e-41a0-b3a5-241b7ed7de0c","name":"Redis4","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"assignments":{"assignments":[{"id":"e061c640-4e1a-495d-8514-3de58025e655","name":"output","value":"={{ $('EMPADRONAR_CITA').item.json.output }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[4080,2288],"id":"cc8a4516-e8ec-4ef9-b932-001582eb24bf","name":"response_false"},{"parameters":{"assignments":{"assignments":[{"id":"e3a91ba8-82f5-4053-a250-26ae481f0680","name":"cleanedOutput","value":"={{ $json.cleanedOutput }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[4080,2112],"id":"dbc36edf-1c02-4241-8a9a-9aa35d54f65a","name":"response_true"},{"parameters":{"jsCode":"// Obtiene todos los items que llegan al nodo\nconst items = $input.all();\n\n// Itera sobre cada item (aunque usualmente ser√° solo uno)\nfor (const item of items) {\n  // 1. Obtiene la salida completa del agente (ej: \"Mensaje | exitoso\")\n  const agentOutput = item.json.output;\n\n  // 2. Verifica que la salida no est√© vac√≠a antes de procesar\n  if (agentOutput && typeof agentOutput === 'string') {\n    // 3. Divide el texto por el car√°cter '|' y toma la primera parte [0]\n    //    .trim() elimina espacios en blanco al principio y al final.\n    const cleanedMessage = agentOutput.split('|')[0].trim();\n    \n    // 4. Crea un nuevo campo en el JSON con el mensaje limpio\n    item.json.cleanedOutput = cleanedMessage;\n  } else {\n    // Si no hay salida o no es un texto, deja el campo vac√≠o o usa el original\n    item.json.cleanedOutput = agentOutput;\n  }\n}\n\n// Devuelve el item modificado, ahora con el nuevo campo 'cleanedOutput'\nreturn items;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3856,2176],"id":"0be77751-85fb-4668-a81d-2e058fcce121","name":"formatea_output"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2c5f8506-5a2e-4511-a196-837d4f575060","leftValue":"={{ $json.output.split('|')[1].trim() }}","rightValue":"exitoso","operator":{"type":"string","operation":"contains"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[3680,2688],"id":"419c637e-dc5f-4bf6-a787-55b0cd0ec0ad","name":"If2"},{"parameters":{"operation":"set","key":"=iclp:chat:{{ $('Edit Fields').item.json.sessionId }}:fase","value":"CONFIRMAR"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3888,2768],"id":"2aeb5972-4211-4f8d-a3d4-f6ecfddc7b25","name":"Redis5","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"assignments":{"assignments":[{"id":"e061c640-4e1a-495d-8514-3de58025e655","name":"output","value":"={{ $('CONSULTAR DISPONIBLIDAD').item.json.output }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[4112,2704],"id":"171c17a9-1f32-4221-be10-8e3b6ac9280a","name":"response_false1"},{"parameters":{"jsCode":"// Obtiene todos los items que llegan al nodo\nconst items = $input.all();\n\n// Itera sobre cada item (aunque usualmente ser√° solo uno)\nfor (const item of items) {\n  // 1. Obtiene la salida completa del agente (ej: \"Mensaje | exitoso\")\n  const agentOutput = item.json.output;\n\n  // 2. Verifica que la salida no est√© vac√≠a antes de procesar\n  if (agentOutput && typeof agentOutput === 'string') {\n    // 3. Divide el texto por el car√°cter '|' y toma la primera parte [0]\n    //    .trim() elimina espacios en blanco al principio y al final.\n    const cleanedMessage = agentOutput.split('|')[0].trim();\n    \n    // 4. Crea un nuevo campo en el JSON con el mensaje limpio\n    item.json.cleanedOutput = cleanedMessage;\n  } else {\n    // Si no hay salida o no es un texto, deja el campo vac√≠o o usa el original\n    item.json.cleanedOutput = agentOutput;\n  }\n}\n\n// Devuelve el item modificado, ahora con el nuevo campo 'cleanedOutput'\nreturn items;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3888,2592],"id":"00f9b75c-739f-4b6f-93df-93d69469be52","name":"formatea_output1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2c5f8506-5a2e-4511-a196-837d4f575060","leftValue":"={{ $json.output.split('|')[1].trim() }}","rightValue":"exitoso","operator":{"type":"string","operation":"contains"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[3728,3120],"id":"1f0b203f-6ec1-4557-a08b-45bf3faee6d8","name":"If3"},{"parameters":{"operation":"set","key":"=iclp:chat:{{ $('Edit Fields').item.json.sessionId }}:fase","value":"CANCELAR"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3936,3200],"id":"f5349a82-5932-4d94-8eff-c2f766998ff7","name":"Redis6","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"assignments":{"assignments":[{"id":"e061c640-4e1a-495d-8514-3de58025e655","name":"output","value":"={{ $('CANCELAR_CITA').item.json.output }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[4160,3136],"id":"f25c97ee-e4cf-4cb1-bbf7-d978b926e620","name":"response_false2"},{"parameters":{"jsCode":"// Obtiene todos los items que llegan al nodo\nconst items = $input.all();\n\n// Itera sobre cada item (aunque usualmente ser√° solo uno)\nfor (const item of items) {\n  // 1. Obtiene la salida completa del agente (ej: \"Mensaje | exitoso\")\n  const agentOutput = item.json.output;\n\n  // 2. Verifica que la salida no est√© vac√≠a antes de procesar\n  if (agentOutput && typeof agentOutput === 'string') {\n    // 3. Divide el texto por el car√°cter '|' y toma la primera parte [0]\n    //    .trim() elimina espacios en blanco al principio y al final.\n    const cleanedMessage = agentOutput.split('|')[0].trim();\n    \n    // 4. Crea un nuevo campo en el JSON con el mensaje limpio\n    item.json.cleanedOutput = cleanedMessage;\n  } else {\n    // Si no hay salida o no es un texto, deja el campo vac√≠o o usa el original\n    item.json.cleanedOutput = agentOutput;\n  }\n}\n\n// Devuelve el item modificado, ahora con el nuevo campo 'cleanedOutput'\nreturn items;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3936,3024],"id":"fa79096c-8148-45db-91f7-db3fe6bd322a","name":"formatea_output2"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2c5f8506-5a2e-4511-a196-837d4f575060","leftValue":"={{ $json.output.split('|')[1].trim() }}","rightValue":"exitoso","operator":{"type":"string","operation":"contains"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[3760,3568],"id":"ab665b04-8360-4250-ade1-89be120aae8f","name":"If4"},{"parameters":{"operation":"set","key":"=iclp:chat:{{ $('Edit Fields').item.json.sessionId }}:fase","value":"CANCELAR"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3968,3648],"id":"0d7d9009-9c04-4b1a-86ae-16c91ca7cb75","name":"Redis7","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"// Obtiene todos los items que llegan al nodo\nconst items = $input.all();\n\n// Itera sobre cada item (aunque usualmente ser√° solo uno)\nfor (const item of items) {\n  // 1. Obtiene la salida completa del agente (ej: \"Mensaje | exitoso\")\n  const agentOutput = item.json.output;\n\n  // 2. Verifica que la salida no est√© vac√≠a antes de procesar\n  if (agentOutput && typeof agentOutput === 'string') {\n    // 3. Divide el texto por el car√°cter '|' y toma la primera parte [0]\n    //    .trim() elimina espacios en blanco al principio y al final.\n    const cleanedMessage = agentOutput.split('|')[0].trim();\n    \n    // 4. Crea un nuevo campo en el JSON con el mensaje limpio\n    item.json.cleanedOutput = cleanedMessage;\n  } else {\n    // Si no hay salida o no es un texto, deja el campo vac√≠o o usa el original\n    item.json.cleanedOutput = agentOutput;\n  }\n}\n\n// Devuelve el item modificado, ahora con el nuevo campo 'cleanedOutput'\nreturn items;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3968,3472],"id":"3d40c2b3-203b-4da2-a57b-cad65fabc280","name":"formatea_output3"},{"parameters":{"assignments":{"assignments":[{"id":"e061c640-4e1a-495d-8514-3de58025e655","name":"output","value":"={{ $('CONFIRMAR CITA').item.json.output }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[4208,3584],"id":"19effbc5-2c7b-433e-ab81-728760386e36","name":"response_false3"},{"parameters":{"promptType":"define","text":"=ANALIZA LA MEMORIA PARA TENER CONTEXTO: {{ $('variables').item.json.message }}","options":{"systemMessage":"=**Fecha actual:** {{ $now.format('DDDD') }} {{ $now.format('t') }}\n\n---\n\n## üéØ MISI√ìN PRINCIPAL\nTu √∫nica misi√≥n es ayudar al paciente a identificar y cancelar un turno activo de forma segura y verificada. Debes guiarlo para que seleccione un turno de una lista y solo confirmar la cancelaci√≥n despu√©s de que la herramienta correspondiente te devuelva un resultado exitoso.\n\n---\n\n## üö® REGLAS INQUEBRABLES\n\n1.  **FORMATO DE SALIDA:** Tu regla m√°s importante. TODA respuesta final que env√≠es al usuario DEBE terminar con ` | status`. Usa `exitoso` para cancelaciones confirmadas y `error` para cualquier otro caso.\n2.  **LISTAS NUMERADAS:** Para evitar errores, SIEMPRE que muestres los turnos del paciente, hazlo en una lista numerada y pedile que responda con el n√∫mero de la opci√≥n.\n3.  **VERIFICACI√ìN ABSOLUTA:** NUNCA confirmes una cancelaci√≥n sin antes haber ejecutado la herramienta `eliminar_turno` y haber recibido la respuesta exacta `\"OK\"`. Tu credibilidad depende de esto.\n4.  **FOCO √öNICO:** No ofrezcas agendar nuevos turnos ni respondas a otras consultas. Si el paciente lo pide, ind√≠cale amablemente que inicie una nueva conversaci√≥n para esa gesti√≥n.\n5.  **HERRAMIENTA PRIMERO:** Siempre ejecuta `lista_turnos` ANTES de mostrarle cualquier opci√≥n al paciente. No asumas ni inventes turnos.\n\n---\n\n## ‚öôÔ∏è FLUJO DE TRABAJO ESTRICTO\n\n### ### ETAPA 1: B√öSQUEDA DE TURNOS\n\n* **An√°lisis:** Revisa si ya conoces el DNI del paciente.\n    * **Si NO tienes el DNI:** P√≠delo de forma directa.\n        * **Respuesta:** `\"Para poder buscar tus turnos y cancelarlos, necesito tu n√∫mero de DNI, por favor. | error\"`\n        * **DETENTE AQU√ç.** Espera la respuesta.\n    * **Si S√ç tienes el DNI:**\n        * **Acci√≥n:** Ejecuta la herramienta `lista_turnos` con el DNI del paciente.\n        * **An√°lisis del Resultado:**\n            * Si la herramienta devuelve una lista con uno o m√°s turnos, avanza a la **ETAPA 2**.\n            * Si la herramienta devuelve una lista vac√≠a `[]` o un error:\n                * **Respuesta:** `\"No encontr√© turnos activos registrados con ese DNI. Si crees que se trata de un error, te recomiendo llamar al (0221) 490-6310. | error\"`\n                * **FIN DEL FLUJO.**\n\n---\n\n### ### ETAPA 2: SELECCI√ìN DE TURNO A CANCELAR\n\n* **An√°lisis:** La herramienta `lista_turnos` te ha devuelto los turnos activos del paciente.\n* **Respuesta:** Muestra los turnos en una lista clara y numerada.\n    `\"Encontr√© estos turnos activos a tu nombre. Por favor, respond√© con el n√∫mero del turno que quer√©s cancelar:\\n\\n1. üìÖ 08/10/2025 a las 09:45 con Dr. Ponce Vena Leonel\\n2. üìÖ 15/10/2025 a las 14:30 con Dra. Roldan Miriam\\n- [lista todos los dem√°s]\\n\\nüìã Respond√© solo con el n√∫mero de la opci√≥n (ej: 1).\"`\n* **DETENTE AQU√ç.** Espera a que el usuario elija un n√∫mero.\n\n---\n\n### ### ETAPA 3: EJECUCI√ìN Y CONFIRMACI√ìN FINAL\n\n* **An√°lisis:** El usuario ha respondido con un n√∫mero. Identifica a qu√© turno corresponde en la lista que mostraste y extrae sus datos t√©cnicos (`matricula`, `fecha` en `yyyyMMdd`, `hora` en `HHmm`).\n* **Acci√≥n:** Ejecuta la herramienta `eliminar_turno` con los datos del turno seleccionado.\n* **Respuesta (basada en el resultado de la herramienta):**\n    * **Si el resultado es `\"OK\"`:**\n        `\"‚úÖ ¬°Listo! Tu turno con el/la Dr./Dra. [Nombre M√©dico] del d√≠a [Fecha legible] a las [Hora legible] fue cancelado correctamente. ¬øNecesit√°s algo m√°s? | exitoso\"`\n    * **Si el resultado es `\"Turno inexistente\"` o `\"El turno ya fue cancelado\"`:**\n        `\"El turno que seleccionaste ya no se encuentra activo. Es posible que haya sido cancelado previamente. Si necesit√°s, podemos volver a revisar tus turnos activos. | error\"`\n    * **Si el resultado es `\"Problema\"` o cualquier otro error:**\n        `\"Hubo un problema t√©cnico al intentar procesar la cancelaci√≥n. Por favor, intent√° nuevamente en unos minutos o llam√° al (0221) 490-6310 para recibir asistencia. | error\"`\n\n---\n\n## üõ†Ô∏è CAJA DE HERRAMIENTAS (TOOLS)\n-   **`lista_turnos`**: Busca y devuelve todos los turnos activos de un paciente a partir de su DNI.\n-   **`eliminar_turno`**: Env√≠a la solicitud para cancelar un turno espec√≠fico. Devuelve el estado de la operaci√≥n."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[2384,2864],"id":"a2431219-9553-493b-aafa-de05d42db85a","name":"CANCELAR CITA"},{"parameters":{"assignments":{"assignments":[{"id":"e3a91ba8-82f5-4053-a250-26ae481f0680","name":"cleanedOutput","value":"={{ $json.cleanedOutput }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[4112,2544],"id":"2d3b89be-c34a-428b-b8a9-afd0347b9fa1","name":"response_true4"},{"parameters":{"assignments":{"assignments":[{"id":"e3a91ba8-82f5-4053-a250-26ae481f0680","name":"cleanedOutput","value":"={{ $json.cleanedOutput }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[4160,2976],"id":"9eb8a5be-d9d6-486f-97dc-9f441562172e","name":"response_true1"},{"parameters":{"assignments":{"assignments":[{"id":"e3a91ba8-82f5-4053-a250-26ae481f0680","name":"cleanedOutput","value":"={{ $json.cleanedOutput }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[4208,3424],"id":"97be0109-f287-4013-82b2-f6ae54a97711","name":"response_true2"}],"connections":{"Redis Chat Memory":{"ai_memory":[[{"node":"RECEPCIONISTA","type":"ai_memory","index":0},{"node":"CANCELAR CITA","type":"ai_memory","index":0},{"node":"CONSULTAR DISPONIBLIDAD","type":"ai_memory","index":0},{"node":"CONFIRMAR CITA","type":"ai_memory","index":0},{"node":"EMPADRONAR_CITA","type":"ai_memory","index":0}]]},"RECEPCIONISTA":{"main":[[{"node":"Redis2","type":"main","index":0}]]},"Redis":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"Switch":{"main":[[{"node":"RECEPCIONISTA","type":"main","index":0}],[{"node":"EMPADRONAR_CITA","type":"main","index":0}],[{"node":"CONSULTAR DISPONIBLIDAD","type":"main","index":0}],[{"node":"CANCELAR CITA","type":"main","index":0}],[{"node":"CONFIRMAR CITA","type":"main","index":0}]]},"eliminar_turno":{"ai_tool":[[{"node":"CANCELAR CITA","type":"ai_tool","index":0}]]},"lista_turnos":{"ai_tool":[[{"node":"CANCELAR CITA","type":"ai_tool","index":0}]]},"tomar_turno":{"ai_tool":[[{"node":"CONFIRMAR CITA","type":"ai_tool","index":0}]]},"horarios_medicos_disponibles":{"ai_tool":[[{"node":"CONSULTAR DISPONIBLIDAD","type":"ai_tool","index":0}]]},"horarios_especialidad_disponibles":{"ai_tool":[[{"node":"CONSULTAR DISPONIBLIDAD","type":"ai_tool","index":0}]]},"flujo_padron":{"ai_tool":[[{"node":"EMPADRONAR_CITA","type":"ai_tool","index":0}]]},"ESPECIALIDAD":{"ai_tool":[[{"node":"CONSULTAR DISPONIBLIDAD","type":"ai_tool","index":0},{"node":"RECEPCIONISTA","type":"ai_tool","index":0}]]},"MATRICULA_MEDICO":{"ai_tool":[[{"node":"RECEPCIONISTA","type":"ai_tool","index":0},{"node":"CANCELAR CITA","type":"ai_tool","index":0},{"node":"CONSULTAR DISPONIBLIDAD","type":"ai_tool","index":0}]]},"NOMBRE_MEDICO":{"ai_tool":[[{"node":"CONSULTAR DISPONIBLIDAD","type":"ai_tool","index":0},{"node":"RECEPCIONISTA","type":"ai_tool","index":0}]]},"DNI_PACIENTE":{"ai_tool":[[{"node":"RECEPCIONISTA","type":"ai_tool","index":0},{"node":"CANCELAR CITA","type":"ai_tool","index":0},{"node":"EMPADRONAR_CITA","type":"ai_tool","index":0}]]},"Redis2":{"main":[[{"node":"Switch1","type":"main","index":0}]]},"NOMBRE_PACIENTE":{"ai_tool":[[{"node":"RECEPCIONISTA","type":"ai_tool","index":0}]]},"DISPONIBILIDAD":{"ai_tool":[[{"node":"RECEPCIONISTA","type":"ai_tool","index":0},{"node":"EMPADRONAR_CITA","type":"ai_tool","index":0}]]},"CONFIRMAR":{"ai_tool":[[{"node":"CONSULTAR DISPONIBLIDAD","type":"ai_tool","index":0}]]},"OBRA SOCIAL":{"ai_tool":[[{"node":"EMPADRONAR_CITA","type":"ai_tool","index":0},{"node":"RECEPCIONISTA","type":"ai_tool","index":0}]]},"OpenRouter Chat Model":{"ai_languageModel":[[{"node":"RECEPCIONISTA","type":"ai_languageModel","index":0},{"node":"EMPADRONAR_CITA","type":"ai_languageModel","index":0},{"node":"CANCELAR CITA","type":"ai_languageModel","index":0},{"node":"CONFIRMAR CITA","type":"ai_languageModel","index":0},{"node":"CONSULTAR DISPONIBLIDAD","type":"ai_languageModel","index":0}]]},"FECHA_CONFIRMAR":{"ai_tool":[[{"node":"CONSULTAR DISPONIBLIDAD","type":"ai_tool","index":0},{"node":"CANCELAR CITA","type":"ai_tool","index":0},{"node":"RECEPCIONISTA","type":"ai_tool","index":0}]]},"HORA_CONFIRMAR":{"ai_tool":[[{"node":"CONSULTAR DISPONIBLIDAD","type":"ai_tool","index":0},{"node":"CANCELAR CITA","type":"ai_tool","index":0},{"node":"RECEPCIONISTA","type":"ai_tool","index":0}]]},"CANCELAR":{"ai_tool":[[{"node":"RECEPCIONISTA","type":"ai_tool","index":0}]]},"EMPADRONAR":{"ai_tool":[[{"node":"RECEPCIONISTA","type":"ai_tool","index":0}]]},"CONFIRMAR CITA":{"main":[[{"node":"Redis7","type":"main","index":0}]]},"Switch1":{"main":[[{"node":"response","type":"main","index":0}],[{"node":"Redis","type":"main","index":0}],[{"node":"Redis","type":"main","index":0}],[{"node":"Redis","type":"main","index":0}],[{"node":"Redis","type":"main","index":0}],[]]},"EMPADRONAR_CITA":{"main":[[{"node":"Redis1","type":"main","index":0}]]},"CONSULTAR DISPONIBLIDAD":{"main":[[{"node":"Redis5","type":"main","index":0}]]},"obtenerMedicos":{"ai_tool":[[{"node":"CONSULTAR DISPONIBLIDAD","type":"ai_tool","index":0},{"node":"RECEPCIONISTA","type":"ai_tool","index":0}]]},"Edit Fields":{"main":[[{"node":"Switch","type":"main","index":0}]]},"If":{"main":[[{"node":"formatea_output","type":"main","index":0}],[{"node":"response_false","type":"main","index":0}]]},"obtenerEspecialidades":{"ai_tool":[[{"node":"CONSULTAR DISPONIBLIDAD","type":"ai_tool","index":0}]]},"Redis1":{"main":[[{"node":"If","type":"main","index":0}]]},"MATRICULA_MEDICO1":{"ai_tool":[[]]},"Webhook":{"main":[[{"node":"variables","type":"main","index":0}]]},"response":{"main":[[{"node":"SendText","type":"main","index":0}]]},"variables":{"main":[[{"node":"Redis","type":"main","index":0}]]},"Webhook1":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]},"formatea_output":{"main":[[{"node":"response_true","type":"main","index":0}]]},"If2":{"main":[[{"node":"formatea_output1","type":"main","index":0}],[{"node":"response_false1","type":"main","index":0}]]},"Redis5":{"main":[[{"node":"If2","type":"main","index":0}]]},"formatea_output1":{"main":[[{"node":"response_true4","type":"main","index":0}]]},"If3":{"main":[[{"node":"formatea_output2","type":"main","index":0}],[{"node":"response_false2","type":"main","index":0}]]},"Redis6":{"main":[[{"node":"If3","type":"main","index":0}]]},"formatea_output2":{"main":[[{"node":"response_true1","type":"main","index":0}]]},"If4":{"main":[[{"node":"formatea_output3","type":"main","index":0}],[{"node":"response_false3","type":"main","index":0}]]},"Redis7":{"main":[[{"node":"If4","type":"main","index":0}]]},"formatea_output3":{"main":[[{"node":"response_true2","type":"main","index":0}]]},"response_true":{"main":[[]]},"response_false":{"main":[[]]},"response_false1":{"main":[[]]},"response_false2":{"main":[[]]},"response_false3":{"main":[[]]},"CANCELAR CITA":{"main":[[{"node":"If3","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Webhook1":[{"json":{"headers":{"host":"hooks.autoclinicas.com","user-agent":"rest-client/2.1.0 (linux-musl x86_64) ruby/3.4.4p34","content-length":"1905","accept":"application/json","accept-encoding":"gzip;q=1.0,deflate;q=0.6,identity;q=0.3","content-type":"application/json","x-forwarded-for":"206.81.1.93","x-forwarded-host":"hooks.autoclinicas.com","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"f2c799d0c305","x-real-ip":"206.81.1.93"},"params":{},"query":{},"body":{"additional_attributes":{},"can_reply":true,"channel":"Channel::Api","contact_inbox":{"id":11579,"contact_id":5992,"inbox_id":14,"source_id":"3a8d5729-bc87-4b2a-8a20-624462a7eac3","created_at":"2025-10-04T19:51:02.374Z","updated_at":"2025-10-04T19:51:02.374Z","hmac_verified":false,"pubsub_token":"s2emiM5HzPtQG8Zvk4UnjSAm"},"id":7029,"inbox_id":14,"messages":[{"id":88943,"content":"Nicolas lopez 42028075 sancor","account_id":2,"inbox_id":14,"conversation_id":7029,"message_type":0,"created_at":1759607485,"updated_at":"2025-10-04T19:51:25.822Z","private":false,"status":"sent","source_id":"WAID:3B700CB5E780B1032E0B","content_type":"text","content_attributes":{},"sender_type":"Contact","sender_id":5992,"external_source_ids":{},"additional_attributes":{},"processed_message_content":"Nicolas lopez 42028075 sancor","sentiment":{},"conversation":{"assignee_id":null,"unread_count":2,"last_activity_at":1759607485,"contact_inbox":{"source_id":"3a8d5729-bc87-4b2a-8a20-624462a7eac3"}},"sender":{"additional_attributes":{},"custom_attributes":{},"email":null,"id":5992,"identifier":"5492213994411@s.whatsapp.net","name":"Nm","phone_number":"+5492213994411","thumbnail":"","blocked":false,"type":"contact"}}],"labels":[],"meta":{"sender":{"additional_attributes":{},"custom_attributes":{},"email":null,"id":5992,"identifier":"5492213994411@s.whatsapp.net","name":"Nm","phone_number":"+5492213994411","thumbnail":"","blocked":false,"type":"contact"},"assignee":null,"team":null,"hmac_verified":false},"status":"open","custom_attributes":{},"snoozed_until":null,"unread_count":2,"first_reply_created_at":null,"priority":null,"waiting_since":1759607462,"agent_last_seen_at":0,"contact_last_seen_at":0,"last_activity_at":1759607485,"timestamp":1759607485,"created_at":1759607462,"updated_at":1759607485.825669,"applied_sla":null,"sla_events":[],"sla_policy_id":null,"event":"automation_event.message_created"},"webhookUrl":"https://hooks.autoclinicas.com/webhook/7684a347-c0eb-4040-8d15-16202dc265e7","executionMode":"production"}}],"Webhook":[{"json":{"headers":{"host":"flows.autoclinicas.com","user-agent":"axios/1.8.3","content-length":"1906","accept":"application/json,text/html,application/xhtml+xml,application/xml,text/*;q=0.9, image/*;q=0.8, */*;q=0.7","accept-encoding":"gzip, compress, deflate, br","content-type":"application/json","x-forwarded-for":"172.18.0.1","x-forwarded-host":"flows.autoclinicas.com","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"f2c799d0c305","x-real-ip":"172.18.0.1"},"params":{},"query":{},"body":{"additional_attributes":{},"can_reply":true,"channel":"Channel::Api","contact_inbox":{"id":11579,"contact_id":5992,"inbox_id":14,"source_id":"3a8d5729-bc87-4b2a-8a20-624462a7eac3","created_at":"2025-10-04T19:51:02.374Z","updated_at":"2025-10-04T19:51:02.374Z","hmac_verified":false,"pubsub_token":"s2emiM5HzPtQG8Zvk4UnjSAm"},"id":7029,"inbox_id":14,"messages":[{"id":88944,"content":"Nicolas lopez 42028075 sancor","account_id":2,"inbox_id":14,"conversation_id":7029,"message_type":0,"created_at":1759607564,"updated_at":"2025-10-04T19:52:44.024Z","private":false,"status":"sent","source_id":"WAID:3B302031F78E0E75EC26","content_type":"text","content_attributes":{},"sender_type":"Contact","sender_id":5992,"external_source_ids":{},"additional_attributes":{},"processed_message_content":"Nicolas lopez 42028075 sancor","sentiment":{},"conversation":{"assignee_id":null,"unread_count":3,"last_activity_at":1759607564,"contact_inbox":{"source_id":"3a8d5729-bc87-4b2a-8a20-624462a7eac3"}},"sender":{"additional_attributes":{},"custom_attributes":{},"email":null,"id":5992,"identifier":"5492213994411@s.whatsapp.net","name":"Nm","phone_number":"+5492213994411","thumbnail":"","blocked":false,"type":"contact"}}],"labels":[],"meta":{"sender":{"additional_attributes":{},"custom_attributes":{},"email":null,"id":5992,"identifier":"5492213994411@s.whatsapp.net","name":"Nm","phone_number":"+5492213994411","thumbnail":"","blocked":false,"type":"contact"},"assignee":null,"team":null,"hmac_verified":false},"status":"open","custom_attributes":{},"snoozed_until":null,"unread_count":3,"first_reply_created_at":null,"priority":null,"waiting_since":1759607462,"agent_last_seen_at":0,"contact_last_seen_at":0,"last_activity_at":1759607564,"timestamp":1759607564,"created_at":1759607462,"updated_at":1759607564.0297952,"applied_sla":null,"sla_events":[],"sla_policy_id":null,"event":"automation_event.message_created"},"webhookUrl":"https://hooks.autoclinicas.com/webhook-test/0986","executionMode":"test"}}]},"versionId":"99d9eab5-1580-40eb-a7ab-55036098422c","triggerCount":2,"shared":[{"createdAt":"2025-09-27T17:54:11.752Z","updatedAt":"2025-09-27T17:54:11.752Z","role":"workflow:owner","workflowId":"kk705kt5AIaWLfjK","projectId":"R66ikVn5xqf0nYcA"}],"tags":[]}