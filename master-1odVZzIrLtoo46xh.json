{"createdAt":"2025-10-10T02:39:42.609Z","updatedAt":"2025-10-27T14:04:05.699Z","id":"1odVZzIrLtoo46xh","name":"MASTER","active":false,"isArchived":false,"nodes":[{"parameters":{"dataToSave":{"values":[{"key":"conversationId","value":"={{ $json.body.id }}"},{"key":"contactNumber","value":"={{ $json.body.contact_inbox.source_id }}"}]}},"type":"n8n-nodes-base.executionData","typeVersion":1,"position":[-6512,1744],"id":"7ce71f93-031e-46b6-9ee5-426d38ead5ef","name":"Execution Data1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"057155d2-7320-48de-8ed5-bf00dcc72b38","leftValue":"={{ $json.body.messages[0].sender.phone_number }}","rightValue":"+5492213994411","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"d0c07208-2eca-4ffc-ae49-063a0363cf6e","leftValue":"={{ $json.body.messages[0].sender.phone_number }}","rightValue":"+595985624358","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"c20fad56-f470-4653-b327-8ce2b684deaa","leftValue":"={{ $json.body.messages[0].sender.phone_number }}","rightValue":"+5492254596618","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"41ecf46b-61e9-4d1b-9bc9-9ed63e9817e3","leftValue":"={{ $json.body.messages[0].sender.phone_number }}","rightValue":"+34629235015","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"or"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[-6512,1936],"id":"3d2eb55b-65b3-45b9-a6ac-ca6c8fd9e10f","name":"Filtrar nÃºmeros de prueba","disabled":true},{"parameters":{"assignments":{"assignments":[{"id":"16d8fd1f-7293-45ec-ba41-6041979d7964","name":"accountId","value":"={{ $json.body.messages[0].account_id }}","type":"number"},{"id":"a8eb17ea-8fda-42e5-9f1c-444826a21e51","name":"message","value":"={{ $json.body.messages[0].content }}","type":"string"},{"id":"3fe92852-b569-426e-bef7-b755cf44ddc9","name":"inboxId","value":"={{ $json.body.contact_inbox.inbox_id }}","type":"number"},{"id":"96fa0ac2-a17b-452c-bf67-cc0f3bd5d4a2","name":"contactId","value":"={{ $json.body.messages[0].sender.id }}","type":"number"},{"id":"0d77d8b4-ec6d-42e0-8a5b-fdf1b78b454d","name":"contactName","value":"={{ $json.body.messages[0].sender.name }}","type":"string"},{"id":"25487cfb-897d-4000-9ad6-99745966c526","name":"contactNumber","value":"={{ $json.body.messages[0].sender.phone_number }}","type":"string"},{"id":"1e1b0044-b199-44e0-927b-c2cabe2a281b","name":"agentId","value":"=","type":"number"},{"id":"ad5ef314-70d7-4790-b82e-ea96a340ae12","name":"agentName","value":"=","type":"string"},{"id":"f4bc6964-862e-4168-8bae-94e6c6ad8321","name":"eventType","value":"={{ $json.body.event }}","type":"string"},{"id":"ef4c85e4-0029-4d70-ade1-0de74711b804","name":"conversationId","value":"={{ $json.body.id }}","type":"number"},{"id":"be91191b-7e8a-4406-af97-0a18e8100e7f","name":"multimedia","value":"={{ $json?.body?.messages?.[0]?.attachments?.[0]?.file_type ? true : false }}","type":"boolean"},{"id":"a3202993-c215-4502-bf56-e7e644b35a88","name":"humano","value":"={{ $json.body.custom_attributes.humano }}","type":"boolean"},{"id":"3da45859-4092-4b0c-bba3-c8898b649491","name":"messagesId","value":"={{ $json.body.messages[0].id }}","type":"number"},{"id":"24592e90-360f-4a9c-8271-1119ba300be1","name":"timestamp","value":"={{ $json.body.timestamp }}","type":"number"},{"id":"e01eb0b6-2e60-4ade-a4ba-949e30df02a5","name":"multimediaUrl","value":"={{ $json.body.messages[0].attachments[0].data_url }}","type":"string"},{"id":"1225af59-1b61-42dc-8052-296978708c1a","name":"agenteBotTokenWhatsapp","value":"JFi43nzvEPDBCaxaFrkhVvdM","type":"string"},{"id":"2e74ddde-5f26-4b0c-a6dc-32eb8e83874f","name":"chatwootUrl","value":"https://chatw.automatizaciones.ai","type":"string"},{"id":"f6ac5f40-5ce8-43a8-b07a-44c1453e86bf","name":"content_type","value":"={{ $('Entrada').first().json.body.messages[0].content_type }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-6272,1936],"id":"10dc3f86-82de-496a-83d7-045a143e570f","name":"variables","onError":"continueRegularOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"0db9a125-ce45-48fe-b722-efbed0fc42a4","leftValue":"={{ $json.body.messages[0].sender.type }}","rightValue":"agent_bot","operator":{"type":"string","operation":"notEquals"}},{"id":"7d71d302-596d-4330-b68c-1b0502f6c7cd","leftValue":"={{ $json.body.event }}","rightValue":"message_created","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"12a51caa-5e4c-46f3-a067-79f0a52ca94b","leftValue":"={{ $json.body.messages[0].attachments[0].file_type }}","rightValue":"=file","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"or"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[-5696,2080],"id":"69157bc7-3b15-4fa9-a941-8c71270f3b49","name":"Filter1"},{"parameters":{"httpMethod":"POST","path":"agentes/v1/iclp","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-6736,1840],"id":"efe49c94-4eeb-41ad-96da-a5c3d7e3ea6e","name":"Entrada","webhookId":"c750562d-ea1f-43c4-abd9-173117a9f97f"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"*ðŸ“ REGISTRO DE NUEVO PACIENTE*\\n\\n*AL SER TU PRIMERA VEZ, NECESITAMOS TUS DATOS:*\\n\\nâ†’ NOMBRE Y APELLIDO\\nâ†’ DNI\\nâ†’ OBRA SOCIAL\\nâ†’ TELÃ‰FONO\\nâ†’ DOMICILIO\\n\\n*ðŸ“‹ FORMATO:*\\nENVIÃ TUS DATOS EN UN SOLO MENSAJE, ASÃ:\\n\\n_JUAN PEREZ_\\n_35946257_\\n_OSDE_\\n_2214567890_\\n_CALLE 50 NÂ°123, LA PLATA_\\n\\nðŸ‘‡ *ESCRIBÃ TUS DATOS Y ENVIALOS*\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"volver-atras\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[928,2912],"id":"f2ebfd3c-e93d-4535-bdac-81560cec764d","name":"Primera vez INS.","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[-6336,4704],"id":"198c502e-9938-463b-b2c8-5a0c08329adc","name":"When clicking â€˜Execute workflowâ€™"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').item.json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"list\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ðŸ«€ INSTITUTO DE CARDIOLOGÃA LA PLATA\"\n    },\n    \"body\": {\n      \"text\": \"ðŸ“‹ MENÃš PRINCIPAL\\n\\nPRESIONÃ 'ABRIR MENÃš' Y ELEGÃ UNA OPCIÃ“N:\\n\\nâ†’ ðŸ• HORARIOS DE ATENCIÃ“N\\n\\nâ†’ ðŸ“ UBICACIÃ“N DE LA CLÃNICA\\n\\nâ†’ ðŸ’» PORTAL DE PACIENTES\\n\\nâ†’ ðŸ“§ SOLICITAR RECETAS\\n\\nâ†’ ðŸ‘¨â€âš•ï¸ NUESTROS MÃ‰DICOS\\n\\nâ†’ ðŸ©º ESPECIALIDADES MÃ‰DICAS\"\n    },\n    \"footer\": {\n      \"text\": \"ðŸ“… LUN-VIE 8-20HS\"\n    },\n    \"action\": {\n      \"button\": \"ABRIR MENÃš\",\n      \"sections\": [\n        {\n          \"title\": \"ELEGÃ UNA OPCIÃ“N ðŸ‘‡\",\n          \"rows\": [\n            {\n              \"id\": \"horarios\",\n              \"title\": \"ðŸ• HORARIOS\",\n              \"description\": \"â†’ HORARIOS DE ATENCIÃ“N\"\n            },\n            {\n              \"id\": \"direccion\",\n              \"title\": \"ðŸ“ DIRECCIÃ“N\",\n              \"description\": \"â†’ UBICACIÃ“N ICLP\"\n            },\n            {\n              \"id\": \"portal-paciente\",\n              \"title\": \"ðŸ’» PORTAL PACIENTES\",\n              \"description\": \"â†’ ACCESO AL PORTAL\"\n            },\n            {\n              \"id\": \"email-recetas\",\n              \"title\": \"ðŸ“§ EMAIL RECETAS\",\n              \"description\": \"â†’ SOLICITAR RECETAS\"\n            },\n            {\n              \"id\": \"medicos\",\n              \"title\": \"ðŸ‘¨â€âš•ï¸ MÃ‰DICOS\",\n              \"description\": \"â†’ VER ESPECIALISTAS\"\n            },\n            {\n              \"id\": \"especialidades\",\n              \"title\": \"ðŸ©º ESPECIALIDADES\",\n              \"description\": \"â†’ LISTA COMPLETA\"\n            },\n            {\n              \"id\": \"menu-principal\",\n              \"title\": \"VOLVER AL MENU PRINCIPAL\",\n              \"description\": \"MENU PRINCIPAL\"\n            }\n\n          ]\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[928,672],"id":"bdd083ec-fdd6-44c8-b2ea-efd08b1dfef5","name":"â„¹ï¸ Info General","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').item.json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ðŸ«€ INSTITUTO DE CARDIOLOGÃA LA PLATA\"\n    },\n    \"body\": {\n      \"text\": \"ðŸ¢ ADMINISTRACIÃ“N\\n\\nTE CONECTAREMOS CON UNA RECEPCIONISTA PARA:\\n\\nâœ… REPROGRAMAR UN TURNO\\nâœ… CONSULTAS O RECLAMOS URGENTES\\nâœ… DERIVACIÃ“N URGENTE\\n\\nâ° HORARIO DE RESPUESTA:\\nLUNES A VIERNES: 8-20HS | SÃBADO 8-13HS\\n\\nðŸ’¡ SI NECESITÃS:\\n- AGENDAR UN TURNO NUEVO â†’ USÃ EL BOT (MÃS RÃPIDO)\\n- CANCELAR UN TURNO â†’ USÃ EL BOT\\n- INFO GENERAL â†’ USÃ EL BOT\\n\\nðŸ“ž OTRO MEDIO DONDE PODÃ‰S RECIBIR ASISTENCIA:\\n221 4906310\\n\\nÂ¿QUERÃ‰S CONTINUAR?\"\n    },\n    \"footer\": {\n      \"text\": \"LUN-VIE 8-20HS\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"si-confirmo\",\n            \"title\": \"SI, CONFIRMO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"volver-atras\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[928,896],"id":"109b379c-2e65-40f5-b5e3-9af967fe933e","name":"ðŸ¢ AdministraciÃ³n","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Filter1').first().json.contactNumber }}","value":"ADMINISTRACION=1","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1152,896],"id":"7bdbe90f-7fbf-40c5-a29b-6d0004a4d3cc","name":"â±ï¸ STATUS MENU","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').item.json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"image\",\n      \"image\": {\n        \"link\": \"https://i.imgur.com/cSVuheF.png\"\n      }\n    },\n    \"body\": {\n      \"text\": \"ðŸ‘‹ Â¡HOLA! BIENVENIDO AL ICLP\\n\\nðŸ¤– BOT: DISPONIBLE 24/7\\n\\nðŸ“ž ATENCIÃ“N TELEFÃ“NICA Y ADMINISTRATIVA:\\nLUNES A VIERNES 8-20HS | SÃBADO 8-13HS\\n\\nSELECCIONÃ UNA OPCIÃ“N:\\n\\nðŸ“… TURNOS (BOT)\\n- AGENDAR, CONSULTAR O CANCELAR\\n\\nâ„¹ï¸ INFO GENERAL (BOT)\\n- HORARIOS, UBICACIÃ“N Y MÃS\\n\\nðŸ¢ ADMINISTRACIÃ“N (PERSONAL ADMINISTRATIVO)\\n* CONSULTAS Y RECLAMOS\\n* RESPUESTA EN HORARIO DE ATENCIÃ“N\"\n    },\n    \"footer\": {\n      \"text\": \"SELECCIONÃ UNA OPCIÃ“N ðŸ‘‡\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"turnos\",\n            \"title\": \"ðŸ“… TURNOS\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"info-general\",\n            \"title\": \"â„¹ï¸ INFO GENERAL\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"administracion\",\n            \"title\": \"ðŸ¢ ADMINISTRACION\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[928,1120],"id":"e81cfe4a-72b1-4332-8cb2-71507f134de7","name":"Menu Principal = MENU=1","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"delete","key":"status:+5492254596618"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-6112,4704],"id":"ae686dba-e7c1-4e32-aab8-c0f047459d35","name":"DELETE - STATUS MENU","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"contador:+5492254596618"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-5888,4704],"id":"de339337-f6b5-45a8-b5aa-50ddd4d62868","name":"DELETE - CONTADOR","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Filter1').first().json.contactNumber }}","value":"MENU=1","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1152,1120],"id":"fede044c-cf4d-465c-a2b7-102fb71d20ef","name":"â±ï¸ STATUS MENU1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Filter1').first().json.contactNumber }}","value":"DATOS=1","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1152,2912],"id":"d5eb4a9e-984a-49f7-bf34-69050b2049ef","name":"â±ï¸ STATUS PRIMERA VEZ","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"068a964d-25b6-4a1f-8e05-c47dd2fea4b7","leftValue":"={{ $json.output.ERROR }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2192,-768],"id":"ba42de5c-7dd8-4955-80a7-0a83069a2b4d","name":"Error informacion de usuario"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').first().json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"âš ï¸ {{ $json.output.ERROR_MESSAGE }}\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2512,-992],"id":"cd92378b-6f58-4f4d-9cf1-1ba8b9471b86","name":"âš ï¸ DATOS INCORRECTOS","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Filter1').first().json.contactNumber }}","value":"ESPECIALIDADES=1","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1408,2496],"id":"00ab4981-648d-4c02-8c2d-9da9ccf234de","name":"ESPECIALIDADES","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.recipient_type }}"},{"name":"to","value":"={{ $json.to }}"},{"name":"type","value":"={{ $json.type }}"},{"name":"interactive","value":"={{ $json.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1184,2496],"id":"9f25a4b6-86e3-43cc-81f6-d5644e244f96","name":"ðŸ©» ESPECIALIDADES","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"jsCode":"// Obtener todas las especialidades del input\nconst items = $input.all();\n\n// Crear el array de rows dinÃ¡micamente\nconst rows = items.map(item => {\n  const especialidad = item.json.Especialidad;\n  const codigo = item.json.Codigo;\n  \n  // Convertir a mayÃºsculas\n  let nombreEspecialidad = especialidad.toUpperCase();\n  \n  // Si tiene parÃ©ntesis, tomar solo lo que estÃ¡ antes\n  if (nombreEspecialidad.includes('(')) {\n    nombreEspecialidad = nombreEspecialidad.split('(')[0].trim();\n  }\n  \n  // Si tiene barra, tomar solo la primera parte\n  if (nombreEspecialidad.includes('/')) {\n    nombreEspecialidad = nombreEspecialidad.split('/')[0].trim();\n  }\n  \n  // Si tiene mÃºltiples palabras, tomar solo la primera palabra\n  if (nombreEspecialidad.includes(' ')) {\n    nombreEspecialidad = nombreEspecialidad.split(' ')[0];\n  }\n  \n  // Crear el title con formato: ESPECIALIDAD-CODIGO\n  let title = `${nombreEspecialidad}-${codigo}`;\n  \n  // Si aÃºn es muy largo, cortar a 24 caracteres\n  if (title.length > 24) {\n    title = title.substring(0, 21) + '...';\n  }\n  \n  // Crear descripciÃ³n completa\n  let description = especialidad;\n  \n  // WhatsApp permite MÃXIMO 72 caracteres en ROW_DESCRIPTION\n  if (description.length > 72) {\n    description = description.substring(0, 69) + '...';\n  }\n  \n  return {\n    id: codigo,\n    title: title,\n    description: description\n  };\n});\n\n// Agregar botÃ³n \"VER MÃS\" al final de la lista\nrows.push({\n  id: \"ver-mas\",\n  title: \"ðŸ“‹ VER MÃS\",\n  description: \"VER MÃS OPCIONES Y ESPECIALIDADES DISPONIBLES\"\n});\n\n// Retornar el JSON completo con la estructura de WhatsApp\nreturn [{\n  json: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: $('Filter1').first().json.contactNumber,\n    type: \"interactive\",\n    interactive: {\n      type: \"list\",\n      header: {\n        type: \"text\",\n        text: \"ðŸ©º ESPECIALIDADES\"\n      },\n      body: {\n        text: \"*ðŸ“‹ Â¿CÃ“MO FUNCIONA?*\\n\\n*1ï¸âƒ£ ELEGÃ LA ESPECIALIDAD*\\nPRESIONÃ EL BOTÃ“N Y SELECCIONÃ LA ESPECIALIDAD MÃ‰DICA QUE NECESITÃS\\n\\n*2ï¸âƒ£ ELEGÃ EL MÃ‰DICO*\\nLUEGO PODRÃS VER Y SELECCIONAR LOS PROFESIONALES DISPONIBLES EN ESA ESPECIALIDAD\\n\\nðŸ‘‡ *PRESIONÃ PARA COMENZAR*\"\n      },\n      footer: {\n        text: \"ðŸ“… LUN-VIE 8-20HS\"\n      },\n      action: {\n        button: \"VER ESPECIALIDADES\",\n        sections: [\n          {\n            title: \"ELEGIR UNA OPCIÃ“N\",\n            rows: rows\n          }\n        ]\n      }\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[960,2496],"id":"6378c534-04f4-4ce5-8da7-9c45b8dc9dd3","name":"LISTA"},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"mi8p2u7tvuplzt5","limit":9,"options":{}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[736,2496],"id":"6d5379f9-4a36-4a30-8da8-b1b2a17ea71f","name":"Get_Especialidades","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"jsCode":"// Obtener el mensaje completo\nconst mensaje = $('Filter1').first().json.message;\n\n// Extraer solo el cÃ³digo (despuÃ©s del guiÃ³n)\nconst codigo = mensaje.split('-').pop();\n\n// Retornar el resultado\nreturn [{\n  json: {\n    codigo: codigo\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1008,3360],"id":"ba2dea2a-7426-410b-ad81-185570dfcc0e","name":"Code1"},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"mhwp4qt6r2d7ymm","limit":9,"options":{"fields":[]}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[1552,3088],"id":"7939ed84-19be-4511-ba96-69affdc7b1ad","name":"get_medicos","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"jsCode":"// Obtener datos del nodo get_datos_usuario\nconst inputData = $('DATOS_PACIENTE:').first().json;\nconsole.log('Input completo:', JSON.stringify(inputData, null, 2));\n\n// Intentar diferentes rutas para encontrar el DNI\nlet dni = null;\n\n// OpciÃ³n 1: Datos.paciente_dni\nif (inputData.Datos && inputData.Datos.paciente_dni) {\n  dni = Number(inputData.Datos.paciente_dni);\n  console.log('DNI encontrado en Datos.paciente_dni:', dni);\n}\n// OpciÃ³n 2: paciente_dni directo\nelse if (inputData.paciente_dni) {\n  dni = Number(inputData.paciente_dni);\n  console.log('DNI encontrado en paciente_dni:', dni);\n}\n// OpciÃ³n 3: DNI directo (sin objeto Datos)\nelse if (inputData.DNI) {\n  dni = Number(inputData.DNI);\n  console.log('DNI encontrado en DNI directo:', dni);\n}\n// OpciÃ³n 4: Datos como string que hay que parsear\nelse if (typeof inputData.Datos === 'string') {\n  try {\n    const datosParsed = JSON.parse(inputData.Datos);\n    dni = Number(datosParsed.paciente_dni);\n    console.log('DNI encontrado parseando Datos:', dni);\n  } catch (error) {\n    console.log('Error al parsear Datos:', error.message);\n    console.log('Datos sin parsear:', inputData.Datos);\n    // Intentar extraer DNI si tiene formato \"DNI:35946257\"\n    if (inputData.Datos.includes(':')) {\n      dni = Number(inputData.Datos.split(':')[1].trim());\n      console.log('DNI extraÃ­do del formato DNI:valor:', dni);\n    }\n  }\n}\n\nconsole.log('DNI final:', dni);\n\n// Validar que se encontrÃ³ el DNI\nif (!dni || isNaN(dni)) {\n  throw new Error('No se pudo encontrar el DNI en los datos de entrada');\n}\n\n// Obtener el mensaje que contiene NOMBRE-MATRICULA\nconst mensaje = $('Filter1').first().json.message;\n\n// Extraer solo la MATRICULA (nÃºmero despuÃ©s del guiÃ³n)\nconst matricula = Number(mensaje.split('-').pop().trim());\n\n// Obtener la fecha actual en formato yyyyMMdd\nconst fecha = Number(DateTime.now()\n  .setZone('America/Argentina/Buenos_Aires')\n  .toFormat('yyyyMMdd'));\n\n// Retornar el resultado\nreturn [{\n  json: {\n    dni: dni,\n    matricula: matricula,\n    fecha: fecha\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2384,4080],"id":"a82d1160-ce2b-4851-81cc-bd978b9616c3","name":"Code"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.recipient_type }}"},{"name":"to","value":"={{ $json.to }}"},{"name":"type","value":"={{ $json.type }}"},{"name":"interactive","value":"={{ $json.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2000,3088],"id":"72eef698-e72f-4b18-af3c-216f5697b1ee","name":"Medicos","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"leftValue":"={{ $('Filter1').item.json.message === 'ðŸ“… TURNOS' &&  $json.status === 'MENU=1'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true},"id":"aacee385-95a8-41d2-9c7e-547318a25143"}],"combinator":"and"},"renameOutput":true,"outputKey":"=ðŸ“… Turnos "},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"4acbe828-86be-4b90-8aec-6b8b842269c1","leftValue":"={{ $('Filter1').item.json.message === 'â„¹ï¸ INFO GENERAL'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"â„¹ï¸ Info General"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"78546a36-a7a9-435c-8932-4778ab0c5959","leftValue":"={{ $('Filter1').item.json.message === 'ðŸ¢ ADMINISTRACION'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ðŸ¢ AdministraciÃ³n"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"6394527f-2e97-4fe0-b78c-0d944b995fa3","leftValue":"={{ ($json.status == null || $json.status === '') && !['â„¹ï¸ INFO GENERAL', 'ðŸ“… TURNOS', 'ðŸ¢ ADMINISTRACION'].includes($('Filter1').item.json.message)  }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"Menu principal"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"44d5c148-338e-4039-a0fe-7b16fffdf96e","leftValue":"={{ $json.status === 'ADMINISTRACION=1' && $('Filter1').item.json.message === 'SI, CONFIRMO' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"SI, CONFIRMO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"83b82f32-93f7-43ac-863c-5d97343541ab","leftValue":"={{ ($json.status === 'ADMINISTRACION=1' || $json.status ==='ESPECIALIDADES=1' || $json.status === 'TURNOS=1' || $json.status === 'MENU=1' || $json.status === 'HORARIOS=1' ) && $('Filter1').item.json.message === 'MENU PRINCIPAL' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"MENU PRINCIPAL"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"2df6674f-a46b-489f-9644-1143b04e73cd","leftValue":"={{ $json.status === 'DATOS=1' && $('Filter1').item.json.message === 'VOLVER ATRAS'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"VOLVER MENU PRMERA VEZ"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"afa7d5a4-b19e-4f00-861d-4fabcb8b365c","leftValue":"={{ $json.status === 'DATOS=1' && $('Filter1').item.json.message === 'MENU PRINCIPAL'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"VUELVE MENU PRINCIPAL"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"efd790d6-e09f-47ec-b9f3-fae3857853be","leftValue":"={{ $json.status === 'DATOS=1' || $json.status ==='MENU=1' && $('Filter1').item.json.message === 'TURNOS CONSULTORIO'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"TURNOS CONSULTORIO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"fa55ec2d-16fc-4430-b1e5-215d7a599092","leftValue":"={{ $json.status === 'DATOS=1' && $('Filter1').item.json.message.trim() === 'TURNOS CONSULTORIO' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"TURNOS CONSULTORIO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"fbd8b46d-0856-4057-9d98-5e7ebda62949","leftValue":"={{ $json.status === 'MENU=1' && $('Filter1').item.json.message === 'NUEVO PACIENTE' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"Primera vez"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"101afc22-c553-4d38-bd69-816f4bf666c0","leftValue":"={{ $json.status === 'DATOS=1' && $('Filter1').item.json.message.trim() !== 'VOLVER ATRAS' &&  $('Filter1').item.json.message !== 'CON ESPECIALIDAD' && $('Filter1').item.json.message !== 'CONTINUAR'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"DATOS PACIENTE"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"f46dd242-17b3-46e9-830f-7c579acc1bbb","leftValue":"={{ $json.status === 'ESPECIALIDADES=1' && $('Filter1').item.json.message !== 'ðŸ“‹ VER MÃS' && $('Filter1').item.json.message !== 'ðŸ“‹ VOLVER ATRAS'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ESPECIALIDADES"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"df533638-b2e2-48ee-aa06-de32ec45bdbe","leftValue":"={{ $json.status === 'MEDICOS=1' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"MEDICOS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"e3130b37-608b-4661-8d88-d870473e46dd","leftValue":"={{ $json.status === 'HORARIOS=1' &&  $('Filter1').item.json.message !== 'â¬…ï¸ VOLVER ATRAS'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"CONFIRMAR-TURNO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"038f4f66-b969-46d1-808c-f5e3e22369bf","leftValue":"={{ $json.status === 'TURNO-CONFIRMADO' && $('Filter1').item.json.message ==='SÃ, CONFIRMO' || $('Filter1').item.json.message === 'CONFIRMAR TURNO' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"TURNO CONFIRMADO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"b8141077-7181-4146-be92-9057da0af435","leftValue":"={{ $json.status === 'MENU=1' &&  $('Filter1').item.json.message === 'PACIENTE REGISTRADO' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"PACIENTE REGISTRADO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"06d618bd-eae8-4b42-bc33-0ddc48516cf1","leftValue":"={{ $json.status === 'PACIENTE=1' &&  $('Filter1').item.json.message !== 'VOLVER ATRÃS'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"BUSCAR DNI"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"4163376b-0a76-4a3d-8c4d-5d7902cc4f48","leftValue":"={{ $json.status.startsWith('DNI:') && $('Filter1').item.json.message === 'MIS TURNO/S'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"MIS TURNOS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"8c49825d-31d8-4120-9ffa-f906cb44bb1b","leftValue":"={{ $json.status.startsWith('DNI:') && $('Filter1').item.json.message === 'VOLVER ATRÃS'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"MIS TURNOS-VOLVER ATRAS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"79743b31-9d7c-48de-8ea3-f0dbaeddbe71","leftValue":"={{ $json.status.startsWith('DNI:') || $json.status === 'MENU=1'&& $('Filter1').item.json.message === 'CANCELAR TURNO'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"CANCELAR TURNO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"558feafc-71ef-42ec-8e71-341549deb019","leftValue":"={{ $json.status.startsWith('DNI:') && $('Filter1').item.json.message === 'MENU PRINCIPAL'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"menu principal"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"a725236c-9399-42ab-a059-026c5d5f0f17","leftValue":"={{ $json.status.startsWith('DNI:') && $('Filter1').item.json.message === 'TOMAR TURNO'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"TOMAR TURNO - YA REGISTRADO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"459206f5-daa4-4933-8869-0be854165d4a","leftValue":"={{ $json.status.startsWith('DNI:') && $('Filter1').item.json.message === 'TURNOS CONSULTORIO'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"TURNOS CONSULTORIO - PACIENTE REGISTRADO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"273275e4-41c6-45c2-a1aa-52581eed6719","leftValue":"={{ $json.status.startsWith('ESPECIALIDADES=1') && $('Filter1').item.json.message === 'ðŸ“‹ VER MÃS'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ESPECIALIDADES-VER MAS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"92c8caf5-317f-4fab-ad94-9ec99357a056","leftValue":"={{ $json.status.startsWith('ESPECIALIDADES=1') && $('Filter1').item.json.message === 'ðŸ“‹ VOLVER ATRAS'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"VOLVER ATRAS-ESPECIALIDADES"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"b7e03e2e-be29-448e-bec1-cfbd7dabecb1","leftValue":"={{ $json.status.startsWith('ESPECIALIDADES=1') && $('Filter1').item.json.message === 'VOLVER ATRÃS'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"VOLVER ATRAS-TOMAR TURNO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"4b9e3939-9475-4e16-a8ab-36bb28537ae2","leftValue":"={{ $json.status.startsWith('DNI:') && $('Filter1').item.json.message === 'TURNOS ESTUDIO'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"turnos estudio"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"98d949f7-5f64-4473-81fe-0d00aa1c922f","leftValue":"={{ $json.status === 'TURNO-CONFIRMADO' && $('Filter1').item.json.message === 'VOLVER ATRÃS' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"VOLVER ATRAAS - TURNO CONFIRMADO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"77eaa7b5-ce78-435b-8829-75fadc40f48e","leftValue":"={{ $json.status.startsWith('DNI:') && /^[A-Z]+(-\\d{2}){2}-\\d{4}$/.test($('Filter1').item.json.message) }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ðŸš« DELETE TURNO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"c620e48b-fa9a-45a1-b715-93a557d4a417","leftValue":"={{ $json.status === 'TURNO-CONFIRMADO' && $('Filter1').item.json.message === 'MENU PRINCIPAL'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"=TURNO-CONFIRMADO - MENU PRINCIPAL"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"ffc31ac1-767a-4385-820d-4de70ce019d7","leftValue":"={{ $('Filter1').item.json.message === 'ðŸ• HORARIOS' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ðŸ• HORARIOS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"812bae76-edd6-4893-85bb-a5438e1795b9","leftValue":"={{ $('Filter1').item.json.message === 'ðŸ“ DIRECCIÃ“N'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ðŸ“ DIRECCIÃ“N"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"e703712c-1f80-4bdf-925a-d0b772b7c952","leftValue":"={{ $('Filter1').item.json.message === 'ðŸ’» PORTAL PACIENTES' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ðŸ’» PORTAL PACIENTES"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"642ded3f-e61d-4393-8a68-a477dba1da2b","leftValue":"={{ $('Filter1').item.json.message === 'ðŸ“§ EMAIL RECETAS' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ðŸ“§ EMAIL RECETAS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"b9cc8543-dce1-4d14-82cb-122960e0445d","leftValue":"={{ $('Filter1').item.json.message === 'ðŸ‘¨â€âš•ï¸ MÃ‰DICOS' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ðŸ‘¨â€âš•ï¸ MÃ‰DICOS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"36d911cd-1dc7-45e7-9fca-4a0f007816d4","leftValue":"={{ $('Filter1').item.json.message === 'ðŸ©º ESPECIALIDADES' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ðŸ©º ESPECIALIDADES"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"78250097-f228-4d14-aa2a-32a1f643dff0","leftValue":"={{ $json.status.startsWith('DNI:') && $('Filter1').item.json.message === 'CONTINUAR'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"CONTINUAR"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"fca1c410-2105-42ad-878f-c4c96a3c227c","leftValue":"={{ $json.status.startsWith('DNI:') && $('Filter1').item.json.message === 'MENU PRINCIPAL'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"MENU PRINCIPAL"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"019f7999-5d5d-407a-ad50-2ed43983585b","leftValue":"={{ $json.status === 'DATOS=1' && $('Filter1').item.json.message === 'CONTINUAR' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"CONTINUAR"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"95d44411-d152-4d3d-b933-3f4d50b1140b","leftValue":"={{ $('Filter1').item.json.message === 'VOLVER ATRÃS' && $json.status === 'PACIENTE=1' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"VOLVER ATRÃS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"4c5bcc71-179a-48cb-be5a-14d61759d32c","leftValue":"={{ $json.status === 'ESPECIALIDADES=1'&& $('Filter1').item.json.message === 'MENU PRINCIPAL'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"MENU PRINCIPAL"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"066d73f1-dfab-42ea-880f-bb79a726382a","leftValue":"={{ $json.status === 'MENU=1' && /^\\d{7,8}$/.test($('Filter1').item.json.message) }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"DNI USUARIO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"ab3b68c3-a8fb-4d15-84dd-4e766ac9e4ef","leftValue":"={{ $json.status === 'HORARIOS=1' && $('Filter1').item.json.message === 'VOLVER ATRAS'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"VOLVER ATRAS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"87509c74-02fd-49b5-8e07-a9fd3f7c2623","leftValue":"={{ $('Entrada').item.json.body.labels[0] === 'turnos-estudios' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ETIQUETA=turnos-estudios"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"7461aa78-e23f-4d64-b78e-58a713ab4e5b","leftValue":"={{ $json.status === 'ESPECIALIDADES=1' && $('Filter1').item.json.message === 'VOLVER'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"VOLVER"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"41e34c42-4bdb-4178-a8a8-c793b3cbe36d","leftValue":"={{ $json.status === 'MENU=1' && $('Filter1').item.json.message === 'CONTINUAR' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"MENU->TURNOS-ESTUDIO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"28c5fbbe-fd56-403a-99c2-a0b79171a45b","leftValue":"={{ $json.status === 'MENU=1' && $('Filter1').item.json.message === 'TOMAR TURNO'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"MENU->TOMAR_TURNO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"d7774bda-f33e-484c-a5b0-e4475d5632b0","leftValue":"={{ $json.status === 'CANCELAR-TURNO' && $('Filter1').item.json.message === 'CANCELAR TURNO'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"CANCELARENVIAR-CONFIRMAR CANCELACIONTURN"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"a3483772-84b4-4c0a-afe6-833ac7b70ba6","leftValue":"={{ $json.status === 'PACIENTE_NUEVO' &&  $('Filter1').item.json.message === 'CONTINUAR'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"PACIENTE NUEVO "},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"8ba0b30a-4d40-463a-9bcd-d8deef0cb931","leftValue":"={{ $json.status === 'PACIENTE_NUEVO' && $('Filter1').item.json.message === 'TOMAR TURNO'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"=TOMAR TURNO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"80aa049b-dbf9-42a5-b578-c931aea17d8e","leftValue":"={{ $json.status === 'TURNOS_CONSULTORIO=1' && $('Filter1').item.json.message === 'TURNOS CONSULTORIO' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"TURNO_CONSULTORIO - ESPECIALIDADES"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"3489f518-ef29-4db9-806a-90987e137bdf","leftValue":"={{ $json.status === 'MENU=1' && $('Filter1').item.json.message === 'MIS TURNO/S'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"MIS TURNOS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"631b6aab-92c4-450b-addc-6323e3266a95","leftValue":"={{ $json.status === 'TURNOS_CONSULTORIO=1' && $('Filter1').item.json.message === 'TURNOS ESTUDIO' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"TURNOS ESTUDIO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"a18c6124-6bbb-42fd-b831-6ecd51a12e10","leftValue":"={{ $json.status === 'CANCELAR-TURNO' && $('Filter1').item.json.message === 'MENU PRINCIPAL'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"}},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"fc1b2623-ce68-421b-8eb9-ef57fe88cda1","leftValue":"={{ $json.status === 'CANCELAR-TURNO' && $('Filter1').item.json.message !== 'MENU PRINCIPAL' &&  $('Filter1').item.json.message !== 'CANCELAR TURNO'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"}}]},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-4608,1232],"id":"212f5d18-51d3-4b9e-ae64-0caa30fe5015","name":"MENU PRINCIPAL","alwaysOutputData":false,"onError":"continueRegularOutput"},{"parameters":{"workflowId":{"__rl":true,"value":"kmoVJGP4RL3PTi16","mode":"list","cachedResultName":"SUB - HORARIOS_TURNOS_PROXIMOS"},"workflowInputs":{"mappingMode":"defineBelow","value":{"matricula":"={{ $json.matricula }}","dni":"={{ $json.dni }}","fechaDesde":"={{ $json.fecha }}"},"matchingColumns":[],"schema":[{"id":"matricula","displayName":"matricula","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"fechaDesde","displayName":"fechaDesde","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[2608,4080],"id":"4140a920-b69b-4809-b4b3-b384a3fe8472","name":"ðŸ“… Horarios Proximos"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.recipient_type }}"},{"name":"to","value":"={{ $json.to }}"},{"name":"type","value":"={{ $json.type }}"},{"name":"interactive","value":"={{ $json.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3056,4080],"id":"7c58b5e2-ebc9-44c2-8804-37d32d9b5a56","name":"ðŸ• Fechas disponibles ","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"jsCode":"// Obtener todos los horarios del input\nconst fechasLibres = $input.first().json.fechas_libres;\n\n// Si no hay fechas disponibles, devolver mensaje con botones\nif (!fechasLibres || fechasLibres.length === 0) {\n  return [{\n    json: {\n      messaging_product: \"whatsapp\",\n      recipient_type: \"individual\",\n      to: $('Filter1').first().json.contactNumber,\n      type: \"interactive\",\n      interactive: {\n        type: \"button\",\n        header: {\n          type: \"text\",\n          text: \"âŒ SIN TURNOS DISPONIBLES\"\n        },\n        body: {\n          text: \"*LO SENTIMOS, NO HAY TURNOS DISPONIBLES EN ESTE MOMENTO*\\n\\n*ðŸ’™ CONTACTANOS DIRECTAMENTE:*\\nðŸ“ž *(0221) 490-6310*\\nðŸ“… *LUN-VIE 8-20HS*\"\n        },\n        footer: {\n          text: \"â¤ï¸ CUIDAMOS TU SALUD CARDIOVASCULAR\"\n        },\n        action: {\n          buttons: [\n                     {\n              type: \"reply\",\n              reply: {\n                id: \"menu-principal\",\n                title: \"MENU PRINCIPAL\"\n              }\n            }\n          ]\n        }\n      }\n    }\n  }];\n}\n\n// Limitar a mÃ¡ximo 9 horarios\nconst fechasLimitadas = fechasLibres.slice(0, 9);\n\n// Crear el array de rows dinÃ¡micamente\nconst rows = fechasLimitadas.map(item => {\n  // Obtener la fecha y hora del formato \"2025-10-14,\\n 11:20\"\n  const fechaHoraRaw = item.fecha_y_hora;\n  \n  // Limpiar y separar fecha y hora\n  const [fecha, hora] = fechaHoraRaw.replace(/\\n/g, '').split(',').map(s => s.trim());\n  \n  // Crear objeto DateTime\n  const dt = DateTime.fromISO(`${fecha}T${hora}`, { \n    zone: 'America/Argentina/Buenos_Aires' \n  });\n  \n  // Obtener dÃ­a de la semana en espaÃ±ol\n  const diasSemana = ['DOM', 'LUN', 'MAR', 'MIÃ‰', 'JUE', 'VIE', 'SÃB'];\n  const diaSemana = diasSemana[dt.weekday % 7];\n  \n  // Formatear fecha como DD/MM\n  const fechaFormateada = dt.toFormat('dd/MM');\n  \n  // Crear el title: DÃA DD/MM - HH:MM\n  let title = `${diaSemana} ${fechaFormateada} - ${hora}`;\n  \n  // Si aÃºn es muy largo, cortar a 24 caracteres\n  if (title.length > 24) {\n    title = title.substring(0, 21) + '...';\n  }\n  \n  // Crear descripciÃ³n completa EN MAYÃšSCULAS\n  let description = `${diaSemana} ${dt.toFormat('dd/MM/yyyy')} A LAS ${hora} HS`;\n  \n  // WhatsApp permite MÃXIMO 72 caracteres en ROW_DESCRIPTION\n  if (description.length > 72) {\n    description = description.substring(0, 69) + '...';\n  }\n  \n  // ID Ãºnico: combinar fecha y hora sin separadores\n  const id = `${fecha.replace(/-/g, '')}-${hora.replace(/:/g, '')}`;\n  \n  return {\n    id: id,\n    title: title,\n    description: description\n  };\n});\n\n// Retornar el JSON completo con la estructura de WhatsApp\nreturn [{\n  json: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: $('Filter1').first().json.contactNumber,\n    type: \"interactive\",\n    interactive: {\n      type: \"list\",\n      header: {\n        type: \"text\",\n        text: \"ðŸ¥ TURNOS DISPONIBLES\"\n      },\n      body: {\n        text: `*ENCONTRAMOS ${fechasLimitadas.length} TURNO${fechasLimitadas.length > 1 ? 'S' : ''} DISPONIBLE${fechasLimitadas.length > 1 ? 'S' : ''}*\\n\\n*ðŸ“… SELECCIONÃ LA FECHA Y HORA DE TU PREFERENCIA*\\n\\nðŸ‘‡ *TOCÃ EL BOTÃ“N PARA VER LOS HORARIOS*`\n      },\n      footer: {\n        text: \"â¤ï¸ ICLP - INSTITUTO CARDIOLÃ“GICO\"\n      },\n      action: {\n        button: \"VER TURNOS\",\n        sections: [\n          {\n            title: \"SELECCIONAR TURNO\",\n            rows: rows\n          }\n        ]\n      }\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2832,4080],"id":"02e54fa4-5d2f-4346-bcd3-32429a27d808","name":"ðŸ• LISTA-HORARIOS"},{"parameters":{"operation":"set","key":"=status:{{ $('Filter1').first().json.contactNumber }}","value":"MEDICOS=1","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2224,3088],"id":"535cf5ad-9ffb-43d7-888d-80ab40f9c093","name":"ðŸ©º MEDICOS","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"// Obtener todos los mÃ©dicos del input\nconst items = $input.all();\n\n// Crear el array de rows dinÃ¡micamente\nconst rows = items.map(item => {\n  const medico = item.json.Medico;\n  const matricula = item.json.Matricula;\n  \n  // Convertir a mayÃºsculas\n  let nombreMedico = medico.toUpperCase();\n  \n  // Si tiene parÃ©ntesis, tomar solo lo que estÃ¡ antes\n  if (nombreMedico.includes('(')) {\n    nombreMedico = nombreMedico.split('(')[0].trim();\n  }\n  \n  // Si tiene barra, tomar solo la primera parte\n  if (nombreMedico.includes('/')) {\n    nombreMedico = nombreMedico.split('/')[0].trim();\n  }\n  \n  // Si tiene mÃºltiples palabras, tomar solo la primera palabra\n  if (nombreMedico.includes(' ')) {\n    nombreMedico = nombreMedico.split(' ')[0];\n  }\n  \n  // Crear el title con formato: NOMBRE-MATRICULA\n  let title = `${nombreMedico}-${matricula}`;\n  \n  // Si aÃºn es muy largo, cortar a 24 caracteres\n  if (title.length > 24) {\n    title = title.substring(0, 21) + '...';\n  }\n  \n  // Crear descripciÃ³n completa\n  let description = medico;\n  \n  // WhatsApp permite MÃXIMO 72 caracteres en ROW_DESCRIPTION\n  if (description.length > 72) {\n    description = description.substring(0, 69) + '...';\n  }\n  \n  return {\n    id: matricula,\n    title: title,\n    description: description\n  };\n});\n\n// Solo agregar \"VER MÃS\" si hay 9 o mÃ¡s mÃ©dicos\nif (items.length >= 9) {\n  rows.push({\n    id: \"ver-mas\",\n    title: \"VER MAS\",\n    description: \"Ver mÃ¡s mÃ©dicos disponibles\"\n  });\n}\n\n// Retornar el JSON completo con la estructura de WhatsApp\nreturn [{\n  json: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: $('Filter1').first().json.contactNumber,\n    type: \"interactive\",\n    interactive: {\n      type: \"list\",\n      header: {\n        type: \"text\",\n        text: \"ðŸ‘¨â€âš•ï¸ MÃ©dicos\"\n      },\n      body: {\n        text: \"SeleccionÃ¡ el mÃ©dico con quien querÃ©s tu turno\"\n      },\n      footer: {\n        text: \"ðŸ“… Lun-Vie 8-20hs\"\n      },\n      action: {\n        button: \"VER MÃ‰DICOS\",\n        sections: [\n          {\n            title: \"ELEGIR MÃ‰DICO\",\n            rows: rows\n          }\n        ]\n      }\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1776,3088],"id":"16ddd7e1-7f14-4532-a7cf-253641b497b7","name":"ðŸ©º LISTA-MEDICOS "},{"parameters":{"operation":"set","key":"=status:{{ $('Filter1').first().json.contactNumber }}","value":"HORARIOS=1","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3280,4080],"id":"33a68b1f-7188-4315-9bfe-066ad77d30e8","name":"ðŸ©º MEDICOS1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[1376,-544],"id":"dd1f690d-56b2-4da6-9669-ea5d85acfccc","name":"OpenRouter Chat Model2","credentials":{"openRouterApi":{"id":"ZlcbniUoDvrFqCIJ","name":"OpenRouter ICLP"}}},{"parameters":{"jsCode":"// Obtener datos del nodo DATOS_PACIENTE\nconst inputData = $('DATOS_PACIENTE').first().json.Datos;\nconsole.log('Input completo:', JSON.stringify(inputData, null, 2));\n\n// Parsear datos si es string\nconst datosParsed = typeof inputData === 'string' ? JSON.parse(inputData) : inputData;\n\n// Extraer DNI\nconst dni = Number(datosParsed.paciente_dni);\nconsole.log('DNI final:', dni);\n\n// Validar que se encontrÃ³ el DNI\nif (!dni || isNaN(dni)) {\n  throw new Error('No se pudo encontrar el DNI en los datos de entrada');\n}\n\n// Extraer nombre completo\nconst nombre_completo = datosParsed.paciente_nombre;\nconsole.log('Nombre completo:', nombre_completo);\n\n// Extraer celular\nconst celular_paciente = datosParsed.paciente_celular;\nconsole.log('Celular:', celular_paciente);\n\n// Obtener la matrÃ­cula completa del input (ROGGIERO-16118)\nconst matriculaCompleta = $('MATRICULA').first().json.matricula;\nconsole.log('MatrÃ­cula completa:', matriculaCompleta);\n\n// Separar por guiÃ³n para obtener mÃ©dico y matrÃ­cula\nconst partes = matriculaCompleta.split('-');\n\n// Extraer el NOMBRE del mÃ©dico (ROGGIERO)\nconst medico = partes[0].trim();\nconsole.log('MÃ©dico:', medico);\n\n// Extraer solo el NÃšMERO de matrÃ­cula (16118)\nconst matricula = Number(partes[1].trim());\nconsole.log('MatrÃ­cula extraÃ­da:', matricula);\n\n// Obtener el horario del nodo Filter1 (MIÃ‰ 22/10 - 15:40)\nconst horarioCompleto = $('Filter1').first().json.message;\nconsole.log('Horario completo:', horarioCompleto);\n\n// Extraer fecha y hora del formato \"MIÃ‰ 22/10 - 15:40\"\nconst partesFechaHora = horarioCompleto.split(' - ');\nconst partesFecha = partesFechaHora[0].split(' ')[1]; // \"22/10\"\nconst horaOriginal = partesFechaHora[1]; // \"15:40\"\n\n// Convertir fecha \"22/10\" a Unix timestamp (milisegundos)\nconst [dia, mes] = partesFecha.split('/');\nconst anio = new Date().getFullYear(); // 2025\n\n// Crear fecha en formato ISO con zona horaria de Argentina\nconst fechaISO = `${anio}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}T00:00:00.000-03:00`;\nconst fecha = new Date(fechaISO).getTime();\nconsole.log('Fecha en Unix (ms):', fecha);\n\n// Convertir hora \"15:40\" a \"1540\" o \"08:20\" a \"0820\" (mantener como string con 4 dÃ­gitos)\nconst hora = horaOriginal.replace(':', '').padStart(4, '0');\nconsole.log('Hora convertida:', hora);\n\n// Retornar el resultado en el formato solicitado\nreturn [{\n  json: {\n    datos: {\n      dni: dni,\n      fecha: fecha,\n      hora: hora,\n      nombre_completo: nombre_completo,\n      celular_paciente: celular_paciente,\n      medico: medico,\n      matricula: matricula\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2608,4576],"id":"c5e2ec8d-de8a-44d3-b3a8-668ccbc8921a","name":"Code2"},{"parameters":{"operation":"set","key":"=MEDICO:{{ $('Filter1').first().json.contactNumber.replace('+', '') }}","value":"={{ $('Filter1').item.json.message }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3504,4080],"id":"a3c3d9a6-e48d-46e5-9417-cf200941a346","name":"Matricula medico","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"matricula","key":"=MEDICO:{{ $('Filter1').first().json.contactNumber.replace('+', '') }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2384,4576],"id":"5ba4ca24-1f5a-498b-9f8e-a1d7f37bd952","name":"MATRICULA","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ðŸ’™ CENTRO CARDIOLÃ“GICO\"\n    },\n    \"body\": {\n      \"text\": \"*_CONFIRMACIÃ“N DE TURNO_*\\n\\n*ðŸ©º DATOS DEL TURNO:*\\n\\nâ¤ï¸ *MÃ‰DICO CARDIÃ“LOGO*\\nDR./DRA. {{ $json.datos.medico }}\\n\\nðŸ“† *FECHA DE ATENCIÃ“N*\\n{{ DateTime.fromMillis($json.datos.fecha).setZone('America/Argentina/Buenos_Aires').toFormat('dd/MM/yyyy') }}\\n\\nâ° *HORA*\\n{{ $json.datos.hora.toString().padStart(4, '0').slice(0,2) }}:{{ $json.datos.hora.toString().padStart(4, '0').slice(2,4) }} HS\\n\\n*ðŸ’™ POR FAVOR, CONFIRMÃ TU ASISTENCIA*\"\n    },\n    \"footer\": {\n      \"text\": \"â¤ï¸ TU SALUD CARDIOVASCULAR ES PRIORIDAD\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"si-confirmo\",\n            \"title\": \"CONFIRMAR TURNO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"volver-atras\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3056,4576],"id":"31e6f657-ca9a-4b08-8aad-8aecddac2a0a","name":"ðŸ“… Confirmar turno","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=turno:{{ $('Filter1').first().json.contactNumber }}","value":"={{ JSON.stringify($json.datos) }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2832,4576],"id":"9b255d3b-5415-4d28-811e-77140498f243","name":"Datos para confirmar turno","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Filter1').first().json.contactNumber }}","value":"TURNO-CONFIRMADO","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3280,4576],"id":"7270f44a-9e26-48ef-b89f-887103fe6f9e","name":"Redis","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"datos","key":"=turno:{{ $('Filter1').first().json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2176,4912],"id":"c601cd75-3d6a-4acc-aa8d-70f8249133e5","name":"Datos para confirmar turno1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"workflowId":{"__rl":true,"value":"e7UD4t6GrwYxGW6Q","mode":"list","cachedResultName":"SUB - POST_TURNO"},"workflowInputs":{"mappingMode":"defineBelow","value":{"dni":"={{ $json.datos.parseJson().dni }}","fecha":"={{ $json.datos.parseJson().fecha }}","hora":"={{ $json.datos.parseJson().hora }}","nombre_completo":"={{ $json.datos.parseJson().nombre_completo}}","celular_paciente":"={{ $('Filter1').item.json.contactNumber }}","matricula":"={{ $json.datos.parseJson().matricula }}"},"matchingColumns":[],"schema":[{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"fecha","displayName":"fecha","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"hora","displayName":"hora","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"nombre_completo","displayName":"nombre_completo","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"celular_paciente","displayName":"celular_paciente","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"matricula","displayName":"matricula","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false}],"attemptToConvertTypes":true,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[2400,4912],"id":"a6455afe-b3fe-4ba7-af0e-401eee435e19","name":"EJECUTAR TURNO"},{"parameters":{"operation":"delete","key":"status:+5492213994411"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-6112,4896],"id":"b8df0a6d-7f58-41f6-be24-0abcf8153681","name":"DELETE - STATUS MENU1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"contador:+5492213994411"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-5888,4896],"id":"21d4cf53-5c37-46ab-9649-3e0204c169a0","name":"DELETE - CONTADOR1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"5492213994411"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-5664,4896],"id":"b1c618ba-92de-4263-8aef-e6a70aae0bd1","name":"DELETE - DATOS=","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"promptType":"define","text":"={{ $('Filter1').first().json.message }}","hasOutputParser":true,"options":{"systemMessage":"=# ROL\nSos un colector/validador de datos clÃ­nicos. Siempre devolvÃ©s UN Ãºnico objeto JSON. Sin texto extra ni markdown. No uses comillas en nÃºmeros.\n\n# CONTEXTO\n$OBRAS_SOCIALES := {{ JSON.stringify($json.obrasociales) }}  // usar EXCLUSIVAMENTE este listado\nCada item: { obrasocial: string, nombre_obrasocial: string }\n\n# CONTRATO DE SALIDA\n{\n  \"status\": \"ASK\" | \"FINAL\",\n  \"ask\": \"string\",                      // UNA pregunta breve, natural y amigable por el dato que falta o hay que corregir\n  \"missing\": [\"NOMBRE\",\"DNI\",\"OBRA_SOCIAL\",\"DIRECCION\",\"TELEFONO\"],\n  \"data\": {\n    \"NOMBRE\": \"string\",\n    \"DNI\": number,\n    \"OBRA_SOCIAL\": \"string\",\n    \"NOMBRE_OBRA_SOCIAL\": \"string\",\n    \"DIRECCION\": \"string\",\n    \"TELEFONO\": number\n  },\n  \"ERROR\": true | false,\n  \"ERROR_MESSAGE\": \"string\"\n}\n\n# REGLAS DE CONVERSACIÃ“N (ORDEN)\nValidÃ¡/pedÃ­ en este orden: NOMBRE â†’ DNI â†’ OBRA_SOCIAL â†’ DIRECCION â†’ TELEFONO.\n\n# REGLAS DE ERROR Y MENSAJES\n- En status=\"ASK\":\n  A) **Si existe algÃºn dato invÃ¡lido YA PROVISTO** (segÃºn el orden), entonces:\n     - ERROR=true\n     - ERROR_MESSAGE = mensaje natural y conversacional del primer invÃ¡lido\n     - ask = pregunta amigable para **corregir ese mismo dato** (no avanzar)\n  B) **Si NO hay invÃ¡lidos, pero faltan datos**, entonces:\n     - ERROR=true\n     - ERROR_MESSAGE = mensaje natural indicando quÃ© datos faltan\n     - ask = pregunta amigable por el **prÃ³ximo** dato faltante (siguiendo el orden)\n- En status=\"FINAL\":\n  - EjecutÃ¡ validaciones estrictas. Si algo falla â†’ ERROR=true y ERROR_MESSAGE natural con **solo** el primer error; si todo ok â†’ ERROR=false y ERROR_MESSAGE=\"\"\n\n# VALIDACIONES (estrictas, SOLO aplican cuando el campo YA fue provisto; en FINAL se aplican a todos)\n1) NOMBRE: al menos dos palabras alfabÃ©ticas\n   - error natural: \"Necesito su nombre completo (nombre y apellido) para registrarlo en el sistema\"\n   \n2) DNI: ^\\\\d{7,8}$ (solo nÃºmeros, sin puntos/espacios)\n   - error natural: \"El DNI que me pasÃ³ no es vÃ¡lido. Por favor, envÃ­eme solo los nÃºmeros, sin puntos ni espacios (ejemplo: 35946257)\"\n   \n3) OBRA_SOCIAL:\n   - \"no/sin obra social/particular\" â‡’ OBRA_SOCIAL=\"PART\", NOMBRE_OBRA_SOCIAL=\"PARTICULAR\"\n   - nombre informado â‡’ normalizar y buscar en $OBRAS_SOCIALES (exacto o inclusiÃ³n); si no hay match â†’ \"Disculpe, la obra social que mencionÃ³ no figura en nuestro sistema. Â¿PodrÃ­a verificar el nombre o indicar si es particular?\"\n   - si no se informÃ³ â‡’ se considera **faltante** (no invÃ¡lido)\n   \n4) DIRECCION: debe incluir calle y **al menos un dÃ­gito**\n   - error natural: \"Me falta la direcciÃ³n completa. Por favor, indÃ­queme calle y nÃºmero (ejemplo: Calle 50 NÂ°123)\"\n   \n5) TELEFONO: ^\\\\d{10}$ (solo nÃºmeros)\n   - error natural: \"El telÃ©fono debe tener 10 dÃ­gitos. Por favor, envÃ­elo completo con cÃ³digo de Ã¡rea, solo nÃºmeros (ejemplo: 2214567890)\"\n\n# TONO DE LOS MENSAJES\n- UsÃ¡ tratamiento formal (usted) pero amigable\n- SÃ© conversacional, no robÃ³tico\n- RecordÃ¡ y reconocÃ© los datos que ya tenÃ©s (\"Perfecto, ya tengo su nombre...\")\n- Cuando pidas el siguiente dato, podÃ©s hacer referencia a lo que ya obtuviste\n- Los mensajes deben ser breves pero claros\n\n# FORMATO\n- Strings faltantes = \"\" ; nÃºmeros faltantes = 0\n- ERROR = true si falta o estÃ¡ invÃ¡lido **cualquier** campo. ERROR=false solo si los 5 estÃ¡n completos y vÃ¡lidos\n\n# EJEMPLOS (NO IMPRIMIR)\n\n## Caso: usuario solo envÃ­a NOMBRE (\"Hector miralles\")\n{\n  \"status\":\"ASK\",\n  \"ask\":\"Perfecto, Hector. Ahora necesito su DNI, por favor (7 u 8 dÃ­gitos, sin puntos)\",\n  \"missing\":[\"DNI\",\"OBRA_SOCIAL\",\"DIRECCION\",\"TELEFONO\"],\n  \"data\":{\"NOMBRE\":\"Hector miralles\",\"DNI\":0,\"OBRA_SOCIAL\":\"\",\"NOMBRE_OBRA_SOCIAL\":\"\",\"DIRECCION\":\"\",\"TELEFONO\":0},\n  \"ERROR\": true,\n  \"ERROR_MESSAGE\": \"AÃºn faltan algunos datos: DNI, obra social, direcciÃ³n y telÃ©fono\"\n}\n\n## Caso: DNI provisto pero con puntos (\"12.345.678\")\n{\n  \"status\":\"ASK\",\n  \"ask\":\"Disculpe, necesito el DNI sin puntos. Â¿Puede enviarlo solo con nÃºmeros? Por ejemplo: 12345678\",\n  \"missing\":[\"OBRA_SOCIAL\",\"DIRECCION\",\"TELEFONO\"],\n  \"data\":{\"NOMBRE\":\"Hector miralles\",\"DNI\":0,\"OBRA_SOCIAL\":\"\",\"NOMBRE_OBRA_SOCIAL\":\"\",\"DIRECCION\":\"\",\"TELEFONO\":0},\n  \"ERROR\": true,\n  \"ERROR_MESSAGE\": \"El DNI que me pasÃ³ no es vÃ¡lido. Por favor, envÃ­eme solo los nÃºmeros, sin puntos ni espacios (ejemplo: 35946257)\"\n}\n\n## Caso: Ya tenemos nombre y DNI vÃ¡lido, pedimos obra social\n{\n  \"status\":\"ASK\",\n  \"ask\":\"Excelente. Â¿Tiene obra social o es particular?\",\n  \"missing\":[\"OBRA_SOCIAL\",\"DIRECCION\",\"TELEFONO\"],\n  \"data\":{\"NOMBRE\":\"Hector Miralles\",\"DNI\":12345678,\"OBRA_SOCIAL\":\"\",\"NOMBRE_OBRA_SOCIAL\":\"\",\"DIRECCION\":\"\",\"TELEFONO\":0},\n  \"ERROR\": true,\n  \"ERROR_MESSAGE\": \"Me faltan los siguientes datos: obra social, direcciÃ³n y telÃ©fono\"\n}\n\n## Caso: Obra social no encontrada\n{\n  \"status\":\"ASK\",\n  \"ask\":\"Disculpe, la obra social 'Medicus Plus' no figura en nuestro sistema. Â¿PodrÃ­a verificar el nombre exacto o indicarme si es particular?\",\n  \"missing\":[\"DIRECCION\",\"TELEFONO\"],\n  \"data\":{\"NOMBRE\":\"Hector Miralles\",\"DNI\":12345678,\"OBRA_SOCIAL\":\"\",\"NOMBRE_OBRA_SOCIAL\":\"\",\"DIRECCION\":\"\",\"TELEFONO\":0},\n  \"ERROR\": true,\n  \"ERROR_MESSAGE\": \"Disculpe, la obra social que mencionÃ³ no figura en nuestro sistema. Â¿PodrÃ­a verificar el nombre o indicar si es particular?\"\n}\n\n## FINAL OK (todo completo y vÃ¡lido)\n{\n  \"status\":\"FINAL\",\n  \"ask\":\"\",\n  \"missing\":[],\n  \"data\":{\"NOMBRE\":\"Hector Miralles\",\"DNI\":12345678,\"OBRA_SOCIAL\":\"1\",\"NOMBRE_OBRA_SOCIAL\":\"Ioma\",\"DIRECCION\":\"Calle 50 123\",\"TELEFONO\":2215551234},\n  \"ERROR\": false,\n  \"ERROR_MESSAGE\":\"\"\n}\n\n## Caso: Usuario envÃ­a todo junto pero direcciÃ³n incompleta\n{\n  \"status\":\"ASK\",\n  \"ask\":\"Casi listo. Me falta el nÃºmero de su direcciÃ³n. Â¿En quÃ© nÃºmero de la Calle 50 vive?\",\n  \"missing\":[\"TELEFONO\"],\n  \"data\":{\"NOMBRE\":\"Hector Miralles\",\"DNI\":12345678,\"OBRA_SOCIAL\":\"1\",\"NOMBRE_OBRA_SOCIAL\":\"Ioma\",\"DIRECCION\":\"\",\"TELEFONO\":0},\n  \"ERROR\": true,\n  \"ERROR_MESSAGE\": \"Me falta la direcciÃ³n completa. Por favor, indÃ­queme calle y nÃºmero (ejemplo: Calle 50 NÂ°123)\"\n}"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[1440,-768],"id":"7bc3533f-82bf-4710-80e2-ace4645fcfc7","name":"AI Agent"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').item.json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"*ðŸ“‹ PACIENTE REGISTRADO*\\n\\n*PARA CONTINUAR CON SU TURNO, NECESITO SU DNI:*\\n\\n*ðŸ“ FORMATO:*\\nENVÃE SOLO SU NÃšMERO DE DNI (SIN PUNTOS NI ESPACIOS)\\n\\n*EJEMPLO:*\\n_35987654_\\n\\nðŸ‘‡ *ESCRIBA SU DNI Y ENVÃELO*\"\n    },\n    \"footer\": {\n      \"text\": \"ðŸ“… LUN-VIE 8-20HS\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"volver-atras\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[128,5408],"id":"b9b59d96-da34-4ec7-bed9-613addad7db2","name":"SOLICITAR DNI PACIENTE","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"068a964d-25b6-4a1f-8e05-c47dd2fea4b7","leftValue":"={{ $json.output.ERROR }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1808,192],"id":"bd249666-e154-4709-ad33-000ad0704691","name":"Error informacion de usuario1"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').first().json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"âš ï¸ {{ $json.output.ERROR_MESSAGE }}\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2048,64],"id":"a1116436-23a5-4619-8a7f-af3986132477","name":"âš ï¸ DATOS INCORRECTOS1","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"4d4f5d9a-5ad9-495c-82f0-043f7f0ef5d6","leftValue":"={{ $json.output.esta_empadronado }}","rightValue":"verificacion_exitosa","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2256,288],"id":"2c77edc0-b826-468d-996d-7977ff89ecfb","name":"Exito1"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[1232,48],"id":"5e3b6509-06da-4397-8f7c-f744a0212ea6","name":"OpenRouter Chat Model","credentials":{"openRouterApi":{"id":"ZlcbniUoDvrFqCIJ","name":"OpenRouter ICLP"}}},{"parameters":{"jsonSchemaExample":"{  \n  \"DNI\": \"string\",  \n  \"ERROR\": false,\n  \"ERROR_MESSAGE\": \"\"\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[1648,16],"id":"85f6d85c-a5cd-4075-902e-e14f02413c2e","name":"Structured Output Parser"},{"parameters":{"promptType":"define","text":"=dni usuario :{{ $('Filter1').first().json.message }}","hasOutputParser":true,"options":{"systemMessage":"=# TAREA\n\n- Analizar el contido que llega y ordenarlo en un objeto JSON\n\n{\n  \n  \"DNI\":\"\"\n \n}\n\n# IMPORTANTE\n\n- Debes analizar si el dni esta bien escrito, debe contener entre 7 y 8 digitos ya que los usuarios mayores poseen 7 digitos y los mas actuales 8 digitos.\n- No deben contener espacios"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[1408,192],"id":"20ed0950-aab3-4d4a-b5d6-53f0b15eebc3","name":"AI Agent1"},{"parameters":{"workflowId":{"__rl":true,"value":"oB7pjyME2Gvo5moH","mode":"list","cachedResultName":"SUB - GET_PACIENTE"},"workflowInputs":{"mappingMode":"defineBelow","value":{"dni":"={{ $json.output.DNI || $('DNI').item.json.status.replace('DNI:', '') ||$('YA SE ACTIVO MENU?').item.json.status.replace('DNI:', '')  }}","telefono":"={{ $('Filter1').first().json.contactNumber }}"},"matchingColumns":["dni"],"schema":[{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"telefono","displayName":"telefono","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[2064,416],"id":"722fe48e-6556-45ce-a7dd-fe025ff01443","name":"Get_Paciente"},{"parameters":{"operation":"set","key":"=DATOS_PACIENTE:{{ $('Filter1').first().json.contactNumber }}","value":"={{ JSON.stringify($('Get_Paciente').item.json.datos) }}","expire":true,"ttl":3600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2816,128],"id":"09281e89-dad8-475a-bed6-59649bef788e","name":"DNI","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"url":"http://iclp.ddns.net:7080/ws-turnos-rest-simple/api/turnos/lista-turnos-actuales","sendQuery":true,"queryParameters":{"parameters":[{"name":"usuario","value":"WSTRRED"},{"name":"password","value":"Y2xpb25lcw"},{"name":"dni","value":"={{ $json.datos.parseJson().paciente_dni }}"},{"name":"fecha","value":"={{ $now.setZone('America/Argentina/Buenos_Aires').toFormat('yyyyLLdd') }}"}]},"options":{"response":{"response":{"neverError":true,"responseFormat":"json"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[880,7056],"id":"4d08ab18-1926-4881-a0a3-c3cdfc7b5dbc","name":"get_turnos_agendados"},{"parameters":{"assignments":{"assignments":[{"id":"8c6cf375-6158-46f1-8b42-593cf42fff40","name":"lista","value":"={{ $json.lista[0] }}","type":"object"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1104,7056],"id":"fcdac25e-0993-4541-8347-a559d1925c04","name":"datos"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.recipient_type }}"},{"name":"to","value":"={{ $json.to }}"},{"name":"type","value":"={{ $json.type }}"},{"name":"interactive","value":"={{ $json.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1552,7056],"id":"5289976d-0eec-410e-9108-1da721bcc6b1","name":"MIS TURNOS","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"url":"http://iclp.ddns.net:7080/ws-turnos-rest-simple/api/turnos/lista-turnos-actuales","sendQuery":true,"queryParameters":{"parameters":[{"name":"usuario","value":"WSTRRED"},{"name":"password","value":"Y2xpb25lcw"},{"name":"dni","value":"={{ $json.DATOS_PACIENTE.parseJson().paciente_dni }}"},{"name":"fecha","value":"={{ $now.setZone('America/Argentina/Buenos_Aires').toFormat('yyyyLLdd') }}"}]},"options":{"response":{"response":{"neverError":true,"responseFormat":"json"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2480,1552],"id":"5e3024a7-3844-492b-8b08-592cb8bb4653","name":"get_turnos_agendados1"},{"parameters":{"assignments":{"assignments":[{"id":"8c6cf375-6158-46f1-8b42-593cf42fff40","name":"lista","value":"={{ $json.lista[0] }}","type":"object"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[2720,1552],"id":"5e312f34-d38b-4a5a-b362-10990bc1ec9b","name":"datos1"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.recipient_type }}"},{"name":"to","value":"={{ $json.to }}"},{"name":"type","value":"={{ $json.type }}"},{"name":"interactive","value":"={{ $json.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3152,1552],"id":"af1d1b46-40a0-4450-898a-84d0b0490a81","name":"MIS TURNOS1","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"jsCode":"// Obtener la lista de turnos\nconst turnos = $input.all();\n\n// FunciÃ³n para validar si un turno tiene datos vÃ¡lidos\nfunction turnoValido(turno) {\n  const datos = turno.json.lista || turno.json;\n  \n  // Verificar que tenga al menos fecha y hora vÃ¡lidas\n  const tieneFecha = datos.fechaString && datos.fechaString !== 'Sin fecha' && datos.fechaString.length > 0;\n  const tieneHora = datos.hora5digitos && datos.hora5digitos !== 'Sin hora' && datos.hora5digitos.length > 0;\n  const tieneNombre = datos.nombreMedico && datos.nombreMedico !== 'Sin nombre' && datos.nombreMedico.length > 0;\n  \n  return tieneFecha && tieneHora && tieneNombre;\n}\n\n// Filtrar solo turnos vÃ¡lidos\nconst turnosValidos = turnos.filter(turnoValido);\n\n// Verificar si hay turnos vÃ¡lidos\nif (!turnosValidos || turnosValidos.length === 0) {\n  return [{\n    json: {\n      messaging_product: \"whatsapp\",\n      recipient_type: \"individual\",\n      to: $('Filter1').first().json.contactNumber,\n      type: \"interactive\",\n      interactive: {\n        type: \"button\",\n        body: {\n          text: \"âŒ NO TENÃ‰S TURNOS PROGRAMADOS EN ESTE MOMENTO\"\n        },\n        footer: {\n          text: \"ðŸ“… Lun-Vie 8-20hs\"\n        },\n        action: {\n          buttons: [\n            {\n              type: \"reply\",\n              reply: {\n                id: \"menu-principal\",\n                title: \"MENU PRINCIPAL\"\n              }\n            }\n          ]\n        }\n      }\n    }\n  }];\n}\n\n// Crear rows para la lista de turnos\nconst rows = [];\n\nfor (let i = 0; i < turnosValidos.length; i++) {\n  const turno = turnosValidos[i].json.lista || turnosValidos[i].json;\n  \n  const fechaString = turno.fechaString;\n  const hora5digitos = turno.hora5digitos;\n  const nombreMedico = turno.nombreMedico;\n  const matricula = turno.matricula || '';\n  \n  // Separar apellido del mÃ©dico y tipo de estudio\n  const partes = nombreMedico.split(' ');\n  const apellido = partes.length > 1 ? partes[partes.length - 1] : nombreMedico;\n  const tipoEstudio = partes.length > 1 ? partes.slice(0, -1).join(' ') : 'CONSULTA';\n  \n  // Formatear fecha de \"20251016\" a \"16-10-2025\"\n  let fechaFormateada = fechaString;\n  if (fechaString.length === 8) {\n    const aÃ±o = fechaString.substring(0, 4);\n    const mes = fechaString.substring(4, 6);\n    const dia = fechaString.substring(6, 8);\n    fechaFormateada = `${dia}-${mes}-${aÃ±o}`;\n  }\n  \n  // Crear title corto (mÃ¡ximo 24 caracteres)\n  let title = `${apellido}-${fechaFormateada}`;\n  if (title.length > 24) {\n    title = title.substring(0, 21) + '...';\n  }\n  \n  // Crear description (mÃ¡ximo 72 caracteres)\n  let description = `${tipoEstudio} - ${hora5digitos}`;\n  if (description.length > 72) {\n    description = description.substring(0, 69) + '...';\n  }\n  \n  // ID Ãºnico para el turno (fecha + hora + matricula)\n  const id = `turno-${fechaString}-${hora5digitos.replace(':', '')}-${matricula}`;\n  \n  rows.push({\n    id: id,\n    title: title,\n    description: description\n  });\n}\n\n// Limitar a 9 turnos mÃ¡ximo\nconst rowsLimitados = rows.slice(0, 9);\n\n// Retornar lista interactiva\nreturn [{\n  json: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: $('Filter1').first().json.contactNumber,\n    type: \"interactive\",\n    interactive: {\n      type: \"list\",\n      header: {\n        type: \"text\",\n        text: \"ðŸ—‘ï¸ CANCELAR TURNO\"\n      },\n      body: {\n        text: \"SELECCIONÃ EL TURNO QUE QUERÃ‰S CANCELAR\"\n      },\n      footer: {\n        text: \"ðŸ“… Lun-Vie 8-20hs\"\n      },\n      action: {\n        button: \"VER TURNOS\",\n        sections: [\n          {\n            title: \"TUS TURNOS\",\n            rows: rowsLimitados\n          }\n        ]\n      }\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2928,1552],"id":"6b5952c9-5e37-4732-b65d-7eb1c187c9bf","name":"ðŸš« CANCELAR TURNO"},{"parameters":{"jsCode":"// Obtener el objeto lista (que es un objeto, no un array)\nconst turno = $input.first().json.lista;\n\n// Verificar si existe el turno\nif (!turno || Object.keys(turno).length === 0) {\n  return [{\n    json: {\n      messaging_product: \"whatsapp\",\n      recipient_type: \"individual\",\n      to: $('Filter1').first().json.contactNumber,\n      type: \"interactive\",\n      interactive: {\n        type: \"button\",\n        body: {\n          text: \"âŒ NO TENÃ‰S TURNOS PROGRAMADOS EN ESTE MOMENTO\"\n        },\n        footer: {\n          text: \"ðŸ“… Lun-Vie 8-20hs\"\n        },\n        action: {\n          buttons: [\n            {\n              type: \"reply\",\n              reply: {\n                id: \"volver-atras\",\n                title: \"VOLVER ATRÃS\"\n              }\n            }\n          ]\n        }\n      }\n    }\n  }];\n}\n\n// Extraer datos del turno\nconst fechaString = turno.fechaString || 'Sin fecha'; // Ejemplo: \"20251016\"\nconst hora5digitos = turno.hora5digitos || 'Sin hora'; // Ejemplo: \"10:20\"\nconst nombreMedico = turno.nombreMedico || 'Sin nombre'; // Ejemplo: \"ERGOMETRIA BARBIERI\"\nconst matricula = turno.matricula || 'Sin matrÃ­cula'; // Ejemplo: \"139\"\n\n// Separar apellido del mÃ©dico y tipo de estudio\n// Ejemplo: \"ERGOMETRIA BARBIERI\" -> apellido=\"BARBIERI\", estudio=\"ERGOMETRIA\"\nconst partes = nombreMedico.split(' ');\nconst apellido = partes.length > 1 ? partes[partes.length - 1] : nombreMedico;\nconst tipoEstudio = partes.length > 1 ? partes.slice(0, -1).join(' ') : 'CONSULTA';\n\n// Formatear fecha de \"20251016\" a \"16-10-2025\"\nlet fechaFormateada = fechaString;\nif (fechaString.length === 8) {\n  const aÃ±o = fechaString.substring(0, 4);\n  const mes = fechaString.substring(4, 6);\n  const dia = fechaString.substring(6, 8);\n  fechaFormateada = `${dia}-${mes}-${aÃ±o}`;\n}\n\n// Construir el mensaje con formato mejorado\nconst mensajeTurnos = `ðŸ“‹ *TUS TURNOS PROGRAMADOS:*\\n\\nðŸ‘¨â€âš•ï¸ *Turno con:* Dr. ${apellido} | MatrÃ­cula ${matricula}\\nðŸ©º *Tipo de estudio:* ${tipoEstudio}\\nðŸ“… *Fecha:* ${fechaFormateada} a las ${hora5digitos}`;\n\n// Retornar el mensaje con botÃ³n\nreturn [{\n  json: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: $('Filter1').first().json.contactNumber,\n    type: \"interactive\",\n    interactive: {\n      type: \"button\",\n      body: {\n        text: mensajeTurnos\n      },\n      footer: {\n        text: \"ðŸ“… Lun-Vie 8-20hs\"\n      },\n      action: {\n        buttons: [\n          {\n            type: \"reply\",\n            reply: {\n              id: \"volver-atras\",\n              title: \"VOLVER ATRÃS\"\n            }\n          }\n        ]\n      }\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1328,7056],"id":"b91def4c-2785-4b72-bd88-74f51e9d1d15","name":"ðŸ“‹ LISTAR TURNOS"},{"parameters":{"content":"### ESPECIALIDADES","height":224,"width":976,"color":4},"type":"n8n-nodes-base.stickyNote","position":[624,2432],"typeVersion":1,"id":"7d56b0a0-81a3-4951-9901-9a1623adb5f7","name":"Sticky Note"},{"parameters":{"operation":"set","key":"=status:{{ $('Filter1').first().json.contactNumber }}","value":"ESPECIALIDADES=1","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1408,2240],"id":"0fe28302-d2c4-4c57-9474-73e7c6a3e95e","name":"ESPECIALIDADES1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.recipient_type }}"},{"name":"to","value":"={{ $json.to }}"},{"name":"type","value":"={{ $json.type }}"},{"name":"interactive","value":"={{ $json.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1184,2240],"id":"c2741235-70b0-4734-82d7-c63b42ef5a7f","name":"ðŸ©» ESPECIALIDADES1","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"jsCode":"// Obtener todas las especialidades del input\nconst items = $input.all();\n\n// Crear el array de rows dinÃ¡micamente\nconst rows = items.map(item => {\n  const especialidad = item.json.Especialidad;\n  const codigo = item.json.Codigo;\n  \n  // Convertir a mayÃºsculas\n  let nombreEspecialidad = especialidad.toUpperCase();\n  \n  // Si tiene parÃ©ntesis, tomar solo lo que estÃ¡ antes\n  if (nombreEspecialidad.includes('(')) {\n    nombreEspecialidad = nombreEspecialidad.split('(')[0].trim();\n  }\n  \n  // Si tiene barra, tomar solo la primera parte\n  if (nombreEspecialidad.includes('/')) {\n    nombreEspecialidad = nombreEspecialidad.split('/')[0].trim();\n  }\n  \n  // Si tiene mÃºltiples palabras, tomar solo la primera palabra\n  if (nombreEspecialidad.includes(' ')) {\n    nombreEspecialidad = nombreEspecialidad.split(' ')[0];\n  }\n  \n  // Crear el title con formato: ESPECIALIDAD-CODIGO\n  let title = `${nombreEspecialidad}-${codigo}`;\n  \n  // Si aÃºn es muy largo, cortar a 24 caracteres\n  if (title.length > 24) {\n    title = title.substring(0, 21) + '...';\n  }\n  \n  // Crear descripciÃ³n completa\n  let description = especialidad;\n  \n  // WhatsApp permite MÃXIMO 72 caracteres en ROW_DESCRIPTION\n  if (description.length > 72) {\n    description = description.substring(0, 69) + '...';\n  }\n  \n  return {\n    id: codigo,\n    title: title,\n    description: description\n  };\n});\n\n// Agregar botÃ³n \"VER MÃS\" al final de la lista\nrows.push({\n  id: \"ver-mas\",\n  title: \"VOLVER\",\n  description: \"VER MÃS OPCIONES Y ESPECIALIDADES DISPONIBLES\"\n});\n\n// Retornar el JSON completo con la estructura de WhatsApp\nreturn [{\n  json: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: $('Filter1').first().json.contactNumber,\n    type: \"interactive\",\n    interactive: {\n      type: \"list\",\n      header: {\n        type: \"text\",\n        text: \"ðŸ©º ESPECIALIDADES\"\n      },\n      body: {\n        text: \"*ðŸ“‹ Â¿CÃ“MO FUNCIONA?*\\n\\n*1ï¸âƒ£ ELEGÃ LA ESPECIALIDAD*\\nPRESIONÃ EL BOTÃ“N Y SELECCIONÃ LA ESPECIALIDAD MÃ‰DICA QUE NECESITÃS\\n\\n*2ï¸âƒ£ ELEGÃ EL MÃ‰DICO*\\nLUEGO PODRÃS VER Y SELECCIONAR LOS PROFESIONALES DISPONIBLES EN ESA ESPECIALIDAD\\n\\nðŸ‘‡ *PRESIONÃ PARA COMENZAR*\"\n      },\n      footer: {\n        text: \"ðŸ“… LUN-VIE 8-20HS\"\n      },\n      action: {\n        button: \"VER ESPECIALIDADES\",\n        sections: [\n          {\n            title: \"ELEGIR UNA OPCIÃ“N\",\n            rows: rows\n          }\n        ]\n      }\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[960,2240],"id":"c2c4ea81-52c4-4d33-86a4-1c3344626f19","name":"LISTA1"},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"mi8p2u7tvuplzt5","limit":3,"options":{"sort":{"property":[{"field":"Especialidad","direction":"desc"}]}}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[736,2240],"id":"20127626-779d-44c8-9e69-855b0892a2af","name":"Get_Especialidades1","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"content":"###  VER MAS ESPECIALIDADES","height":224,"width":976,"color":5},"type":"n8n-nodes-base.stickyNote","position":[624,2176],"typeVersion":1,"id":"a39a01d6-a941-46bb-b072-b90b797ede73","name":"Sticky Note1"},{"parameters":{"workflowId":{"__rl":true,"value":"gsbUq8JFSpw8U7yR","mode":"list","cachedResultName":"Etiqueta_Consulta_Reclamo"},"workflowInputs":{"mappingMode":"defineBelow","value":{"humano":true,"accountId":"={{ $('Filter1').first().json.accountId }}","conversationId":"={{ $('Filter1').item.json.conversationId.toString() }}","contactId":"={{ $('Filter1').item.json.contactId.toString() }}","message":"={{ $('Filter1').item.json.message }}","inboxId":"={{ $('Filter1').item.json.inboxId.toString() }}","chatwootUrlBase":"={{ $('Filter1').item.json.chatwootUrl }}","tokenChatwoot":"={{ $('Filter1').item.json.agenteBotTokenWhatsapp }}","tipoIntencion":"consultas-reclamos"},"matchingColumns":[],"schema":[{"id":"accountId","displayName":"accountId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"conversationId","displayName":"conversationId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"contactId","displayName":"contactId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"message","displayName":"message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"inboxId","displayName":"inboxId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"humano","displayName":"humano","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"boolean"},{"id":"chatwootUrlBase","displayName":"chatwootUrlBase","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"tokenChatwoot","displayName":"tokenChatwoot","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"tipoIntencion","displayName":"tipoIntencion","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[928,1344],"id":"8e002130-aa37-453b-b157-d62ae4e5d264","name":"ETIQUETA CONSULTA-RECLAMO"},{"parameters":{"workflowId":{"__rl":true,"value":"xBZYzq5pKXYbUGV7","mode":"list","cachedResultName":"SUB - Etiqueta_Turno_Estudio"},"workflowInputs":{"mappingMode":"defineBelow","value":{"humano":true,"accountId":"={{ $('Filter1').item.json.accountId }}","conversationId":"={{ $('Filter1').item.json.conversationId.toString() }}","contactId":"={{ $('Filter1').item.json.contactId.toString() }}","message":"={{ $('Filter1').item.json.message }}","inboxId":"={{ $('Filter1').item.json.inboxId.toString() }}","chatwootUrlBase":"={{ $('Filter1').item.json.chatwootUrl }}","tokenChatwoot":"={{ $('Filter1').item.json.agenteBotTokenWhatsapp }}","tipoIntencion":"turnos-estudios"},"matchingColumns":[],"schema":[{"id":"accountId","displayName":"accountId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"conversationId","displayName":"conversationId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"contactId","displayName":"contactId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"message","displayName":"message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"inboxId","displayName":"inboxId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"humano","displayName":"humano","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"boolean"},{"id":"chatwootUrlBase","displayName":"chatwootUrlBase","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"tokenChatwoot","displayName":"tokenChatwoot","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"tipoIntencion","displayName":"tipoIntencion","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[928,1760],"id":"212d74fa-bb27-4c86-b3ec-73fbcd553d85","name":"TURNOS ESTUDIO"},{"parameters":{"operation":"set","key":"=CODIGO_ESPECIALIDAD:{{ $('Filter1').first().json.contactNumber }}","value":"={{ $('Filter1').first().json.message }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3728,4080],"id":"698567a5-63aa-44bd-a7b7-9883c75491e6","name":"ESPECIALIDAD-USADO PARA VOLVER ATRAS","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"medicos_volver_atras","key":"=CODIGO_ESPECIALIDAD:{{ $('Filter1').first().json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[208,3648],"id":"1662d64c-2028-4923-94db-fb0f1d5163e5","name":"get_codigo_especialidad","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=DATOS_MEDICO:{{ $('Filter1').item.json.contactNumber }}","value":"={{ JSON.stringify($('datos1').item.json.lista) }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3408,1552],"id":"91ffd616-9af4-404c-81e6-949de1d014e5","name":"Datos turnos","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"delete","key":"=DATOS_MEDICO:{{ $('Filter1').first().json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2208,1872],"id":"8fd1a1cb-be93-45e8-bdac-1835c7ca8079","name":"Redis1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').item.json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"âœ… *TURNO CANCELADO EXITOSAMENTE*\\n\\nðŸ—“ï¸ Tu turno ha sido cancelado correctamente.\\n\\nðŸ“‹ *Detalles de la cancelaciÃ³n:*\\nâ€¢ MÃ©dico: Dr./Dra. {{ $json.nombreMedico }}\\nâ€¢ Fecha: {{ $json.fecha }}\\nâ€¢ Hora: {{ $json.hora }}hs\\n\\nðŸ’¡ *Â¿NecesitÃ¡s reagendar?*\\nPodÃ©s solicitar un nuevo turno cuando lo necesites.\\n\\n*TambiÃ©n podÃ©s contactarnos:*\\nâ€¢ TelÃ©fono: (0221) 4906310\\nâ€¢ Horarios: Lunes a Viernes 8:00-20:00hs\\n\\nÂ¡Esperamos verte pronto! â¤ï¸\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2752,1872],"id":"bb8c9524-6b29-426f-81d4-f1b83ff1fd6e","name":"ðŸš« TURNO-CANCELADO","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"jsCode":"// Parsear el JSON que viene como string\nconst deleteData = JSON.parse($('Redis1').item.json.delete);\n\n// Convertir fecha Unix (milisegundos) a formato legible DD/MM/YYYY\nconst fechaUnix = deleteData.fecha;\nconst fechaObj = new Date(fechaUnix);\nconst dia = String(fechaObj.getDate()).padStart(2, '0');\nconst mes = String(fechaObj.getMonth() + 1).padStart(2, '0'); // Los meses empiezan en 0\nconst aÃ±o = fechaObj.getFullYear();\nconst fechaLegible = `${dia}/${mes}/${aÃ±o}`;\n\n// Convertir hora de \"1540\" a \"15:40\"\nconst horaString = deleteData.hora;\nconst horaLegible = horaString.slice(0, 2) + ':' + horaString.slice(2);\n\n// Retornar todos los datos formateados\nreturn [{\n  json: {\n    matricula: deleteData.matricula,\n    fechaOriginal: deleteData.fecha,\n    fecha: fechaLegible, // \"14/11/2025\"\n    horaOriginal: deleteData.hora,\n    hora: horaLegible, // \"15:40\"\n    horasDigitos: deleteData.horasDigitos,\n    fechaString: deleteData.fechaString,\n    nombreMedico: deleteData.nombreMedico,\n    nombrePaciente: deleteData.nombrePaciente,\n    celular: deleteData.celular,\n    especialidad: deleteData.especialidad,\n    dni: deleteData.dni,\n    obraSocial: deleteData.obraSocial\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2576,1872],"id":"cbff37b1-d093-41d4-9e77-0124db3c201e","name":"Code3"},{"parameters":{"operation":"delete","key":"=status:{{ $('Filter1').item.json.contactNumber }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2928,1872],"id":"256876e8-b5d3-45c2-80c3-56e0d61102a4","name":"DELETE - STATUS MENU2","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').item.json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"ðŸ•’ *HORARIO DE ATENCIÃ“N*\\n\\nðŸ“… *Nuestros horarios son:*\\nâ€¢ Lunes a Viernes: 08:00 - 20:00hs\\nâ€¢ SÃ¡bados: 08:00 - 13:00hs\\nâ€¢ Domingos: CERRADO\\n\\nðŸ“ž *Contacto:*\\nTelÃ©fono: (0221) 4906310\\n\\nÂ¡Te esperamos! ðŸ’™\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[928,2688],"id":"fb66135e-23b6-4962-b8c6-bebca49da95a","name":"HORARIOS","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').item.json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": true,\n    \"body\": \"ðŸ“ *UBICACIÃ“N*\\n\\nðŸ¥ *INSTITUTO DE CARDIOLOGÃA LA PLATA*\\n\\nðŸ“Œ *DirecciÃ³n:*\\nCalle 6 NÂ°212 (entre 36 y 37)\\nLa Plata, Buenos Aires\\n\\nðŸ—ºï¸ *Ver en Google Maps:*\\nhttps://maps.app.goo.gl/ij23zZscf3vTKQV56\\n\\nðŸ“ž *TelÃ©fono:*\\n(0221) 4906310\\n\\nÂ¡Te esperamos! ðŸ’š\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[928,3136],"id":"6b28583e-de42-4df8-ac61-377240a978aa","name":"UBICACION","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').item.json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": true,\n    \"body\": \"ðŸ’» *PORTAL DEL PACIENTE*\\n\\nðŸŒ *Acceso:*\\nwww.iclp.com.ar â†’ \\\"PORTAL PACIENTES\\\"\\n\\nðŸ” *Tus datos de acceso:*\\nâ€¢ Usuario: [TU DNI] (sin puntos)\\nâ€¢ ContraseÃ±a: p + Ãºltimos 5 nÃºmeros del DNI\\n\\nðŸ“ *Ejemplo:*\\nDNI 12345678 â†’ ContraseÃ±a: p45678\\n\\nÂ¿NecesitÃ¡s ayuda? Â¡Contactanos! ðŸ’™\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[928,3584],"id":"86a5922b-aaaf-473a-b9eb-889251a36962","name":"PORTAL GENERAL","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').item.json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"ðŸ’Š *RECETAS MÃ‰DICAS*\\n\\nâœ¨ Â¡Te explico cÃ³mo pedir tus recetas!\\n\\nðŸ“§ *MANERA MÃS FÃCIL - POR EMAIL*\\nâœ‰ï¸ Correo: recetas@iclpsrl.com.ar\\n\\nðŸ“ *Envianos:*\\nâ€¢ Apellido y nombre\\nâ€¢ Obra social\\nâ€¢ NÃºmero de afiliado\\nâ€¢ Nombre del mÃ©dico\\n\\nðŸš¨ *ATENCIÃ“N ESPECIAL - Dr. FabiÃ¡n Barba*\\nðŸ“² Sus recetas solo por WhatsApp:\\n2216810260\\n\\nÂ¿NecesitÃ¡s ayuda? Â¡Estamos para ayudarte! ðŸ’š\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[928,4032],"id":"138d65fb-d029-4c7c-bea6-1b7ce493fe36","name":"EMAIL RECETAS","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').first().json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": {{ JSON.stringify($json.mensaje) }}\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3168,3520],"id":"f4051845-0051-42f9-a4f8-794fac196f17","name":"ESPECIALIDADES2","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=datos_recolectados:{{ $('Filter1').first().json.contactNumber }}","value":"={{ JSON.stringify($('AI Agent').item.json.output) }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2768,-992],"id":"c9bec719-e559-47ad-83e7-2528c6e55827","name":"DATOS RECOLECTADOS","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ðŸ«€ ICLP - GESTIÃ“N DE TURNOS\"\n    },\n    \"body\": {\n      \"text\": \"*HOLA {{ $json.output.paciente_nombre }} âœ…*\\n\\n*ðŸ“‹ SUS DATOS EN NUESTRO SISTEMA:*\\n\\nðŸ‘¤ *NOMBRE:* *{{ $json.output.paciente_nombre }}*\\n\\nðŸ†” *DNI:* *{{ $json.output.paciente_dni }}*\\n\\nðŸ“ž *TELÃ‰FONO:* *{{ $json.output.paciente_celular }}*\\n\\nâœ… *SI LOS DATOS SON CORRECTOS, PRESIONE CONTINUAR*\\n\\nâš ï¸ *Â¿HAY ALGÃšN ERROR?*\\nCOMUNÃQUESE CON ADMINISTRACIÃ“N:\\nðŸ“ž (0221) 490-6310\"\n    },\n    \"footer\": {\n      \"text\": \"ðŸ“… LUN-VIE 8-20HS\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"CONTINUAR\",\n            \"title\": \"CONTINUAR\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"MENU-PRINCIPAL\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2560,128],"id":"bfbbc8e5-1735-4c49-8b1f-19ab2f6322ca","name":"âœ… DATOS VALIDADOS2","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"m1kjf7ed0befl04","returnAll":true,"options":{}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[896,192],"id":"504ef504-77b9-4bb7-9bec-ed599a221b3d","name":"obra_social","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"m1kjf7ed0befl04","returnAll":true,"options":{}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[928,-768],"id":"b7cf73f6-5325-40e1-89e5-4cfc874be9bc","name":"obrasociales","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"jsCode":"return {\n    total: $input.all().length,\n    obrasociales: $input.all().map(item => ({\n        Id_os: item.json.Id,\n        nombre_obrasocial: item.json.nombre_obrasocial,\n        obrasocial: item.json.obrasocial\n    }))\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1152,-768],"id":"7f53c341-befe-4351-be22-90e152827b69","name":"Code6"},{"parameters":{"jsCode":"return {\n    total: $input.all().length,\n    obrasociales: $input.all().map(item => ({\n        Id_os: item.json.Id,\n        nombre_obrasocial: item.json.nombre_obrasocial,\n        obrasocial: item.json.obrasocial\n    }))\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1120,192],"id":"6c930f5a-47e8-4736-8e6e-f81f64e34303","name":"Code7"},{"parameters":{"jsonSchemaExample":"{\n  \"NOMBRE\": \"Juan PÃ©rez\",\n  \"DNI\": 0,\n  \"OBRA_SOCIAL\": \"724\",\n  \"NOMBRE_OBRA_SOCIAL\": \"Osde\",\n  \"DIRECCION\": \"Calle 50 N 123\",\n  \"TELEFONO\": 2215551234,\n  \"ERROR\": true,\n  \"ERROR_MESSAGE\": \"DNI invÃ¡lido. Debe tener 7 u 8 dÃ­gitos sin puntos (ej: 12345678). Por favor, proporcionÃ¡ tu DNI sin puntos.\"\n}","autoFix":true},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[1664,-560],"id":"84d062aa-fcb4-4605-93e1-7efd33660479","name":"Structured Output Parser1"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ðŸ«€ ICLP - GESTIÃ“N DE TURNOS\"\n    },\n    \"body\": {\n      \"text\": \"ðŸ«€ *Â¡PERFECTO!*\\n\\nAL PARECER YA ESTÃ REGISTRADO EN NUESTRO SISTEMA.\\n\\nðŸ’“ *SUS DATOS REGISTRADOS:*\\n\\nðŸ‘¤ NOMBRE: {{ $('AI Agent').first().json.output.NOMBRE.toUpperCase() }}\\nðŸ†” DNI:{{ $json.datos.paciente_dni }} \\nðŸ“ž TELÃ‰FONO:{{ $json.datos.paciente_celular }} \\nðŸ©º OBRA SOCIAL: {{ $json.datos.nombre_obrasocial }}\\n\\nâœ… SI LOS DATOS SON CORRECTOS, PRESIONE CONTINUAR PARA GESTIONAR SU TURNO CARDIOLÃ“GICO\\n\\nâš ï¸ Â¿DETECTÃ“ ALGÃšN ERROR?\\nCOMUNÃQUESE CON ADMINISTRACIÃ“N:\\nðŸ“ž (0221) 490-6310\"\n    },\n    \"footer\": {\n      \"text\": \"ðŸ«€ ICLP - LUN-VIE 8-20HS\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"CONTINUAR\",\n            \"title\": \"CONTINUAR\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"MENU-PRINCIPAL\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2752,-672],"id":"c437791d-a5d6-4696-aab8-ce8b457c3bea","name":"âœ… DATOS VALIDADOS3","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Filter1').first().json.contactNumber }}","sessionTTL":600,"contextWindowLength":10},"type":"@n8n/n8n-nodes-langchain.memoryRedisChat","typeVersion":1.5,"position":[1504,-416],"id":"b14bb5bf-fc29-47fb-b90f-8f4b3d996000","name":"Redis Chat Memory","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"content":"## INFO GENERAL - MEDICOS","height":304,"width":992,"color":4},"type":"n8n-nodes-base.stickyNote","position":[2624,3088],"typeVersion":1,"id":"9911530f-9072-4fbe-9c25-fc845264e6ec","name":"Sticky Note2"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').first().json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": {{ JSON.stringify($json.mensaje) }}\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3152,3168],"id":"984ffc40-7670-4088-8b1b-1dc34c62559c","name":"MEDICOS","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"jsCode":"// Obtener todos los mÃ©dicos\nconst items = $input.all();\n\n// Crear un objeto para agrupar mÃ©dicos por especialidad\nconst medicosPorEspecialidad = {};\n\nitems.forEach(item => {\n  const medico = item.json.Medico;\n  const especialidad = item.json.Especialidad;\n  \n  if (!medicosPorEspecialidad[especialidad]) {\n    medicosPorEspecialidad[especialidad] = [];\n  }\n  \n  // Evitar duplicados\n  if (!medicosPorEspecialidad[especialidad].includes(medico)) {\n    medicosPorEspecialidad[especialidad].push(medico);\n  }\n});\n\n// Ordenar especialidades alfabÃ©ticamente\nconst especialidadesOrdenadas = Object.keys(medicosPorEspecialidad).sort();\n\n// Crear el listado formateado\nlet listadoMedicos = '';\nespecialidadesOrdenadas.forEach(especialidad => {\n  listadoMedicos += `\\nðŸ“Œ *${especialidad}*\\n`;\n  \n  // Ordenar mÃ©dicos alfabÃ©ticamente\n  const medicos = medicosPorEspecialidad[especialidad].sort();\n  \n  medicos.forEach(medico => {\n    listadoMedicos += `   â€¢ Dr./Dra. ${medico}\\n`;\n  });\n});\n\n// Crear el mensaje completo con las nuevas instrucciones\nconst mensaje = `ðŸ‘¨â€âš•ï¸ *NUESTROS PROFESIONALES*\\n\\nðŸ¥ *CONTAMOS CON LOS SIGUIENTES MÃ‰DICOS ESPECIALISTAS:*${listadoMedicos}\\n\\nðŸ“ž *CONTACTO:*\\n(0221) 4906310\\nLUNES A VIERNES: 8:00-20:00HS`;\n\n// Mensaje para botÃ³n interactivo\nconst mensajeBoton = `ðŸ“‹ IR AL MENÃš PRINCIPAL O DIRECTAMENTE SACAR TURNO`;\n\n// Retornar el resultado en JSON\nreturn [{\n  json: {\n    listadoMedicos: listadoMedicos.trim(),\n    mensaje: mensaje,\n    mensajeBoton: mensajeBoton,\n    medicosPorEspecialidad: medicosPorEspecialidad,\n    totalEspecialidades: especialidadesOrdenadas.length,\n    totalMedicos: items.length,\n    // Estructura completa para mensaje interactivo\n    interactive_body: mensajeBoton,\n    interactive_button_id: \"menu_principal\",\n    interactive_button_title: \"MENU PRINCIPAL\"\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2928,3168],"id":"9dd9fb8a-048c-40e5-8da8-f38a5f8b7714","name":"Msg preparado"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').item.json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ðŸ«€ INSTITUTO DE CARDIOLOGÃA LA PLATA\"\n    },\n    \"body\": {\n      \"text\": \"ðŸ“‹ PARA SACAR UN TURNO, SELECCIONÃ:\\n\\nðŸ†• NUEVO PACIENTE\\nâ†’ Si es tu primera vez\\n\\nðŸ‘¤ PACIENTE REGISTRADO\\nâ†’ Si ya tenÃ©s historial con nosotros\\n\\nðŸ  MENÃš PRINCIPAL\\nâ†’ Ver horarios, ubicaciÃ³n y mÃ¡s info\"\n    },\n    \"footer\": {\n      \"text\": \"LUN-VIE 8-20HS\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"primera-vez\",\n            \"title\": \"NUEVO PACIENTE\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"ya-atendido\",\n            \"title\": \"PACIENTE REGISTRADO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"volver-atras\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-2864,240],"id":"c47aa3e9-8477-4578-9117-e995edd4833a","name":"ðŸ“… Turnos - PACIENTE NUEVO - PACIENTE REGISTRADO - ","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"mhwp4qt6r2d7ymm","returnAll":true,"options":{}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[2704,3168],"id":"da3d701c-6c86-4726-b588-9e89975c59c3","name":"get_medicos1","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"mi8p2u7tvuplzt5","returnAll":true,"options":{}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[2720,3520],"id":"37bab11e-dbe9-4891-a15c-1946677dc6b0","name":"get_especialidades","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"jsCode":"// Obtener todas las especialidades\nconst items = $input.all();\n\n// Extraer las especialidades y eliminar duplicados\nconst especialidades = [...new Set(items.map(item => item.json.Especialidad))];\n\n// Ordenar alfabÃ©ticamente\nespecialidades.sort();\n\n// Crear el listado formateado para WhatsApp\nconst listadoEspecialidades = especialidades\n  .map((esp, index) => `${index + 1}. ${esp.toUpperCase()}`)\n  .join('\\n');\n\n// Crear el mensaje completo en mayÃºsculas\nconst mensaje = `ðŸ¥ *ESPECIALIDADES DISPONIBLES*\\n\\nðŸ“‹ *CONTAMOS CON LAS SIGUIENTES ESPECIALIDADES:*\\n\\n${listadoEspecialidades}\\n\\nðŸ‘‡ *PRESIONE SI QUIERE SACAR UN TURNO Y SIGA LAS INDICACIONES*\\n\\nðŸ“ž *CONTACTO:*\\n(0221) 4906310\\nLUNES A VIERNES: 8:00-20:00HS`;\n\n// Mensaje para botÃ³n interactivo\nconst mensajeBoton = `ðŸ“‹ SACAR UN TURNO O IR AL  MENU PRINCIPAL`;\n\n// Retornar tanto el array como el mensaje\nreturn [{\n  json: {\n    especialidades: especialidades,\n    total: especialidades.length,\n    listadoEspecialidades: listadoEspecialidades,\n    mensaje: mensaje,\n    mensajeBoton: mensajeBoton,\n    // Estructura completa para mensaje interactivo\n    interactive_body: mensajeBoton,\n    interactive_button_id: \"menu_principal\",\n    interactive_button_title: \"MENU PRINCIPAL\"\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2944,3520],"id":"4da6dd0e-50de-4db5-ac4a-af6dc9111a4b","name":"Msg preparado1"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"{{ $('Msg preparado1').item.json.mensajeBoton }}\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"sacar_turno\",\n            \"title\": \"TOMAR TURNO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"menu_principal\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3376,3520],"id":"2ac3f3ff-d36d-44b5-80b6-2342c6a197ee","name":"ENVIA-> MENU-SACAR TURNO","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"{{ $('Msg preparado').item.json.mensajeBoton }}\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"sacar_turno\",\n            \"title\": \"TOMAR TURNO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"menu_principal\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3360,3168],"id":"021fdebf-9fc8-425d-b46c-301264c9a4e2","name":"ENVIA-> MENU-SACAR TURNO1","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"content":"## INFO GENERAL - ESPECIALIDADES","height":304,"width":992,"color":5},"type":"n8n-nodes-base.stickyNote","position":[2624,3424],"typeVersion":1,"id":"7586acf2-7fec-46f0-b58c-dda0bd240655","name":"Sticky Note3"},{"parameters":{"operation":"delete","key":"5492254596618"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-5680,4704],"id":"85a3494b-5bd1-40ab-8a12-7f4b02a86836","name":"DELETE - DATOS=2","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"={{ $('Filter1').first().json.contactNumber }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3008,-672],"id":"21f749fa-4c7a-4a33-b561-feca2126c0a5","name":"ðŸ¤– RESET AGENTE","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ðŸ«€ ICLP - GESTIÃ“N DE TURNOS\"\n    },\n    \"body\": {\n      \"text\": \"*ðŸ“‹ GESTIÃ“N DE TURNOS*\\n\\n*Â¿QUÃ‰ DESEA HACER?*\\n\\n*ðŸ“… TOMAR TURNO*\\nâ†’ AGENDAR UNA NUEVA CONSULTA CON NUESTROS ESPECIALISTAS\\n\\n*âŒ CANCELAR TURNO*\\nâ†’ ANULAR UN TURNO YA PROGRAMADO\\n\\n*ðŸ“ MIS TURNO/S*\\nâ†’ VER SUS PRÃ“XIMAS CITAS AGENDADAS\\n\\nðŸ‘‡ *SELECCIONE UNA OPCIÃ“N PARA CONTINUAR*\"\n    },\n    \"footer\": {\n      \"text\": \"ðŸ“… LUN-VIE 8-20HS\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"tomar-turno\",\n            \"title\": \"TOMAR TURNO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"cancelar-turno\",\n            \"title\": \"CANCELAR TURNO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"mis-turnos\",\n            \"title\": \"MIS TURNO/S\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[848,6720],"id":"1e19d401-92e4-486d-abab-b3ad8d831f70","name":"TOMAR TURNO","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"delete","key":"=status:{{ $('Filter1').first().json.contactNumber }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-2624,224],"id":"6a6cf03b-3a7c-499f-a07f-22e6bd728b99","name":"Redis2","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Filter1').first().json.contactNumber }}","value":"MENU=1","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-2384,224],"id":"33076e8e-dde9-4fb6-b89f-7ffe58a2039c","name":"â±ï¸ STATUS MENU2","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').first().json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"âš ï¸ {{ $json.output.ERROR_MESSAGE }}\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-3328,5328],"id":"900c0463-5352-4e2b-98e4-7a7f18138975","name":"âš ï¸ DATOS INCORRECTOS2","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"4d4f5d9a-5ad9-495c-82f0-043f7f0ef5d6","leftValue":"={{ $json.output.esta_empadronado }}","rightValue":"verificacion_exitosa","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2960,5728],"id":"78112a9d-7981-41e4-87f8-2518c4f74a03","name":"Exito2"},{"parameters":{"workflowId":{"__rl":true,"value":"oB7pjyME2Gvo5moH","mode":"list","cachedResultName":"SUB - GET_PACIENTE"},"workflowInputs":{"mappingMode":"defineBelow","value":{"dni":"={{ $('Filter1').first().json.message }}","telefono":"={{ $('Filter1').item.json.contactNumber.slice(1) }}"},"matchingColumns":["dni"],"schema":[{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"telefono","displayName":"telefono","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[2752,5728],"id":"80a27b54-fc4d-489e-b6ab-17b00ff2ece6","name":"Get_Paciente1"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ðŸ«€ ICLP - GESTIÃ“N DE TURNOS\"\n    },\n    \"body\": {\n      \"text\": \"*HOLA {{ $json.output.paciente_nombre }} âœ…*\\n\\n*ðŸ“‹ SUS DATOS EN NUESTRO SISTEMA:*\\n\\nðŸ‘¤ *NOMBRE:* *{{ $json.output.paciente_nombre }}*\\n\\nðŸ†” *DNI:* *{{ $json.output.paciente_dni }}*\\n\\nðŸ“ž *TELÃ‰FONO:* *{{ $json.output.paciente_celular }}*\\n\\nâœ… *SI LOS DATOS SON CORRECTOS, PRESIONE CONTINUAR*\\n\\nâš ï¸ *Â¿HAY ALGÃšN ERROR?*\\nCOMUNÃQUESE CON ADMINISTRACIÃ“N:\\nðŸ“ž (0221) 490-6310\"\n    },\n    \"footer\": {\n      \"text\": \"ðŸ“… LUN-VIE 8-20HS\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"CONTINUAR\",\n            \"title\": \"CONTINUAR\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"MENU-PRINCIPAL\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3152,5456],"id":"81e540cf-cbc0-4185-92cd-b03d46546e68","name":"âœ… DATOS VALIDADOS4","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').first().json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"âŒ *LO SENTIMOS*\\n\\nEL DNI QUE NOS PROPORCIONÃ“ NO SE ENCUENTRA REGISTRADO EN NUESTRO SISTEMA.\\n\\nâœ… *Â¿QUÃ‰ PUEDE HACER?*\\n\\n*1ï¸âƒ£ VERIFIQUE EL DNI*\\nASEGÃšRESE DE HABERLO INGRESADO CORRECTAMENTE (SIN PUNTOS NI ESPACIOS)\\n\\n*2ï¸âƒ£ REGÃSTRESE COMO NUEVO PACIENTE*\\nSI ES SU PRIMERA VEZ, VUELVA AL MENÃš PRINCIPAL Y SELECCIONE LA OPCIÃ“N *NUEVO PACIENTE* PARA COMPLETAR SU REGISTRO\\n\\nðŸ“ž *Â¿NECESITA AYUDA?*\\nCOMUNÃQUESE CON ADMINISTRACIÃ“N:\\n(0221) 490-6310\\nLUN-VIE 8-20HS\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3248,5808],"id":"1f9a9c8f-6b20-4efb-97b8-3efe44046e59","name":"âœ… DATOS VALIDADOS1","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[1776,-384],"id":"1cdf9e22-bc29-405f-918e-95ef59e9ba04","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"mE1IL02M9AnIg3tD","name":"OpenAi Credenciales ICLP"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c8df2d50-2e61-4b46-b8a5-bbdefbb98378","leftValue":"={{ $json.codigo === 'VOLVER' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1216,3376],"id":"626eab42-70d0-4bf1-b38f-8b264e8fbb54","name":"If"},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"mhwp4qt6r2d7ymm","limit":9,"options":{"fields":[],"where":"=(Codigo,eq,{{ $json?.codigo }})&limit=9&offset=0&sort=Medico"}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[1600,3696],"id":"b483d529-22e9-472e-955c-b2c3763b57dd","name":"get_medicos2","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.recipient_type }}"},{"name":"to","value":"={{ $json.to }}"},{"name":"type","value":"={{ $json.type }}"},{"name":"interactive","value":"={{ $json.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2032,3680],"id":"bb201c0e-b24a-415f-b561-10418dbb2671","name":"Medicos1","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Filter1').first().json.contactNumber }}","value":"MEDICOS=1","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2256,3680],"id":"dd67e078-3dce-49d6-ad31-57e3af607947","name":"ðŸ©º MEDICOS2","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"// Obtener todos los mÃ©dicos del input\nconst items = $input.all();\n\n// Crear el array de rows dinÃ¡micamente\nconst rows = items.map(item => {\n  const medico = item.json.Medico;\n  const matricula = item.json.Matricula;\n  \n  // Convertir a mayÃºsculas\n  let nombreMedico = medico.toUpperCase();\n  \n  // Si tiene parÃ©ntesis, tomar solo lo que estÃ¡ antes\n  if (nombreMedico.includes('(')) {\n    nombreMedico = nombreMedico.split('(')[0].trim();\n  }\n  \n  // Si tiene barra, tomar solo la primera parte\n  if (nombreMedico.includes('/')) {\n    nombreMedico = nombreMedico.split('/')[0].trim();\n  }\n  \n  // Si tiene mÃºltiples palabras, tomar solo la primera palabra\n  if (nombreMedico.includes(' ')) {\n    nombreMedico = nombreMedico.split(' ')[0];\n  }\n  \n  // Crear el title con formato: NOMBRE-MATRICULA\n  let title = `${nombreMedico}-${matricula}`;\n  \n  // Si aÃºn es muy largo, cortar a 24 caracteres\n  if (title.length > 24) {\n    title = title.substring(0, 21) + '...';\n  }\n  \n  // Crear descripciÃ³n completa en mayÃºsculas\n  let description = medico.toUpperCase();\n  \n  // WhatsApp permite MÃXIMO 72 caracteres en ROW_DESCRIPTION\n  if (description.length > 72) {\n    description = description.substring(0, 69) + '...';\n  }\n  \n  return {\n    id: matricula,\n    title: title,\n    description: description\n  };\n});\n\n// Solo agregar \"VER MÃS\" si hay 9 o mÃ¡s mÃ©dicos\nif (items.length >= 9) {\n  rows.push({\n    id: \"ver-mas\",\n    title: \"VER MAS\",\n    description: \"VER LISTA COMPLETA DE MÃ‰DICOS\"\n  });\n}\n\n// Retornar el JSON completo con la estructura de WhatsApp\nreturn [{\n  json: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: $('Filter1').first().json.contactNumber,\n    type: \"interactive\",\n    interactive: {\n      type: \"list\",\n      header: {\n        type: \"text\",\n        text: \"ðŸ©º PROFESIONALES DISPONIBLES\"\n      },\n      body: {\n        text: `*âœ… ENCONTRAMOS ${items.length} MÃ‰DICO${items.length > 1 ? 'S' : ''} PARA TU ESPECIALIDAD*\\n\\n*ðŸ‘‡ SELECCIONÃ EL PROFESIONAL CON QUIEN QUERÃ‰S AGENDAR TU TURNO:*`\n      },\n      footer: {\n        text: \"ðŸ’¡ TOCÃ EL BOTÃ“N PARA VER LA LISTA\"\n      },\n      action: {\n        button: \"VER MÃ‰DICOS\",\n        sections: [\n          {\n            title: \"ðŸ‘¨â€âš•ï¸ SELECCIONAR MÃ‰DICO\",\n            rows: rows\n          }\n        ]\n      }\n    }\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1808,3680],"id":"bbee8ce2-f803-4d6d-82d7-fa6966783df7","name":"ðŸ©º LISTA-MEDICOS 1"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.multimedia }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true},"id":"e7a9ef75-11df-4262-8ec0-c63644980c5e"}],"combinator":"and"},"renameOutput":true,"outputKey":"tieneMultimedia"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"839f4006-0caa-456b-b044-28ae16cd1ab4","leftValue":"={{ $json.humano }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"tieneHumano"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"579505b2-6063-4333-9c73-476c450aee99","leftValue":"={{ $json.message }}","rightValue":"Texto","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"tieneTexto"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-6032,1920],"id":"ca1121ab-5727-4b76-9fa1-dfa81f7902c7","name":"Switch"},{"parameters":{"workflowId":{"__rl":true,"value":"5yeTNub4mGFgBUpp","mode":"list","cachedResultName":"SUB - POST_PACIENTE"},"workflowInputs":{"mappingMode":"defineBelow","value":{"dni":"={{ $json.output.DNI.toString() }}","paciente":"={{ $json.output.NOMBRE }}","direccion":"={{ $json.output.DIRECCION }}","celular":"={{ $json.output.TELEFONO.toString() }}","obraSocial":"={{ $json.output.OBRA_SOCIAL }}","nombreobrasocial":"={{ $json.output.NOMBRE_OBRA_SOCIAL }}"},"matchingColumns":[],"schema":[{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"paciente","displayName":"paciente","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"direccion","displayName":"direccion","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"celular","displayName":"celular","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"obraSocial","displayName":"obraSocial","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"nombreobrasocial","displayName":"nombreobrasocial","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[2512,-672],"id":"b7a655bd-dc30-4aaf-8416-448eaa7cb500","name":"POST_PACIENTE"},{"parameters":{"operation":"get","propertyName":"status","key":"=status:{{ $json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-5200,1872],"id":"1448d219-5e32-4449-9635-da96223e8f89","name":"YA SE ACTIVO MENU?","retryOnFail":false,"credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}},"onError":"continueRegularOutput"},{"parameters":{"workflowId":{"__rl":true,"value":"54erSSiJNvNSRnpK","mode":"list","cachedResultName":"SUB - DELETE TURNO"},"workflowInputs":{"mappingMode":"defineBelow","value":{"matricula":"={{ $json.delete.parseJson().matricula }}","fecha":"={{ $json.delete.parseJson().fechaString.toNumber() }}","hora":"={{ $json.delete.parseJson().hora.toNumber() }}","num_conver":"={{ $('Filter1').first().json.conversationId }}"},"matchingColumns":[],"schema":[{"id":"matricula","displayName":"matricula","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"fecha","displayName":"fecha","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"hora","displayName":"hora","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"num_conver","displayName":"num_conver","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[2400,1872],"id":"fe64d250-80bb-4d1c-93bc-e4f1262ff95d","name":"DELETE_TURNO"},{"parameters":{"operation":"set","key":"=DNI:{{ $('Filter1').first().json.contactNumber.replace('+','') }}","value":"={{ $('MENU PRINCIPAL').item.json.status }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1088,6720],"id":"cd7ced84-a798-4c58-a592-6e91af45176d","name":"SET_DNI_TOMAR_TURNOS","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"content":"###  ELIMINAR UN TURNO","height":224,"width":976,"color":3},"type":"n8n-nodes-base.stickyNote","position":[2128,1808],"typeVersion":1,"id":"7a5c0ffc-f5f0-4670-87d5-7a0573fe119a","name":"Sticky Note5"},{"parameters":{"operation":"set","key":"=DATOS_PACIENTE:{{ $('Filter1').first().json.contactNumber.replace('+','') }}","value":"={{ JSON.stringify($json.datos) }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3632,5456],"id":"129f45d7-08e9-4423-b36c-9ea3fb94b88d","name":"SET_DNI_PACIENTE","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"DNI:5492254596618"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-5472,4704],"id":"2fa7f6a7-8655-4be2-aaa1-f1d03faf0a20","name":"DELETE - DATOS=3","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-4128,3008],"id":"853e68d7-a870-4ff1-a6d2-1a0ac73404d6","name":"ETIQUETA_ESTUDIO"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filter1').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ðŸ«€ INSTITUTO DE CARDIOLOGÃA LA PLATA\"\n    },\n    \"body\": {\n      \"text\": \"Recuerda que MOMENTÃNEAMENTE SOLO DAMOS LOS TURNOS MÃS PRÃ“XIMOS\\n\\nSi necesita una fecha mÃ¡s lejana elija la opciÃ³n de administraciÃ³n\"\n    },\n    \"footer\": {\n      \"text\": \"ðŸ“… Lun-Vie 8-20hs\"\n    },\n    \"action\": {\n      \"buttons\": [\n              {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"con-consultorio\",\n            \"title\": \"TURNOS CONSULTORIO\"\n          }\n        },\n      {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"con-estudio\",\n            \"title\": \"TURNOS ESTUDIO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"volver-atras\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-3744,3664],"id":"0eb827bc-9b85-44ee-beaf-f19e2edcc599","name":"MENU->TURNOS_CONSULTORIO_TURNOS_ESTUDIO","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"content":"## CONFIRMAR TURNO\n\n### Enviar la lista con los datos para tomar el turno si el usuario confirma\n- Nombre\n- Dni\n- Matricula medico\n- Fecha en formatoc linux\n- Hora\n- Celular","height":432,"width":1584,"color":4},"type":"n8n-nodes-base.stickyNote","position":[1904,4336],"typeVersion":1,"id":"82f35166-cf92-40f8-a14d-540dc92c116e","name":"Sticky Note6"},{"parameters":{"content":"## CREA EL TURNO","height":352,"width":1584,"color":5},"type":"n8n-nodes-base.stickyNote","position":[1904,4784],"typeVersion":1,"id":"58c1d107-73d8-4a6d-943d-95794d22a964","name":"Sticky Note7"},{"parameters":{"assignments":{"assignments":[{"id":"fe76c493-88c1-40e2-8d17-9e4faf2e8b37","name":"datos.paciente_nombre","value":"={{ $('Get_Paciente1').item.json.output.paciente_nombre }}","type":"string"},{"id":"9e8c2882-9d49-445c-8fc5-61daa8298a3a","name":"datos.paciente_dni","value":"={{ $('Get_Paciente1').item.json.output.paciente_dni }}","type":"number"},{"id":"feb578dd-9449-4b4f-b273-151283f73b16","name":"datos.paciente_celular","value":"={{ $('Get_Paciente1').item.json.output.paciente_celular }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[3392,5456],"id":"e3f23771-3d1e-4431-a901-a679fda1c5d8","name":"datos_paciente"},{"parameters":{"operation":"get","propertyName":"=Datos","key":"=DATOS_PACIENTE:{{ $('Filter1').item.json.contactNumber.replace('+', '') }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2160,4576],"id":"658f0c00-69ea-4b88-a89e-5d7e781bfa58","name":"DATOS_PACIENTE","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"=Datos","key":"=DATOS_PACIENTE:{{ $('Filter1').item.json.contactNumber }}","keyType":"=automatic","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2160,4080],"id":"85a4e9bc-c9f4-4282-b0af-cf3b0eff96d1","name":"DATOS_PACIENTE:","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"content":"## SELECCIONAMOS EL MEDICO","height":336,"width":2080},"type":"n8n-nodes-base.stickyNote","position":[1904,3984],"typeVersion":1,"id":"8437a08f-0f7f-4972-bb40-03f66bbad7c4","name":"Sticky Note8"},{"parameters":{"operation":"get","propertyName":"DATOS_PACIENTE","key":"=DATOS_PACIENTE:{{ $('Filter1').item.json.contactNumber.replace('+', '') }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2240,1552],"id":"89d44aa1-d184-4202-8133-28d4f866995b","name":"DATOS_PACIENTE1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"content":"###  MUESTRA LAS FECHAS A ELIMINAR SI EXISTEN","height":224,"width":1696,"color":3},"type":"n8n-nodes-base.stickyNote","position":[2128,1504],"typeVersion":1,"id":"f755e0e2-82ad-4858-ac5e-44a6e64e847a","name":"Sticky Note9"},{"parameters":{"operation":"set","key":"=status:{{ $('Filter1').item.json.contactNumber }}","value":"CANCELAR-TURNO","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3616,1552],"id":"7699ab9b-269b-4172-a304-a74962a50b50","name":"STATUS=CANCELAR-TURNO","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=DATOS_PACIENTE:{{ $('Filter1').first().json.contactNumber }}","value":"={{ JSON.stringify($('POST_PACIENTE').item.json.datos) }}","expire":true,"ttl":3600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3248,-672],"id":"a1e5dcb4-bce2-47bb-8c89-7d60e2d7dd72","name":"DATOS_PACIENTE REGISTRADO","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Filter1').first().json.contactNumber}}","value":"PACIENTE_NUEVO","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3456,-672],"id":"5f7858f7-a36b-40ea-8137-0353fcaa727f","name":"STATUS=PACIENTE_NUEVO","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Filter1').item.json.contactNumber }}","value":"TURNOS_CONSULTORIO=1","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3504,3680],"id":"a363cd95-9ccf-45f0-8cc5-34efb6b6296e","name":"STATUS:MENU=1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"datos","key":"=DATOS_PACIENTE:{{ $('Filter1').item.json.contactNumber.replace('+', '') }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[640,7056],"id":"b05067d4-f909-4bb8-a2bc-f4f664e9202a","name":"GET_PACIENTE","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"mhwp4qt6r2d7ymm","returnAll":true,"options":{"fields":[]}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[2048,2528],"id":"b5c324f1-2497-465d-8189-c15219ade6f9","name":"get_medicos3","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}}],"connections":{"Filtrar nÃºmeros de prueba":{"main":[[{"node":"variables","type":"main","index":0}]]},"variables":{"main":[[{"node":"Switch","type":"main","index":0}]]},"Filter1":{"main":[[{"node":"YA SE ACTIVO MENU?","type":"main","index":0}]]},"Entrada":{"main":[[{"node":"Execution Data1","type":"main","index":0},{"node":"Filtrar nÃºmeros de prueba","type":"main","index":0}]]},"Primera vez INS.":{"main":[[{"node":"â±ï¸ STATUS PRIMERA VEZ","type":"main","index":0}]]},"When clicking â€˜Execute workflowâ€™":{"main":[[{"node":"DELETE - STATUS MENU","type":"main","index":0},{"node":"DELETE - STATUS MENU1","type":"main","index":0}]]},"ðŸ¢ AdministraciÃ³n":{"main":[[{"node":"â±ï¸ STATUS MENU","type":"main","index":0}]]},"Menu Principal = MENU=1":{"main":[[{"node":"â±ï¸ STATUS MENU1","type":"main","index":0}]]},"DELETE - STATUS MENU":{"main":[[{"node":"DELETE - CONTADOR","type":"main","index":0}]]},"DELETE - CONTADOR":{"main":[[{"node":"DELETE - DATOS=2","type":"main","index":0}]]},"Error informacion de usuario":{"main":[[{"node":"âš ï¸ DATOS INCORRECTOS","type":"main","index":0}],[{"node":"POST_PACIENTE","type":"main","index":0}]]},"âš ï¸ DATOS INCORRECTOS":{"main":[[{"node":"DATOS RECOLECTADOS","type":"main","index":0}]]},"ðŸ©» ESPECIALIDADES":{"main":[[{"node":"ESPECIALIDADES","type":"main","index":0}]]},"LISTA":{"main":[[{"node":"ðŸ©» ESPECIALIDADES","type":"main","index":0}]]},"Get_Especialidades":{"main":[[{"node":"LISTA","type":"main","index":0}]]},"Code1":{"main":[[{"node":"If","type":"main","index":0}]]},"get_medicos":{"main":[[{"node":"ðŸ©º LISTA-MEDICOS ","type":"main","index":0}]]},"Code":{"main":[[{"node":"ðŸ“… Horarios Proximos","type":"main","index":0}]]},"Medicos":{"main":[[{"node":"ðŸ©º MEDICOS","type":"main","index":0}]]},"MENU PRINCIPAL":{"main":[[{"node":"ðŸ“… Turnos - PACIENTE NUEVO - PACIENTE REGISTRADO - ","type":"main","index":0}],[{"node":"â„¹ï¸ Info General","type":"main","index":0}],[{"node":"ðŸ¢ AdministraciÃ³n","type":"main","index":0}],[{"node":"Menu Principal = MENU=1","type":"main","index":0}],[{"node":"ETIQUETA CONSULTA-RECLAMO","type":"main","index":0}],[{"node":"Menu Principal = MENU=1","type":"main","index":0}],[{"node":"ðŸ“… Turnos - PACIENTE NUEVO - PACIENTE REGISTRADO - ","type":"main","index":0}],[{"node":"Menu Principal = MENU=1","type":"main","index":0}],[{"node":"obrasociales","type":"main","index":0}],[{"node":"Get_Especialidades","type":"main","index":0}],[{"node":"Primera vez INS.","type":"main","index":0}],[{"node":"obrasociales","type":"main","index":0}],[{"node":"get_codigo_especialidad","type":"main","index":0}],[{"node":"DATOS_PACIENTE:","type":"main","index":0}],[{"node":"DATOS_PACIENTE","type":"main","index":0}],[{"node":"Datos para confirmar turno1","type":"main","index":0}],[{"node":"SOLICITAR DNI PACIENTE","type":"main","index":0}],[{"node":"obra_social","type":"main","index":0}],[{"node":"GET_PACIENTE","type":"main","index":0}],[{"node":"Get_Paciente","type":"main","index":0},{"node":"Get_Especialidades","type":"main","index":0}],[{"node":"DATOS_PACIENTE1","type":"main","index":0}],[{"node":"Menu Principal = MENU=1","type":"main","index":0}],[{"node":"MENU->TURNOS_CONSULTORIO_TURNOS_ESTUDIO","type":"main","index":0}],[{"node":"Get_Especialidades","type":"main","index":0}],[{"node":"Get_Especialidades1","type":"main","index":0}],[{"node":"Get_Especialidades","type":"main","index":0}],[{"node":"Get_Paciente","type":"main","index":0}],[{"node":"TURNOS ESTUDIO","type":"main","index":0}],[{"node":"DATOS_PACIENTE:","type":"main","index":0}],[{"node":"Redis1","type":"main","index":0}],[{"node":"Menu Principal = MENU=1","type":"main","index":0}],[{"node":"HORARIOS","type":"main","index":0}],[{"node":"UBICACION","type":"main","index":0}],[{"node":"PORTAL GENERAL","type":"main","index":0}],[{"node":"EMAIL RECETAS","type":"main","index":0}],[{"node":"get_medicos1","type":"main","index":0}],[{"node":"get_especialidades","type":"main","index":0}],[{"node":"TOMAR TURNO","type":"main","index":0}],[{"node":"Menu Principal = MENU=1","type":"main","index":0}],[{"node":"MENU->TURNOS_CONSULTORIO_TURNOS_ESTUDIO","type":"main","index":0}],[{"node":"ðŸ“… Turnos - PACIENTE NUEVO - PACIENTE REGISTRADO - ","type":"main","index":0}],[{"node":"Menu Principal = MENU=1","type":"main","index":0}],[{"node":"Get_Paciente1","type":"main","index":0}],[{"node":"MENU->TURNOS_CONSULTORIO_TURNOS_ESTUDIO","type":"main","index":0}],[{"node":"ETIQUETA_ESTUDIO","type":"main","index":0}],[{"node":"MENU->TURNOS_CONSULTORIO_TURNOS_ESTUDIO","type":"main","index":0}],[{"node":"TOMAR TURNO","type":"main","index":0}],[{"node":"MENU->TURNOS_CONSULTORIO_TURNOS_ESTUDIO","type":"main","index":0}],[{"node":"Redis1","type":"main","index":0}],[{"node":"TOMAR TURNO","type":"main","index":0}],[{"node":"MENU->TURNOS_CONSULTORIO_TURNOS_ESTUDIO","type":"main","index":0}],[{"node":"Get_Especialidades","type":"main","index":0}],[{"node":"GET_PACIENTE","type":"main","index":0}],[{"node":"TURNOS ESTUDIO","type":"main","index":0}],[{"node":"Menu Principal = MENU=1","type":"main","index":0}],[{"node":"Redis1","type":"main","index":0}]]},"ðŸ“… Horarios Proximos":{"main":[[{"node":"ðŸ• LISTA-HORARIOS","type":"main","index":0}]]},"ðŸ• Fechas disponibles ":{"main":[[{"node":"ðŸ©º MEDICOS1","type":"main","index":0}]]},"ðŸ• LISTA-HORARIOS":{"main":[[{"node":"ðŸ• Fechas disponibles ","type":"main","index":0}]]},"ðŸ©º LISTA-MEDICOS ":{"main":[[{"node":"Medicos","type":"main","index":0}]]},"ðŸ©º MEDICOS1":{"main":[[{"node":"Matricula medico","type":"main","index":0}]]},"OpenRouter Chat Model2":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"Code2":{"main":[[{"node":"Datos para confirmar turno","type":"main","index":0}]]},"Matricula medico":{"main":[[{"node":"ESPECIALIDAD-USADO PARA VOLVER ATRAS","type":"main","index":0}]]},"MATRICULA":{"main":[[{"node":"Code2","type":"main","index":0}]]},"ðŸ“… Confirmar turno":{"main":[[{"node":"Redis","type":"main","index":0}]]},"Datos para confirmar turno":{"main":[[{"node":"ðŸ“… Confirmar turno","type":"main","index":0}]]},"Datos para confirmar turno1":{"main":[[{"node":"EJECUTAR TURNO","type":"main","index":0}]]},"EJECUTAR TURNO":{"main":[[]]},"DELETE - STATUS MENU1":{"main":[[{"node":"DELETE - CONTADOR1","type":"main","index":0}]]},"DELETE - CONTADOR1":{"main":[[{"node":"DELETE - DATOS=","type":"main","index":0}]]},"AI Agent":{"main":[[{"node":"Error informacion de usuario","type":"main","index":0}]]},"SOLICITAR DNI PACIENTE":{"main":[[]]},"Error informacion de usuario1":{"main":[[{"node":"âš ï¸ DATOS INCORRECTOS1","type":"main","index":0}],[{"node":"Get_Paciente","type":"main","index":0}]]},"Exito1":{"main":[[{"node":"âœ… DATOS VALIDADOS2","type":"main","index":0}],[]]},"OpenRouter Chat Model":{"ai_languageModel":[[{"node":"AI Agent1","type":"ai_languageModel","index":0}]]},"Structured Output Parser":{"ai_outputParser":[[{"node":"AI Agent1","type":"ai_outputParser","index":0}]]},"AI Agent1":{"main":[[{"node":"Error informacion de usuario1","type":"main","index":0}]]},"Get_Paciente":{"main":[[{"node":"Exito1","type":"main","index":0}]]},"get_turnos_agendados":{"main":[[{"node":"datos","type":"main","index":0}]]},"datos":{"main":[[{"node":"ðŸ“‹ LISTAR TURNOS","type":"main","index":0}]]},"get_turnos_agendados1":{"main":[[{"node":"datos1","type":"main","index":0}]]},"datos1":{"main":[[{"node":"ðŸš« CANCELAR TURNO","type":"main","index":0}]]},"MIS TURNOS1":{"main":[[{"node":"Datos turnos","type":"main","index":0}]]},"ðŸš« CANCELAR TURNO":{"main":[[{"node":"MIS TURNOS1","type":"main","index":0}]]},"ðŸ“‹ LISTAR TURNOS":{"main":[[{"node":"MIS TURNOS","type":"main","index":0}]]},"ðŸ©» ESPECIALIDADES1":{"main":[[{"node":"ESPECIALIDADES1","type":"main","index":0}]]},"LISTA1":{"main":[[{"node":"ðŸ©» ESPECIALIDADES1","type":"main","index":0}]]},"Get_Especialidades1":{"main":[[{"node":"LISTA1","type":"main","index":0}]]},"ETIQUETA CONSULTA-RECLAMO":{"main":[[]]},"get_codigo_especialidad":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Redis1":{"main":[[{"node":"DELETE_TURNO","type":"main","index":0}]]},"ðŸš« TURNO-CANCELADO":{"main":[[{"node":"DELETE - STATUS MENU2","type":"main","index":0}]]},"Code3":{"main":[[{"node":"ðŸš« TURNO-CANCELADO","type":"main","index":0}]]},"âœ… DATOS VALIDADOS2":{"main":[[{"node":"DNI","type":"main","index":0}]]},"obra_social":{"main":[[{"node":"Code7","type":"main","index":0}]]},"obrasociales":{"main":[[{"node":"Code6","type":"main","index":0}]]},"Code6":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"Code7":{"main":[[{"node":"AI Agent1","type":"main","index":0}]]},"Structured Output Parser1":{"ai_outputParser":[[{"node":"AI Agent","type":"ai_outputParser","index":0}]]},"Redis Chat Memory":{"ai_memory":[[{"node":"AI Agent","type":"ai_memory","index":0},{"node":"AI Agent1","type":"ai_memory","index":0}]]},"MEDICOS":{"main":[[{"node":"ENVIA-> MENU-SACAR TURNO1","type":"main","index":0}]]},"Msg preparado":{"main":[[{"node":"MEDICOS","type":"main","index":0}]]},"ESPECIALIDADES2":{"main":[[{"node":"ENVIA-> MENU-SACAR TURNO","type":"main","index":0}]]},"get_medicos1":{"main":[[{"node":"Msg preparado","type":"main","index":0}]]},"get_especialidades":{"main":[[{"node":"Msg preparado1","type":"main","index":0}]]},"Msg preparado1":{"main":[[{"node":"ESPECIALIDADES2","type":"main","index":0}]]},"âœ… DATOS VALIDADOS3":{"main":[[{"node":"ðŸ¤– RESET AGENTE","type":"main","index":0}]]},"ðŸ“… Turnos - PACIENTE NUEVO - PACIENTE REGISTRADO - ":{"main":[[{"node":"Redis2","type":"main","index":0}]]},"Redis2":{"main":[[{"node":"â±ï¸ STATUS MENU2","type":"main","index":0}]]},"Exito2":{"main":[[{"node":"âœ… DATOS VALIDADOS4","type":"main","index":0}],[{"node":"âœ… DATOS VALIDADOS1","type":"main","index":0}]]},"Get_Paciente1":{"main":[[{"node":"Exito2","type":"main","index":0}]]},"âœ… DATOS VALIDADOS4":{"main":[[{"node":"datos_paciente","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"Structured Output Parser1","type":"ai_languageModel","index":0}]]},"If":{"main":[[{"node":"get_medicos","type":"main","index":0}],[{"node":"get_medicos2","type":"main","index":0}]]},"get_medicos2":{"main":[[{"node":"ðŸ©º LISTA-MEDICOS 1","type":"main","index":0}]]},"Medicos1":{"main":[[{"node":"ðŸ©º MEDICOS2","type":"main","index":0}]]},"ðŸ©º LISTA-MEDICOS 1":{"main":[[{"node":"Medicos1","type":"main","index":0}]]},"ðŸ©º MEDICOS2":{"main":[[]]},"ðŸ¤– RESET AGENTE":{"main":[[{"node":"DATOS_PACIENTE REGISTRADO","type":"main","index":0}]]},"Switch":{"main":[[],[],[{"node":"Filter1","type":"main","index":0}]]},"TOMAR TURNO":{"main":[[{"node":"SET_DNI_TOMAR_TURNOS","type":"main","index":0}]]},"POST_PACIENTE":{"main":[[{"node":"âœ… DATOS VALIDADOS3","type":"main","index":0}]]},"YA SE ACTIVO MENU?":{"main":[[{"node":"MENU PRINCIPAL","type":"main","index":0}]]},"DELETE_TURNO":{"main":[[{"node":"Code3","type":"main","index":0}]]},"DELETE - DATOS=2":{"main":[[{"node":"DELETE - DATOS=3","type":"main","index":0}]]},"datos_paciente":{"main":[[{"node":"SET_DNI_PACIENTE","type":"main","index":0}]]},"DATOS_PACIENTE":{"main":[[{"node":"MATRICULA","type":"main","index":0}]]},"DATOS_PACIENTE:":{"main":[[{"node":"Code","type":"main","index":0}]]},"DATOS_PACIENTE1":{"main":[[{"node":"get_turnos_agendados1","type":"main","index":0}]]},"Datos turnos":{"main":[[{"node":"STATUS=CANCELAR-TURNO","type":"main","index":0}]]},"DATOS_PACIENTE REGISTRADO":{"main":[[{"node":"STATUS=PACIENTE_NUEVO","type":"main","index":0}]]},"MENU->TURNOS_CONSULTORIO_TURNOS_ESTUDIO":{"main":[[{"node":"STATUS:MENU=1","type":"main","index":0}]]},"GET_PACIENTE":{"main":[[{"node":"get_turnos_agendados","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","timezone":"America/Argentina/Buenos_Aires","callerPolicy":"workflowsFromSameOwner","errorWorkflow":"6dh84HOwd5HeezOI"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"GET_PACIENTE":[{"json":{"datos":"{\"paciente_nombre\":\"FERNANDO\",\"paciente_dni\":35946257,\"paciente_celular\":\"5492254596618\"}"}}],"Entrada":[{"json":{"headers":{"host":"hooks.autoclinicas.com","user-agent":"rest-client/2.1.0 (linux-musl x86_64) ruby/3.4.4p34","content-length":"2161","accept":"application/json","accept-encoding":"gzip;q=1.0,deflate;q=0.6,identity;q=0.3","content-type":"application/json","x-forwarded-for":"206.81.1.93","x-forwarded-host":"hooks.autoclinicas.com","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"f2c799d0c305","x-real-ip":"206.81.1.93"},"params":{},"query":{},"body":{"additional_attributes":{},"can_reply":true,"channel":"Channel::Whatsapp","contact_inbox":{"id":11730,"contact_id":6099,"inbox_id":13,"source_id":"5492254596618","created_at":"2025-10-06T23:09:25.001Z","updated_at":"2025-10-06T23:09:25.001Z","hmac_verified":false,"pubsub_token":"72kqoh9Mvmbyd7NJRvsQTtnR"},"id":8775,"inbox_id":13,"messages":[{"id":122056,"content":"COSTA-118604","account_id":2,"inbox_id":13,"conversation_id":8775,"message_type":0,"created_at":1761573748,"updated_at":"2025-10-27T14:02:28.487Z","private":false,"status":"sent","source_id":"wamid.HBgNNTQ5MjI1NDU5NjYxOBUCABIYFjNFQjA2MkI1QTZFNTkyOUM0OEE3MDgA","content_type":"text","content_attributes":{"in_reply_to_external_id":null,"in_reply_to":null},"sender_type":"Contact","sender_id":6099,"external_source_ids":{},"additional_attributes":{},"processed_message_content":"COSTA-118604","sentiment":{},"conversation":{"assignee_id":null,"unread_count":10,"last_activity_at":1761573748,"contact_inbox":{"source_id":"5492254596618"}},"sender":{"additional_attributes":{"city":"","country":"","description":"","company_name":"","country_code":"","social_profiles":{}},"custom_attributes":{},"email":null,"id":6099,"identifier":null,"name":"Fer ðŸ¤–","phone_number":"+5492254596618","thumbnail":"","blocked":false,"type":"contact"}}],"labels":[],"meta":{"sender":{"additional_attributes":{"city":"","country":"","description":"","company_name":"","country_code":"","social_profiles":{}},"custom_attributes":{},"email":null,"id":6099,"identifier":null,"name":"Fer ðŸ¤–","phone_number":"+5492254596618","thumbnail":"","blocked":false,"type":"contact"},"assignee":null,"team":{"id":1,"name":"recepcionistas"},"hmac_verified":false},"status":"open","custom_attributes":{"bot":false,"humano":false},"snoozed_until":null,"unread_count":10,"first_reply_created_at":"2025-10-25T12:14:54.160Z","priority":null,"waiting_since":1761559110,"agent_last_seen_at":1761565085,"contact_last_seen_at":0,"last_activity_at":1761573748,"timestamp":1761573748,"created_at":1761240928,"updated_at":1761573748.4900422,"applied_sla":null,"sla_events":[],"sla_policy_id":null,"event":"automation_event.message_created"},"webhookUrl":"https://hooks.autoclinicas.com/webhook/agentes/v1/iclp","executionMode":"production"}}]},"versionId":"a6309f01-57e4-4d5f-81e0-6520eb433548","triggerCount":1,"shared":[{"createdAt":"2025-10-10T02:39:42.609Z","updatedAt":"2025-10-10T02:39:42.609Z","role":"workflow:owner","workflowId":"1odVZzIrLtoo46xh","projectId":"R66ikVn5xqf0nYcA"}],"tags":[{"createdAt":"2025-10-18T05:48:24.047Z","updatedAt":"2025-10-18T05:48:24.047Z","id":"9MPkCQDvT4HFCUIK","name":"ClinicAI-v1.33"}]}