{"createdAt":"2025-08-16T02:50:34.286Z","updatedAt":"2025-08-17T00:10:46.418Z","id":"7Cr0OKX3gXeSAJgS","name":"Base_Conocimiento_ICLP ðŸ¥µ","active":false,"isArchived":false,"nodes":[{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[-260,-2220],"id":"d4260567-7b74-44a8-be0d-ac57d77711ab","name":"When clicking â€˜Execute workflowâ€™"},{"parameters":{"url":"={{ $json.url_chatwoot }}api/v1/accounts/{{ $json.account_id }}/conversations","sendQuery":true,"queryParameters":{"parameters":[{"name":"inbox_id","value":"={{ $json.inbox_id }}"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $json.token_chatwoot }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[180,-2220],"id":"19cbef70-2200-4f32-8906-dffa40bf1f58","name":"HTTP Request"},{"parameters":{"assignments":{"assignments":[{"id":"24741f09-dd98-4a8d-a7a2-7fb32279aac1","name":"url_chatwoot","value":"https://chatw.automatizaciones.ai/","type":"string"},{"id":"c796ec74-8b65-4543-88d2-4b2957e15729","name":"account_id","value":"2","type":"string"},{"id":"6a6b1f81-034a-4911-9300-62aa259b4555","name":"inbox_id","value":"1","type":"string"},{"id":"1080a846-bda0-4715-8e1b-a6816731ee99","name":"token_chatwoot","value":"JFi43nzvEPDBCaxaFrkhVvdM","type":"string"},{"id":"f13c253a-864b-40b7-a495-6f945014951a","name":"identificador_bandeja","value":"ziqBX44T7qsqhqeGx1n7Vipj","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-40,-2220],"id":"22fb78ad-9380-4209-929f-29d4570045b7","name":"set_de_campos"},{"parameters":{"fieldToSplitOut":"data.payload","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[400,-2220],"id":"03e052d8-1afb-485f-b26d-e33f2ad9400a","name":"Split Out"},{"parameters":{"maxItems":100},"type":"n8n-nodes-base.limit","typeVersion":1,"position":[620,-2220],"id":"2f8daf2a-ea6e-499d-b057-a2a286ae382f","name":"Limit"},{"parameters":{"url":"={{ $('set_de_campos').item.json.url_chatwoot }}public/api/v1/inboxes/{{ $('set_de_campos').item.json.identificador_bandeja }}/contacts/{{ $json.last_non_activity_message.conversation.contact_inbox.source_id }}/conversations/{{ $json.id }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('set_de_campos').item.json.token_chatwoot }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1060,-2220],"id":"ff52b0bf-4d6c-45b4-a1ca-97823321c4ed","name":"HTTP Request1"},{"parameters":{"fieldToSplitOut":"messages","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[1280,-2220],"id":"a78737d5-da73-4555-873a-46c919bd5499","name":"Split Out1"},{"parameters":{"assignments":{"assignments":[{"id":"f2275391-9217-483f-9660-8fc8c5e59371","name":"content","value":"={{ $json.message_type === 0 ? 'Paciente: ' + $json.content : 'Recepcionista: ' + $json.content }}","type":"string"},{"id":"553c8af8-b5d5-41d8-9a03-3b011d6eefef","name":"message_type","value":"={{ $json.message_type }}","type":"number"},{"id":"2a54cdc1-854c-43bc-8ade-0c185bc5f59b","name":"sender_identifier","value":"={{ $json.sender.identifier }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1720,-2220],"id":"7b97bbe5-1858-4b95-ba7c-a6cfcc55a15f","name":"Edit Fields","disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"6924cd77-f055-4b34-a4cd-8ce1ac32eda5","leftValue":"={{ $json.message_type }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1940,-2220],"id":"4cf505e8-4ad9-4270-a97b-f91327d741da","name":"If","disabled":true},{"parameters":{"aggregate":"aggregateAllItemData","destinationFieldName":"Conversacion","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[2160,-2220],"id":"98e1b39c-a71b-4ac9-9028-03aba181ef8d","name":"Aggregate"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[840,-2220],"id":"01e70be2-788a-4df8-828d-3fb843f56635","name":"Loop Over Items"},{"parameters":{"assignments":{"assignments":[{"id":"8518b976-bd4c-481c-a758-d4d9618f26e7","name":"Rol","value":"={{ $json.message_type === 0 ? \"Paciente\" : \"Recepcionista\" }}","type":"string"},{"id":"228102dd-c590-4455-8ada-afe3029d16cb","name":"Mensaje","value":"={{ $json.content }}","type":"string"},{"id":"6dc2f8ea-64f0-4e7f-a96a-5c9eb826d27b","name":"NumeroPaciente","value":"={{ $json.sender.type === \"contact\" ? $json.sender.phone_number : \"\" }}","type":"string"},{"id":"f486dccb-7c1d-48d6-abe2-067e3394e95e","name":"Nombre","value":"={{ $json.sender.name }}","type":"string"},{"id":"97c3fa3e-4045-4670-a85c-3ee5e197316b","name":"FechaHora","value":"={{ new Date($json.created_at * 1000).toISOString() }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1500,-2220],"id":"2fee6557-9fcc-43ff-b401-1c945befee4f","name":"formateo_rol"},{"parameters":{"model":"google/gemini-2.5-flash","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[2360,-1940],"id":"4bd24660-7046-4be6-911b-77977c6144b7","name":"OpenRouter Chat Model","credentials":{"openRouterApi":{"id":"ZlcbniUoDvrFqCIJ","name":"OpenRouter ICLP"}}},{"parameters":{"promptType":"define","text":"={{ $json.Conversacion }}","messages":{"messageValues":[{"message":"=Tu tarea es analizar una conversaciÃ³n de Chatwoot y devolver SIEMPRE un ARRAY JSON de objetos vÃ¡lidos (sin fences ```).\n\nREGLAS CLAVE (estrictas):\n- Prohibido devolver bloques con ``` o â€œ```jsonâ€. Devuelve SOLO JSON plano.\n- Ignora SIEMPRE el mensaje automÃ¡tico que empieza con \"**Gracias por comunicarte con Instituto de CardiologÃ­a La Plata**\".\n- Si no encaja en nada Ãºtil, devuelve [].\n\nCLASES Y CAMPOS PERMITIDOS\n\n1) INTENCION_TURNO\n{\n  \"tipo\": \"INTENCION_TURNO\",\n  \"mensaje\": \"Texto completo del paciente\",\n  \"nombre\": \"Nombre o null\",\n  \"telefono\": \"NÃºmero o null\"\n}\n\n2) PATRON_TURNO (CONSULTAS con mÃ©dico o especialidad)\n{\n  \"tipo\": \"PATRON_TURNO\",\n  \"consulta_o_estudio\": \"CONSULTA\",\n  \"nombre\": \"Nombre o null\",\n  \"dni\": \"XXXXXXXX o null\",\n  \"obra_social\": \"Nombre o null\",\n  \"telefono\": \"NÃºmero o null\",\n  \"medico_o_especialidad\": \"Nombre del mÃ©dico o especialidad\"\n}\nRegla: en PATRON_TURNO, NUNCA usar la palabra â€œEstudio(s)â€ en medico_o_especialidad.\n\n3) PATRON_ESTUDIO (estudios: holter, MAPA, ecografÃ­a, ergometrÃ­a, eco doppler, etc.)\n{\n  \"tipo\": \"PATRON_ESTUDIO\",\n  \"consulta_o_estudio\": \"ESTUDIO\",\n  \"nombre\": \"Nombre o null\",\n  \"dni\": \"XXXXXXXX o null\",\n  \"obra_social\": \"Nombre o null\",\n  \"telefono\": \"NÃºmero o null\",\n  \"medico_o_especialidad\": null,\n  \"estudio_detalle\": \"Nombre del estudio (si se mencionÃ³) o null\"\n}\nReglas:\n- JAMÃS rellenar medico_o_especialidad con â€œEstudioâ€ o â€œEstudiosâ€.\n- Si el paciente solo dice â€œEstudio/Estudiosâ€ sin detalle, usa \"estudio_detalle\": null.\n- Si el paciente menciona el estudio (ej: â€œEcodoppler cardÃ­acoâ€), colÃ³calo en â€œestudio_detalleâ€.\n\n4) CONSULTA_RECLAMO (obras sociales, Ã³rdenes mÃ©dicas, reclamos)\n{\n  \"tipo\": \"CONSULTA_RECLAMO\",\n  \"pregunta\": \"Texto original del paciente\"\n}\n\n5) FAQ (pregunta-respuesta general Ãºtil: horarios, portal, etc.)\n{\n  \"tipo\": \"FAQ\",\n  \"pregunta\": \"Pregunta clara del paciente\",\n  \"respuesta\": \"Respuesta final y correcta de la recepcionista\"\n}\n\nMULTISALIDA: si aparecen varios casos (p. ej. CONSULTA_RECLAMO + FAQ), devuelve varios objetos en el mismo array.\n\nEJEMPLOS\n\nEntrada:\n{ \"Rol\": \"Paciente\", \"Mensaje\": \"Hola buenas tardes querÃ­a pedir un turno\", \"NumeroPaciente\": \"+5492216438599\", \"Nombre\": \"Yamila\" }\nSalida:\n[\n  {\n    \"tipo\": \"INTENCION_TURNO\",\n    \"mensaje\": \"Hola buenas tardes querÃ­a pedir un turno\",\n    \"nombre\": \"Yamila\",\n    \"telefono\": \"+5492216438599\"\n  }\n]\n\nEntrada:\n\"Lucero ArgandoÃ±a\\n19035700\\nMedicus\\n2214978733\\n147 1157\\nEstudio\"\nSalida:\n[\n  {\n    \"tipo\": \"PATRON_ESTUDIO\",\n    \"consulta_o_estudio\": \"ESTUDIO\",\n    \"nombre\": \"Lucero ArgandoÃ±a\",\n    \"dni\": \"19035700\",\n    \"obra_social\": \"Medicus\",\n    \"telefono\": \"2214978733\",\n    \"medico_o_especialidad\": null,\n    \"estudio_detalle\": null\n  }\n]\n\nEntrada:\n\"Nicolas Gonzalez Capriata\\n36572311\\nSwiss Medical\\n2216111040\\nECOESTRES con ejercicio. Ecodoppler cardÃ­aco color y Doppler color de vasos del cuello\"\nSalida:\n[\n  {\n    \"tipo\": \"PATRON_ESTUDIO\",\n    \"consulta_o_estudio\": \"ESTUDIO\",\n    \"nombre\": \"Nicolas Gonzalez Capriata\",\n    \"dni\": \"36572311\",\n    \"obra_social\": \"Swiss Medical\",\n    \"telefono\": \"2216111040\",\n    \"medico_o_especialidad\": null,\n    \"estudio_detalle\": \"ECOESTRES con ejercicio. Ecodoppler cardÃ­aco color y Doppler color de vasos del cuello\"\n  }\n]\n\nEntrada:\n\"Atienden por PAMI?\"\nRespuesta: \"Solo hacemos ecografÃ­as por PAMI\"\nSalida:\n[\n  { \"tipo\": \"CONSULTA_RECLAMO\", \"pregunta\": \"Atienden por PAMI?\" },\n  { \"tipo\": \"FAQ\", \"pregunta\": \"Â¿Atienden por PAMI?\", \"respuesta\": \"Solo hacemos ecografÃ­as por PAMI\" }\n]\n\nEMPAREJAR PREGUNTAâ€“RESPUESTA (FAQ adicional):\nSi el paciente hace una pregunta de informaciÃ³n general (horarios, ubicaciÃ³n, especialidades como â€œdeportologÃ­aâ€, trÃ¡mites, etc.) y dentro de la misma conversaciÃ³n existe una respuesta clara y final de la recepcionista (p. ej., â€œpor el momento no contamos con la especialidadâ€, â€œsÃ­, atendemos porâ€¦â€, â€œsolo hacemos Xâ€¦â€), debes devolver dos objetos:\n\n{\"tipo\":\"CONSULTA_RECLAMO\",\"pregunta\":\"[texto original]\"}\n\n{\"tipo\":\"FAQ\",\"pregunta\":\"[pregunta normalizada y clara]\",\"respuesta\":\"[respuesta textual de la recepcionista]\"}\nNormaliza la ortografÃ­a/acentos en la pregunta del FAQ (ej.: â€œdeportologosâ€ â†’ â€œdeportÃ³logosâ€), pero conserva el sentido literal de la respuesta.\nSi no hay respuesta clara en la conversaciÃ³n, devuelve solo CONSULTA_RECLAMO.\n\nEjemplo concreto (tu caso â€œdeportologÃ­aâ€)\n\nEntrada (fragmento):\nPaciente: â€œQuerÃ­a saber si tiene deportologos?â€\nRecepcionista: â€œPor el momento no contamos con la especialidad.â€\n\nSalida esperada:\n\n[\n  {\n    \"tipo\": \"CONSULTA_RECLAMO\",\n    \"pregunta\": \"QuerÃ­a saber si tiene deportologos?\"\n  },\n  {\n    \"tipo\": \"FAQ\",\n    \"pregunta\": \"Â¿Tienen especialistas en deportologÃ­a?\",\n    \"respuesta\": \"Por el momento no contamos con la especialidad.\"\n  }\n]\n\nÃ“RDENES MÃ‰DICAS â‰  PEDIDOS DE TURNO\nSi el mensaje habla de orden/autorizaciÃ³n/carga en sistema (p. ej.: â€œÂ¿estÃ¡ la orden?â€, â€œÂ¿entrÃ³ la orden?â€, â€œÂ¿la subieron al sistema?â€, â€œautorizaciÃ³n PAMI/OSDE/IOMAâ€), clasificar SIEMPRE como:\n\n{\n  \"tipo\": \"CONSULTA_RECLAMO\",\n  \"subtipo\": \"ORDEN_MEDICA\",\n  \"pregunta\": \"[mensaje original del paciente]\",\n  \"nombre\": \"Nombre o null\",\n  \"telefono\": \"Tel o null\",\n  \"obra_social\": \"OS/Prepaga o null\",\n  \"estudio_detalle\": \"si menciona el estudio, extraerlo; si no, null\"\n}\n\n#REGLA IMPORTANTE \nNo devuelvas PATRON_ESTUDIO/PATRON_TURNO a menos que el paciente pida explÃ­citamente un turno (â€œquiero/needito/sacar turnoâ€, â€œme dan un turnoâ€¦â€, â€œpara cuÃ¡ndo turnoâ€¦â€) o provea los datos estructurados de turno.\nSi en la misma conversaciÃ³n primero pregunta por la orden y despuÃ©s pide turno, devuelve dos objetos: uno CONSULTA_RECLAMO (subtipo ORDEN_MEDICA) y otro PATRON_ESTUDIO/PATRON_TURNO segÃºn corresponda.\n"}]},"batching":{}},"type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.7,"position":[2380,-2220],"id":"3351eff2-4b61-42c1-8579-2fbf970140b2","name":"Analista de Conversaciones"},{"parameters":{"jsCode":"// ============================================================================\n// PARSER DE CLASIFICACIONES ICLP - Optimizado para Google Sheets\n// ============================================================================\n\n// --- FUNCIONES HELPER ---\nfunction stripFences(s) {\n  if (typeof s !== 'string') return '';\n  return s.replace(/^\\s*```json\\s*/i, '')\n          .replace(/\\s*```$/i, '')\n          .trim();\n}\n\nfunction normalize(v) {\n  if (v === undefined || v === null) return null;\n  const s = String(v).trim();\n  return (s === '' || s.toUpperCase() === 'N/D') ? null : s;\n}\n\nfunction normalizePhone(v) {\n  if (!v) return null;\n  const s = String(v).replace(/[^\\d+]/g, '').trim();\n  return s ? s : null;\n}\n\nfunction normalizeObraSocial(v) {\n  if (!v) return null;\n  let s = String(v).trim();\n  s = s.replace(/\\bP\\.?A\\.?M\\.?I\\b/gi, 'PAMI')\n       .replace(/\\bO\\.?S\\.?D\\.?E\\b/gi, 'OSDE')\n       .replace(/\\bI\\.?O\\.?M\\.?A\\b/gi, 'IOMA');\n  return s;\n}\n\n// FunciÃ³n para normalizar preguntas y detectar similitud\nfunction normalizarPregunta(pregunta) {\n  if (!pregunta) return '';\n  return pregunta.toLowerCase()\n    .replace(/[Â¿?Â¡!.,;:]/g, '') // Quitar signos\n    .replace(/\\s+/g, ' ') // Normalizar espacios\n    .trim();\n}\n\n// Detectar si dos preguntas son similares\nfunction sonPreguntasSimilares(pregunta1, pregunta2) {\n  const p1 = normalizarPregunta(pregunta1);\n  const p2 = normalizarPregunta(pregunta2);\n  \n  if (p1 === p2) return true;\n  \n  // Detectar palabras clave similares\n  const palabrasClaveP1 = p1.split(' ').filter(word => word.length > 3);\n  const palabrasClaveP2 = p2.split(' ').filter(word => word.length > 3);\n  \n  // Si comparten mÃ¡s del 70% de palabras clave, son similares\n  const coincidencias = palabrasClaveP1.filter(word => palabrasClaveP2.includes(word));\n  const similitud = coincidencias.length / Math.max(palabrasClaveP1.length, palabrasClaveP2.length);\n  \n  return similitud > 0.7;\n}\n\nfunction isEstudioWord(v) {\n  return v && /^(estudio|estudios)$/i.test(String(v).trim());\n}\n\n// Determinar relevancia - captar todo lo Ãºtil sin duplicar\nfunction esRelevante(tipo, entry) {\n  const tiposRelevantes = [\n    'INTENCION_TURNO',\n    'PATRON_TURNO', \n    'PATRON_ESTUDIO',\n    'CONSULTA_RECLAMO', // Siempre relevante - incluye preguntas sin respuesta\n    'FAQ'\n  ];\n  \n  return tiposRelevantes.includes(tipo);\n}\n\n// FunciÃ³n simple para detectar si tiene datos completos para turno\nfunction esTurnoCompleto(entry) {\n  const tipoTurno = entry.tipo === 'PATRON_TURNO' || entry.tipo === 'PATRON_ESTUDIO';\n  if (!tipoTurno) return false;\n  \n  const tieneContacto = !!(entry.nombre && entry.telefono && entry.dni);\n  const tieneMedico = !!(entry.medico_o_especialidad || entry.estudio_detalle);\n  \n  return tieneContacto && tieneMedico;\n}\n\n// ============================================================================\n// PROCESAMIENTO PRINCIPAL\n// ============================================================================\n\n// Buscar el Ãºltimo item con texto del LLM\nconst lastWithText = [...items].reverse().find(i => typeof i?.json?.text === 'string');\nif (!lastWithText) {\n  console.log('No se encontrÃ³ texto del LLM para procesar');\n  return [];\n}\n\n// Obtener contexto de variables (conversaciÃ³n, etc.)\nconst vars = (() => {\n  try {\n    const it = $items('variables', 0, 0);\n    return it.length ? (it[0].json ?? {}) : {};\n  } catch { \n    return {}; \n  }\n})();\n\n// Limpiar y parsear respuesta del LLM\nlet rawText = stripFences(lastWithText.json.text || '');\nif (rawText === '' || rawText === '[]') {\n  console.log('Respuesta del LLM vacÃ­a o array vacÃ­o');\n  return [];\n}\n\nlet parsedData;\ntry {\n  const parsed = JSON.parse(rawText);\n  parsedData = Array.isArray(parsed) ? parsed : [parsed];\n} catch (e) {\n  console.error('Error parseando JSON:', e.message);\n  return [{\n    json: {\n      error: 'Error parseando JSON del LLM',\n      detalle: e.message,\n      raw_text: rawText,\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\n// ============================================================================\n// PROCESAR Y NORMALIZAR CADA ENTRADA - CON DEDUPLICACIÃ“N\n// ============================================================================\n\nconst resultados = [];\nconst timestamp = new Date().toISOString();\nconst preguntasProcessadas = new Set(); // Para evitar duplicados\n\nfor (let entry of parsedData) {\n  // Normalizar campos bÃ¡sicos\n  const tipo = normalize(entry.tipo);\n  const subtipo = normalize(entry.subtipo);\n  \n  // Solo procesar si es relevante\n  if (!esRelevante(tipo, entry)) {\n    console.log(`Tipo '${tipo}' no es relevante, se omite`);\n    continue;\n  }\n  \n  // DEDUPLICACIÃ“N MEJORADA: Si es CONSULTA_RECLAMO, verificar si ya existe como FAQ\n  if (tipo === 'CONSULTA_RECLAMO') {\n    const preguntaNormalizada = normalize(entry.pregunta);\n    if (preguntaNormalizada) {\n      // Buscar si ya existe un FAQ con pregunta similar en los datos parseados\n      const existeFAQ = parsedData.some(item => {\n        if (item.tipo !== 'FAQ' || !normalize(item.respuesta)) return false;\n        return sonPreguntasSimilares(preguntaNormalizada, normalize(item.pregunta));\n      });\n      \n      if (existeFAQ) {\n        console.log(`ðŸš« CONSULTA_RECLAMO omitida - ya existe como FAQ: \"${preguntaNormalizada}\"`);\n        continue; // Saltar este registro\n      }\n      \n      // Marcar pregunta como procesada\n      preguntasProcessadas.add(normalizarPregunta(preguntaNormalizada));\n    }\n  }\n  \n  // Si es FAQ, verificar que no hayamos procesado ya esta pregunta como CONSULTA_RECLAMO\n  if (tipo === 'FAQ') {\n    const preguntaNormalizada = normalize(entry.pregunta);\n    if (preguntaNormalizada) {\n      const preguntaNorm = normalizarPregunta(preguntaNormalizada);\n      if (preguntasProcessadas.has(preguntaNorm)) {\n        console.log(`ðŸš« FAQ duplicada omitida: \"${preguntaNormalizada}\"`);\n        continue;\n      }\n    }\n  }\n  \n  // Extraer y normalizar todos los campos\n  const datosNormalizados = {\n    // === METADATOS ===\n    conversation_id: vars.conversationId || null,\n    contact_id: vars.contactId || null,\n    message_id: vars.messageId || null,\n    processed_at: timestamp,\n    \n    // === CLASIFICACIÃ“N ===\n    tipo: tipo,\n    subtipo: subtipo,\n    consulta_o_estudio: normalize(entry.consulta_o_estudio),\n    \n    // === DATOS PERSONALES ===\n    nombre: normalize(entry.nombre) || vars.contactName || null,\n    dni: normalize(entry.dni),\n    telefono: normalizePhone(entry.telefono) || vars.contactNumber || null,\n    obra_social: normalizeObraSocial(entry.obra_social),\n    \n    // === DATOS MÃ‰DICOS ===\n    medico_o_especialidad: null, // Se ajusta abajo segÃºn reglas\n    estudio_detalle: normalize(entry.estudio_detalle),\n    \n    // === CONTENIDO ===\n    pregunta: normalize(entry.pregunta),\n    respuesta: normalize(entry.respuesta),\n    mensaje_original: normalize(entry.mensaje),\n    \n    // === DATOS TÃ‰CNICOS ===\n    raw_json: JSON.stringify(entry),\n    \n    // === VALIDACIONES SIMPLES ===\n    tiene_datos_contacto: false,\n    tiene_datos_medicos: false,\n    es_turno_completo: false\n  };\n  \n  // Aplicar reglas de negocio especÃ­ficas\n  if (tipo === 'PATRON_ESTUDIO') {\n    // En estudios, nunca llenar mÃ©dico/especialidad\n    datosNormalizados.medico_o_especialidad = null;\n  } else if (tipo === 'PATRON_TURNO') {\n    // En turnos, usar mÃ©dico/especialidad pero limpiar palabras \"Estudio\"\n    let medEsp = normalize(entry.medico_o_especialidad);\n    if (isEstudioWord(medEsp)) {\n      medEsp = null; // Limpiar \"Estudio(s)\"\n    }\n    datosNormalizados.medico_o_especialidad = medEsp;\n  } else {\n    // Para otros tipos, mantener como estÃ¡\n    datosNormalizados.medico_o_especialidad = normalize(entry.medico_o_especialidad);\n  }\n  \n  // Calcular validaciones simples\n  datosNormalizados.tiene_datos_contacto = !!(datosNormalizados.nombre && datosNormalizados.telefono);\n  \n  datosNormalizados.tiene_datos_medicos = !!(\n    datosNormalizados.medico_o_especialidad || \n    datosNormalizados.estudio_detalle\n  );\n  \n  datosNormalizados.es_turno_completo = esTurnoCompleto(datosNormalizados);\n  \n  // Limpiar campos vacÃ­os antes de agregar al resultado\n  const registro = {};\n  for (const [key, value] of Object.entries(datosNormalizados)) {\n    if (value !== null && value !== undefined && value !== '' && value !== false) {\n      registro[key] = value;\n    }\n  }\n  \n  resultados.push({ json: registro });\n  \n  console.log(`Procesado: ${tipo} - Turno completo: ${datosNormalizados.es_turno_completo} - Tiene contacto: ${datosNormalizados.tiene_datos_contacto}`);\n}\n\nconsole.log(`âœ… Procesados ${resultados.length} registros relevantes de ${parsedData.length} totales`);\n\nreturn resultados;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2800,-2240],"id":"5b621fde-d8e2-4c47-b5fc-2b6d9de619e7","name":"Code2"},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1TCQyvZ_pmnyji6hSJvIQEjvWJmQkUF_tVMHWJmjD3vY","mode":"list","cachedResultName":"Conversaciones_ICLP","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1TCQyvZ_pmnyji6hSJvIQEjvWJmQkUF_tVMHWJmjD3vY/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Conversaciones ICLP","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1TCQyvZ_pmnyji6hSJvIQEjvWJmQkUF_tVMHWJmjD3vY/edit#gid=0"},"columns":{"mappingMode":"defineBelow","value":{"processed_at":"={{ $json.processed_at }}","tipo":"={{ $json.tipo }}","consulta_o_estudio":"={{ $json.consulta_o_estudio }}","dni":"={{ $json.dni }}","nombre":"={{ $json.nombre }}","telefono":"={{ $json.telefono }}","obra_social":"={{ $json.obra_social }}","raw_json":"={{ $json.raw_json }}","tiene_datos_contacto":"={{ $json.tiene_datos_contacto }}","subtipo":"={{ $json.subtipo }}","tiene_datos_medicos":"={{ $json.tiene_datos_medicos }}","medico_o_especialidad":"={{ $json.medico_o_especialidad }}","es_turno_comp":"={{ $json.es_turno_completo }}","mensaje_original":"={{ $json.mensaje_original }}","estudio_detalle":"={{ $json.estudio_detalle }}","pregunta":"={{ $json.pregunta }}","respuesta":"={{ $json.respuesta }}"},"matchingColumns":[],"schema":[{"id":"processed_at","displayName":"processed_at","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"tipo","displayName":"tipo","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"subtipo","displayName":"subtipo","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"consulta_o_estudio","displayName":"consulta_o_estudio","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"nombre","displayName":"nombre","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"telefono","displayName":"telefono","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"obra_social","displayName":"obra_social","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"medico_o_especialidad","displayName":"medico_o_especialidad","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"estudio_detalle","displayName":"estudio_detalle","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"pregunta","displayName":"pregunta","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"respuesta","displayName":"respuesta","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"mensaje_original","displayName":"mensaje_original","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"raw_json","displayName":"raw_json","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"tiene_datos_contacto","displayName":"tiene_datos_contacto","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"tiene_datos_medicos","displayName":"tiene_datos_medicos","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"es_turno_comp","displayName":"es_turno_comp","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[3020,-2240],"id":"ec66d010-83a9-47f7-8a6d-09777b7f8442","name":"Append row in sheet","credentials":{"googleSheetsOAuth2Api":{"id":"VWqufq8KarePOAFl","name":"Google Sheets account"}}},{"parameters":{},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[3240,-2240],"id":"d14bfaf9-8e6e-4a55-8dc6-06c37d358c08","name":"Wait","webhookId":"1c4eeb62-bd9d-4028-9053-16700374a657"}],"connections":{"When clicking â€˜Execute workflowâ€™":{"main":[[{"node":"set_de_campos","type":"main","index":0}]]},"set_de_campos":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]},"HTTP Request":{"main":[[{"node":"Split Out","type":"main","index":0}]]},"Split Out":{"main":[[{"node":"Limit","type":"main","index":0}]]},"Limit":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"HTTP Request1":{"main":[[{"node":"Split Out1","type":"main","index":0}]]},"Split Out1":{"main":[[{"node":"formateo_rol","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"If","type":"main","index":0}]]},"If":{"main":[[{"node":"Aggregate","type":"main","index":0}]]},"Loop Over Items":{"main":[[],[{"node":"HTTP Request1","type":"main","index":0}]]},"Aggregate":{"main":[[{"node":"Analista de Conversaciones","type":"main","index":0}]]},"formateo_rol":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"OpenRouter Chat Model":{"ai_languageModel":[[{"node":"Analista de Conversaciones","type":"ai_languageModel","index":0}]]},"Analista de Conversaciones":{"main":[[{"node":"Code2","type":"main","index":0}]]},"Code2":{"main":[[{"node":"Append row in sheet","type":"main","index":0}]]},"Append row in sheet":{"main":[[{"node":"Wait","type":"main","index":0}]]},"Wait":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"9b2425ab-3730-41ed-879a-99c83f933c17","triggerCount":0,"shared":[{"createdAt":"2025-08-16T02:50:34.286Z","updatedAt":"2025-08-16T02:50:34.286Z","role":"workflow:owner","workflowId":"7Cr0OKX3gXeSAJgS","projectId":"R66ikVn5xqf0nYcA"}],"tags":[]}