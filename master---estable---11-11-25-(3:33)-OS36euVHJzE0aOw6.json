{"createdAt":"2025-10-31T00:56:08.910Z","updatedAt":"2025-11-21T13:24:45.623Z","id":"OS36euVHJzE0aOw6","name":"MASTER - ESTABLE - 11-11-25 (3:33)","active":false,"isArchived":false,"nodes":[{"parameters":{"assignments":{"assignments":[{"id":"account-id","name":"accountId","value":"={{ $json.body.messages[0].account_id }}","type":"number"},{"id":"message","name":"message","value":"={{ $json.body.messages[0].content }}","type":"string"},{"id":"inbox-id","name":"inboxId","value":"={{ $json.body.contact_inbox.inbox_id }}","type":"number"},{"id":"contact-id","name":"contactId","value":"={{ $json.body.messages[0].sender.id }}","type":"number"},{"id":"contact-name","name":"contactName","value":"={{ $json.body.messages[0].sender.name }}","type":"string"},{"id":"contact-number","name":"contactNumber","value":"={{ $json.body.messages[0].sender.phone_number }}","type":"string"},{"id":"conversation-id","name":"conversationId","value":"={{ $json.body.id }}","type":"number"},{"id":"multimedia","name":"multimedia","value":"={{ $json?.body?.messages?.[0]?.attachments?.[0]?.file_type ? true : false }}","type":"boolean"},{"id":"humano","name":"humano","value":"={{ $json.body.custom_attributes.humano }}","type":"boolean"},{"id":"chatwoot-url","name":"chatwootUrl","value":"https://chatw.automatizaciones.ai","type":"string"},{"id":"token-bot","name":"agenteBotTokenWhatsapp","value":"JFi43nzvEPDBCaxaFrkhVvdM","type":"string"},{"id":"fcd30a41-417f-4ca5-8b22-7ee673628621","name":"rowId","value":"","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-4848,1536],"id":"75c49994-a7e8-4298-beaa-5769083ac8a4","name":"Variables"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.multimedia }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true},"id":"multimedia-check"}],"combinator":"and"},"renameOutput":true,"outputKey":"tieneMultimedia"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"humano-check","leftValue":"={{ $json.humano }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"tieneHumano"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"texto-check","leftValue":"={{ $json.message }}","rightValue":"Texto","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"tieneTexto"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-4400,1520],"id":"a9e017cc-a1b0-4dce-80ed-aa32e21fb201","name":"Filtro Tipo Mensaje"},{"parameters":{"operation":"get","propertyName":"status","key":"=status:{{ $('Filtro Tipo Mensaje').item.json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3536,1632],"id":"d5be1852-cc18-4de2-b8c9-972a0b7e271d","name":"ğŸ” Get Estado Actual","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Variables').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"image\",\n      \"image\": {\n        \"link\": \"https://i.imgur.com/cSVuheF.png\"\n      }\n    },\n    \"body\": {\n      \"text\": \"ğŸ‘‹ Â¡HOLA! BIENVENIDO AL ICLP\\n\\nğŸ¤– BOT: DISPONIBLE 24/7\\n\\nğŸ“ ATENCIÃ“N TELEFÃ“NICA Y ADMINISTRATIVA:\\nLUNES A VIERNES 8-20HS | SÃBADO 8-13HS\\n\\nSELECCIONÃ UNA OPCIÃ“N:\\n\\nğŸ“… TURNOS (BOT)\\n- AGENDAR, CONSULTAR O CANCELAR\\n\\nâ„¹ï¸ INFO GENERAL (BOT)\\n- HORARIOS, UBICACIÃ“N Y MÃS\\n\\nğŸ¢ ADMINISTRACIÃ“N (PERSONAL ADMINISTRATIVO)\\n* CONSULTAS Y RECLAMOS\\n* RESPUESTA EN HORARIO DE ATENCIÃ“N\"\n    },\n    \"footer\": {\n      \"text\": \"SELECCIONÃ UNA OPCIÃ“N ğŸ‘‡\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"turnos\",\n            \"title\": \"ğŸ“… TURNOS\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"info-general\",\n            \"title\": \"â„¹ï¸ INFO GENERAL\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"administracion\",\n            \"title\": \"ğŸ¢ ADMINISTRACION\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-704,768],"id":"ab55cf79-771a-445f-ade8-15397594b2f9","name":"ğŸ“± Mensaje Menu Principal","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Variables').first().json.contactNumber }}","value":"={{ $('msg_clasificador').item.json.nuevoEstado }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-480,768],"id":"56448da4-f00f-4423-9025-285659fe9c48","name":"ğŸ’¾ Set Estado MENU","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"// Router para gestiÃ³n de turnos\nconst categoria = $('msg_clasificador').first().json.categoria;\nconst contactNumber = $('Variables').first().json.contactNumber;\n\n// Mapeo de acciones\nconst accion = {\n  categoria: categoria,\n  contactNumber: contactNumber,\n  // Determinar quÃ© hacer\n  accion: null\n};\n\nswitch(categoria) {\n  case 'NUEVO_PACIENTE':\n    accion.accion = 'MOSTRAR_FORM_NUEVO_PACIENTE';\n    break;\n  case 'PACIENTE_REGISTRADO':\n    accion.accion = 'SOLICITAR_DNI';\n    break;\n  case 'INICIAR_TOMAR_TURNO':\n    accion.accion = 'MENU_TOMAR_TURNO';\n    break;\n  case 'INICIAR_CANCELAR_TURNO':\n    accion.accion = 'LISTAR_TURNOS_CANCELAR';\n    break;\n  case 'LISTAR_MIS_TURNOS':\n    accion.accion = 'MOSTRAR_MIS_TURNOS';\n    break;\n  default:\n    accion.accion = 'DESCONOCIDO';\n}\n\nreturn [{ json: accion }];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2784,704],"id":"7521f056-143e-4f86-bbd6-3386788f8cfd","name":"ğŸ« Router GestiÃ³n Turnos"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Variables').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"list\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ğŸ«€ INSTITUTO DE CARDIOLOGÃA LA PLATA\"\n    },\n    \"body\": {\n      \"text\": \"ğŸ“‹ MENÃš PRINCIPAL\\n\\nPRESIONÃ 'ABRIR MENÃš' Y ELEGÃ UNA OPCIÃ“N:\\n\\nâ†’ ğŸ• HORARIOS DE ATENCIÃ“N\\n\\nâ†’ ğŸ“ UBICACIÃ“N DE LA CLÃNICA\\n\\nâ†’ ğŸ’» PORTAL DE PACIENTES\\n\\nâ†’ ğŸ“§ SOLICITAR RECETAS\\n\\nâ†’ ğŸ‘¨â€âš•ï¸ NUESTROS MÃ‰DICOS\\n\\nâ†’ ğŸ©º ESPECIALIDADES MÃ‰DICAS\"\n    },\n    \"footer\": {\n      \"text\": \"ğŸ“… LUN-VIE 8-20HS\"\n    },\n    \"action\": {\n      \"button\": \"ABRIR MENÃš\",\n      \"sections\": [\n        {\n          \"title\": \"ELEGÃ UNA OPCIÃ“N ğŸ‘‡\",\n          \"rows\": [\n            {\n              \"id\": \"horarios\",\n              \"title\": \"ğŸ• HORARIOS\",\n              \"description\": \"â†’ HORARIOS DE ATENCIÃ“N\"\n            },\n            {\n              \"id\": \"direccion\",\n              \"title\": \"ğŸ“ DIRECCIÃ“N\",\n              \"description\": \"â†’ UBICACIÃ“N ICLP\"\n            },\n            {\n              \"id\": \"portal-paciente\",\n              \"title\": \"ğŸ’» PORTAL PACIENTES\",\n              \"description\": \"â†’ ACCESO AL PORTAL\"\n            },\n            {\n              \"id\": \"email-recetas\",\n              \"title\": \"ğŸ“§ EMAIL RECETAS\",\n              \"description\": \"â†’ SOLICITAR RECETAS\"\n            },\n            {\n              \"id\": \"medicos\",\n              \"title\": \"ğŸ‘¨â€âš•ï¸ MÃ‰DICOS\",\n              \"description\": \"â†’ VER ESPECIALISTAS\"\n            },\n            {\n              \"id\": \"especialidades\",\n              \"title\": \"ğŸ©º ESPECIALIDADES\",\n              \"description\": \"â†’ LISTA COMPLETA\"\n            },\n            {\n              \"id\": \"menu-principal\",\n              \"title\": \"VOLVER AL MENU PRINCIPAL\",\n              \"description\": \"MENU PRINCIPAL\"\n            }\n          ]\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-704,1216],"id":"1d5e3ada-f363-47b3-aa2a-351288cec555","name":"ğŸ“± Mensaje Info General","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ğŸ«€ INSTITUTO DE CARDIOLOGÃA LA PLATA\"\n    },\n    \"body\": {\n      \"text\": \"ğŸ“‹ PARA SACAR UN TURNO, SELECCIONÃ:\\n\\nğŸ†• NUEVO PACIENTE\\nâ†’ Si es tu primera vez\\n\\nğŸ‘¤ PACIENTE REGISTRADO\\nâ†’ Si ya tenÃ©s historial con nosotros\\n\\nğŸ  MENÃš PRINCIPAL\\nâ†’ Ver horarios, ubicaciÃ³n y mÃ¡s info\"\n    },\n    \"footer\": {\n      \"text\": \"LUN-VIE 8-20HS\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"primera-vez\",\n            \"title\": \"NUEVO PACIENTE\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"ya-atendido\",\n            \"title\": \"PACIENTE REGISTRADO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"volver-atras\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-704,992],"id":"f15d6644-15ee-477b-882f-8f8a456f4486","name":"ğŸ“… Turnos - PACIENTE NUEVO - PACIENTE REGISTRADO - ","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Variables').first().json.contactNumber }}","value":"={{ $('msg_clasificador').item.json.nuevoEstado }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-480,992],"id":"b7c5ecf5-f21f-4250-ba0d-31c107582421","name":"ğŸ’¾ Set Estado MENU1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=status:{{ $('msg_clasificador').first().json.contactNumber }}","value":"={{ $('msg_clasificador').item.json.nuevoEstado }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3232,704],"id":"6c9225c8-0dae-40ac-99c4-0bd265488967","name":"â±ï¸ STATUS PRIMERA VEZ","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": \"*ğŸ“ REGISTRO DE NUEVO PACIENTE*\\n\\n*AL SER TU PRIMERA VEZ, NECESITAMOS TUS DATOS:*\\n\\nâ†’ APELLIDO y NOMBRE\\nâ†’ DNI\\nâ†’ OBRA SOCIAL\\nâ†’ TELÃ‰FONO\\nâ†’ DOMICILIO\\n\\n*ğŸ“‹ FORMATO:*\\nENVIÃ TUS DATOS EN UN SOLO MENSAJE, ASÃ:\\n\\n_JUAN PEREZ_\\n_42028079_\\n_OSDE_\\n_2214567890_\\n_CALLE 50 NÂ°123, LA PLATA_\\n\\nğŸ‘‡ *ESCRIBÃ TUS DATOS Y ENVIALOS*\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3008,704],"id":"5f8c9f20-6320-45f5-9e6a-b56b34bf9c93","name":"CREAR PACIENTE","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Variables').first().json.contactNumber }}","value":"={{ $('msg_clasificador').item.json.nuevoEstado }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-480,1216],"id":"4e080c2e-4db8-4940-8bb4-6b8b0a3df918","name":"ğŸ’¾ Set Estado MENU2","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=status:{{ $('msg_clasificador').first().json.contactNumber }}","value":"={{ $('msg_clasificador').item.json.nuevoEstado }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-80,4672],"id":"80f634a6-1e36-48c5-94e4-ba95fff5c8a1","name":"â±ï¸ STATUS PRIMERA VEZ1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"status\": \"read\",\n  \"message_id\": \"{{ $('Entrada').item.json.body.messages[0].source_id }}\",\n  \"typing_indicator\": {\n    \"type\": \"text\"\n  }\n} ","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-256,1216],"id":"051ccfed-1451-4d2d-9cbd-4d6014199df8","name":"HTTP Request1","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"status\": \"read\",\n  \"message_id\": \"{{ $('Entrada').item.json.body.messages[0].source_id }}\",\n  \"typing_indicator\": {\n    \"type\": \"text\"\n  }\n} ","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-256,768],"id":"b31f0a95-3192-44df-ae30-3bb8492a7f77","name":"HTTP Request2","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"status\": \"read\",\n  \"message_id\": \"{{ $('Entrada').item.json.body.messages[0].source_id }}\",\n  \"typing_indicator\": {\n    \"type\": \"text\"\n  }\n} ","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-256,992],"id":"82e90648-19ec-48d4-92fd-b11092410fa4","name":"HTTP Request3","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"status\": \"read\",\n  \"message_id\": \"{{ $('Entrada').first().json.body.messages[0].source_id }}\",\n  \"typing_indicator\": {\n    \"type\": \"text\"\n  }\n} ","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-4176,1632],"id":"14c1b297-c7c6-4e18-bbd5-307568c5cd88","name":"HTTP Request4","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"jsCode":"// ============================================\n// CLASIFICADOR DE MENSAJES - SISTEMA JERÃRQUICO\n// ============================================\n// Autor: Sistema de GestiÃ³n de Turnos ICLP\n// VersiÃ³n: 2.0\n// ============================================\n\n// ============================================\n// 1. CONFIGURACIÃ“N Y CONSTANTES\n// ============================================\n\nconst PATRONES = {\n  MENU: {\n    TURNOS: 'ğŸ“… TURNOS',\n    INFO: 'â„¹ï¸ INFO GENERAL',\n    ADMIN: 'ğŸ¢ ADMINISTRACION',\n    VOLVER: 'MENU PRINCIPAL'\n  },\n  \n  TURNOS: {\n    NUEVO: 'NUEVO PACIENTE',\n    REGISTRADO: 'PACIENTE REGISTRADO',\n    TOMAR: 'TOMAR TURNO',\n    CANCELAR: 'CANCELAR TURNO',\n    MIS_TURNOS: 'MIS TURNO/S'\n  },\n  \n  TIPOS: {\n    CONSULTORIO: 'TURNOS CONSULTORIO',\n    ESTUDIO: 'TURNOS ESTUDIO'\n  },\n  \n  INFO: {\n    HORARIOS: 'ğŸ• HORARIOS',\n    DIRECCION: 'ğŸ“ DIRECCIÃ“N',\n    PORTAL: 'ğŸ’» PORTAL PACIENTES',\n    RECETAS: 'ğŸ“§ EMAIL RECETAS',\n    MEDICOS: 'ğŸ‘¨â€âš•ï¸ MÃ‰DICOS',\n    ESPECIALIDADES: 'ğŸ©º ESPECIALIDADES'\n  },\n  \n  ACCION: {\n    CONTINUAR: ['CONTINUAR', 'SI, CONFIRMO', 'SÃ, CONFIRMO', 'CONFIRMAR TURNO'],\n    VOLVER: ['VOLVER ATRAS', 'VOLVER ATRÃS', 'MENU PRINCIPAL', 'VOLVER AL MENU PRINCIPAL', 'â¬…ï¸ VOLVER ATRAS']\n  }\n};\n\n\n// ============================================\n// 2. UTILIDADES - VALIDACIÃ“N DE FORMATOS\n// ============================================\n\n/**\n * Valida si el texto es una selecciÃ³n de lista (formato: TEXTO-COD o TEXTO-123)\n * @param {string} texto - Texto a validar\n * @returns {boolean}\n */\nfunction esSeleccionLista(texto) {\n  // Acepta formatos: CARDIOLOGÃA-CAR, NEUROLOGÃA-123, etc.\n  return /^[A-ZÃ€-ÃšÃ‘\\s]+-[A-Z0-9]+$/i.test(texto);\n}\n\n/**\n * Valida si el texto es una selecciÃ³n de horario (formato: MIÃ‰ 22/10 - 15:40)\n * @param {string} texto - Texto a validar\n * @returns {boolean}\n */\nfunction esSeleccionHorario(texto) {\n  return /^[A-ZÃ‰]{3}\\s\\d{1,2}\\/\\d{1,2}\\s-\\s\\d{2}:\\d{2}$/.test(texto);\n}\n\n/**\n * Extrae el DNI de un texto, ignorando palabras y caracteres adicionales\n * @param {string} texto - Texto que puede contener un DNI\n * @returns {string|null} - DNI encontrado o null\n */\nfunction extraerDNI(texto) {\n  // Convertir a string\n  const textoStr = texto.toString().trim();\n  \n  // Remover TODOS los caracteres que no sean dÃ­gitos\n  const soloDigitos = textoStr.replace(/\\D/g, '');\n  \n  // Buscar secuencia de 7-8 dÃ­gitos consecutivos\n  const patron = /\\d{7,8}/;\n  const match = soloDigitos.match(patron);\n  \n  if (!match) return null;\n  \n  // Retornar los primeros 7-8 dÃ­gitos encontrados\n  const dni = match[0];\n  \n  // Si tiene mÃ¡s de 8 dÃ­gitos, tomar solo los primeros 8\n  return dni.length > 8 ? dni.substring(0, 8) : dni;\n}\n\n/**\n * Valida si el texto contiene un DNI vÃ¡lido (7-8 dÃ­gitos)\n * @param {string} texto - Texto a validar\n * @returns {boolean}\n */\nfunction esDNI(texto) {\n  return extraerDNI(texto) !== null;\n}\n\n/**\n * Valida si el texto es un identificador de turno para cancelar\n * @param {string} texto - Texto a validar\n * @returns {boolean}\n */\nfunction esTurnoParaCancelar(texto) {\n  return /^[A-Z]+-\\d{2}-\\d{2}-\\d{4}(-\\d+)?/.test(texto) || \n         /^turno-\\d{8}-\\d{4}-\\d+/.test(texto);\n}\n\n/**\n * Verifica si el paciente estÃ¡ registrado en el sistema\n * Obtiene los datos del nodo 'PACIENTE EXISTE?' y verifica el campo 'PACIENTE REGISTRADO'\n * @returns {boolean} true si el paciente estÃ¡ registrado, false si no\n */\nfunction esPacienteRegistrado() {\n  try {\n    // Intentar obtener datos del nodo 'PACIENTE EXISTE?'\n    const pacienteData = $('PACIENTE EXISTE?').first().json['PACIENTE REGISTRADO'];\n    \n    // Si es null o undefined â†’ paciente NO registrado\n    if (pacienteData === null || pacienteData === undefined) {\n      console.log('âŒ Paciente NO registrado (campo null/undefined)');\n      return false;\n    }\n    \n    // Si tiene algÃºn valor â†’ paciente registrado\n    console.log('âœ… Paciente registrado detectado:', JSON.stringify(pacienteData));\n    return true;\n    \n  } catch (error) {\n    // Si el nodo no existe o hay error, asumir que no estÃ¡ registrado\n    console.log('âš ï¸ No se pudo verificar paciente (nodo no existe o error):', error.message);\n    return false;\n  }\n}\n\n// ============================================\n// 3. GESTIÃ“N DE ESTADOS\n// ============================================\n\n/**\n * Normaliza el estado al formato jerÃ¡rquico\n * @param {string} estado - Estado a normalizar\n * @returns {string} Estado normalizado\n */\nfunction normalizarEstado(estado) {\n  // Sin estado\n  if (!estado || estado === '') return '';\n  \n  // Ya estÃ¡ normalizado (formato: SECCION:SUBSECCION)\n  if (estado.includes(':')) return estado;\n  \n  // Estados con DNI (formato especial: DNI:12345678)\n  if (estado.startsWith('DNI:')) {\n    const dni = estado.replace('DNI:', '');\n    return `DATOS:DNI_VALIDADO:${dni}`;\n  }\n  \n  // Retornar el estado tal cual si no requiere normalizaciÃ³n\n  return estado;\n}\n\n/**\n * Extrae el contexto del estado jerÃ¡rquico\n * @param {string} estado - Estado en formato jerÃ¡rquico\n * @returns {object} Contexto con secciÃ³n, subsecciÃ³n y datos\n */\nfunction obtenerContexto(estado) {\n  if (!estado) {\n    return { seccion: null, subseccion: null, datos: null };\n  }\n  \n  const partes = estado.split(':');\n  return {\n    seccion: partes[0] || null,\n    subseccion: partes[1] || null,\n    datos: partes[2] || null\n  };\n}\n\n// ============================================\n// 4. REGLAS DE CLASIFICACIÃ“N\n// ============================================\n\n/**\n * Reglas para el menÃº principal\n */\nfunction clasificarMenuPrincipal(mensaje, estado) {\n  // Verificar que estamos en el menÃº principal\n  if (estado !== 'MENU_PRINCIPAL' && estado !== 'MENU_INICIAL') {\n    console.log('â­ï¸ clasificarMenuPrincipal: Estado no es MENU_PRINCIPAL, saltando...');\n    return null;\n  }\n  \n  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n  console.log('ğŸ” clasificarMenuPrincipal()');\n  console.log('ğŸ“© Mensaje:', JSON.stringify(mensaje));\n  console.log('ğŸ·ï¸  Estado:', estado);\n  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n  \n  // TURNOS - Detectar con o sin emoji (mÃ¡s robusto)\n  console.log('ğŸ” Verificando TURNOS...');\n  console.log('   mensaje === PATRONES.MENU.TURNOS:', mensaje === PATRONES.MENU.TURNOS);\n  console.log('   mensaje.includes(\"TURNOS\"):', mensaje.includes('TURNOS'));\n  console.log('   mensaje === \"ğŸ« TURNOS\":', mensaje === 'ğŸ« TURNOS');\n  \n  if (mensaje === PATRONES.MENU.TURNOS || mensaje.includes('TURNOS') || mensaje === 'ğŸ« TURNOS') {\n    console.log('âœ… Detectado botÃ³n TURNOS - Navegando a gestiÃ³n de turnos');\n    return { categoria: 'NAV_TURNOS', nuevoEstado: 'TURNOS:TIPO_PACIENTE' };\n  }\n  \n  // INFO GENERAL - Detectar con o sin emoji\n  if (mensaje === PATRONES.MENU.INFO || mensaje.includes('INFO GENERAL')) {\n    console.log('âœ… Detectado botÃ³n INFO GENERAL');\n    return { categoria: 'NAV_INFO', nuevoEstado: 'INFO:MENU' };\n  }\n  \n  // ADMINISTRACIÃ“N - Detectar con o sin emoji\n  if (mensaje === PATRONES.MENU.ADMIN || mensaje.includes('ADMINISTRACION')) {\n    console.log('âœ… Detectado botÃ³n ADMINISTRACIÃ“N');\n    return { categoria: 'NAV_ADMIN', nuevoEstado: 'ADMIN:CONFIRMAR' };\n  }\n  \n  // DNI directo\n  if (esDNI(mensaje)) {\n    console.log('âœ… Detectado DNI directo');\n    return { \n      categoria: 'INGRESO_DNI', \n      nuevoEstado: `DATOS:DNI_VALIDADO:${mensaje}` \n    };\n  }\n  \n  console.log('âŒ No se detectÃ³ ninguna opciÃ³n del menÃº principal');\n  return null;\n}\n\n/**\n * Reglas para gestiÃ³n de turnos\n */\nfunction clasificarGestionTurnos(mensaje, estado, ctx) {\n  // Tipo de paciente\n  if (estado === 'TURNOS:TIPO_PACIENTE') {\n    if (mensaje === PATRONES.TURNOS.NUEVO) {\n      return { categoria: 'NUEVO_PACIENTE', nuevoEstado: 'DATOS:RECOLECCION' };\n    }\n    if (mensaje === PATRONES.TURNOS.REGISTRADO) {\n      return { categoria: 'PACIENTE_REGISTRADO', nuevoEstado: 'DATOS:SOLICITAR_DNI' };\n    }\n  }\n  \n  // Usuario con DNI validado\n  if (ctx.seccion === 'DATOS' && ctx.subseccion === 'DNI_VALIDADO') {\n    const dni = ctx.datos;\n    \n    // Usuario confirma sus datos despuÃ©s de validar DNI\n    if (PATRONES.ACCION.CONTINUAR.includes(mensaje)) {\n      return { \n        categoria: 'CONFIRMAR_DATOS_DNI', \n        nuevoEstado: 'TURNOS:TIPO_TURNO', \n        metadata: { dni } \n      };\n    }\n    \n    if (mensaje === PATRONES.TURNOS.TOMAR) {\n      return { \n        categoria: 'INICIAR_TOMAR_TURNO', \n        nuevoEstado: 'TURNOS:TIPO_TURNO', \n        metadata: { dni } \n      };\n    }\n    \n    if (mensaje === PATRONES.TURNOS.CANCELAR) {\n      return { \n        categoria: 'INICIAR_CANCELAR_TURNO', \n        nuevoEstado: 'CANCELAR:LISTAR', \n        metadata: { dni } \n      };\n    }\n    \n    if (mensaje === PATRONES.TURNOS.MIS_TURNOS) {\n      return { \n        categoria: 'LISTAR_MIS_TURNOS', \n        nuevoEstado: estado, \n        metadata: { dni } \n      };\n    }\n  }\n  \n  // Tipo de turno\n  if (estado === 'TURNOS:TIPO_TURNO') {\n    if (mensaje === PATRONES.TIPOS.CONSULTORIO) {\n      return { categoria: 'TURNO_CONSULTORIO', nuevoEstado: 'TURNOS:ESPECIALIDADES' };\n    }\n    if (mensaje === PATRONES.TIPOS.ESTUDIO) {\n      return { categoria: 'TURNO_ESTUDIO', nuevoEstado: 'TURNOS:ESPECIALIDADES_ESTUDIO' };\n    }\n  }\n  \n  // MENÃš GESTIÃ“N DE TURNOS (despuÃ©s de confirmar DNI)\n  if (estado === 'MENU:GESTION_TURNOS') {\n    if (mensaje === PATRONES.TURNOS.TOMAR) {\n      return { \n        categoria: 'TOMAR_TURNO', \n        nuevoEstado: 'TURNOS:ESPECIALIDADES'\n      };\n    }\n    if (mensaje === PATRONES.TURNOS.CANCELAR) {\n      return { \n        categoria: 'CANCELAR_TURNO', \n        nuevoEstado: 'CANCELAR:LISTAR'\n      };\n    }\n    if (mensaje === PATRONES.TURNOS.MIS_TURNOS) {\n      return { \n        categoria: 'MIS_TURNOS', \n        nuevoEstado: 'TURNOS:MIS_TURNOS'\n      };\n    }\n  }\n  \n  return null;\n}\n\n/**\n * Reglas para selecciones (especialidad, mÃ©dico, horario)\n */\nfunction clasificarSelecciones(mensaje, estado) {\n  // BotÃ³n ELEGIR OTRO MÃ‰DICO (cuando no hay turnos disponibles)\n  const esBotonElegirOtroMedico = mensaje === 'ELEGIR OTRO MÃ‰DICO' ||\n                                   mensaje === 'ğŸ‘¨â€âš•ï¸ ELEGIR OTRO MÃ‰DICO' ||\n                                   mensaje.includes('ELEGIR OTRO MÃ‰DICO') ||\n                                   mensaje.toLowerCase().includes('elegir otro mÃ©dico') ||\n                                   mensaje.toLowerCase().includes('elegir otro medico');\n  \n  if (estado === 'TURNOS:SIN_HORARIOS' && esBotonElegirOtroMedico) {\n    console.log('âœ… Detectado botÃ³n ELEGIR OTRO MÃ‰DICO - Volviendo a lista de mÃ©dicos');\n    console.log('ğŸ“© Mensaje recibido:', mensaje);\n    return { \n      categoria: 'VOLVER_MEDICOS', \n      nuevoEstado: 'TURNOS:MEDICOS'  // Volver a la lista de mÃ©dicos\n    };\n  }\n  \n  // BotÃ³n VER MÃS ESPECIALIDADES (Chatwoot envÃ­a el title)\n  if (estado === 'TURNOS:ESPECIALIDADES' && mensaje === 'â• VER MÃS ESPECIALIDADES') {\n    return { \n      categoria: 'VER_MAS_ESPECIALIDADES', \n      nuevoEstado: 'TURNOS:ESPECIALIDADES:VER_MAS'\n    };\n  }\n  \n  // BotÃ³n VER ANTERIORES (desde segundo bloque)\n  const esBotonVolver = mensaje === 'â¬…ï¸ VER ANTERIORES' || \n                        mensaje === 'VER ANTERIORES' ||\n                        mensaje.includes('VER ANTERIORES') ||\n                        mensaje.toLowerCase().includes('ver anteriores');\n  \n  if (estado === 'TURNOS:ESPECIALIDADES:VER_MAS' && esBotonVolver) {\n    console.log('âœ… Detectado botÃ³n VER ANTERIORES - Volviendo al primer bloque');\n    console.log('ğŸ“© Mensaje recibido:', mensaje);\n    return { \n      categoria: 'TURNO_CONSULTORIO', \n      nuevoEstado: 'TURNOS:ESPECIALIDADES'\n    };\n  }\n  \n  // Especialidad (primer bloque)\n  if (estado === 'TURNOS:ESPECIALIDADES' && esSeleccionLista(mensaje)) {\n    console.log('âœ… Especialidad seleccionada (primer bloque):', mensaje);\n    // Extraer cÃ³digo de especialidad (ejemplo: CARDIOLOGÃA-CAR â†’ CAR)\n    const codigoEspecialidad = mensaje.split('-').pop();\n    return { \n      categoria: 'SELECCION_ESPECIALIDAD', \n      nuevoEstado: 'TURNOS:MEDICOS', \n      metadata: { \n        especialidad: mensaje,\n        codigoEspecialidad: codigoEspecialidad\n      } \n    };\n  }\n  \n  // Especialidad (segundo bloque - VER MÃS)\n  if (estado === 'TURNOS:ESPECIALIDADES:VER_MAS' && esSeleccionLista(mensaje)) {\n    console.log('âœ… Especialidad seleccionada (segundo bloque):', mensaje);\n    // Extraer cÃ³digo de especialidad (ejemplo: CARDIOLOGÃA-CAR â†’ CAR)\n    const codigoEspecialidad = mensaje.split('-').pop();\n    return { \n      categoria: 'SELECCION_ESPECIALIDAD', \n      nuevoEstado: 'TURNOS:MEDICOS', \n      metadata: { \n        especialidad: mensaje,\n        codigoEspecialidad: codigoEspecialidad\n      } \n    };\n  }\n  \n  // ============================================\n  // ğŸ“„ PAGINACIÃ“N DE MÃ‰DICOS\n  // ============================================\n  \n  // FunciÃ³n para extraer nÃºmero de pÃ¡gina del tÃ­tulo del botÃ³n\n  function extraerNumeroPagina(mensaje) {\n    // Buscar patrÃ³n (N) donde N es un nÃºmero\n    const match = mensaje.match(/\\((\\d+)\\)/);\n    if (match) {\n      return parseInt(match[1]);\n    }\n    return null;\n  }\n  \n  // BotÃ³n: â• VER MÃS (N) - ir a pÃ¡gina N\n  if (estado === 'TURNOS:MEDICOS' && mensaje.includes('VER MÃS')) {\n    const paginaDestino = extraerNumeroPagina(mensaje);\n    \n    if (paginaDestino) {\n      console.log(`ğŸ“„ VER MÃS - Navegando a pÃ¡gina ${paginaDestino}`);\n      \n      const metadata = {\n        paginaMedicos: paginaDestino\n      };\n      \n      // Preservar cÃ³digo de especialidad y especialidad\n      if (globalThis._metadataPrevio?.codigoEspecialidad) {\n        metadata.codigoEspecialidad = globalThis._metadataPrevio.codigoEspecialidad;\n      }\n      if (globalThis._metadataPrevio?.especialidadSeleccionada) {\n        metadata.especialidad = globalThis._metadataPrevio.especialidadSeleccionada;\n      }\n      if (globalThis._metadataPrevio?.especialidad) {\n        metadata.especialidad = globalThis._metadataPrevio.especialidad;\n      }\n      \n      console.log('ğŸ“¦ Metadata actualizado:', JSON.stringify(metadata));\n      \n      return { \n        categoria: 'SELECCION_ESPECIALIDAD', \n        nuevoEstado: 'TURNOS:MEDICOS',\n        metadata: metadata\n      };\n    }\n  }\n  \n  // BotÃ³n: â¬…ï¸ ANTERIORES (N) - ir a pÃ¡gina N\n  if (estado === 'TURNOS:MEDICOS' && mensaje.includes('ANTERIORES')) {\n    const paginaDestino = extraerNumeroPagina(mensaje);\n    \n    if (paginaDestino) {\n      console.log(`ğŸ“„ ANTERIORES - Navegando a pÃ¡gina ${paginaDestino}`);\n      \n      const metadata = {\n        paginaMedicos: paginaDestino\n      };\n      \n      // Preservar cÃ³digo de especialidad y especialidad\n      if (globalThis._metadataPrevio?.codigoEspecialidad) {\n        metadata.codigoEspecialidad = globalThis._metadataPrevio.codigoEspecialidad;\n      }\n      if (globalThis._metadataPrevio?.especialidadSeleccionada) {\n        metadata.especialidad = globalThis._metadataPrevio.especialidadSeleccionada;\n      }\n      if (globalThis._metadataPrevio?.especialidad) {\n        metadata.especialidad = globalThis._metadataPrevio.especialidad;\n      }\n      \n      console.log('ğŸ“¦ Metadata actualizado:', JSON.stringify(metadata));\n      \n      return { \n        categoria: 'SELECCION_ESPECIALIDAD', \n        nuevoEstado: 'TURNOS:MEDICOS',\n        metadata: metadata\n      };\n    }\n  }\n  \n  // BotÃ³n: â¬…ï¸ INICIO - regresar a pÃ¡gina 1\n  if (estado === 'TURNOS:MEDICOS' && (mensaje === 'â¬…ï¸ INICIO' || mensaje === 'INICIO' || mensaje.includes('INICIO'))) {\n    console.log('ğŸ“„ INICIO - Regresando a pÃ¡gina 1');\n    \n    const metadata = {\n      paginaMedicos: 1\n    };\n    \n    // Preservar cÃ³digo de especialidad y especialidad\n    if (globalThis._metadataPrevio?.codigoEspecialidad) {\n      metadata.codigoEspecialidad = globalThis._metadataPrevio.codigoEspecialidad;\n    }\n    if (globalThis._metadataPrevio?.especialidadSeleccionada) {\n      metadata.especialidad = globalThis._metadataPrevio.especialidadSeleccionada;\n    }\n    if (globalThis._metadataPrevio?.especialidad) {\n      metadata.especialidad = globalThis._metadataPrevio.especialidad;\n    }\n    \n    console.log('ğŸ“¦ Metadata actualizado:', JSON.stringify(metadata));\n    \n    return { \n      categoria: 'SELECCION_ESPECIALIDAD', \n      nuevoEstado: 'TURNOS:MEDICOS',\n      metadata: metadata\n    };\n  }\n  \n  // MÃ©dico seleccionado (cualquier pÃ¡gina)\n  if (estado === 'TURNOS:MEDICOS' && esSeleccionLista(mensaje)) {\n    console.log('âœ… MÃ©dico seleccionado:', mensaje);\n    // Extraer matrÃ­cula (ejemplo: PONCE VENA-112196 â†’ 112196)\n    const matricula = mensaje.split('-').pop().trim();\n    console.log('ğŸ”¢ MatrÃ­cula extraÃ­da:', matricula);\n    \n    return { \n      categoria: 'SELECCION_MEDICO', \n      nuevoEstado: 'TURNOS:HORARIOS', \n      metadata: { \n        medico: mensaje,\n        matricula: matricula,\n        paginaMedicos: 1 // Resetear pÃ¡gina cuando se selecciona mÃ©dico\n      } \n    };\n  }\n  \n  // Horario\n  if (estado === 'TURNOS:HORARIOS' && esSeleccionHorario(mensaje)) {\n    return { \n      categoria: 'SELECCION_HORARIO', \n      nuevoEstado: 'TURNOS:CONFIRMAR', \n      metadata: { horario: mensaje } \n    };\n  }\n  \n  // Confirmar turno - Directamente ejecutar POST\n  if (estado === 'TURNOS:CONFIRMAR' && PATRONES.ACCION.CONTINUAR.includes(mensaje)) {\n    console.log('âœ… ConfirmaciÃ³n de turno detectada - Ejecutando POST');\n    return { \n      categoria: 'EJECUTAR_POST_TURNO',  // â¬…ï¸ CAMBIO DIRECTO\n      nuevoEstado: 'MENU_PRINCIPAL' \n    };\n  }\n  \n  return null;\n}\n\n/**\n * Reglas para recolecciÃ³n de datos\n */\nfunction clasificarDatos(mensaje, estado) {\n  // Solicitar DNI - Usuario ingresa DNI para validaciÃ³n (primera vez)\n  if (estado === 'DATOS:SOLICITAR_DNI') {\n    const dniExtraido = extraerDNI(mensaje);\n    if (dniExtraido) {\n      console.log('âœ… DNI extraÃ­do:', dniExtraido, 'del mensaje:', mensaje);\n      return { \n        categoria: 'VALIDAR_DNI', \n        nuevoEstado: `DATOS:DNI_VALIDADO:${dniExtraido}`,\n        metadata: { dni: dniExtraido }\n      };\n    }\n  }\n  \n  // DNI no encontrado (0) - Usuario reintenta con otro DNI\n  if (estado === 'DATOS:DNI_VALIDADO:0') {\n    const dniExtraido = extraerDNI(mensaje);\n    if (dniExtraido) {\n      console.log('ğŸ”„ Reintentando validaciÃ³n de DNI:', dniExtraido);\n      return { \n        categoria: 'VALIDAR_DNI', \n        nuevoEstado: `DATOS:DNI_VALIDADO:${dniExtraido}`,\n        metadata: { dni: dniExtraido }\n      };\n    }\n  }\n  \n  // RecolecciÃ³n inicial de datos\n  if (estado === 'DATOS:RECOLECCION') {\n  if (!PATRONES.ACCION.VOLVER.includes(mensaje) && mensaje !== 'CONTINUAR') {\n      return { categoria: 'INGRESO_DATOS_PACIENTE', nuevoEstado: 'DATOS:RECOLECTADOS' };\n    }\n  }\n  \n  // Datos ya recolectados, esperando confirmaciÃ³n\n  if (estado === 'DATOS:RECOLECTADOS') {\n  if (PATRONES.ACCION.CONTINUAR.includes(mensaje)) {\n    return { categoria: 'CONFIRMAR_PACIENTE_NUEVO', nuevoEstado: 'DATOS:PACIENTE_NUEVO' };\n    }\n  }\n  \n  return null;\n}\n\n/**\n * Reglas para cancelaciÃ³n de turnos\n */\nfunction clasificarCancelacion(mensaje, estado) {\n  // Usuario confirma que quiere eliminar el turno\n  if (estado === 'CANCELAR-TURNO' || estado === 'CANCELAR:TURNO') {\n    console.log('âœ… Detectado estado CANCELAR-TURNO - Ejecutando eliminaciÃ³n');\n    return { \n      categoria: 'ELIMINAR_TURNO', \n      nuevoEstado: 'MENU_PRINCIPAL' \n    };\n  }\n  \n  // Usuario selecciona un turno de la lista para cancelar\n  if (estado === 'CANCELAR:LISTAR' && esTurnoParaCancelar(mensaje)) {\n    return { \n      categoria: 'EJECUTAR_CANCELACION_TURNO', \n      nuevoEstado: 'CANCELAR-TURNO',  // Cambiar al estado de confirmaciÃ³n\n      metadata: { turno_id: mensaje } \n    };\n  }\n  \n  return null;\n}\n\n/**\n * Reglas para informaciÃ³n general\n */\nfunction clasificarInformacion(mensaje, estado) {\n  const infoMap = {\n    [PATRONES.INFO.HORARIOS]: 'INFO_HORARIOS',\n    [PATRONES.INFO.DIRECCION]: 'INFO_DIRECCION',\n    [PATRONES.INFO.PORTAL]: 'INFO_PORTAL',\n    [PATRONES.INFO.RECETAS]: 'INFO_RECETAS',\n    [PATRONES.INFO.MEDICOS]: 'INFO_MEDICOS',\n    [PATRONES.INFO.ESPECIALIDADES]: 'INFO_ESPECIALIDADES'\n  };\n  \n  if (infoMap[mensaje]) {\n    return { categoria: infoMap[mensaje], nuevoEstado: estado };\n  }\n  \n  return null;\n}\n\n/**\n * Reglas para navegaciÃ³n hacia atrÃ¡s\n */\nfunction clasificarVolverAtras(mensaje, estado) {\n  if (!PATRONES.ACCION.VOLVER.includes(mensaje)) return null;\n  \n  const navegacionAtras = {\n    'TURNOS:HORARIOS': 'TURNOS:MEDICOS',\n    'TURNOS:MEDICOS': 'TURNOS:ESPECIALIDADES',\n    'TURNOS:ESPECIALIDADES': 'TURNOS:TIPO_TURNO',\n    'TURNOS:ESPECIALIDADES:VER_MAS': 'TURNOS:ESPECIALIDADES',\n    'TURNOS:CONFIRMAR': 'TURNOS:HORARIOS',\n    'CANCELAR:LISTAR': 'MENU_PRINCIPAL',\n    'DATOS:RECOLECTADOS': 'DATOS:RECOLECCION',\n    'INFO:MENU': 'MENU_PRINCIPAL'\n  };\n  \n  const nuevoEstado = navegacionAtras[estado] || 'MENU_PRINCIPAL';\n  \n  // Si volvemos al menÃº principal, usar categorÃ­a MENU_INICIAL\n  const categoria = (nuevoEstado === 'MENU_PRINCIPAL') ? 'MENU_INICIAL' : 'VOLVER_ATRAS';\n  \n  return { categoria, nuevoEstado };\n}\n\n/**\n * Reglas para administraciÃ³n\n */\nfunction clasificarAdmin(mensaje, estado) {\n  if (estado === 'ADMIN:CONFIRMAR' && mensaje === 'SI, CONFIRMO') {\n    return { categoria: 'DERIVAR_HUMANO', nuevoEstado: 'ADMIN:HUMANO_ACTIVO' };\n  }\n  \n  return null;\n}\n\n// ============================================\n// 5. CLASIFICADOR PRINCIPAL\n// ============================================\n\n/**\n * Clasificador principal - Ejecuta todas las reglas en orden\n * @param {string} mensaje - Mensaje del usuario\n * @param {string} estado - Estado actual\n * @returns {object} Resultado con categorÃ­a y nuevo estado\n */\nfunction clasificar(mensaje, estado) {\n  const ctx = obtenerContexto(estado);\n  \n  // 1. INICIO / SIN ESTADO\n  if (!estado || estado === '') {\n    return { categoria: 'MENU_INICIAL', nuevoEstado: 'MENU_PRINCIPAL' };\n  }\n  \n  // 2. VOLVER AL MENÃš PRINCIPAL\n  if (mensaje === 'MENU PRINCIPAL') {\n    return { categoria: 'MENU_INICIAL', nuevoEstado: 'MENU_PRINCIPAL' };\n  }\n  \n  // 3. BOTÃ“N ADMINISTRACIÃ“N (desde cualquier estado)\n  if (mensaje === 'ğŸ¢ ADMINISTRACION') {\n    return { categoria: 'NAV_ADMIN', nuevoEstado: 'ADMIN:CONFIRMAR' };\n  }\n  \n  // 4. EJECUTAR REGLAS EN ORDEN\n  const reglas = [\n    clasificarMenuPrincipal,\n    clasificarGestionTurnos,\n    clasificarSelecciones,\n    clasificarDatos,\n    clasificarCancelacion,\n    clasificarInformacion,\n    clasificarVolverAtras,\n    clasificarAdmin\n  ];\n  \n  for (const regla of reglas) {\n    const resultado = regla(mensaje, estado, ctx);\n    if (resultado) return resultado;\n  }\n  \n  // 5. FALLBACK INTELIGENTE - Devuelve categorÃ­a basada en el estado actual\n  return obtenerCategoriaDeEstado(estado);\n}\n\n/**\n * Obtiene una categorÃ­a por defecto basada en el estado actual\n * Esto permite que el flujo continÃºe incluso cuando no se reconoce el mensaje\n * @param {string} estado - Estado actual del usuario\n * @returns {object} Resultado con categorÃ­a y estado\n */\nfunction obtenerCategoriaDeEstado(estado) {\n  console.log('âš ï¸ FALLBACK INTELIGENTE - No se reconociÃ³ el mensaje');\n  console.log('ğŸ“ Estado actual:', estado);\n  \n  // Mapa de estados a categorÃ­as por defecto\n  const estadoACategoriaMap = {\n    // Estados de Datos\n    'DATOS:SOLICITAR_DNI': { categoria: 'SOLICITAR_DNI', nuevoEstado: 'DATOS:SOLICITAR_DNI' },\n    'DATOS:DNI_VALIDADO': { categoria: 'MENU_GESTION_TURNOS', nuevoEstado: 'MENU:GESTION_TURNOS' },\n    \n    // Estados del MenÃº de GestiÃ³n\n    'MENU:GESTION_TURNOS': { categoria: 'MENU_GESTION_TURNOS', nuevoEstado: 'MENU:GESTION_TURNOS' },\n    'TURNOS:TIPO_TURNO': { categoria: 'MENU_TIPO_TURNO', nuevoEstado: 'TURNOS:TIPO_TURNO' },\n    \n    // Estados de Turnos - Especialidades\n    'TURNOS:ESPECIALIDADES': { categoria: 'TURNO_CONSULTORIO', nuevoEstado: 'TURNOS:ESPECIALIDADES' },\n    'TURNOS:ESPECIALIDADES:VER_MAS': { categoria: 'VER_MAS_ESPECIALIDADES', nuevoEstado: 'TURNOS:ESPECIALIDADES:VER_MAS' },\n    'TURNOS:ESPECIALIDADES_ESTUDIO': { categoria: 'TURNO_ESTUDIO', nuevoEstado: 'TURNOS:ESPECIALIDADES_ESTUDIO' },\n    \n    // Estados de Turnos - MÃ©dicos\n    'TURNOS:MEDICOS': { categoria: 'SELECCION_ESPECIALIDAD', nuevoEstado: 'TURNOS:MEDICOS' },\n    \n    // Estados de Turnos - Horarios\n    'TURNOS:HORARIOS': { categoria: 'SELECCION_MEDICO', nuevoEstado: 'TURNOS:HORARIOS' },\n    'TURNOS:SIN_HORARIOS': { categoria: 'SELECCION_MEDICO', nuevoEstado: 'TURNOS:MEDICOS' },\n    'TURNOS:CONFIRMAR': { categoria: 'SELECCION_HORARIO', nuevoEstado: 'TURNOS:CONFIRMAR' },\n    \n    // Estados de CancelaciÃ³n\n    'CANCELAR:LISTAR': { categoria: 'CANCELAR_TURNO', nuevoEstado: 'CANCELAR:LISTAR' },\n    'CANCELAR-TURNO': { categoria: 'EJECUTAR_CANCELACION_TURNO', nuevoEstado: 'CANCELAR-TURNO' },\n    'CANCELAR:TURNO': { categoria: 'EJECUTAR_CANCELACION_TURNO', nuevoEstado: 'CANCELAR:TURNO' },\n    \n    // Estados de Mis Turnos\n    'TURNOS:MIS_TURNOS': { categoria: 'MIS_TURNOS', nuevoEstado: 'TURNOS:MIS_TURNOS' },\n    \n    // Estados de AdministraciÃ³n\n    'ADMIN:CONFIRMAR': { categoria: 'NAV_ADMIN', nuevoEstado: 'ADMIN:CONFIRMAR' },\n    'ADMIN:HUMANO_ACTIVO': { categoria: 'DERIVAR_HUMANO', nuevoEstado: 'ADMIN:HUMANO_ACTIVO' },\n    \n    // MenÃº Principal\n    'MENU_PRINCIPAL': { categoria: 'MENU_INICIAL', nuevoEstado: 'MENU_PRINCIPAL' }\n  };\n  \n  // Buscar categorÃ­a por estado exacto\n  if (estadoACategoriaMap[estado]) {\n    const resultado = estadoACategoriaMap[estado];\n    console.log('âœ… CategorÃ­a encontrada para estado:', resultado.categoria);\n    return resultado;\n  }\n  \n  // Si no encuentra exacto, buscar por prefijo\n  if (estado.startsWith('DATOS:DNI_VALIDADO:')) {\n    console.log('âœ… Detectado DNI validado - Redirigiendo a menÃº gestiÃ³n');\n    return { categoria: 'MENU_GESTION_TURNOS', nuevoEstado: 'MENU:GESTION_TURNOS' };\n  }\n  \n  if (estado.startsWith('TURNOS:')) {\n    console.log('âœ… Usuario en flujo de turnos - Manteniendo contexto');\n    return { categoria: 'TURNO_CONSULTORIO', nuevoEstado: estado };\n  }\n  \n  if (estado.startsWith('CANCELAR:')) {\n    console.log('âœ… Usuario en cancelaciÃ³n - Manteniendo contexto');\n    return { categoria: 'CANCELAR_TURNO', nuevoEstado: estado };\n  }\n  \n  if (estado.startsWith('DATOS:')) {\n    console.log('âœ… Usuario en registro de datos');\n    return { categoria: 'SOLICITAR_DNI', nuevoEstado: 'DATOS:SOLICITAR_DNI' };\n  }\n  \n  // Ãšltimo recurso: volver al menÃº principal\n  console.log('âš ï¸ Estado no reconocido - Redirigiendo a menÃº principal');\n  return { categoria: 'MENU_INICIAL', nuevoEstado: 'MENU_PRINCIPAL' };\n}\n\n// ============================================\n// 6. EJECUCIÃ“N Y LOGGING\n// ============================================\n\n/**\n * Registra informaciÃ³n de depuraciÃ³n\n */\nfunction logDebug(mensaje, estadoRaw, estado, resultado) {\n  const dniExtraido = extraerDNI(mensaje);\n  \n  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n  console.log('ğŸ“± Mensaje:', mensaje);\n  console.log('ğŸ“ Longitud:', mensaje.length);\n  console.log('ğŸ”¤ Tipo:', typeof mensaje);\n  console.log('ğŸ§ª Es DNI?:', esDNI(mensaje));\n  if (dniExtraido) {\n    console.log('ğŸ†” DNI ExtraÃ­do:', dniExtraido);\n  }\n  console.log('ğŸ·ï¸  Estado Raw:', estadoRaw || '(sin estado)');\n  console.log('ğŸ·ï¸  Estado Normalizado:', estado || '(sin estado)');\n  console.log('ğŸ¯ CategorÃ­a:', resultado.categoria);\n  console.log('ğŸ”„ Nuevo Estado:', resultado.nuevoEstado);\n  if (resultado.metadata) {\n    console.log('ğŸ“¦ Metadata:', JSON.stringify(resultado.metadata));\n  }\n  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n}\n\n/**\n * Construye el contexto enriquecido\n */\nfunction construirContexto(resultado) {\n  const nuevoCtx = obtenerContexto(resultado.nuevoEstado);\n  \n  return {\n    seccion: nuevoCtx.seccion,\n    subseccion: nuevoCtx.subseccion,\n    es_usuario_registrado: resultado.nuevoEstado.startsWith('DATOS:DNI_VALIDADO'),\n    en_proceso_turno: resultado.nuevoEstado.startsWith('TURNOS:'),\n    en_cancelacion: resultado.nuevoEstado.startsWith('CANCELAR:')\n  };\n}\n\n// ============================================\n// 7. MAIN - PUNTO DE ENTRADA\n// ============================================\n\n// Obtener datos de entrada\nconst estadoRaw = $json.status || $json.value || $json.result || '';\nconst mensajeRaw = $('Variables').first().json.message;\nconst mensaje = mensajeRaw.toString().trim();\nconst contactNumber = $('Variables').first().json.contactNumber;\n\n// ============================================\n// ğŸ” DEBUG: InformaciÃ³n del mensaje\n// ============================================\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\nconsole.log('ğŸ” DEBUG MENSAJE');\nconsole.log('ğŸ“© mensajeRaw:', mensajeRaw);\nconsole.log('ğŸ“ Tipo de mensajeRaw:', typeof mensajeRaw);\nconsole.log('ğŸ“© mensaje (despuÃ©s de toString y trim):', mensaje);\nconsole.log('ğŸ“ Tipo de mensaje:', typeof mensaje);\nconsole.log('ğŸ“ Longitud:', mensaje.length);\nconsole.log('ğŸ”¤ Caracteres:', JSON.stringify(mensaje));\nconsole.log('ğŸ†” CÃ³digos de caracteres:', mensaje.split('').map(c => c.charCodeAt(0)));\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n\n// Intentar obtener metadata del nodo anterior (para preservar cÃ³digo de especialidad, etc.)\nlet metadataPrevio = {};\ntry {\n  // Primero intentar del $json actual (puede venir del nodo Redis GET)\n  if ($json.metadata && Object.keys($json.metadata).length > 0) {\n    metadataPrevio = $json.metadata;\n    console.log('âœ… Metadata encontrado en $json');\n  } else {\n    // Intentar del nodo Get Estado Actual\n    metadataPrevio = $('Get Estado Actual').first().json.metadata || {};\n    console.log('âœ… Metadata encontrado en Get Estado Actual');\n  }\n} catch (e) {\n  try {\n    // Intentar del nodo LISTA_MEDICOS\n    const listaMedicos = $('LISTA_MEDICOS').first().json;\n    metadataPrevio = {\n      codigoEspecialidad: listaMedicos.codigoEspecialidad,\n      especialidadSeleccionada: listaMedicos.especialidadSeleccionada\n    };\n    console.log('âœ… Metadata encontrado en LISTA_MEDICOS');\n  } catch (e2) {\n    try {\n      // Intentar del nodo LISTA_ESPECIALIDADES\n      metadataPrevio = $('LISTA_ESPECIALIDADES').first().json;\n      console.log('âœ… Metadata encontrado en LISTA_ESPECIALIDADES');\n    } catch (e3) {\n      metadataPrevio = {};\n      console.log('âš ï¸ No se encontrÃ³ metadata previo');\n    }\n  }\n}\n\nconsole.log('ğŸ“¦ Metadata previo final:', JSON.stringify(metadataPrevio));\n\n// Hacer metadata previo disponible globalmente para las funciones clasificadoras\nglobalThis._metadataPrevio = metadataPrevio;\n\n// Normalizar estado\nconst estado = normalizarEstado(estadoRaw);\n\n// ============================================\n// ğŸš¨ DETECCIÃ“N DE ERROR_MESSAGE (Errores de Registro)\n// ============================================\n// Si hay un error de registro (DNI incorrecto, nombre incompleto, etc.)\n// debe devolver ERROR_REGISTRO para volver al flujo de datos\nconst hasError = $json.hasError || false;\nconst errorMessage = $json.errorMessage || null;\n\nif (hasError && errorMessage) {\n  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n  console.log('ğŸš¨ ERROR DE REGISTRO DETECTADO');\n  console.log('ğŸ“ Mensaje de error:', errorMessage);\n  console.log('ğŸ”„ Redirigiendo al flujo de datos para reintentar');\n  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n  \n  // Retornar inmediatamente con categorÃ­a ERROR_REGISTRO\n  return [{\n    json: {\n      categoria: 'ERROR_REGISTRO',\n      mensaje: mensaje,\n      contactNumber: contactNumber,\n      estadoActual: 'DATOS:ERROR_REGISTRO',\n      estadoAnterior: estado,\n      metadata: {\n        errorMessage: errorMessage,\n        errorOriginal: errorMessage\n      },\n      redisKey: `state:${contactNumber}`,\n      redisValue: 'DATOS:ERROR_REGISTRO',\n      nuevoEstado: 'DATOS:ERROR_REGISTRO',\n      _context: {\n        seccion: 'DATOS',\n        subseccion: 'ERROR_REGISTRO',\n        es_usuario_registrado: false,\n        en_proceso_turno: false,\n        en_cancelacion: false,\n        tiene_error: true\n      }\n    }\n  }];\n}\n\n// Log de entrada\nconst dniEnMensaje = extraerDNI(mensaje);\nconsole.log('â”â”â”â”â”â” ENTRADA â”â”â”â”â”â”');\nconsole.log('ğŸ“© Mensaje raw:', JSON.stringify(mensajeRaw));\nconsole.log('ğŸ“© Mensaje procesado:', mensaje);\nconsole.log('ğŸ“ Longitud:', mensaje.length);\nconsole.log('ğŸ“ Tipo:', typeof mensajeRaw);\nconsole.log('ğŸ§ª Es DNI?:', esDNI(mensaje));\nif (dniEnMensaje) {\n  console.log('ğŸ†” DNI encontrado:', dniEnMensaje);\n}\nconsole.log('ğŸ·ï¸  Estado raw:', estadoRaw);\nconsole.log('ğŸ·ï¸  Estado normalizado:', estado);\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n\n// Clasificar\nconst resultado = clasificar(mensaje, estado);\n\n// Log de depuraciÃ³n\nlogDebug(mensaje, estadoRaw, estado, resultado);\n\n// Retornar resultado estructurado\nreturn [{\n  json: {\n    // Datos principales\n    categoria: resultado.categoria,\n    mensaje: mensaje,\n    contactNumber: contactNumber,\n    \n    // Estados para Redis\n    estadoActual: resultado.nuevoEstado,      // Estado a guardar en Redis\n    estadoAnterior: estado,                   // Estado previo (para volver atrÃ¡s)\n    \n    // Metadata\n    metadata: resultado.metadata || {},\n    \n    // Redis keys (compatibilidad)\n    redisKey: `state:${contactNumber}`,\n    redisValue: resultado.nuevoEstado,\n    \n    // Alias para compatibilidad con cÃ³digo existente\n    nuevoEstado: resultado.nuevoEstado,\n    \n    // Contexto enriquecido\n    _context: construirContexto(resultado)\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-3024,1632],"id":"4d1db910-d985-4094-89dc-8f3cfd4811e5","name":"msg_clasificador"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Preparar Redis').item.json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ğŸ«€ INSTITUTO DE CARDIOLOGÃA LA PLATA\"\n    },\n    \"body\": {\n      \"text\": \"ğŸ¢ ADMINISTRACIÃ“N\\n\\nTE CONECTAREMOS CON UNA ADMINISTRATIVA\\n\\nRECUERDA:\\n\\nâ° HORARIO DE RESPUESTA:\\nLUNES A VIERNES: 8-20HS | SÃBADO 8-13HS\\n\\nğŸ“ OTRO MEDIO DONDE PODÃ‰S RECIBIR ASISTENCIA:\\n221 4906310\\n\\nÂ¿QUERÃ‰S CONTINUAR?\"\n    },\n    \"footer\": {\n      \"text\": \"LUN-VIE 8-20HS | SÃB 8-13HS\"\n    },\n    \"action\": {\n      \"buttons\": [\n                {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"volver-atras\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-704,1440],"id":"4adb5249-75fd-4c00-ab78-91d7ab6aec5b","name":"ğŸ¢ AdministraciÃ³n","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}},"disabled":true},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"status\": \"read\",\n  \"message_id\": \"{{ $('Entrada').item.json.body.messages[0].source_id }}\",\n  \"typing_indicator\": {\n    \"type\": \"text\"\n  }\n} ","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3456,704],"id":"d42e2d04-5ec1-41b5-b095-8af9d403e649","name":"HTTP Request5","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"status\": \"read\",\n  \"message_id\": \"{{ $('Entrada').item.json.body.messages[0].source_id }}\",\n  \"typing_indicator\": {\n    \"type\": \"text\"\n  }\n} ","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-480,1440],"id":"1b0c539d-1d51-4b9c-afba-53ea734ead01","name":"HTTP Request6","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}},"disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"057155d2-7320-48de-8ed5-bf00dcc72b38","leftValue":"={{ $json.contactNumber }}","rightValue":"+5492213994411","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"c20fad56-f470-4653-b327-8ce2b684deaa","leftValue":"={{ $json.contactNumber }}","rightValue":"+5492254596618","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"or"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[-4624,1536],"id":"9b8eecb2-e43b-49c6-9ffa-3ccd83b823c7","name":"Filtrar nÃºmeros de prueba","disabled":true},{"parameters":{"operation":"delete","key":"=status:{{ $('Variables').first().json.contactNumber }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-256,1440],"id":"a493c66b-3433-4a28-ab0b-5ea14f5d583b","name":"ğŸ’¾ Set Estado MENU3","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"workflowId":{"__rl":true,"value":"gsbUq8JFSpw8U7yR","mode":"list","cachedResultName":"SUB - ETIQUETA: CONSULTA_RECLAMO"},"workflowInputs":{"mappingMode":"defineBelow","value":{"humano":true,"accountId":"={{ $('Filtro Tipo Mensaje').item.json.accountId }}","conversationId":"={{ $('Filtro Tipo Mensaje').item.json.conversationId.toString() }}","contactId":"={{ $('Filtro Tipo Mensaje').item.json.contactId.toString() }}","message":"={{ $('Filtro Tipo Mensaje').item.json.message }}","inboxId":"={{ $('Filtro Tipo Mensaje').item.json.inboxId.toString() }}","chatwootUrlBase":"={{ $('Filtro Tipo Mensaje').item.json.chatwootUrl }}","tokenChatwoot":"={{ $('Filtro Tipo Mensaje').item.json.agenteBotTokenWhatsapp }}","tipoIntencion":"consultas-reclamos"},"matchingColumns":[],"schema":[{"id":"accountId","displayName":"accountId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"conversationId","displayName":"conversationId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"contactId","displayName":"contactId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"message","displayName":"message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"inboxId","displayName":"inboxId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"humano","displayName":"humano","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"boolean"},{"id":"chatwootUrlBase","displayName":"chatwootUrlBase","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"tokenChatwoot","displayName":"tokenChatwoot","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"tipoIntencion","displayName":"tipoIntencion","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-672,2128],"id":"95b976df-6771-4592-80f4-86e6e47c218f","name":"ETIQUETA CONSULTA-RECLAMO"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"status\": \"read\",\n  \"message_id\": \"{{ $('Entrada').item.json.body.messages[0].source_id }}\",\n  \"typing_indicator\": {\n    \"type\": \"text\"\n  }\n} ","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-320,2128],"id":"183ab715-114b-42d6-b316-17fd808d5bdb","name":"HTTP Request7","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"status\": \"read\",\n  \"message_id\": \"{{ $('Entrada').first().json.body.messages[0].source_id }}\",\n  \"typing_indicator\": {\n    \"type\": \"text\"\n  }\n} ","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-3728,1440],"id":"02ecccb6-c4c8-4753-b8d0-c60fcf9924cb","name":"HTTP Request8","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"={{ $('Filtro Tipo Mensaje').item.json.chatwootUrl }}/api/v1/accounts/{{ $('Filtro Tipo Mensaje').item.json.accountId }}/conversations/{{ $('Filtro Tipo Mensaje').item.json.conversationId }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('Filtro Tipo Mensaje').item.json.agenteBotTokenWhatsapp }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"content","value":"=ğŸ·ï¸ Su consulta ya quedÃ³ registrada y etiquetada para que un supervisor del Ã¡rea administrativa se comunique con usted.\n\nğŸ‘¤ En breve recibirÃ¡ atenciÃ³n personalizada.\nâ¸ï¸ El menÃº automÃ¡tico permanecerÃ¡ pausado por el momento.\n\nâ¤ï¸ *Gracias por tu confianza.*\n_Instituto de CardiologÃ­a La Plata_"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-3504,1440],"id":"87ba624e-ce07-422d-97b2-97675cc09807","name":"sendRespondCw"},{"parameters":{"operation":"incr","key":"=contador:{{ $('Filtro Tipo Mensaje').item.json.contactNumber }}","expire":true,"ttl":3600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3248,1408],"id":"befed2f7-989c-4a76-85fa-16ae5b4dc822","name":"contador","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"mensaje_enviado","key":"=contador:{{ $('Filtro Tipo Mensaje').item.json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-4176,1440],"id":"c82b8cf9-604f-4f5c-8cbb-d5c3467c3d6a","name":"MSG ENVIADO?","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"28730a7e-22e0-4e24-9233-e808f6b6826c","leftValue":"={{ $json.mensaje_enviado >= 1 && $json.mensaje_enviado !== null }}","rightValue":"null","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-3952,1440],"id":"1766aec1-db20-42de-839f-b5ca7b085eaa","name":"If"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filtro Tipo Mensaje').first().json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": {{ JSON.stringify($json.mensaje) }}\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[112,4416],"id":"a2fe1941-3e46-48f8-b1bd-5e1408db7d97","name":"ESPECIALIDADES2","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"content":"## INFO GENERAL - MEDICOS","height":304,"width":992,"color":4},"type":"n8n-nodes-base.stickyNote","position":[-880,3968],"typeVersion":1,"id":"a0a7e7e3-5dac-49e8-a308-1a5b605ecf25","name":"Sticky Note2"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filtro Tipo Mensaje').first().json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": {{ JSON.stringify($json.mensaje) }}\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-16,4080],"id":"d1e7242b-f0c6-42f9-97fc-c9b750320218","name":"MEDICOS","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"jsCode":"// Obtener todos los mÃ©dicos\nconst items = $input.all();\n\n// Crear un objeto para agrupar mÃ©dicos por especialidad\nconst medicosPorEspecialidad = {};\n\nitems.forEach(item => {\n  const medico = item.json.Medico;\n  const especialidad = item.json.Especialidad;\n  \n  if (!medicosPorEspecialidad[especialidad]) {\n    medicosPorEspecialidad[especialidad] = [];\n  }\n  \n  // Evitar duplicados\n  if (!medicosPorEspecialidad[especialidad].includes(medico)) {\n    medicosPorEspecialidad[especialidad].push(medico);\n  }\n});\n\n// Ordenar especialidades alfabÃ©ticamente\nconst especialidadesOrdenadas = Object.keys(medicosPorEspecialidad).sort();\n\n// Crear el listado formateado\nlet listadoMedicos = '';\nespecialidadesOrdenadas.forEach(especialidad => {\n  listadoMedicos += `\\nğŸ“Œ *${especialidad}*\\n`;\n  \n  // Ordenar mÃ©dicos alfabÃ©ticamente\n  const medicos = medicosPorEspecialidad[especialidad].sort();\n  \n  medicos.forEach(medico => {\n    listadoMedicos += `   â€¢ Dr./Dra. ${medico}\\n`;\n  });\n});\n\n// Crear el mensaje completo con las nuevas instrucciones\nconst mensaje = `ğŸ‘¨â€âš•ï¸ *NUESTROS PROFESIONALES*\\n\\nğŸ¥ *CONTAMOS CON LOS SIGUIENTES MÃ‰DICOS ESPECIALISTAS:*${listadoMedicos}\\n\\nğŸ“ *CONTACTO:*\\n(0221) 4906310\\nLUNES A VIERNES: 8:00-20:00HS`;\n\n// Mensaje para botÃ³n interactivo\nconst mensajeBoton = `ğŸ“‹ IR AL MENÃš PRINCIPAL O DIRECTAMENTE SACAR TURNO`;\n\n// Retornar el resultado en JSON\nreturn [{\n  json: {\n    listadoMedicos: listadoMedicos.trim(),\n    mensaje: mensaje,\n    mensajeBoton: mensajeBoton,\n    medicosPorEspecialidad: medicosPorEspecialidad,\n    totalEspecialidades: especialidadesOrdenadas.length,\n    totalMedicos: items.length,\n    // Estructura completa para mensaje interactivo\n    interactive_body: mensajeBoton,\n    interactive_button_id: \"menu_principal\",\n    interactive_button_title: \"MENU PRINCIPAL\"\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-240,4080],"id":"e3dca266-589b-4cc7-9065-b7cf7939d1a8","name":"Msg preparado"},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"mhwp4qt6r2d7ymm","returnAll":true,"options":{}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[-464,4080],"id":"06a9b845-5722-4fd3-beaf-5a91c5942fc9","name":"get_medicos1","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"mi8p2u7tvuplzt5","returnAll":true,"options":{}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[-336,4416],"id":"c2b36640-7d31-4583-a29e-c713210f0b88","name":"get_especialidades","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"jsCode":"// Obtener todas las especialidades\nconst items = $input.all();\n\n// Extraer las especialidades y eliminar duplicados\nconst especialidades = [...new Set(items.map(item => item.json.Especialidad))];\n\n// Ordenar alfabÃ©ticamente\nespecialidades.sort();\n\n// Crear el listado formateado para WhatsApp\nconst listadoEspecialidades = especialidades\n  .map((esp, index) => `${index + 1}. ${esp.toUpperCase()}`)\n  .join('\\n');\n\n// Crear el mensaje completo en mayÃºsculas\nconst mensaje = `ğŸ¥ *ESPECIALIDADES DISPONIBLES*\\n\\nğŸ“‹ *CONTAMOS CON LAS SIGUIENTES ESPECIALIDADES:*\\n\\n${listadoEspecialidades}\\n\\nğŸ‘‡ *PRESIONE SI QUIERE SACAR UN TURNO Y SIGA LAS INDICACIONES*\\n\\nğŸ“ *CONTACTO:*\\n(0221) 4906310\\nLUNES A VIERNES: 8:00-20:00HS`;\n\n// Mensaje para botÃ³n interactivo\nconst mensajeBoton = `ğŸ“‹ SACAR UN TURNO O IR AL  MENU PRINCIPAL`;\n\n// Retornar tanto el array como el mensaje\nreturn [{\n  json: {\n    especialidades: especialidades,\n    total: especialidades.length,\n    listadoEspecialidades: listadoEspecialidades,\n    mensaje: mensaje,\n    mensajeBoton: mensajeBoton,\n    // Estructura completa para mensaje interactivo\n    interactive_body: mensajeBoton,\n    interactive_button_id: \"menu_principal\",\n    interactive_button_title: \"MENU PRINCIPAL\"\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-112,4416],"id":"043e0a38-668b-4ffe-8390-405d3ffabd3e","name":"Msg preparado1"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filtro Tipo Mensaje').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"{{ $('Msg preparado1').item.json.mensajeBoton }}\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"sacar_turno\",\n            \"title\": \"TOMAR TURNO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"menu_principal\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[320,4416],"id":"27359c0e-1403-4e7b-b456-4c41c6a2193b","name":"ENVIA-> MENU-SACAR TURNO","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filtro Tipo Mensaje').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"{{ $('Msg preparado').item.json.mensajeBoton }}\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"sacar_turno\",\n            \"title\": \"TOMAR TURNO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"menu_principal\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[192,4080],"id":"387664ed-6b85-4fce-9d90-eadbe1f20a6e","name":"ENVIA-> MENU-SACAR TURNO1","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"content":"## INFO GENERAL - ESPECIALIDADES","height":304,"width":992,"color":5},"type":"n8n-nodes-base.stickyNote","position":[-880,4304],"typeVersion":1,"id":"6927415e-c9da-4bb1-a8a6-94dc978fbeb5","name":"Sticky Note3"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"flujo-medicos","leftValue":"={{ $json.tipoFlujo }}","rightValue":"medicos","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"ğŸ‘¨â€âš•ï¸ MÃ‰DICOS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"flujo-especialidades","leftValue":"={{ $json.tipoFlujo }}","rightValue":"especialidades","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"ğŸ©º ESPECIALIDADES"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"flujo-directo","leftValue":"={{ $json.esFlujoDirecto }}","rightValue":"","operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"renameOutput":true,"outputKey":"â„¹ï¸ INFORMACIÃ“N GENERAL"}]},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-832,4400],"id":"6051aac8-1b9d-444a-9014-aa42086e4393","name":"ğŸ”€ SWITCH INFO FLUJOS"},{"parameters":{"content":"## INFO GENERAL - OTROS MENSAJES","height":368,"width":992,"color":5},"type":"n8n-nodes-base.stickyNote","position":[-880,4640],"typeVersion":1,"id":"87c153ef-0cea-4ade-b2d3-c9343bd1361e","name":"Sticky Note"},{"parameters":{"operation":"set","key":"=status:{{ $('msg').item.json.body.to }}","value":"={{ $('msg').item.json.estadoActual }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3248,1232],"id":"6bbcb3b5-9d73-43e8-ac67-6545b1fd3acc","name":"STATUS:MENU=1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"\n\nconst contactNumber = $json.contactNumber;\n\n// Mensaje con botones para elegir tipo de turno\nconst mensajeBody = {\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": contactNumber,\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ğŸ«€ INSTITUTO DE CARDIOLOGÃA LA PLATA\"\n    },\n    \"body\": {\n      \"text\": \"Recuerda que MOMENTÃNEAMENTE SOLO DAMOS LOS TURNOS MÃS PRÃ“XIMOS\\n\\nSi necesita una fecha mÃ¡s lejana elija la opciÃ³n de administraciÃ³n\"\n    },\n    \"footer\": {\n      \"text\": \"ğŸ“… Lun-Vie 8-20hs\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"con-consultorio\",\n            \"title\": \"TURNOS CONSULTORIO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"con-estudio\",\n            \"title\": \"TURNOS ESTUDIO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"volver-atras\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n};\n\n// Log\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\nconsole.log('ğŸ“… SELECCIONAR TIPO DE TURNO');\nconsole.log('ğŸ“± Destinatario:', contactNumber);\nconsole.log('ğŸ¯ Estado: TURNOS:TIPO_TURNO');\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n\n// Retornar\nreturn [{\n  json: {\n    body: mensajeBody,\n    categoria: 'INICIAR_TOMAR_TURNO',\n    contactNumber: contactNumber,\n    estadoActual: 'TURNOS:TIPO_TURNO'\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-576,2640],"id":"2bb17ace-f5db-4410-9d7d-b2932f9cb942","name":"ğŸ« Router GestiÃ³n Turnos1"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.body.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.body.recipient_type }}"},{"name":"to","value":"={{ $json.body.to }}"},{"name":"type","value":"={{ $json.body.type }}"},{"name":"interactive","value":"={{ $json.body.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-352,2640],"id":"483cf002-3cf2-4a69-9144-77cbd41cf539","name":"PACIENTE REGISTRADO","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=status:{{ $('msg_clasificador').first().json.contactNumber }}","value":"={{ $('ğŸ« Router GestiÃ³n Turnos1').item.json.estadoActual }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-128,2640],"id":"48bd3d5b-d707-4052-a81b-494dc5e9c1ad","name":"â±ï¸ STATUS PRIMERA VEZ2","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"validar-dni","leftValue":"={{ $json.categoria }}","rightValue":"VALIDAR_DNI","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"ğŸ” VALIDAR DNI (IA)"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"ingreso-dni-menu","leftValue":"={{ $json.categoria }}","rightValue":"INGRESO_DNI","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"ğŸ“‹ DNI DESDE MENU"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"ingreso-datos","leftValue":"={{ ['INGRESO_DATOS_PACIENTE','SOLICITAR_DNI'].includes($json.categoria) || $json.estadoAnterior === 'PACIENTE_NUEVO_ERROR'}}","rightValue":"INGRESO_DATOS_PACIENTE","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ğŸ“ INGRESO DATOS"}]},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-800,2864],"id":"9cb5b7ab-9e0e-4da9-a22d-eeffa26f2b37","name":"ğŸ”€ SWITCH DATOS PACIENTE"},{"parameters":{"jsCode":"// ============================================\n// MENSAJE: SOLICITAR DNI\n// ============================================\n// Solicita al usuario que ingrese su DNI para validaciÃ³n\n// ============================================\nconst contactNumber = $json.contactNumber;\n\n// Mensaje solicitando DNI\nconst mensajeBody = {\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": contactNumber,\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": \"ğŸ“ *POR FAVOR, ESCRIBA SU DNI*\\n\\nğŸ”¢ *Formato:* Solo nÃºmeros, sin puntos ni espacios\\n\\nğŸ’¡ *EJEMPLO:* 35987654\\n\\nğŸ‘‰ Escriba su DNI y presione ENVIAR\"\n  }\n};\n\n// Log\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\nconsole.log('ğŸ“ SOLICITAR DNI');\nconsole.log('ğŸ“± Destinatario:', contactNumber);\nconsole.log('ğŸ¯ Estado: DATOS:SOLICITAR_DNI');\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n\n// Retornar\nreturn [{\n  json: {\n    body: mensajeBody,\n    categoria: 'PACIENTE_REGISTRADO',\n    contactNumber: contactNumber,\n    estadoActual: 'DATOS:SOLICITAR_DNI'\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2784,928],"id":"766cf99d-f3b3-43fc-8728-b4b2772815a0","name":"PACIENTE REGISTRADO1"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.body.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.body.recipient_type }}"},{"name":"to","value":"={{ $json.body.to }}"},{"name":"text","value":"={{ $json.body.text }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3008,928],"id":"85086bd3-269a-43e8-859d-6276e55667f5","name":"SOLICITAR DNI","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=status:{{ $('msg_clasificador').first().json.contactNumber }}","value":"={{ $('ğŸ”€ SWITCH GESTIÃ“N TURNOS').item.json.estadoActual }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3232,928],"id":"20a376e9-cf1a-4e4e-9e16-70f91f7dd8a5","name":"â±ï¸ STATUS PRIMERA VEZ3","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"068a964d-25b6-4a1f-8e05-c47dd2fea4b7","leftValue":"={{ $json.output.ERROR }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[224,144],"id":"5ca50854-1a82-40f2-a118-dbb054e94c9d","name":"Error informacion de usuario"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Variables').first().json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"âš ï¸ {{ $json.output.ERROR_MESSAGE }}\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[464,16],"id":"ec15c9c0-cb39-4416-b6d4-68809ef0b2d5","name":"âš ï¸ DATOS INCORRECTOS","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[-352,0],"id":"a492d6b5-e44d-45c1-9273-68d9dcf19bb5","name":"OpenRouter Chat Model1","credentials":{"openRouterApi":{"id":"ZlcbniUoDvrFqCIJ","name":"OpenRouter ICLP"}}},{"parameters":{"jsonSchemaExample":"{  \n  \"DNI\": \"string\",  \n  \"ERROR\": false,\n  \"ERROR_MESSAGE\": \"\"\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[64,-32],"id":"65f68828-5f47-4426-9826-3963b76044ee","name":"Structured Output Parser1"},{"parameters":{"promptType":"define","text":"=dni usuario :{{ $('ğŸ”€ ROUTER PRINCIPAL').first().json.mensaje }}","hasOutputParser":true,"options":{"systemMessage":"=# TAREA\n\n- Analizar el contido que llega y ordenarlo en un objeto JSON\n\n{\n  \n  \"DNI\":\"\",\n  \"ERROR\": false,\n  \"ERROR_MESSAGE\": \"\"\n}\n\n# IMPORTANTE\n\n- Debes analizar si el dni esta bien escrito, debe contener entre 7 y 8 digitos ya que los usuarios mayores poseen 7 digitos y los mas actuales 8 digitos.\n- No deben contener espacios ni puntos, si el mensaje del usuario es > DNI 35.946.257 debes formatearlo solo al numero 35946257\n- Si da error debes preparar un mensaje de devolucion para colocarlo en ERROR_MESSAGE"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[-176,144],"id":"3f605ac6-9e8b-4ef8-81b2-2ec400fa212c","name":"AI Agent"},{"parameters":{"workflowId":{"__rl":true,"value":"oB7pjyME2Gvo5moH","mode":"list","cachedResultName":"SUB - GET_PACIENTE"},"workflowInputs":{"mappingMode":"defineBelow","value":{"dni":"={{ $json.output.DNI || $('DNI1').item.json.status.replace('DNI:', '') ||$('YA SE ACTIVO MENU?').item.json.status.replace('DNI:', '')  }}","telefono":"={{ $('Variables').first().json.contactNumber }}"},"matchingColumns":["dni"],"schema":[{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"telefono","displayName":"telefono","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[480,368],"id":"0d423bef-686f-47db-9bae-3405a3c8b9f2","name":"Get_Paciente1"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Variables').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ğŸ«€ INSTITUTO DE CARDIOLOGÃA LA PLATA\"\n    },\n    \"body\": {\n      \"text\": \"*HOLA {{ $json.output.paciente_nombre }}* âœ“\\n\\n*ğŸ“‹ VERIFICACIÃ“N DE DATOS*\\n\\nCONFIRMÃ QUE TU INFORMACIÃ“N SEA CORRECTA:\\n\\nâ–ªï¸ *NOMBRE:* {{ $json.output.paciente_nombre }}\\n\\nâ–ªï¸ *DNI:* {{ $json.output.paciente_dni }}\\n\\nâ–ªï¸ *TELÃ‰FONO:* {{ $json.output.paciente_celular }}\\n\\nâœ“ *Â¿LOS DATOS SON CORRECTOS?*\\nPRESIONÃ CONTINUAR\\n\\nğŸ’¬ *Â¿NECESITÃS CORREGIR ALGO?*\\nCOMUNICATE CON ADMINISTRACIÃ“N:\\n*ğŸ“ (0221) 490-6310*\"\n    },\n    \"footer\": {\n      \"text\": \"LUN-VIE 8-20HS | SÃB 8-13HS\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"CONTINUAR\",\n            \"title\": \"CONTINUAR\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"MENU-PRINCIPAL\",\n            \"title\": \"MENÃš PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[960,464],"id":"cf5535e5-758e-47e3-81fb-646b8165f774","name":"âœ… DATOS VALIDADOS","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"m1kjf7ed0befl04","returnAll":true,"options":{}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[-688,144],"id":"06478264-aa8f-4fd6-abb5-97e823748790","name":"obra_social1","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"jsCode":"return {\n    total: $input.all().length,\n    obrasociales: $input.all().map(item => ({\n        Id_os: item.json.Id,\n        nombre_obrasocial: item.json.nombre_obrasocial,\n        obrasocial: item.json.obrasocial\n    }))\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-464,144],"id":"8887deb4-98cc-498b-9996-e54b4b7d579b","name":"Code8"},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Variables').first().json.contactNumber }}","sessionTTL":600,"contextWindowLength":10},"type":"@n8n/n8n-nodes-langchain.memoryRedisChat","typeVersion":1.5,"position":[-352,416],"id":"00656f57-93d5-478b-9d21-b6058b7b594f","name":"Redis Chat Memory","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Variables').first().json.contactNumber }}","value":"=DATOS:DNI_VALIDADO:{{ $('Get_Paciente1').item.json.output.paciente_dni }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1184,464],"id":"f021a1cd-bfbd-4003-9ee7-d56feb6d7934","name":"DNI VERIFICADO","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"const contactNumber = $json.contactNumber;\n\n// Mensaje con botones de gestiÃ³n de turnos\nconst mensajeBody = {\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": contactNumber,\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ğŸ«€ ICLP - GESTIÃ“N DE TURNOS\"\n    },\n    \"body\": {\n      \"text\": \"*ğŸ“‹ GESTIÃ“N DE TURNOS*\\n\\n*Â¿QUÃ‰ DESEA HACER?*\\n\\n*ğŸ“… TOMAR TURNO*\\nâ†’ AGENDAR UNA NUEVA CONSULTA CON NUESTROS ESPECIALISTAS\\n\\n*âŒ CANCELAR TURNO*\\nâ†’ ANULAR UN TURNO YA PROGRAMADO\\n\\n*ğŸ“ MIS TURNO/S*\\nâ†’ VER SUS PRÃ“XIMAS CITAS AGENDADAS\\n\\nğŸ‘‡ *SELECCIONE UNA OPCIÃ“N PARA CONTINUAR*\"\n    },\n    \"footer\": {\n      \"text\": \"ğŸ“… LUN-VIE 8-20HS\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"tomar-turno\",\n            \"title\": \"TOMAR TURNO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"cancelar-turno\",\n            \"title\": \"CANCELAR TURNO\"\n          }          \n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"mis-turnos\",\n            \"title\": \"MIS TURNOS\"\n          }        \n        }\n      ]\n    }\n  }\n};\n\n// Log\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\nconsole.log('ğŸ“‹ MENÃš GESTIÃ“N DE TURNOS');\nconsole.log('ğŸ“± Destinatario:', contactNumber);\nconsole.log('ğŸ¯ Estado: MENU:GESTION_TURNOS');\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n\n// Retornar\nreturn [{\n  json: {\n    body: mensajeBody,\n    categoria: 'MENU_GESTION_TURNOS',\n    contactNumber: contactNumber,\n    estadoActual: 'MENU:GESTION_TURNOS'\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2800,1232],"id":"5a7e4814-5c76-4a8d-b94a-6c1a3a4beedd","name":"msg"},{"parameters":{"operation":"set","key":"=status:{{ $('LISTA_ESPECIALIDADES_BLOQUES').item.json.to }}","value":"={{ $('LISTA_ESPECIALIDADES_BLOQUES').item.json.estadoActual }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3408,1984],"id":"34941c24-52aa-41c8-9f48-e3dce1d60c03","name":"ESPECIALIDADES1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.recipient_type }}"},{"name":"to","value":"={{ $json.to }}"},{"name":"type","value":"={{ $json.type }}"},{"name":"interactive","value":"={{ $json.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3184,1984],"id":"0ec82555-fb32-473c-8a40-9ecf51103a38","name":"ğŸ©» ESPECIALIDADES1","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"mi8p2u7tvuplzt5","returnAll":true,"options":{"sort":{"property":[{"field":"Especialidad"}]}}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[2736,1984],"id":"1fa5a396-767b-486e-a18a-1b8149d6ec52","name":"Get_Especialidades1","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"jsCode":"// ============================================\n// LISTA DE ESPECIALIDADES CON BLOQUES\n// ============================================\n// Divide las especialidades en dos bloques:\n// - Primer bloque: 9 especialidades + botÃ³n VER MÃS\n// - Segundo bloque: Especialidades restantes\n// ============================================\n\n// Obtener todas las especialidades del input\nconst items = $input.all();\n\n// Obtener contactNumber desde mÃºltiples fuentes posibles\nlet contactNumber;\ntry {\n  // Intentar obtener del nodo clasificador\n  contactNumber = $('msg_clasificador').first().json.contactNumber;\n} catch (e) {\n  try {\n    // Si no, intentar del router principal\n    contactNumber = $('ROUTER PRINCIPAL').first().json.contactNumber;\n  } catch (e2) {\n    try {\n      // Si no, intentar del switch gestiÃ³n turnos\n      contactNumber = $('SWITCH GESTIÃ“N TURNOS').first().json.contactNumber;\n    } catch (e3) {\n      // Ãšltimo recurso: buscar en cualquier item del input\n      contactNumber = items[0]?.json?.contactNumber || $json.contactNumber;\n    }\n  }\n}\n\n// Verificar el estado actual para determinar quÃ© bloque mostrar\nlet estadoActual;\ntry {\n  estadoActual = $('msg_clasificador').first().json.estadoActual || \n                 $('msg_clasificador').first().json.nuevoEstado || \n                 $json.estadoActual || \n                 $json.nuevoEstado || \n                 'TURNOS:ESPECIALIDADES';\n} catch (e) {\n  estadoActual = $json.estadoActual || $json.nuevoEstado || 'TURNOS:ESPECIALIDADES';\n}\n\nconst esVerMas = estadoActual === 'TURNOS:ESPECIALIDADES:VER_MAS';\n\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\nconsole.log('ğŸ©º PREPARANDO ESPECIALIDADES');\nconsole.log('ğŸ“± Contact Number:', contactNumber);\nconsole.log('ğŸ“Š Estado actual:', estadoActual);\nconsole.log('ğŸ“‹ Bloque:', esVerMas ? 'VER MÃS (segundo)' : 'PRINCIPAL (primero)');\nconsole.log('ğŸ“¦ Total especialidades:', items.length);\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n\n// Crear el array de rows para TODAS las especialidades\nconst todasLasRows = items.map(item => {\n  const especialidad = item.json.Especialidad;\n  const codigo = item.json.Codigo;\n  \n  // Convertir a mayÃºsculas\n  let nombreEspecialidad = especialidad.toUpperCase();\n  \n  // Si tiene parÃ©ntesis, tomar solo lo que estÃ¡ antes\n  if (nombreEspecialidad.includes('(')) {\n    nombreEspecialidad = nombreEspecialidad.split('(')[0].trim();\n  }\n  \n  // Si tiene barra, tomar solo la primera parte\n  if (nombreEspecialidad.includes('/')) {\n    nombreEspecialidad = nombreEspecialidad.split('/')[0].trim();\n  }\n  \n  // Si tiene mÃºltiples palabras, tomar solo la primera palabra\n  if (nombreEspecialidad.includes(' ')) {\n    nombreEspecialidad = nombreEspecialidad.split(' ')[0];\n  }\n  \n  // Crear el title con formato: ESPECIALIDAD-CODIGO\n  let title = `${nombreEspecialidad}-${codigo}`;\n  \n  // Si aÃºn es muy largo, cortar a 24 caracteres\n  if (title.length > 24) {\n    title = title.substring(0, 21) + '...';\n  }\n  \n  // Crear descripciÃ³n completa\n  let description = especialidad;\n  \n  // WhatsApp permite MÃXIMO 72 caracteres en ROW_DESCRIPTION\n  if (description.length > 72) {\n    description = description.substring(0, 69) + '...';\n  }\n  \n  return {\n    id: codigo,\n    title: title,\n    description: description\n  };\n});\n\n// Dividir en dos bloques\nconst primerBloque = todasLasRows.slice(0, 9);\nconst segundoBloque = todasLasRows.slice(9);\n\n// Seleccionar quÃ© bloque mostrar\nlet rows;\nlet headerText;\nlet bodyText;\nlet nuevoEstado;\n\nif (esVerMas) {\n  // SEGUNDO BLOQUE (VER MÃS)\n  rows = segundoBloque;\n  headerText = \"ğŸ“‹ MÃS ESPECIALIDADES\";\n  bodyText = \"*Estas son las especialidades restantes:*\\n\\nğŸ‘‡ *SELECCIONÃ LA ESPECIALIDAD QUE NECESITÃS*\\n\\nLuego podrÃ¡s elegir el mÃ©dico y horario disponible.\";\n  nuevoEstado = 'TURNOS:ESPECIALIDADES:VER_MAS';\n  \n  // Agregar botÃ³n \"VOLVER\" para regresar al primer bloque\n  rows.push({\n    id: \"volver-especialidades-anterior\",\n    title: \"â¬…ï¸ VER ANTERIORES\",\n    description: \"Regresar a las primeras especialidades\"\n  });\n  \n  console.log('âœ… Mostrando segundo bloque:', segundoBloque.length, 'especialidades + botÃ³n VOLVER');\n} else {\n  // PRIMER BLOQUE (con botÃ³n VER MÃS)\n  rows = primerBloque;\n  headerText = \"ğŸ©º ESPECIALIDADES\";\n  bodyText = \"âš ï¸ *ELIJA LA ESPECIALIDAD Y LUEGO EL MEDICO*\\n\\nğŸ‘‡ *MARCÃ ABAJO*\";\n  nuevoEstado = 'TURNOS:ESPECIALIDADES';\n  \n  // Agregar botÃ³n \"VER MÃS\" solo si hay mÃ¡s especialidades\n  if (segundoBloque.length > 0) {\n    rows.push({\n      id: \"ver-mas\",\n      title: \"â• VER MÃS ESPECIALIDADES\",\n      description: \"Ver mÃ¡s opciones disponibles\"\n    });\n    console.log('âœ… Mostrando primer bloque:', primerBloque.length, 'especialidades + botÃ³n VER MÃS');\n  } else {\n    console.log('âœ… Mostrando todas las especialidades:', rows.length, '(no hay botÃ³n VER MÃS)');\n  }\n}\n\n// Retornar el JSON completo con la estructura de WhatsApp\nreturn [{\n  json: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: contactNumber,\n    type: \"interactive\",\n    interactive: {\n      type: \"list\",\n      header: {\n        type: \"text\",\n        text: headerText\n      },\n      body: {\n        text: bodyText\n      },\n      footer: {\n        text: \"ğŸ“… LUN-VIE 8-20HS\"\n      },\n      action: {\n        button: \"VER ESPECIALIDADES\",\n        sections: [\n          {\n            title: \"ELEGIR UNA OPCIÃ“N\",\n            rows: rows\n          }\n        ]\n      }\n    },\n    \n    // Metadatos para el siguiente nodo\n    contactNumber: contactNumber,\n    estadoActual: nuevoEstado,\n    bloqueActual: esVerMas ? 'segundo' : 'primero',\n    totalEspecialidades: todasLasRows.length\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2960,1984],"id":"99f2ec95-8c4c-4a8c-a513-9c4f7a51825b","name":"LISTA_ESPECIALIDADES_BLOQUES"},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"mhwp4qt6r2d7ymm","returnAll":true,"options":{"fields":[],"where":"=(Codigo,eq,{{ $('Preparar Redis').item?.json?.metadata?.codigoEspecialidad || $('ESPECIALIDAD').item.json.especialidad }})"}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[2736,2144],"id":"04baa91a-7d22-4a5b-b43b-0924cafbdfaf","name":"get_medicos2","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"operation":"set","key":"=status:{{ $('LISTA_MEDICOS').item.json.to }}","value":"={{ $('LISTA_MEDICOS').first().json.estadoActual }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3408,2144],"id":"b15563fb-194e-4fa5-a611-4c46044a400f","name":"ğŸ©º MEDICOS2","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"// ============================================\n// 1. EXTRACCIÃ“N DE DATOS DE ENTRADA\n// ============================================\nconst items = $input.all();\n\nif (!items || items.length === 0) {\n  throw new Error('No hay mÃ©dicos disponibles para mostrar');\n}\n\nlet contactNumber;\ntry {\n  contactNumber = $('msg_clasificador').first().json.contactNumber;\n} catch (e) {\n  try {\n    contactNumber = $('ROUTER PRINCIPAL').first().json.contactNumber;\n  } catch (e2) {\n    try {\n      contactNumber = $('SWITCH GESTIÃ“N TURNOS').first().json.contactNumber;\n    } catch (e3) {\n      contactNumber = items[0]?.json?.contactNumber || $json.contactNumber;\n    }\n  }\n}\n\nif (!contactNumber) {\n  throw new Error('No se pudo obtener el nÃºmero de contacto');\n}\n\n// ============================================\n// 2. EXTRACCIÃ“N DE ESTADO Y METADATA\n// ============================================\nlet estadoActual;\nlet especialidadSeleccionada;\nlet codigoEspecialidad;\nlet paginaActual = 1;\n\ntry {\n  const clasificador = $('msg_clasificador').first().json;\n  estadoActual = clasificador.estadoActual || clasificador.nuevoEstado || 'TURNOS:MEDICOS';\n  especialidadSeleccionada = clasificador.metadata?.especialidad || 'Especialidad';\n  codigoEspecialidad = clasificador.metadata?.codigoEspecialidad || '';\n  paginaActual = clasificador.metadata?.paginaMedicos || 1;\n} catch (e) {\n  estadoActual = $json.estadoActual || $json.nuevoEstado || 'TURNOS:MEDICOS';\n  especialidadSeleccionada = $json.especialidad || 'Especialidad';\n  codigoEspecialidad = $json.codigoEspecialidad || '';\n  paginaActual = $json.metadata?.paginaMedicos || 1;\n}\n\n// ============================================\n// 3. CÃLCULO DE PAGINACIÃ“N OPTIMIZADO\n// ============================================\nconst totalMedicos = items.length;\nlet totalPaginas, indiceInicio, indiceFin, medicosPorPagina;\nlet esPrimeraPagina, esUltimaPagina, esPaginaIntermedia;\n\nif (totalMedicos <= 8) {\n  // Caso: 8 o menos mÃ©dicos caben en una pÃ¡gina con 1 botÃ³n\n  totalPaginas = 1;\n  indiceInicio = 0;\n  indiceFin = totalMedicos;\n  medicosPorPagina = totalMedicos;\n  esPrimeraPagina = true;\n  esUltimaPagina = true;\n  esPaginaIntermedia = false;\n} else {\n  // Caso: mÃ¡s de 8 mÃ©dicos, se necesitan mÃºltiples pÃ¡ginas\n  // Primera pÃ¡gina: 8 mÃ©dicos (para dejar espacio a 2 botones)\n  // PÃ¡ginas siguientes: 8 mÃ©dicos c/u\n  const medicosRestantes = totalMedicos - 8;\n  const paginasAdicionales = Math.ceil(medicosRestantes / 8);\n  totalPaginas = 1 + paginasAdicionales;\n  \n  esPrimeraPagina = (paginaActual === 1);\n  esUltimaPagina = (paginaActual === totalPaginas);\n  esPaginaIntermedia = !esPrimeraPagina && !esUltimaPagina;\n  \n  if (esPrimeraPagina) {\n    // Primera pÃ¡gina: 8 mÃ©dicos + 2 botones = 10 filas âœ…\n    indiceInicio = 0;\n    indiceFin = 8;\n    medicosPorPagina = 8;\n  } else {\n    // PÃ¡ginas siguientes: Ã­ndice desde 8 en adelante\n    indiceInicio = 8 + ((paginaActual - 2) * 8);\n    \n    if (esUltimaPagina) {\n      indiceFin = totalMedicos;\n      medicosPorPagina = indiceFin - indiceInicio;\n    } else {\n      indiceFin = indiceInicio + 8;\n      medicosPorPagina = 8;\n    }\n  }\n}\n\n// ============================================\n// 4. CONSTRUCCIÃ“N DE FILAS DE MÃ‰DICOS\n// ============================================\nconst medicosBloque = items.slice(indiceInicio, indiceFin);\n\nconst rows = medicosBloque.map((item, index) => {\n  const medico = item.json.Medico || item.json.medico || '';\n  const matricula = item.json.Matricula || item.json.matricula || '';\n  const especialidad = item.json.Especialidad || item.json.especialidad || '';\n  \n  if (!medico || !matricula) {\n    console.warn('MÃ©dico sin datos completos:', item.json);\n  }\n  \n  const indiceGlobal = indiceInicio + index;\n  const idUnico = `med-${matricula}-${indiceGlobal}`;\n  \n  let nombreCompleto = String(medico).toUpperCase();\n  \n  if (nombreCompleto.includes('(')) {\n    nombreCompleto = nombreCompleto.split('(')[0].trim();\n  }\n  \n  if (nombreCompleto.includes('/')) {\n    nombreCompleto = nombreCompleto.split('/')[0].trim();\n  }\n  \n  const palabras = nombreCompleto.split(' ').filter(p => p.length > 0);\n  let apellido = palabras[0] || 'SIN_APELLIDO';\n  \n  const matriculaStr = String(matricula);\n  const separador = '-';\n  const espacioDisponible = 24 - matriculaStr.length - separador.length;\n  \n  if (apellido.length > espacioDisponible) {\n    apellido = apellido.substring(0, espacioDisponible);\n  }\n  \n  let title = `${apellido}${separador}${matriculaStr}`;\n  \n  if (title.length > 24) {\n    title = title.substring(0, 24);\n  }\n  \n  let description = String(medico).toUpperCase();\n  \n  if (especialidad && String(especialidad).trim() !== '') {\n    description = `${description} - ${especialidad}`;\n  }\n  \n  if (description.length > 72) {\n    description = description.substring(0, 69) + '...';\n  }\n  \n  return {\n    id: idUnico,\n    title: title,\n    description: description\n  };\n});\n\n// ============================================\n// 5. CONSTRUCCIÃ“N DE BOTONES DE NAVEGACIÃ“N\n// ============================================\nconst botonesNavegacion = [];\n\nif (esPrimeraPagina) {\n  // âœ… PRIMERA PÃGINA: Siempre mostrar CAMBIAR ESPECIALIDAD\n  botonesNavegacion.push({\n    id: 'cambiar-especialidad',\n    title: 'ğŸ”„ CAMBIAR ESPECIALIDAD',\n    description: 'Elegir otra especialidad mÃ©dica'\n  });\n  \n  // Si hay mÃ¡s pÃ¡ginas, agregar VER MÃS\n  if (!esUltimaPagina) {\n    botonesNavegacion.push({\n      id: 'ver-mas-medicos',\n      title: `â• VER MÃS (${paginaActual + 1})`,\n      description: `Ver pÃ¡gina ${paginaActual + 1} de ${totalPaginas}`\n    });\n  }\n  \n} else if (esPaginaIntermedia) {\n  // ğŸ“„ PÃGINA INTERMEDIA: ANTERIORES + VER MÃS\n  botonesNavegacion.push({\n    id: 'ver-anteriores-medicos',\n    title: `â¬…ï¸ ANTERIORES (${paginaActual - 1})`,\n    description: `Volver a pÃ¡gina ${paginaActual - 1}`\n  });\n  \n  botonesNavegacion.push({\n    id: 'ver-mas-medicos',\n    title: `â• VER MÃS (${paginaActual + 1})`,\n    description: `Ver pÃ¡gina ${paginaActual + 1} de ${totalPaginas}`\n  });\n  \n} else if (esUltimaPagina && !esPrimeraPagina) {\n  // ğŸ”š ÃšLTIMA PÃGINA: INICIO + CAMBIAR ESPECIALIDAD\n  botonesNavegacion.push({\n    id: 'volver-inicio-medicos',\n    title: 'â¬…ï¸ INICIO',\n    description: 'Ver primera pÃ¡gina'\n  });\n  \n  botonesNavegacion.push({\n    id: 'cambiar-especialidad',\n    title: 'ğŸ”„ CAMBIAR ESPECIALIDAD',\n    description: 'Elegir otra especialidad mÃ©dica'\n  });\n}\n\n// ============================================\n// 6. COMBINACIÃ“N Y VALIDACIÃ“N DE FILAS\n// ============================================\nconst rowsFinales = [...rows, ...botonesNavegacion];\n\n// ValidaciÃ³n de lÃ­mite de 10 filas\nif (rowsFinales.length > 10) {\n  throw new Error(`ERROR: Se excediÃ³ el lÃ­mite de 10 filas. Total: ${rowsFinales.length} (MÃ©dicos: ${rows.length}, Botones: ${botonesNavegacion.length})`);\n}\n\n// ============================================\n// 7. CONSTRUCCIÃ“N DEL TEXTO DEL MENSAJE\n// ============================================\nlet bodyText;\nif (totalPaginas === 1) {\n  bodyText = `*âœ… ${totalMedicos} MÃ‰DICO${totalMedicos > 1 ? 'S' : ''} DISPONIBLE${totalMedicos > 1 ? 'S' : ''}*\\n\\n*ğŸ©º ESPECIALIDAD:*\\n${especialidadSeleccionada}\\n\\n*ğŸ‘‡ SELECCIONÃ TU PROFESIONAL:*`;\n} else {\n  const rangoInicio = indiceInicio + 1;\n  const rangoFin = indiceFin;\n  bodyText = `*ğŸ‘¨â€âš•ï¸ PROFESIONALES DISPONIBLES*\\n\\n*ğŸ©º ESPECIALIDAD:*\\n${especialidadSeleccionada}\\n\\n*ğŸ“„ PÃGINA ${paginaActual} DE ${totalPaginas}*\\n*ğŸ“‹ MOSTRANDO ${rangoInicio}-${rangoFin} DE ${totalMedicos} MÃ‰DICOS*\\n\\n*ğŸ‘‡ SELECCIONÃ TU PROFESIONAL:*`;\n}\n\n// ============================================\n// 8. RETORNO DEL MENSAJE DE WHATSAPP\n// ============================================\nreturn [{\n  json: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: contactNumber,\n    type: \"interactive\",\n    interactive: {\n      type: \"list\",\n      header: {\n        type: \"text\",\n        text: \"ğŸ‘¨â€âš•ï¸ PROFESIONALES\"\n      },\n      body: {\n        text: bodyText\n      },\n      footer: {\n        text: \"ğŸ“… LUN-VIE 8-20HS\"\n      },\n      action: {\n        button: \"VER MÃ‰DICOS\",\n        sections: [\n          {\n            title: \"ELEGIR PROFESIONAL\",\n            rows: rowsFinales\n          }\n        ]\n      }\n    },\n    contactNumber: contactNumber,\n    estadoActual: 'TURNOS:MEDICOS',\n    categoria: 'LISTA_MEDICOS',\n    metadata: {\n      especialidad: especialidadSeleccionada,\n      codigoEspecialidad: codigoEspecialidad,\n      paginaMedicos: paginaActual,\n      totalPaginas: totalPaginas,\n      totalMedicos: totalMedicos,\n      medicosMostrados: medicosBloque.length\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2960,2144],"id":"9698934a-2cfa-4bb6-b7ef-830b034a80da","name":"LISTA_MEDICOS"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.recipient_type }}"},{"name":"to","value":"={{ $json.to }}"},{"name":"type","value":"={{ $json.type }}"},{"name":"interactive","value":"={{ $json.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3184,2144],"id":"de93e4c2-91d6-46ad-8e7a-699ad48b2cfa","name":"Medicos2","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"workflowId":{"__rl":true,"value":"kmoVJGP4RL3PTi16","mode":"list","cachedResultName":"SUB - HORARIOS_TURNOS_PROXIMOS"},"workflowInputs":{"mappingMode":"defineBelow","value":{"matricula":"={{ $('Preparar Redis').first()?.json?.value?.parseJson()?.metadata?.matricula?.toNumber() || $('msg_clasificador').first().json.mensaje.match(/\\d+$/)[0].toNumber() }}","dni":"={{ $json.DATOS_PACIENTE.paciente_dni }}","fechaDesde":"={{ $now.toISO().toDateTime().format('yyyyMMdd').toNumber()}}"},"matchingColumns":[],"schema":[{"id":"matricula","displayName":"matricula","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"fechaDesde","displayName":"fechaDesde","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[3200,2896],"id":"984851c0-4a08-4d88-841f-06d42117e47d","name":"ğŸ“… Horarios Proximos"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json?.body?.messaging_product || $json.messaging_product }}"},{"name":"recipient_type","value":"={{ $json?.body?.recipient_type || $json.recipient_type }}"},{"name":"to","value":"={{ $('msg_clasificador').first().json.contactNumber }}"},{"name":"type","value":"={{ $json?.body?.type || $json.type }}"},{"name":"interactive","value":"={{ $json?.body?.interactive || $json.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3648,2896],"id":"63253d58-d021-4fb7-8192-2b62ad2c3035","name":"ğŸ• Fechas disponibles ","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"jsCode":"// ============================================\n// ğŸ“… LISTA DE HORARIOS DISPONIBLES\n// ============================================\n// Muestra lista interactiva con horarios disponibles\n// ============================================\n\n// MÃ‰DICOS CON TURNOS MES A MES (requieren llamar a administraciÃ³n)\nconst MEDICOS_MES_A_MES = [\n  'HONAINE',\n  'PEDERSOLI', \n  'COSTA MARIANO',\n  'GENONI'\n];\n\n// MATRÃCULAS DE MÃ‰DICOS MES A MES\nconst MATRICULAS_MES_A_MES = [\n  114788, // HONAINE\n  114793, // PEDERSOLI\n  118604, // COSTA MARIANO\n  115351  // GENONI\n];\n\n// Obtener todos los horarios del input\nconst fechasLibres = $input.first().json.fechas_libres;\n\n// Obtener DNI\nlet dni = null;\ntry {\n  dni = Number($('Preparar Redis').first().json.datosCliente.paciente_dni);\n  console.log('âœ… DNI obtenido:', dni);\n} catch (e) {\n  console.log('âš ï¸ No se encontrÃ³ DNI');\n}\n\n// Obtener matrÃ­cula\nlet matricula = null;\ntry {\n  matricula = Number($input.first().json.matricula || $('Preparar Redis').first().json.mensaje);\n  console.log('âœ… MatrÃ­cula obtenida:', matricula);\n} catch (e) {\n  console.log('âš ï¸ No se encontrÃ³ matrÃ­cula');\n}\n\n// Obtener mÃ©dico\nlet medico = null;\ntry {\n  medico = $('Preparar Redis').first().json.metadata.medico;\n  console.log('âœ… MÃ©dico obtenido:', medico);\n} catch (e) {\n  console.log('âš ï¸ No se encontrÃ³ mÃ©dico');\n}\n\n// Obtener especialidad seleccionada\nlet especialidadSeleccionada = null;\nlet codigoEspecialidad = null;\n\ntry {\n  especialidadSeleccionada = $input.first().json.especialidadSeleccionada;\n  codigoEspecialidad = $input.first().json.codigoEspecialidad;\n  console.log('âœ… Especialidad:', especialidadSeleccionada, '- CÃ³digo:', codigoEspecialidad);\n} catch (e) {\n  console.log('âš ï¸ No se encontrÃ³ especialidad en $input');\n}\n\n// Si no se encontrÃ³, buscar en Redis\nif (!especialidadSeleccionada || !codigoEspecialidad) {\n  try {\n    const redisValue = $('ESPECIALIDAD').first().json.value;\n    const redisData = typeof redisValue === 'string' ? JSON.parse(redisValue) : redisValue;\n    \n    if (redisData && redisData.metadata) {\n      especialidadSeleccionada = redisData.metadata.especialidadSeleccionada;\n      codigoEspecialidad = redisData.metadata.codigoEspecialidad;\n      console.log('âœ… Especialidad desde Redis:', especialidadSeleccionada, '- CÃ³digo:', codigoEspecialidad);\n    }\n  } catch (e) {\n    console.log('âš ï¸ No se pudo obtener especialidad desde Redis');\n  }\n}\n\n// Obtener contactNumber\nlet contactNumber = null;\ntry {\n  contactNumber = $input.first().json.contactNumber;\n} catch (e) {\n  console.log('âš ï¸ No se encontrÃ³ contactNumber en $input');\n}\n\nif (!contactNumber) {\n  try {\n    contactNumber = $('PREPARAR_DATOS_HORARIOS').first().json.contactNumber;\n  } catch (e) {\n    console.log('âš ï¸ No se encontrÃ³ contactNumber en PREPARAR_DATOS_HORARIOS');\n  }\n}\n\nif (!contactNumber) {\n  try {\n    const redisValue = $('ESPECIALIDAD').first().json.value;\n    const redisData = typeof redisValue === 'string' ? JSON.parse(redisValue) : redisValue;\n    contactNumber = redisData.contactNumber;\n  } catch (e) {\n    console.log('âš ï¸ No se encontrÃ³ contactNumber en Redis');\n  }\n}\n\nif (!contactNumber) {\n  try {\n    contactNumber = $('GET_PACIENTE_REGISTRADO').first().json.contactNumber;\n  } catch (e) {\n    console.log('âš ï¸ No se encontrÃ³ contactNumber en DATOS');\n  }\n}\n\nconsole.log('ğŸ“± Contact Number:', contactNumber);\n\n// ============================================\n// VERIFICAR SI ES MÃ‰DICO MES A MES\n// ============================================\nconst medicoNormalizado = medico ? medico.toUpperCase().trim() : '';\nconst esMedicoMesAMesPorNombre = MEDICOS_MES_A_MES.some(m => medicoNormalizado.includes(m));\nconst esMedicoMesAMesPorMatricula = matricula ? MATRICULAS_MES_A_MES.includes(matricula) : false;\nconst esMedicoMesAMes = esMedicoMesAMesPorNombre || esMedicoMesAMesPorMatricula;\n\nconsole.log('ğŸ” Verificando mÃ©dico:', medicoNormalizado);\nconsole.log('ğŸ” Verificando matrÃ­cula:', matricula);\nconsole.log('ğŸ“‹ Â¿Es mÃ©dico mes a mes por nombre?:', esMedicoMesAMesPorNombre);\nconsole.log('ğŸ“‹ Â¿Es mÃ©dico mes a mes por matrÃ­cula?:', esMedicoMesAMesPorMatricula);\nconsole.log('ğŸ“‹ Â¿Es mÃ©dico mes a mes?:', esMedicoMesAMes);\n\n// ============================================\n// CASO 1: MÃ‰DICO MES A MES (SIN TURNOS ONLINE)\n// ============================================\nif (esMedicoMesAMes) {\n  console.log('ğŸ“… MÃ©dico mes a mes detectado:', medico, '- MatrÃ­cula:', matricula);\n  \n  return [{\n    json: {\n      body: {\n        messaging_product: \"whatsapp\",\n        recipient_type: \"individual\",\n        to: contactNumber,\n        type: \"interactive\",\n        interactive: {\n          type: \"button\",\n          header: {\n            type: \"text\",\n            text: \"ğŸ“… TURNOS POR ADMINISTRACIÃ“N\"\n          },\n          body: {\n            text: `ğŸ©º *DR/A ${medico}*\\n\\nğŸ—“ï¸ *LOS TURNOS DE ESTE PROFESIONAL SE TOMAN MEDIANTE ADMINISTRACIÃ“N*\\n\\nPara solicitar tu turno:\\n\\nğŸ¢ VolvÃ© al *MENÃš PRINCIPAL* y elegÃ­:\\n*\"ADMINISTRACIÃ“N\"*\\n\\nğŸ“ *O LLAMANOS:*\\n*(0221) 490-6310*\\nLun-Vie 8-20hs | SÃ¡b 8-13hs\\n\\nÂ¡Te conseguimos el turno que necesites! ğŸ’š`\n          },\n          footer: {\n            text: \"â¤ï¸ CUIDAMOS TU SALUD CARDIOVASCULAR\"\n          },\n          action: {\n            buttons: [\n              {\n                type: \"reply\",\n                reply: {\n                  id: \"contactar-administracion\",\n                  title: \"ADMINISTRACIÃ“N\"\n                }\n              }\n            ]\n          }\n        }\n      },\n      categoria: 'MEDICO_MES_A_MES',\n      contactNumber: contactNumber,\n      DNI: dni,\n      metadata: {\n        dni: dni,\n        especialidadSeleccionada: especialidadSeleccionada,\n        codigoEspecialidad: codigoEspecialidad,\n        medicoMesAMes: medico,\n        matricula: matricula,\n        esMedicoMesAMes: true\n      }\n    }\n  }];\n}\n\n// ============================================\n// CASO 2: SIN TURNOS DISPONIBLES\n// ============================================\nif (!fechasLibres || fechasLibres.length === 0) {\n  console.log('âŒ No hay fechas disponibles');\n  console.log('ğŸ“‹ Preparando opciones de navegaciÃ³n...');\n  console.log('   Especialidad:', especialidadSeleccionada);\n  console.log('   CÃ³digo:', codigoEspecialidad);\n  console.log('   MÃ©dico sin turnos:', medico);\n  \n  return [{\n    json: {\n      body: {\n        messaging_product: \"whatsapp\",\n        recipient_type: \"individual\",\n        to: contactNumber,\n        type: \"interactive\",\n        interactive: {\n          type: \"button\",\n          header: {\n            type: \"text\",\n            text: \"âŒ SIN TURNOS DISPONIBLES\"\n          },\n          body: {\n            text: `ğŸ˜” *LO SENTIMOS, EL DR/A ${medico || 'SELECCIONADO/A'} NO TIENE TURNOS DISPONIBLES EN ESTE MOMENTO*\\n\\nğŸ’¡ *Â¿QUÃ‰ PODÃ‰S HACER?*\\n\\nğŸ‘¨â€âš•ï¸ *ELEGIR OTRO MÃ‰DICO*\\nVer otros profesionales de ${especialidadSeleccionada || 'la especialidad'}\\n\\nğŸ¢ *CONTACTAR ADMINISTRACIÃ“N*\\nVolvÃ© al *MENÃš PRINCIPAL* y elegÃ­:\\n*\"ADMINISTRACIÃ“N\"*\\n\\nTe ayudamos a encontrar el turno perfecto ğŸ’š\\n\\nğŸ“ *(0221) 490-6310*\\nLun-Vie 8-20hs | SÃ¡b 8-13hs`\n          },\n          footer: {\n            text: \"â¤ï¸ CUIDAMOS TU SALUD CARDIOVASCULAR\"\n          },\n          action: {\n            buttons: [\n              {\n                type: \"reply\",\n                reply: {\n                  id: \"elegir-otro-medico\",\n                  title: \"ADMINISTRACIÃ“N\"\n                }\n              }\n            ]\n          }\n        }\n      },\n      categoria: 'SIN_TURNOS',\n      contactNumber: contactNumber,\n      DNI: dni,\n      metadata: {\n        dni: dni,\n        especialidadSeleccionada: especialidadSeleccionada,\n        codigoEspecialidad: codigoEspecialidad,\n        medicoSinTurnos: medico,\n        matriculaSinTurnos: matricula\n      }\n    }\n  }];\n}\n\nconsole.log(`âœ… Fechas disponibles: ${fechasLibres.length}`);\n\n// Limitar a mÃ¡ximo 9 horarios\nconst fechasLimitadas = fechasLibres.slice(0, 9);\n\n// Crear mapeo de horarios con Unix timestamp\nconst horariosMap = {};\n\n// Crear el array de rows dinÃ¡micamente\nconst rows = fechasLimitadas.map(item => {\n  // Obtener la fecha y hora del formato \"2025-10-14,\\n 11:20\"\n  const fechaHoraRaw = item.fecha_y_hora;\n  \n  // Limpiar y separar fecha y hora\n  const [fecha, hora] = fechaHoraRaw.replace(/\\n/g, '').split(',').map(s => s.trim());\n  \n  // Crear objeto DateTime\n  const dt = DateTime.fromISO(`${fecha}T${hora}`, { \n    zone: 'America/Argentina/Buenos_Aires' \n  });\n  \n  // Obtener dÃ­a de la semana en espaÃ±ol\n  const diasSemana = ['DOM', 'LUN', 'MAR', 'MIÃ‰', 'JUE', 'VIE', 'SÃB'];\n  const diaSemana = diasSemana[dt.weekday % 7];\n  \n  // Formatear fecha como DD/MM\n  const fechaFormateada = dt.toFormat('dd/MM');\n  \n  // Crear el title: DÃA DD/MM - HH:MM\n  let title = `${diaSemana} ${fechaFormateada} - ${hora}`;\n  \n  // Si aÃºn es muy largo, cortar a 24 caracteres\n  if (title.length > 24) {\n    title = title.substring(0, 21) + '...';\n  }\n  \n  // Crear descripciÃ³n completa EN MAYÃšSCULAS\n  let description = `${diaSemana} ${dt.toFormat('dd/MM/yyyy')} A LAS ${hora} HS`;\n  \n  // WhatsApp permite MÃXIMO 72 caracteres en ROW_DESCRIPTION\n  if (description.length > 72) {\n    description = description.substring(0, 69) + '...';\n  }\n  \n  // ID Ãºnico: combinar fecha y hora sin separadores\n  const id = `${fecha.replace(/-/g, '')}-${hora.replace(/:/g, '')}`;\n  \n  // Convertir a Unix timestamp (milisegundos)\n  const fechaUnix = dt.toMillis();\n  \n  // Convertir hora a formato HHMM (string de 4 dÃ­gitos)\n  const horaFormato = hora.replace(':', '').padStart(4, '0');\n  \n  // Guardar en el mapa para uso posterior\n  horariosMap[id] = {\n    fechaUnix: fechaUnix,\n    hora: horaFormato,\n    fechaOriginal: fecha,\n    horaOriginal: hora,\n    title: title\n  };\n  \n  return {\n    id: id,\n    title: title,\n    description: description\n  };\n});\n\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\nconsole.log('âœ… Lista de horarios generada');\nconsole.log(`ğŸ“‹ Cantidad de horarios: ${rows.length}`);\nconsole.log('ğŸ“… Mapa de horarios:', JSON.stringify(horariosMap, null, 2));\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n\n// ============================================\n// CASO 3: CON TURNOS DISPONIBLES\n// ============================================\nreturn [{\n  json: {\n    body: {\n      messaging_product: \"whatsapp\",\n      recipient_type: \"individual\",\n      to: contactNumber,\n      type: \"interactive\",\n      interactive: {\n        type: \"list\",\n        header: {\n          type: \"text\",\n          text: \"ğŸ¥ TURNOS DISPONIBLES\"\n        },\n        body: {\n          text: `âœ¨ *Â¡ENCONTRAMOS ${fechasLimitadas.length} TURNO${fechasLimitadas.length > 1 ? 'S' : ''} DISPONIBLE${fechasLimitadas.length > 1 ? 'S' : ''}!*\\n\\nğŸ“… *SELECCIONÃ TU FECHA Y HORA*\\nğŸ‘‡ TocÃ¡ *\"VER TURNOS\"* para elegir\\n\\nğŸš¨ *Â¿NO ENCONTRÃS EL HORARIO QUE NECESITÃS?*\\n\\nğŸ¢ En el *MENÃš PRINCIPAL* elegÃ­:\\n*\"ADMINISTRACIÃ“N\"*\\n\\nTe conseguimos el turno que necesites ğŸ’š\\n\\nğŸ“ *(0221) 490-6310*\\nLun-Vie 8-20hs | SÃ¡b 8-13hs`\n        },\n        footer: {\n          text: \"â¤ï¸ ICLP - TU SALUD ES LO PRIMERO\"\n        },\n        action: {\n          button: \"VER TURNOS\",\n          sections: [\n            {\n              title: \"SELECCIONAR TURNO\",\n              rows: rows\n            }\n          ]\n        }\n      }\n    },\n    categoria: 'MOSTRAR_HORARIOS',\n    contactNumber: contactNumber,\n    DNI: dni,\n    matricula: matricula,\n    estadoActual: 'TURNOS:HORARIOS',\n    metadata: {\n      dni: dni,\n      matricula: matricula,\n      medico: medico,\n      horariosMap: horariosMap,\n      cantidadHorarios: fechasLimitadas.length\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3424,2896],"id":"491ad205-0aa7-4486-9d8c-7e9c2fa138f5","name":"ğŸ• LISTA-HORARIOS"},{"parameters":{"jsCode":"// ============================================\n// REDIS GET - PARSER\n// ============================================\n// Parsea el JSON almacenado en Redis para extraer:\n// - status (estadoActual)\n// - metadata (codigoEspecialidad, dni, etc.)\n// ============================================\n\nconst redisOutput = $input.first().json.status; // Viene del nodo Redis GET\n\nlet estado = null;\nlet metadata = {};\n\n// Si Redis devuelve algo, parsearlo\nif (redisOutput) {\n  try {\n    // Intentar parsear como JSON\n    const parsed = JSON.parse(redisOutput);\n    estado = parsed.status || null;\n    metadata = parsed.metadata || {};\n    \n    console.log('âœ… Redis parseado correctamente');\n    console.log('ğŸ“Š Estado:', estado);\n    console.log('ğŸ“¦ Metadata:', JSON.stringify(metadata));\n  } catch (e) {\n    // Si no es JSON vÃ¡lido, usar el valor directo como estado\n    console.log('âš ï¸ Redis no es JSON, usando valor directo');\n    estado = redisOutput;\n    metadata = {};\n  }\n} else {\n  console.log('â„¹ï¸ Redis vacÃ­o (primera conversaciÃ³n)');\n  estado = null;\n  metadata = {};\n}\n\n// Retornar en formato que msg_clasificador espera\nreturn [{\n  json: {\n    status: estado,           // Estado actual para el clasificador\n    metadata: metadata,       // Metadata preservado\n    contactNumber: $('Filtro Tipo Mensaje').first().json.contactNumber\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-3344,1632],"id":"af7e5f4a-83de-41eb-8aca-dc28f9e40cfa","name":"Parsear Redis"},{"parameters":{"jsCode":"// ============================================\n// REDIS SET - PREPARADOR\n// ============================================\nconst contactNumber = $json.contactNumber;\nconst estadoActual = $json.estadoActual || $json.nuevoEstado;\nconst metadata = $json.metadata || {};\n\n// ============================================\n// VALIDACIÃ“N CORRECTA DEL PACIENTE\n// ============================================\nconst datosPacienteRedis = $('PACIENTE').first().json.paciente;\n\nconst pacienteRegistrado = datosPacienteRedis !== null && \n                          datosPacienteRedis !== undefined &&\n                          Object.keys(datosPacienteRedis || {}).length > 0;\n\nconst datosCliente = pacienteRegistrado ? datosPacienteRedis : null;\n\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\nconsole.log('ğŸ” VALIDACIÃ“N DE PACIENTE');\nconsole.log('ğŸ“¥ Datos recibidos:', JSON.stringify(datosPacienteRedis));\nconsole.log('âœ… Â¿EstÃ¡ registrado?:', pacienteRegistrado);\nconsole.log('ğŸ‘¤ Datos cliente:', datosCliente ? JSON.stringify(datosCliente) : 'null');\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n\n// ============================================\n// EXTRACCIÃ“N DE MATRÃCULA DEL MÃ‰DICO\n// ============================================\nlet mensajeOriginal = $input.first().json.mensaje;\nlet mensajeProcesado = mensajeOriginal;\nconst categoria = $input.first().json.categoria;\n\n// Si la categorÃ­a es SELECCION_MEDICO y el mensaje tiene formato TEXTO-NUMEROS\nif (categoria === 'SELECCION_MEDICO' && mensajeOriginal) {\n  // Regex para extraer solo los nÃºmeros despuÃ©s del guion\n  const regex = /^[A-Z]+-(\\d+)$/i;\n  const match = mensajeOriginal.match(regex);\n  \n  if (match && match[1]) {\n    mensajeProcesado = match[1]; // Solo la matrÃ­cula\n    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n    console.log('ğŸ‘¨â€âš•ï¸ EXTRACCIÃ“N DE MATRÃCULA');\n    console.log('ğŸ“ Mensaje original:', mensajeOriginal);\n    console.log('ğŸ†” MatrÃ­cula extraÃ­da:', mensajeProcesado);\n    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n  }\n}\n\n// Construir el valor a guardar en Redis\nconst redisValue = JSON.stringify({\n  status: estadoActual,\n  metadata: metadata,\n  timestamp: new Date().toISOString()\n});\n\nconst redisKey = `status:${contactNumber}`;\n\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\nconsole.log('ğŸ’¾ PREPARANDO DATOS PARA REDIS');\nconsole.log('ğŸ”‘ Key:', redisKey);\nconsole.log('ğŸ“Š Estado:', estadoActual);\nconsole.log('ğŸ“‚ CategorÃ­a:', categoria);\nconsole.log('ğŸ’¬ Mensaje procesado:', mensajeProcesado);\nconsole.log('ğŸ¥ Paciente Registrado:', pacienteRegistrado);\nconsole.log('ğŸ“¦ Metadata:', JSON.stringify(metadata));\nconsole.log('ğŸ’¿ Valor completo:', redisValue);\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n\n// Retornar TODOS los datos\nreturn [{\n  json: {\n    // Datos para Redis SET\n    key: redisKey,\n    value: redisValue,\n    ttl: 600,\n    \n    // Estado del paciente (VALIDADO CORRECTAMENTE)\n    pacienteRegistrado: pacienteRegistrado,\n    datosCliente: datosCliente,\n    \n    // Datos del clasificador\n    categoria: categoria,\n    mensaje: mensajeProcesado,  // Mensaje procesado (matrÃ­cula si aplica)\n    mensajeOriginal: mensajeOriginal,  // Guardamos el original tambiÃ©n\n    contactNumber: contactNumber,\n    estadoActual: estadoActual,\n    estadoAnterior: $json.estadoAnterior,\n    metadata: metadata,\n    nuevoEstado: estadoActual,\n    \n    // Alias para compatibilidad\n    redisKey: redisKey,\n    redisValue: estadoActual,\n    _context: $json._context || {}\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-2736,1632],"id":"1b982ac2-d201-42c5-b5a7-2ef8557ee62c","name":"Preparar Redis"},{"parameters":{"httpMethod":"POST","path":"agentes/v1/iclp","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-5072,1536],"id":"0c53d882-a24d-40b3-8c42-0108f1552a61","name":"Entrada","webhookId":"5488cf55-839c-4285-8eab-672ab06a77b2"},{"parameters":{"operation":"set","key":"=status:{{ $('msg1').item.json.body.to }}","value":"={{ $('msg1').item.json.estadoActual }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3248,1408],"id":"765d1bd9-8e55-4ffa-821f-5ac8635a7644","name":"STATUS:MENU=","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"const contactNumber = $json.contactNumber;\n\nconst mensajeBody = {\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": contactNumber,\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ğŸ«€ INSTITUTO DE CARDIOLOGÃA LA PLATA\"\n    },\n    \"body\": {\n      \"text\": \"âš ï¸ *IMPORTANTE*\\n\\nPOR ESTA OPCIÃ“N MOMENTÃNEAMENTE SOLO DAMOS LOS *TURNOS MÃS PRÃ“XIMOS* ğŸ“…\\n\\nSI NECESITA UNA *FECHA QUE NO SE ENCUENTRA* O ES MÃS ALEJADA, PUEDE CONTACTARSE:\\n\\nğŸ“ Llamando al *221 4906310*\\nğŸ’¬ Seleccionando la opciÃ³n *'ADMINISTRACIÃ“N'*\\n\\nğŸ«€ ELIJA UNA DE LAS SIGUIENTES OPCIONES PARA CONTINUAR:\"\n    },\n    \"footer\": {\n      \"text\": \"ğŸ“… LUN-VIE 8-20HS | â˜ï¸ (0221) 490-6310\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"con-consultorio\",\n            \"title\": \"TURNOS CONSULTORIO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"con-estudio\",\n            \"title\": \"TURNOS ESTUDIO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"volver-atras\",\n            \"title\": \"MENÃš PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n};\n\n\n\nreturn [{\n  json: {\n    body: mensajeBody,\n    categoria: 'INICIAR_TOMAR_TURNO',\n    contactNumber: contactNumber,\n    estadoActual: 'TURNOS:TIPO_TURNO'\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2800,1408],"id":"e3e9ce50-e810-4075-8819-a5fcf6452529","name":"msg1"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.body.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.body.recipient_type }}"},{"name":"to","value":"={{ $json.body.to }}"},{"name":"type","value":"={{ $json.body.type }}"},{"name":"interactive","value":"={{ $json.body.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3024,1232],"id":"7f7ce360-0ff2-49fc-b872-a56fd2c4045e","name":"[MENU] - GESTION MIS TURNOS","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.body.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.body.recipient_type }}"},{"name":"to","value":"={{ $json.body.to }}"},{"name":"type","value":"={{ $json.body.type }}"},{"name":"interactive","value":"={{ $json.body.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3024,1408],"id":"4b03c447-aaae-4634-b557-cae9517a3c53","name":"[MENU] - TURNOS","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"delete","key":"status:+5492254596618"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-4256,2336],"id":"9d9580e5-0aa5-4947-9c8c-ba76ed3bf58c","name":"Redis1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"categoria-validar-dni","leftValue":"={{ $json.categoria !== 'MENU_INICIAL' && (\n    $json.categoria === 'INGRESO_DNI' || \n    $json.categoria === 'SOLICITAR_DNI' || \n    $json.estadoAnterior === 'PACIENTE_REGISTRADO_ERROR' ||  \n    $json.estadoActual.includes('DATOS:DNI_VALIDADO:') \n) }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ğŸ” VALIDAR DNI (IA)"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"menu-inicial","leftValue":"={{ \n  // Nueva condiciÃ³n: MENU_INICIAL con mensaje MENÃš PRINCIPAL\n  ($json.categoria === 'MENU_INICIAL' && $json.mensaje === 'MENÃš PRINCIPAL') ||\n  \n  // Condiciones originales\n  (\n    !$json.categoria?.startsWith('INFO_') && \n    $json.categoria !== 'NAV_ADMIN' && \n    $json.mensaje !== 'CONFIRMAR TURNO' && \n    $json.estadoAnterior !== 'PACIENTE_NUEVO_ERROR' && \n    !['NAV_TURNOS', 'NAV_INFO', 'NUEVO_PACIENTE', 'INGRESO_DATOS_PACIENTE', 'MENU_GESTION_TURNOS', 'PACIENTE_REGISTRADO', 'INFO_ESPECIALIDADES', 'INFO_MEDICOS'].includes($json.categoria) && \n    (\n      $json.administracion === true || \n      (!$json.pacienteRegistrado && !['TURNO_CONSULTORIO', 'TURNO_ESTUDIO', 'SELECCION_ESPECIALIDAD', 'SELECCION_MEDICO', 'SELECCION_HORARIO', 'TOMAR_TURNO'].includes($json.categoria)) || \n      (\n        ($json.mensaje === 'MENÃš PRINCIPAL' || \n         $json.mensaje === 'MENU PRINCIPAL' || \n         $('msg_clasificador').item.json.categoria === 'MENU_INICIAL' || \n         ($json.categoria === 'fallback' && $json.estadoAnterior !== 'PACIENTE_NUEVO_ERROR')) && \n         $json.estadoAnterior !== 'PACIENTE_NUEVO_REGISTRADO'\n      )\n    )\n  )\n}}","rightValue":"MENU_INICIAL","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ğŸ  MENU INICIAL"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"nav-turnos","leftValue":"={{ \n  $json.estadoActual !== 'TURNOS:ESPECIALIDADES' && \n  (\n    ($json.categoria === 'NAV_TURNOS' && $json.pacienteRegistrado === false) ||  \n    $json.categoria === 'TURNO_CONSULTORIO' \n  ) &&\n  !($json.mensaje === 'PACIENTE REGISTRADO' && $json.categoria === 'TURNO_CONSULTORIO')\n}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ğŸ“… NAVEGACIÃ“N TURNOS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"nav-info","leftValue":"={{ $json.categoria }}","rightValue":"NAV_INFO","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"â„¹ï¸ NAVEGACIÃ“N INFO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"nav-admin","leftValue":"={{ $json.categoria === 'NAV_ADMIN' || \n   $json.mensaje === 'ğŸ¢ ADMINISTRACION' || \n   $json.mensaje === 'ADMINISTRACION' ||\n   $json.mensaje === 'ğŸ¢ AdministraciÃ³n' ||\n   $json.mensaje === 'ADMINISTRACIÃ“N'}}","rightValue":"NAV_ADMIN","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ğŸ¢ ADMINISTRACIÃ“N"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"derivar-humano","leftValue":"={{ $json.categoria }}","rightValue":"DERIVAR_HUMANO","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"ğŸ‘¤ DERIVAR HUMANO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"gestion-turnos","leftValue":"={{ !($json.mensaje && (\n     $json.mensaje.toUpperCase().includes('INFO GENERAL') || \n     $json.mensaje.toUpperCase().includes('ADMINISTRACION') || \n     $json.mensaje.toUpperCase().includes('ADMINISTRACIÃ“N') ||\n     $json.mensaje.toUpperCase().includes('PORTAL') ||\n     $json.mensaje.toUpperCase().includes('DIRECCION') ||\n     $json.mensaje.toUpperCase().includes('DIRECCIÃ“N') ||\n     $json.mensaje.toUpperCase().includes('UBICACION') ||\n     $json.mensaje.toUpperCase().includes('UBICACIÃ“N') ||\n     $json.mensaje.toUpperCase().includes('HORARIOS') ||\n     $json.mensaje.toUpperCase().includes('RECETAS') ||\n     $json.mensaje.toUpperCase().includes('MÃ‰DICOS')\n   )) &&\n   ($json.categoria === 'MENU_TIPO_TURNO' || \n   ($json.mensaje && $json.mensaje.toUpperCase().includes('TURNOS')) ||\n   $json.categoria === 'NUEVO_PACIENTE' || \n   ($json.categoria === 'MENU_GESTION_TURNOS' && $json.pacienteRegistrado === false && $json.estadoActual === 'MENU:GESTION_TURNOS') ||\n   ($json.categoria === 'PACIENTE_REGISTRADO' && $json.pacienteRegistrado === false) ||\n   ($json.pacienteRegistrado === true && (\n     ['PACIENTE_REGISTRADO', 'INICIAR_TOMAR_TURNO', 'CONFIRMAR_DATOS_DNI', 'INICIAR_CANCELAR_TURNO', 'LISTAR_MIS_TURNOS', 'TURNO_CONSULTORIO', 'TURNO_ESTUDIO', 'VER_MAS_ESPECIALIDADES', 'VER_MAS_MEDICOS', 'SELECCION_ESPECIALIDAD', 'SELECCION_MEDICO', 'SELECCION_HORARIO', 'TOMAR_TURNO', 'CANCELAR_TURNO', 'MIS_TURNOS', 'VOLVER_MEDICOS', 'EJECUTAR_POST_TURNO', 'ELIMINAR_TURNO', 'EJECUTAR_CANCELACION_TURNO', 'MENU_GESTION_TURNOS'].includes($json.categoria) || \n     ['PACIENTE REGISTRADO', 'MIS TURNOS'].includes($json.mensaje) || \n     ($json.mensaje === 'CONTINUAR' && ['PACIENTE_NUEVO', 'PACIENTE_NUEVO_REGISTRADO'].includes($json.estadoAnterior)) ||\n     $json.estadoAnterior === 'PACIENTE_REGISTRADO_ERROR' || \n     $('msg_clasificador').item.json.categoria === 'NAV_TURNOS'\n   ))) \n}}","rightValue":"","operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"renameOutput":true,"outputKey":"ğŸ« GESTIÃ“N TURNOS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"datos-paciente","leftValue":"={{ ['INGRESO_DNI', 'INGRESO_DATOS_PACIENTE'].includes($json.categoria) || $json.estadoAnterior ==='PACIENTE_NUEVO_ERROR' || $json.mensaje === 'CANCELAR TURNO' }}","rightValue":"","operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"renameOutput":true,"outputKey":"ğŸ“ DATOS PACIENTE"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"confirmaciones","leftValue":"={{ $json.categoria.includes('CONFIRMAR') || $json.categoria.includes('CONTINUAR') }}","rightValue":"","operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"renameOutput":true,"outputKey":"âœ… CONFIRMACIONES"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"info-opciones","leftValue":"={{ $json.categoria.startsWith('INFO_') || $json.mensaje.includes('INFO GENERAL')}}","rightValue":"","operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"renameOutput":true,"outputKey":"ğŸ’¡ INFO OPCIONES"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"volver","leftValue":"={{ $json.categoria }}","rightValue":"VOLVER_ATRAS","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"â¬…ï¸ VOLVER"}]},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-2080,1504],"id":"c8a0ea3f-d2dc-47c4-bfe3-493f2af8c52f","name":"ğŸ”€ ROUTER PRINCIPAL"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":1},"conditions":[{"id":"confirmar-datos-dni","leftValue":"={{ $json.categoria === 'CONFIRMAR_DATOS_DNI' || $json.pacienteRegistrado === true && $json.categoria !== 'TOMAR_TURNO' }}","rightValue":"CONFIRMAR_DATOS_DNI","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ğŸ“‹ MENÃš GESTIÃ“N TURNOS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":1},"conditions":[{"id":"tomar-turno-menu","leftValue":"={{ $json.categoria === 'TOMAR_TURNO' ||$json.estadoAnterior === 'PACIENTE_NUEVO_REGISTRADO' &&  $json.mensaje === 'CONTINUAR'  }}","rightValue":"TOMAR_TURNO","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ğŸ©º MENÃš TIPO TURNO"}]},"options":{"looseTypeValidation":true}},"id":"866350c9-81aa-4de2-9a88-baa882a7d106","name":"SWITCH: Tipo MenÃº Tomar Turno","type":"n8n-nodes-base.switch","typeVersion":3,"position":[2480,1328]},{"parameters":{"operation":"set","key":"=status:{{ $('Variables').first().json.contactNumber }}","value":"PACIENTE_REGISTRADO_ERROR","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[688,16],"id":"62246b50-a217-4395-bba9-273fcb04dc43","name":"DATO_INCORRECTO","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"// Obtener datos del nodo DATOS_PACIENTE\nconst inputData = $('DATOS_PACIENTE').first().json.Datos;\nconsole.log('Input completo:', JSON.stringify(inputData, null, 2));\n\n// Parsear datos si es string\nconst datosParsed = typeof inputData === 'string' ? JSON.parse(inputData) : inputData;\n\n// Extraer DNI\nconst dni = Number(datosParsed.paciente_dni);\nconsole.log('DNI final:', dni);\n\n// Validar que se encontrÃ³ el DNI\nif (!dni || isNaN(dni)) {\n  throw new Error('No se pudo encontrar el DNI en los datos de entrada');\n}\n\n// Extraer nombre completo\nconst nombre_completo = datosParsed.paciente_nombre;\nconsole.log('Nombre completo:', nombre_completo);\n\n// Extraer celular\nconst celular_paciente = datosParsed.paciente_celular;\nconsole.log('Celular:', celular_paciente);\n\n// Obtener la matrÃ­cula completa del input (ROGGIERO-16118)\nconst matriculaCompleta = $('MATRICULA').first().json.matricula;\nconsole.log('MatrÃ­cula completa:', matriculaCompleta);\n\n// Separar por guiÃ³n para obtener mÃ©dico y matrÃ­cula\nconst partes = matriculaCompleta.split('-');\n\n// Extraer el NOMBRE del mÃ©dico (ROGGIERO)\nconst medico = partes[0].trim();\nconsole.log('MÃ©dico:', medico);\n\n// Extraer solo el NÃšMERO de matrÃ­cula (16118)\nconst matricula = Number(partes[1].trim());\nconsole.log('MatrÃ­cula extraÃ­da:', matricula);\n\n// Obtener el horario del nodo Filter1 (MIÃ‰ 22/10 - 15:40)\nconst horarioCompleto = $('Filter1').first().json.message;\nconsole.log('Horario completo:', horarioCompleto);\n\n// Extraer fecha y hora del formato \"MIÃ‰ 22/10 - 15:40\"\nconst partesFechaHora = horarioCompleto.split(' - ');\nconst partesFecha = partesFechaHora[0].split(' ')[1]; // \"22/10\"\nconst horaOriginal = partesFechaHora[1]; // \"15:40\"\n\n// Convertir fecha \"22/10\" a Unix timestamp (milisegundos)\nconst [dia, mes] = partesFecha.split('/');\nconst anio = new Date().getFullYear(); // 2025\n\n// Crear fecha en formato ISO con zona horaria de Argentina\nconst fechaISO = `${anio}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}T00:00:00.000-03:00`;\nconst fecha = new Date(fechaISO).getTime();\nconsole.log('Fecha en Unix (ms):', fecha);\n\n// Convertir hora \"15:40\" a \"1540\" o \"08:20\" a \"0820\" (mantener como string con 4 dÃ­gitos)\nconst hora = horaOriginal.replace(':', '').padStart(4, '0');\nconsole.log('Hora convertida:', hora);\n\n// Retornar el resultado en el formato solicitado\nreturn [{\n  json: {\n    datos: {\n      dni: dni,\n      fecha: fecha,\n      hora: hora,\n      nombre_completo: nombre_completo,\n      celular_paciente: celular_paciente,\n      medico: medico,\n      matricula: matricula\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[768,2640],"id":"f2421bd5-455c-41c8-a9d4-00d123d1acb6","name":"Code2"},{"parameters":{"operation":"get","propertyName":"matricula","key":"=MEDICO:{{ $('Filter1').first().json.contactNumber.replace('+', '') }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[544,2640],"id":"a7fd25b6-ffc4-4fcf-aee7-cdc68e5345ff","name":"MATRICULA","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filtro Tipo Mensaje').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ğŸ’™ CENTRO CARDIOLÃ“GICO\"\n    },\n    \"body\": {\n      \"text\": \"*_CONFIRMACIÃ“N DE TURNO_*\\n\\n*ğŸ©º DATOS DEL TURNO:*\\n\\nâ¤ï¸ *MÃ‰DICO CARDIÃ“LOGO*\\nDR./DRA. {{ $('datos').item.json.datos.parseJson().medico }} \\n\\nğŸ“† *FECHA DE ATENCIÃ“N*\\n{{ $('ğŸ”€ SWITCH GESTIÃ“N TURNOS').first().json.mensaje }}\\n\\n*ğŸ’™ POR FAVOR, CONFIRMÃ TU ASISTENCIA*\"\n    },\n    \"footer\": {\n      \"text\": \"â¤ï¸ TU SALUD CARDIOVASCULAR ES PRIORIDAD\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"si-confirmo\",\n            \"title\": \"CONFIRMAR TURNO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"volver-atras\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3200,3088],"id":"18c32590-8ab3-42d2-85d4-42ffcb4bd6ff","name":"ğŸ“… Confirmar turno","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=turno:{{ $('Filter1').first().json.contactNumber }}","value":"={{ JSON.stringify($json.datos) }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[992,2640],"id":"fa0f2e4d-cf58-49fd-b4f5-9b4915e4a021","name":"Datos para confirmar turno","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"=Datos","key":"=DATOS_PACIENTE:","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[320,2640],"id":"07c77804-e819-471e-a1cb-0429f17805bf","name":"DATOS_PACIENTE","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=status:{{ $('msg_clasificador').item.json.contactNumber }}","value":"TURNOS:CONFIRMAR","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3648,3088],"id":"6ebee0e4-48fe-45e8-b4da-50b9946f52f2","name":"Redis2","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=status:{{ $('msg_clasificador').first().json.contactNumber }}","value":"={{ $('ğŸ• LISTA-HORARIOS').item.json.estadoActual || 'TURNOS:HORARIOS'}}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3872,2896],"id":"ae51d263-2dfd-4be1-bded-ef32126010d2","name":"ğŸ©º FECHA","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"$('ğŸ”€ SWITCH GESTIÃ“N TURNOS1').first().json.mensaje\n\n$input.first().json.DNI"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[96,2640],"id":"9d1d8f66-9478-4a3c-8126-15bac213e664","name":"PREPARAR_CONFIRMAR_TURNO"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"nuevo-paciente","leftValue":"={{ $json.categoria }}","rightValue":"NUEVO_PACIENTE","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"â• NUEVO PACIENTE"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"paciente-registrado","leftValue":"={{ $json.categoria === '' || $json.mensaje === 'PACIENTE REGISTRADO'}}","rightValue":"PACIENTE_REGISTRADO","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"âœ… PACIENTE REGISTRADO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"tomar-turno","leftValue":"={{\n  ['INICIAR_TOMAR_TURNO', 'CONFIRMAR_DATOS_DNI', 'TOMAR_TURNO'].includes($json.categoria) ||\n  ($json.estadoAnterior === 'PACIENTE_NUEVO_REGISTRADO' && $json.mensaje === 'CONTINUAR') ||\n  $json.mensaje === 'TOMAR TURNO' ||\n  ($json.categoria === 'SELECCION_MEDICO' && $json.mensaje === 'ğŸ“… TURNOS') ||\n  (\n    $json.pacienteRegistrado === true && \n    $json.mensaje !== 'TURNOS CONSULTORIO' && \n    $json.mensaje !== 'TURNOS ESTUDIO' && \n    $json.categoria !== 'SELECCION_ESPECIALIDAD' && \n    $json.categoria !== 'SELECCION_MEDICO' && \n    $json.categoria !== 'SELECCION_HORARIO' && \n    $json.categoria !== 'CANCELAR_TURNO' && \n    $json.categoria !== 'EJECUTAR_POST_TURNO' &&\n    $json.categoria !== 'ELIMINAR_TURNO' && \n    $json.categoria !== 'VER_MAS_ESPECIALIDADES' &&\n    $json.categoria !== 'TURNO_CONSULTORIO' &&\n    $json.mensaje !== 'MIS TURNOS' &&\n    $json.categoria !== 'EJECUTAR_CANCELACION_TURNO'\n  )\n}}","rightValue":"","operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"renameOutput":true,"outputKey":"ğŸ“… TOMAR TURNO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"listar-turnos","leftValue":"={{ ['LISTAR_MIS_TURNOS', 'MIS_TURNOS'].includes($json.categoria) }}","rightValue":"","operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"renameOutput":true,"outputKey":"ğŸ“‹ MIS TURNOS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"turno-consultorio","leftValue":"={{\n  $json.categoria === 'TURNO_CONSULTORIO' ||\n  ($json.categoria === 'SELECCION_ESPECIALIDAD' && $json.mensaje === 'ğŸ”„ CAMBIAR ESPECIALIDAD')\n}}","rightValue":"TURNO_CONSULTORIO","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ğŸ©º TURNO CONSULTORIO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"turno-estudio","leftValue":"={{\n  $json.categoria === 'TURNO_ESTUDIO' ||\n  ($json.categoria === 'TURNO_CONSULTORIO' && $json.mensaje === 'TURNOS ESTUDIO')\n}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ğŸ”¬ TURNO ESTUDIO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"ver-mas-especialidades","leftValue":"={{ $json.categoria }}","rightValue":"VER_MAS_ESPECIALIDADES","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"â• VER MÃS ESPECIALIDADES"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"ver-mas-medicos","leftValue":"={{ $json.categoria === 'VER_MAS_MEDICOS' || $json.mensaje.includes('â• VER MÃS') }}","rightValue":"VER_MAS_MEDICOS","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"â• VER MÃS MÃ‰DICOS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"seleccion-especialidad","leftValue":"={{\n  ['SELECCION_ESPECIALIDAD', 'VOLVER_MEDICOS'].includes($json.categoria) && \n  !($json.mensaje && (\n    $json.mensaje.toUpperCase() === 'CANCELAR TURNO' || \n    $json.mensaje.toUpperCase() === 'MIS TURNOS' ||\n    $json.mensaje === 'ğŸ”„ CAMBIAR ESPECIALIDAD'\n  ))\n}}","rightValue":"","operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"renameOutput":true,"outputKey":"ğŸ©º SELECCIÃ“N ESPECIALIDAD"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"seleccion-medico","leftValue":"={{ $json.categoria === 'SELECCION_MEDICO' &&  $json.mensaje !== 'ğŸ“… TURNOS'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ğŸ‘¨â€âš•ï¸ SELECCIÃ“N MÃ‰DICO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"seleccion-horario","leftValue":"={{ $json.categoria }}","rightValue":"SELECCION_HORARIO","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"â° SELECCIÃ“N HORARIO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"ee3917ed-5fc7-444d-a6b3-6b6c0a7daaaa","leftValue":"={{ $json.categoria }}","rightValue":"EJECUTAR_POST_TURNO","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"EJECUTAR TURNO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"8764b955-7499-4f00-8106-de7eae17539b","leftValue":"={{ $json.categoria === 'ELIMINAR_TURNO' && $json.estadoAnterior ==='CANCELAR-TURNO' && $json.mensaje !== 'MIS TURNOS' || $json.categoria === 'EJECUTAR_CANCELACION_TURNO' && $json.mensaje ==='MIS TURNOS' }}","rightValue":"ELIMINAR_TURNO","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"âŒ ELIMINAR TURNO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"cancelar-turno","leftValue":"={{ ['INICIAR_CANCELAR_TURNO', 'CANCELAR_TURNO'].includes($json.categoria) || $json.mensaje === 'CANCELAR TURNO' }}","rightValue":"","operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"renameOutput":true,"outputKey":"âŒ CANCELAR TURNO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"cac1d24c-59e0-47e8-92cb-a70111fc41d6","leftValue":"={{ $json.mensaje === 'MIS TURNOS' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"MIS TURNOS"}]},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[1168,1488],"id":"458e6c77-3082-4fc4-af6a-badbad3bb37a","name":"ğŸ”€ SWITCH GESTIÃ“N TURNOS"},{"parameters":{"operation":"get","propertyName":"datos","key":"=DATOS_TURNO:{{ $('msg_clasificador').item.json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2752,3312],"id":"cb09c6b4-3001-4a0d-9652-b7696261f2bd","name":"Datos para confirmar turno1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"workflowId":{"__rl":true,"value":"e7UD4t6GrwYxGW6Q","mode":"list","cachedResultName":"SUB - POST_TURNO"},"workflowInputs":{"mappingMode":"defineBelow","value":{"dni":"={{ $('PACIENTE').first().json.paciente.paciente_dni }}","fecha":"={{ $json.fecha }}","hora":"={{ $json.hora }}","nombre_completo":"={{ $json.nombre }}","celular_paciente":"={{ $json.celuar }}","matricula":"={{ $json.matricula }}","celuar_whatsapp":"={{ $('msg_clasificador').first().json.contactNumber }}"},"matchingColumns":[],"schema":[{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"fecha","displayName":"fecha","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"hora","displayName":"hora","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"nombre_completo","displayName":"nombre_completo","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"celular_paciente","displayName":"celular_paciente","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"matricula","displayName":"matricula","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"celuar_whatsapp","displayName":"celuar_whatsapp","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":true,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[3184,3312],"id":"35200223-f38f-4258-bcf2-734447d1134d","name":"EJECUTAR TURNO"},{"parameters":{"operation":"get","propertyName":"datos","key":"=DATOS_TURNO:{{ $('Parsear Redis').item.json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2752,3088],"id":"c1b46331-0247-4df7-be04-64d600ae9d20","name":"datos","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=PACIENTE_REGISTRADO:{{ $('Variables').first().json.contactNumber }}","value":"={{ $('Get_Paciente1').item.json.output}}","expire":true,"ttl":3600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1408,464],"id":"f3ce3eb3-e4ea-4378-be3f-3c99d473e258","name":"PACIENTE_REGISTRADO","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"PACIENTE","key":"=PACIENTE_REGISTRADO:{{ $('msg_clasificador').item.json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2976,3088],"id":"e4978332-7062-4150-95ba-d9e517cc1f9c","name":"DATOS_PACIENTE_REGISTRADO","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"// ============================================\n// 1. OBTENER DATOS BASE\n// ============================================\n\nlet datosBase = null;\n\n// Intento 1: Acceso directo sin parseJson\ntry {\n    datosBase = $('datos').first().json.datos;\n    console.log('âœ… Intento 1 - $(\"datos\").first().json.datos:');\n    console.log(JSON.stringify(datosBase, null, 2));\n    console.log('   MatrÃ­cula:', datosBase.matricula);\n} catch (e) {\n    console.log('âŒ Intento 1 fallÃ³:', e.message);\n}\n\n// Intento 2: Desde el primer item\nif (!datosBase || !datosBase.matricula) {\n    try {\n        datosBase = $('datos').item(0).json;\n        console.log('âœ… Intento 2 - $(\"datos\").item(0).json:');\n        console.log(JSON.stringify(datosBase, null, 2));\n        console.log('   MatrÃ­cula:', datosBase.matricula);\n    } catch (e) {\n        console.log('âŒ Intento 2 fallÃ³:', e.message);\n    }\n}\n\n// Intento 3: Acceso con all()\nif (!datosBase || !datosBase.matricula) {\n    try {\n        const todosLosDatos = $('datos').all();\n        if (todosLosDatos && todosLosDatos.length > 0) {\n            datosBase = todosLosDatos[0].json;\n            console.log('âœ… Intento 3 - $(\"datos\").all()[0].json:');\n            console.log(JSON.stringify(datosBase, null, 2));\n            console.log('   MatrÃ­cula:', datosBase.matricula);\n        }\n    } catch (e) {\n        console.log('âŒ Intento 3 fallÃ³:', e.message);\n    }\n}\n\n// Intento 4: Si datos es un string JSON, parsearlo\nif (!datosBase || !datosBase.matricula) {\n    try {\n        const datosString = $('datos').first().json.datos;\n        if (typeof datosString === 'string') {\n            datosBase = JSON.parse(datosString);\n            console.log('âœ… Intento 4 - JSON.parse aplicado:');\n            console.log(JSON.stringify(datosBase, null, 2));\n            console.log('   MatrÃ­cula:', datosBase.matricula);\n        }\n    } catch (e) {\n        console.log('âŒ Intento 4 fallÃ³:', e.message);\n    }\n}\n\n// Verificar si obtuvimos los datos\nif (!datosBase) {\n    console.log('ğŸš¨ ERROR CRÃTICO: No se pudieron obtener los datos del nodo');\n    throw new Error('No se pudo acceder al nodo datos');\n}\n\nconsole.log('\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\nconsole.log('âœ… DATOS BASE OBTENIDOS:');\nconsole.log('   DNI:', datosBase.dni);\nconsole.log('   MatrÃ­cula:', datosBase.matricula);\nconsole.log('   MÃ©dico:', datosBase.medico);\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n\n// Si la matrÃ­cula aÃºn es null, intentar extraerla del mÃ©dico\nlet matriculaFinal = datosBase.matricula;\n\nif (!matriculaFinal || matriculaFinal === null || matriculaFinal === 'null') {\n    console.log('\\nâš ï¸ MatrÃ­cula es null, intentando extraer del mÃ©dico...');\n    \n    if (datosBase.medico) {\n        const match = datosBase.medico.match(/-(\\d+)$/);\n        if (match) {\n            matriculaFinal = match[1];\n            console.log('âœ… MatrÃ­cula extraÃ­da del mÃ©dico:', matriculaFinal);\n        }\n    }\n    \n    if (!matriculaFinal && datosBase.medicoSeleccionado) {\n        const match = datosBase.medicoSeleccionado.match(/-(\\d+)$/);\n        if (match) {\n            matriculaFinal = match[1];\n            console.log('âœ… MatrÃ­cula extraÃ­da del medicoSeleccionado:', matriculaFinal);\n        }\n    }\n}\n\nconsole.log('\\nğŸ¯ MATRÃCULA FINAL:', matriculaFinal);\n\n// ============================================\n// 2. OBTENER TODOS LOS DATOS DEL PACIENTE\n// ============================================\n\nconsole.log('\\nğŸ‘¤ OBTENIENDO DATOS DEL PACIENTE:');\n\nlet pacienteData = null;\n\n// Intento 1: Acceso directo\ntry {\n    pacienteData = $('DATOS_PACIENTE_REGISTRADO').first().json.PACIENTE;\n    console.log('âœ… Datos del paciente obtenidos:');\n    console.log(JSON.stringify(pacienteData, null, 2));\n} catch (e) {\n    console.log('âŒ Error al obtener datos del paciente:', e.message);\n}\n\n// Intento 2: Si PACIENTE es un string JSON, parsearlo\nif (!pacienteData || typeof pacienteData === 'string') {\n    try {\n        const pacienteString = $('DATOS_PACIENTE_REGISTRADO').first().json.PACIENTE;\n        if (typeof pacienteString === 'string') {\n            pacienteData = JSON.parse(pacienteString);\n            console.log('âœ… Datos del paciente parseados:');\n            console.log(JSON.stringify(pacienteData, null, 2));\n        }\n    } catch (e) {\n        console.log('âŒ Error al parsear datos del paciente:', e.message);\n    }\n}\n\n// Verificar si obtuvimos los datos del paciente\nif (!pacienteData) {\n    console.log('ğŸš¨ ERROR CRÃTICO: No se pudieron obtener los datos del paciente');\n    throw new Error('No se pudo acceder a DATOS_PACIENTE_REGISTRADO');\n}\n\n// Extraer campos individuales (con valores por defecto)\nconst nombrePaciente = pacienteData.paciente_nombre || '';\nconst celularPaciente = pacienteData.paciente_celular || '';\nconst dni_paciente = pacienteData.paciente_dni || '';\nconst emailPaciente = pacienteData.paciente_email || '';\nconst obraSocial = pacienteData.paciente_obra_social || '';\n\nconsole.log('\\nğŸ“‹ CAMPOS DEL PACIENTE EXTRAÃDOS:');\nconsole.log('   Nombre:', nombrePaciente);\nconsole.log('   DNI:', dni_paciente);\nconsole.log('   Celular:', celularPaciente);\nconsole.log('   Email:', emailPaciente);\nconsole.log('   Obra Social:', obraSocial);\n\n// ============================================\n// 3. EXTRAER FECHA Y HORA DEL MENSAJE\n// ============================================\n\nconsole.log('\\nğŸ“… EXTRAYENDO FECHA Y HORA:');\n\nconst mensajeHora = $('msg_clasificador').first().json.mensaje;\nconsole.log('   Mensaje:', mensajeHora);\n\nconst fechaHoraMatch = mensajeHora.match(/(\\d{1,2})\\/(\\d{1,2})\\s*-\\s*(\\d{1,2}):(\\d{2})/);\n\nlet fechaLimpia = \"\";\nlet horaLimpia = \"\";\n\nif (fechaHoraMatch) {\n    const dia = fechaHoraMatch[1].padStart(2, '0');\n    const mes = fechaHoraMatch[2].padStart(2, '0');\n    const aÃ±o = new Date().getFullYear();\n    \n    fechaLimpia = `${aÃ±o}${mes}${dia}`;\n    \n    const horas = fechaHoraMatch[3].padStart(2, '0');\n    const minutos = fechaHoraMatch[4];\n    horaLimpia = horas + minutos;\n    \n    console.log('   Fecha:', fechaLimpia);\n    console.log('   Hora:', horaLimpia);\n}\n\n// ============================================\n// 4. EXTRAER HORA DE PREPARAR REDIS\n// ============================================\n\nconsole.log('\\nğŸ• EXTRAYENDO HORA DE PREPARAR REDIS:');\n\nlet horarioFormateado = \"\";\n\ntry {\n    const horarioCompleto = $('Preparar Redis').first().json.metadata.horario;\n    console.log('   Horario completo:', horarioCompleto);\n    \n    // Extraer solo la hora en formato HH:MM\n    const matchHora = horarioCompleto.match(/(\\d{1,2}):(\\d{2})$/);\n    \n    if (matchHora) {\n        const horas = matchHora[1].padStart(2, '0');\n        const minutos = matchHora[2];\n        horarioFormateado = `${horas}:${minutos}`;\n        \n        console.log('   Hora extraÃ­da:', horarioFormateado);\n    } else {\n        horarioFormateado = horarioCompleto;\n        console.log('   âš ï¸ No se pudo extraer hora, usando valor completo');\n    }\n} catch (error) {\n    console.log('   âŒ Error al extraer hora de Preparar Redis:', error.message);\n    horarioFormateado = horaLimpia || \"\";\n}\n\nconsole.log('   âœ… Horario formateado final:', horarioFormateado);\n\n// ============================================\n// 5. CREAR OBJETO DE TURNO CON TODOS LOS DATOS\n// ============================================\n\nconsole.log('\\nğŸ“¦ CREANDO OBJETO DE TURNO:');\n\nconst dato_turno = {\n    datos_turno: {\n        // Datos del turno\n        fecha: fechaLimpia,\n        hora: horarioFormateado,\n        medico: datosBase.medico,\n        matricula: matriculaFinal,\n        medicoSeleccionado: datosBase.medicoSeleccionado,\n        \n        // TODOS los datos del paciente\n        ...pacienteData,\n        \n        // Campos individuales para compatibilidad\n        dni: dni_paciente,\n        celular: celularPaciente,\n        nombre: nombrePaciente\n    }\n};\n\nconsole.log('\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\nconsole.log('âœ… OBJETO DE TURNO CREADO CON TODOS LOS DATOS:');\nconsole.log(JSON.stringify(dato_turno, null, 2));\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n\nreturn dato_turno;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3424,3088],"id":"6898086f-df37-4932-ab40-69eb86db6768","name":"DATOS_COMBINADOS"},{"parameters":{"operation":"get","propertyName":"DATOS_PACIENTE","key":"=PACIENTE_REGISTRADO:{{ $('Variables').first().json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2752,2896],"id":"5c36174b-8cdf-4fa0-8d66-ea2a48176040","name":"GET_PACIENTE_REGISTRADO","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=DATOS_TURNO:{{ $('msg_clasificador').item.json.contactNumber }}","value":"={{ JSON.stringify($('DATOS_COMBINADOS').item.json.datos_turno) }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3872,3088],"id":"90578396-642a-4578-b616-21ef5960a27c","name":"DATOS_TURNO_PACIENTE","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"url":"http://iclp.ddns.net:7080/ws-turnos-rest-simple/api/turnos/lista-turnos-actuales","sendQuery":true,"queryParameters":{"parameters":[{"name":"usuario","value":"WSTRRED"},{"name":"password","value":"Y2xpb25lcw"},{"name":"dni","value":"={{ $json.DATOS_PACIENTE.paciente_dni }}"},{"name":"fecha","value":"={{ $now.setZone('America/Argentina/Buenos_Aires').toFormat('yyyyLLdd') }}"}]},"options":{"response":{"response":{"neverError":true,"responseFormat":"json"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3008,2640],"id":"79a54d75-4b23-47ce-aa0e-6ea3e6dfe887","name":"get_turnos_agendados1"},{"parameters":{"assignments":{"assignments":[{"id":"8c6cf375-6158-46f1-8b42-593cf42fff40","name":"lista","value":"={{ JSON.stringify($json.lista) }}","type":"array"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[3232,2640],"id":"838f3989-1ac9-43bb-a6b1-00edc224eb17","name":"datos1"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.body.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.body.recipient_type }}"},{"name":"to","value":"={{ $('msg_clasificador').first().json.contactNumber }}"},{"name":"type","value":"={{ $json.body.type }}"},{"name":"interactive","value":"={{ $json.body.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3680,2640],"id":"7555c834-b888-4a11-a7e5-a29f0a366d20","name":"MIS TURNOS1","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"jsCode":"// ============================================\n// PREPARAR LISTA DE TURNOS PARA CANCELAR\n// ============================================\n\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\nconsole.log('ğŸ” INICIANDO PROCESO DE TURNOS');\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n\n// Obtener la lista de turnos\nconst inputData = $input.first().json;\nconsole.log('ğŸ“¦ Input completo:', JSON.stringify(inputData, null, 2));\n\n// Extraer el array de turnos\nlet turnos = [];\n\nif (inputData.lista && Array.isArray(inputData.lista)) {\n  turnos = inputData.lista;\n} else if (Array.isArray(inputData)) {\n  turnos = inputData;\n} else if (inputData.turnos && Array.isArray(inputData.turnos)) {\n  turnos = inputData.turnos;\n}\n\nconsole.log('ğŸ“‹ Total de turnos encontrados:', turnos.length);\nconsole.log('ğŸ“¦ Primer turno:', JSON.stringify(turnos[0], null, 2));\n\n// FunciÃ³n para convertir timestamp a fecha formateada\nfunction timestampAFecha(timestamp) {\n  const dt = DateTime.fromMillis(timestamp, { zone: 'America/Argentina/Buenos_Aires' });\n  return dt.toFormat('dd-MM-yyyy');\n}\n\n// FunciÃ³n para formatear hora de nÃºmero a string\nfunction formatearHora(hora) {\n  const horaStr = hora.toString().padStart(4, '0');\n  return `${horaStr.substring(0, 2)}:${horaStr.substring(2, 4)}`;\n}\n\n// FunciÃ³n para validar si un turno tiene datos vÃ¡lidos\nfunction turnoValido(turno) {\n  console.log('ğŸ” Validando turno:', JSON.stringify(turno, null, 2));\n  \n  const tieneFecha = turno.fecha && turno.fecha > 0;\n  const tieneHora = turno.hora && turno.hora.toString().length >= 3;\n  const tieneMatricula = turno.matricula && turno.matricula.toString().length > 0;\n  \n  console.log('   âœ“ Tiene fecha:', tieneFecha, '-', turno.fecha);\n  console.log('   âœ“ Tiene hora:', tieneHora, '-', turno.hora);\n  console.log('   âœ“ Tiene matrÃ­cula:', tieneMatricula, '-', turno.matricula);\n  \n  return tieneFecha && tieneHora && tieneMatricula;\n}\n\n// Filtrar solo turnos vÃ¡lidos\nconst turnosValidos = turnos.filter(turnoValido);\n\nconsole.log('âœ… Turnos vÃ¡lidos encontrados:', turnosValidos.length);\n\n// Obtener contactNumber\nconst contactNumber = $('DATOS_PACIENTE1').first().json.DATOS_PACIENTE.paciente_celular;\nconsole.log('ğŸ“± Contact Number:', contactNumber);\n\n// Verificar si hay turnos vÃ¡lidos\nif (!turnosValidos || turnosValidos.length === 0) {\n  console.log('âŒ No hay turnos vÃ¡lidos - Mostrando mensaje');\n  \n  return [{\n    json: {\n      body: {\n        messaging_product: \"whatsapp\",\n        recipient_type: \"individual\",\n        to: contactNumber,\n        type: \"interactive\",\n        interactive: {\n          type: \"button\",\n          header: {\n            type: \"text\",\n            text: \"âŒ SIN TURNOS\"\n          },\n          body: {\n            text: \"âŒ *NO TENÃ‰S TURNOS PROGRAMADOS EN ESTE MOMENTO*\\n\\nÂ¿QuerÃ©s sacar un turno nuevo?\"\n          },\n          footer: {\n            text: \"â¤ï¸ ICLP - INSTITUTO CARDIOLÃ“GICO\"\n          },\n          action: {\n            buttons: [\n              {\n                type: \"reply\",\n                reply: {\n                  id: \"menu-principal\",\n                  title: \"MENÃš PRINCIPAL\"\n                }\n              }\n            ]\n          }\n        }\n      },\n      categoria: 'SIN_TURNOS_PARA_CANCELAR',\n      contactNumber: contactNumber\n    }\n  }];\n}\n\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\nconsole.log('ğŸ“ CREANDO LISTA DE TURNOS');\n\n// Crear rows para la lista de turnos\nconst rows = [];\n\nfor (let i = 0; i < turnosValidos.length; i++) {\n  const turno = turnosValidos[i];\n  \n  console.log(`\\nğŸ« Procesando turno ${i + 1}:`, JSON.stringify(turno, null, 2));\n  \n  // Obtener datos del turno\n  const fechaTimestamp = turno.fecha;\n  const hora = turno.hora;\n  const matricula = turno.matricula || '';\n  const sexo = turno.sexo || '';\n  const dni = turno.dni || '';\n  \n  // Formatear fecha\n  const fechaFormateada = timestampAFecha(fechaTimestamp);\n  \n  // Formatear hora\n  const horaFormateada = formatearHora(hora);\n  \n  // Crear title corto (mÃ¡ximo 24 caracteres)\n  let title = `MAT ${matricula} ${fechaFormateada}`;\n  if (title.length > 24) {\n    title = title.substring(0, 21) + '...';\n  }\n  \n  // Crear description (mÃ¡ximo 72 caracteres)\n  let description = `${fechaFormateada} A LAS ${horaFormateada}HS`;\n  if (description.length > 72) {\n    description = description.substring(0, 69) + '...';\n  }\n  \n  // Crear fechaString en formato YYYYMMDD para compatibilidad\n  const dt = DateTime.fromMillis(fechaTimestamp, { zone: 'America/Argentina/Buenos_Aires' });\n  const fechaString = dt.toFormat('yyyyMMdd');\n  const hora5digitos = horaFormateada;\n  \n  // ID Ãºnico para el turno\n  const id = `turno-${fechaString}-${hora.toString()}-${matricula}`;\n  \n  console.log(`   âœ“ Title: ${title}`);\n  console.log(`   âœ“ Description: ${description}`);\n  console.log(`   âœ“ ID: ${id}`);\n  \n  rows.push({\n    id: id,\n    title: title,\n    description: description,\n    // Datos adicionales para el siguiente nodo\n    fechaString: fechaString,\n    hora5digitos: hora5digitos,\n    matricula: matricula,\n    fechaTimestamp: fechaTimestamp,\n    dni: dni,\n    sexo: sexo\n  });\n}\n\n// Limitar a 9 turnos mÃ¡ximo\nconst rowsLimitados = rows.slice(0, 9);\n\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\nconsole.log(`âœ… Lista creada con ${rowsLimitados.length} turnos`);\nconsole.log('ğŸ“‹ Rows:', JSON.stringify(rowsLimitados, null, 2));\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n\n// Retornar lista interactiva\nreturn [{\n  json: {\n    body: {\n      messaging_product: \"whatsapp\",\n      recipient_type: \"individual\",\n      to: contactNumber,\n      type: \"interactive\",\n      interactive: {\n        type: \"list\",\n        header: {\n          type: \"text\",\n          text: \"ğŸ—‘ï¸ CANCELAR TURNO\"\n        },\n        body: {\n          text: `ğŸ“‹ *TENÃ‰S ${rowsLimitados.length} TURNO${rowsLimitados.length > 1 ? 'S' : ''} PROGRAMADO${rowsLimitados.length > 1 ? 'S' : ''}*\\n\\nğŸ‘‡ SeleccionÃ¡ el turno que querÃ©s cancelar`\n        },\n        footer: {\n          text: \"â¤ï¸ ICLP - INSTITUTO CARDIOLÃ“GICO\"\n        },\n        action: {\n          button: \"VER MIS TURNOS\",\n          sections: [\n            {\n              title: \"TURNOS PROGRAMADOS\",\n              rows: rowsLimitados.map(r => ({\n                id: r.id,\n                title: r.title,\n                description: r.description\n              }))\n            }\n          ]\n        }\n      }\n    },\n    categoria: 'LISTA_TURNOS_CANCELAR',\n    contactNumber: contactNumber,\n    cantidadTurnos: rowsLimitados.length,\n    turnosData: rowsLimitados\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3456,2640],"id":"d8ee77e7-8d88-4a85-9188-c71adef7ebb8","name":"ğŸš« CANCELAR TURNO"},{"parameters":{"operation":"set","key":"=DATOS_MEDICO:{{ $('Parsear Redis').item.json.contactNumber }}","value":"={{ JSON.stringify($('datos1').item.json.lista) }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3904,2640],"id":"885ee7a3-3d10-4590-9154-d7af82ba0bc3","name":"Datos turnos","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"DATOS_PACIENTE","key":"=PACIENTE_REGISTRADO:{{ $('msg_clasificador').item.json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2784,2640],"id":"8c1a1ada-7732-4ed4-bede-7b6df344ef10","name":"DATOS_PACIENTE1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"content":"###  MUESTRA LAS FECHAS A ELIMINAR SI EXISTEN","height":240,"width":1808,"color":3},"type":"n8n-nodes-base.stickyNote","position":[2688,2560],"typeVersion":1,"id":"f4db2d27-bfc4-45c8-938c-93c816ad6037","name":"Sticky Note9"},{"parameters":{"operation":"set","key":"=status:{{ $('Parsear Redis').item.json.contactNumber }}","value":"CANCELAR-TURNO","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[4128,2640],"id":"b01b5612-1738-465b-a818-d666f7d03a8f","name":"STATUS=CANCELAR-TURNO","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"=status:{{ $('msg_clasificador').first().json.contactNumber }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3456,2384],"id":"e7fe59c0-4340-4ec5-8e98-abba4d486b20","name":"DELETE - STATUS MENU2","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"workflowId":{"__rl":true,"value":"lsdxfv73onWtf115","mode":"list","cachedResultName":"SUB - DELETE TURNO copy"},"workflowInputs":{"mappingMode":"defineBelow","value":{"matricula":"={{ $json.matricula.toNumber() }}","fecha":"={{ $json.fecha.toNumber() }}","hora":"={{ $json.hora.toNumber() }}","num_conver":"={{ $('Filtro Tipo Mensaje').item.json.conversationId }}","celular":"={{ $('msg_clasificador').item.json.contactNumber }}"},"matchingColumns":[],"schema":[{"id":"matricula","displayName":"matricula","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"fecha","displayName":"fecha","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"hora","displayName":"hora","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"num_conver","displayName":"num_conver","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"celular","displayName":"celular","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[3088,2384],"id":"3c99838e-b439-4580-9041-3f93e092a61b","name":"DELETE_TURNO"},{"parameters":{"content":"###  ELIMINAR UN TURNO","height":224,"width":976,"color":3},"type":"n8n-nodes-base.stickyNote","position":[2688,2320],"typeVersion":1,"id":"9fe7c939-0adf-4bc0-85e9-5b7d83d5e775","name":"Sticky Note5"},{"parameters":{"operation":"get","propertyName":"delete","key":"=DATOS_MEDICO:{{ $json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2736,2384],"id":"4cde4fe1-82af-4c34-8ecc-359c2affb1fd","name":"Redis3","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"// Parsear el JSON que viene como string\nconst deleteData = JSON.parse($('Redis3').item.json.delete);\n\n// Convertir fecha Unix (milisegundos) a formato legible DD/MM/YYYY\nconst fechaUnix = deleteData.fecha;\nconst fechaObj = new Date(fechaUnix);\nconst dia = String(fechaObj.getDate()).padStart(2, '0');\nconst mes = String(fechaObj.getMonth() + 1).padStart(2, '0'); // Los meses empiezan en 0\nconst aÃ±o = fechaObj.getFullYear();\nconst fechaLegible = `${dia}/${mes}/${aÃ±o}`;\n\n// Convertir hora de \"1540\" a \"15:40\"\nconst horaString = deleteData.hora;\nconst horaLegible = horaString.slice(0, 2) + ':' + horaString.slice(2);\n\n// Retornar todos los datos formateados\nreturn [{\n  json: {\n    matricula: deleteData.matricula,\n    fechaOriginal: deleteData.fecha,\n    fecha: fechaLegible, // \"14/11/2025\"\n    horaOriginal: deleteData.hora,\n    hora: horaLegible, // \"15:40\"\n    horasDigitos: deleteData.horasDigitos,\n    fechaString: deleteData.fechaString,\n    nombreMedico: deleteData.nombreMedico,\n    nombrePaciente: deleteData.nombrePaciente,\n    celular: deleteData.celular,\n    especialidad: deleteData.especialidad,\n    dni: deleteData.dni,\n    obraSocial: deleteData.obraSocial\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3264,2384],"id":"44aaf3db-9db8-4823-95f3-b57b625bfa35","name":"Code4"},{"parameters":{"workflowId":{"__rl":true,"value":"xBZYzq5pKXYbUGV7","mode":"list","cachedResultName":"SUB - ETIQUETE: TURNO_ESTUDIO"},"workflowInputs":{"mappingMode":"defineBelow","value":{"humano":true,"accountId":"={{ $('Variables').item.json.accountId }}","conversationId":"={{ $('Variables').item.json.conversationId.toString() }}","contactId":"={{ $('Variables').item.json.contactId.toString() }}","message":"={{ $('Variables').item.json.message }}","inboxId":"={{ $('Variables').item.json.inboxId.toString() }}","chatwootUrlBase":"={{ $('Variables').item.json.chatwootUrl }}","tokenChatwoot":"={{ $('Variables').item.json.agenteBotTokenWhatsapp }}","tipoIntencion":"turnos-estudios"},"matchingColumns":[],"schema":[{"id":"accountId","displayName":"accountId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"conversationId","displayName":"conversationId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"contactId","displayName":"contactId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"message","displayName":"message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"inboxId","displayName":"inboxId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"humano","displayName":"humano","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"boolean"},{"id":"chatwootUrlBase","displayName":"chatwootUrlBase","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"tokenChatwoot","displayName":"tokenChatwoot","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"tipoIntencion","displayName":"tipoIntencion","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[2768,1728],"id":"80fbb49f-ccb8-4ae7-aa3c-31a4041f1912","name":"TURNOS ESTUDIO"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[-160,3344],"id":"d4de40f4-f81b-4776-8fe0-5362a9754b40","name":"OpenRouter Chat Model2","credentials":{"openRouterApi":{"id":"ZlcbniUoDvrFqCIJ","name":"OpenRouter ICLP"}}},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"m1kjf7ed0befl04","returnAll":true,"options":{}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[-608,3120],"id":"68f6ea3d-9a5d-41e3-beaf-3dae49ca14c9","name":"obrasociales","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"jsCode":"return {\n    total: $input.all().length,\n    obrasociales: $input.all().map(item => ({\n        Id_os: item.json.Id,\n        nombre_obrasocial: item.json.nombre_obrasocial,\n        obrasocial: item.json.obrasocial\n    }))\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-384,3120],"id":"b30c8767-2144-405c-b32d-c3e91420a4d3","name":"Code6"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('msg_clasificador').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ğŸ«€ INSTITUTO DE CARDIOLOGÃA LA PLATA\"\n    },\n    \"body\": {\n      \"text\": \"*REGISTRO EXITOSO!* âœ“\\n\\n*ğŸ“‹ TUS DATOS HAN SIDO GUARDADOS*\\n\\nINFORMACIÃ“N REGISTRADA:\\n\\nâ–ªï¸ *NOMBRE:* {{ $json.datos.paciente_nombre }}\\n\\nâ–ªï¸ *DNI:* {{ $json.datos.paciente_dni }}\\n\\nâ–ªï¸ *TELÃ‰FONO:* {{ $json.datos.paciente_celular }}\\n\\nâ–ªï¸ *OBRA SOCIAL:* {{ $json.datos.nombre_obrasocial }}\\n\\nâœ“ *PRESIONÃ CONTINUAR PARA GESTIONAR TU TURNO CARDIOLÃ“GICO*\\n\\nğŸ’¬ *Â¿DETECTASTE ALGÃšN ERROR?*\\nCOMUNICATE AL *ğŸ“ (0221) 490-6310*\"\n    },\n    \"footer\": {\n      \"text\": \"LUN-VIE 8-20HS | SÃB 8-13HS\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"CONTINUAR\",\n            \"title\": \"CONTINUAR\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"MENU-PRINCIPAL\",\n            \"title\": \"MENÃš PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1216,3328],"id":"f1b27c24-25f1-4c16-aad0-7c0a866af89b","name":"âœ… DATOS VALIDADOS3","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"delete","key":"={{ $('msg_clasificador').first().json.contactNumber }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1440,3328],"id":"d7ae1d5d-f880-4e04-9d9b-abd97f413b57","name":"ğŸ¤– RESET AGENTE","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[416,3520],"id":"79bf890a-0aef-40e6-8b08-f18af3e71553","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"mE1IL02M9AnIg3tD","name":"OpenAi Credenciales ICLP"}}},{"parameters":{"workflowId":{"__rl":true,"value":"5yeTNub4mGFgBUpp","mode":"list","cachedResultName":"SUB - POST_PACIENTE"},"workflowInputs":{"mappingMode":"defineBelow","value":{"dni":"={{ $json.output.DNI.toString() }}","paciente":"={{ $json.output.NOMBRE }}","direccion":"={{ $json.output.DIRECCION }}","celular":"={{ $json.output.TELEFONO.toString() }}","obraSocial":"={{ $json.output.OBRA_SOCIAL }}","nombreobrasocial":"={{ $json.output.NOMBRE_OBRA_SOCIAL }}","whatsapp":"={{ $('msg_clasificador').first().json.contactNumber }}"},"matchingColumns":[],"schema":[{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"paciente","displayName":"paciente","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"direccion","displayName":"direccion","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"celular","displayName":"celular","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"obraSocial","displayName":"obraSocial","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"nombreobrasocial","displayName":"nombreobrasocial","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"whatsapp","displayName":"whatsapp","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[688,3216],"id":"ac878ea0-6237-4f36-a1e0-6eb2344e7c5c","name":"POST_PACIENTE"},{"parameters":{"operation":"set","key":"=PACIENTE_REGISTRADO:{{ $('Preparar Redis').first().json.contactNumber }}","value":"={{ JSON.stringify($('POST_PACIENTE').item.json.datos) }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1664,3328],"id":"4272e0f0-cefc-49a4-b4b3-62368b0e6459","name":"DATOS_PACIENTE REGISTRADO","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=status:{{ $('ğŸ”€ ROUTER PRINCIPAL').first().json.contactNumber }}","value":"PACIENTE_NUEVO_REGISTRADO","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1888,3328],"id":"6950d33f-9d54-4dd2-bce6-b730c0901320","name":"STATUS=PACIENTE_NUEVO","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"068a964d-25b6-4a1f-8e05-c47dd2fea4b7","leftValue":"={{ $json.output.ERROR }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[464,3120],"id":"31b90804-0a7d-4fc2-a20c-9ba4594f73bb","name":"Error informacion de usuario1"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('msg_clasificador').first().json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"âš ï¸ {{ $json.output.ERROR_MESSAGE }}\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[688,3024],"id":"bdead567-4b80-4fc0-bd8a-8c3bbd30cd55","name":"âš ï¸ DATOS INCORRECTOS1","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"promptType":"define","text":"={{ $('ğŸ”€ ROUTER PRINCIPAL').first().json.mensaje }}","hasOutputParser":true,"options":{"systemMessage":"=# ROL\nSos un colector/validador de datos clÃ­nicos. Siempre devolvÃ©s UN Ãºnico objeto JSON. Sin texto extra ni markdown. No uses comillas en nÃºmeros.\n\n# CONTEXTO\n$OBRAS_SOCIALES := {{ JSON.stringify($json.obrasociales) }}  // usar EXCLUSIVAMENTE este listado\nCada item: { obrasocial: string, nombre_obrasocial: string }\n\n# CONTRATO DE SALIDA\n{\n  \"status\": \"ASK\" | \"FINAL\",\n  \"ask\": \"string\",                      // UNA pregunta breve, natural y amigable por el dato que falta o hay que corregir\n  \"missing\": [\"NOMBRE\",\"DNI\",\"OBRA_SOCIAL\",\"DIRECCION\",\"TELEFONO\"],\n  \"data\": {\n    \"NOMBRE\": \"string\",\n    \"DNI\": number,\n    \"OBRA_SOCIAL\": \"string\",\n    \"NOMBRE_OBRA_SOCIAL\": \"string\",\n    \"DIRECCION\": \"string\",\n    \"TELEFONO\": number\n  },\n  \"ERROR\": true | false,\n  \"ERROR_MESSAGE\": \"string\"\n}\n\n# REGLAS DE CONVERSACIÃ“N (ORDEN)\nValidÃ¡/pedÃ­ en este orden: NOMBRE â†’ DNI â†’ OBRA_SOCIAL â†’ DIRECCION â†’ TELEFONO.\n\n# REGLAS DE ERROR Y MENSAJES\n- En status=\"ASK\":\n  A) **Si existe algÃºn dato invÃ¡lido YA PROVISTO** (segÃºn el orden), entonces:\n     - ERROR=true\n     - ERROR_MESSAGE = mensaje natural y conversacional del primer invÃ¡lido\n     - ask = pregunta amigable para **corregir ese mismo dato** (no avanzar)\n  B) **Si NO hay invÃ¡lidos, pero faltan datos**, entonces:\n     - ERROR=true\n     - ERROR_MESSAGE = mensaje natural indicando quÃ© datos faltan\n     - ask = pregunta amigable por el **prÃ³ximo** dato faltante (siguiendo el orden)\n- En status=\"FINAL\":\n  - EjecutÃ¡ validaciones estrictas. Si algo falla â†’ ERROR=true y ERROR_MESSAGE natural con **solo** el primer error; si todo ok â†’ ERROR=false y ERROR_MESSAGE=\"\"\n\n# VALIDACIONES (estrictas, SOLO aplican cuando el campo YA fue provisto; en FINAL se aplican a todos)\n1) NOMBRE: al menos dos palabras alfabÃ©ticas\n   - error natural: \"Necesito su nombre completo (nombre y apellido) para registrarlo en el sistema\"\n   \n2) DNI: ^\\\\d{7,8}$ (solo nÃºmeros, sin puntos/espacios)\n   - error natural: \"El DNI que me pasÃ³ no es vÃ¡lido. Por favor, envÃ­eme solo los nÃºmeros, sin puntos ni espacios (ejemplo: 35946257)\"\n   \n3) OBRA_SOCIAL:\n   - \"no/sin obra social/particular\" â‡’ OBRA_SOCIAL=\"PART\", NOMBRE_OBRA_SOCIAL=\"PARTICULAR\"\n   - nombre informado â‡’ normalizar y buscar en $OBRAS_SOCIALES (exacto o inclusiÃ³n); si no hay match â†’ \"Disculpe, la obra social que mencionÃ³ no figura en nuestro sistema. Â¿PodrÃ­a verificar el nombre o indicar si es particular?\"\n   - si no se informÃ³ â‡’ se considera **faltante** (no invÃ¡lido)\n   \n4) DIRECCION: debe incluir calle y **al menos un dÃ­gito**\n   - error natural: \"Me falta la direcciÃ³n completa. Por favor, indÃ­queme calle y nÃºmero (ejemplo: Calle 50 NÂ°123)\"\n   \n5) TELEFONO: ^\\\\d{10}$ (solo nÃºmeros)\n   - error natural: \"El telÃ©fono debe tener 10 dÃ­gitos. Por favor, envÃ­elo completo con cÃ³digo de Ã¡rea, solo nÃºmeros (ejemplo: 2214567890)\"\n\n# TONO DE LOS MENSAJES\n- UsÃ¡ tratamiento formal (usted) pero amigable\n- SÃ© conversacional, no robÃ³tico\n- RecordÃ¡ y reconocÃ© los datos que ya tenÃ©s (\"Perfecto, ya tengo su nombre...\")\n- Cuando pidas el siguiente dato, podÃ©s hacer referencia a lo que ya obtuviste\n- Los mensajes deben ser breves pero claros\n\n# FORMATO\n- Strings faltantes = \"\" ; nÃºmeros faltantes = 0\n- ERROR = true si falta o estÃ¡ invÃ¡lido **cualquier** campo. ERROR=false solo si los 5 estÃ¡n completos y vÃ¡lidos\n\n# EJEMPLOS (NO IMPRIMIR)\n\n## Caso: usuario solo envÃ­a NOMBRE (\"Hector miralles\")\n{\n  \"status\":\"ASK\",\n  \"ask\":\"Perfecto, Hector. Ahora necesito su DNI, por favor (7 u 8 dÃ­gitos, sin puntos)\",\n  \"missing\":[\"DNI\",\"OBRA_SOCIAL\",\"DIRECCION\",\"TELEFONO\"],\n  \"data\":{\"NOMBRE\":\"Hector miralles\",\"DNI\":0,\"OBRA_SOCIAL\":\"\",\"NOMBRE_OBRA_SOCIAL\":\"\",\"DIRECCION\":\"\",\"TELEFONO\":0},\n  \"ERROR\": true,\n  \"ERROR_MESSAGE\": \"AÃºn faltan algunos datos: DNI, obra social, direcciÃ³n y telÃ©fono\"\n}\n\n## Caso: DNI provisto pero con puntos (\"12.345.678\")\n{\n  \"status\":\"ASK\",\n  \"ask\":\"Disculpe, necesito el DNI sin puntos. Â¿Puede enviarlo solo con nÃºmeros? Por ejemplo: 12345678\",\n  \"missing\":[\"OBRA_SOCIAL\",\"DIRECCION\",\"TELEFONO\"],\n  \"data\":{\"NOMBRE\":\"Hector miralles\",\"DNI\":0,\"OBRA_SOCIAL\":\"\",\"NOMBRE_OBRA_SOCIAL\":\"\",\"DIRECCION\":\"\",\"TELEFONO\":0},\n  \"ERROR\": true,\n  \"ERROR_MESSAGE\": \"El DNI que me pasÃ³ no es vÃ¡lido. Por favor, envÃ­eme solo los nÃºmeros, sin puntos ni espacios (ejemplo: 35946257)\"\n}\n\n## Caso: Ya tenemos nombre y DNI vÃ¡lido, pedimos obra social\n{\n  \"status\":\"ASK\",\n  \"ask\":\"Excelente. Â¿Tiene obra social o es particular?\",\n  \"missing\":[\"OBRA_SOCIAL\",\"DIRECCION\",\"TELEFONO\"],\n  \"data\":{\"NOMBRE\":\"Hector Miralles\",\"DNI\":12345678,\"OBRA_SOCIAL\":\"\",\"NOMBRE_OBRA_SOCIAL\":\"\",\"DIRECCION\":\"\",\"TELEFONO\":0},\n  \"ERROR\": true,\n  \"ERROR_MESSAGE\": \"Me faltan los siguientes datos: obra social, direcciÃ³n y telÃ©fono\"\n}\n\n## Caso: Obra social no encontrada\n{\n  \"status\":\"ASK\",\n  \"ask\":\"Disculpe, la obra social 'Medicus Plus' no figura en nuestro sistema. Â¿PodrÃ­a verificar el nombre exacto o indicarme si es particular?\",\n  \"missing\":[\"DIRECCION\",\"TELEFONO\"],\n  \"data\":{\"NOMBRE\":\"Hector Miralles\",\"DNI\":12345678,\"OBRA_SOCIAL\":\"\",\"NOMBRE_OBRA_SOCIAL\":\"\",\"DIRECCION\":\"\",\"TELEFONO\":0},\n  \"ERROR\": true,\n  \"ERROR_MESSAGE\": \"Disculpe, la obra social que mencionÃ³ no figura en nuestro sistema. Â¿PodrÃ­a verificar el nombre o indicar si es particular?\"\n}\n\n## FINAL OK (todo completo y vÃ¡lido)\n{\n  \"status\":\"FINAL\",\n  \"ask\":\"\",\n  \"missing\":[],\n  \"data\":{\"NOMBRE\":\"Hector Miralles\",\"DNI\":12345678,\"OBRA_SOCIAL\":\"1\",\"NOMBRE_OBRA_SOCIAL\":\"Ioma\",\"DIRECCION\":\"Calle 50 123\",\"TELEFONO\":2215551234},\n  \"ERROR\": false,\n  \"ERROR_MESSAGE\":\"\"\n}\n\n## Caso: Usuario envÃ­a todo junto pero direcciÃ³n incompleta\n{\n  \"status\":\"ASK\",\n  \"ask\":\"Casi listo. Me falta el nÃºmero de su direcciÃ³n. Â¿En quÃ© nÃºmero de la Calle 50 vive?\",\n  \"missing\":[\"TELEFONO\"],\n  \"data\":{\"NOMBRE\":\"Hector Miralles\",\"DNI\":12345678,\"OBRA_SOCIAL\":\"1\",\"NOMBRE_OBRA_SOCIAL\":\"Ioma\",\"DIRECCION\":\"\",\"TELEFONO\":0},\n  \"ERROR\": true,\n  \"ERROR_MESSAGE\": \"Me falta la direcciÃ³n completa. Por favor, indÃ­queme calle y nÃºmero (ejemplo: Calle 50 NÂ°123)\"\n}"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[-96,3120],"id":"da2cef5b-1cb4-4c93-8055-7a338a52cf69","name":"AI Agent1"},{"parameters":{"jsonSchemaExample":"{\n  \"NOMBRE\": \"Juan PÃ©rez\",\n  \"DNI\": 0,\n  \"OBRA_SOCIAL\": \"724\",\n  \"NOMBRE_OBRA_SOCIAL\": \"Osde\",\n  \"DIRECCION\": \"Calle 50 N 123\",\n  \"TELEFONO\": 2215551234,\n  \"ERROR\": true,\n  \"ERROR_MESSAGE\": \"DNI invÃ¡lido. Debe tener 7 u 8 dÃ­gitos sin puntos (ej: 12345678). Por favor, proporcionÃ¡ tu DNI sin puntos.\"\n}","autoFix":true},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[96,3344],"id":"44b4ac05-38fa-47d4-a748-8aee7caf6a67","name":"Structured Output Parser"},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Variables').first().json.contactNumber }}","sessionTTL":600,"contextWindowLength":10},"type":"@n8n/n8n-nodes-langchain.memoryRedisChat","typeVersion":1.5,"position":[-32,3344],"id":"0126528e-12c5-4e40-b26c-97d7f9967644","name":"Redis Chat Memory1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"content":"## POST TURNO","height":704,"width":1808,"color":5},"type":"n8n-nodes-base.stickyNote","position":[2688,2816],"typeVersion":1,"id":"5c6c1b7e-7474-468d-a87f-4cc615fa22f3","name":"Sticky Note1"},{"parameters":{"content":"## ESPECIALIDADES Y MEDICOS","height":368,"width":1456,"color":4},"type":"n8n-nodes-base.stickyNote","position":[2688,1920],"typeVersion":1,"id":"6b73e144-02d3-42bf-88e9-a1d2892775e5","name":"Sticky Note4"},{"parameters":{"content":"## TURNOS ESTUDIO","height":288,"width":288,"color":7},"type":"n8n-nodes-base.stickyNote","position":[2688,1616],"typeVersion":1,"id":"c1e7c770-b3ad-4953-a949-f424fa8a663a","name":"Sticky Note6"},{"parameters":{"operation":"set","key":"=status:{{ $('ğŸ”€ ROUTER PRINCIPAL').first().json.contactNumber }}","value":"PACIENTE_NUEVO_ERROR","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[912,3024],"id":"2b04b4ad-2e5f-4d87-a439-600ca4030bc3","name":"STATUS=PACIENTE_NUEVO1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"0ff6738a-d69a-4bd6-9e26-fee07ed3e8f5","leftValue":"={{ $json.output.status_verificacion }}","rightValue":"no_encontrado","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"2ae59540-58fe-49e0-8e2a-66b811325f6e","leftValue":"={{ $json.output.status_verificacion }}","rightValue":"error","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"or"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[736,368],"id":"2dd6b2e3-baa8-451a-81f9-46d7bcdf8efc","name":"no_encontrado?"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Variables').first().json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"âš ï¸ {{ $('Get_Paciente1').item.json.output.mensaje_usuario }}\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[960,208],"id":"66a85071-19d9-42ee-a52a-b7d6453fb7fa","name":"âš ï¸ DATOS INCORRECTOS2","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Variables').first().json.contactNumber }}","value":"PACIENTE_REGISTRADO_ERROR","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1184,208],"id":"1f2eb6d7-2edf-4fb1-91b8-ebb4a0409238","name":"DATO_INCORRECTO1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"paciente","key":"=PACIENTE_REGISTRADO:{{ $('Filtro Tipo Mensaje').item.json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3728,1632],"id":"fa128542-4640-4d3a-8d99-d194cd515a8e","name":"PACIENTE","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"=DATOS_TURNO:{{ $('msg_clasificador').item.json.contactNumber }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3408,3312],"id":"65b7e402-ef6d-47dc-9805-a35e327b5474","name":"DATOS","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"url":"http://iclp.ddns.net:7080/ws-turnos-rest-simple/api/turnos/lista-turnos-actuales","sendQuery":true,"queryParameters":{"parameters":[{"name":"usuario","value":"WSTRRED"},{"name":"password","value":"Y2xpb25lcw"},{"name":"dni","value":"={{ $json.datos.paciente_dni.toNumber() }}"},{"name":"fecha","value":"={{ $now.setZone('America/Argentina/Buenos_Aires').toFormat('yyyyLLdd') }}"}]},"options":{"response":{"response":{"neverError":true,"responseFormat":"json"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2960,3632],"id":"c755b426-b7bf-431a-b08e-1c01de65f237","name":"get_turnos_agendados2","executeOnce":true,"onError":"continueErrorOutput"},{"parameters":{"assignments":{"assignments":[{"id":"8c6cf375-6158-46f1-8b42-593cf42fff40","name":"lista","value":"={{ JSON.stringify($json.lista) }}","type":"array"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[3200,3568],"id":"a8a33f6b-d3d9-42ad-a325-4b84e35c238c","name":"datos3"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.body.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.body.recipient_type }}"},{"name":"to","value":"={{ $('msg_clasificador').first().json.contactNumber }}"},{"name":"type","value":"={{ $json.body.type }}"},{"name":"interactive","value":"={{ $json.body.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3648,3568],"id":"6819f802-fec3-4a38-8891-07019aae344b","name":"MIS TURNOS2","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"jsCode":"// ============================================\n// MOSTRAR MIS TURNOS\n// ============================================\n\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\nconsole.log('ğŸ“‹ INICIANDO LISTADO DE TURNOS');\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n\n// Obtener datos del input\nconst inputData = $input.first().json;\nconsole.log('ğŸ“¦ Input completo:', JSON.stringify(inputData, null, 2));\n\n// Extraer el array de turnos\nlet turnos = [];\n\nif (inputData.lista && Array.isArray(inputData.lista)) {\n  turnos = inputData.lista;\n} else if (Array.isArray(inputData)) {\n  turnos = inputData;\n} else if (inputData.turnos && Array.isArray(inputData.turnos)) {\n  turnos = inputData.turnos;\n} else if (inputData.lista && typeof inputData.lista === 'object') {\n  // Si lista es un objeto Ãºnico, convertirlo en array\n  turnos = [inputData.lista];\n}\n\nconsole.log('ğŸ“‹ Total de turnos encontrados:', turnos.length);\n\n// Obtener contactNumber\nconst contactNumber = $('GET_PACIENTE1').first().json.datos.paciente_celular;\nconsole.log('ğŸ“± Contact Number:', contactNumber);\n\n// Verificar si existen turnos\nif (!turnos || turnos.length === 0) {\n  console.log('âŒ No hay turnos programados');\n  \n  return [{\n    json: {\n      body: {\n        messaging_product: \"whatsapp\",\n        recipient_type: \"individual\",\n        to: contactNumber,\n        type: \"interactive\",\n        interactive: {\n          type: \"button\",\n          header: {\n            type: \"text\",\n            text: \"âŒ SIN TURNOS\"\n          },\n          body: {\n            text: \"âŒ *NO TENÃ‰S TURNOS PROGRAMADOS EN ESTE MOMENTO*\\n\\nÂ¿QuerÃ©s sacar un turno nuevo?\"\n          },\n          footer: {\n            text: \"â¤ï¸ ICLP - INSTITUTO CARDIOLÃ“GICO\"\n          },\n          action: {\n            buttons: [\n              {\n                type: \"reply\",\n                reply: {\n                  id: \"volver-atras\",\n                  title: \"MENÃš PRINCIPAL\"\n                }\n              }\n            ]\n          }\n        }\n      },\n      categoria: 'SIN_TURNOS',\n      contactNumber: contactNumber\n    }\n  }];\n}\n\n// FunciÃ³n para convertir timestamp a fecha formateada\nfunction timestampAFecha(timestamp) {\n  const dt = DateTime.fromMillis(timestamp, { zone: 'America/Argentina/Buenos_Aires' });\n  return dt.toFormat('dd-MM-yyyy');\n}\n\n// FunciÃ³n para convertir timestamp a dÃ­a de la semana\nfunction timestampADiaSemana(timestamp) {\n  const dt = DateTime.fromMillis(timestamp, { zone: 'America/Argentina/Buenos_Aires' });\n  const diasSemana = ['Domingo', 'Lunes', 'Martes', 'MiÃ©rcoles', 'Jueves', 'Viernes', 'SÃ¡bado'];\n  return diasSemana[dt.weekday % 7];\n}\n\n// FunciÃ³n para formatear hora de nÃºmero a string\nfunction formatearHora(hora) {\n  const horaStr = hora.toString().padStart(4, '0');\n  return `${horaStr.substring(0, 2)}:${horaStr.substring(2, 4)}`;\n}\n\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\nconsole.log('ğŸ“ FORMATEANDO TURNOS');\n\n// Construir el mensaje con todos los turnos\nlet mensajeTurnos = `ğŸ“‹ *TUS TURNOS PROGRAMADOS:*\\n\\n`;\n\nfor (let i = 0; i < turnos.length; i++) {\n  const turno = turnos[i];\n  \n  console.log(`\\nğŸ« Procesando turno ${i + 1}:`, JSON.stringify(turno, null, 2));\n  \n  // Extraer datos del turno\n  const fechaTimestamp = turno.fecha || 0;\n  const hora = turno.hora || 0;\n  const matricula = turno.matricula || 'Sin matrÃ­cula';\n  const nombreMedico = turno.nombreMedico || 'Profesional';\n  const dni = turno.dni || '';\n  const sexo = turno.sexo || '';\n  \n  // Formatear fecha y hora\n  const fechaFormateada = timestampAFecha(fechaTimestamp);\n  const diaSemana = timestampADiaSemana(fechaTimestamp);\n  const horaFormateada = formatearHora(hora);\n  \n  console.log(`   âœ“ Fecha: ${fechaFormateada} (${diaSemana})`);\n  console.log(`   âœ“ Hora: ${horaFormateada}`);\n  console.log(`   âœ“ MÃ©dico: ${nombreMedico}`);\n  console.log(`   âœ“ MatrÃ­cula: ${matricula}`);\n  \n  // Agregar separador si hay mÃºltiples turnos\n  if (i > 0) {\n    mensajeTurnos += `\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n`;\n  }\n  \n  // Construir informaciÃ³n del turno\n  mensajeTurnos += `ğŸ—“ï¸ *TURNO ${i + 1}*\\n`;\n  mensajeTurnos += `ğŸ‘¨â€âš•ï¸ *Profesional:* Dr/a. ${nombreMedico}\\n`;\n  mensajeTurnos += `ğŸ”¢ *MatrÃ­cula:* ${matricula}\\n`;\n  mensajeTurnos += `ğŸ“… *Fecha:* ${diaSemana}, ${fechaFormateada}\\n`;\n  mensajeTurnos += `â° *Hora:* ${horaFormateada}hs`;\n  \n  if (i < turnos.length - 1) {\n    mensajeTurnos += `\\n`;\n  }\n}\n\n// Agregar footer informativo\nmensajeTurnos += `\\n\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\nğŸ’¡ *Â¿NECESITÃS CANCELAR UN TURNO?*\\nVolvÃ© al menÃº principal y elegÃ­ *\"CANCELAR TURNO\"*`;\n\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\nconsole.log('âœ… Mensaje de turnos construido');\nconsole.log('ğŸ“ Mensaje:', mensajeTurnos);\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n\n// Retornar el mensaje con botÃ³n\nreturn [{\n  json: {\n    body: {\n      messaging_product: \"whatsapp\",\n      recipient_type: \"individual\",\n      to: contactNumber,\n      type: \"interactive\",\n      interactive: {\n        type: \"button\",\n        header: {\n          type: \"text\",\n          text: \"ğŸ“… MIS TURNOS\"\n        },\n        body: {\n          text: mensajeTurnos\n        },\n        footer: {\n          text: \"â¤ï¸ ICLP - INSTITUTO CARDIOLÃ“GICO\"\n        },\n        action: {\n          buttons: [\n            {\n              type: \"reply\",\n              reply: {\n                id: \"menu-principal\",\n                title: \"MENÃš PRINCIPAL\"\n              }\n            }\n          ]\n        }\n      }\n    },\n    categoria: 'MOSTRAR_MIS_TURNOS',\n    contactNumber: contactNumber,\n    cantidadTurnos: turnos.length,\n    turnosData: turnos\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3424,3568],"id":"8911b0d4-f227-4ad9-8cf7-1048796a7251","name":"ğŸ“‹ LISTAR TURNOS1"},{"parameters":{"operation":"get","propertyName":"datos","key":"=PACIENTE_REGISTRADO:{{ $('Variables').first().json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2736,3632],"id":"27dc23bc-d93a-4929-9021-3a95ad1e84f1","name":"GET_PACIENTE1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"content":"## PRESIONAN \"MIS TURNOS\"","height":384,"width":1184,"color":7},"type":"n8n-nodes-base.stickyNote","position":[2656,3536],"typeVersion":1,"id":"5e51f757-0e15-4e44-a7ad-b20241c9417e","name":"Sticky Note7"},{"parameters":{"content":"## MENU\n* MIS TURNOS\n* Turnos estudio-TURNOS CONSULTORIO","height":480,"width":752,"color":2},"type":"n8n-nodes-base.stickyNote","position":[2688,1104],"typeVersion":1,"id":"30e24d6f-92d5-4090-a32c-941b63ae2e54","name":"Sticky Note8"},{"parameters":{"content":"## CREAR PACIENTE O REGISTRARSE","height":464,"width":960,"color":5},"type":"n8n-nodes-base.stickyNote","position":[2688,624],"typeVersion":1,"id":"2d758552-6d54-4af8-9db0-f38c2becd8b3","name":"Sticky Note10"},{"parameters":{"operation":"delete","key":"PACIENTE_REGISTRADO:+5492254596618"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-4048,2336],"id":"aba67d99-b914-431b-8b79-a41eaaabc73f","name":"Redis4","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"PACIENTE_REGISTRADO:+5492254596618"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3808,2336],"id":"a0188af3-9b23-4654-a941-b0f4b76aad19","name":"Redis5","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3fd1ef0d-ded2-4bfa-b57f-4d7e151cfabe","leftValue":"={{ $json.statusCode }}","rightValue":"ERROR","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[976,3216],"id":"db2d8202-0a48-437d-b69f-a5a97e8d12ea","name":"error servidor","executeOnce":false},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"7d168b67-4edc-44b8-bffa-a59133961fdb","leftValue":"={{ $('msg_clasificador').first().json.mensaje.includes('VER MÃS')  }}","rightValue":"=","operator":{"type":"boolean","operation":"true","singleValue":true}},{"id":"259614a6-d4f8-4386-9247-0d159aa32819","leftValue":"={{ $('msg_clasificador').first().json.mensaje.includes('INICIO')  }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"or"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[3632,2144],"id":"2b8a046a-1849-44cf-a1fd-36eaeea1562d","name":"If2"},{"parameters":{"operation":"set","key":"=ESPECIALIDAD_SELECIONADA:{{ $('LISTA_MEDICOS').item.json.to }}","value":"={{ $('Preparar Redis').first()?.json?.metadata?.codigoEspecialidad || $('Preparar Redis').first()?.json?.categoria }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3920,2160],"id":"fdab3ee3-b8b4-4de9-aa5b-c350588a9ab8","name":"ğŸ©º ESPECIALIDADES","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"especialidad","key":"=ESPECIALIDAD_SELECIONADA:{{ $('Filtro Tipo Mensaje').item.json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3952,1632],"id":"3067056a-8f9b-4461-b73b-815f63639502","name":"ESPECIALIDAD","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"workflowId":{"__rl":true,"value":"gsbUq8JFSpw8U7yR","mode":"list","cachedResultName":"SUB - ETIQUETA: CONSULTA_RECLAMO"},"workflowInputs":{"mappingMode":"defineBelow","value":{"humano":true,"accountId":"={{ $('Filtro Tipo Mensaje').item.json.accountId }}","conversationId":"={{ $('Filtro Tipo Mensaje').item.json.conversationId.toString() }}","contactId":"={{ $('Filtro Tipo Mensaje').item.json.contactId.toString() }}","message":"={{ $('Filtro Tipo Mensaje').item.json.message }}","inboxId":"={{ $('Filtro Tipo Mensaje').item.json.inboxId.toString() }}","chatwootUrlBase":"={{ $('Filtro Tipo Mensaje').item.json.chatwootUrl }}","tokenChatwoot":"={{ $('Filtro Tipo Mensaje').item.json.agenteBotTokenWhatsapp }}","tipoIntencion":"consultas-reclamos"},"matchingColumns":[],"schema":[{"id":"accountId","displayName":"accountId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"conversationId","displayName":"conversationId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"contactId","displayName":"contactId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"message","displayName":"message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"inboxId","displayName":"inboxId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"humano","displayName":"humano","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"boolean"},{"id":"chatwootUrlBase","displayName":"chatwootUrlBase","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"tokenChatwoot","displayName":"tokenChatwoot","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"tipoIntencion","displayName":"tipoIntencion","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-16,1440],"id":"f8b58219-88a6-46a5-b297-7a47d76912be","name":"ETIQUETA CONSULTA-RECLAMO1"},{"parameters":{"operation":"set","key":"=DATOS_TURNO:{{ $('msg_clasificador').item.json.contactNumber }}","value":"={{ JSON.stringify($json.datos) }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[4320,2896],"id":"a23bc270-e70b-4b96-8c03-6f6720d8a166","name":"DATOS_TURNO_PACIENTE1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"// Extraer datos del paciente\nconst nombre = $('GET_PACIENTE_REGISTRADO').first().json.DATOS_PACIENTE.paciente_nombre;\nconst celular = $('GET_PACIENTE_REGISTRADO').first().json.DATOS_PACIENTE.paciente_celular;\nconst dni = $('GET_PACIENTE_REGISTRADO').first().json.DATOS_PACIENTE.paciente_dni;\n\n// Extraer datos del mÃ©dico\nlet matricula = $('Preparar Redis').first().json.metadata.matricula;\nlet medico = $('Preparar Redis').first().json.metadata.medico;\n\n// Si matricula estÃ¡ vacÃ­a, extraer del mensaje\nif (!matricula || matricula === '' || matricula === null) {\n  try {\n    const mensaje = $('Preparar Redis').first().json.mensaje;\n    \n    // Extraer solo el NÃšMERO del formato NOMBRE-NUMERO (ej: HONAINE-114788 â†’ 114788)\n    const match = mensaje.match(/\\d+$/);\n    matricula = match ? match[0] : mensaje;\n    \n    console.log('âš ï¸ MatrÃ­cula extraÃ­da del mensaje:', mensaje, 'â†’', matricula);\n  } catch (error) {\n    console.error('âŒ Error al extraer matrÃ­cula del mensaje:', error);\n    matricula = '';\n  }\n}\n\n// Si medico estÃ¡ vacÃ­o, extraer del mensajeOriginal\nif (!medico || medico === '' || medico === null) {\n  try {\n    const mensajeOriginal = $('Preparar Redis').first().json.mensajeOriginal;\n    \n    // Extraer solo el NOMBRE del formato NOMBRE-NUMERO (ej: HONAINE-114788 â†’ HONAINE)\n    const match = mensajeOriginal.match(/^[^-]+/);\n    medico = match ? match[0].trim() : mensajeOriginal;\n    \n    console.log('âš ï¸ MÃ©dico extraÃ­do del mensajeOriginal:', mensajeOriginal, 'â†’', medico);\n  } catch (error) {\n    console.error('âŒ Error al extraer mÃ©dico del mensajeOriginal:', error);\n    medico = '';\n  }\n}\n\n// Obtener fecha de hoy\nconst fecha = Number(DateTime.now().setZone('America/Argentina/Buenos_Aires').toFormat('yyyyMMdd'));\n\n// Crear objeto JSON final\nconst dato_turno = {\n  datos: {\n    dni: dni,\n    matricula: matricula,\n    fecha: fecha,\n    celular: celular,\n    medico: medico,\n    medicoSeleccionado: medico,\n    nombre: nombre\n  }\n};\n\n// Retornar el objeto\nreturn dato_turno;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[4096,2896],"id":"49ff7378-c673-44f7-a96e-691fd28f4aff","name":"PACIENTE_MEDICO_MATRICULA"},{"parameters":{"assignments":{"assignments":[{"id":"53b3acf5-339b-4630-81b6-2dba96c0225a","name":"hora","value":"={{ $json.datos.parseJson().hora.replace(':','') }}","type":"string"},{"id":"65206830-79af-4863-9ffa-a6e13bd230fa","name":"fecha","value":"={{ DateTime.fromFormat($json.datos.parseJson().fecha.toString(), 'yyyyMMdd').toMillis() }}","type":"string"},{"id":"5bc9f50b-e059-4b1e-8649-0f27878afd04","name":"nombre","value":"={{ $json.datos.parseJson().nombre }}","type":"string"},{"id":"61edc5f5-0adf-46b1-9078-1ac62e935624","name":"celuar","value":"={{ $json.datos.parseJson().celular }}","type":"string"},{"id":"2a145278-e2f1-4792-a2fa-bda0873b0ec9","name":"dni","value":"={{ $json.datos.parseJson().dni }}","type":"number"},{"id":"63505ada-1a27-4933-80de-29587d81356c","name":"matricula","value":"={{ $json.datos.parseJson().matricula.toNumber() }}","type":"number"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[2960,3312],"id":"267c927c-f7d4-4ccd-87dd-93823edc7657","name":"Edit Fields"},{"parameters":{"assignments":{"assignments":[{"id":"99a95393-32fb-4ee2-ac21-a7d1b9040ae2","name":"DATOS_PACIENTE.paciente_dni","value":"={{ $json.DATOS_PACIENTE.paciente_dni }}","type":"number"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[2976,2896],"id":"10d177c6-ac40-4062-b932-543cdd2bdb48","name":"dni"},{"parameters":{"jsCode":"// ============================================\n// PREPARAR DATOS PARA ELIMINAR TURNO\n// ============================================\n\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\nconsole.log('ğŸ—‘ï¸ INICIO');\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n\n// PASO 1: Obtener datos de Redis\nconst inputCompleto = $input.first().json;\nconsole.log('ğŸ“¦ INPUT KEYS:', Object.keys(inputCompleto));\n\n// PASO 2: Extraer y PARSEAR array delete\nlet turnosRedis = inputCompleto.delete;\nconsole.log('ğŸ“‹ Tipo inicial:', typeof turnosRedis);\nconsole.log('ğŸ“‹ Valor inicial:', turnosRedis);\n\n// Si es string, parsearlo\nif (typeof turnosRedis === 'string') {\n  console.log('âš ï¸ Es string, parseando...');\n  try {\n    turnosRedis = JSON.parse(turnosRedis);\n    console.log('âœ… Parseado exitoso');\n  } catch (e) {\n    console.log('âŒ Error al parsear:', e.message);\n    return [{\n      json: {\n        error: true,\n        mensaje: 'Error al parsear datos de Redis'\n      }\n    }];\n  }\n}\n\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\nconsole.log('ğŸ“‹ TURNOS PARSEADOS:');\nconsole.log('   Es Array:', Array.isArray(turnosRedis));\nconsole.log('   Cantidad:', turnosRedis ? turnosRedis.length : 0);\nconsole.log('   Datos:', JSON.stringify(turnosRedis, null, 2));\n\n// Validar array\nif (!turnosRedis || !Array.isArray(turnosRedis) || turnosRedis.length === 0) {\n  console.log('âŒ Array vacÃ­o o invÃ¡lido');\n  return [{\n    json: {\n      error: true,\n      mensaje: 'No hay turnos disponibles en Redis'\n    }\n  }];\n}\n\nconsole.log('âœ… Array con', turnosRedis.length, 'turnos');\n\n// PASO 3: Obtener mensaje\nconst mensaje = $('Preparar Redis').first().json.mensaje;\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\nconsole.log('ğŸ“¨ MENSAJE:', mensaje);\n\nif (!mensaje) {\n  return [{\n    json: {\n      error: true,\n      mensaje: 'No hay mensaje'\n    }\n  }];\n}\n\n// PASO 4: Parsear mensaje \"MAT 114163 14-11-2025\"\nconst partes = mensaje.split(' ');\nconsole.log('ğŸ” Partes del mensaje:', partes);\n\nif (partes.length < 3) {\n  return [{\n    json: {\n      error: true,\n      mensaje: 'Formato de mensaje invÃ¡lido'\n    }\n  }];\n}\n\nconst matriculaBuscada = partes[1];\nconst fechaDDMMYYYY = partes[2];\n\n// Convertir DD-MM-YYYY a YYYYMMDD\nconst [dia, mes, aÃ±o] = fechaDDMMYYYY.split('-');\nconst fechaBuscada = `${aÃ±o}${mes}${dia}`;\n\nconsole.log('ğŸ¯ BUSCAR:');\nconsole.log('   MatrÃ­cula:', matriculaBuscada);\nconsole.log('   Fecha:', fechaBuscada);\n\n// PASO 5: Buscar el turno\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\nconsole.log('ğŸ” BUSCANDO EN', turnosRedis.length, 'TURNOS...');\n\nlet encontrado = null;\n\nfor (let i = 0; i < turnosRedis.length; i++) {\n  const turno = turnosRedis[i];\n  console.log(`\\n--- TURNO ${i} ---`);\n  console.log('   MatrÃ­cula:', turno.matricula);\n  console.log('   Fecha timestamp:', turno.fecha);\n  console.log('   Hora:', turno.hora);\n  \n  if (!turno.fecha || !turno.matricula || !turno.hora) {\n    console.log('   âŒ Datos incompletos');\n    continue;\n  }\n  \n  // Convertir timestamp a YYYYMMDD\n  const dt = DateTime.fromMillis(turno.fecha, { zone: 'America/Argentina/Buenos_Aires' });\n  const fechaStr = dt.toFormat('yyyyMMdd');\n  const matriculaStr = turno.matricula.toString();\n  \n  console.log('   Fecha formateada:', fechaStr);\n  console.log('   MatrÃ­cula string:', matriculaStr);\n  console.log('   Â¿Coincide?:', fechaStr === fechaBuscada && matriculaStr === matriculaBuscada);\n  \n  if (fechaStr === fechaBuscada && matriculaStr === matriculaBuscada) {\n    encontrado = turno;\n    console.log('   âœ… Â¡MATCH!');\n    break;\n  }\n}\n\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n\nif (!encontrado) {\n  console.log('âŒ NO ENCONTRADO');\n  return [{\n    json: {\n      error: true,\n      mensaje: 'No se encontrÃ³ el turno seleccionado'\n    }\n  }];\n}\n\n// PASO 6: Preparar resultado\nconst resultado = {\n  matricula: encontrado.matricula.toString(),\n  fecha: DateTime.fromMillis(encontrado.fecha).toFormat('yyyyMMdd'),\n  hora: encontrado.hora.toString().padStart(4, '0')\n};\n\nconsole.log('âœ… RESULTADO:');\nconsole.log(JSON.stringify(resultado, null, 2));\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n\nreturn [{\n  json: resultado\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2912,2384],"id":"bcdf0896-5093-4c94-b1eb-8ddffbb8bfed","name":"Code1"},{"parameters":{"jsCode":"// ============================================\n// PREPARADOR DE MENSAJES DE INFORMACIÃ“N\n// ============================================\n// Prepara el body del HTTP Request segÃºn la categorÃ­a\n// ============================================\n\n// Obtener datos del nodo anterior\nconst categoria = $json.categoria;\nconst contactNumber = $json.contactNumber;\nconst mensaje = $json.mensaje || '';\n\n// ============================================\n// VERIFICACIÃ“N ESPECIAL: INFO GENERAL\n// ============================================\n// SIEMPRE que el mensaje contenga \"INFO GENERAL\", mostrar el menÃº\n// sin importar la categorÃ­a\nif (mensaje.includes('INFO GENERAL')) {\n  \n  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n  console.log('ğŸ”„ INFO GENERAL DETECTADO');\n  console.log('ğŸ“‹ CategorÃ­a original:', categoria);\n  console.log('ğŸ’¬ Mensaje:', mensaje);\n  console.log('ğŸ“± Mostrando menÃº de informaciÃ³n general');\n  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n  \n  // Crear mensaje con menÃº de informaciÃ³n general\n  const menuInfoGeneral = {\n    \"messaging_product\": \"whatsapp\",\n    \"recipient_type\": \"individual\",\n    \"to\": contactNumber,\n    \"type\": \"interactive\",\n    \"interactive\": {\n      \"type\": \"list\",\n      \"header\": {\n        \"type\": \"text\",\n        \"text\": \"â„¹ï¸ INFORMACIÃ“N GENERAL\"\n      },\n      \"body\": {\n        \"text\": \"SeleccionÃ¡ la informaciÃ³n que necesitÃ¡s:\"\n      },\n      \"footer\": {\n        \"text\": \"Instituto de CardiologÃ­a La Plata\"\n      },\n      \"action\": {\n        \"button\": \"Ver opciones\",\n        \"sections\": [\n          {\n            \"title\": \"InformaciÃ³n disponible\",\n            \"rows\": [\n              {\n                \"id\": \"info_portal\",\n                \"title\": \"ğŸ’» Portal del Paciente\",\n                \"description\": \"Acceso y credenciales\"\n              },\n              {\n                \"id\": \"info_direccion\",\n                \"title\": \"ğŸ“ UbicaciÃ³n\",\n                \"description\": \"DirecciÃ³n y mapa\"\n              },\n              {\n                \"id\": \"info_recetas\",\n                \"title\": \"ğŸ’Š Recetas MÃ©dicas\",\n                \"description\": \"CÃ³mo solicitar recetas\"\n              },\n              {\n                \"id\": \"info_horarios\",\n                \"title\": \"ğŸ•’ Horarios\",\n                \"description\": \"Horarios de atenciÃ³n\"\n              },\n              {\n                \"id\": \"info_medicos\",\n                \"title\": \"ğŸ‘¨â€âš•ï¸ MÃ©dicos\",\n                \"description\": \"Lista de profesionales\"\n              },\n              {\n                \"id\": \"info_especialidades\",\n                \"title\": \"ğŸ¥ Especialidades\",\n                \"description\": \"Servicios mÃ©dicos\"\n              }\n            ]\n          }\n        ]\n      }\n    }\n  };\n  \n  return [{\n    json: {\n      body: menuInfoGeneral,\n      categoria: 'INFO_GENERAL_MENU',  // Cambiar la categorÃ­a para tracking\n      categoriaOriginal: categoria,     // Guardar la categorÃ­a original\n      mensajeOriginal: mensaje,         // Guardar el mensaje original\n      contactNumber: contactNumber,\n      esFlujoDirecto: true,\n      esMenuInfo: true,\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\n// ============================================\n// FLUJOS NORMALES (CÃ“DIGO ORIGINAL)\n// ============================================\n\n// CategorÃ­as que requieren flujos especiales (no mensajes directos)\nconst FLUJOS_ESPECIALES = {\n  INFO_MEDICOS: 'medicos',\n  INFO_ESPECIALIDADES: 'especialidades'\n};\n\n// Mapeo de categorÃ­as a mensajes directos\nconst MENSAJES = {\n  INFO_PORTAL: {\n    \"messaging_product\": \"whatsapp\",\n    \"recipient_type\": \"individual\",\n    \"to\": contactNumber,\n    \"type\": \"text\",\n    \"text\": {\n      \"preview_url\": true,\n      \"body\": \"ğŸ’» *PORTAL DEL PACIENTE*\\n\\nğŸŒ *Acceso:*\\nwww.iclp.com.ar â†’ \\\"PORTAL PACIENTES\\\"\\n\\nğŸ” *Tus datos de acceso:*\\nâ€¢ Usuario: [TU DNI] (sin puntos)\\nâ€¢ ContraseÃ±a: p + Ãºltimos 5 nÃºmeros del DNI\\n\\nğŸ“ *Ejemplo:*\\nDNI 12345678 â†’ ContraseÃ±a: p45678\\n\\nÂ¿NecesitÃ¡s ayuda? Â¡Contactanos! ğŸ’™\"\n    }\n  },\n  \n  INFO_DIRECCION: {\n    \"messaging_product\": \"whatsapp\",\n    \"recipient_type\": \"individual\",\n    \"to\": contactNumber,\n    \"type\": \"text\",\n    \"text\": {\n      \"preview_url\": true,\n      \"body\": \"ğŸ“ *UBICACIÃ“N*\\n\\nğŸ¥ *INSTITUTO DE CARDIOLOGÃA LA PLATA*\\n\\nğŸ“Œ *DirecciÃ³n:*\\nCalle 6 NÂ°212 (entre 36 y 37)\\nLa Plata, Buenos Aires\\n\\nğŸ—ºï¸ *Ver en Google Maps:*\\nhttps://maps.app.goo.gl/ij23zZscf3vTKQV56\\n\\nğŸ“ *TelÃ©fono:*\\n(0221) 4906310\\n\\nÂ¡Te esperamos! ğŸ’š\"\n    }\n  },\n  \n  INFO_RECETAS: {\n    \"messaging_product\": \"whatsapp\",\n    \"recipient_type\": \"individual\",\n    \"to\": contactNumber,\n    \"type\": \"text\",\n    \"text\": {\n      \"preview_url\": false,\n      \"body\": \"ğŸ’Š *RECETAS MÃ‰DICAS*\\n\\nâœ¨ Â¡Te explico cÃ³mo pedir tus recetas!\\n\\nğŸ“§ *MANERA MÃS FÃCIL - POR EMAIL*\\nâœ‰ï¸ Correo: recetas@iclpsrl.com.ar\\n\\nğŸ“ *Envianos:*\\nâ€¢ Apellido y nombre\\nâ€¢ Obra social\\nâ€¢ NÃºmero de afiliado\\nâ€¢ Nombre del mÃ©dico\\n\\nğŸš¨ *ATENCIÃ“N ESPECIAL - Dr. FabiÃ¡n Barba*\\nğŸ“² Sus recetas solo por WhatsApp:\\n2216810260\\n\\nÂ¿NecesitÃ¡s ayuda? Â¡Estamos para ayudarte! ğŸ’š\"\n    }\n  },\n  \n  INFO_HORARIOS: {\n    \"messaging_product\": \"whatsapp\",\n    \"recipient_type\": \"individual\",\n    \"to\": contactNumber,\n    \"type\": \"text\",\n    \"text\": {\n      \"preview_url\": false,\n      \"body\": \"ğŸ•’ *HORARIO DE ATENCIÃ“N*\\n\\nğŸ“… *Nuestros horarios son:*\\nâ€¢ Lunes a Viernes: 08:00 - 20:00hs\\nâ€¢ SÃ¡bados: 08:00 - 13:00hs\\nâ€¢ Domingos: CERRADO\\n\\nğŸ“ *Contacto:*\\nTelÃ©fono: (0221) 4906310\\n\\nÂ¡Te esperamos! ğŸ’™\"\n    }\n  }\n};\n\n// ============================================\n// DETERMINAR TIPO DE FLUJO\n// ============================================\n\n// 1. Verificar si es un flujo especial (mÃ©dicos o especialidades)\nif (FLUJOS_ESPECIALES[categoria]) {\n  const tipoFlujo = FLUJOS_ESPECIALES[categoria];\n  \n  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n  console.log('ğŸ”€ FLUJO ESPECIAL DETECTADO');\n  console.log('ğŸ¯ CategorÃ­a:', categoria);\n  console.log('ğŸ“‹ Tipo de flujo:', tipoFlujo);\n  console.log('ğŸ“± Destinatario:', contactNumber);\n  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n  \n  return [{\n    json: {\n      tipoFlujo: tipoFlujo,           // \"medicos\" o \"especialidades\"\n      categoria: categoria,\n      contactNumber: contactNumber,\n      esFlujoDirecto: false           // Requiere procesamiento adicional\n    }\n  }];\n}\n\n// 2. Si tiene mensaje predefinido, usarlo\nif (MENSAJES[categoria]) {\n  const mensajeBody = MENSAJES[categoria];\n  \n  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n  console.log('ğŸ“¤ MENSAJE DIRECTO');\n  console.log('ğŸ¯ CategorÃ­a:', categoria);\n  console.log('ğŸ“± Destinatario:', contactNumber);\n  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n  \n  return [{\n    json: {\n      body: mensajeBody,\n      categoria: categoria,\n      contactNumber: contactNumber,\n      esFlujoDirecto: true,           // Mensaje listo para enviar\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\n// 3. Mensaje de texto simple (fallback)\nconst mensajeBody = {\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": contactNumber,\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": mensaje\n  }\n};\n\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\nconsole.log('ğŸ“ MENSAJE TEXTO SIMPLE');\nconsole.log('ğŸ¯ CategorÃ­a:', categoria);\nconsole.log('ğŸ“± Destinatario:', contactNumber);\nconsole.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');\n\nreturn [{\n  json: {\n    body: mensajeBody,\n    categoria: categoria,\n    contactNumber: contactNumber,\n    esFlujoDirecto: true,\n    timestamp: new Date().toISOString()\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1168,4400],"id":"994d67c1-13de-4b32-8da6-e59368866ea5","name":"Code"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.body.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.body.recipient_type }}"},{"name":"to","value":"={{ $json.body.to }}"},{"name":"type","value":"={{ $json.body.type }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-304,4672],"id":"a824c470-941f-4c7a-aa56-a6ca0867dab7","name":"Medicos","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('msg_clasificador').first().json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"â° *SESIÃ“N CADUCADA* Vuevla al _MENU PRINCIPAL_\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3200,3744],"id":"f3d55354-f8f5-42b1-96bc-5054b546bbe1","name":"âš ï¸ DATOS INCORRECTOS3","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=status:{{ $('msg_clasificador').first().json.contactNumber }}","value":"={{ $('msg_clasificador').item.json.nuevoEstado }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-80,4864],"id":"579bd0de-1f43-4966-a05b-8577c09a8859","name":"â±ï¸ STATUS PRIMERA VEZ4","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.body.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.body.recipient_type }}"},{"name":"to","value":"={{ $json.body.to }}"},{"name":"type","value":"={{ $json.body.type }}"},{"name":"text","value":"={{ $json.body.text }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-304,4864],"id":"77848283-321f-4922-82a2-daf8bb84c68b","name":"Other","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"d146038a-5a06-4b8e-80f3-f16faec1d3a6","leftValue":"={{ $json.esFlujoDirecto }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-528,4768],"id":"ccaa0e3d-79d4-45d1-b4ef-cd35f0cb2bc1","name":"ES_DIRECTO"}],"connections":{"Variables":{"main":[[{"node":"Filtrar nÃºmeros de prueba","type":"main","index":0}]]},"Filtro Tipo Mensaje":{"main":[[],[{"node":"MSG ENVIADO?","type":"main","index":0}],[{"node":"HTTP Request4","type":"main","index":0}]]},"ğŸ” Get Estado Actual":{"main":[[{"node":"Parsear Redis","type":"main","index":0}]]},"ğŸ“± Mensaje Menu Principal":{"main":[[{"node":"ğŸ’¾ Set Estado MENU","type":"main","index":0}]]},"ğŸ’¾ Set Estado MENU":{"main":[[{"node":"HTTP Request2","type":"main","index":0}]]},"ğŸ« Router GestiÃ³n Turnos":{"main":[[{"node":"CREAR PACIENTE","type":"main","index":0}]]},"ğŸ“± Mensaje Info General":{"main":[[{"node":"ğŸ’¾ Set Estado MENU2","type":"main","index":0}]]},"ğŸ“… Turnos - PACIENTE NUEVO - PACIENTE REGISTRADO - ":{"main":[[{"node":"ğŸ’¾ Set Estado MENU1","type":"main","index":0}]]},"ğŸ’¾ Set Estado MENU1":{"main":[[{"node":"HTTP Request3","type":"main","index":0}]]},"â±ï¸ STATUS PRIMERA VEZ":{"main":[[{"node":"HTTP Request5","type":"main","index":0}]]},"CREAR PACIENTE":{"main":[[{"node":"â±ï¸ STATUS PRIMERA VEZ","type":"main","index":0}]]},"ğŸ’¾ Set Estado MENU2":{"main":[[{"node":"HTTP Request1","type":"main","index":0}]]},"HTTP Request4":{"main":[[{"node":"ESPECIALIDAD","type":"main","index":0}]]},"msg_clasificador":{"main":[[{"node":"Preparar Redis","type":"main","index":0}]]},"ğŸ¢ AdministraciÃ³n":{"main":[[{"node":"HTTP Request6","type":"main","index":0}]]},"HTTP Request6":{"main":[[{"node":"ğŸ’¾ Set Estado MENU3","type":"main","index":0}]]},"Filtrar nÃºmeros de prueba":{"main":[[{"node":"Filtro Tipo Mensaje","type":"main","index":0}]]},"ğŸ’¾ Set Estado MENU3":{"main":[[{"node":"ETIQUETA CONSULTA-RECLAMO1","type":"main","index":0}]]},"ETIQUETA CONSULTA-RECLAMO":{"main":[[{"node":"HTTP Request7","type":"main","index":0}]]},"HTTP Request8":{"main":[[{"node":"sendRespondCw","type":"main","index":0}]]},"sendRespondCw":{"main":[[{"node":"contador","type":"main","index":0}]]},"MSG ENVIADO?":{"main":[[{"node":"If","type":"main","index":0}]]},"If":{"main":[[],[{"node":"HTTP Request8","type":"main","index":0}]]},"ESPECIALIDADES2":{"main":[[{"node":"ENVIA-> MENU-SACAR TURNO","type":"main","index":0}]]},"MEDICOS":{"main":[[{"node":"ENVIA-> MENU-SACAR TURNO1","type":"main","index":0}]]},"Msg preparado":{"main":[[{"node":"MEDICOS","type":"main","index":0}]]},"get_medicos1":{"main":[[{"node":"Msg preparado","type":"main","index":0}]]},"get_especialidades":{"main":[[{"node":"Msg preparado1","type":"main","index":0}]]},"Msg preparado1":{"main":[[{"node":"ESPECIALIDADES2","type":"main","index":0}]]},"ğŸ”€ SWITCH INFO FLUJOS":{"main":[[{"node":"get_medicos1","type":"main","index":0}],[{"node":"get_especialidades","type":"main","index":0}],[{"node":"ES_DIRECTO","type":"main","index":0}]]},"ğŸ« Router GestiÃ³n Turnos1":{"main":[[{"node":"PACIENTE REGISTRADO","type":"main","index":0}]]},"PACIENTE REGISTRADO":{"main":[[{"node":"â±ï¸ STATUS PRIMERA VEZ2","type":"main","index":0}]]},"â±ï¸ STATUS PRIMERA VEZ2":{"main":[[{"node":"PREPARAR_CONFIRMAR_TURNO","type":"main","index":0}]]},"ğŸ”€ SWITCH DATOS PACIENTE":{"main":[[{"node":"ğŸ« Router GestiÃ³n Turnos1","type":"main","index":0}],[{"node":"obrasociales","type":"main","index":0}],[{"node":"obrasociales","type":"main","index":0}]]},"PACIENTE REGISTRADO1":{"main":[[{"node":"SOLICITAR DNI","type":"main","index":0}]]},"SOLICITAR DNI":{"main":[[{"node":"â±ï¸ STATUS PRIMERA VEZ3","type":"main","index":0}]]},"Error informacion de usuario":{"main":[[{"node":"âš ï¸ DATOS INCORRECTOS","type":"main","index":0}],[{"node":"Get_Paciente1","type":"main","index":0}]]},"âš ï¸ DATOS INCORRECTOS":{"main":[[{"node":"DATO_INCORRECTO","type":"main","index":0}]]},"OpenRouter Chat Model1":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"Structured Output Parser1":{"ai_outputParser":[[{"node":"AI Agent","type":"ai_outputParser","index":0}]]},"AI Agent":{"main":[[{"node":"Error informacion de usuario","type":"main","index":0}]]},"Get_Paciente1":{"main":[[{"node":"no_encontrado?","type":"main","index":0}]]},"âœ… DATOS VALIDADOS":{"main":[[{"node":"DNI VERIFICADO","type":"main","index":0}]]},"obra_social1":{"main":[[{"node":"Code8","type":"main","index":0}]]},"Code8":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"Redis Chat Memory":{"ai_memory":[[{"node":"AI Agent","type":"ai_memory","index":0}]]},"DNI VERIFICADO":{"main":[[{"node":"PACIENTE_REGISTRADO","type":"main","index":0}]]},"msg":{"main":[[{"node":"[MENU] - GESTION MIS TURNOS","type":"main","index":0}]]},"ğŸ©» ESPECIALIDADES1":{"main":[[{"node":"ESPECIALIDADES1","type":"main","index":0}]]},"Get_Especialidades1":{"main":[[{"node":"LISTA_ESPECIALIDADES_BLOQUES","type":"main","index":0}]]},"LISTA_ESPECIALIDADES_BLOQUES":{"main":[[{"node":"ğŸ©» ESPECIALIDADES1","type":"main","index":0}]]},"get_medicos2":{"main":[[{"node":"LISTA_MEDICOS","type":"main","index":0}]]},"ğŸ©º MEDICOS2":{"main":[[{"node":"If2","type":"main","index":0}]]},"LISTA_MEDICOS":{"main":[[{"node":"Medicos2","type":"main","index":0}]]},"Medicos2":{"main":[[{"node":"ğŸ©º MEDICOS2","type":"main","index":0}]]},"ğŸ“… Horarios Proximos":{"main":[[{"node":"ğŸ• LISTA-HORARIOS","type":"main","index":0}]]},"ğŸ• Fechas disponibles ":{"main":[[{"node":"ğŸ©º FECHA","type":"main","index":0}]]},"ğŸ• LISTA-HORARIOS":{"main":[[{"node":"ğŸ• Fechas disponibles ","type":"main","index":0}]]},"Parsear Redis":{"main":[[{"node":"msg_clasificador","type":"main","index":0}]]},"Preparar Redis":{"main":[[{"node":"ğŸ”€ ROUTER PRINCIPAL","type":"main","index":0}]]},"Entrada":{"main":[[{"node":"Variables","type":"main","index":0}]]},"msg1":{"main":[[{"node":"[MENU] - TURNOS","type":"main","index":0}]]},"[MENU] - GESTION MIS TURNOS":{"main":[[{"node":"STATUS:MENU=1","type":"main","index":0}]]},"[MENU] - TURNOS":{"main":[[{"node":"STATUS:MENU=","type":"main","index":0}]]},"ğŸ”€ ROUTER PRINCIPAL":{"main":[[{"node":"obra_social1","type":"main","index":0}],[{"node":"ğŸ“± Mensaje Menu Principal","type":"main","index":0}],[{"node":"ğŸ“… Turnos - PACIENTE NUEVO - PACIENTE REGISTRADO - ","type":"main","index":0}],[{"node":"ğŸ“± Mensaje Info General","type":"main","index":0}],[{"node":"ğŸ¢ AdministraciÃ³n","type":"main","index":0}],[{"node":"ETIQUETA CONSULTA-RECLAMO","type":"main","index":0}],[{"node":"ğŸ”€ SWITCH GESTIÃ“N TURNOS","type":"main","index":0}],[{"node":"ğŸ”€ SWITCH DATOS PACIENTE","type":"main","index":0}],[],[{"node":"Code","type":"main","index":0}]]},"SWITCH: Tipo MenÃº Tomar Turno":{"main":[[{"node":"msg","type":"main","index":0}],[{"node":"msg1","type":"main","index":0}]]},"Code2":{"main":[[{"node":"Datos para confirmar turno","type":"main","index":0}]]},"MATRICULA":{"main":[[{"node":"Code2","type":"main","index":0}]]},"ğŸ“… Confirmar turno":{"main":[[{"node":"DATOS_COMBINADOS","type":"main","index":0}]]},"DATOS_PACIENTE":{"main":[[{"node":"MATRICULA","type":"main","index":0}]]},"Redis2":{"main":[[{"node":"DATOS_TURNO_PACIENTE","type":"main","index":0}]]},"ğŸ©º FECHA":{"main":[[{"node":"PACIENTE_MEDICO_MATRICULA","type":"main","index":0}]]},"PREPARAR_CONFIRMAR_TURNO":{"main":[[{"node":"DATOS_PACIENTE","type":"main","index":0}]]},"ğŸ”€ SWITCH GESTIÃ“N TURNOS":{"main":[[{"node":"ğŸ« Router GestiÃ³n Turnos","type":"main","index":0}],[{"node":"PACIENTE REGISTRADO1","type":"main","index":0}],[{"node":"SWITCH: Tipo MenÃº Tomar Turno","type":"main","index":0}],[],[{"node":"Get_Especialidades1","type":"main","index":0}],[{"node":"TURNOS ESTUDIO","type":"main","index":0}],[{"node":"Get_Especialidades1","type":"main","index":0}],[{"node":"get_medicos2","type":"main","index":0}],[{"node":"get_medicos2","type":"main","index":0}],[{"node":"GET_PACIENTE_REGISTRADO","type":"main","index":0}],[{"node":"datos","type":"main","index":0}],[{"node":"Datos para confirmar turno1","type":"main","index":0}],[{"node":"Redis3","type":"main","index":0}],[{"node":"DATOS_PACIENTE1","type":"main","index":0}],[{"node":"GET_PACIENTE1","type":"main","index":0}]]},"Datos para confirmar turno1":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"EJECUTAR TURNO":{"main":[[{"node":"DATOS","type":"main","index":0}]]},"datos":{"main":[[{"node":"DATOS_PACIENTE_REGISTRADO","type":"main","index":0}]]},"DATOS_PACIENTE_REGISTRADO":{"main":[[{"node":"ğŸ“… Confirmar turno","type":"main","index":0}]]},"DATOS_COMBINADOS":{"main":[[{"node":"Redis2","type":"main","index":0}]]},"GET_PACIENTE_REGISTRADO":{"main":[[{"node":"dni","type":"main","index":0}]]},"get_turnos_agendados1":{"main":[[{"node":"datos1","type":"main","index":0}]]},"datos1":{"main":[[{"node":"ğŸš« CANCELAR TURNO","type":"main","index":0}]]},"MIS TURNOS1":{"main":[[{"node":"Datos turnos","type":"main","index":0}]]},"ğŸš« CANCELAR TURNO":{"main":[[{"node":"MIS TURNOS1","type":"main","index":0}]]},"Datos turnos":{"main":[[{"node":"STATUS=CANCELAR-TURNO","type":"main","index":0}]]},"DATOS_PACIENTE1":{"main":[[{"node":"get_turnos_agendados1","type":"main","index":0}]]},"DELETE_TURNO":{"main":[[{"node":"Code4","type":"main","index":0}]]},"Redis3":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Code4":{"main":[[{"node":"DELETE - STATUS MENU2","type":"main","index":0}]]},"OpenRouter Chat Model2":{"ai_languageModel":[[{"node":"AI Agent1","type":"ai_languageModel","index":0}]]},"obrasociales":{"main":[[{"node":"Code6","type":"main","index":0}]]},"Code6":{"main":[[{"node":"AI Agent1","type":"main","index":0}]]},"âœ… DATOS VALIDADOS3":{"main":[[{"node":"ğŸ¤– RESET AGENTE","type":"main","index":0}]]},"ğŸ¤– RESET AGENTE":{"main":[[{"node":"DATOS_PACIENTE REGISTRADO","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"Structured Output Parser","type":"ai_languageModel","index":0}]]},"POST_PACIENTE":{"main":[[{"node":"error servidor","type":"main","index":0}]]},"DATOS_PACIENTE REGISTRADO":{"main":[[{"node":"STATUS=PACIENTE_NUEVO","type":"main","index":0}]]},"Error informacion de usuario1":{"main":[[{"node":"âš ï¸ DATOS INCORRECTOS1","type":"main","index":0}],[{"node":"POST_PACIENTE","type":"main","index":0}]]},"âš ï¸ DATOS INCORRECTOS1":{"main":[[{"node":"STATUS=PACIENTE_NUEVO1","type":"main","index":0}]]},"AI Agent1":{"main":[[{"node":"Error informacion de usuario1","type":"main","index":0}]]},"Structured Output Parser":{"ai_outputParser":[[{"node":"AI Agent1","type":"ai_outputParser","index":0}]]},"Redis Chat Memory1":{"ai_memory":[[{"node":"AI Agent1","type":"ai_memory","index":0}]]},"no_encontrado?":{"main":[[{"node":"âš ï¸ DATOS INCORRECTOS2","type":"main","index":0}],[{"node":"âœ… DATOS VALIDADOS","type":"main","index":0}]]},"âš ï¸ DATOS INCORRECTOS2":{"main":[[{"node":"DATO_INCORRECTO1","type":"main","index":0}]]},"PACIENTE":{"main":[[{"node":"ğŸ” Get Estado Actual","type":"main","index":0}]]},"get_turnos_agendados2":{"main":[[{"node":"datos3","type":"main","index":0}],[{"node":"âš ï¸ DATOS INCORRECTOS3","type":"main","index":0}]]},"datos3":{"main":[[{"node":"ğŸ“‹ LISTAR TURNOS1","type":"main","index":0}]]},"ğŸ“‹ LISTAR TURNOS1":{"main":[[{"node":"MIS TURNOS2","type":"main","index":0}]]},"GET_PACIENTE1":{"main":[[{"node":"get_turnos_agendados2","type":"main","index":0}]]},"error servidor":{"main":[[],[{"node":"âœ… DATOS VALIDADOS3","type":"main","index":0}]]},"If2":{"main":[[],[{"node":"ğŸ©º ESPECIALIDADES","type":"main","index":0}]]},"ESPECIALIDAD":{"main":[[{"node":"PACIENTE","type":"main","index":0}]]},"PACIENTE_MEDICO_MATRICULA":{"main":[[{"node":"DATOS_TURNO_PACIENTE1","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"EJECUTAR TURNO","type":"main","index":0}]]},"dni":{"main":[[{"node":"ğŸ“… Horarios Proximos","type":"main","index":0}]]},"Code1":{"main":[[{"node":"DELETE_TURNO","type":"main","index":0}]]},"Code":{"main":[[{"node":"ğŸ”€ SWITCH INFO FLUJOS","type":"main","index":0}]]},"Medicos":{"main":[[{"node":"â±ï¸ STATUS PRIMERA VEZ1","type":"main","index":0}]]},"Other":{"main":[[{"node":"â±ï¸ STATUS PRIMERA VEZ4","type":"main","index":0}]]},"ES_DIRECTO":{"main":[[{"node":"Other","type":"main","index":0}],[{"node":"Medicos","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","timezone":"America/Argentina/Buenos_Aires","callerPolicy":"workflowsFromSameOwner"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Entrada":[{"json":{"headers":{"host":"hooks.autoclinicas.com","user-agent":"rest-client/2.1.0 (linux-musl x86_64) ruby/3.4.4p34","content-length":"2187","accept":"application/json","accept-encoding":"gzip;q=1.0,deflate;q=0.6,identity;q=0.3","content-type":"application/json","x-forwarded-for":"206.81.1.93","x-forwarded-host":"hooks.autoclinicas.com","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"f2c799d0c305","x-real-ip":"206.81.1.93"},"params":{},"query":{},"body":{"additional_attributes":{},"can_reply":true,"channel":"Channel::Whatsapp","contact_inbox":{"id":11730,"contact_id":6099,"inbox_id":13,"source_id":"5492254596618","created_at":"2025-10-06T23:09:25.001Z","updated_at":"2025-10-06T23:09:25.001Z","hmac_verified":false,"pubsub_token":"72kqoh9Mvmbyd7NJRvsQTtnR"},"id":9364,"inbox_id":13,"messages":[{"id":143969,"content":"MENÃš PRINCIPAL","account_id":2,"inbox_id":13,"conversation_id":9364,"message_type":0,"created_at":1762845084,"updated_at":"2025-11-11T07:11:24.757Z","private":false,"status":"sent","source_id":"wamid.HBgNNTQ5MjI1NDU5NjYxOBUCABIYFjNFQjA2REM0RDU2NDhEQTAzMTI3OEIA","content_type":"text","content_attributes":{"in_reply_to_external_id":null,"in_reply_to":null},"sender_type":"Contact","sender_id":6099,"external_source_ids":{},"additional_attributes":{},"processed_message_content":"MENÃš PRINCIPAL","sentiment":{},"conversation":{"assignee_id":null,"unread_count":1,"last_activity_at":1762845084,"contact_inbox":{"source_id":"5492254596618"}},"sender":{"additional_attributes":{"city":"","country":"","description":"","company_name":"","country_code":"","social_profiles":{}},"custom_attributes":{},"email":null,"id":6099,"identifier":null,"name":"Fer  ğŸ¤– [SOPORTE]","phone_number":"+5492254596618","thumbnail":"","blocked":false,"type":"contact"}}],"labels":[],"meta":{"sender":{"additional_attributes":{"city":"","country":"","description":"","company_name":"","country_code":"","social_profiles":{}},"custom_attributes":{},"email":null,"id":6099,"identifier":null,"name":"Fer  ğŸ¤– [SOPORTE]","phone_number":"+5492254596618","thumbnail":"","blocked":false,"type":"contact"},"assignee":null,"team":{"id":1,"name":"recepcionistas"},"hmac_verified":false},"status":"open","custom_attributes":{"bot":false,"humano":false},"snoozed_until":null,"unread_count":1,"first_reply_created_at":"2025-10-30T14:47:53.240Z","priority":null,"waiting_since":1762839678,"agent_last_seen_at":1762845059,"contact_last_seen_at":0,"last_activity_at":1762845084,"timestamp":1762845084,"created_at":1761835670,"updated_at":1762845084.7624588,"applied_sla":null,"sla_events":[],"sla_policy_id":null,"event":"automation_event.message_created"},"webhookUrl":"https://hooks.autoclinicas.com/webhook/agentes/v1/iclp","executionMode":"production"}}]},"versionId":"45e69b5a-276e-4309-9381-f966ad60da42","triggerCount":1,"shared":[{"createdAt":"2025-10-31T00:56:08.910Z","updatedAt":"2025-10-31T00:56:08.910Z","role":"workflow:owner","workflowId":"OS36euVHJzE0aOw6","projectId":"R66ikVn5xqf0nYcA"}],"tags":[{"createdAt":"2025-10-18T05:48:24.047Z","updatedAt":"2025-10-18T05:48:24.047Z","id":"9MPkCQDvT4HFCUIK","name":"ClinicAI-v1.33"}]}