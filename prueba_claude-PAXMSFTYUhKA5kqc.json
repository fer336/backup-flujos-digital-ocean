{"createdAt":"2025-08-18T01:37:48.280Z","updatedAt":"2025-09-07T14:25:00.572Z","id":"PAXMSFTYUhKA5kqc","name":"Prueba_Claude","active":false,"isArchived":false,"nodes":[{"parameters":{"databaseId":256795,"tableId":606371,"returnAll":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Return_All', `Devuelve la matricula del medico que pidio el paciente\n\nSi no pidio un doctor en especifico, devuelve una lista de medicos con esa especialidad y su matricula`, 'boolean') }}","additionalOptions":{}},"type":"n8n-nodes-base.baserowTool","typeVersion":1,"position":[-3804,760],"id":"83c1342f-5d2c-455f-ab36-f3bc5cbbee76","name":"obtener_medicos_matricula","credentials":{"baserowApi":{"id":"ZpGSFHDmV88Zga8O","name":"Baserow account"}}},{"parameters":{"databaseId":256795,"tableId":606737,"returnAll":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Return_All', `Devuelve solo el campo 'Estudio'\n\nEsto nos dara informacion sobre los estudios que realiza el instituto`, 'boolean') }}","additionalOptions":{}},"type":"n8n-nodes-base.baserowTool","typeVersion":1,"position":[-3684,760],"id":"e8762b84-f216-47eb-bda2-f7098128d966","name":"obtener_estudios","credentials":{"baserowApi":{"id":"ZpGSFHDmV88Zga8O","name":"Baserow account"}}},{"parameters":{"description":"Llama a este subflujo cuando se necesita saber los horarios disponibles de un medico","workflowId":{"__rl":true,"value":"kmoVJGP4RL3PTi16","mode":"list","cachedResultName":"Turno-medico-mas-proximo"},"workflowInputs":{"mappingMode":"defineBelow","value":{"matricula":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('matricula', `Matricula del medico encontrada desde obtener_medicos_especialidades o pgvector\n\nEs unicamente un dato de tipo NUMBER`, 'number') }}","dni":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('dni', `DNI o cedula de identidad provista por el paciente\n\nEjemplo: 42028075`, 'number') }}","fechaDesde":"={{ DateTime.now().setZone('America/Argentina/Buenos_Aires').toFormat('yyyyMMdd') }}"},"matchingColumns":["matricula"],"schema":[{"id":"matricula","displayName":"matricula","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"fechaDesde","displayName":"fechaDesde","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[-3564,760],"id":"1782178c-5b9a-4101-84dd-8ee1515d52f1","name":"horarios_medicos_disponibles"},{"parameters":{"description":"Confirma un turno mÃ©dico para el paciente. Requiere DNI, matrÃ­cula del mÃ©dico, fecha y hora. Convierte automÃ¡ticamente los formatos de fecha (a timestamp) y hora (a HHMM) para la API.","workflowId":{"__rl":true,"value":"H4tsNj9SnsCxET4y","mode":"list","cachedResultName":"ICLP - Subflujo_Tomar_Turno"},"workflowInputs":{"mappingMode":"defineBelow","value":{"dni":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('dni', `Documento/DNI proporcionado por el paciente`, 'number') }}","matricula":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('matricula', `matricula del medico que va a obtener el turno`, 'number') }}","fecha":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fecha', `El dia que el paciente quiere el turno`, 'string') }}","hora":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('hora', `La hora que el paciente quiere el turno`, 'string') }}","nombre_completo":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('nombre_completo', `Nombre y apellido completo del paciente proporcionado por el usuario en la conversaciÃ³n. DEBE ser especÃ­fico, NO usar nombres genÃ©ricos como 'Paciente'. Ejemplo: 'Juan Carlos PÃ©rez'`, 'string') }}","obra_social":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('obra_social', `Obra social del paciente si la tiene, o 'particular' si no tiene obra social. Ejemplo: 'OSDE', 'Swiss Medical', 'particular'`, 'string') }}"},"matchingColumns":[],"schema":[{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"fecha","displayName":"fecha","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"matricula","displayName":"matricula","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"hora","displayName":"hora","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"nombre_completo","displayName":"nombre_completo","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"obra_social","displayName":"obra_social","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[-3444,760],"id":"c827c878-6ccf-4ac0-9ec3-c04f7cf3eb60","name":"tomar_turno_paciente"},{"parameters":{"promptType":"define","text":"=Mensaje del Paciente: {{ $('variables').item.json.message }} \n\nIntenciÃ³n del Paciente: {{ $json.intencionNormalizada }}","options":{"systemMessage":"=Eres el Asistente MÃ©dico Digital del Instituto de CardiologÃ­a La Plata (ICLP), un sistema experto en la gestiÃ³n de citas mÃ©dicas.\n\n## HOY ES: {{ $now.setLocale('es').toFormat(\"cccc, dd/MM/yyyy TT\") }}\n\n**PERSONALIDAD**: Profesional, resolutivo, empÃ¡tico. Usas el voseo argentino.\n\n---\n\n## 1. CONTEXTO OPERATIVO Y LÃMITES CRÃTICOS\n\n* **UbicaciÃ³n:** Calle 6 Nro. 212, La Plata (entre 36 y 37).\n* **Horario Instituto:** Lunes a Viernes 8:00-20:00hs / SÃ¡bado 8:00 - 13:00hs.\n* **Contacto:** TelÃ©fono (0221) 4906310. Para recetas y estudios, el interno es 29.\n* **Recetas:** El email es recetas@iclpsrl.com.ar. ExcepciÃ³n: Las recetas del Dr. FabiÃ¡n Barba se piden por WhatsApp al 2216810260.\n* **Pagina oficial:** https://www.iclp.com.ar/ y para turnos: https://www.iclp.com.ar/turnos\n* **PORTAL PACIENTES:** \n- Ingresar a www.iclp.com.ar\n- Ir a PORTAL PACIENTES\n- Ingresar con el documento del paciente y la contraseÃ±a (siempre es p + los 5 Ãºltimos nÃºmeros del DNI)\nEjemplo:\nDNI: 123456\nCONTRASEÃ‘A: p23456\n* **PARA VER LOS ESTUDIOS CARGADOS O SUBIDOS NECESITAN IR AL PORTAL PACIENTES**\n* **Si el paciente pide por \nMarcapasos o Electrofisiologia\nBARBA FABIAN y ARREGUI VICTOR\n\nEspecialista en Arritmias\nBARBA FABIAN**\n\n\n\n### **NO PUEDES (REGLAS INDISCUTIBLES):**\n-   **NUNCA agendar/confirmar turnos para ESTUDIOS** (Holter, MAPA, ErgometrÃ­a, ecografÃ­as, etc.).\n-   **NUNCA** dar consejos mÃ©dicos, diagnÃ³sticos ni prescribir.\n-   **NUNCA** dar precios o valores de consultas o estudios.\n-   **Urgencias:** Si detectas palabras como \"dolor de pecho\", \"infarto\", \"ACV\", \"emergencia\", responde INMEDIATAMENTE: \"Para urgencias mÃ©dicas, llamÃ¡ al 107 o dirigite a la guardia mÃ¡s cercana. No puedo ayudarte por este medio.\" y no ejecutes ninguna otra herramienta.\n\n---\n\n## 2. SALUDO INICIAL - RESPUESTA EXACTA Y LITERAL\n\n**INSTRUCCIÃ“N CRÃTICA**: Cuando un paciente inicie la conversaciÃ³n (primer mensaje, saludo, \"hola\", etc.), tu respuesta debe ser EXACTAMENTE esta, COPIANDO LITERALMENTE cada lÃ­nea, emoji y formato:\n\n```\nGracias por comunicarte con Instituto de CardiologÃ­a La Plata â¤ï¸\nLEER CON ATENCION â€¼ï¸â€¼ï¸â€¼ï¸\n\nðŸ•› HORARIO DE ATENCION:  LUNES A VIERNES 8 A 20 HS\n\nðŸ“ PARA TURNOS INDICAR SI ES:\n    - *Turno para una Consulta MÃ©dica*\n    - *Turno para un Estudio*\n\nSi necesitÃ¡s una Consulta, decime la especialidad o el nombre del profesional y tu DNI.\nSi es para un Estudio, te derivarÃ© con una recepcionista para que te asista rapidamente.\n\nâ” Tambien te podemos ayudar a gestionar consultas mas comunes como:\n- *Â¿Donde envio mis recetas?* \n- *Â¿Cual es el horario de atenciÃ³n?* \n- *Â¿Que especialidades tienen?* \n- *Â¿Donde saco turno por la pagina web?*\n\n\nðŸš«ðŸš« NO RECIBIMOS LLAMADAS POR ESTE MEDIO ðŸš«ðŸš«\n```\n\n**NO MODIFIQUES NADA**: No agregues emojis adicionales, no cambies el formato, no reformules. USA ESTE TEXTO EXACTO.\n\n---\n\n## 3. FLUJOS DE ACCIÃ“N PRINCIPALES\n\n###  **REGLA DE ORO: Â¡PENSAR PRIMERO!**\nAntes de cualquier flujo, ejecuta una reflexiÃ³n interna (usa `tool_think`) para analizar el mensaje del usuario y planificar los pasos a seguir segÃºn los flujos descritos a continuaciÃ³n.\n\n### TAREA: AGENDAR TURNO DE CONSULTA (POR ESPECIALIDAD)\n1.  **VALIDAR PACIENTE**: Ejecuta `Flujo_padron` para asegurar que el paciente estÃ© registrado.\n2.  **OBTENER CÃ“DIGO**: El usuario pide \"CardiologÃ­a\". Ejecuta `obtener_medicos_especialidades(especialidad: \"Cardiologia\")` para obtener la lista de mÃ©dicos y el **cÃ³digo interno** de la especialidad (ej: \"CAR\").\n3.  **BUSCAR DISPONIBILIDAD**: Con el cÃ³digo, ejecuta `horarios_especialidad_disponibles(especialidad: \"CAR\", dni: \"...\")`.\n4.  **PRESENTAR OPCIONES**: Muestra al paciente las 2-3 primeras opciones (MÃ©dico, fecha, hora).\n5.  **RECOPILAR DATOS COMPLETOS**: **ANTES** de agendar, SIEMPRE solicita y confirma los siguientes datos obligatorios:\n    - **Nombre y apellido completo del paciente**\n    - **DNI** (ya deberÃ­as tenerlo, pero confirmalo)\n    - **Obra Social** (si tiene, o aclarar \"particular\")\n    \n    **NUNCA** proceder con `tomar_turno_paciente` hasta tener estos datos completos y confirmados por el paciente.\n6.  **CONFIRMAR Y AGENDAR**: Una vez que el paciente confirma la opciÃ³n Y proporciona todos los datos, obtÃ©n la matrÃ­cula del mÃ©dico con `obtener_medicos_matricula` y luego ejecuta `tomar_turno_paciente` con todos los datos completos.\n6.  **COMUNICAR Ã‰XITO**: Informa el turno confirmado con todos los detalles como: \n*Turno confirmado* âœ…\n- Paciente: {nombre_completo_del_paciente}\n- MÃ©dico: {nombre_del_doctor}\n- Especialidad: {especialidad_del_medico}\n- â Fecha: {fecha_del_turno}\n- â Hora: {hora_del_turno}\n- Direccion : Calle 6 Nro.212 - Entre Calles 36 y 37\n\nPor favor, asistir 15 minutos antes del horario de tu turno al instituto. \n\nMuchas Gracias! â¤ï¸\n\n###  TAREA: AGENDAR TURNO DE CONSULTA (POR MÃ‰DICO)\n1.  **VALIDAR PACIENTE**: Ejecuta `Flujo_padron`.\n2.  **OBTENER MATRÃCULA**: El usuario pide \"Dr. Barba\". Ejecuta `obtener_medicos_matricula(nombre: \"FabiÃ¡n Barba\")` para obtener su matrÃ­cula (ej: 112218).\n3.  **BUSCAR DISPONIBILIDAD**: Con la matrÃ­cula, ejecuta `horarios_medicos_disponibles(matricula: \"112218\", dni: \"...\")`.\n4.  **PRESENTAR OPCIONES**: Informa el primer horario disponible y preguntÃ¡ si desea tomarlo.\n5.  **RECOPILAR DATOS COMPLETOS**: **ANTES** de agendar, SIEMPRE solicita y confirma los siguientes datos obligatorios:\n    - **Nombre y apellido completo del paciente**\n    - **DNI** (ya deberÃ­as tenerlo, pero confirmalo)\n    - **Obra Social** (si tiene, o aclarar \"particular\")\n  \n    **NUNCA** proceder con `tomar_turno_paciente` hasta tener estos datos completos y confirmados por el paciente.\n6.  **CONFIRMAR Y AGENDAR**: Si el paciente acepta Y proporciona todos los datos, ejecuta `tomar_turno_paciente` con la informaciÃ³n completa.\n7.  **COMUNICAR Ã‰XITO**: Informa el turno confirmado.\n\n###  TAREA: CANCELAR TURNO\n1.  **OBTENER TURNOS**: Pregunta el DNI si no lo tenÃ©s. Ejecuta `Lista_Turnos(dni: \"...\")`.\n2.  **CONFIRMAR CON USUARIO**: Muestra la lista de turnos y preguntÃ¡ cuÃ¡l desea cancelar.\n3.  **EJECUTAR CANCELACIÃ“N**: Una vez que el usuario confirma, ejecuta `eliminar_Turno` con los datos exactos del turno seleccionado (matrÃ­cula, fecha yyyyMMdd, hora HHmm).\n4.  **COMUNICAR Ã‰XITO**: Informa que el turno fue cancelado.\n\n###  TAREA: REPROGRAMAR TURNO\n1.  **OBTENER TURNOS**: Ejecuta `Lista_Turnos(dni: \"...\")` para saber quÃ© turno quiere cambiar.\n2.  **LÃ“GICA DE CONTEXTO**:\n    * Si el usuario pide cambiar solo la hora de un turno reciÃ©n agendado, mantenÃ© la fecha.\n    * Si no hay contexto, preguntÃ¡ la nueva fecha y hora deseadas.\n3.  **VERIFICAR DISPONIBILIDAD**: Usa `horarios_medicos_disponibles` o `horarios_especialidad_disponibles` para validar que el nuevo horario estÃ© libre. **Â¡NUNCA REPROGRAMES SIN VERIFICAR ANTES!**\n4.  **EJECUTAR REPROGRAMACIÃ“N**: Si estÃ¡ disponible, ejecuta `reprogramar_Turno` con todos los datos (dni, matricula, fechaAnterior, horaAnterior, fechaNueva, horaNueva).\n5.  **COMUNICAR Ã‰XITO**: Informa el nuevo turno confirmado. Si no hay disponibilidad, ofrece alternativas.\n\n###  TAREA: GESTIONAR TURNO DE ESTUDIO (DERIVACIÃ“N)\n1.  **DETECTAR INTENCIÃ“N**: Si el usuario confirma que necesita un turno para un **ESTUDIO**.\n2.  **NO USAR HERRAMIENTAS DE AGENDA**: No llames a `horarios_*` ni `tomar_turno_paciente`.\n3.  **EJECUTAR DERIVACIÃ“N**: Llama al subflujo `llamaToolStudios` que se encarga de asignar a un humano.\n\n\n---\n\n## 4. HERRAMIENTAS DISPONIBLES (ICLP)\n\n* `Flujo_padron`: Valida/registra pacientes.\n* `obtener_medicos_especialidades`: Obtiene mÃ©dicos y **cÃ³digo de especialidad**.\n* `obtener_medicos_matricula`: Obtiene la **matrÃ­cula** de un mÃ©dico.\n* `horarios_especialidad_disponibles`: Busca turnos por **cÃ³digo de especialidad**.\n* `horarios_medicos_disponibles`: Busca turnos por **matrÃ­cula de mÃ©dico**.\n* `tomar_turno_paciente`: Agenda una nueva cita.\n* `Lista_Turnos`: Muestra los turnos activos de un paciente.\n* `eliminar_Turno`: Cancela una cita.\n* `reprogramar_Turno`: Cambia fecha/hora de una cita.\n* `llamaToolStudios`: Dispara el flujo para derivar a un humano.\n\n---\n\n## 5. REGLAS CRÃTICAS Y VALIDACIÃ“N ANTES DE RESPONDER\n\nAntes de cada respuesta, revisÃ¡ mentalmente esta lista de autoevaluaciÃ³n:\n\nâœ“  CRÃTICO: Â¿EjecutÃ© la reflexiÃ³n interna (usa `tool_think`) PRIMERO antes que cualquier otra acciÃ³n? (OBLIGATORIO - SIN EXCEPCIONES).\nâœ“ Â¿La intenciÃ³n es para un ESTUDIO? Si es asÃ­, seguir el flujo de derivaciÃ³n y no intentar agendar.\nâœ“ Â¿Tengo todos los datos necesarios del paciente (especialmente el DNI, nombre completo y obra social)?\nâœ“ Si el usuario pide valores de turnos, estudios, o sobre valor/precio de la consulta medica: Dile que solo sos un chatbot configurado para ayudar a gestionar consultas o turnos, que no tenes la informaciÃ³n sobre eso.\nâœ“ Â¿VerifiquÃ© la disponibilidad con horarios_medicos_disponibles o horarios_especialidad_disponibles antes de confirmar o reprogramar? (Â¡Obligatorio!).\nâœ“ Â¿Estoy usando la herramienta correcta para la tarea correcta? (Ej: horarios_especialidad_disponibles necesita un CÃ“DIGO, no un nombre).\nâœ“ Â¿RevisÃ© la fecha actual para interpretar correctamente \"maÃ±ana\" o \"prÃ³ximo jueves\" y para no agendar en dÃ­as no laborales?\nâœ“ Â¿Estoy por dar un precio, un diagnÃ³stico o agendar un estudio? (Â¡PROHIBIDO!).","maxIterations":10}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2,"position":[-3352,540],"id":"a3cc9693-16f4-47d7-992d-abcc7553acd7","name":"Agente conversacional"},{"parameters":{"jsCode":"const textoOriginal = $json.output || \"\";\n\n// FILTRO CRÃTICO: Eliminar prioridades internas antes de mostrar al paciente\nlet textoFiltrado = textoOriginal\n  // Eliminar lÃ­neas completas que contengan prioridades\n  .replace(/^.*Prioridad\\s*[123].*:.*$/gm, '')\n  .replace(/^.*Sin Prioridad.*\\(S\\/P\\).*:.*$/gm, '')\n  .replace(/^.*S\\/P.*:.*$/gm, '')\n  // Eliminar texto especÃ­fico de prioridades\n  .replace(/Prioridad\\s*[123]\\s*:/gi, '')\n  .replace(/Sin\\s*Prioridad\\s*\\(S\\/P\\)\\s*:/gi, '')\n  .replace(/S\\/P\\s*:/gi, '')\n  // Limpiar saltos de lÃ­nea mÃºltiples excesivos (mÃ¡s de 3)\n  .replace(/\\n{4,}/g, '\\n\\n\\n')\n  .trim();\n\n// Aplicar limpieza mÃ­nima para WhatsApp\nconst limpio = textoFiltrado\n  // Convertir ** a * para negrita de WhatsApp\n  .replace(/\\*\\*([^*]+)\\*\\*/g, '*$1*')\n  \n  // Convertir bullets markdown a bullets de WhatsApp\n  .replace(/^[-]\\s+/gm, 'â€¢ ')\n  \n  // IMPORTANTE: Preservar saltos de lÃ­nea y espacios\n  // NO eliminar saltos de lÃ­nea simples\n  // NO comprimir espacios despuÃ©s de puntuaciÃ³n\n  \n  // Solo limpiar espacios mÃºltiples horizontales (no verticales)\n  .replace(/[ \\t]{2,}/g, ' ')\n  \n  // Eliminar espacios al final de cada lÃ­nea\n  .replace(/[ \\t]+$/gm, '')\n  \n  .trim();\n\n// Si el mensaje queda vacÃ­o, usar el original\nconst mensajeFinal = limpio.length > 0 ? limpio : textoOriginal.trim();\n\nreturn [{\n  json: {\n    texto_limpio: mensajeFinal\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-2404,540],"id":"7d92a94e-8293-4107-a415-888e001766e7","name":"Code"},{"parameters":{"method":"POST","url":"=https://chatw.automatizaciones.ai/api/v1/accounts/{{ $('variables').item.json.accountId }}/conversations/{{ $('variables').item.json.conversationId }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"rgqHjdPeBQpVpzt2iDR2RKLp"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"content","value":"={{ $json.texto_limpio }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-2184,540],"id":"1b656ca8-4cf1-4a68-8d2d-67eae175c5e1","name":"SendText"},{"parameters":{"modelName":"models/gemini-2.5-flash","options":{"temperature":0.1,"topP":0.5}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[-4652,710],"id":"36a54286-779b-4d09-a126-11aa60fdb51e","name":"LLM","credentials":{"googlePalmApi":{"id":"y4EbL32CeQSjDRft","name":"Google Gemini(PaLM) Api account"}}},{"parameters":{"sessionIdType":"customKey","sessionKey":"=chat:{{ $('variables').item.json.conversationId }}_iclp","sessionTTL":132800,"contextWindowLength":15},"type":"@n8n/n8n-nodes-langchain.memoryRedisChat","typeVersion":1.5,"position":[-3924,760],"id":"c78633a2-a6fa-4c2d-a57b-93ca4412d053","name":"MEMORY","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"toolDescription":"Permite cancelar un turno mÃ©dico existente. IMPORTANTE: Primero verificar con HTTP Lista_Turnos que el turno existe y estÃ¡ activo. Requiere la matrÃ­cula del mÃ©dico, la fecha (en formato YYYYMMDD, ej: '20250708') y la hora (en formato HHMM, ej: '1430') del turno a eliminar. Si el turno ya fue cancelado, informar al usuario.","method":"PUT","url":"http://iclp.ddns.net:7080/ws-turnos-rest-simple/api/turnos/eliminar-turno","sendQuery":true,"queryParameters":{"parameters":[{"name":"usuario","value":"WSTRRED"},{"name":"password","value":"Y2xpb25lcw"},{"name":"matricula","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters2_Value', `Matricula del medico, generalmente son 5 a 7 numeros. \nTe puedes guiar por parameters2_Value:\n111808\n`, 'string') }}"},{"name":"fecha","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters3_Value', `Es la fecha del turno\nTe puedes guiar por\nparameters3_Value:\n20250721`, 'string') }}"},{"name":"hora","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters4_Value', `Es la hora del turno te puedes guiar por\nparameters4_Value:\n1040`, 'string') }}"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"options":{"response":{"response":{"neverError":true,"responseFormat":"text","outputPropertyName":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Put_Output_in_Field', `Turno cancelado exitosamente\t\"OK\" (HTTP 200)\tâœ… \"OK\"\nTurno inexistente\t\"Turno inexistente.\" (HTTP 500)\tâœ… \"Turno inexistente.\"\nTurno ya cancelado\t\"El turno ya fue cancelado.\" (HTTP 500)\tâœ… \"El turno ya fue cancelado.\"\nError general\t\"Problema.\" (HTTP 500)\tâœ… \"Problema.\"`, 'string') }}"}},"timeout":30000}},"type":"n8n-nodes-base.httpRequestTool","typeVersion":4.2,"position":[-3324,760],"id":"cd0c8c3f-f9af-468e-8e23-b21da201d8d5","name":"eliminar_Turno","retryOnFail":true},{"parameters":{"httpMethod":"POST","path":"agentes/v1/iclp","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-5620,240],"id":"e12dd148-f00f-49da-8af9-38bc53421e30","name":"Webhook","webhookId":"ab81407a-fc2f-402c-8bd5-85a9551bde3e"},{"parameters":{"assignments":{"assignments":[{"id":"16d8fd1f-7293-45ec-ba41-6041979d7964","name":"accountId","value":"={{ $json.body.messages[0].account_id }}","type":"number"},{"id":"a8eb17ea-8fda-42e5-9f1c-444826a21e51","name":"message","value":"={{ $json.body.messages[0].content }}","type":"string"},{"id":"3fe92852-b569-426e-bef7-b755cf44ddc9","name":"inboxId","value":"={{ $json.body.contact_inbox.inbox_id }}","type":"number"},{"id":"96fa0ac2-a17b-452c-bf67-cc0f3bd5d4a2","name":"contactId","value":"={{ $json.body.messages[0].sender.id }}","type":"number"},{"id":"0d77d8b4-ec6d-42e0-8a5b-fdf1b78b454d","name":"contactName","value":"={{ $json.body.messages[0].sender.name }}","type":"string"},{"id":"25487cfb-897d-4000-9ad6-99745966c526","name":"contactNumber","value":"={{ $json.body.messages[0].sender.phone_number }}","type":"string"},{"id":"1e1b0044-b199-44e0-927b-c2cabe2a281b","name":"tokenChatwoot","value":"=rgqHjdPeBQpVpzt2iDR2RKLp","type":"string"},{"id":"ad5ef314-70d7-4790-b82e-ea96a340ae12","name":"chatwootUrlBase","value":"=https://chatw.automatizaciones.ai","type":"string"},{"id":"f4bc6964-862e-4168-8bae-94e6c6ad8321","name":"eventType","value":"={{ $json.body.event }}","type":"string"},{"id":"ef4c85e4-0029-4d70-ade1-0de74711b804","name":"conversationId","value":"={{ $json.body.id }}","type":"number"},{"id":"be91191b-7e8a-4406-af97-0a18e8100e7f","name":"multimedia","value":"={{ $json?.body?.messages?.[0]?.attachments?.[0]?.file_type ? true : false }}","type":"boolean"},{"id":"a3202993-c215-4502-bf56-e7e644b35a88","name":"humano","value":"={{ $json.body.custom_attributes.humano }}","type":"boolean"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-5400,340],"id":"11abeac2-a732-4621-8ff1-41dd5a00721f","name":"variables"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"0db9a125-ce45-48fe-b722-efbed0fc42a4","leftValue":"={{ $json.body.messages[0].sender.type }}","rightValue":"agent_bot","operator":{"type":"string","operation":"notEquals"}},{"id":"7d71d302-596d-4330-b68c-1b0502f6c7cd","leftValue":"={{ $json.body.event }}","rightValue":"message_created","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"12a51caa-5e4c-46f3-a067-79f0a52ca94b","leftValue":"={{ $json.body.messages[0].attachments[0].file_type }}","rightValue":"=file","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"or"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[-5180,340],"id":"d4c22459-4266-40a9-9c2e-db201d877e13","name":"Filter"},{"parameters":{"description":"Llama a este subflujo cuando se necesita saber los horarios disponibles de una especialidad","workflowId":{"__rl":true,"value":"9VbCzLdHQtztJk3X","mode":"list","cachedResultName":"Turno-especialidad-mas-proximo"},"workflowInputs":{"mappingMode":"defineBelow","value":{"especialidad":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('especialidad', `especialidad del medico encontrada desde obtener_medicos_especialidades o pgvector\n\nEs unicamente un dato de tipo 3 Caracteres como: CLI\nencontrada en la tabla \"codigo\"`, 'string') }}","dni":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('dni', `DNI o cedula de identidad provista por el paciente\n\nEjemplo: 42028075`, 'number') }}","fechaDesde":"={{ DateTime.now().setZone('America/Argentina/Buenos_Aires').toFormat('yyyyMMdd') }}"},"matchingColumns":[],"schema":[{"id":"especialidad","displayName":"especialidad","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"fechaDesde","displayName":"fechaDesde","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[-3204,760],"id":"7f53aab9-ac90-4346-90a7-2022ed4d6291","name":"horarios_especialidad_disponibles"},{"parameters":{"name":"Flujo_padron","description":"Verifica si un paciente estÃ¡ registrado en el padrÃ³n mÃ©dico mediante su DNI. Si no lo estÃ¡, permite empadronarlo enviando nombre completo, DNI, obra social y telÃ©fono. UsÃ¡ esta herramienta en cualquier momento en que necesites validar si el paciente ya existe en el sistema.","workflowId":{"__rl":true,"value":"gdiHQp4cbaJJhGdl","mode":"list","cachedResultName":"ICLP - Testing - Agente Padron"},"workflowInputs":{"mappingMode":"defineBelow","value":{"texto":"={{ $('variables').item.json.message }}","celular":"={{ $('variables').item.json.contactNumber }}","dni":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('dni', `Numero de documento de identidad del paciente\n\nPuede ser por ejemplo:\n42028075`, 'number') }}","paciente":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('paciente', `Nombre del paciente\n\nPuede ser por ejemplo:\nNicolas Lopez`, 'string') }}","obraSocial":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('obraSocial', `Obra social del paciente\n\nPuede ser por ejemplo:\nIOMA`, 'string') }}"},"matchingColumns":[],"schema":[{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"paciente","displayName":"paciente","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"texto","displayName":"texto","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"celular","displayName":"celular","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"obraSocial","displayName":"obraSocial","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.1,"position":[-3084,760],"id":"c5bf206b-abfd-4421-b300-dcf7d38e5bdc","name":"Flujo_padron"},{"parameters":{"databaseId":256795,"tableId":606371,"returnAll":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Return_All', `Devuelve la lista completa de los medicos segun la especialidad que pidio el paciente`, 'boolean') }}","additionalOptions":{"order":{"fields":[{"field":4918220}]}}},"type":"n8n-nodes-base.baserowTool","typeVersion":1,"position":[-2964,760],"id":"590192e8-7e18-48c9-bc83-456c910657af","name":"obtener_medicos_especialidades","credentials":{"baserowApi":{"id":"ZpGSFHDmV88Zga8O","name":"Baserow account"}}},{"parameters":{"toolDescription":"Reprograma un turno existente (dni, matricula, fechaAnterior, horaAnterior, fechaNueva, horaNueva)","method":"POST","url":"http://iclp.ddns.net:7080/ws-turnos-rest-simple/api/turnos/reprogramar-turno","sendQuery":true,"queryParameters":{"parameters":[{"name":"password","value":"Y2xpb25lcw"},{"name":"usuario","value":"WSTRRED"},{"name":"matricula","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters2_Value', `NÃºmero de matrÃ­cula del mÃ©dico asignado al turno`, 'string') }}"},{"name":"dni","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters3_Value', `Documento Nacional de Identidad del paciente sin puntos ni guiones.`, 'string') }}"},{"name":"fechaAnterior","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters4_Value', `Fecha original del turno a reprogramar, en formato numÃ©rico AAAAMMDD (ejemplo: 20250819).`, 'string') }}"},{"name":"horaAnterior","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters5_Value', `Hora original del turno en formato 24 horas, sin separadores (ejemplo: 0930).`, 'string') }}"},{"name":"fechaNueva","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters6_Value', `Nueva fecha deseada para el turno, en formato numÃ©rico AAAAMMDD`, 'string') }}"},{"name":"horaNueva","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters7_Value', `Nueva hora deseada para el turno en formato 24 horas, sin separadores (ejemplo: 1230).`, 'string') }}"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"options":{"response":{"response":{"neverError":true,"responseFormat":"json"}},"timeout":30000}},"type":"n8n-nodes-base.httpRequestTool","typeVersion":4.2,"position":[-2844,760],"id":"df629d8e-e24e-4618-9dab-de117746e3ac","name":"reprogramar_Turno","retryOnFail":true},{"parameters":{"toolDescription":"Lista los turnos actuales de un paciente por DNI.Si la fecha es 8/07/2025 transformarla a 20250708","url":"http://iclp.ddns.net:7080/ws-turnos-rest-simple/api/turnos/lista-turnos-actuales","sendQuery":true,"queryParameters":{"parameters":[{"name":"usuario","value":"=WSTRRED"},{"name":"password","value":"=Y2xpb25lcw"},{"name":"dni","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters2_Value', `Documento de identidad proporcionado por el paciente`, 'string') }}"},{"name":"fecha","value":"={{ $now.setZone('America/Argentina/Buenos_Aires').toFormat('yyyyLLdd') }}"}]},"options":{"response":{"response":{"neverError":true}},"timeout":30000},"optimizeResponse":true,"dataField":"lista","fieldsToInclude":"selected","fields":"fecha, fechaString, hora, hora5digitos, matricula, nombreMedico, estudios"},"type":"n8n-nodes-base.httpRequestTool","typeVersion":4.2,"position":[-2724,760],"id":"ec820a68-abbc-42b3-bf18-abcf3b522157","name":"Lista_Turnos","retryOnFail":true},{"parameters":{"assignments":{"assignments":[{"id":"b936cc1e-c8a5-4e63-8fb4-7cebac541b1c","name":"asunto","value":"={{ $json.text.split('|')[0].trim() }}","type":"string"},{"id":"ff857062-0bab-4152-afd4-e233cd6a5228","name":"intencion","value":"={{ $json.text.split('|')[1].trim() }}","type":"string"},{"id":"dfa8e24c-9700-425b-a266-ac74fad744c8","name":"DNI","value":"={{ $json.text.split('|')[2].trim() }}","type":"string"},{"id":"0f3cb05d-dcbc-4cb8-b433-3f99f0ba46dc","name":"Medico","value":"={{ $json.text.split('|')[3].trim() }}","type":"string"},{"id":"cf930d93-53cb-46a4-b0d8-1623047cd50d","name":"Especialidad","value":"={{ $json.text.split('|')[4].trim() }}","type":"string"},{"id":"20a9667d-5578-451e-ac06-8f43e626a31f","name":"Fecha","value":"={{ ($json.text.split('|')[5] && $json.text.split('|')[5].split(':')[1] && $json.text.split('|')[5].split(':')[1].trim() !== \"\" ? $json.text.split('|')[5].split(':')[1].trim().replace(/\\s{2,}/g, ' ') : \"Sin Destino\") }}","type":"string"},{"id":"3328ab2d-9f56-408d-aca6-90beadf22628","name":"Hora","value":"={{ ($json.text.split('|')[6] ? $json.text.split('|')[6] : \"Sin Origen Especificado\").trim().replace(/\\s{2,}/g, ' ').split(':')[1].trim() }}","type":"string"},{"id":"adfe1884-ccac-4f9a-b06b-24f919943e6d","name":"ArchivosAdjuntos","value":"={{ $json.text.split('|')[7].trim() }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-5620,900],"id":"bccc5fed-435f-4beb-8565-65b2936158d2","name":"salida","disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":false,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"6dcbb235-081a-408e-a17c-b6eecd664150","leftValue":"={{ $json.intencionNormalizada }}","rightValue":"turnos-estudios","operator":{"type":"string","operation":"equals"}},{"id":"75633605-352a-47b3-b870-7572fb978eec","leftValue":"={{ $json.tieneMultimedia }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"or"},"looseTypeValidation":true,"options":{"ignoreCase":true}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-4144,490],"id":"3e5c7ea2-17dc-488b-bfa7-3cfc30d5249b","name":"If"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a0f7b709-29f4-42af-bf55-29ee500f2c07","leftValue":"={{ $json.multimedia }}","rightValue":"file","operator":{"type":"boolean","operation":"true","singleValue":true}},{"id":"474975e7-e71c-42e3-8907-97884381d9e9","leftValue":"={{ $json.humano }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"or"},"options":{"ignoreCase":false}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-4960,340],"id":"e055b288-c2eb-411d-9e14-574db07a97b3","name":"tieneMultimedia"},{"parameters":{"workflowId":{"__rl":true,"value":"sJes6x6MKxKh7A0G","mode":"list","cachedResultName":"tipoEstudio Tool âš’ï¸âš’ï¸"},"workflowInputs":{"mappingMode":"defineBelow","value":{"accountId":"={{ $('variables').item.json.accountId }}","conversationId":"={{ $('variables').item.json.conversationId }}","contactId":"={{ $('variables').item.json.contactId }}","message":"={{ $('variables').item.json.message }}","inboxId":"={{ $('variables').item.json.inboxId }}","humano":"={{ $('variables').item.json.humano }}","chatwootUrlBase":"={{ $('variables').item.json.chatwootUrlBase }}","tokenChatwoot":"={{ $('variables').item.json.tokenChatwoot }}","tipoIntencion":"={{(() => {\n  if ($('Formateador').isExecuted) {\n    return $('Formateador').item.json.intencionNormalizada;\n  }\n  return 'turnos-estudios';\n})()}}"},"matchingColumns":[],"schema":[{"id":"accountId","displayName":"accountId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"conversationId","displayName":"conversationId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"contactId","displayName":"contactId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"message","displayName":"message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"inboxId","displayName":"inboxId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"humano","displayName":"humano","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"boolean","removed":false},{"id":"chatwootUrlBase","displayName":"chatwootUrlBase","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"tokenChatwoot","displayName":"tokenChatwoot","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"tipoIntencion","displayName":"tipoIntencion","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":true,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-2404,140],"id":"90a11fb2-c048-482f-9fb4-9a32c3bc5b77","name":"llamaToolStudios"},{"parameters":{"mode":"insert","messages":{"messageValues":[{"type":"user","message":"={{ $json.message ?? $('variables').item?.json?.message ?? '' }}"}]}},"type":"@n8n/n8n-nodes-langchain.memoryManager","typeVersion":1.1,"position":[-3352,40],"id":"0312e95c-31b4-49d6-a098-beb7ef7dd054","name":"Chat Memory Manager"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-4144,90],"id":"a431888b-9a7a-4da6-9579-e9186056f6b6","name":"noOp"},{"parameters":{"sessionIdType":"customKey","sessionKey":"=chat:{{ $('variables').item.json.conversationId }}_iclp","sessionTTL":132800,"contextWindowLength":15},"type":"@n8n/n8n-nodes-langchain.memoryRedisChat","typeVersion":1.5,"position":[-3264,260],"id":"4f3d02d7-a540-4e89-85bf-88c92f067ccb","name":"Redis Chat Memory","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{},"type":"@n8n/n8n-nodes-langchain.toolThink","typeVersion":1,"position":[-2604,760],"id":"5c8ab719-dfab-40cf-a095-fea315223007","name":"tool_think"},{"parameters":{"promptType":"define","text":"=mensaje_usuario: {{ $('variables').item.json.message }}\n","messages":{"messageValues":[{"message":"=# Sistema de ClasificaciÃ³n de Intenciones - ICLP WhatsApp\n\nEres un router de intenciÃ³n para WhatsApp del Instituto de CardiologÃ­a La Plata (ICLP). Tu funciÃ³n es clasificar la intenciÃ³n del mensaje, extraer datos clave y preservar el mensaje original.\n\n## DATOS DE CONTEXTO:\n- Nombre: {{ $('variables').item.json.contactName }}\n- NÃºmero: {{ $('variables').item.json.contactNumber }}\n- Conversation ID: {{ $('variables').item.json.conversationId }}\n- Mensaje del usuario: {{ $('variables').item.json.message }}\n\n## CATEGORÃAS DE INTENCIÃ“N (14 totales):\n\n### ðŸ¥ Turnos de Consultorio (3):\n1. **turnos-consultorio** - Solicita turno para consulta mÃ©dica con profesional\n2. **CANCELA_TURNO_CONSULTORIO** - Cancela turno de consultorio existente\n3. **REPROGRAMA_TURNO_CONSULTORIO** - Cambia fecha/hora de consulta mÃ©dica\n\n### ðŸ”¬ Turnos de Estudios (3):\n4. **turnos-estudios** - Solicita turno para estudio diagnÃ³stico\n5. **CANCELA_TURNO_ESTUDIO** - Cancela turno de estudio existente\n6. **REPROGRAMA_TURNO_ESTUDIO** - Cambia fecha/hora de estudio\n\n### â„¹ï¸ Solicitudes de InformaciÃ³n (3):\n7. **INFO_MEDICOS_ESPECIALIDADES** - Consulta sobre profesionales o especialidades\n8. **INFO_ESTUDIOS** - Pregunta quÃ© estudios realizan o informaciÃ³n sobre estudios\n9. **INFO_GENERAL** - Horarios, ubicaciÃ³n, telÃ©fonos, pÃ¡gina web, costos, obras sociales\n\n### ðŸš¨ Situaciones Especiales (5):\n10. **URGENCIA** - Emergencia mÃ©dica, sÃ­ntomas graves o dolor agudo\n11. **consultas-reclamos** - Expresa insatisfacciÃ³n, problema o queja \n12. **SALUDO_SMALLTALK** - Saludo, agradecimiento o charla casual\n13. **ARCHIVOS_ADJUNTOS** - EnvÃ­a documentos, imÃ¡genes o archivos\n14. **OTRO** - No encaja en ninguna categorÃ­a anterior\n\n## REGLAS DE CLASIFICACIÃ“N EXHAUSTIVAS:\n\n### ðŸ¥ turnos-consultorio:\n**Palabras clave:** turno, consulta, cita, ver al doctor, atenciÃ³n\n**Frases tÃ­picas:**\n- \"Necesito turno con [especialidad/mÃ©dico]\"\n- \"Quiero consulta con cardiÃ³logo\"\n- \"Puedo sacar turno con el Dr...\"\n- \"Hay turnos disponibles para...\"\n- \"Primera vez que voy\" + contexto mÃ©dico\n\n### âŒ CANCELA_TURNO_CONSULTORIO:\n**Palabras clave:** cancelar, anular, dar de baja, no voy a poder\n**Frases tÃ­picas:**\n- \"Cancelar turno con Dr. [nombre]\"\n- \"No puedo ir a mi consulta\"\n- \"Dar de baja el turno del [fecha]\"\n**Regla:** Si no especifica si es consulta o estudio â†’ asumir CONSULTORIO\n\n### ðŸ”„ REPROGRAMA_TURNO_CONSULTORIO:\n**Palabras clave:** cambiar, reprogramar, mover, postergar, adelantar\n**Frases tÃ­picas:**\n- \"Cambiar turno del [fecha]\"\n- \"Puedo pasar mi consulta para otro dÃ­a\"\n- \"Necesito reprogramar con el Dr...\"\n\n### ðŸ”¬ turnos-estudios:\n**Estudios comunes:** eco, ecocardiograma, eco doppler, holter, MAPA, ergometrÃ­a, electrocardiograma, ECG, prueba de esfuerzo, cateterismo\n**Frases tÃ­picas:**\n- \"Turno para holter\"\n- \"Necesito hacerme un eco\"\n- \"Tengo orden para ergometrÃ­a\"\n- \"Me mandaron a hacer un electrocardiograma\"\n\n### âŒ CANCELA_TURNO_ESTUDIO:\n**Identificadores:** Menciona estudio especÃ­fico + cancelar\n**Frases tÃ­picas:**\n- \"Cancelar el holter del martes\"\n- \"No voy a poder hacerme el eco\"\n- \"Anular turno de ergometrÃ­a\"\n\n### ðŸ”„ REPROGRAMA_TURNO_ESTUDIO:\n**Frases tÃ­picas:**\n- \"Cambiar fecha del eco doppler\"\n- \"Mover el turno del holter\"\n- \"Reprogramar mi ergometrÃ­a\"\n\n### â„¹ï¸ INFO_MEDICOS_ESPECIALIDADES:\n**Preguntas sobre:**\n- \"Â¿QuÃ© especialidades tienen?\"\n- \"Â¿Atiende el Dr. [nombre]?\"\n- \"Â¿Hay cardiÃ³logos?\"\n- \"Lista de mÃ©dicos\"\n- \"Â¿QuÃ© dÃ­as atiende [mÃ©dico]?\"\n\n### â„¹ï¸ INFO_ESTUDIOS:\n**Preguntas sobre:**\n- \"Â¿QuÃ© estudios hacen?\"\n- \"Â¿Hacen resonancias?\"\n- \"Â¿Realizan eco doppler?\"\n- \"InformaciÃ³n sobre el holter\"\n- \"Â¿En quÃ© consiste la ergometrÃ­a?\"\n\n### â„¹ï¸ INFO_GENERAL:\n**Preguntas sobre:**\n- Horarios de atenciÃ³n\n- DirecciÃ³n/ubicaciÃ³n\n- TelÃ©fonos de contacto\n- PÃ¡gina web\n- Obras sociales/prepagas aceptadas\n- Costos/precios (aunque no se pueden dar)\n- CÃ³mo sacar turno online\n- Recetas mÃ©dicas\n- PreparaciÃ³n para estudios\n\n### ðŸš¨ URGENCIA:\n**SÃ­ntomas de alerta:**\n- Dolor de pecho/opresiÃ³n\n- Falta de aire/ahogo\n- Desmayo/mareos severos\n- Palpitaciones fuertes\n- PresiÃ³n alta con sÃ­ntomas\n- \"Me siento muy mal\"\n- \"Es urgente\"/\"emergencia\"\n\n### ðŸ˜  consultas-reclamos:  \n**Indicadores:**\n- Tono de enojo o frustraciÃ³n\n- \"Es la tercera vez que...\"\n- \"Mala atenciÃ³n\"\n- \"Nadie me responde\"\n- \"Hace dÃ­as que espero\"\n- Referencias a problemas previos\n```\n\n### ðŸ‘‹ SALUDO_SMALLTALK:\n- Saludos: hola, buen dÃ­a, buenas tardes, buenas noches\n- Despedidas: gracias, hasta luego, chau\n- CortesÃ­a: por favor, disculpe\n- Sin contexto mÃ©dico adicional\n\n### ðŸ“Ž ARCHIVOS_ADJUNTOS:\n- Cuando el mensaje viene con archivos\n- \"EnvÃ­o mi orden mÃ©dica\"\n- \"Adjunto estudios\"\n- \"Mando foto de...\"\n\n## EXTRACCIÃ“N DE DATOS COMPLETA:\n\nExtraer TODOS estos campos si estÃ¡n presentes:\n- **Mensaje_Original**: El texto completo del usuario (SIEMPRE incluir)\n- **DNI**: 7-9 dÃ­gitos sin puntos (ej: 12345678)\n- **MÃ©dico**: Nombre del profesional mencionado\n- **Especialidad**: cardiologÃ­a, clÃ­nica mÃ©dica, etc.\n- **Fecha**: Convertir a yyyyMMdd (20240315 para 15 de marzo 2024)\n- **Hora**: Convertir a HHmm (1430 para 2:30 PM)\n- **DÃ­a_Semana**: lunes, martes, etc.\n- **Tipo_Estudio**: holter, eco, ergometrÃ­a, etc.\n- **Obra_Social**: IOMA, OSDE, particular, etc.\n- **TelÃ©fono**: Si proporciona nÃºmero de contacto\n- **Email**: Si proporciona correo\n- **Archivos**: Si/No\n\n## FORMATO DE SALIDA ESTRICTO:\n\n```\n[Mensaje original completo] | [Resumen en 3-5 palabras] | IntenciÃ³n:[CATEGORIA] | DNI:[valor o N/D] | Medico:[valor o N/D] | Especialidad:[valor o N/D] | Fecha:[yyyyMMdd o N/D] | Hora:[HHmm o N/D] | Dia:[valor o N/D] | Estudio:[valor o N/D] | ObraSocial:[valor o N/D] | Telefono:[valor o N/D] | Email:[valor o N/D] | Archivos:[Si/No]\n```\n\n## EJEMPLOS COMPLETOS:\n\n**Entrada:** \"Hola, buen dÃ­a\"\n**Salida:** `Hola, buen dÃ­a | Saludo cordial | IntenciÃ³n:SALUDO_SMALLTALK | DNI:N/D | Medico:N/D | Especialidad:N/D | Fecha:N/D | Hora:N/D | Dia:N/D | Estudio:N/D | ObraSocial:N/D | Telefono:N/D | Email:N/D | Archivos:No`\n\n**Entrada:** \"Necesito turno con cardiÃ³logo para la semana que viene, mi DNI es 25789456, tengo IOMA\"\n**Salida:** `Necesito turno con cardiÃ³logo para la semana que viene, mi DNI es 25789456, tengo IOMA | Solicita turno cardiologÃ­a | IntenciÃ³n:turnos-consultorio | DNI:25789456 | Medico:N/D | Especialidad:CardiologÃ­a | Fecha:N/D | Hora:N/D | Dia:N/D | Estudio:N/D | ObraSocial:IOMA | Telefono:N/D | Email:N/D | Archivos:No`\n\n**Entrada:** \"Quiero cancelar el eco doppler que tengo el viernes 20 a las 10:30\"\n**Salida:** `Quiero cancelar el eco doppler que tengo el viernes 20 a las 10:30 | Cancela estudio programado | IntenciÃ³n:CANCELA_TURNO_ESTUDIO | DNI:N/D | Medico:N/D | Especialidad:N/D | Fecha:20240320 | Hora:1030 | Dia:viernes | Estudio:Eco doppler | ObraSocial:N/D | Telefono:N/D | Email:N/D | Archivos:No`\n\n**Entrada:** \"Me duele mucho el pecho y me falta el aire, necesito ayuda\"\n**Salida:** `Me duele mucho el pecho y me falta el aire, necesito ayuda | Emergencia sÃ­ntomas cardÃ­acos | IntenciÃ³n:URGENCIA | DNI:N/D | Medico:N/D | Especialidad:N/D | Fecha:N/D | Hora:N/D | Dia:N/D | Estudio:N/D | ObraSocial:N/D | Telefono:N/D | Email:N/D | Archivos:No`\n\n**Entrada:** \"El Dr. FernÃ¡ndez me dijo que pida turno para holter de 24hs, mi obra social es OSDE 210\"\n**Salida:** `El Dr. FernÃ¡ndez me dijo que pida turno para holter de 24hs, mi obra social es OSDE 210 | Solicita holter por derivaciÃ³n | IntenciÃ³n:turnos-estudios | DNI:N/D | Medico:Dr. FernÃ¡ndez | Especialidad:N/D | Fecha:N/D | Hora:N/D | Dia:N/D | Estudio:Holter 24hs | ObraSocial:OSDE 210 | Telefono:N/D | Email:N/D | Archivos:No`\n\n**Entrada:** \"Â¿Atienden los sÃ¡bados? Â¿Hasta quÃ© hora?\"\n**Salida:** `Â¿Atienden los sÃ¡bados? Â¿Hasta quÃ© hora? | Consulta horarios sÃ¡bado | IntenciÃ³n:INFO_GENERAL | DNI:N/D | Medico:N/D | Especialidad:N/D | Fecha:N/D | Hora:N/D | Dia:sÃ¡bado | Estudio:N/D | ObraSocial:N/D | Telefono:N/D | Email:N/D | Archivos:No`\n\n## CASOS ESPECIALES Y AMBIGUOS:\n\n1. **\"Quiero un turno\"** (sin especificar) â†’ PREGUNTAR SI ES TURNO DE ESTUDIO O DE CONSULTA\n2. **\"Cancelar turno\"** (sin especificar) â†’ PREGUNTAR SI CANCELA TURNO DE ESTUDIO O DE CONSULTORIO\n3. **\"Para maÃ±ana\"** â†’ Calcular fecha del dÃ­a siguiente\n4. **\"La semana que viene\"** â†’ No calcular fecha especÃ­fica, dejar N/D\n5. **MÃºltiples intenciones** â†’ Elegir la PRINCIPAL\n6. **Mensaje confuso** â†’ OTRO\n7. **Pregunta de costo + turno** â†’ Priorizar TURNO sobre INFO\n\n## VALIDACIONES CRÃTICAS:\n\nâœ“ SIEMPRE incluir el mensaje original completo como primer campo\nâœ“ Usar EXACTAMENTE 14 campos separados por |\nâœ“ No inventar datos - usar N/D si no estÃ¡ presente\nâœ“ Fechas futuras en formato yyyyMMdd\nâœ“ Horas en formato 24h sin separadores\nâœ“ Una sola lÃ­nea de salida\nâœ“ Sin explicaciones adicionales\nâœ“ CategorÃ­a debe ser una de las 14 definidas\n\n## REGLA FINAL ABSOLUTA:\nSi tienes duda entre dos categorÃ­as, usa esta jerarquÃ­a de prioridad:\n1. URGENCIA (siempre tiene prioridad mÃ¡xima)\n2. TURNOS (agendar/cancelar/reprogramar)\n3. INFORMACIÃ“N\n4. OTROS"}]},"batching":{}},"type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.7,"position":[-4740,490],"id":"561d4407-0236-4c1e-93ab-59e82ada75c7","name":"Analista de ConversaciÃ³n"},{"parameters":{"jsCode":"// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n// â”‚ ðŸ“¥ SECTION 1: INPUT PROCESSING                                             â”‚\n// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n\nconst rawInput = $json.text ?? $json.output ?? \"\";\nconst line = String(rawInput).trim();\n\nconst vars = (() => {\n  try {\n    const items = $items('variables', 0, 0);\n    if (!items || !items.length) return {};\n    const data = items[0]?.json;\n    return data && typeof data === 'object' ? data : {};\n  } catch (error) {\n    console.warn('âš ï¸ Variables context unavailable:', error.message);\n    return {};\n  }\n})();\n\nconst multimedia = (() => {\n  try {\n    const items = $items('tieneMultimedia', 0, 0);\n    if (!items || !items.length) return {};\n    const data = items[0]?.json;\n    return data && typeof data === 'object' ? data : {};\n  } catch (error) {\n    console.warn('âš ï¸ Multimedia context unavailable:', error.message);\n    return {};\n  }\n})();\n\n// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n// â”‚ ðŸ› ï¸ SECTION 2: CORE UTILITY FUNCTIONS                                       â”‚\n// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n\nfunction parseTokenMap(s) {\n  try {\n    if (!s || typeof s !== 'string') return { parts: [], map: {} };\n    \n    const parts = s.split(\"|\").map(p => String(p).trim()).filter(Boolean);\n    const map = {};\n    \n    for (const part of parts) {\n      const colonIndex = part.indexOf(\":\");\n      if (colonIndex > 0) {\n        const key = part.slice(0, colonIndex).trim().toLowerCase();\n        const value = part.slice(colonIndex + 1).trim();\n        if (key && value) {\n          map[key] = value;\n        }\n      }\n    }\n    \n    return { parts, map };\n  } catch (error) {\n    console.error('âŒ Error parsing token map:', error);\n    return { parts: [], map: {} };\n  }\n}\n\nfunction normalizeToNull(value) {\n  if (value === null || value === undefined) return null;\n  const str = String(value).trim();\n  if (!str || str.toUpperCase() === \"N/D\" || str === \"-\") return null;\n  return str;\n}\n\nfunction isValidDNI(dni) {\n  if (!dni) return false;\n  const cleaned = dni.replace(/[^\\d]/g, '');\n  return cleaned.length >= 7 && cleaned.length <= 9;\n}\n\nfunction isValidEmail(email) {\n  if (!email) return false;\n  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n  return emailRegex.test(email);\n}\n\nfunction isValidPhone(phone) {\n  if (!phone) return false;\n  const cleaned = phone.replace(/[^\\d]/g, '');\n  return cleaned.length >= 8 && cleaned.length <= 15;\n}\n\nfunction normalizeDate(dateStr) {\n  if (!dateStr) return null;\n  \n  try {\n    if (/^\\d{8}$/.test(dateStr)) return dateStr;\n    \n    const date = new Date(dateStr);\n    if (isNaN(date.getTime())) return null;\n    \n    const year = date.getFullYear();\n    const month = String(date.getMonth() + 1).padStart(2, '0');\n    const day = String(date.getDate()).padStart(2, '0');\n    \n    return `${year}${month}${day}`;\n  } catch {\n    return null;\n  }\n}\n\nfunction normalizeTime(timeStr) {\n  if (!timeStr) return null;\n  \n  try {\n    if (/^\\d{4}$/.test(timeStr)) return timeStr;\n    \n    const cleaned = timeStr.replace(/[^\\d:]/g, '');\n    const parts = cleaned.split(':');\n    \n    if (parts.length >= 2) {\n      const hours = parseInt(parts[0]);\n      const minutes = parseInt(parts[1]);\n      \n      if (hours >= 0 && hours <= 23 && minutes >= 0 && minutes <= 59) {\n        return String(hours).padStart(2, '0') + String(minutes).padStart(2, '0');\n      }\n    }\n    \n    return null;\n  } catch {\n    return null;\n  }\n}\n\n// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n// â”‚ ðŸŽ¯ SECTION 3: INTENT NORMALIZATION ENGINE                                  â”‚\n// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n\nfunction normalizeIntention(intent) {\n  if (!intent || typeof intent !== 'string') {\n    console.warn('âš ï¸ Intent is null/undefined/invalid');\n    return \"OTRO\";\n  }\n  \n  const cleaned = intent.trim().toUpperCase();\n  if (!cleaned) return \"OTRO\";\n  \n  console.log(`ðŸ” Normalizing intent: \"${intent}\" â†’ \"${cleaned}\"`);\n  \n  // === URGENCIAS (MÃXIMA PRIORIDAD) ===\n  if (cleaned.includes(\"URGENCIA\") || \n      cleaned.includes(\"EMERGENCIA\") || \n      cleaned.includes(\"CRITICAL\") ||\n      cleaned.includes(\"URGENT\")) {\n    console.log('ðŸš¨ Detected URGENCIA');\n    return \"URGENCIA\";\n  }\n  \n  // === TURNOS DE CONSULTORIO ===\n  if (cleaned.includes(\"CONSULTORIO_AGENDAR\") || \n      cleaned.includes(\"TURNOS-CONSULTORIO\") ||\n      cleaned.includes(\"TURNO-CONSULTORIO\") ||\n      cleaned.includes(\"AGENDAR_CONSULTORIO\") ||\n      cleaned.includes(\"SOLICITAR_TURNO\") ||\n      cleaned.includes(\"PEDIR_TURNO\")) {\n    console.log('ðŸ¥ Detected CONSULTORIO_AGENDAR');\n    return \"CONSULTORIO_AGENDAR\";\n  }\n  \n  if (cleaned.includes(\"CONSULTORIO_CANCELAR\") ||\n      cleaned.includes(\"CANCELAR_CONSULTORIO\") ||\n      cleaned.includes(\"CANCELAR_TURNO\")) {\n    console.log('âŒ Detected CONSULTORIO_CANCELAR');\n    return \"CONSULTORIO_CANCELAR\";\n  }\n  \n  if (cleaned.includes(\"CONSULTORIO_REPROGRAMAR\") ||\n      cleaned.includes(\"REPROGRAMAR_CONSULTORIO\") ||\n      cleaned.includes(\"CAMBIAR_TURNO\") ||\n      cleaned.includes(\"MOVER_TURNO\")) {\n    console.log('ðŸ”„ Detected CONSULTORIO_REPROGRAMAR');\n    return \"CONSULTORIO_REPROGRAMAR\";\n  }\n  \n  // === TURNOS DE ESTUDIOS (TODAS LAS VARIANTES) ===\n  if (cleaned.includes(\"ESTUDIO_TURNO\") || \n      cleaned.includes(\"TURNO_ESTUDIO\") || \n      cleaned.includes(\"TURNOS-ESTUDIO\") ||\n      cleaned.includes(\"TURNOS-ESTUDIOS\") ||\n      cleaned.includes(\"TURNO-ESTUDIO\") ||\n      cleaned.includes(\"TURNO-ESTUDIOS\") ||\n      cleaned.includes(\"ESTUDIOS_TURNO\") ||\n      cleaned.includes(\"AGENDAR_ESTUDIO\") ||\n      cleaned.includes(\"SOLICITAR_ESTUDIO\") ||\n      cleaned.includes(\"PEDIR_ESTUDIO\")) {\n    console.log('ðŸ”¬ Detected turnos-estudios');\n    return \"turnos-estudios\";\n  }\n  \n  // === QUEJAS Y RECLAMOS ===\n  if (cleaned.includes(\"QUEJA\") || \n      cleaned.includes(\"RECLAM\") ||\n      cleaned.includes(\"CONSULTAS-RECLAMOS\") ||\n      cleaned.includes(\"CONSULTA-RECLAMO\") ||\n      cleaned.includes(\"COMPLAINT\") ||\n      cleaned.includes(\"PROBLEMA\") ||\n      cleaned.includes(\"INSATISF\") ||\n      cleaned.includes(\"MALO\") ||\n      cleaned.includes(\"MOLESTO\")) {\n    console.log('ðŸ˜  Detected consultas-reclamos');\n    return \"consultas-reclamos\";\n  }\n  \n  // === INFORMACIÃ“N MÃ‰DICA ===\n  if (cleaned.includes(\"INFO_MEDICOS\") || \n      cleaned.includes(\"ESPECIALIDADES\") ||\n      cleaned.includes(\"MEDICOS\") ||\n      cleaned.includes(\"DOCTORES\") ||\n      cleaned.includes(\"PROFESIONALES\")) {\n    console.log('ðŸ‘©â€âš•ï¸ Detected INFO_MEDICOS_ESPECIALIDADES');\n    return \"INFO_MEDICOS_ESPECIALIDADES\";\n  }\n  \n  if (cleaned.includes(\"INFO_ESTUDIOS\") ||\n      cleaned.includes(\"ESTUDIOS\") ||\n      cleaned.includes(\"EXAMENES\") ||\n      cleaned.includes(\"ANALISIS\")) {\n    console.log('ðŸ“Š Detected INFO_ESTUDIOS');\n    return \"INFO_ESTUDIOS\";\n  }\n  \n  // === SALUDOS ===\n  if (cleaned.includes(\"SALUDO\") || \n      cleaned.includes(\"SMALLTALK\") ||\n      cleaned.includes(\"HOLA\") ||\n      cleaned.includes(\"BUEN\") ||\n      cleaned.includes(\"GRACIAS\") ||\n      cleaned.includes(\"HELLO\")) {\n    console.log('ðŸ‘‹ Detected SALUDO_SMALLTALK');\n    return \"SALUDO_SMALLTALK\";\n  }\n  \n  // === ARCHIVOS ===\n  if (cleaned.includes(\"ARCHIVOS\") ||\n      cleaned.includes(\"ADJUNTOS\") ||\n      cleaned.includes(\"DOCUMENTOS\") ||\n      cleaned.includes(\"ARCHIVO\") ||\n      cleaned.includes(\"FILES\")) {\n    console.log('ðŸ“Ž Detected ARCHIVOS_ADJUNTOS');\n    return \"ARCHIVOS_ADJUNTOS\";\n  }\n  \n  // === DEFAULT ===\n  console.log('â“ Intent not matched, returning OTRO');\n  return \"OTRO\";\n}\n\n// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n// â”‚ âœ… SECTION 4: VALIDATION SYSTEM                                            â”‚\n// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n\nfunction validateDataCompleteness(result) {\n  const missing = [];\n  const intent = result.intencionNormalizada;\n  \n  switch (intent) {\n    case \"CONSULTORIO_AGENDAR\":\n      if (!result.paciente.dni) missing.push(\"DNI\");\n      if (!result.datosMedicos.medico && !result.datosMedicos.especialidad) {\n        missing.push(\"MÃ©dico o Especialidad\");\n      }\n      break;\n      \n    case \"CONSULTORIO_CANCELAR\":\n    case \"CONSULTORIO_REPROGRAMAR\":\n      if (!result.paciente.dni) missing.push(\"DNI\");\n      break;\n      \n    case \"turnos-estudios\":\n      if (!result.datosMedicos.tipoEstudio) missing.push(\"Tipo de Estudio\");\n      break;\n      \n    default:\n      break;\n  }\n  \n  return {\n    isComplete: missing.length === 0,\n    missing: missing\n  };\n}\n\nfunction validateDataQuality(data) {\n  const errors = [];\n  \n  if (data.paciente.dni && !isValidDNI(data.paciente.dni)) {\n    errors.push(\"DNI invÃ¡lido (debe tener 7-9 dÃ­gitos)\");\n  }\n  \n  if (data.paciente.email && !isValidEmail(data.paciente.email)) {\n    errors.push(\"Email invÃ¡lido\");\n  }\n  \n  if (data.paciente.telefono && !isValidPhone(data.paciente.telefono)) {\n    errors.push(\"TelÃ©fono invÃ¡lido\");\n  }\n  \n  return {\n    isValid: errors.length === 0,\n    errors: errors\n  };\n}\n\n// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n// â”‚ ðŸš€ SECTION 5: MAIN PROCESSING ENGINE                                       â”‚\n// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n\n// ðŸ”§ DECLARAR VARIABLE resultado FUERA DEL TRY-CATCH\nlet resultado;\n\ntry {\n  console.log('ðŸš€ Starting Ultimate Parser Router ICLP v2.1');\n  console.log(`ðŸ“¥ Input: \"${line.substring(0, 100)}${line.length > 100 ? '...' : ''}\"`);\n  \n  // === STEP 1: PARSE INPUT ===\n  const { parts, map } = parseTokenMap(line);\n  console.log(`ðŸ”§ Parsed ${parts.length} parts, ${Object.keys(map).length} key-value pairs`);\n  \n  // === STEP 2: EXTRACT INTENTION ===\n  const intentRaw = map[\"intenciÃ³n\"] || map[\"intencion\"] || null;\n  const intentNormalized = normalizeIntention(intentRaw);\n  console.log(`ðŸŽ¯ Intent: \"${intentRaw}\" â†’ \"${intentNormalized}\"`);\n  \n  // === STEP 3: BUILD RESULT OBJECT ===\n  resultado = {\n    // Metadata bÃ¡sica\n    descripcion: parts[0] || \"\",\n    resumen: parts[1] || \"\",\n    intencion: intentRaw,\n    intencionNormalizada: intentNormalized,\n    \n    // Datos del paciente\n    paciente: {\n      dni: normalizeToNull(map[\"dni\"]),\n      nombre: vars.contactName || null,\n      telefono: normalizeToNull(map[\"telefono\"]) || vars.contactNumber || null,\n      email: normalizeToNull(map[\"email\"]),\n      obraSocial: normalizeToNull(map[\"obrasocial\"] || map[\"obra_social\"]),\n      conversationId: vars.conversationId || null,\n    },\n    \n    // Datos mÃ©dicos\n    datosMedicos: {\n      medico: normalizeToNull(map[\"medico\"]),\n      especialidad: normalizeToNull(map[\"especialidad\"]),\n      fecha: normalizeDate(map[\"fecha\"]),\n      hora: normalizeTime(map[\"hora\"]),\n      diaSemana: normalizeToNull(map[\"dia\"]),\n      tipoEstudio: normalizeToNull(map[\"estudio\"]),\n    },\n    \n    // Archivos y multimedia\n    archivos: {\n      tiene: (String(map[\"archivos\"] || \"\").toLowerCase().startsWith(\"si\") || \n              !!multimedia.multimedia) || false,\n      tipo: normalizeToNull(map[\"tipo_archivo\"]),\n    },\n    \n    // Control de flujo\n    requiereAccion: true,\n    tipoAccion: null,\n    siguientePaso: null,\n    datosCompletos: true,\n    datosFaltantes: [],\n    flujo: {},\n    respuestaDirecta: null,\n    \n    // Debug y auditorÃ­a\n    respuestaOriginal: line,\n    procesadoEn: new Date().toISOString(),\n    version: \"2.1\",\n    inputSource: rawInput ? \"LLM\" : \"EMPTY\"\n  };\n  \n  // === STEP 4: VALIDATE DATA ===\n  const completenessCheck = validateDataCompleteness(resultado);\n  const qualityCheck = validateDataQuality(resultado);\n  \n  resultado.datosCompletos = completenessCheck.isComplete;\n  resultado.datosFaltantes = completenessCheck.missing;\n  \n  if (!qualityCheck.isValid) {\n    console.warn('âš ï¸ Data quality issues:', qualityCheck.errors);\n    resultado.advertencias = qualityCheck.errors;\n  }\n  \n  console.log(`âœ… Data validation: Complete=${completenessCheck.isComplete}, Quality=${qualityCheck.isValid}`);\n  \n  // === STEP 5: DETERMINE ACTIONS BY INTENTION ===\n  switch (intentNormalized) {\n    case \"URGENCIA\":\n      resultado.tipoAccion = \"RESPUESTA_URGENCIA\";\n      resultado.siguientePaso = \"responder_emergencia\";\n      resultado.prioridad = \"ALTA\";\n      console.log('ðŸš¨ Configured URGENCIA flow');\n      break;\n\n    case \"SALUDO_SMALLTALK\":\n      resultado.tipoAccion = \"SALUDO_INICIAL\";\n      resultado.siguientePaso = \"mostrar_menu_principal\";\n      resultado.respuestaDirecta = `Gracias por comunicarte con Instituto de CardiologÃ­a La Plata â¤ï¸\nLEER CON ATENCIÃ“N â€¼ï¸\n\nðŸ•› HORARIO: Lunes a Viernes 8 a 20 hs\n\nðŸ“ PARA TURNOS INDICAR SI ES:\n  - Consulta MÃ©dica\n  - Estudio\n\nSi necesitÃ¡s una Consulta, decime especialidad o nombre del profesional y tu DNI.\nSi es para un Estudio, te derivo con recepciÃ³n para que te asistan rÃ¡pido.\n\nâ” TambiÃ©n ayudamos con:\n- Â¿DÃ³nde envÃ­o mis recetas?\n- Â¿CuÃ¡l es el horario de atenciÃ³n?\n- Â¿QuÃ© especialidades tienen?\n- Â¿DÃ³nde saco turno por la web?\n\nðŸš« NO RECIBIMOS LLAMADAS POR ESTE MEDIO ðŸš«`;\n      resultado.flujo.usarRespuestaDirecta = true;\n      console.log('ðŸ‘‹ Configured SALUDO flow');\n      break;\n\n    case \"CONSULTORIO_AGENDAR\":\n      resultado.tipoAccion = \"INICIAR_AGENDAMIENTO\";\n      resultado.siguientePaso = \"validar_paciente_padron\";\n      resultado.etiquetaChatwoot = \"turnos-consultorio\";\n      console.log('ðŸ¥ Configured CONSULTORIO_AGENDAR flow');\n      break;\n\n    case \"CONSULTORIO_CANCELAR\":\n      resultado.tipoAccion = \"INICIAR_CANCELACION\";\n      resultado.siguientePaso = \"buscar_turnos_activos\";\n      resultado.etiquetaChatwoot = \"cancelacion-turno\";\n      console.log('âŒ Configured CONSULTORIO_CANCELAR flow');\n      break;\n\n    case \"CONSULTORIO_REPROGRAMAR\":\n      resultado.tipoAccion = \"INICIAR_REPROGRAMACION\";\n      resultado.siguientePaso = \"buscar_turnos_para_cambiar\";\n      resultado.etiquetaChatwoot = \"reprogramacion-turno\";\n      console.log('ðŸ”„ Configured CONSULTORIO_REPROGRAMAR flow');\n      break;\n\n    case \"turnos-estudios\":\n      resultado.tipoAccion = \"DERIVAR_HUMANO\";\n      resultado.siguientePaso = \"llamar_tool_studios\";\n      resultado.etiquetaChatwoot = \"turnos-estudios\";\n      console.log('ðŸ”¬ Configured turnos-estudios flow');\n      break;\n\n    case \"consultas-reclamos\":\n      resultado.tipoAccion = \"GESTIONAR_RECLAMO\";\n      resultado.siguientePaso = \"derivar_supervisor\";\n      resultado.etiquetaChatwoot = \"consultas-reclamos\";\n      resultado.prioridad = \"ALTA\";\n      console.log('ðŸ˜  Configured consultas-reclamos flow');\n      break;\n\n    case \"INFO_ESTUDIOS\":\n      resultado.tipoAccion = \"INFORMAR_ESTUDIOS\";\n      resultado.siguientePaso = \"obtener_lista_estudios\";\n      resultado.etiquetaChatwoot = \"info-estudios\";\n      console.log('ðŸ“Š Configured INFO_ESTUDIOS flow');\n      break;\n\n    case \"INFO_MEDICOS_ESPECIALIDADES\":\n      resultado.tipoAccion = \"INFORMAR_PROFESIONALES\";\n      resultado.siguientePaso = \"obtener_medicos_especialidades\";\n      resultado.etiquetaChatwoot = \"info-medicos\";\n      console.log('ðŸ‘©â€âš•ï¸ Configured INFO_MEDICOS flow');\n      break;\n\n    case \"ARCHIVOS_ADJUNTOS\":\n      resultado.tipoAccion = \"PROCESAR_ARCHIVOS\";\n      resultado.siguientePaso = \"analizar_documentos\";\n      resultado.etiquetaChatwoot = \"archivos\";\n      console.log('ðŸ“Ž Configured ARCHIVOS flow');\n      break;\n\n    default:\n      resultado.tipoAccion = \"PROCESAR_CON_AGENTE\";\n      resultado.siguientePaso = \"agente_conversacional\";\n      resultado.etiquetaChatwoot = \"general\";\n      console.log('â“ Configured DEFAULT flow');\n  }\n  \n  // === STEP 6: SET FLOW FLAGS ===\n  resultado.flujo = {\n    ...resultado.flujo,\n    debeUsarAgente: ![\"URGENCIA\", \"SALUDO_SMALLTALK\", \"turnos-estudios\", \"consultas-reclamos\"].includes(intentNormalized),\n    debeDerivar: [\"turnos-estudios\", \"consultas-reclamos\"].includes(intentNormalized),\n    esEmergencia: intentNormalized === \"URGENCIA\",\n    esPrimerContacto: intentNormalized === \"SALUDO_SMALLTALK\",\n    necesitaDatosAdicionales: !resultado.datosCompletos,\n    requiereSupervision: [\"consultas-reclamos\", \"URGENCIA\"].includes(intentNormalized),\n    puedeAutomatizar: [\"SALUDO_SMALLTALK\", \"INFO_ESTUDIOS\", \"INFO_MEDICOS_ESPECIALIDADES\"].includes(intentNormalized)\n  };\n  \n  // === STEP 7: GENERATE SUGGESTED MESSAGE ===\n  if (!resultado.datosCompletos && resultado.datosFaltantes.length > 0) {\n    resultado.mensajeSugerido = `Para poder ayudarte mejor, necesito que me proporciones: ${resultado.datosFaltantes.join(\", \")}. Â¿PodrÃ­as proporcionarme esa informaciÃ³n?`;\n  }\n  \n  // === STEP 8: FINAL LOGGING ===\n  console.log(`âœ… Processing completed successfully`);\n  console.log(`ðŸ“Š Intent: ${intentNormalized}, Action: ${resultado.tipoAccion}`);\n  console.log(`ðŸ·ï¸ Chatwoot Label: ${resultado.etiquetaChatwoot || 'none'}`);\n  console.log(`ðŸ“ˆ Data Complete: ${resultado.datosCompletos}, Missing: [${resultado.datosFaltantes.join(', ')}]`);\n  \n  console.log('ðŸŽ‰ Ultimate Parser Router completed successfully!');\n  \n} catch (error) {\n  // === ERROR HANDLING ===\n  console.error('ðŸ’¥ CRITICAL ERROR in Ultimate Parser Router:', error);\n  \n  // ðŸ”§ CREAR RESULTADO DE ERROR USANDO LA VARIABLE YA DECLARADA\n  resultado = {\n    descripcion: \"Error en procesamiento\",\n    resumen: \"Error interno\",\n    intencion: null,\n    intencionNormalizada: \"OTRO\",\n    \n    paciente: {\n      dni: null,\n      nombre: vars.contactName || null,\n      telefono: vars.contactNumber || null,\n      email: null,\n      obraSocial: null,\n      conversationId: vars.conversationId || null,\n    },\n    \n    datosMedicos: {\n      medico: null,\n      especialidad: null,\n      fecha: null,\n      hora: null,\n      diaSemana: null,\n      tipoEstudio: null,\n    },\n    \n    archivos: {\n      tiene: false,\n      tipo: null,\n    },\n    \n    requiereAccion: true,\n    tipoAccion: \"PROCESAR_CON_AGENTE\",\n    siguientePaso: \"agente_conversacional\",\n    datosCompletos: false,\n    datosFaltantes: [\"Error en procesamiento\"],\n    flujo: {\n      debeUsarAgente: true,\n      debeDerivar: false,\n      esEmergencia: false,\n      esPrimerContacto: false,\n      necesitaDatosAdicionales: true,\n      requiereSupervision: true,\n      puedeAutomatizar: false\n    },\n    respuestaDirecta: null,\n    \n    // Error info\n    error: {\n      occurred: true,\n      message: error.message,\n      timestamp: new Date().toISOString()\n    },\n    \n    respuestaOriginal: line,\n    procesadoEn: new Date().toISOString(),\n    version: \"2.1-ERROR\",\n    inputSource: \"ERROR\"\n  };\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ðŸŽ¯ FINAL OUTPUT - ALWAYS RETURN ARRAY FORMAT FOR N8N\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nreturn [{ json: resultado }];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-4364,490],"id":"eda3e6c8-2695-41f5-9b47-c750fc2c3d8e","name":"Formateador"},{"parameters":{"dataToSave":{"values":[{"key":"conversationId","value":"={{ $json.body.id }}"},{"key":"contactNumber","value":"={{ $json.body.contact_inbox.source_id }}"}]}},"type":"n8n-nodes-base.executionData","typeVersion":1,"position":[-5400,140],"id":"d554481b-8b84-4260-8b6b-48ea3b405761","name":"Execution Data"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.multimedia }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true},"id":"e7a9ef75-11df-4262-8ec0-c63644980c5e"}],"combinator":"and"},"renameOutput":true,"outputKey":"tieneMultimedia"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"839f4006-0caa-456b-b044-28ae16cd1ab4","leftValue":"={{ $json.humano }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"tieneHumano"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"579505b2-6063-4333-9c73-476c450aee99","leftValue":"={{ $json.message }}","rightValue":"Texto","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"tieneTexto"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-5180,1260],"id":"c57ea235-ce0d-4055-af6e-53df86bc6dff","name":"Switch"},{"parameters":{"workflowId":{"__rl":true,"value":"NuqjIAupbDxn4tlV","mode":"list","cachedResultName":"TOOL BUFFER MENSAJES - TRANSCRIPCIONES âš’ï¸âš’ï¸"},"workflowInputs":{"mappingMode":"defineBelow","value":{"message":"={{ $('variables1').item.json.message }}","conversationId":"={{ $('variables1').item.json.conversationId }}","messageId":"={{ $('variables1').item.json.messagesId }}","timestamp":"={{ $('variables1').item.json.timestamp }}"},"matchingColumns":[],"schema":[{"id":"message","displayName":"message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"conversationId","displayName":"conversationId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"messageId","displayName":"messageId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"timestamp","displayName":"timestamp","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":true,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-4960,1360],"id":"5bfd1e8f-a8aa-42b2-9edf-4da5f8924d0f","name":"bufferMessages"},{"parameters":{"workflowId":{"__rl":true,"value":"bB6n7ZuHDz9q0WeY","mode":"list","cachedResultName":"TOOL PROCESA MULTIMEDIAS CHATWOOT âš’ï¸âš’ï¸"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":true,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-4960,1160],"id":"7dbfedb9-c1a9-47d8-a119-650977ebf4d1","name":"multimediaProccess"},{"parameters":{"assignments":{"assignments":[{"id":"bb31dc82-ebb8-4bca-bd8d-6b4760085673","name":"texto","value":"={{ $json.text }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-4740,1260],"id":"d9753a35-4530-4b59-9f26-0c56470a45a8","name":"unifiedText"},{"parameters":{"assignments":{"assignments":[{"id":"16d8fd1f-7293-45ec-ba41-6041979d7964","name":"accountId","value":"={{ $json.body.messages[0].account_id }}","type":"number"},{"id":"a8eb17ea-8fda-42e5-9f1c-444826a21e51","name":"message","value":"={{ $json.body.messages[0].content }}","type":"string"},{"id":"3fe92852-b569-426e-bef7-b755cf44ddc9","name":"inboxId","value":"={{ $json.body.contact_inbox.inbox_id }}","type":"number"},{"id":"96fa0ac2-a17b-452c-bf67-cc0f3bd5d4a2","name":"contactId","value":"={{ $json.body.messages[0].sender.id }}","type":"number"},{"id":"0d77d8b4-ec6d-42e0-8a5b-fdf1b78b454d","name":"contactName","value":"={{ $json.body.messages[0].sender.name }}","type":"string"},{"id":"25487cfb-897d-4000-9ad6-99745966c526","name":"contactNumber","value":"={{ $json.body.messages[0].sender.phone_number }}","type":"string"},{"id":"1e1b0044-b199-44e0-927b-c2cabe2a281b","name":"agentId","value":"=","type":"number"},{"id":"ad5ef314-70d7-4790-b82e-ea96a340ae12","name":"agentName","value":"=","type":"string"},{"id":"f4bc6964-862e-4168-8bae-94e6c6ad8321","name":"eventType","value":"={{ $json.body.event }}","type":"string"},{"id":"ef4c85e4-0029-4d70-ade1-0de74711b804","name":"conversationId","value":"={{ $json.body.id }}","type":"number"},{"id":"be91191b-7e8a-4406-af97-0a18e8100e7f","name":"multimedia","value":"={{ $json?.body?.messages?.[0]?.attachments?.[0]?.file_type ? true : false }}","type":"boolean"},{"id":"a3202993-c215-4502-bf56-e7e644b35a88","name":"humano","value":"={{ $json.body.custom_attributes.humano }}","type":"boolean"},{"id":"3da45859-4092-4b0c-bba3-c8898b649491","name":"messagesId","value":"={{ $json.body.messages[0].id }}","type":"number"},{"id":"24592e90-360f-4a9c-8271-1119ba300be1","name":"timestamp","value":"={{ $json.body.timestamp }}","type":"number"},{"id":"e01eb0b6-2e60-4ade-a4ba-949e30df02a5","name":"multimediaUrl","value":"={{ $json.body.messages[0].attachments[0].data_url }}","type":"string"},{"id":"1225af59-1b61-42dc-8052-296978708c1a","name":"agenteTokenWhatsapp","value":"GV7NTeP2iFqkYTa5u677kBn3","type":"string"},{"id":"2e74ddde-5f26-4b0c-a6dc-32eb8e83874f","name":"chatwootUrl","value":"https://chatwoot.orchila.tech","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-5620,1260],"id":"42f385a6-e99f-43e3-a24c-1bb1df3ba0ac","name":"variables1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"0db9a125-ce45-48fe-b722-efbed0fc42a4","leftValue":"={{ $json.body.messages[0].sender.type }}","rightValue":"agent_bot","operator":{"type":"string","operation":"notEquals"}},{"id":"7d71d302-596d-4330-b68c-1b0502f6c7cd","leftValue":"={{ $json.body.event }}","rightValue":"message_created","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"12a51caa-5e4c-46f3-a067-79f0a52ca94b","leftValue":"={{ $json.body.messages[0].attachments[0].file_type }}","rightValue":"=file","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"or"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[-5400,1260],"id":"f14c071e-bc98-4d47-824d-84d90a2a10dc","name":"Filter1"},{"parameters":{"assignments":{"assignments":[{"id":"prompt_contexto_base","name":"prompt_contexto_base","value":"Eres el Asistente MÃ©dico Digital del Instituto de CardiologÃ­a La Plata (ICLP).\n\n**DATOS INSTITUCIONALES**:\nâ€¢ UbicaciÃ³n: Calle 6 Nro. 212, La Plata (entre 36 y 37)\nâ€¢ Horario: Lunes a Viernes 8:00-20:00hs / SÃ¡bado 8:00-13:00hs\nâ€¢ TelÃ©fono: (0221) 427-1000 | Recetas: interno 29\nâ€¢ Email recetas: recetas@iclpsrl.com.ar\nâ€¢ Web: https://www.iclp.com.ar/\n\n**PERSONALIDAD**: Profesional, resolutivo, empÃ¡tico. Usas voseo argentino.","type":"string"},{"id":"prompt_reglas_criticas","name":"prompt_reglas_criticas","value":"**REGLAS INDISCUTIBLES**:\nâ€¢ NUNCA agendar turnos para ESTUDIOS\nâ€¢ NUNCA dar consejos mÃ©dicos o diagnÃ³sticos\nâ€¢ NUNCA dar precios\nâ€¢ URGENCIAS: 'Para urgencias llamÃ¡ al 107'","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-3846,2045],"id":"5b27cbbb-4ad1-4408-aaa0-b1e58016db2a","name":"Prompt_Base_Config"},{"parameters":{"jsCode":"// Generar prompt dinÃ¡mico basado en intenciÃ³n\n// Obtener datos del nodo anterior (If/Formateador) y del nodo actual (Prompt_Base_Config)\nlet intencion = 'GENERAL';\n\n// Obtener intenciÃ³n del input anterior\ntry {\n  // El $input.first() contiene los datos del nodo anterior (If)\n  const inputData = $input.first();\n  if (inputData && inputData.json && inputData.json.intencionNormalizada) {\n    intencion = inputData.json.intencionNormalizada;\n  }\n} catch (error) {\n  console.log('Error obteniendo intenciÃ³n:', error.message);\n  intencion = 'GENERAL';\n}\n\n// Obtener contexto base del nodo actual (Prompt_Base_Config)\nconst contextoBase = $json.prompt_contexto_base;\nconst reglasCriticas = $json.prompt_reglas_criticas;\n\nlet promptEspecifico = '';\n\nswitch(intencion) {\n  case 'AGENDAR_TURNO':\n  case 'TURNO_MEDICO':\n  case 'CONSULTORIO_AGENDAR':\n    promptEspecifico = `**FLUJO TURNO**:\n1. Validar paciente con Flujo_padron\n2. Obtener especialidad/mÃ©dico\n3. RECOPILAR DATOS COMPLETOS:\n   - Nombre y apellido completo\n   - DNI confirmado\n   - Obra Social\n4. Buscar disponibilidad\n5. Confirmar y agendar`;\n    break;\n    \n  case 'CANCELAR_TURNO':\n  case 'CONSULTORIO_CANCELAR':\n    promptEspecifico = `**FLUJO CANCELACIÃ“N**:\n1. Obtener DNI\n2. Ejecutar Lista_Turnos\n3. Confirmar turno especÃ­fico\n4. Ejecutar eliminar_Turno`;\n    break;\n    \n  case 'ESTUDIO_TURNO':\n    promptEspecifico = `**FLUJO ESTUDIO**:\n1. NO usar herramientas de agenda\n2. Ejecutar llamaToolStudios\n3. Responder: derivaciÃ³n a recepcionista`;\n    break;\n    \n  case 'OTRO':\n    promptEspecifico = `**FLUJO CONSULTA GENERAL**:\n1. Analizar la consulta del paciente\n2. Si menciona un mÃ©dico especÃ­fico, buscar en obtener_medicos_matricula\n3. Si es para turno mÃ©dico, recopilar datos completos\n4. Responder de manera profesional y empÃ¡tica`;\n    break;\n    \n  default:\n    promptEspecifico = `**FLUJO GENERAL**:\n1. Analizar consulta\n2. Usar herramientas apropiadas\n3. Responder profesionalmente`;\n}\n\n// Crear fecha actual sin usar sintaxis de n8n\nconst fechaActual = new Date().toLocaleString('es-AR', {\n  weekday: 'long',\n  year: 'numeric',\n  month: '2-digit',\n  day: '2-digit',\n  hour: '2-digit',\n  minute: '2-digit'\n});\n\nconst promptFinal = `${contextoBase}\n\n${reglasCriticas}\n\n${promptEspecifico}\n\nHOY ES: ${fechaActual}`;\n\nreturn [{\n  json: {\n    system_prompt: promptFinal,\n    intencion_detectada: intencion,\n    contexto_base: contextoBase,\n    reglas_criticas: reglasCriticas,\n    processed_at: new Date().toISOString()\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-3548,2045],"id":"2a6729cf-cb16-4b40-b6c6-f6058e3135eb","name":"Prompt_Dinamico_Generator"},{"parameters":{"jsCode":"// Sistema de memoria conversacional sin LangChain\n// Obtener datos de manera segura\nconst variables = $('variables2')?.item?.json || {};\nconst conversationId = variables.conversationId || 'unknown';\nconst message = variables.message || '';\nconst memoryKey = `conversation_${conversationId}`;\nconst maxMessages = 8;\n\n// Validar que tenemos los datos necesarios\nif (!conversationId || conversationId === 'unknown') {\n  return [{\n    json: {\n      error: 'No conversation ID found',\n      conversation_context: '',\n      message_count: 0,\n      memory_enabled: false\n    }\n  }];\n}\n\n// Simular Redis con memoria local\nif (typeof global.conversationMemory === 'undefined') {\n  global.conversationMemory = {};\n}\n\n// Obtener historial existente\nlet conversationHistory = global.conversationMemory[memoryKey] || [];\n\n// Agregar nuevo mensaje solo si no estÃ¡ vacÃ­o\nif (message && message.trim() !== '') {\n  conversationHistory.push({\n    timestamp: new Date().toISOString(),\n    role: 'user',\n    content: message.trim(),\n    conversation_id: conversationId\n  });\n  \n  // Mantener solo los Ãºltimos N mensajes\n  if (conversationHistory.length > maxMessages) {\n    conversationHistory = conversationHistory.slice(-maxMessages);\n  }\n  \n  // Guardar en memoria\n  global.conversationMemory[memoryKey] = conversationHistory;\n}\n\n// Crear contexto de conversaciÃ³n para el prompt\nconst conversationContext = conversationHistory.length > 0 \n  ? conversationHistory.map(msg => `${msg.role}: ${msg.content}`).join('\\n')\n  : 'Primera interacciÃ³n';\n\nreturn [{\n  json: {\n    conversation_id: conversationId,\n    conversation_context: conversationContext,\n    message_count: conversationHistory.length,\n    memory_enabled: true,\n    current_message: message,\n    memory_key: memoryKey\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-5620,2915],"id":"4a07d41e-0416-4b41-9529-3d868ed19e2a","name":"Memory_Conversacional"},{"parameters":{"jsCode":"// Sistema de cola simple para rate limiting\nconst conversationId = $('variables2').item.json.conversationId;\nconst queueKey = 'baserow_queue';\nconst activeKey = 'baserow_active';\n\n// Simular Redis con memoria local si no estÃ¡ disponible\nif (!global.redisSimulator) {\n  global.redisSimulator = {\n    data: {},\n    get: function(key) { return this.data[key] || '0'; },\n    set: function(key, value) { this.data[key] = value; },\n    incr: function(key) { \n      this.data[key] = (parseInt(this.data[key]) || 0) + 1;\n      return this.data[key];\n    },\n    decr: function(key) {\n      this.data[key] = Math.max(0, (parseInt(this.data[key]) || 0) - 1);\n      return this.data[key];\n    }\n  };\n}\n\nconst redis = global.redisSimulator;\n\n// Verificar si hay demasiadas llamadas activas\nconst activeCount = parseInt(redis.get(activeKey)) || 0;\n\nif (activeCount >= 3) {\n  // Implementar cola bÃ¡sica\n  return [{\n    json: {\n      queued: true,\n      position: activeCount + 1,\n      message: 'Tu consulta estÃ¡ en cola, te respondo en un momento...',\n      wait_time: 2000\n    }\n  }];\n} else {\n  // Incrementar contador activos\n  redis.incr(activeKey);\n  \n  // Auto-decrementar despuÃ©s de 30 segundos\n  setTimeout(() => {\n    redis.decr(activeKey);\n  }, 30000);\n  \n  return [{\n    json: {\n      can_proceed: true,\n      active_requests: activeCount + 1,\n      conversation_id: conversationId\n    }\n  }];\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-4960,2345],"id":"dfd5bc22-316a-446d-898a-b500a6090d54","name":"Rate_Limiter"},{"parameters":{"amount":500,"unit":"ms"},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-4662,2345],"id":"8aa8066c-11de-442d-a9ec-a8c5e301fa94","name":"API_Delay","webhookId":"44a0fe85-4ed7-4626-9e46-0b6f895e13a1"},{"parameters":{"jsCode":"// Sistema de cachÃ© para datos mÃ©dicos\nconst especialidad = $json.especialidad || 'all';\nconst cacheKey = `medicos:${especialidad}`;\nconst TTL = 4 * 60 * 60 * 1000; // 4 horas en ms\n\n// Simular cachÃ© con memoria local\nif (!global.medicosCache) {\n  global.medicosCache = {\n    data: {},\n    timestamps: {}\n  };\n}\n\nconst cache = global.medicosCache;\nconst now = Date.now();\n\n// Verificar si existe y no ha expirado\nif (cache.data[cacheKey] && cache.timestamps[cacheKey]) {\n  const age = now - cache.timestamps[cacheKey];\n  if (age < TTL) {\n    return [{\n      json: {\n        cached: true,\n        data: cache.data[cacheKey],\n        source: 'memory_cache',\n        cache_age_minutes: Math.round(age / 60000),\n        cache_key: cacheKey\n      }\n    }];\n  } else {\n    // CachÃ© expirado, limpiar\n    delete cache.data[cacheKey];\n    delete cache.timestamps[cacheKey];\n  }\n}\n\n// No hay cachÃ© vÃ¡lido, proceder con Baserow\nreturn [{\n  json: {\n    cached: false,\n    needs_baserow: true,\n    cache_key: cacheKey,\n    ttl_hours: 4\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-4364,2345],"id":"ad1eb244-6e8c-4a7d-9ff1-7924495a59eb","name":"Cache_Check"},{"parameters":{"jsCode":"// Actualizar cachÃ© despuÃ©s de consulta Baserow\nconst cacheKey = $('Cache_Check').item.json.cache_key;\nconst baserowData = $json;\n\nif (!global.medicosCache) {\n  global.medicosCache = {\n    data: {},\n    timestamps: {}\n  };\n}\n\nconst cache = global.medicosCache;\n\ntry {\n  // Guardar en cachÃ©\n  cache.data[cacheKey] = baserowData;\n  cache.timestamps[cacheKey] = Date.now();\n  \n  return [{\n    json: {\n      ...baserowData,\n      cached_at: new Date().toISOString(),\n      cache_key: cacheKey,\n      cache_status: 'updated'\n    }\n  }];\n} catch (error) {\n  // Error en cachÃ© no es crÃ­tico\n  return [{\n    json: {\n      ...baserowData,\n      cache_error: error.message,\n      cache_status: 'failed'\n    }\n  }];\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-4144,2345],"id":"2f47c677-ca63-4f4f-81e2-f21a079a8d53","name":"Cache_Update"},{"parameters":{"jsCode":"// Error handler para llamadas Baserow\ntry {\n  const data = $input.all();\n  \n  // Verificar si hay datos vÃ¡lidos\n  if (!data || data.length === 0) {\n    return [{\n      json: {\n        error: true,\n        errorType: 'NO_DATA',\n        fallbackMessage: 'No se encontraron mÃ©dicos disponibles. Te voy a derivar con una recepcionista.',\n        originalRequest: $json,\n        timestamp: new Date().toISOString()\n      }\n    }];\n  }\n  \n  // Verificar estructura de datos\n  const firstItem = data[0];\n  if (!firstItem || !firstItem.json || Object.keys(firstItem.json).length === 0) {\n    return [{\n      json: {\n        error: true,\n        errorType: 'INVALID_DATA',\n        fallbackMessage: 'Hay un problema temporal con nuestro sistema. Te voy a conectar con una recepcionista.',\n        originalRequest: $json,\n        timestamp: new Date().toISOString()\n      }\n    }];\n  }\n  \n  // Todo OK, pasar datos\n  return data.map(item => ({\n    json: {\n      ...item.json,\n      error: false,\n      processed_at: new Date().toISOString()\n    }\n  }));\n  \n} catch (error) {\n  return [{\n    json: {\n      error: true,\n      errorType: 'EXCEPTION',\n      errorMessage: error.message,\n      fallbackMessage: 'Disculpas, hay un problema tÃ©cnico. Te voy a derivar con una recepcionista.',\n      originalRequest: $json,\n      timestamp: new Date().toISOString()\n    }\n  }];\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-3846,2345],"id":"4e0b6140-0f00-4ddf-85df-ebd1b8996de3","name":"Error_Handler_Baserow"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"check_error_condition","leftValue":"={{ $json.error }}","rightValue":true,"operator":{"type":"boolean","operation":"equal"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2,"position":[-3548,2345],"id":"bc3bbb1f-96bf-47ab-bc05-17bdd311ca0e","name":"Check_Error"},{"parameters":{"assignments":{"assignments":[{"id":"fallback_response_text","name":"response","value":"={{ $json.fallbackMessage || 'Disculpas, hay un problema tÃ©cnico. Te voy a derivar con una recepcionista para que te ayude personalmente.' }}","type":"string"},{"id":"requires_human_flag","name":"requires_human","value":true,"type":"boolean"},{"id":"error_logged","name":"error_details","value":"={{ JSON.stringify({ type: $json.errorType, message: $json.errorMessage, timestamp: $json.timestamp }) }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2678,2395],"id":"4247873d-868d-4a1a-8ac7-53853a5fed8b","name":"Fallback_Response"},{"parameters":{"databaseId":256795,"tableId":606371,"returnAll":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Return_All', `Devuelve la matricula del medico que pidio el paciente\n\nSi no pidio un doctor en especifico, devuelve una lista de medicos con esa especialidad y su matricula`, 'boolean') }}","additionalOptions":{}},"type":"n8n-nodes-base.baserowTool","typeVersion":1,"position":[-3208,2215],"id":"63627a26-42e9-43e3-ae16-8b2c80c4e106","name":"obtener_medicos_matricula1","credentials":{"baserowApi":{"id":"ZpGSFHDmV88Zga8O","name":"Baserow account"}}},{"parameters":{"databaseId":256795,"tableId":606737,"returnAll":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Return_All', `Devuelve solo el campo 'Estudio'\n\nEsto nos dara informacion sobre los estudios que realiza el instituto`, 'boolean') }}","additionalOptions":{}},"type":"n8n-nodes-base.baserowTool","typeVersion":1,"position":[-3088,2215],"id":"310c0dcc-acef-48fa-8062-5486619bf300","name":"obtener_estudios1","credentials":{"baserowApi":{"id":"ZpGSFHDmV88Zga8O","name":"Baserow account"}}},{"parameters":{"description":"Llama a este subflujo cuando se necesita saber los horarios disponibles de un medico","workflowId":{"__rl":true,"value":"kmoVJGP4RL3PTi16","mode":"list","cachedResultName":"Turno-medico-mas-proximo"},"workflowInputs":{"mappingMode":"defineBelow","value":{"matricula":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('matricula', `Matricula del medico encontrada desde obtener_medicos_especialidades o pgvector\n\nEs unicamente un dato de tipo NUMBER`, 'number') }}","dni":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('dni', `DNI o cedula de identidad provista por el paciente\n\nEjemplo: 42028075`, 'number') }}","fechaDesde":"={{ DateTime.now().setZone('America/Argentina/Buenos_Aires').toFormat('yyyyMMdd') }}"},"matchingColumns":["matricula"],"schema":[{"id":"matricula","displayName":"matricula","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"fechaDesde","displayName":"fechaDesde","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[-2968,2215],"id":"1f6af208-2007-464e-b16b-137d33b2e08c","name":"horarios_medicos_disponibles1"},{"parameters":{"description":"Confirma un turno mÃ©dico para el paciente. Requiere DNI, matrÃ­cula del mÃ©dico, fecha y hora. Convierte automÃ¡ticamente los formatos de fecha (a timestamp) y hora (a HHMM) para la API.","workflowId":{"__rl":true,"value":"H4tsNj9SnsCxET4y","mode":"list","cachedResultName":"ICLP - Subflujo_Tomar_Turno"},"workflowInputs":{"mappingMode":"defineBelow","value":{"dni":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('dni', `Documento/DNI proporcionado por el paciente`, 'number') }}","matricula":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('matricula', `matricula del medico que va a obtener el turno`, 'number') }}","fecha":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fecha', `El dia que el paciente quiere el turno`, 'string') }}","hora":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('hora', `La hora que el paciente quiere el turno`, 'string') }}","nombre_completo":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('nombre_completo', `Nombre y apellido completo del paciente proporcionado por el usuario en la conversaciÃ³n. DEBE ser especÃ­fico, NO usar nombres genÃ©ricos como 'Paciente'. Ejemplo: 'Juan Carlos PÃ©rez'`, 'string') }}","obra_social":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('obra_social', `Obra social del paciente si la tiene, o 'particular' si no tiene obra social. Ejemplo: 'OSDE', 'Swiss Medical', 'particular'`, 'string') }}"},"matchingColumns":[],"schema":[{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"fecha","displayName":"fecha","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"matricula","displayName":"matricula","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"hora","displayName":"hora","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"nombre_completo","displayName":"nombre_completo","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"obra_social","displayName":"obra_social","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[-2848,2215],"id":"64c058d2-1df5-43d5-b8ec-669e9e23d3f7","name":"tomar_turno_paciente1"},{"parameters":{"promptType":"define","text":"=Mensaje del Paciente: {{ $('variables2').item.json.message }}\n\nIntenciÃ³n del Paciente: {{ $json.intencion_detectada }}\n","options":{"systemMessage":"={{ $json.system_prompt }}","maxIterations":10}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2,"position":[-2756,1995],"id":"9397d7a0-2e4f-455d-8727-3365d60969f4","name":"Agente conversacional1"},{"parameters":{"jsCode":"const textoOriginal = $json.output || \"\";\n\n// FILTRO CRÃTICO: Eliminar prioridades internas antes de mostrar al paciente\nlet textoFiltrado = textoOriginal\n  // Eliminar lÃ­neas completas que contengan prioridades\n  .replace(/^.*Prioridad\\s*[123].*:.*$/gm, '')\n  .replace(/^.*Sin Prioridad.*\\(S\\/P\\).*:.*$/gm, '')\n  .replace(/^.*S\\/P.*:.*$/gm, '')\n  // Eliminar texto especÃ­fico de prioridades\n  .replace(/Prioridad\\s*[123]\\s*:/gi, '')\n  .replace(/Sin\\s*Prioridad\\s*\\(S\\/P\\)\\s*:/gi, '')\n  .replace(/S\\/P\\s*:/gi, '')\n  // Limpiar saltos de lÃ­nea mÃºltiples excesivos (mÃ¡s de 3)\n  .replace(/\\n{4,}/g, '\\n\\n\\n')\n  .trim();\n\n// Aplicar limpieza mÃ­nima para WhatsApp\nconst limpio = textoFiltrado\n  // Convertir ** a * para negrita de WhatsApp\n  .replace(/\\*\\*([^*]+)\\*\\*/g, '*$1*')\n  \n  // Convertir bullets markdown a bullets de WhatsApp\n  .replace(/^[-]\\s+/gm, 'â€¢ ')\n  \n  // IMPORTANTE: Preservar saltos de lÃ­nea y espacios\n  // NO eliminar saltos de lÃ­nea simples\n  // NO comprimir espacios despuÃ©s de puntuaciÃ³n\n  \n  // Solo limpiar espacios mÃºltiples horizontales (no verticales)\n  .replace(/[ \\t]{2,}/g, ' ')\n  \n  // Eliminar espacios al final de cada lÃ­nea\n  .replace(/[ \\t]+$/gm, '')\n  \n  .trim();\n\n// Si el mensaje queda vacÃ­o, usar el original\nconst mensajeFinal = limpio.length > 0 ? limpio : textoOriginal.trim();\n\nreturn [{\n  json: {\n    texto_limpio: mensajeFinal\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1808,2095],"id":"4c3b0f30-4756-49a4-8009-b541a1acd035","name":"Code1"},{"parameters":{"method":"POST","url":"=https://chatw.automatizaciones.ai/api/v1/accounts/{{ $('variables2').item.json.accountId }}/conversations/{{ $('variables2').item.json.conversationId }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"rgqHjdPeBQpVpzt2iDR2RKLp"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"content","value":"={{ $json.texto_limpio }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1588,2095],"id":"1236128c-ecb0-4cd8-98ee-61c2719523e6","name":"SendText1"},{"parameters":{"modelName":"models/gemini-2.5-flash","options":{"temperature":0.1,"topP":0.5}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[-4652,2115],"id":"df364cee-ea07-4d27-811a-9abe9dd4f696","name":"LLM1","credentials":{"googlePalmApi":{"id":"y4EbL32CeQSjDRft","name":"Google Gemini(PaLM) Api account"}}},{"parameters":{"sessionIdType":"customKey","sessionKey":"=chat:{{ $('variables2').item.json.conversationId }}_iclp","sessionTTL":132800,"contextWindowLength":15},"type":"@n8n/n8n-nodes-langchain.memoryRedisChat","typeVersion":1.5,"position":[-3328,2215],"id":"c8d11f3c-52ab-485f-9509-4799b2d7344e","name":"MEMORY1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"toolDescription":"Permite cancelar un turno mÃ©dico existente. IMPORTANTE: Primero verificar con HTTP Lista_Turnos que el turno existe y estÃ¡ activo. Requiere la matrÃ­cula del mÃ©dico, la fecha (en formato YYYYMMDD, ej: '20250708') y la hora (en formato HHMM, ej: '1430') del turno a eliminar. Si el turno ya fue cancelado, informar al usuario.","method":"PUT","url":"http://iclp.ddns.net:7080/ws-turnos-rest-simple/api/turnos/eliminar-turno","sendQuery":true,"queryParameters":{"parameters":[{"name":"usuario","value":"WSTRRED"},{"name":"password","value":"Y2xpb25lcw"},{"name":"matricula","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters2_Value', `Matricula del medico, generalmente son 5 a 7 numeros. \nTe puedes guiar por parameters2_Value:\n111808\n`, 'string') }}"},{"name":"fecha","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters3_Value', `Es la fecha del turno\nTe puedes guiar por\nparameters3_Value:\n20250721`, 'string') }}"},{"name":"hora","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters4_Value', `Es la hora del turno te puedes guiar por\nparameters4_Value:\n1040`, 'string') }}"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"options":{"response":{"response":{"neverError":true,"responseFormat":"text","outputPropertyName":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Put_Output_in_Field', `Turno cancelado exitosamente\t\"OK\" (HTTP 200)\tâœ… \"OK\"\nTurno inexistente\t\"Turno inexistente.\" (HTTP 500)\tâœ… \"Turno inexistente.\"\nTurno ya cancelado\t\"El turno ya fue cancelado.\" (HTTP 500)\tâœ… \"El turno ya fue cancelado.\"\nError general\t\"Problema.\" (HTTP 500)\tâœ… \"Problema.\"`, 'string') }}"}},"timeout":30000}},"type":"n8n-nodes-base.httpRequestTool","typeVersion":4.2,"position":[-2728,2215],"id":"6e0b0f3d-7f8c-4042-91d6-f95467c28637","name":"eliminar_Turno1","retryOnFail":true},{"parameters":{"httpMethod":"POST","path":"agentes/v1/iclp","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-5620,1870],"id":"6231db91-27ea-4208-a78f-48c034aabed0","name":"Webhook1","webhookId":"ab81407a-fc2f-402c-8bd5-85a9551bde3e"},{"parameters":{"assignments":{"assignments":[{"id":"16d8fd1f-7293-45ec-ba41-6041979d7964","name":"accountId","value":"={{ $json.body.messages[0].account_id }}","type":"number"},{"id":"a8eb17ea-8fda-42e5-9f1c-444826a21e51","name":"message","value":"={{ $json.body.messages[0].content }}","type":"string"},{"id":"3fe92852-b569-426e-bef7-b755cf44ddc9","name":"inboxId","value":"={{ $json.body.contact_inbox.inbox_id }}","type":"number"},{"id":"96fa0ac2-a17b-452c-bf67-cc0f3bd5d4a2","name":"contactId","value":"={{ $json.body.messages[0].sender.id }}","type":"number"},{"id":"0d77d8b4-ec6d-42e0-8a5b-fdf1b78b454d","name":"contactName","value":"={{ $json.body.messages[0].sender.name }}","type":"string"},{"id":"25487cfb-897d-4000-9ad6-99745966c526","name":"contactNumber","value":"={{ $json.body.messages[0].sender.phone_number }}","type":"string"},{"id":"1e1b0044-b199-44e0-927b-c2cabe2a281b","name":"tokenChatwoot","value":"=rgqHjdPeBQpVpzt2iDR2RKLp","type":"string"},{"id":"ad5ef314-70d7-4790-b82e-ea96a340ae12","name":"chatwootUrlBase","value":"=https://chatw.automatizaciones.ai","type":"string"},{"id":"f4bc6964-862e-4168-8bae-94e6c6ad8321","name":"eventType","value":"={{ $json.body.event }}","type":"string"},{"id":"ef4c85e4-0029-4d70-ade1-0de74711b804","name":"conversationId","value":"={{ $json.body.id }}","type":"number"},{"id":"be91191b-7e8a-4406-af97-0a18e8100e7f","name":"multimedia","value":"={{ $json?.body?.messages?.[0]?.attachments?.[0]?.file_type ? true : false }}","type":"boolean"},{"id":"a3202993-c215-4502-bf56-e7e644b35a88","name":"humano","value":"={{ $json.body.custom_attributes.humano }}","type":"boolean"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-5400,1870],"id":"b0b772ff-70fe-4dcd-ac3f-10dd7dcc894f","name":"variables2"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"0db9a125-ce45-48fe-b722-efbed0fc42a4","leftValue":"={{ $json.body.messages[0].sender.type }}","rightValue":"agent_bot","operator":{"type":"string","operation":"notEquals"}},{"id":"7d71d302-596d-4330-b68c-1b0502f6c7cd","leftValue":"={{ $json.body.event }}","rightValue":"message_created","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"12a51caa-5e4c-46f3-a067-79f0a52ca94b","leftValue":"={{ $json.body.messages[0].attachments[0].file_type }}","rightValue":"=file","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"or"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[-5180,1870],"id":"7bb289f2-5334-42e9-abb5-740235d6bff2","name":"Filter2"},{"parameters":{"description":"Llama a este subflujo cuando se necesita saber los horarios disponibles de una especialidad","workflowId":{"__rl":true,"value":"9VbCzLdHQtztJk3X","mode":"list","cachedResultName":"Turno-especialidad-mas-proximo"},"workflowInputs":{"mappingMode":"defineBelow","value":{"especialidad":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('especialidad', `especialidad del medico encontrada desde obtener_medicos_especialidades o pgvector\n\nEs unicamente un dato de tipo 3 Caracteres como: CLI\nencontrada en la tabla \"codigo\"`, 'string') }}","dni":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('dni', `DNI o cedula de identidad provista por el paciente\n\nEjemplo: 42028075`, 'number') }}","fechaDesde":"={{ DateTime.now().setZone('America/Argentina/Buenos_Aires').toFormat('yyyyMMdd') }}"},"matchingColumns":[],"schema":[{"id":"especialidad","displayName":"especialidad","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"fechaDesde","displayName":"fechaDesde","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[-2608,2215],"id":"4aaa2c3f-e289-4c27-a1e1-e46fd6a6fd3e","name":"horarios_especialidad_disponibles1"},{"parameters":{"name":"Flujo_padron","description":"Verifica si un paciente estÃ¡ registrado en el padrÃ³n mÃ©dico mediante su DNI. Si no lo estÃ¡, permite empadronarlo enviando nombre completo, DNI, obra social y telÃ©fono. UsÃ¡ esta herramienta en cualquier momento en que necesites validar si el paciente ya existe en el sistema.","workflowId":{"__rl":true,"value":"gdiHQp4cbaJJhGdl","mode":"list","cachedResultName":"ICLP - Testing - Agente Padron"},"workflowInputs":{"mappingMode":"defineBelow","value":{"texto":"={{ $('variables2').item.json.message }}","celular":"={{ $('variables2').item.json.contactNumber }}","dni":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('dni', `Numero de documento de identidad del paciente\n\nPuede ser por ejemplo:\n42028075`, 'number') }}","paciente":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('paciente', `Nombre del paciente\n\nPuede ser por ejemplo:\nNicolas Lopez`, 'string') }}","obraSocial":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('obraSocial', `Obra social del paciente\n\nPuede ser por ejemplo:\nIOMA`, 'string') }}"},"matchingColumns":[],"schema":[{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"paciente","displayName":"paciente","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"texto","displayName":"texto","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"celular","displayName":"celular","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"obraSocial","displayName":"obraSocial","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.1,"position":[-2488,2215],"id":"39d88700-1f18-487c-bca7-7fa7b5d50864","name":"Flujo_padron1"},{"parameters":{"databaseId":256795,"tableId":606371,"returnAll":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Return_All', `Devuelve la lista completa de los medicos segun la especialidad que pidio el paciente`, 'boolean') }}","additionalOptions":{"order":{"fields":[{"field":4918220}]}}},"type":"n8n-nodes-base.baserowTool","typeVersion":1,"position":[-2368,2215],"id":"60b473c5-c1a9-4fa9-b488-7dc6bf6ffa62","name":"obtener_medicos_especialidades1","credentials":{"baserowApi":{"id":"ZpGSFHDmV88Zga8O","name":"Baserow account"}}},{"parameters":{"toolDescription":"Reprograma un turno existente (dni, matricula, fechaAnterior, horaAnterior, fechaNueva, horaNueva)","method":"POST","url":"http://iclp.ddns.net:7080/ws-turnos-rest-simple/api/turnos/reprogramar-turno","sendQuery":true,"queryParameters":{"parameters":[{"name":"password","value":"Y2xpb25lcw"},{"name":"usuario","value":"WSTRRED"},{"name":"matricula","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters2_Value', `NÃºmero de matrÃ­cula del mÃ©dico asignado al turno`, 'string') }}"},{"name":"dni","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters3_Value', `Documento Nacional de Identidad del paciente sin puntos ni guiones.`, 'string') }}"},{"name":"fechaAnterior","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters4_Value', `Fecha original del turno a reprogramar, en formato numÃ©rico AAAAMMDD (ejemplo: 20250819).`, 'string') }}"},{"name":"horaAnterior","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters5_Value', `Hora original del turno en formato 24 horas, sin separadores (ejemplo: 0930).`, 'string') }}"},{"name":"fechaNueva","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters6_Value', `Nueva fecha deseada para el turno, en formato numÃ©rico AAAAMMDD`, 'string') }}"},{"name":"horaNueva","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters7_Value', `Nueva hora deseada para el turno en formato 24 horas, sin separadores (ejemplo: 1230).`, 'string') }}"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"options":{"response":{"response":{"neverError":true,"responseFormat":"json"}},"timeout":30000}},"type":"n8n-nodes-base.httpRequestTool","typeVersion":4.2,"position":[-2248,2215],"id":"f6e3c4f0-9553-479e-b2c8-d5a2e9f0b028","name":"reprogramar_Turno1","retryOnFail":true},{"parameters":{"toolDescription":"Lista los turnos actuales de un paciente por DNI.Si la fecha es 8/07/2025 transformarla a 20250708","url":"http://iclp.ddns.net:7080/ws-turnos-rest-simple/api/turnos/lista-turnos-actuales","sendQuery":true,"queryParameters":{"parameters":[{"name":"usuario","value":"=WSTRRED"},{"name":"password","value":"=Y2xpb25lcw"},{"name":"dni","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters2_Value', `Documento de identidad proporcionado por el paciente`, 'string') }}"},{"name":"fecha","value":"={{ $now.setZone('America/Argentina/Buenos_Aires').toFormat('yyyyLLdd') }}"}]},"options":{"response":{"response":{"neverError":true}},"timeout":30000},"optimizeResponse":true,"dataField":"lista","fieldsToInclude":"selected","fields":"fecha, fechaString, hora, hora5digitos, matricula, nombreMedico, estudios"},"type":"n8n-nodes-base.httpRequestTool","typeVersion":4.2,"position":[-2128,2215],"id":"15b5e2d0-502b-4869-91b3-c812f52afeea","name":"Lista_Turnos1","retryOnFail":true},{"parameters":{"assignments":{"assignments":[{"id":"b936cc1e-c8a5-4e63-8fb4-7cebac541b1c","name":"asunto","value":"={{ $json.text.split('|')[0].trim() }}","type":"string"},{"id":"ff857062-0bab-4152-afd4-e233cd6a5228","name":"intencion","value":"={{ $json.text.split('|')[1].trim() }}","type":"string"},{"id":"dfa8e24c-9700-425b-a266-ac74fad744c8","name":"DNI","value":"={{ $json.text.split('|')[2].trim() }}","type":"string"},{"id":"0f3cb05d-dcbc-4cb8-b433-3f99f0ba46dc","name":"Medico","value":"={{ $json.text.split('|')[3].trim() }}","type":"string"},{"id":"cf930d93-53cb-46a4-b0d8-1623047cd50d","name":"Especialidad","value":"={{ $json.text.split('|')[4].trim() }}","type":"string"},{"id":"20a9667d-5578-451e-ac06-8f43e626a31f","name":"Fecha","value":"={{ ($json.text.split('|')[5] && $json.text.split('|')[5].split(':')[1] && $json.text.split('|')[5].split(':')[1].trim() !== \"\" ? $json.text.split('|')[5].split(':')[1].trim().replace(/\\s{2,}/g, ' ') : \"Sin Destino\") }}","type":"string"},{"id":"3328ab2d-9f56-408d-aca6-90beadf22628","name":"Hora","value":"={{ ($json.text.split('|')[6] ? $json.text.split('|')[6] : \"Sin Origen Especificado\").trim().replace(/\\s{2,}/g, ' ').split(':')[1].trim() }}","type":"string"},{"id":"adfe1884-ccac-4f9a-b06b-24f919943e6d","name":"ArchivosAdjuntos","value":"={{ $json.text.split('|')[7].trim() }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-5620,2655],"id":"3864f357-4210-4377-9b3b-bf6aef10fd73","name":"salida1"},{"parameters":{"conditions":{"options":{"caseSensitive":false,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"6dcbb235-081a-408e-a17c-b6eecd664150","leftValue":"={{ $json.intencionNormalizada }}","rightValue":"ESTUDIO_TURNO","operator":{"type":"string","operation":"equals"}},{"id":"75633605-352a-47b3-b870-7572fb978eec","leftValue":"={{ $json.tieneMultimedia }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"or"},"looseTypeValidation":true,"options":{"ignoreCase":true}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-4144,1995],"id":"57041179-356a-4e4c-97bf-4948f82da1d3","name":"If1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a0f7b709-29f4-42af-bf55-29ee500f2c07","leftValue":"={{ $json.multimedia }}","rightValue":"file","operator":{"type":"boolean","operation":"true","singleValue":true}},{"id":"474975e7-e71c-42e3-8907-97884381d9e9","leftValue":"={{ $json.humano }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"or"},"options":{"ignoreCase":false}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-4960,1870],"id":"cc9cabe7-067c-4142-a8d0-cf6cc4b345a8","name":"tieneMultimedia1"},{"parameters":{"workflowId":{"__rl":true,"value":"sJes6x6MKxKh7A0G","mode":"list","cachedResultName":"tipoEstudio Tool âš’ï¸âš’ï¸"},"workflowInputs":{"mappingMode":"defineBelow","value":{"accountId":"={{ $('variables2').item.json.accountId }}","conversationId":"={{ $('variables2').item.json.conversationId }}","contactId":"={{ $('variables2').item.json.contactId }}","message":"={{ $('variables2').item.json.message }}","inboxId":"={{ $('variables2').item.json.inboxId }}","humano":"={{ $('variables2').item.json.humano }}","chatwootUrlBase":"={{ $('variables2').item.json.chatwootUrlBase }}","tokenChatwoot":"={{ $('variables2').item.json.tokenChatwoot }}","tipoIntencion":"={{ $('Formateador1').item.json.intencionNormalizada }}"},"matchingColumns":[],"schema":[{"id":"accountId","displayName":"accountId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"conversationId","displayName":"conversationId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"contactId","displayName":"contactId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"message","displayName":"message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"inboxId","displayName":"inboxId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"humano","displayName":"humano","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"boolean","removed":false},{"id":"chatwootUrlBase","displayName":"chatwootUrlBase","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"tokenChatwoot","displayName":"tokenChatwoot","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"tipoIntencion","displayName":"tipoIntencion","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":true,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-3548,1720],"id":"2c63abc6-ad3f-448c-a5cb-fc7e1618f20a","name":"llamaToolStudios1"},{"parameters":{"mode":"insert","messages":{"messageValues":[{"type":"user","message":"={{ $json.message ?? $('variables2').item?.json?.message ?? '' }}"}]}},"type":"@n8n/n8n-nodes-langchain.memoryManager","typeVersion":1.1,"position":[-3924,1620],"id":"5bc1fe4f-c944-49a2-93ca-5fe60032ef3f","name":"Chat Memory Manager1"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-4144,1670],"id":"b655fc67-868b-4ea7-9161-5475c98b2cb7","name":"noOp1"},{"parameters":{"sessionIdType":"customKey","sessionKey":"=chat:{{ $('variables2').item.json.conversationId }}_iclp","sessionTTL":132800,"contextWindowLength":15},"type":"@n8n/n8n-nodes-langchain.memoryRedisChat","typeVersion":1.5,"position":[-3836,1840],"id":"7d865f23-4747-490b-b8e2-8724b9261d8f","name":"Redis Chat Memory1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{},"type":"@n8n/n8n-nodes-langchain.toolThink","typeVersion":1,"position":[-2008,2215],"id":"b8ddf81e-904c-4d84-92e6-600a40bd6fe0","name":"tool_think1"},{"parameters":{"promptType":"define","text":"=mensaje_usuario: {{ $('variables2').item.json.message }}\n","messages":{"messageValues":[{"message":"=# Sistema de ClasificaciÃ³n de Intenciones - ICLP WhatsApp\n\nEres un router de intenciÃ³n para WhatsApp del Instituto de CardiologÃ­a La Plata (ICLP). Tu funciÃ³n es clasificar la intenciÃ³n del mensaje, extraer datos clave y preservar el mensaje original.\n\n## DATOS DE CONTEXTO:\n- Nombre: {{ $('variables2').item.json.contactName }}\n- NÃºmero: {{ $('variables2').item.json.contactNumber }}\n- Conversation ID: {{ $('variables2').item.json.conversationId }}\n- Mensaje del usuario: {{ $('variables2').item.json.message }}\n\n## CATEGORÃAS DE INTENCIÃ“N (14 totales):\n\n### ðŸ¥ Turnos de Consultorio (3):\n1. **TURNO_CONSULTORIO** - Solicita turno para consulta mÃ©dica con profesional\n2. **CANCELA_TURNO_CONSULTORIO** - Cancela turno de consultorio existente\n3. **REPROGRAMA_TURNO_CONSULTORIO** - Cambia fecha/hora de consulta mÃ©dica\n\n### ðŸ”¬ Turnos de Estudios (3):\n4. **TURNO_ESTUDIO** - Solicita turno para estudio diagnÃ³stico\n5. **CANCELA_TURNO_ESTUDIO** - Cancela turno de estudio existente\n6. **REPROGRAMA_TURNO_ESTUDIO** - Cambia fecha/hora de estudio\n\n### â„¹ï¸ Solicitudes de InformaciÃ³n (3):\n7. **INFO_MEDICOS_ESPECIALIDADES** - Consulta sobre profesionales o especialidades\n8. **INFO_ESTUDIOS** - Pregunta quÃ© estudios realizan o informaciÃ³n sobre estudios\n9. **INFO_GENERAL** - Horarios, ubicaciÃ³n, telÃ©fonos, pÃ¡gina web, costos, obras sociales\n\n### ðŸš¨ Situaciones Especiales (5):\n10. **URGENCIA** - Emergencia mÃ©dica, sÃ­ntomas graves o dolor agudo\n11. **QUEJA_RECLAMO** - Expresa insatisfacciÃ³n, problema o queja\n12. **SALUDO_SMALLTALK** - Saludo, agradecimiento o charla casual\n13. **ARCHIVOS_ADJUNTOS** - EnvÃ­a documentos, imÃ¡genes o archivos\n14. **OTRO** - No encaja en ninguna categorÃ­a anterior\n\n## REGLAS DE CLASIFICACIÃ“N EXHAUSTIVAS:\n\n### ðŸ¥ TURNO_CONSULTORIO:\n**Palabras clave:** turno, consulta, cita, ver al doctor, atenciÃ³n\n**Frases tÃ­picas:**\n- \"Necesito turno con [especialidad/mÃ©dico]\"\n- \"Quiero consulta con cardiÃ³logo\"\n- \"Puedo sacar turno con el Dr...\"\n- \"Hay turnos disponibles para...\"\n- \"Primera vez que voy\" + contexto mÃ©dico\n\n### âŒ CANCELA_TURNO_CONSULTORIO:\n**Palabras clave:** cancelar, anular, dar de baja, no voy a poder\n**Frases tÃ­picas:**\n- \"Cancelar turno con Dr. [nombre]\"\n- \"No puedo ir a mi consulta\"\n- \"Dar de baja el turno del [fecha]\"\n**Regla:** Si no especifica si es consulta o estudio â†’ asumir CONSULTORIO\n\n### ðŸ”„ REPROGRAMA_TURNO_CONSULTORIO:\n**Palabras clave:** cambiar, reprogramar, mover, postergar, adelantar\n**Frases tÃ­picas:**\n- \"Cambiar turno del [fecha]\"\n- \"Puedo pasar mi consulta para otro dÃ­a\"\n- \"Necesito reprogramar con el Dr...\"\n\n### ðŸ”¬ TURNO_ESTUDIO:\n**Estudios comunes:** eco, ecocardiograma, eco doppler, holter, MAPA, ergometrÃ­a, electrocardiograma, ECG, prueba de esfuerzo, cateterismo\n**Frases tÃ­picas:**\n- \"Turno para holter\"\n- \"Necesito hacerme un eco\"\n- \"Tengo orden para ergometrÃ­a\"\n- \"Me mandaron a hacer un electrocardiograma\"\n\n### âŒ CANCELA_TURNO_ESTUDIO:\n**Identificadores:** Menciona estudio especÃ­fico + cancelar\n**Frases tÃ­picas:**\n- \"Cancelar el holter del martes\"\n- \"No voy a poder hacerme el eco\"\n- \"Anular turno de ergometrÃ­a\"\n\n### ðŸ”„ REPROGRAMA_TURNO_ESTUDIO:\n**Frases tÃ­picas:**\n- \"Cambiar fecha del eco doppler\"\n- \"Mover el turno del holter\"\n- \"Reprogramar mi ergometrÃ­a\"\n\n### â„¹ï¸ INFO_MEDICOS_ESPECIALIDADES:\n**Preguntas sobre:**\n- \"Â¿QuÃ© especialidades tienen?\"\n- \"Â¿Atiende el Dr. [nombre]?\"\n- \"Â¿Hay cardiÃ³logos?\"\n- \"Lista de mÃ©dicos\"\n- \"Â¿QuÃ© dÃ­as atiende [mÃ©dico]?\"\n\n### â„¹ï¸ INFO_ESTUDIOS:\n**Preguntas sobre:**\n- \"Â¿QuÃ© estudios hacen?\"\n- \"Â¿Hacen resonancias?\"\n- \"Â¿Realizan eco doppler?\"\n- \"InformaciÃ³n sobre el holter\"\n- \"Â¿En quÃ© consiste la ergometrÃ­a?\"\n\n### â„¹ï¸ INFO_GENERAL:\n**Preguntas sobre:**\n- Horarios de atenciÃ³n\n- DirecciÃ³n/ubicaciÃ³n\n- TelÃ©fonos de contacto\n- PÃ¡gina web\n- Obras sociales/prepagas aceptadas\n- Costos/precios (aunque no se pueden dar)\n- CÃ³mo sacar turno online\n- Recetas mÃ©dicas\n- PreparaciÃ³n para estudios\n\n### ðŸš¨ URGENCIA:\n**SÃ­ntomas de alerta:**\n- Dolor de pecho/opresiÃ³n\n- Falta de aire/ahogo\n- Desmayo/mareos severos\n- Palpitaciones fuertes\n- PresiÃ³n alta con sÃ­ntomas\n- \"Me siento muy mal\"\n- \"Es urgente\"/\"emergencia\"\n\n### ðŸ˜  QUEJA_RECLAMO:\n**Indicadores:**\n- Tono de enojo o frustraciÃ³n\n- \"Es la tercera vez que...\"\n- \"Mala atenciÃ³n\"\n- \"Nadie me responde\"\n- \"Hace dÃ­as que espero\"\n- Referencias a problemas previos\n\n### ðŸ‘‹ SALUDO_SMALLTALK:\n- Saludos: hola, buen dÃ­a, buenas tardes, buenas noches\n- Despedidas: gracias, hasta luego, chau\n- CortesÃ­a: por favor, disculpe\n- Sin contexto mÃ©dico adicional\n\n### ðŸ“Ž ARCHIVOS_ADJUNTOS:\n- Cuando el mensaje viene con archivos\n- \"EnvÃ­o mi orden mÃ©dica\"\n- \"Adjunto estudios\"\n- \"Mando foto de...\"\n\n## EXTRACCIÃ“N DE DATOS COMPLETA:\n\nExtraer TODOS estos campos si estÃ¡n presentes:\n- **Mensaje_Original**: El texto completo del usuario (SIEMPRE incluir)\n- **DNI**: 7-9 dÃ­gitos sin puntos (ej: 12345678)\n- **MÃ©dico**: Nombre del profesional mencionado\n- **Especialidad**: cardiologÃ­a, clÃ­nica mÃ©dica, etc.\n- **Fecha**: Convertir a yyyyMMdd (20240315 para 15 de marzo 2024)\n- **Hora**: Convertir a HHmm (1430 para 2:30 PM)\n- **DÃ­a_Semana**: lunes, martes, etc.\n- **Tipo_Estudio**: holter, eco, ergometrÃ­a, etc.\n- **Obra_Social**: IOMA, OSDE, particular, etc.\n- **TelÃ©fono**: Si proporciona nÃºmero de contacto\n- **Email**: Si proporciona correo\n- **Archivos**: Si/No\n\n## FORMATO DE SALIDA ESTRICTO:\n\n```\n[Mensaje original completo] | [Resumen en 3-5 palabras] | IntenciÃ³n:[CATEGORIA] | DNI:[valor o N/D] | Medico:[valor o N/D] | Especialidad:[valor o N/D] | Fecha:[yyyyMMdd o N/D] | Hora:[HHmm o N/D] | Dia:[valor o N/D] | Estudio:[valor o N/D] | ObraSocial:[valor o N/D] | Telefono:[valor o N/D] | Email:[valor o N/D] | Archivos:[Si/No]\n```\n\n## EJEMPLOS COMPLETOS:\n\n**Entrada:** \"Hola, buen dÃ­a\"\n**Salida:** `Hola, buen dÃ­a | Saludo cordial | IntenciÃ³n:SALUDO_SMALLTALK | DNI:N/D | Medico:N/D | Especialidad:N/D | Fecha:N/D | Hora:N/D | Dia:N/D | Estudio:N/D | ObraSocial:N/D | Telefono:N/D | Email:N/D | Archivos:No`\n\n**Entrada:** \"Necesito turno con cardiÃ³logo para la semana que viene, mi DNI es 25789456, tengo IOMA\"\n**Salida:** `Necesito turno con cardiÃ³logo para la semana que viene, mi DNI es 25789456, tengo IOMA | Solicita turno cardiologÃ­a | IntenciÃ³n:TURNO_CONSULTORIO | DNI:25789456 | Medico:N/D | Especialidad:CardiologÃ­a | Fecha:N/D | Hora:N/D | Dia:N/D | Estudio:N/D | ObraSocial:IOMA | Telefono:N/D | Email:N/D | Archivos:No`\n\n**Entrada:** \"Quiero cancelar el eco doppler que tengo el viernes 20 a las 10:30\"\n**Salida:** `Quiero cancelar el eco doppler que tengo el viernes 20 a las 10:30 | Cancela estudio programado | IntenciÃ³n:CANCELA_TURNO_ESTUDIO | DNI:N/D | Medico:N/D | Especialidad:N/D | Fecha:20240320 | Hora:1030 | Dia:viernes | Estudio:Eco doppler | ObraSocial:N/D | Telefono:N/D | Email:N/D | Archivos:No`\n\n**Entrada:** \"Me duele mucho el pecho y me falta el aire, necesito ayuda\"\n**Salida:** `Me duele mucho el pecho y me falta el aire, necesito ayuda | Emergencia sÃ­ntomas cardÃ­acos | IntenciÃ³n:URGENCIA | DNI:N/D | Medico:N/D | Especialidad:N/D | Fecha:N/D | Hora:N/D | Dia:N/D | Estudio:N/D | ObraSocial:N/D | Telefono:N/D | Email:N/D | Archivos:No`\n\n**Entrada:** \"El Dr. FernÃ¡ndez me dijo que pida turno para holter de 24hs, mi obra social es OSDE 210\"\n**Salida:** `El Dr. FernÃ¡ndez me dijo que pida turno para holter de 24hs, mi obra social es OSDE 210 | Solicita holter por derivaciÃ³n | IntenciÃ³n:TURNO_ESTUDIO | DNI:N/D | Medico:Dr. FernÃ¡ndez | Especialidad:N/D | Fecha:N/D | Hora:N/D | Dia:N/D | Estudio:Holter 24hs | ObraSocial:OSDE 210 | Telefono:N/D | Email:N/D | Archivos:No`\n\n**Entrada:** \"Â¿Atienden los sÃ¡bados? Â¿Hasta quÃ© hora?\"\n**Salida:** `Â¿Atienden los sÃ¡bados? Â¿Hasta quÃ© hora? | Consulta horarios sÃ¡bado | IntenciÃ³n:INFO_GENERAL | DNI:N/D | Medico:N/D | Especialidad:N/D | Fecha:N/D | Hora:N/D | Dia:sÃ¡bado | Estudio:N/D | ObraSocial:N/D | Telefono:N/D | Email:N/D | Archivos:No`\n\n## CASOS ESPECIALES Y AMBIGUOS:\n\n1. **\"Quiero un turno\"** (sin especificar) â†’ TURNO_CONSULTORIO\n2. **\"Cancelar turno\"** (sin especificar) â†’ CANCELA_TURNO_CONSULTORIO\n3. **\"Para maÃ±ana\"** â†’ Calcular fecha del dÃ­a siguiente\n4. **\"La semana que viene\"** â†’ No calcular fecha especÃ­fica, dejar N/D\n5. **MÃºltiples intenciones** â†’ Elegir la PRINCIPAL\n6. **Mensaje confuso** â†’ OTRO\n7. **Pregunta de costo + turno** â†’ Priorizar TURNO sobre INFO\n\n## VALIDACIONES CRÃTICAS:\n\nâœ“ SIEMPRE incluir el mensaje original completo como primer campo\nâœ“ Usar EXACTAMENTE 14 campos separados por |\nâœ“ No inventar datos - usar N/D si no estÃ¡ presente\nâœ“ Fechas futuras en formato yyyyMMdd\nâœ“ Horas en formato 24h sin separadores\nâœ“ Una sola lÃ­nea de salida\nâœ“ Sin explicaciones adicionales\nâœ“ CategorÃ­a debe ser una de las 14 definidas\n\n## REGLA FINAL ABSOLUTA:\nSi tienes duda entre dos categorÃ­as, usa esta jerarquÃ­a de prioridad:\n1. URGENCIA (siempre tiene prioridad mÃ¡xima)\n2. TURNOS (agendar/cancelar/reprogramar)\n3. INFORMACIÃ“N\n4. OTROS"}]},"batching":{}},"type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.7,"position":[-4740,1895],"id":"d0b37b20-930e-48a4-b922-f260f1f6fe7b","name":"Analista de ConversaciÃ³n1"},{"parameters":{"jsCode":"// n8n Code node â€” Parser Router ICLP\n// Modo: Run Once for Each Item\n// Entrada principal: $json.text (o $json.output) desde el LLM\n\n// 1) Texto del LLM\nconst line = String($json.text ?? $json.output ?? \"\").trim();\n\n// 2) (Opcional) Contexto de \"variables\" SIN cablear ese nodo\nconst vars = (() => {\n  try {\n    const it = $items('variables2', 0, 0);\n    return it.length ? (it[0].json ?? {}) : {};\n  } catch { return {}; }\n})();\n\n// 3) (Opcional) Multimedia SIN cablear ese nodo\nconst mm = (() => {\n  try {\n    const it = $items('tieneMultimedia1', 0, 0);\n    return it.length ? (it[0].json ?? {}) : {};\n  } catch { return {}; }\n})();\n\n// ---- Helpers ----\nfunction tokenMap(s) {\n  const parts = s.split(\"|\").map(p => p.trim());\n  const map = {};\n  for (const p of parts) {\n    const idx = p.indexOf(\":\");\n    if (idx > -1) {\n      const k = p.slice(0, idx).trim().toLowerCase();\n      const v = p.slice(idx + 1).trim();\n      map[k] = v;\n    }\n  }\n  return { parts, map };\n}\n\nfunction ndToNull(v) {\n  if (v == null) return null;\n  const t = String(v).trim();\n  return (t === \"\" || t.toUpperCase() === \"N/D\") ? null : t;\n}\n\nfunction normInt(s) {\n  if (!s) return \"OTRO\";\n  s = s.toUpperCase();\n  if (s.includes(\"CONSULTORIO_AGENDAR\")) return \"CONSULTORIO_AGENDAR\";\n  if (s.includes(\"CONSULTORIO_CANCELAR\")) return \"CONSULTORIO_CANCELAR\";\n  if (s.includes(\"CONSULTORIO_REPROGRAMAR\")) return \"CONSULTORIO_REPROGRAMAR\";\n  if (s.includes(\"INFO_MEDICOS\") || s.includes(\"ESPECIALIDADES\")) return \"INFO_MEDICOS_ESPECIALIDADES\";\n  if (s.includes(\"QUEJA\") || s.includes(\"RECLAM\")) return \"QUEJA_RECLAMO\";\n  if (s.includes(\"INFO_ESTUDIOS\")) return \"INFO_ESTUDIOS\";\n  if (s.includes(\"ESTUDIO_TURNO\") || s.includes(\"TURNO_ESTUDIO\")) return \"ESTUDIO_TURNO\"; // ambas variantes\n  if (s.includes(\"URGENCIA\")) return \"URGENCIA\";\n  if (s.includes(\"SALUDO\") || s.includes(\"SMALLTALK\")) return \"SALUDO_SMALLTALK\";\n  if (s.includes(\"ARCHIVOS\")) return \"ARCHIVOS_ADJUNTOS\";\n  return \"OTRO\";\n}\n\n// ---- Parseo del renglÃ³n del LLM ----\nconst { parts, map } = tokenMap(line);\n\n// parts[0] suele ser descripciÃ³n, parts[1] un resumen opcional\nconst intentRaw = map[\"intenciÃ³n\"] ?? map[\"intencion\"] ?? null;\n\nconst resultado = {\n  descripcion: parts[0] ?? \"\",\n  resumen: parts[1] ?? \"\",\n  intencion: intentRaw,\n  intencionNormalizada: normInt(intentRaw),\n\n  paciente: {\n    dni: ndToNull(map[\"dni\"]),\n    nombre: vars.contactName ?? null,\n    telefono: ndToNull(map[\"telefono\"]) ?? vars.contactNumber ?? null,\n    email: ndToNull(map[\"email\"]),\n    obraSocial: ndToNull(map[\"obrasocial\"]),\n    conversationId: vars.conversationId ?? null,\n  },\n\n  datosMedicos: {\n    medico: ndToNull(map[\"medico\"]),\n    especialidad: ndToNull(map[\"especialidad\"]),\n    fecha: ndToNull(map[\"fecha\"]),\n    hora: ndToNull(map[\"hora\"]),\n    diaSemana: ndToNull(map[\"dia\"]),\n    tipoEstudio: ndToNull(map[\"estudio\"]),\n  },\n\n  archivos: {\n    tiene: (String(map[\"archivos\"] ?? \"\").toLowerCase().startsWith(\"si\") || !!mm.multimedia) || false,\n    tipo: null,\n  },\n\n  // Control de flujo\n  requiereAccion: true,\n  tipoAccion: null,\n  siguientePaso: null,\n  datosCompletos: true,\n  datosFaltantes: [],\n  flujo: {},\n  respuestaDirecta: null,\n\n  // Debug\n  respuestaOriginal: line,\n  procesadoEn: new Date().toISOString(),\n};\n\n// ---- Acciones y validaciones por intenciÃ³n ----\nswitch (resultado.intencionNormalizada) {\n  case \"URGENCIA\":\n    resultado.tipoAccion = \"RESPUESTA_URGENCIA\";\n    resultado.siguientePaso = \"responder_emergencia\";\n    break;\n\n  case \"SALUDO_SMALLTALK\":\n    resultado.tipoAccion = \"SALUDO_INICIAL\";\n    resultado.siguientePaso = \"mostrar_menu_principal\";\n    resultado.respuestaDirecta = `Gracias por comunicarte con Instituto de CardiologÃ­a La Plata â¤ï¸\nLEER CON ATENCIÃ“N â€¼ï¸\n\nðŸ•› HORARIO: Lunes a Viernes 8 a 20 hs\n\nðŸ“ PARA TURNOS INDICAR SI ES:\n  - Consulta MÃ©dica\n  - Estudio\n\nSi necesitÃ¡s una Consulta, decime especialidad o nombre del profesional y tu DNI.\nSi es para un Estudio, te derivo con recepciÃ³n para que te asistan rÃ¡pido.\n\nâ” TambiÃ©n ayudamos con:\n- Â¿DÃ³nde envÃ­o mis recetas?\n- Â¿CuÃ¡l es el horario de atenciÃ³n?\n- Â¿QuÃ© especialidades tienen?\n- Â¿DÃ³nde saco turno por la web?\n\nðŸš« NO RECIBIMOS LLAMADAS POR ESTE MEDIO ðŸš«`;\n    resultado.flujo.usarRespuestaDirecta = true;\n    break;\n\n  case \"CONSULTORIO_AGENDAR\":\n    resultado.tipoAccion = \"INICIAR_AGENDAMIENTO\";\n    resultado.siguientePaso = \"validar_paciente_padron\";\n    if (!resultado.paciente.dni) { resultado.datosFaltantes.push(\"DNI\"); resultado.datosCompletos = false; }\n    if (!resultado.datosMedicos.medico && !resultado.datosMedicos.especialidad) {\n      resultado.datosFaltantes.push(\"MÃ©dico o Especialidad\");\n      resultado.datosCompletos = false;\n    }\n    break;\n\n  case \"CONSULTORIO_CANCELAR\":\n    resultado.tipoAccion = \"INICIAR_CANCELACION\";\n    resultado.siguientePaso = \"buscar_turnos_activos\";\n    if (!resultado.paciente.dni) { resultado.datosFaltantes.push(\"DNI\"); resultado.datosCompletos = false; }\n    break;\n\n  case \"CONSULTORIO_REPROGRAMAR\":\n    resultado.tipoAccion = \"INICIAR_REPROGRAMACION\";\n    resultado.siguientePaso = \"buscar_turnos_para_cambiar\";\n    if (!resultado.paciente.dni) { resultado.datosFaltantes.push(\"DNI\"); resultado.datosCompletos = false; }\n    break;\n\n  case \"ESTUDIO_TURNO\":\n    resultado.tipoAccion = \"DERIVAR_HUMANO\";\n    resultado.siguientePaso = \"llamar_tool_studios\";\n    break;\n\n  case \"INFO_ESTUDIOS\":\n    resultado.tipoAccion = \"INFORMAR_ESTUDIOS\";\n    resultado.siguientePaso = \"obtener_lista_estudios\";\n    break;\n\n  case \"INFO_MEDICOS_ESPECIALIDADES\":\n    resultado.tipoAccion = \"INFORMAR_PROFESIONALES\";\n    resultado.siguientePaso = \"obtener_medicos_especialidades\";\n    break;\n\n  case \"QUEJA_RECLAMO\":\n    resultado.tipoAccion = \"GESTIONAR_RECLAMO\";\n    resultado.siguientePaso = \"derivar_supervisor\";\n    break;\n\n  default:\n    resultado.tipoAccion = \"PROCESAR_CON_AGENTE\";\n    resultado.siguientePaso = \"agente_conversacional\";\n}\n\n// Flags de flujo\nresultado.flujo = {\n  ...resultado.flujo,\n  debeUsarAgente: ![\"URGENCIA\", \"SALUDO_SMALLTALK\", \"ESTUDIO_TURNO\"].includes(resultado.intencionNormalizada),\n  debeDerivar: resultado.intencionNormalizada === \"ESTUDIO_TURNO\",\n  esEmergencia: resultado.intencionNormalizada === \"URGENCIA\",\n  esPrimerContacto: resultado.intencionNormalizada === \"SALUDO_SMALLTALK\",\n  necesitaDatosAdicionales: !resultado.datosCompletos,\n};\n\n// Mensaje sugerido si faltan datos\nif (!resultado.datosCompletos && resultado.datosFaltantes.length) {\n  resultado.mensajeSugerido = `Para poder ayudarte mejor, necesito que me proporciones: ${resultado.datosFaltantes.join(\", \")}`;\n}\n\n// Salida SIEMPRE como array de items\nreturn [{ json: resultado }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-4364,1995],"id":"7156605d-23c4-4a8b-8468-70eb35a33e9b","name":"Formateador1"}],"connections":{"obtener_medicos_matricula":{"ai_tool":[[{"node":"Agente conversacional","type":"ai_tool","index":0}]]},"obtener_estudios":{"ai_tool":[[{"node":"Agente conversacional","type":"ai_tool","index":0}]]},"horarios_medicos_disponibles":{"ai_tool":[[{"node":"Agente conversacional","type":"ai_tool","index":0}]]},"tomar_turno_paciente":{"ai_tool":[[{"node":"Agente conversacional","type":"ai_tool","index":0}]]},"Agente conversacional":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"SendText","type":"main","index":0}]]},"LLM":{"ai_languageModel":[[{"node":"Agente conversacional","type":"ai_languageModel","index":0},{"node":"Analista de ConversaciÃ³n","type":"ai_languageModel","index":0}]]},"MEMORY":{"ai_memory":[[{"node":"Agente conversacional","type":"ai_memory","index":0}]]},"eliminar_Turno":{"ai_tool":[[{"node":"Agente conversacional","type":"ai_tool","index":0}]]},"Webhook":{"main":[[{"node":"variables","type":"main","index":0},{"node":"Execution Data","type":"main","index":0}]]},"variables":{"main":[[{"node":"Filter","type":"main","index":0}]]},"Filter":{"main":[[{"node":"tieneMultimedia","type":"main","index":0}]]},"horarios_especialidad_disponibles":{"ai_tool":[[{"node":"Agente conversacional","type":"ai_tool","index":0}]]},"Flujo_padron":{"ai_tool":[[{"node":"Agente conversacional","type":"ai_tool","index":0}]]},"obtener_medicos_especialidades":{"ai_tool":[[{"node":"Agente conversacional","type":"ai_tool","index":0}]]},"reprogramar_Turno":{"ai_tool":[[{"node":"Agente conversacional","type":"ai_tool","index":0}]]},"Lista_Turnos":{"ai_tool":[[{"node":"Agente conversacional","type":"ai_tool","index":0}]]},"If":{"main":[[{"node":"Chat Memory Manager","type":"main","index":0}],[{"node":"Agente conversacional","type":"main","index":0}]]},"tieneMultimedia":{"main":[[{"node":"noOp","type":"main","index":0}],[{"node":"Analista de ConversaciÃ³n","type":"main","index":0}]]},"noOp":{"main":[[{"node":"Chat Memory Manager","type":"main","index":0}]]},"Chat Memory Manager":{"main":[[{"node":"llamaToolStudios","type":"main","index":0}]]},"Redis Chat Memory":{"ai_memory":[[{"node":"Chat Memory Manager","type":"ai_memory","index":0}]]},"tool_think":{"ai_tool":[[{"node":"Agente conversacional","type":"ai_tool","index":0}]]},"Analista de ConversaciÃ³n":{"main":[[{"node":"Formateador","type":"main","index":0}]]},"Formateador":{"main":[[{"node":"If","type":"main","index":0}]]},"Switch":{"main":[[{"node":"multimediaProccess","type":"main","index":0}],[],[{"node":"bufferMessages","type":"main","index":0}]]},"bufferMessages":{"main":[[{"node":"unifiedText","type":"main","index":0}]]},"multimediaProccess":{"main":[[{"node":"unifiedText","type":"main","index":0}]]},"variables1":{"main":[[{"node":"Filter1","type":"main","index":0}]]},"Filter1":{"main":[[{"node":"Switch","type":"main","index":0}]]},"Prompt_Base_Config":{"main":[[{"node":"Prompt_Dinamico_Generator","type":"main","index":0}]]},"Prompt_Dinamico_Generator":{"main":[[{"node":"Agente conversacional1","type":"main","index":0}]]},"Rate_Limiter":{"main":[[{"node":"API_Delay","type":"main","index":0}]]},"API_Delay":{"main":[[{"node":"Cache_Check","type":"main","index":0}]]},"Cache_Check":{"main":[[{"node":"Cache_Update","type":"main","index":0}]]},"Cache_Update":{"main":[[{"node":"Error_Handler_Baserow","type":"main","index":0}]]},"Error_Handler_Baserow":{"main":[[{"node":"Check_Error","type":"main","index":0}]]},"Check_Error":{"main":[[{"node":"Agente conversacional1","type":"main","index":0},{"node":"Fallback_Response","type":"main","index":0}]]},"obtener_medicos_matricula1":{"ai_tool":[[{"node":"Agente conversacional1","type":"ai_tool","index":0}]]},"obtener_estudios1":{"ai_tool":[[{"node":"Agente conversacional1","type":"ai_tool","index":0}]]},"horarios_medicos_disponibles1":{"ai_tool":[[{"node":"Agente conversacional1","type":"ai_tool","index":0}]]},"tomar_turno_paciente1":{"ai_tool":[[{"node":"Agente conversacional1","type":"ai_tool","index":0}]]},"Agente conversacional1":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Code1":{"main":[[{"node":"SendText1","type":"main","index":0}]]},"LLM1":{"ai_languageModel":[[{"node":"Agente conversacional1","type":"ai_languageModel","index":0},{"node":"Analista de ConversaciÃ³n1","type":"ai_languageModel","index":0}]]},"MEMORY1":{"ai_memory":[[{"node":"Agente conversacional1","type":"ai_memory","index":0}]]},"eliminar_Turno1":{"ai_tool":[[{"node":"Agente conversacional1","type":"ai_tool","index":0}]]},"Webhook1":{"main":[[{"node":"variables2","type":"main","index":0}]]},"variables2":{"main":[[{"node":"Filter2","type":"main","index":0}]]},"Filter2":{"main":[[{"node":"tieneMultimedia1","type":"main","index":0}]]},"horarios_especialidad_disponibles1":{"ai_tool":[[{"node":"Agente conversacional1","type":"ai_tool","index":0}]]},"Flujo_padron1":{"ai_tool":[[{"node":"Agente conversacional1","type":"ai_tool","index":0}]]},"obtener_medicos_especialidades1":{"ai_tool":[[{"node":"Agente conversacional1","type":"ai_tool","index":0}]]},"reprogramar_Turno1":{"ai_tool":[[{"node":"Agente conversacional1","type":"ai_tool","index":0}]]},"Lista_Turnos1":{"ai_tool":[[{"node":"Agente conversacional1","type":"ai_tool","index":0}]]},"If1":{"main":[[{"node":"Chat Memory Manager1","type":"main","index":0}],[{"node":"Prompt_Base_Config","type":"main","index":0}]]},"tieneMultimedia1":{"main":[[{"node":"noOp1","type":"main","index":0}],[{"node":"Analista de ConversaciÃ³n1","type":"main","index":0}]]},"Chat Memory Manager1":{"main":[[{"node":"llamaToolStudios1","type":"main","index":0}]]},"noOp1":{"main":[[{"node":"Chat Memory Manager1","type":"main","index":0}]]},"Redis Chat Memory1":{"ai_memory":[[{"node":"Chat Memory Manager1","type":"ai_memory","index":0}]]},"tool_think1":{"ai_tool":[[{"node":"Agente conversacional1","type":"ai_tool","index":0}]]},"Analista de ConversaciÃ³n1":{"main":[[{"node":"Formateador1","type":"main","index":0}]]},"Formateador1":{"main":[[{"node":"If1","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{"Webhook":[{"json":{"headers":{"host":"hooks.autoclinicas.com","user-agent":"rest-client/2.1.0 (linux-musl x86_64) ruby/3.4.4p34","content-length":"2604","accept":"application/json","accept-encoding":"gzip;q=1.0,deflate;q=0.6,identity;q=0.3","content-type":"application/json","x-forwarded-for":"206.81.1.93","x-forwarded-host":"hooks.autoclinicas.com","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"0efcae3bc99e","x-real-ip":"206.81.1.93"},"params":{},"query":{},"body":{"additional_attributes":{},"can_reply":true,"channel":"Channel::Whatsapp","contact_inbox":{"id":1179,"contact_id":604,"inbox_id":3,"source_id":"5492213994411","created_at":"2025-07-31T03:21:27.355Z","updated_at":"2025-07-31T03:21:27.355Z","hmac_verified":false,"pubsub_token":"e8N3PaFx7sqrYBJ1wm2GK6rJ"},"id":2907,"inbox_id":3,"messages":[{"id":34290,"content":null,"account_id":2,"inbox_id":3,"conversation_id":2907,"message_type":0,"created_at":1755665607,"updated_at":"2025-08-20T04:53:27.165Z","private":false,"status":"sent","source_id":"wamid.HBgNNTQ5MjIxMzk5NDQxMRUCABIYFDNBNkZDOEZEQzYzOTAyMDZCMjBCAA==","content_type":"text","content_attributes":{},"sender_type":"Contact","sender_id":604,"external_source_ids":{},"additional_attributes":{},"processed_message_content":null,"sentiment":{},"conversation":{"assignee_id":null,"unread_count":1,"last_activity_at":1755665607,"contact_inbox":{"source_id":"5492213994411"}},"attachments":[{"id":2421,"message_id":34290,"file_type":"image","account_id":2,"extension":null,"data_url":"https://chatw.automatizaciones.ai/rails/active_storage/blobs/redirect/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBcGNLIiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--8cf190dc6f74f76bfa0df3ddbf82a579d0754d4f/File.jpg","thumb_url":"https://chatw.automatizaciones.ai/rails/active_storage/representations/redirect/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBcGNLIiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--8cf190dc6f74f76bfa0df3ddbf82a579d0754d4f/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCem9MWm05eWJXRjBTU0lJYW5CbkJqb0dSVlE2RTNKbGMybDZaVjkwYjE5bWFXeHNXd2RwQWZvdyIsImV4cCI6bnVsbCwicHVyIjoidmFyaWF0aW9uIn19--31a1f63818a5159f71dca8446fe68168fe417ce5/File.jpg","file_size":6529,"width":null,"height":null}],"sender":{"additional_attributes":{},"custom_attributes":{},"email":null,"id":604,"identifier":null,"name":"Nm","phone_number":"+5492213994411","thumbnail":"","blocked":false,"type":"contact"}}],"labels":[],"meta":{"sender":{"additional_attributes":{},"custom_attributes":{},"email":null,"id":604,"identifier":null,"name":"Nm","phone_number":"+5492213994411","thumbnail":"","blocked":false,"type":"contact"},"assignee":null,"team":null,"hmac_verified":false},"status":"pending","custom_attributes":{},"snoozed_until":null,"unread_count":1,"first_reply_created_at":"2025-08-20T04:51:35.984Z","priority":null,"waiting_since":1755665504,"agent_last_seen_at":1755665561,"contact_last_seen_at":0,"last_activity_at":1755665607,"timestamp":1755665607,"created_at":1755663868,"updated_at":1755665607.169528,"applied_sla":null,"sla_events":[],"sla_policy_id":null,"event":"automation_event.message_created"},"webhookUrl":"https://hooks.autoclinicas.com/webhook/agentes/v1/iclp","executionMode":"production"}}],"Webhook1":[{"json":{"headers":{"host":"hooks.autoclinicas.com","user-agent":"rest-client/2.1.0 (linux-musl x86_64) ruby/3.4.4p34","content-length":"1812","accept":"application/json","accept-encoding":"gzip;q=1.0,deflate;q=0.6,identity;q=0.3","content-type":"application/json","x-forwarded-for":"206.81.1.93","x-forwarded-host":"hooks.autoclinicas.com","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"0efcae3bc99e","x-real-ip":"206.81.1.93"},"params":{},"query":{},"body":{"additional_attributes":{},"can_reply":true,"channel":"Channel::Whatsapp","contact_inbox":{"id":1179,"contact_id":604,"inbox_id":3,"source_id":"5492213994411","created_at":"2025-07-31T03:21:27.355Z","updated_at":"2025-07-31T03:21:27.355Z","hmac_verified":false,"pubsub_token":"e8N3PaFx7sqrYBJ1wm2GK6rJ"},"id":2505,"inbox_id":3,"messages":[{"id":28998,"content":"Hola si quiero un turno con genovesi","account_id":2,"inbox_id":3,"conversation_id":2505,"message_type":0,"created_at":1755199859,"updated_at":"2025-08-14T19:30:59.662Z","private":false,"status":"sent","source_id":"wamid.HBgNNTQ5MjIxMzk5NDQxMRUCABIYFDNBMDgxMjlGQzFFNTIzOTJCNDY4AA==","content_type":"text","content_attributes":{},"sender_type":"Contact","sender_id":604,"external_source_ids":{},"additional_attributes":{},"processed_message_content":"Hola si quiero un turnocon genovesi","sentiment":{},"conversation":{"assignee_id":null,"unread_count":1,"last_activity_at":1755199859,"contact_inbox":{"source_id":"5492213994411"}},"sender":{"additional_attributes":{},"custom_attributes":{},"email":null,"id":604,"identifier":null,"name":"Nm","phone_number":"+5492213994411","thumbnail":"","blocked":false,"type":"contact"}}],"labels":[],"meta":{"sender":{"additional_attributes":{},"custom_attributes":{},"email":null,"id":604,"identifier":null,"name":"Nm","phone_number":"+5492213994411","thumbnail":"","blocked":false,"type":"contact"},"assignee":null,"team":null,"hmac_verified":false},"status":"pending","custom_attributes":{},"snoozed_until":null,"unread_count":1,"first_reply_created_at":null,"priority":null,"waiting_since":1755199794,"agent_last_seen_at":1755199799,"contact_last_seen_at":0,"last_activity_at":1755199859,"timestamp":1755199859,"created_at":1755199794,"updated_at":1755199859.6670022,"event":"automation_event.message_created"},"webhookUrl":"https://hooks.autoclinicas.com/webhook/agentes/v1/iclp","executionMode":"production"}}]},"versionId":"9bb56ebd-6290-44cc-9443-3b163e622c10","triggerCount":1,"shared":[{"createdAt":"2025-08-18T01:37:48.280Z","updatedAt":"2025-08-18T01:37:48.280Z","role":"workflow:owner","workflowId":"PAXMSFTYUhKA5kqc","projectId":"R66ikVn5xqf0nYcA"}],"tags":[]}