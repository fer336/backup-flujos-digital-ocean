{"createdAt":"2025-10-24T05:06:16.254Z","updatedAt":"2025-10-29T21:00:46.506Z","id":"gIhBDLybkhqRwiWz","name":"MASTER - REFACTORIZACION 2025-10-27T05:05","active":false,"isArchived":true,"nodes":[{"parameters":{"assignments":{"assignments":[{"id":"account-id","name":"accountId","value":"={{ $json.body.messages[0].account_id }}","type":"number"},{"id":"message","name":"message","value":"={{ $json.body.messages[0].content }}","type":"string"},{"id":"inbox-id","name":"inboxId","value":"={{ $json.body.contact_inbox.inbox_id }}","type":"number"},{"id":"contact-id","name":"contactId","value":"={{ $json.body.messages[0].sender.id }}","type":"number"},{"id":"contact-name","name":"contactName","value":"={{ $json.body.messages[0].sender.name }}","type":"string"},{"id":"contact-number","name":"contactNumber","value":"={{ $json.body.messages[0].sender.phone_number }}","type":"string"},{"id":"conversation-id","name":"conversationId","value":"={{ $json.body.id }}","type":"number"},{"id":"multimedia","name":"multimedia","value":"={{ $json?.body?.messages?.[0]?.attachments?.[0]?.file_type ? true : false }}","type":"boolean"},{"id":"humano","name":"humano","value":"={{ $json.body.custom_attributes.humano }}","type":"boolean"},{"id":"chatwoot-url","name":"chatwootUrl","value":"https://chatw.automatizaciones.ai","type":"string"},{"id":"token-bot","name":"agenteBotTokenWhatsapp","value":"JFi43nzvEPDBCaxaFrkhVvdM","type":"string"},{"id":"fcd30a41-417f-4ca5-8b22-7ee673628621","name":"rowId","value":"","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2208,-624],"id":"6897d426-6eaa-4712-a418-4deca3c562a7","name":"Variables"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.multimedia }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true},"id":"multimedia-check"}],"combinator":"and"},"renameOutput":true,"outputKey":"tieneMultimedia"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"humano-check","leftValue":"={{ $json.humano }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"tieneHumano"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"texto-check","leftValue":"={{ $json.message }}","rightValue":"Texto","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"tieneTexto"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-1680,-528],"id":"d89565c1-891f-4387-883e-6dae2a93b5dc","name":"Filtro Tipo Mensaje"},{"parameters":{"operation":"get","propertyName":"status","key":"=status:{{ $('Filtro Tipo Mensaje').item.json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-416,-384],"id":"00a79d56-2bf9-414c-a1cd-c935d2e6a900","name":"üîç Get Estado Actual","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Variables').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"image\",\n      \"image\": {\n        \"link\": \"https://i.imgur.com/cSVuheF.png\"\n      }\n    },\n    \"body\": {\n      \"text\": \"üëã ¬°HOLA! BIENVENIDO AL ICLP\\n\\nü§ñ BOT: DISPONIBLE 24/7\\n\\nüìû ATENCI√ìN TELEF√ìNICA Y ADMINISTRATIVA:\\nLUNES A VIERNES 8-20HS | S√ÅBADO 8-13HS\\n\\nSELECCION√Å UNA OPCI√ìN:\\n\\nüìÖ TURNOS (BOT)\\n- AGENDAR, CONSULTAR O CANCELAR\\n\\n‚ÑπÔ∏è INFO GENERAL (BOT)\\n- HORARIOS, UBICACI√ìN Y M√ÅS\\n\\nüè¢ ADMINISTRACI√ìN (PERSONAL ADMINISTRATIVO)\\n* CONSULTAS Y RECLAMOS\\n* RESPUESTA EN HORARIO DE ATENCI√ìN\"\n    },\n    \"footer\": {\n      \"text\": \"SELECCION√Å UNA OPCI√ìN üëá\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"turnos\",\n            \"title\": \"üìÖ TURNOS\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"info-general\",\n            \"title\": \"‚ÑπÔ∏è INFO GENERAL\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"administracion\",\n            \"title\": \"üè¢ ADMINISTRACION\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2448,-1248],"id":"96bbf6e8-30e1-4d20-8b61-20f72c103d3a","name":"üì± Mensaje Menu Principal","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Variables').first().json.contactNumber }}","value":"={{ $('msg_clasificador').item.json.nuevoEstado }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2672,-1248],"id":"8ebfe19c-020a-45f7-a3fb-e2f8423c08bb","name":"üíæ Set Estado MENU","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"// Router para gesti√≥n de turnos\nconst categoria = $('msg_clasificador').first().json.categoria;\nconst contactNumber = $('Variables').first().json.contactNumber;\n\n// Mapeo de acciones\nconst accion = {\n  categoria: categoria,\n  contactNumber: contactNumber,\n  // Determinar qu√© hacer\n  accion: null\n};\n\nswitch(categoria) {\n  case 'NUEVO_PACIENTE':\n    accion.accion = 'MOSTRAR_FORM_NUEVO_PACIENTE';\n    break;\n  case 'PACIENTE_REGISTRADO':\n    accion.accion = 'SOLICITAR_DNI';\n    break;\n  case 'INICIAR_TOMAR_TURNO':\n    accion.accion = 'MENU_TOMAR_TURNO';\n    break;\n  case 'INICIAR_CANCELAR_TURNO':\n    accion.accion = 'LISTAR_TURNOS_CANCELAR';\n    break;\n  case 'LISTAR_MIS_TURNOS':\n    accion.accion = 'MOSTRAR_MIS_TURNOS';\n    break;\n  default:\n    accion.accion = 'DESCONOCIDO';\n}\n\nreturn [{ json: accion }];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[6576,-1200],"id":"d875bd77-60fa-4d1d-abce-3f0b2efccc8c","name":"üé´ Router Gesti√≥n Turnos"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Variables').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"list\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ü´Ä INSTITUTO DE CARDIOLOG√çA LA PLATA\"\n    },\n    \"body\": {\n      \"text\": \"üìã MEN√ö PRINCIPAL\\n\\nPRESION√Å 'ABRIR MEN√ö' Y ELEG√ç UNA OPCI√ìN:\\n\\n‚Üí üïê HORARIOS DE ATENCI√ìN\\n\\n‚Üí üìç UBICACI√ìN DE LA CL√çNICA\\n\\n‚Üí üíª PORTAL DE PACIENTES\\n\\n‚Üí üìß SOLICITAR RECETAS\\n\\n‚Üí üë®‚Äç‚öïÔ∏è NUESTROS M√âDICOS\\n\\n‚Üí ü©∫ ESPECIALIDADES M√âDICAS\"\n    },\n    \"footer\": {\n      \"text\": \"üìÖ LUN-VIE 8-20HS\"\n    },\n    \"action\": {\n      \"button\": \"ABRIR MEN√ö\",\n      \"sections\": [\n        {\n          \"title\": \"ELEG√ç UNA OPCI√ìN üëá\",\n          \"rows\": [\n            {\n              \"id\": \"horarios\",\n              \"title\": \"üïê HORARIOS\",\n              \"description\": \"‚Üí HORARIOS DE ATENCI√ìN\"\n            },\n            {\n              \"id\": \"direccion\",\n              \"title\": \"üìç DIRECCI√ìN\",\n              \"description\": \"‚Üí UBICACI√ìN ICLP\"\n            },\n            {\n              \"id\": \"portal-paciente\",\n              \"title\": \"üíª PORTAL PACIENTES\",\n              \"description\": \"‚Üí ACCESO AL PORTAL\"\n            },\n            {\n              \"id\": \"email-recetas\",\n              \"title\": \"üìß EMAIL RECETAS\",\n              \"description\": \"‚Üí SOLICITAR RECETAS\"\n            },\n            {\n              \"id\": \"medicos\",\n              \"title\": \"üë®‚Äç‚öïÔ∏è M√âDICOS\",\n              \"description\": \"‚Üí VER ESPECIALISTAS\"\n            },\n            {\n              \"id\": \"especialidades\",\n              \"title\": \"ü©∫ ESPECIALIDADES\",\n              \"description\": \"‚Üí LISTA COMPLETA\"\n            },\n            {\n              \"id\": \"menu-principal\",\n              \"title\": \"VOLVER AL MENU PRINCIPAL\",\n              \"description\": \"MENU PRINCIPAL\"\n            }\n          ]\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2448,-800],"id":"401f3e9b-3d13-4bee-9b3f-3682318a9264","name":"üì± Mensaje Info General","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ü´Ä INSTITUTO DE CARDIOLOG√çA LA PLATA\"\n    },\n    \"body\": {\n      \"text\": \"üìã PARA SACAR UN TURNO, SELECCION√Å:\\n\\nüÜï NUEVO PACIENTE\\n‚Üí Si es tu primera vez\\n\\nüë§ PACIENTE REGISTRADO\\n‚Üí Si ya ten√©s historial con nosotros\\n\\nüè† MEN√ö PRINCIPAL\\n‚Üí Ver horarios, ubicaci√≥n y m√°s info\"\n    },\n    \"footer\": {\n      \"text\": \"LUN-VIE 8-20HS\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"primera-vez\",\n            \"title\": \"NUEVO PACIENTE\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"ya-atendido\",\n            \"title\": \"PACIENTE REGISTRADO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"volver-atras\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2448,-1024],"id":"08b11019-3146-4edc-8fb2-61b7c976e430","name":"üìÖ Turnos - PACIENTE NUEVO - PACIENTE REGISTRADO - ","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Variables').first().json.contactNumber }}","value":"={{ $('msg_clasificador').item.json.nuevoEstado }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2672,-1024],"id":"098b2a4e-6de0-46ae-904c-f5088831d54f","name":"üíæ Set Estado MENU1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=status:{{ $('msg_clasificador').first().json.contactNumber }}","value":"={{ $('msg_clasificador').item.json.nuevoEstado }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[7024,-1200],"id":"00560228-8624-416c-8723-74d3e52b6892","name":"‚è±Ô∏è STATUS PRIMERA VEZ","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"*üìù REGISTRO DE NUEVO PACIENTE*\\n\\n*AL SER TU PRIMERA VEZ, NECESITAMOS TUS DATOS:*\\n\\n‚Üí NOMBRE Y APELLIDO\\n‚Üí DNI\\n‚Üí OBRA SOCIAL\\n‚Üí TEL√âFONO\\n‚Üí DOMICILIO\\n\\n*üìã FORMATO:*\\nENVI√Å TUS DATOS EN UN SOLO MENSAJE, AS√ç:\\n\\n_JUAN PEREZ_\\n_35946257_\\n_OSDE_\\n_2214567890_\\n_CALLE 50 N¬∞123, LA PLATA_\\n\\nüëá *ESCRIB√ç TUS DATOS Y ENVIALOS*\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"volver-atras\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[6800,-1200],"id":"a07e97ca-ed11-4d92-8df3-88a3d88abf77","name":"CREAR PACIENTE","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Variables').first().json.contactNumber }}","value":"={{ $('msg_clasificador').item.json.nuevoEstado }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2672,-800],"id":"17b07e95-f7d1-4f0b-8fbf-ad4a6fb903fc","name":"üíæ Set Estado MENU2","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"// ============================================\n// PREPARADOR DE MENSAJES DE INFORMACI√ìN\n// ============================================\n// Prepara el body del HTTP Request seg√∫n la categor√≠a\n// ============================================\n\n// Obtener datos del nodo anterior\nconst categoria = $json.categoria;\nconst contactNumber = $json.contactNumber;\nconst mensaje = $json.mensaje || '';\n\n// Categor√≠as que requieren flujos especiales (no mensajes directos)\nconst FLUJOS_ESPECIALES = {\n  INFO_MEDICOS: 'medicos',\n  INFO_ESPECIALIDADES: 'especialidades'\n};\n\n// Mapeo de categor√≠as a mensajes directos\nconst MENSAJES = {\n  INFO_PORTAL: {\n    \"messaging_product\": \"whatsapp\",\n    \"recipient_type\": \"individual\",\n    \"to\": contactNumber,\n    \"type\": \"text\",\n    \"text\": {\n      \"preview_url\": true,\n      \"body\": \"üíª *PORTAL DEL PACIENTE*\\n\\nüåê *Acceso:*\\nwww.iclp.com.ar ‚Üí \\\"PORTAL PACIENTES\\\"\\n\\nüîê *Tus datos de acceso:*\\n‚Ä¢ Usuario: [TU DNI] (sin puntos)\\n‚Ä¢ Contrase√±a: p + √∫ltimos 5 n√∫meros del DNI\\n\\nüìù *Ejemplo:*\\nDNI 12345678 ‚Üí Contrase√±a: p45678\\n\\n¬øNecesit√°s ayuda? ¬°Contactanos! üíô\"\n    }\n  },\n  \n  INFO_DIRECCION: {\n    \"messaging_product\": \"whatsapp\",\n    \"recipient_type\": \"individual\",\n    \"to\": contactNumber,\n    \"type\": \"text\",\n    \"text\": {\n      \"preview_url\": true,\n      \"body\": \"üìç *UBICACI√ìN*\\n\\nüè• *INSTITUTO DE CARDIOLOG√çA LA PLATA*\\n\\nüìå *Direcci√≥n:*\\nCalle 6 N¬∞212 (entre 36 y 37)\\nLa Plata, Buenos Aires\\n\\nüó∫Ô∏è *Ver en Google Maps:*\\nhttps://maps.app.goo.gl/ij23zZscf3vTKQV56\\n\\nüìû *Tel√©fono:*\\n(0221) 4906310\\n\\n¬°Te esperamos! üíö\"\n    }\n  },\n  \n  INFO_RECETAS: {\n    \"messaging_product\": \"whatsapp\",\n    \"recipient_type\": \"individual\",\n    \"to\": contactNumber,\n    \"type\": \"text\",\n    \"text\": {\n      \"preview_url\": false,\n      \"body\": \"üíä *RECETAS M√âDICAS*\\n\\n‚ú® ¬°Te explico c√≥mo pedir tus recetas!\\n\\nüìß *MANERA M√ÅS F√ÅCIL - POR EMAIL*\\n‚úâÔ∏è Correo: recetas@iclpsrl.com.ar\\n\\nüìù *Envianos:*\\n‚Ä¢ Apellido y nombre\\n‚Ä¢ Obra social\\n‚Ä¢ N√∫mero de afiliado\\n‚Ä¢ Nombre del m√©dico\\n\\nüö® *ATENCI√ìN ESPECIAL - Dr. Fabi√°n Barba*\\nüì≤ Sus recetas solo por WhatsApp:\\n2216810260\\n\\n¬øNecesit√°s ayuda? ¬°Estamos para ayudarte! üíö\"\n    }\n  },\n  \n  INFO_HORARIOS: {\n    \"messaging_product\": \"whatsapp\",\n    \"recipient_type\": \"individual\",\n    \"to\": contactNumber,\n    \"type\": \"text\",\n    \"text\": {\n      \"preview_url\": false,\n      \"body\": \"üïí *HORARIO DE ATENCI√ìN*\\n\\nüìÖ *Nuestros horarios son:*\\n‚Ä¢ Lunes a Viernes: 08:00 - 20:00hs\\n‚Ä¢ S√°bados: 08:00 - 13:00hs\\n‚Ä¢ Domingos: CERRADO\\n\\nüìû *Contacto:*\\nTel√©fono: (0221) 4906310\\n\\n¬°Te esperamos! üíô\"\n    }\n  }\n};\n\n// ============================================\n// DETERMINAR TIPO DE FLUJO\n// ============================================\n\n// 1. Verificar si es un flujo especial (m√©dicos o especialidades)\nif (FLUJOS_ESPECIALES[categoria]) {\n  const tipoFlujo = FLUJOS_ESPECIALES[categoria];\n  \n  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n  console.log('üîÄ FLUJO ESPECIAL DETECTADO');\n  console.log('üéØ Categor√≠a:', categoria);\n  console.log('üìã Tipo de flujo:', tipoFlujo);\n  console.log('üì± Destinatario:', contactNumber);\n  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n  \n  return [{\n    json: {\n      tipoFlujo: tipoFlujo,           // \"medicos\" o \"especialidades\"\n      categoria: categoria,\n      contactNumber: contactNumber,\n      esFlujoDirecto: false           // Requiere procesamiento adicional\n    }\n  }];\n}\n\n// 2. Si tiene mensaje predefinido, usarlo\nif (MENSAJES[categoria]) {\n  const mensajeBody = MENSAJES[categoria];\n  \n  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n  console.log('üì§ MENSAJE DIRECTO');\n  console.log('üéØ Categor√≠a:', categoria);\n  console.log('üì± Destinatario:', contactNumber);\n  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n  \n  return [{\n    json: {\n      body: mensajeBody,\n      categoria: categoria,\n      contactNumber: contactNumber,\n      esFlujoDirecto: true,           // Mensaje listo para enviar\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\n// 3. Mensaje de texto simple (fallback)\nconst mensajeBody = {\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": contactNumber,\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": mensaje\n  }\n};\n\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\nconsole.log('üìù MENSAJE TEXTO SIMPLE');\nconsole.log('üéØ Categor√≠a:', categoria);\nconsole.log('üì± Destinatario:', contactNumber);\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n\nreturn [{\n  json: {\n    body: mensajeBody,\n    categoria: categoria,\n    contactNumber: contactNumber,\n    esFlujoDirecto: true,\n    timestamp: new Date().toISOString()\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2544,2384],"id":"c5649b9d-ab78-42f8-af77-e238d1682c8e","name":"Code"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.body.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.body.recipient_type }}"},{"name":"to","value":"={{ $json.body.to }}"},{"name":"type","value":"={{ $json.body.type }}"},{"name":"text","value":"={{ $json.body.text }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3104,2752],"id":"0d0cd0d8-2b06-41c7-832a-2a3a4f7b3a58","name":"Medicos","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=status:{{ $('msg_clasificador').first().json.contactNumber }}","value":"={{ $('msg_clasificador').item.json.nuevoEstado }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3360,2752],"id":"f076e00d-ff60-4ede-a58e-2651974da2d0","name":"‚è±Ô∏è STATUS PRIMERA VEZ1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"status\": \"read\",\n  \"message_id\": \"{{ $('Entrada').item.json.body.messages[0].source_id }}\",\n  \"typing_indicator\": {\n    \"type\": \"text\"\n  }\n} ","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2896,-800],"id":"1a4b1a83-31b7-4f70-81e5-acdd6ff08a3f","name":"HTTP Request1","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"status\": \"read\",\n  \"message_id\": \"{{ $('Entrada').item.json.body.messages[0].source_id }}\",\n  \"typing_indicator\": {\n    \"type\": \"text\"\n  }\n} ","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2896,-1248],"id":"8d4520b5-55a6-476a-aaa0-7cf2bdf72863","name":"HTTP Request2","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"status\": \"read\",\n  \"message_id\": \"{{ $('Entrada').item.json.body.messages[0].source_id }}\",\n  \"typing_indicator\": {\n    \"type\": \"text\"\n  }\n} ","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2896,-1024],"id":"9f8bbac6-e7b3-4ea8-8127-ebe8b45f40d7","name":"HTTP Request3","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"status\": \"read\",\n  \"message_id\": \"{{ $('Entrada').first().json.body.messages[0].source_id }}\",\n  \"typing_indicator\": {\n    \"type\": \"text\"\n  }\n} ","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1056,-560],"id":"38bc8570-cf53-4219-a3b9-42f0cc2bae88","name":"HTTP Request4","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"jsCode":"// ============================================\n// CLASIFICADOR DE MENSAJES - SISTEMA JER√ÅRQUICO\n// ============================================\n// Autor: Sistema de Gesti√≥n de Turnos ICLP\n// Versi√≥n: 2.0\n// ============================================\n\n// ============================================\n// 1. CONFIGURACI√ìN Y CONSTANTES\n// ============================================\n\nconst PATRONES = {\n  MENU: {\n    TURNOS: 'üìÖ TURNOS',\n    INFO: '‚ÑπÔ∏è INFO GENERAL',\n    ADMIN: 'üè¢ ADMINISTRACION',\n    VOLVER: 'MENU PRINCIPAL'\n  },\n  \n  TURNOS: {\n    NUEVO: 'NUEVO PACIENTE',\n    REGISTRADO: 'PACIENTE REGISTRADO',\n    TOMAR: 'TOMAR TURNO',\n    CANCELAR: 'CANCELAR TURNO',\n    MIS_TURNOS: 'MIS TURNO/S'\n  },\n  \n  TIPOS: {\n    CONSULTORIO: 'TURNOS CONSULTORIO',\n    ESTUDIO: 'TURNOS ESTUDIO'\n  },\n  \n  INFO: {\n    HORARIOS: 'üïê HORARIOS',\n    DIRECCION: 'üìç DIRECCI√ìN',\n    PORTAL: 'üíª PORTAL PACIENTES',\n    RECETAS: 'üìß EMAIL RECETAS',\n    MEDICOS: 'üë®‚Äç‚öïÔ∏è M√âDICOS',\n    ESPECIALIDADES: 'ü©∫ ESPECIALIDADES'\n  },\n  \n  ACCION: {\n    CONTINUAR: ['CONTINUAR', 'SI, CONFIRMO', 'S√ç, CONFIRMO', 'CONFIRMAR TURNO'],\n    VOLVER: ['VOLVER ATRAS', 'VOLVER ATR√ÅS', 'MENU PRINCIPAL', 'VOLVER AL MENU PRINCIPAL', '‚¨ÖÔ∏è VOLVER ATRAS']\n  }\n};\n\n\n// ============================================\n// 2. UTILIDADES - VALIDACI√ìN DE FORMATOS\n// ============================================\n\n/**\n * Valida si el texto es una selecci√≥n de lista (formato: TEXTO-COD o TEXTO-123)\n * @param {string} texto - Texto a validar\n * @returns {boolean}\n */\nfunction esSeleccionLista(texto) {\n  // Acepta formatos: CARDIOLOG√çA-CAR, NEUROLOG√çA-123, etc.\n  return /^[A-Z√Ä-√ö√ë\\s]+-[A-Z0-9]+$/i.test(texto);\n}\n\n/**\n * Valida si el texto es una selecci√≥n de horario (formato: MI√â 22/10 - 15:40)\n * @param {string} texto - Texto a validar\n * @returns {boolean}\n */\nfunction esSeleccionHorario(texto) {\n  return /^[A-Z√â]{3}\\s\\d{1,2}\\/\\d{1,2}\\s-\\s\\d{2}:\\d{2}$/.test(texto);\n}\n\n/**\n * Extrae el DNI de un texto, ignorando palabras y caracteres adicionales\n * @param {string} texto - Texto que puede contener un DNI\n * @returns {string|null} - DNI encontrado o null\n */\nfunction extraerDNI(texto) {\n  // Convertir a string\n  const textoStr = texto.toString().trim();\n  \n  // Remover TODOS los caracteres que no sean d√≠gitos\n  const soloDigitos = textoStr.replace(/\\D/g, '');\n  \n  // Buscar secuencia de 7-8 d√≠gitos consecutivos\n  const patron = /\\d{7,8}/;\n  const match = soloDigitos.match(patron);\n  \n  if (!match) return null;\n  \n  // Retornar los primeros 7-8 d√≠gitos encontrados\n  const dni = match[0];\n  \n  // Si tiene m√°s de 8 d√≠gitos, tomar solo los primeros 8\n  return dni.length > 8 ? dni.substring(0, 8) : dni;\n}\n\n/**\n * Valida si el texto contiene un DNI v√°lido (7-8 d√≠gitos)\n * @param {string} texto - Texto a validar\n * @returns {boolean}\n */\nfunction esDNI(texto) {\n  return extraerDNI(texto) !== null;\n}\n\n/**\n * Valida si el texto es un identificador de turno para cancelar\n * @param {string} texto - Texto a validar\n * @returns {boolean}\n */\nfunction esTurnoParaCancelar(texto) {\n  return /^[A-Z]+-\\d{2}-\\d{2}-\\d{4}(-\\d+)?/.test(texto) || \n         /^turno-\\d{8}-\\d{4}-\\d+/.test(texto);\n}\n\n// ============================================\n// 3. GESTI√ìN DE ESTADOS\n// ============================================\n\n/**\n * Normaliza el estado al formato jer√°rquico\n * @param {string} estado - Estado a normalizar\n * @returns {string} Estado normalizado\n */\nfunction normalizarEstado(estado) {\n  // Sin estado\n  if (!estado || estado === '') return '';\n  \n  // Ya est√° normalizado (formato: SECCION:SUBSECCION)\n  if (estado.includes(':')) return estado;\n  \n  // Estados con DNI (formato especial: DNI:12345678)\n  if (estado.startsWith('DNI:')) {\n    const dni = estado.replace('DNI:', '');\n    return `DATOS:DNI_VALIDADO:${dni}`;\n  }\n  \n  // Retornar el estado tal cual si no requiere normalizaci√≥n\n  return estado;\n}\n\n/**\n * Extrae el contexto del estado jer√°rquico\n * @param {string} estado - Estado en formato jer√°rquico\n * @returns {object} Contexto con secci√≥n, subsecci√≥n y datos\n */\nfunction obtenerContexto(estado) {\n  if (!estado) {\n    return { seccion: null, subseccion: null, datos: null };\n  }\n  \n  const partes = estado.split(':');\n  return {\n    seccion: partes[0] || null,\n    subseccion: partes[1] || null,\n    datos: partes[2] || null\n  };\n}\n\n// ============================================\n// 4. REGLAS DE CLASIFICACI√ìN\n// ============================================\n\n/**\n * Reglas para el men√∫ principal\n */\nfunction clasificarMenuPrincipal(mensaje, estado) {\n  if (estado !== 'MENU_PRINCIPAL' && estado !== 'MENU_INICIAL') return null;\n  \n  if (mensaje === PATRONES.MENU.TURNOS) {\n    return { categoria: 'NAV_TURNOS', nuevoEstado: 'TURNOS:TIPO_PACIENTE' };\n  }\n  \n  if (mensaje === PATRONES.MENU.INFO) {\n    return { categoria: 'NAV_INFO', nuevoEstado: 'INFO:MENU' };\n  }\n  \n  if (mensaje === PATRONES.MENU.ADMIN) {\n    return { categoria: 'NAV_ADMIN', nuevoEstado: 'ADMIN:CONFIRMAR' };\n  }\n  \n  if (esDNI(mensaje)) {\n    return { \n      categoria: 'INGRESO_DNI', \n      nuevoEstado: `DATOS:DNI_VALIDADO:${mensaje}` \n    };\n  }\n  \n  return null;\n}\n\n/**\n * Reglas para gesti√≥n de turnos\n */\nfunction clasificarGestionTurnos(mensaje, estado, ctx) {\n  // Tipo de paciente\n  if (estado === 'TURNOS:TIPO_PACIENTE') {\n    if (mensaje === PATRONES.TURNOS.NUEVO) {\n      return { categoria: 'NUEVO_PACIENTE', nuevoEstado: 'DATOS:RECOLECCION' };\n    }\n    if (mensaje === PATRONES.TURNOS.REGISTRADO) {\n      return { categoria: 'PACIENTE_REGISTRADO', nuevoEstado: 'DATOS:SOLICITAR_DNI' };\n    }\n  }\n  \n  // Usuario con DNI validado\n  if (ctx.seccion === 'DATOS' && ctx.subseccion === 'DNI_VALIDADO') {\n    const dni = ctx.datos;\n    \n    // Usuario confirma sus datos despu√©s de validar DNI\n    if (PATRONES.ACCION.CONTINUAR.includes(mensaje)) {\n      return { \n        categoria: 'CONFIRMAR_DATOS_DNI', \n        nuevoEstado: 'TURNOS:TIPO_TURNO', \n        metadata: { dni } \n      };\n    }\n    \n    if (mensaje === PATRONES.TURNOS.TOMAR) {\n      return { \n        categoria: 'INICIAR_TOMAR_TURNO', \n        nuevoEstado: 'TURNOS:TIPO_TURNO', \n        metadata: { dni } \n      };\n    }\n    \n    if (mensaje === PATRONES.TURNOS.CANCELAR) {\n      return { \n        categoria: 'INICIAR_CANCELAR_TURNO', \n        nuevoEstado: 'CANCELAR:LISTAR', \n        metadata: { dni } \n      };\n    }\n    \n    if (mensaje === PATRONES.TURNOS.MIS_TURNOS) {\n      return { \n        categoria: 'LISTAR_MIS_TURNOS', \n        nuevoEstado: estado, \n        metadata: { dni } \n      };\n    }\n  }\n  \n  // Tipo de turno\n  if (estado === 'TURNOS:TIPO_TURNO') {\n    if (mensaje === PATRONES.TIPOS.CONSULTORIO) {\n      return { categoria: 'TURNO_CONSULTORIO', nuevoEstado: 'TURNOS:ESPECIALIDADES' };\n    }\n    if (mensaje === PATRONES.TIPOS.ESTUDIO) {\n      return { categoria: 'TURNO_ESTUDIO', nuevoEstado: 'TURNOS:ESPECIALIDADES_ESTUDIO' };\n    }\n  }\n  \n  // MEN√ö GESTI√ìN DE TURNOS (despu√©s de confirmar DNI)\n  if (estado === 'MENU:GESTION_TURNOS') {\n    if (mensaje === PATRONES.TURNOS.TOMAR) {\n      return { \n        categoria: 'TOMAR_TURNO', \n        nuevoEstado: 'TURNOS:ESPECIALIDADES'\n      };\n    }\n    if (mensaje === PATRONES.TURNOS.CANCELAR) {\n      return { \n        categoria: 'CANCELAR_TURNO', \n        nuevoEstado: 'CANCELAR:LISTAR'\n      };\n    }\n    if (mensaje === PATRONES.TURNOS.MIS_TURNOS) {\n      return { \n        categoria: 'MIS_TURNOS', \n        nuevoEstado: 'TURNOS:MIS_TURNOS'\n      };\n    }\n  }\n  \n  return null;\n}\n\n/**\n * Reglas para selecciones (especialidad, m√©dico, horario)\n */\nfunction clasificarSelecciones(mensaje, estado) {\n  // Bot√≥n ELEGIR OTRO M√âDICO (cuando no hay turnos disponibles)\n  const esBotonElegirOtroMedico = mensaje === 'ELEGIR OTRO M√âDICO' ||\n                                   mensaje === 'üë®‚Äç‚öïÔ∏è ELEGIR OTRO M√âDICO' ||\n                                   mensaje.includes('ELEGIR OTRO M√âDICO') ||\n                                   mensaje.toLowerCase().includes('elegir otro m√©dico') ||\n                                   mensaje.toLowerCase().includes('elegir otro medico');\n  \n  if (estado === 'TURNOS:SIN_HORARIOS' && esBotonElegirOtroMedico) {\n    console.log('‚úÖ Detectado bot√≥n ELEGIR OTRO M√âDICO - Volviendo a lista de m√©dicos');\n    console.log('üì© Mensaje recibido:', mensaje);\n    return { \n      categoria: 'VOLVER_MEDICOS', \n      nuevoEstado: 'TURNOS:MEDICOS'  // Volver a la lista de m√©dicos\n    };\n  }\n  \n  // Bot√≥n VER M√ÅS ESPECIALIDADES (Chatwoot env√≠a el title)\n  if (estado === 'TURNOS:ESPECIALIDADES' && mensaje === '‚ûï VER M√ÅS ESPECIALIDADES') {\n    return { \n      categoria: 'VER_MAS_ESPECIALIDADES', \n      nuevoEstado: 'TURNOS:ESPECIALIDADES:VER_MAS'\n    };\n  }\n  \n  // Bot√≥n VER ANTERIORES (desde segundo bloque)\n  const esBotonVolver = mensaje === '‚¨ÖÔ∏è VER ANTERIORES' || \n                        mensaje === 'VER ANTERIORES' ||\n                        mensaje.includes('VER ANTERIORES') ||\n                        mensaje.toLowerCase().includes('ver anteriores');\n  \n  if (estado === 'TURNOS:ESPECIALIDADES:VER_MAS' && esBotonVolver) {\n    console.log('‚úÖ Detectado bot√≥n VER ANTERIORES - Volviendo al primer bloque');\n    console.log('üì© Mensaje recibido:', mensaje);\n    return { \n      categoria: 'TURNO_CONSULTORIO', \n      nuevoEstado: 'TURNOS:ESPECIALIDADES'\n    };\n  }\n  \n  // Especialidad (primer bloque)\n  if (estado === 'TURNOS:ESPECIALIDADES' && esSeleccionLista(mensaje)) {\n    console.log('‚úÖ Especialidad seleccionada (primer bloque):', mensaje);\n    // Extraer c√≥digo de especialidad (ejemplo: CARDIOLOG√çA-CAR ‚Üí CAR)\n    const codigoEspecialidad = mensaje.split('-').pop();\n    return { \n      categoria: 'SELECCION_ESPECIALIDAD', \n      nuevoEstado: 'TURNOS:MEDICOS', \n      metadata: { \n        especialidad: mensaje,\n        codigoEspecialidad: codigoEspecialidad\n      } \n    };\n  }\n  \n  // Especialidad (segundo bloque - VER M√ÅS)\n  if (estado === 'TURNOS:ESPECIALIDADES:VER_MAS' && esSeleccionLista(mensaje)) {\n    console.log('‚úÖ Especialidad seleccionada (segundo bloque):', mensaje);\n    // Extraer c√≥digo de especialidad (ejemplo: CARDIOLOG√çA-CAR ‚Üí CAR)\n    const codigoEspecialidad = mensaje.split('-').pop();\n    return { \n      categoria: 'SELECCION_ESPECIALIDAD', \n      nuevoEstado: 'TURNOS:MEDICOS', \n      metadata: { \n        especialidad: mensaje,\n        codigoEspecialidad: codigoEspecialidad\n      } \n    };\n  }\n  \n  // Bot√≥n VER M√ÅS M√âDICOS (primer bloque)\n  if (estado === 'TURNOS:MEDICOS' && mensaje === '‚ûï VER M√ÅS M√âDICOS') {\n    // Preservar c√≥digo de especialidad y especialidad del metadata previo\n    const metadata = {};\n    if (globalThis._metadataPrevio?.codigoEspecialidad) {\n      metadata.codigoEspecialidad = globalThis._metadataPrevio.codigoEspecialidad;\n    }\n    if (globalThis._metadataPrevio?.especialidadSeleccionada) {\n      metadata.especialidad = globalThis._metadataPrevio.especialidadSeleccionada;\n    }\n    console.log('üì¶ Preservando metadata para VER_MAS_MEDICOS:', JSON.stringify(metadata));\n    \n    return { \n      categoria: 'VER_MAS_MEDICOS', \n      nuevoEstado: 'TURNOS:MEDICOS:VER_MAS',\n      metadata: metadata\n    };\n  }\n  \n  // Bot√≥n VER ANTERIORES M√âDICOS (desde segundo bloque)\n  const esBotonVolverMedicos = mensaje === '‚¨ÖÔ∏è VER ANTERIORES' || \n                                mensaje === 'VER ANTERIORES' ||\n                                mensaje.includes('VER ANTERIORES') ||\n                                mensaje.toLowerCase().includes('ver anteriores');\n  \n  if (estado === 'TURNOS:MEDICOS:VER_MAS' && esBotonVolverMedicos) {\n    console.log('‚úÖ Detectado bot√≥n VER ANTERIORES - Volviendo al primer bloque de m√©dicos');\n    \n    // Preservar c√≥digo de especialidad y especialidad del metadata previo\n    const metadata = {};\n    if (globalThis._metadataPrevio?.codigoEspecialidad) {\n      metadata.codigoEspecialidad = globalThis._metadataPrevio.codigoEspecialidad;\n    }\n    if (globalThis._metadataPrevio?.especialidadSeleccionada) {\n      metadata.especialidad = globalThis._metadataPrevio.especialidadSeleccionada;\n    }\n    \n    return { \n      categoria: 'SELECCION_ESPECIALIDAD', \n      nuevoEstado: 'TURNOS:MEDICOS',\n      metadata: metadata\n    };\n  }\n  \n  // M√©dico (primer bloque)\n  if (estado === 'TURNOS:MEDICOS' && esSeleccionLista(mensaje)) {\n    console.log('‚úÖ M√©dico seleccionado (primer bloque):', mensaje);\n    // Extraer matr√≠cula (ejemplo: PONCE VENA-112196 ‚Üí 112196)\n    const matricula = mensaje.split('-').pop().trim();\n    console.log('üî¢ Matr√≠cula extra√≠da:', matricula);\n    \n    return { \n      categoria: 'SELECCION_MEDICO', \n      nuevoEstado: 'TURNOS:HORARIOS', \n      metadata: { \n        medico: mensaje,\n        matricula: matricula\n      } \n    };\n  }\n  \n  // M√©dico (segundo bloque - VER M√ÅS)\n  if (estado === 'TURNOS:MEDICOS:VER_MAS' && esSeleccionLista(mensaje)) {\n    console.log('‚úÖ M√©dico seleccionado (segundo bloque):', mensaje);\n    const matricula = mensaje.split('-').pop().trim();\n    console.log('üî¢ Matr√≠cula extra√≠da:', matricula);\n    \n    return { \n      categoria: 'SELECCION_MEDICO', \n      nuevoEstado: 'TURNOS:HORARIOS', \n      metadata: { \n        medico: mensaje,\n        matricula: matricula\n      } \n    };\n  }\n  \n  // Horario\n  if (estado === 'TURNOS:HORARIOS' && esSeleccionHorario(mensaje)) {\n    return { \n      categoria: 'SELECCION_HORARIO', \n      nuevoEstado: 'TURNOS:CONFIRMAR', \n      metadata: { horario: mensaje } \n    };\n  }\n  \n  // Confirmar turno - Directamente ejecutar POST\n  if (estado === 'TURNOS:CONFIRMAR' && PATRONES.ACCION.CONTINUAR.includes(mensaje)) {\n    console.log('‚úÖ Confirmaci√≥n de turno detectada - Ejecutando POST');\n    return { \n      categoria: 'EJECUTAR_POST_TURNO',  // ‚¨ÖÔ∏è CAMBIO DIRECTO\n      nuevoEstado: 'MENU_PRINCIPAL' \n    };\n  }\n  \n  return null;\n}\n\n/**\n * Reglas para recolecci√≥n de datos\n */\nfunction clasificarDatos(mensaje, estado) {\n  // Solicitar DNI - Usuario ingresa DNI para validaci√≥n (primera vez)\n  if (estado === 'DATOS:SOLICITAR_DNI') {\n    const dniExtraido = extraerDNI(mensaje);\n    if (dniExtraido) {\n      console.log('‚úÖ DNI extra√≠do:', dniExtraido, 'del mensaje:', mensaje);\n      return { \n        categoria: 'VALIDAR_DNI', \n        nuevoEstado: `DATOS:DNI_VALIDADO:${dniExtraido}`,\n        metadata: { dni: dniExtraido }\n      };\n    }\n  }\n  \n  // DNI no encontrado (0) - Usuario reintenta con otro DNI\n  if (estado === 'DATOS:DNI_VALIDADO:0') {\n    const dniExtraido = extraerDNI(mensaje);\n    if (dniExtraido) {\n      console.log('üîÑ Reintentando validaci√≥n de DNI:', dniExtraido);\n      return { \n        categoria: 'VALIDAR_DNI', \n        nuevoEstado: `DATOS:DNI_VALIDADO:${dniExtraido}`,\n        metadata: { dni: dniExtraido }\n      };\n    }\n  }\n  \n  // Recolecci√≥n inicial de datos\n  if (estado === 'DATOS:RECOLECCION') {\n  if (!PATRONES.ACCION.VOLVER.includes(mensaje) && mensaje !== 'CONTINUAR') {\n      return { categoria: 'INGRESO_DATOS_PACIENTE', nuevoEstado: 'DATOS:RECOLECTADOS' };\n    }\n  }\n  \n  // Datos ya recolectados, esperando confirmaci√≥n\n  if (estado === 'DATOS:RECOLECTADOS') {\n  if (PATRONES.ACCION.CONTINUAR.includes(mensaje)) {\n    return { categoria: 'CONFIRMAR_PACIENTE_NUEVO', nuevoEstado: 'DATOS:PACIENTE_NUEVO' };\n    }\n  }\n  \n  return null;\n}\n\n/**\n * Reglas para cancelaci√≥n de turnos\n */\nfunction clasificarCancelacion(mensaje, estado) {\n  // Usuario confirma que quiere eliminar el turno\n  if (estado === 'CANCELAR-TURNO' || estado === 'CANCELAR:TURNO') {\n    console.log('‚úÖ Detectado estado CANCELAR-TURNO - Ejecutando eliminaci√≥n');\n    return { \n      categoria: 'ELIMINAR_TURNO', \n      nuevoEstado: 'MENU_PRINCIPAL' \n    };\n  }\n  \n  // Usuario selecciona un turno de la lista para cancelar\n  if (estado === 'CANCELAR:LISTAR' && esTurnoParaCancelar(mensaje)) {\n    return { \n      categoria: 'EJECUTAR_CANCELACION_TURNO', \n      nuevoEstado: 'CANCELAR-TURNO',  // Cambiar al estado de confirmaci√≥n\n      metadata: { turno_id: mensaje } \n    };\n  }\n  \n  return null;\n}\n\n/**\n * Reglas para informaci√≥n general\n */\nfunction clasificarInformacion(mensaje, estado) {\n  const infoMap = {\n    [PATRONES.INFO.HORARIOS]: 'INFO_HORARIOS',\n    [PATRONES.INFO.DIRECCION]: 'INFO_DIRECCION',\n    [PATRONES.INFO.PORTAL]: 'INFO_PORTAL',\n    [PATRONES.INFO.RECETAS]: 'INFO_RECETAS',\n    [PATRONES.INFO.MEDICOS]: 'INFO_MEDICOS',\n    [PATRONES.INFO.ESPECIALIDADES]: 'INFO_ESPECIALIDADES'\n  };\n  \n  if (infoMap[mensaje]) {\n    return { categoria: infoMap[mensaje], nuevoEstado: estado };\n  }\n  \n  return null;\n}\n\n/**\n * Reglas para navegaci√≥n hacia atr√°s\n */\nfunction clasificarVolverAtras(mensaje, estado) {\n  if (!PATRONES.ACCION.VOLVER.includes(mensaje)) return null;\n  \n  const navegacionAtras = {\n    'TURNOS:HORARIOS': 'TURNOS:MEDICOS',\n    'TURNOS:MEDICOS': 'TURNOS:ESPECIALIDADES',\n    'TURNOS:MEDICOS:VER_MAS': 'TURNOS:MEDICOS',\n    'TURNOS:ESPECIALIDADES': 'TURNOS:TIPO_TURNO',\n    'TURNOS:ESPECIALIDADES:VER_MAS': 'TURNOS:ESPECIALIDADES',\n    'TURNOS:CONFIRMAR': 'TURNOS:HORARIOS',\n    'CANCELAR:LISTAR': 'MENU_PRINCIPAL',\n    'DATOS:RECOLECTADOS': 'DATOS:RECOLECCION',\n    'INFO:MENU': 'MENU_PRINCIPAL'\n  };\n  \n  const nuevoEstado = navegacionAtras[estado] || 'MENU_PRINCIPAL';\n  \n  // Si volvemos al men√∫ principal, usar categor√≠a MENU_INICIAL\n  const categoria = (nuevoEstado === 'MENU_PRINCIPAL') ? 'MENU_INICIAL' : 'VOLVER_ATRAS';\n  \n  return { categoria, nuevoEstado };\n}\n\n/**\n * Reglas para administraci√≥n\n */\nfunction clasificarAdmin(mensaje, estado) {\n  if (estado === 'ADMIN:CONFIRMAR' && mensaje === 'SI, CONFIRMO') {\n    return { categoria: 'DERIVAR_HUMANO', nuevoEstado: 'ADMIN:HUMANO_ACTIVO' };\n  }\n  \n  return null;\n}\n\n// ============================================\n// 5. CLASIFICADOR PRINCIPAL\n// ============================================\n\n/**\n * Clasificador principal - Ejecuta todas las reglas en orden\n * @param {string} mensaje - Mensaje del usuario\n * @param {string} estado - Estado actual\n * @returns {object} Resultado con categor√≠a y nuevo estado\n */\nfunction clasificar(mensaje, estado) {\n  const ctx = obtenerContexto(estado);\n  \n  // 1. INICIO / SIN ESTADO\n  if (!estado || estado === '') {\n    return { categoria: 'fallback', nuevoEstado: 'MENU_PRINCIPAL' };\n  }\n  \n  // 2. VOLVER AL MEN√ö PRINCIPAL\n  if (mensaje === 'MENU PRINCIPAL') {\n    return { categoria: 'MENU_INICIAL', nuevoEstado: 'MENU_PRINCIPAL' };\n  }\n  \n  // 3. BOT√ìN ADMINISTRACI√ìN (desde cualquier estado)\n  if (mensaje === 'üè¢ ADMINISTRACION') {\n    return { categoria: 'NAV_ADMIN', nuevoEstado: 'ADMIN:CONFIRMAR' };\n  }\n  \n  // 4. EJECUTAR REGLAS EN ORDEN\n  const reglas = [\n    clasificarMenuPrincipal,\n    clasificarGestionTurnos,\n    clasificarSelecciones,\n    clasificarDatos,\n    clasificarCancelacion,\n    clasificarInformacion,\n    clasificarVolverAtras,\n    clasificarAdmin\n  ];\n  \n  for (const regla of reglas) {\n    const resultado = regla(mensaje, estado, ctx);\n    if (resultado) return resultado;\n  }\n  \n  // 5. FALLBACK INTELIGENTE - Devuelve categor√≠a basada en el estado actual\n  return obtenerCategoriaDeEstado(estado);\n}\n\n/**\n * Obtiene una categor√≠a por defecto basada en el estado actual\n * Esto permite que el flujo contin√∫e incluso cuando no se reconoce el mensaje\n * @param {string} estado - Estado actual del usuario\n * @returns {object} Resultado con categor√≠a y estado\n */\nfunction obtenerCategoriaDeEstado(estado) {\n  console.log('‚ö†Ô∏è FALLBACK INTELIGENTE - No se reconoci√≥ el mensaje');\n  console.log('üìç Estado actual:', estado);\n  \n  // Mapa de estados a categor√≠as por defecto\n  const estadoACategoriaMap = {\n    // Estados de Datos\n    'DATOS:SOLICITAR_DNI': { categoria: 'SOLICITAR_DNI', nuevoEstado: 'DATOS:SOLICITAR_DNI' },\n    'DATOS:DNI_VALIDADO': { categoria: 'MENU_GESTION_TURNOS', nuevoEstado: 'MENU:GESTION_TURNOS' },\n    \n    // Estados del Men√∫ de Gesti√≥n\n    'MENU:GESTION_TURNOS': { categoria: 'MENU_GESTION_TURNOS', nuevoEstado: 'MENU:GESTION_TURNOS' },\n    'TURNOS:TIPO_TURNO': { categoria: 'MENU_TIPO_TURNO', nuevoEstado: 'TURNOS:TIPO_TURNO' },\n    \n    // Estados de Turnos - Especialidades\n    'TURNOS:ESPECIALIDADES': { categoria: 'TURNO_CONSULTORIO', nuevoEstado: 'TURNOS:ESPECIALIDADES' },\n    'TURNOS:ESPECIALIDADES:VER_MAS': { categoria: 'VER_MAS_ESPECIALIDADES', nuevoEstado: 'TURNOS:ESPECIALIDADES:VER_MAS' },\n    'TURNOS:ESPECIALIDADES_ESTUDIO': { categoria: 'TURNO_ESTUDIO', nuevoEstado: 'TURNOS:ESPECIALIDADES_ESTUDIO' },\n    \n    // Estados de Turnos - M√©dicos\n    'TURNOS:MEDICOS': { categoria: 'SELECCION_ESPECIALIDAD', nuevoEstado: 'TURNOS:MEDICOS' },\n    'TURNOS:MEDICOS:VER_MAS': { categoria: 'VER_MAS_MEDICOS', nuevoEstado: 'TURNOS:MEDICOS:VER_MAS' },\n    \n    // Estados de Turnos - Horarios\n    'TURNOS:HORARIOS': { categoria: 'SELECCION_MEDICO', nuevoEstado: 'TURNOS:HORARIOS' },\n    'TURNOS:SIN_HORARIOS': { categoria: 'SELECCION_MEDICO', nuevoEstado: 'TURNOS:MEDICOS' },\n    'TURNOS:CONFIRMAR': { categoria: 'SELECCION_HORARIO', nuevoEstado: 'TURNOS:CONFIRMAR' },\n    \n    // Estados de Cancelaci√≥n\n    'CANCELAR:LISTAR': { categoria: 'CANCELAR_TURNO', nuevoEstado: 'CANCELAR:LISTAR' },\n    'CANCELAR-TURNO': { categoria: 'EJECUTAR_CANCELACION_TURNO', nuevoEstado: 'CANCELAR-TURNO' },\n    'CANCELAR:TURNO': { categoria: 'EJECUTAR_CANCELACION_TURNO', nuevoEstado: 'CANCELAR:TURNO' },\n    \n    // Estados de Mis Turnos\n    'TURNOS:MIS_TURNOS': { categoria: 'MIS_TURNOS', nuevoEstado: 'TURNOS:MIS_TURNOS' },\n    \n    // Estados de Administraci√≥n\n    'ADMIN:CONFIRMAR': { categoria: 'NAV_ADMIN', nuevoEstado: 'ADMIN:CONFIRMAR' },\n    'ADMIN:HUMANO_ACTIVO': { categoria: 'DERIVAR_HUMANO', nuevoEstado: 'ADMIN:HUMANO_ACTIVO' },\n    \n    // Men√∫ Principal\n    'MENU_PRINCIPAL': { categoria: 'MENU_INICIAL', nuevoEstado: 'MENU_PRINCIPAL' }\n  };\n  \n  // Buscar categor√≠a por estado exacto\n  if (estadoACategoriaMap[estado]) {\n    const resultado = estadoACategoriaMap[estado];\n    console.log('‚úÖ Categor√≠a encontrada para estado:', resultado.categoria);\n    return resultado;\n  }\n  \n  // Si no encuentra exacto, buscar por prefijo\n  if (estado.startsWith('DATOS:DNI_VALIDADO:')) {\n    console.log('‚úÖ Detectado DNI validado - Redirigiendo a men√∫ gesti√≥n');\n    return { categoria: 'MENU_GESTION_TURNOS', nuevoEstado: 'MENU:GESTION_TURNOS' };\n  }\n  \n  if (estado.startsWith('TURNOS:')) {\n    console.log('‚úÖ Usuario en flujo de turnos - Manteniendo contexto');\n    return { categoria: 'TURNO_CONSULTORIO', nuevoEstado: estado };\n  }\n  \n  if (estado.startsWith('CANCELAR:')) {\n    console.log('‚úÖ Usuario en cancelaci√≥n - Manteniendo contexto');\n    return { categoria: 'CANCELAR_TURNO', nuevoEstado: estado };\n  }\n  \n  if (estado.startsWith('DATOS:')) {\n    console.log('‚úÖ Usuario en registro de datos');\n    return { categoria: 'SOLICITAR_DNI', nuevoEstado: 'DATOS:SOLICITAR_DNI' };\n  }\n  \n  // √öltimo recurso: categor√≠a fallback\n  console.log('‚ö†Ô∏è Estado no reconocido o null - Categor√≠a fallback');\n  return { categoria: 'fallback', nuevoEstado: 'MENU_PRINCIPAL' };\n}\n\n// ============================================\n// 6. EJECUCI√ìN Y LOGGING\n// ============================================\n\n/**\n * Registra informaci√≥n de depuraci√≥n\n */\nfunction logDebug(mensaje, estadoRaw, estado, resultado) {\n  const dniExtraido = extraerDNI(mensaje);\n  \n  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n  console.log('üì± Mensaje:', mensaje);\n  console.log('üìè Longitud:', mensaje.length);\n  console.log('üî§ Tipo:', typeof mensaje);\n  console.log('üß™ Es DNI?:', esDNI(mensaje));\n  if (dniExtraido) {\n    console.log('üÜî DNI Extra√≠do:', dniExtraido);\n  }\n  console.log('üè∑Ô∏è  Estado Raw:', estadoRaw || '(sin estado)');\n  console.log('üè∑Ô∏è  Estado Normalizado:', estado || '(sin estado)');\n  console.log('üéØ Categor√≠a:', resultado.categoria);\n  console.log('üîÑ Nuevo Estado:', resultado.nuevoEstado);\n  if (resultado.metadata) {\n    console.log('üì¶ Metadata:', JSON.stringify(resultado.metadata));\n  }\n  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n}\n\n/**\n * Construye el contexto enriquecido\n */\nfunction construirContexto(resultado) {\n  const nuevoCtx = obtenerContexto(resultado.nuevoEstado);\n  \n  return {\n    seccion: nuevoCtx.seccion,\n    subseccion: nuevoCtx.subseccion,\n    es_usuario_registrado: resultado.nuevoEstado.startsWith('DATOS:DNI_VALIDADO'),\n    en_proceso_turno: resultado.nuevoEstado.startsWith('TURNOS:'),\n    en_cancelacion: resultado.nuevoEstado.startsWith('CANCELAR:')\n  };\n}\n\n// ============================================\n// 7. MAIN - PUNTO DE ENTRADA\n// ============================================\n\n// Obtener datos de entrada\nconst estadoRaw = $json.status || $json.value || $json.result || '';\nconst mensajeRaw = $('Variables').first().json.message;\nconst mensaje = mensajeRaw.toString().trim();\nconst contactNumber = $('Variables').first().json.contactNumber;\n\n// Intentar obtener metadata del nodo anterior (para preservar c√≥digo de especialidad, etc.)\nlet metadataPrevio = {};\ntry {\n  // Primero intentar del $json actual (puede venir del nodo Redis GET)\n  if ($json.metadata && Object.keys($json.metadata).length > 0) {\n    metadataPrevio = $json.metadata;\n    console.log('‚úÖ Metadata encontrado en $json');\n  } else {\n    // Intentar del nodo Get Estado Actual\n    metadataPrevio = $('Get Estado Actual').first().json.metadata || {};\n    console.log('‚úÖ Metadata encontrado en Get Estado Actual');\n  }\n} catch (e) {\n  try {\n    // Intentar del nodo LISTA_MEDICOS\n    const listaMedicos = $('LISTA_MEDICOS').first().json;\n    metadataPrevio = {\n      codigoEspecialidad: listaMedicos.codigoEspecialidad,\n      especialidadSeleccionada: listaMedicos.especialidadSeleccionada\n    };\n    console.log('‚úÖ Metadata encontrado en LISTA_MEDICOS');\n  } catch (e2) {\n    try {\n      // Intentar del nodo LISTA_ESPECIALIDADES\n      metadataPrevio = $('LISTA_ESPECIALIDADES').first().json;\n      console.log('‚úÖ Metadata encontrado en LISTA_ESPECIALIDADES');\n    } catch (e3) {\n      metadataPrevio = {};\n      console.log('‚ö†Ô∏è No se encontr√≥ metadata previo');\n    }\n  }\n}\n\nconsole.log('üì¶ Metadata previo final:', JSON.stringify(metadataPrevio));\n\n// Hacer metadata previo disponible globalmente para las funciones clasificadoras\nglobalThis._metadataPrevio = metadataPrevio;\n\n// Normalizar estado\nconst estado = normalizarEstado(estadoRaw);\n\n// ============================================\n// üîç VERIFICACI√ìN DE CLIENTE REGISTRADO EN REDIS\n// ============================================\n// Intentar obtener datos del cliente desde el nodo PACIENTE\nlet pacienteRegistrado = false;\nlet datosCliente = null;\n\ntry {\n  // Obtener del nodo PACIENTE (viene de Redis GET)\n  const redisCliente = $('PACIENTE').first().json.paciente; // Nota: el campo se llama 'paciete' en el nodo\n  \n  if (redisCliente !== null && redisCliente !== undefined && redisCliente !== '') {\n    pacienteRegistrado = true;\n    datosCliente = redisCliente;\n    console.log('‚úÖ Cliente REGISTRADO encontrado en Redis');\n    console.log('üìã Datos del cliente:', JSON.stringify(datosCliente));\n  } else {\n    console.log('‚ùå Cliente NO registrado - Redis devolvi√≥ null');\n  }\n} catch (e) {\n  console.log('‚ö†Ô∏è No se pudo obtener datos del nodo PACIENTE:', e.message);\n  pacienteRegistrado = false;\n}\n\nconsole.log('üè• Paciente Registrado:', pacienteRegistrado);\n\n// ============================================\n// üö® DETECCI√ìN DE ERROR_MESSAGE (Errores de Registro)\n// ============================================\n// Si hay un error de registro (DNI incorrecto, nombre incompleto, etc.)\n// debe devolver ERROR_REGISTRO para volver al flujo de datos\nconst hasError = $json.hasError || false;\nconst errorMessage = $json.errorMessage || null;\n\nif (hasError && errorMessage) {\n  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n  console.log('üö® ERROR DE REGISTRO DETECTADO');\n  console.log('üìù Mensaje de error:', errorMessage);\n  console.log('üîÑ Redirigiendo al flujo de datos para reintentar');\n  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n  \n  // Retornar inmediatamente con categor√≠a ERROR_REGISTRO\n  return [{\n    json: {\n      categoria: 'ERROR_REGISTRO',\n      mensaje: mensaje,\n      contactNumber: contactNumber,\n      pacienteRegistrado: pacienteRegistrado,\n      datosCliente: datosCliente,\n      estadoActual: 'DATOS:ERROR_REGISTRO',\n      estadoAnterior: estado,\n      metadata: {\n        errorMessage: errorMessage,\n        errorOriginal: errorMessage\n      },\n      redisKey: `state:${contactNumber}`,\n      redisValue: 'DATOS:ERROR_REGISTRO',\n      nuevoEstado: 'DATOS:ERROR_REGISTRO',\n      _context: {\n        seccion: 'DATOS',\n        subseccion: 'ERROR_REGISTRO',\n        es_usuario_registrado: false,\n        en_proceso_turno: false,\n        en_cancelacion: false,\n        tiene_error: true\n      }\n    }\n  }];\n}\n\n// Log de entrada\nconst dniEnMensaje = extraerDNI(mensaje);\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ ENTRADA ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\nconsole.log('üì© Mensaje raw:', JSON.stringify(mensajeRaw));\nconsole.log('üì© Mensaje procesado:', mensaje);\nconsole.log('üìè Longitud:', mensaje.length);\nconsole.log('üìè Tipo:', typeof mensajeRaw);\nconsole.log('üß™ Es DNI?:', esDNI(mensaje));\nif (dniEnMensaje) {\n  console.log('üÜî DNI encontrado:', dniEnMensaje);\n}\nconsole.log('üè∑Ô∏è  Estado raw:', estadoRaw);\nconsole.log('üè∑Ô∏è  Estado normalizado:', estado);\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n\n// Clasificar\nconst resultado = clasificar(mensaje, estado);\n\n// Log de depuraci√≥n\nlogDebug(mensaje, estadoRaw, estado, resultado);\n\n// Retornar resultado estructurado\nreturn [{\n  json: {\n    // Datos principales\n    categoria: resultado.categoria,\n    mensaje: mensaje,\n    contactNumber: contactNumber,\n    \n    // Verificaci√≥n de registro\n    pacienteRegistrado: pacienteRegistrado,\n    datosCliente: datosCliente,\n    \n    // Estados para Redis\n    estadoActual: resultado.nuevoEstado,      // Estado a guardar en Redis\n    estadoAnterior: estado,                   // Estado previo (para volver atr√°s)\n    \n    // Metadata\n    metadata: resultado.metadata || {},\n    \n    // Redis keys (compatibilidad)\n    redisKey: `state:${contactNumber}`,\n    redisValue: resultado.nuevoEstado,\n    \n    // Alias para compatibilidad con c√≥digo existente\n    nuevoEstado: resultado.nuevoEstado,\n    \n    // Contexto enriquecido\n    _context: construirContexto(resultado)\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[128,-384],"id":"292ce705-62a5-41c4-9eb8-fb6bc7500795","name":"msg_clasificador"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('msg_clasificador').item.json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ü´Ä INSTITUTO DE CARDIOLOG√çA LA PLATA\"\n    },\n    \"body\": {\n      \"text\": \"üè¢ ADMINISTRACI√ìN\\n\\nTE CONECTAREMOS CON UNA RECEPCIONISTA PARA:\\n\\n‚úÖ REPROGRAMAR UN TURNO\\n‚úÖ CONSULTAS O RECLAMOS URGENTES\\n‚úÖ DERIVACI√ìN URGENTE\\n\\n‚è∞ HORARIO DE RESPUESTA:\\nLUNES A VIERNES: 8-20HS | S√ÅBADO 8-13HS\\n\\nüí° SI NECESIT√ÅS:\\n- AGENDAR UN TURNO NUEVO ‚Üí US√Å EL BOT (M√ÅS R√ÅPIDO)\\n- CANCELAR UN TURNO ‚Üí US√Å EL BOT\\n- INFO GENERAL ‚Üí US√Å EL BOT\\n\\nüìû OTRO MEDIO DONDE POD√âS RECIBIR ASISTENCIA:\\n221 4906310\\n\\n¬øQUER√âS CONTINUAR?\"\n    },\n    \"footer\": {\n      \"text\": \"LUN-VIE 8-20HS\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"si-confirmo\",\n            \"title\": \"SI, CONFIRMO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"volver-atras\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2448,-576],"id":"426f7ae4-0280-4924-9e84-45711dc25d72","name":"üè¢ Administraci√≥n","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"status\": \"read\",\n  \"message_id\": \"{{ $('Entrada').item.json.body.messages[0].source_id }}\",\n  \"typing_indicator\": {\n    \"type\": \"text\"\n  }\n} ","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[7248,-1200],"id":"e164e113-f7fa-4524-9ddc-342bbf4f9fa1","name":"HTTP Request5","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"status\": \"read\",\n  \"message_id\": \"{{ $('Entrada').item.json.body.messages[0].source_id }}\",\n  \"typing_indicator\": {\n    \"type\": \"text\"\n  }\n} ","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2672,-576],"id":"d2a43870-d514-4e17-b95f-3dc6257b3d2f","name":"HTTP Request6","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"057155d2-7320-48de-8ed5-bf00dcc72b38","leftValue":"={{ $json.body.messages[0].sender.phone_number }}","rightValue":"+5492213994411","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"d0c07208-2eca-4ffc-ae49-063a0363cf6e","leftValue":"={{ $json.body.messages[0].sender.phone_number }}","rightValue":"+595985624358","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"c20fad56-f470-4653-b327-8ce2b684deaa","leftValue":"={{ $json.body.messages[0].sender.phone_number }}","rightValue":"+5492254596618","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"41ecf46b-61e9-4d1b-9bc9-9ed63e9817e3","leftValue":"={{ $json.body.messages[0].sender.phone_number }}","rightValue":"+34629235015","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"or"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[-1952,-608],"id":"d8979532-e05f-4cbf-9dbe-cb09ee0d41bf","name":"Filtrar n√∫meros de prueba","disabled":true},{"parameters":{"dataToSave":{"values":[{"key":"conversationId","value":"={{ $json.body.id }}"},{"key":"contactNumber","value":"={{ $json.body.contact_inbox.source_id }}"}]}},"type":"n8n-nodes-base.executionData","typeVersion":1,"position":[-2208,-800],"id":"020da41d-1d8b-4dfd-8498-1697b5d1a54a","name":"Execution Data1"},{"parameters":{"operation":"set","key":"=status:{{ $('Variables').first().json.contactNumber }}","value":"={{ $('msg_clasificador').item.json.nuevoEstado }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2896,-576],"id":"72094f30-0692-47ec-9e0e-ba1a7145e786","name":"üíæ Set Estado MENU3","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"workflowId":{"__rl":true,"value":"gsbUq8JFSpw8U7yR","mode":"list","cachedResultName":"SUB - ETIQUETA: CONSULTA_RECLAMO"},"workflowInputs":{"mappingMode":"defineBelow","value":{"humano":true,"accountId":"={{ $('Filtro Tipo Mensaje').item.json.accountId }}","conversationId":"={{ $('Filtro Tipo Mensaje').item.json.conversationId.toString() }}","contactId":"={{ $('Filtro Tipo Mensaje').item.json.contactId.toString() }}","message":"={{ $('Filtro Tipo Mensaje').item.json.message }}","inboxId":"={{ $('Filtro Tipo Mensaje').item.json.inboxId.toString() }}","chatwootUrlBase":"={{ $('Filtro Tipo Mensaje').item.json.chatwootUrl }}","tokenChatwoot":"={{ $('Filtro Tipo Mensaje').item.json.agenteBotTokenWhatsapp }}","tipoIntencion":"consultas-reclamos"},"matchingColumns":[],"schema":[{"id":"accountId","displayName":"accountId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"conversationId","displayName":"conversationId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"contactId","displayName":"contactId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"message","displayName":"message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"inboxId","displayName":"inboxId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"humano","displayName":"humano","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"boolean"},{"id":"chatwootUrlBase","displayName":"chatwootUrlBase","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"tokenChatwoot","displayName":"tokenChatwoot","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"tipoIntencion","displayName":"tipoIntencion","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[3712,-736],"id":"c8c4784f-0279-4cb9-a7f0-cbe6f92a0cf1","name":"ETIQUETA CONSULTA-RECLAMO"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"status\": \"read\",\n  \"message_id\": \"{{ $('Entrada').item.json.body.messages[0].source_id }}\",\n  \"typing_indicator\": {\n    \"type\": \"text\"\n  }\n} ","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[4064,-736],"id":"42fec033-ff6e-474a-b657-ab6767f03ceb","name":"HTTP Request7","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"status\": \"read\",\n  \"message_id\": \"{{ $('Entrada').first().json.body.messages[0].source_id }}\",\n  \"typing_indicator\": {\n    \"type\": \"text\"\n  }\n} ","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-864,-720],"id":"92853f7d-fbd7-472c-b9ec-d116f02c6ee0","name":"HTTP Request8","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"={{ $('Filtro Tipo Mensaje').item.json.chatwootUrl }}/api/v1/accounts/{{ $('Filtro Tipo Mensaje').item.json.accountId }}/conversations/{{ $('Filtro Tipo Mensaje').item.json.conversationId }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('Filtro Tipo Mensaje').item.json.agenteBotTokenWhatsapp }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"content","value":"=üè∑Ô∏è Su consulta ya qued√≥ registrada y etiquetada para que un supervisor del √°rea administrativa se comunique con usted.\n\nüë§ En breve recibir√° atenci√≥n personalizada.\n‚è∏Ô∏è El men√∫ autom√°tico permanecer√° pausado por el momento.\n\n‚ù§Ô∏è *Gracias por tu confianza.*\n_Instituto de Cardiolog√≠a La Plata_"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-624,-800],"id":"a81e84a9-f571-4b51-bf88-07e331f665a3","name":"sendRespondCw"},{"parameters":{"operation":"incr","key":"=contador:{{ $('Filtro Tipo Mensaje').item.json.contactNumber }}","expire":true,"ttl":3600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-400,-720],"id":"e2c5ed3a-751d-4290-b9f7-7ec03716cea1","name":"contador","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"mensaje_enviado","key":"=contador:{{ $('Filtro Tipo Mensaje').item.json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-1344,-800],"id":"0670bf51-4b55-4afd-b0e0-287c42ad043c","name":"MSG ENVIADO?","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"28730a7e-22e0-4e24-9233-e808f6b6826c","leftValue":"={{ $json.mensaje_enviado >= 1 && $json.mensaje_enviado !== null }}","rightValue":"null","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-1104,-800],"id":"28af0ef1-cc7a-48de-a6d4-81cd88ee90df","name":"If"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filtro Tipo Mensaje').first().json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": {{ JSON.stringify($json.mensaje) }}\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3488,2384],"id":"ca1a1700-7ecb-4b5f-b942-13f4f641364e","name":"ESPECIALIDADES2","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"content":"## INFO GENERAL - MEDICOS","height":304,"width":992,"color":4},"type":"n8n-nodes-base.stickyNote","position":[2896,1952],"typeVersion":1,"id":"e7bdbeb6-380f-4e69-b6f4-1808e832c18a","name":"Sticky Note2"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filtro Tipo Mensaje').first().json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": {{ JSON.stringify($json.mensaje) }}\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3472,2032],"id":"0aeb4e36-60b3-4c7c-94dc-73ca42d12096","name":"MEDICOS","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"jsCode":"// Obtener todos los m√©dicos\nconst items = $input.all();\n\n// Crear un objeto para agrupar m√©dicos por especialidad\nconst medicosPorEspecialidad = {};\n\nitems.forEach(item => {\n  const medico = item.json.Medico;\n  const especialidad = item.json.Especialidad;\n  \n  if (!medicosPorEspecialidad[especialidad]) {\n    medicosPorEspecialidad[especialidad] = [];\n  }\n  \n  // Evitar duplicados\n  if (!medicosPorEspecialidad[especialidad].includes(medico)) {\n    medicosPorEspecialidad[especialidad].push(medico);\n  }\n});\n\n// Ordenar especialidades alfab√©ticamente\nconst especialidadesOrdenadas = Object.keys(medicosPorEspecialidad).sort();\n\n// Crear el listado formateado\nlet listadoMedicos = '';\nespecialidadesOrdenadas.forEach(especialidad => {\n  listadoMedicos += `\\nüìå *${especialidad}*\\n`;\n  \n  // Ordenar m√©dicos alfab√©ticamente\n  const medicos = medicosPorEspecialidad[especialidad].sort();\n  \n  medicos.forEach(medico => {\n    listadoMedicos += `   ‚Ä¢ Dr./Dra. ${medico}\\n`;\n  });\n});\n\n// Crear el mensaje completo con las nuevas instrucciones\nconst mensaje = `üë®‚Äç‚öïÔ∏è *NUESTROS PROFESIONALES*\\n\\nüè• *CONTAMOS CON LOS SIGUIENTES M√âDICOS ESPECIALISTAS:*${listadoMedicos}\\n\\nüìû *CONTACTO:*\\n(0221) 4906310\\nLUNES A VIERNES: 8:00-20:00HS`;\n\n// Mensaje para bot√≥n interactivo\nconst mensajeBoton = `üìã IR AL MEN√ö PRINCIPAL O DIRECTAMENTE SACAR TURNO`;\n\n// Retornar el resultado en JSON\nreturn [{\n  json: {\n    listadoMedicos: listadoMedicos.trim(),\n    mensaje: mensaje,\n    mensajeBoton: mensajeBoton,\n    medicosPorEspecialidad: medicosPorEspecialidad,\n    totalEspecialidades: especialidadesOrdenadas.length,\n    totalMedicos: items.length,\n    // Estructura completa para mensaje interactivo\n    interactive_body: mensajeBoton,\n    interactive_button_id: \"menu_principal\",\n    interactive_button_title: \"MENU PRINCIPAL\"\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3248,2032],"id":"48555e51-50ac-4bb5-b7a8-cf07a10161bb","name":"Msg preparado"},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"mhwp4qt6r2d7ymm","returnAll":true,"options":{}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[3024,2032],"id":"4646a8a1-8ec5-46a1-a9a2-1f1064fec319","name":"get_medicos1","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"mi8p2u7tvuplzt5","returnAll":true,"options":{}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[3040,2384],"id":"24b2ab9d-a9c4-489d-9553-66ea09d9927a","name":"get_especialidades","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"jsCode":"// Obtener todas las especialidades\nconst items = $input.all();\n\n// Extraer las especialidades y eliminar duplicados\nconst especialidades = [...new Set(items.map(item => item.json.Especialidad))];\n\n// Ordenar alfab√©ticamente\nespecialidades.sort();\n\n// Crear el listado formateado para WhatsApp\nconst listadoEspecialidades = especialidades\n  .map((esp, index) => `${index + 1}. ${esp.toUpperCase()}`)\n  .join('\\n');\n\n// Crear el mensaje completo en may√∫sculas\nconst mensaje = `üè• *ESPECIALIDADES DISPONIBLES*\\n\\nüìã *CONTAMOS CON LAS SIGUIENTES ESPECIALIDADES:*\\n\\n${listadoEspecialidades}\\n\\nüëá *PRESIONE SI QUIERE SACAR UN TURNO Y SIGA LAS INDICACIONES*\\n\\nüìû *CONTACTO:*\\n(0221) 4906310\\nLUNES A VIERNES: 8:00-20:00HS`;\n\n// Mensaje para bot√≥n interactivo\nconst mensajeBoton = `üìã SACAR UN TURNO O IR AL  MENU PRINCIPAL`;\n\n// Retornar tanto el array como el mensaje\nreturn [{\n  json: {\n    especialidades: especialidades,\n    total: especialidades.length,\n    listadoEspecialidades: listadoEspecialidades,\n    mensaje: mensaje,\n    mensajeBoton: mensajeBoton,\n    // Estructura completa para mensaje interactivo\n    interactive_body: mensajeBoton,\n    interactive_button_id: \"menu_principal\",\n    interactive_button_title: \"MENU PRINCIPAL\"\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3264,2384],"id":"ced25d41-013e-4a29-b52a-c1adb4ad6d6b","name":"Msg preparado1"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filtro Tipo Mensaje').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"{{ $('Msg preparado1').item.json.mensajeBoton }}\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"sacar_turno\",\n            \"title\": \"TOMAR TURNO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"menu_principal\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3696,2384],"id":"03b12342-4b12-404a-866b-32153e08be4e","name":"ENVIA-> MENU-SACAR TURNO","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filtro Tipo Mensaje').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"{{ $('Msg preparado').item.json.mensajeBoton }}\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"sacar_turno\",\n            \"title\": \"SACAR TURNO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"menu_principal\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3680,2032],"id":"25aae86d-3d94-42a7-b079-fa276db6ef6a","name":"ENVIA-> MENU-SACAR TURNO1","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"content":"## INFO GENERAL - ESPECIALIDADES","height":304,"width":992,"color":5},"type":"n8n-nodes-base.stickyNote","position":[2896,2288],"typeVersion":1,"id":"5078e68a-be65-4f92-93be-ea26a2420bae","name":"Sticky Note3"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"flujo-medicos","leftValue":"={{ $json.tipoFlujo }}","rightValue":"medicos","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"üë®‚Äç‚öïÔ∏è M√âDICOS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"flujo-especialidades","leftValue":"={{ $json.tipoFlujo }}","rightValue":"especialidades","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"ü©∫ ESPECIALIDADES"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"flujo-directo","leftValue":"={{ $json.esFlujoDirecto }}","rightValue":"","operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"renameOutput":true,"outputKey":"üí¨ MENSAJE DIRECTO"}]},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[2752,2368],"id":"f8d9e33b-3ab9-4586-a554-0d9cef406970","name":"üîÄ SWITCH INFO FLUJOS"},{"parameters":{"content":"## INFO GENERAL - OTROS MENSAJES","height":304,"width":992,"color":5},"type":"n8n-nodes-base.stickyNote","position":[2896,2624],"typeVersion":1,"id":"d5a7026e-ee01-48ea-8639-21b31c62fa4b","name":"Sticky Note"},{"parameters":{"operation":"set","key":"=status:{{ $('msg').item.json.body.to }}","value":"={{ $('msg').item.json.estadoActual }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[7024,-640],"id":"67d6fd5b-abe7-40d0-9d38-98d15d7fd0e2","name":"STATUS:MENU=1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"\n\nconst contactNumber = $json.contactNumber;\n\n// Mensaje con botones para elegir tipo de turno\nconst mensajeBody = {\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": contactNumber,\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ü´Ä INSTITUTO DE CARDIOLOG√çA LA PLATA\"\n    },\n    \"body\": {\n      \"text\": \"Recuerda que MOMENT√ÅNEAMENTE SOLO DAMOS LOS TURNOS M√ÅS PR√ìXIMOS\\n\\nSi necesita una fecha m√°s lejana elija la opci√≥n de administraci√≥n\"\n    },\n    \"footer\": {\n      \"text\": \"üìÖ Lun-Vie 8-20hs\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"con-consultorio\",\n            \"title\": \"TURNOS CONSULTORIO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"con-estudio\",\n            \"title\": \"TURNOS ESTUDIO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"volver-atras\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n};\n\n// Log\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\nconsole.log('üìÖ SELECCIONAR TIPO DE TURNO');\nconsole.log('üì± Destinatario:', contactNumber);\nconsole.log('üéØ Estado: TURNOS:TIPO_TURNO');\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n\n// Retornar\nreturn [{\n  json: {\n    body: mensajeBody,\n    categoria: 'INICIAR_TOMAR_TURNO',\n    contactNumber: contactNumber,\n    estadoActual: 'TURNOS:TIPO_TURNO'\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2576,624],"id":"d16ce95b-d7ce-455d-8784-c9b4c92248f8","name":"üé´ Router Gesti√≥n Turnos1"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.body.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.body.recipient_type }}"},{"name":"to","value":"={{ $json.body.to }}"},{"name":"type","value":"={{ $json.body.type }}"},{"name":"interactive","value":"={{ $json.body.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2800,624],"id":"cb5b0f5d-4bcc-4dc8-9068-3612fce47b25","name":"PACIENTE REGISTRADO","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=status:{{ $('msg_clasificador').first().json.contactNumber }}","value":"={{ $('üé´ Router Gesti√≥n Turnos1').item.json.estadoActual }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3024,624],"id":"5940038d-ff9e-4f3a-9b65-327c6099cdf7","name":"‚è±Ô∏è STATUS PRIMERA VEZ2","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"validar-dni","leftValue":"={{ $json.categoria }}","rightValue":"VALIDAR_DNI","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"üîç VALIDAR DNI (IA)"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"ingreso-dni-menu","leftValue":"={{ $json.categoria }}","rightValue":"INGRESO_DNI","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"üìã DNI DESDE MENU"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"ingreso-datos","leftValue":"={{ ['INGRESO_DATOS_PACIENTE','SOLICITAR_DNI'].includes($json.categoria) || $json.estadoAnterior === 'PACIENTE_NUEVO_ERROR'}}","rightValue":"INGRESO_DATOS_PACIENTE","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"üìù INGRESO DATOS"}]},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[2352,848],"id":"4b4e02f2-b243-46cf-aea8-d5cebfbc5af6","name":"üîÄ SWITCH DATOS PACIENTE"},{"parameters":{"jsCode":"// ============================================\n// MENSAJE: SOLICITAR DNI\n// ============================================\n// Solicita al usuario que ingrese su DNI para validaci√≥n\n// ============================================\n\nconst contactNumber = $json.contactNumber;\n\n// Mensaje solicitando DNI\nconst mensajeBody = {\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": contactNumber,\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"*üìã PACIENTE REGISTRADO*\\n\\n*PARA CONTINUAR CON SU TURNO, NECESITO SU DNI:*\\n\\n*üìù FORMATO:*\\nENV√çE SOLO SU N√öMERO DE DNI (SIN PUNTOS NI ESPACIOS)\\n\\n*EJEMPLO:*\\n_35987654_\\n\\nüëá *ESCRIBA SU DNI Y ENV√çELO*\"\n    },\n    \"footer\": {\n      \"text\": \"üìÖ LUN-VIE 8-20HS\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"volver-atras\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n};\n\n// Log\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\nconsole.log('üìù SOLICITAR DNI');\nconsole.log('üì± Destinatario:', contactNumber);\nconsole.log('üéØ Estado: DATOS:SOLICITAR_DNI');\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n\n// Retornar\nreturn [{\n  json: {\n    body: mensajeBody,\n    categoria: 'PACIENTE_REGISTRADO',\n    contactNumber: contactNumber,\n    estadoActual: 'DATOS:SOLICITAR_DNI'\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[6576,-976],"id":"b00ca8eb-63bf-4e0e-af83-d963fb269f22","name":"PACIENTE REGISTRADO1"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.body.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.body.recipient_type }}"},{"name":"to","value":"={{ $json.body.to }}"},{"name":"type","value":"={{ $json.body.type }}"},{"name":"interactive","value":"={{ $json.body.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[6800,-976],"id":"3ad521e9-9751-48bd-94e2-eb3b92eec7f1","name":"SOLICITAR DNI","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=status:{{ $('msg_clasificador').first().json.contactNumber }}","value":"={{ $('üîÄ SWITCH GESTI√ìN TURNOS').item.json.estadoActual }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[7024,-976],"id":"e0126e3b-48cf-4c0d-adf6-8172ea2682bf","name":"‚è±Ô∏è STATUS PRIMERA VEZ3","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"068a964d-25b6-4a1f-8e05-c47dd2fea4b7","leftValue":"={{ $json.output.ERROR }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[3376,-1872],"id":"a55285a1-e44e-40de-9955-35c28402c5b9","name":"Error informacion de usuario"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Variables').first().json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"‚ö†Ô∏è {{ $json.output.ERROR_MESSAGE }}\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3616,-2000],"id":"866ce320-fd2f-439d-8e76-8a57af12a2d0","name":"‚ö†Ô∏è DATOS INCORRECTOS","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[2800,-2016],"id":"54128eab-db51-4745-b08d-97cf489566ea","name":"OpenRouter Chat Model1","credentials":{"openRouterApi":{"id":"ZlcbniUoDvrFqCIJ","name":"OpenRouter ICLP"}}},{"parameters":{"jsonSchemaExample":"{  \n  \"DNI\": \"string\",  \n  \"ERROR\": false,\n  \"ERROR_MESSAGE\": \"\"\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[3216,-2048],"id":"c5603a0a-1562-4809-bc71-a220f7058502","name":"Structured Output Parser1"},{"parameters":{"promptType":"define","text":"=dni usuario :{{ $('üîÄ ROUTER PRINCIPAL').first().json.mensaje }}","hasOutputParser":true,"options":{"systemMessage":"=# TAREA\n\n- Analizar el contido que llega y ordenarlo en un objeto JSON\n\n{\n  \n  \"DNI\":\"\",\n  \"ERROR\": false,\n  \"ERROR_MESSAGE\": \"\"\n}\n\n# IMPORTANTE\n\n- Debes analizar si el dni esta bien escrito, debe contener entre 7 y 8 digitos ya que los usuarios mayores poseen 7 digitos y los mas actuales 8 digitos.\n- No deben contener espacios ni puntos, si el mensaje del usuario es > DNI 35.946.257 debes formatearlo solo al numero 35946257\n- Si da error debes preparar un mensaje de devolucion para colocarlo en ERROR_MESSAGE"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[2976,-1872],"id":"7d857513-1182-478b-afdf-ee84247e1144","name":"AI Agent"},{"parameters":{"workflowId":{"__rl":true,"value":"oB7pjyME2Gvo5moH","mode":"list","cachedResultName":"SUB - GET_PACIENTE"},"workflowInputs":{"mappingMode":"defineBelow","value":{"dni":"={{ $json.output.DNI || $('DNI1').item.json.status.replace('DNI:', '') ||$('YA SE ACTIVO MENU?').item.json.status.replace('DNI:', '')  }}","telefono":"={{ $('Variables').first().json.contactNumber }}"},"matchingColumns":["dni"],"schema":[{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"telefono","displayName":"telefono","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[3632,-1648],"id":"c48931ec-16b0-460b-b62a-d7ec7ca3302b","name":"Get_Paciente1"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Variables').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ü´Ä ICLP - GESTI√ìN DE TURNOS\"\n    },\n    \"body\": {\n      \"text\": \"*HOLA {{ $json.output.paciente_nombre }} ‚úÖ*\\n\\n*üìã SUS DATOS EN NUESTRO SISTEMA:*\\n\\nüë§ *NOMBRE:* *{{ $json.output.paciente_nombre }}*\\n\\nüÜî *DNI:* *{{ $json.output.paciente_dni }}*\\n\\nüìû *TEL√âFONO:* *{{ $json.output.paciente_celular }}*\\n\\n‚úÖ *SI LOS DATOS SON CORRECTOS, PRESIONE CONTINUAR*\\n\\n‚ö†Ô∏è *¬øHAY ALG√öN ERROR?*\\nCOMUN√çQUESE CON ADMINISTRACI√ìN:\\nüìû (0221) 490-6310\"\n    },\n    \"footer\": {\n      \"text\": \"üìÖ LUN-VIE 8-20HS\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"CONTINUAR\",\n            \"title\": \"CONTINUAR\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"MENU-PRINCIPAL\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[4112,-1552],"id":"da26a639-3646-4372-989e-5c3b330a6843","name":"‚úÖ DATOS VALIDADOS","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"m1kjf7ed0befl04","returnAll":true,"options":{}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[2464,-1872],"id":"998ac071-1bf3-4563-a521-c51793186845","name":"obra_social1","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"jsCode":"return {\n    total: $input.all().length,\n    obrasociales: $input.all().map(item => ({\n        Id_os: item.json.Id,\n        nombre_obrasocial: item.json.nombre_obrasocial,\n        obrasocial: item.json.obrasocial\n    }))\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2688,-1872],"id":"18d945cf-145d-4603-820d-a5cbc6be7894","name":"Code8"},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Variables').first().json.contactNumber }}","sessionTTL":600,"contextWindowLength":10},"type":"@n8n/n8n-nodes-langchain.memoryRedisChat","typeVersion":1.5,"position":[2800,-1600],"id":"f91ee28f-0b05-4daa-9c81-66e2fa625846","name":"Redis Chat Memory","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Variables').first().json.contactNumber }}","value":"=DATOS:DNI_VALIDADO:{{ $('Get_Paciente1').item.json.output.paciente_dni }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[4336,-1552],"id":"6780eb47-fe39-4fc0-be9c-f2148d7c558a","name":"DNI VERIFICADO","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Variables').first().json.contactNumber }}","value":"=DATOS:DNI_VALIDADO:{{ $('Get_Paciente1').item.json.output.paciente_dni }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[4752,-1744],"id":"b6ad1694-e55c-4111-bf90-0e799690043a","name":"DNI INCORRECTO1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"const contactNumber = $json.contactNumber;\n\n// Mensaje con botones de gesti√≥n de turnos\nconst mensajeBody = {\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": contactNumber,\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ü´Ä ICLP - GESTI√ìN DE TURNOS\"\n    },\n    \"body\": {\n      \"text\": \"*üìã GESTI√ìN DE TURNOS*\\n\\n*¬øQU√â DESEA HACER?*\\n\\n*üìÖ TOMAR TURNO*\\n‚Üí AGENDAR UNA NUEVA CONSULTA CON NUESTROS ESPECIALISTAS\\n\\n*‚ùå CANCELAR TURNO*\\n‚Üí ANULAR UN TURNO YA PROGRAMADO\\n\\n*üìù MIS TURNO/S*\\n‚Üí VER SUS PR√ìXIMAS CITAS AGENDADAS\\n\\nüëá *SELECCIONE UNA OPCI√ìN PARA CONTINUAR*\"\n    },\n    \"footer\": {\n      \"text\": \"üìÖ LUN-VIE 8-20HS\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"tomar-turno\",\n            \"title\": \"TOMAR TURNO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"cancelar-turno\",\n            \"title\": \"CANCELAR TURNO\"\n          }          \n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"mis-turnos\",\n            \"title\": \"MIS TURNOS\"\n          }        \n        }\n      ]\n    }\n  }\n};\n\n// Log\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\nconsole.log('üìã MEN√ö GESTI√ìN DE TURNOS');\nconsole.log('üì± Destinatario:', contactNumber);\nconsole.log('üéØ Estado: MENU:GESTION_TURNOS');\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n\n// Retornar\nreturn [{\n  json: {\n    body: mensajeBody,\n    categoria: 'MENU_GESTION_TURNOS',\n    contactNumber: contactNumber,\n    estadoActual: 'MENU:GESTION_TURNOS'\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[6576,-640],"id":"ee659f8e-ff1f-47d4-ad03-4b4f75568e69","name":"msg"},{"parameters":{"operation":"set","key":"=status:{{ $('LISTA_ESPECIALIDADES_BLOQUES').item.json.to }}","value":"={{ $('LISTA_ESPECIALIDADES_BLOQUES').item.json.estadoActual }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[7232,112],"id":"fe77f0d5-399a-40eb-81ed-c6d1ac9fc6ce","name":"ESPECIALIDADES1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.recipient_type }}"},{"name":"to","value":"={{ $json.to }}"},{"name":"type","value":"={{ $json.type }}"},{"name":"interactive","value":"={{ $json.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[7008,112],"id":"f7c5bd64-e85f-4eaa-9953-79b96c861bc0","name":"ü©ª ESPECIALIDADES1","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"mi8p2u7tvuplzt5","returnAll":true,"options":{"sort":{"property":[{"field":"Especialidad"}]}}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[6560,112],"id":"0b4e5411-0a3d-4b4b-b1ab-a16c8b7a13f9","name":"Get_Especialidades1","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"jsCode":"// ============================================\n// LISTA DE ESPECIALIDADES CON BLOQUES\n// ============================================\n// Divide las especialidades en dos bloques:\n// - Primer bloque: 9 especialidades + bot√≥n VER M√ÅS\n// - Segundo bloque: Especialidades restantes\n// ============================================\n\n// Obtener todas las especialidades del input\nconst items = $input.all();\n\n// Obtener contactNumber desde m√∫ltiples fuentes posibles\nlet contactNumber;\ntry {\n  // Intentar obtener del nodo clasificador\n  contactNumber = $('msg_clasificador').first().json.contactNumber;\n} catch (e) {\n  try {\n    // Si no, intentar del router principal\n    contactNumber = $('ROUTER PRINCIPAL').first().json.contactNumber;\n  } catch (e2) {\n    try {\n      // Si no, intentar del switch gesti√≥n turnos\n      contactNumber = $('SWITCH GESTI√ìN TURNOS').first().json.contactNumber;\n    } catch (e3) {\n      // √öltimo recurso: buscar en cualquier item del input\n      contactNumber = items[0]?.json?.contactNumber || $json.contactNumber;\n    }\n  }\n}\n\n// Verificar el estado actual para determinar qu√© bloque mostrar\nlet estadoActual;\ntry {\n  estadoActual = $('msg_clasificador').first().json.estadoActual || \n                 $('msg_clasificador').first().json.nuevoEstado || \n                 $json.estadoActual || \n                 $json.nuevoEstado || \n                 'TURNOS:ESPECIALIDADES';\n} catch (e) {\n  estadoActual = $json.estadoActual || $json.nuevoEstado || 'TURNOS:ESPECIALIDADES';\n}\n\nconst esVerMas = estadoActual === 'TURNOS:ESPECIALIDADES:VER_MAS';\n\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\nconsole.log('ü©∫ PREPARANDO ESPECIALIDADES');\nconsole.log('üì± Contact Number:', contactNumber);\nconsole.log('üìä Estado actual:', estadoActual);\nconsole.log('üìã Bloque:', esVerMas ? 'VER M√ÅS (segundo)' : 'PRINCIPAL (primero)');\nconsole.log('üì¶ Total especialidades:', items.length);\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n\n// Crear el array de rows para TODAS las especialidades\nconst todasLasRows = items.map(item => {\n  const especialidad = item.json.Especialidad;\n  const codigo = item.json.Codigo;\n  \n  // Convertir a may√∫sculas\n  let nombreEspecialidad = especialidad.toUpperCase();\n  \n  // Si tiene par√©ntesis, tomar solo lo que est√° antes\n  if (nombreEspecialidad.includes('(')) {\n    nombreEspecialidad = nombreEspecialidad.split('(')[0].trim();\n  }\n  \n  // Si tiene barra, tomar solo la primera parte\n  if (nombreEspecialidad.includes('/')) {\n    nombreEspecialidad = nombreEspecialidad.split('/')[0].trim();\n  }\n  \n  // Si tiene m√∫ltiples palabras, tomar solo la primera palabra\n  if (nombreEspecialidad.includes(' ')) {\n    nombreEspecialidad = nombreEspecialidad.split(' ')[0];\n  }\n  \n  // Crear el title con formato: ESPECIALIDAD-CODIGO\n  let title = `${nombreEspecialidad}-${codigo}`;\n  \n  // Si a√∫n es muy largo, cortar a 24 caracteres\n  if (title.length > 24) {\n    title = title.substring(0, 21) + '...';\n  }\n  \n  // Crear descripci√≥n completa\n  let description = especialidad;\n  \n  // WhatsApp permite M√ÅXIMO 72 caracteres en ROW_DESCRIPTION\n  if (description.length > 72) {\n    description = description.substring(0, 69) + '...';\n  }\n  \n  return {\n    id: codigo,\n    title: title,\n    description: description\n  };\n});\n\n// Dividir en dos bloques\nconst primerBloque = todasLasRows.slice(0, 9);\nconst segundoBloque = todasLasRows.slice(9);\n\n// Seleccionar qu√© bloque mostrar\nlet rows;\nlet headerText;\nlet bodyText;\nlet nuevoEstado;\n\nif (esVerMas) {\n  // SEGUNDO BLOQUE (VER M√ÅS)\n  rows = segundoBloque;\n  headerText = \"üìã M√ÅS ESPECIALIDADES\";\n  bodyText = \"*Estas son las especialidades restantes:*\\n\\nüëá *SELECCION√Å LA ESPECIALIDAD QUE NECESIT√ÅS*\\n\\nLuego podr√°s elegir el m√©dico y horario disponible.\";\n  nuevoEstado = 'TURNOS:ESPECIALIDADES:VER_MAS';\n  \n  // Agregar bot√≥n \"VOLVER\" para regresar al primer bloque\n  rows.push({\n    id: \"volver-especialidades-anterior\",\n    title: \"‚¨ÖÔ∏è VER ANTERIORES\",\n    description: \"Regresar a las primeras especialidades\"\n  });\n  \n  console.log('‚úÖ Mostrando segundo bloque:', segundoBloque.length, 'especialidades + bot√≥n VOLVER');\n} else {\n  // PRIMER BLOQUE (con bot√≥n VER M√ÅS)\n  rows = primerBloque;\n  headerText = \"ü©∫ ESPECIALIDADES\";\n  bodyText = \"*üìã ¬øC√ìMO FUNCIONA?*\\n\\n*1Ô∏è‚É£ ELEG√ç LA ESPECIALIDAD*\\nPRESION√Å EL BOT√ìN Y SELECCION√Å LA ESPECIALIDAD M√âDICA QUE NECESIT√ÅS\\n\\n*2Ô∏è‚É£ ELEG√ç EL M√âDICO*\\nLUEGO PODR√ÅS VER Y SELECCIONAR LOS PROFESIONALES DISPONIBLES EN ESA ESPECIALIDAD\\n\\nüëá *PRESION√Å PARA COMENZAR*\";\n  nuevoEstado = 'TURNOS:ESPECIALIDADES';\n  \n  // Agregar bot√≥n \"VER M√ÅS\" solo si hay m√°s especialidades\n  if (segundoBloque.length > 0) {\n    rows.push({\n      id: \"ver-mas\",\n      title: \"‚ûï VER M√ÅS ESPECIALIDADES\",\n      description: \"Ver m√°s opciones disponibles\"\n    });\n    console.log('‚úÖ Mostrando primer bloque:', primerBloque.length, 'especialidades + bot√≥n VER M√ÅS');\n  } else {\n    console.log('‚úÖ Mostrando todas las especialidades:', rows.length, '(no hay bot√≥n VER M√ÅS)');\n  }\n}\n\n// Retornar el JSON completo con la estructura de WhatsApp\nreturn [{\n  json: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: contactNumber,\n    type: \"interactive\",\n    interactive: {\n      type: \"list\",\n      header: {\n        type: \"text\",\n        text: headerText\n      },\n      body: {\n        text: bodyText\n      },\n      footer: {\n        text: \"üìÖ LUN-VIE 8-20HS\"\n      },\n      action: {\n        button: \"VER ESPECIALIDADES\",\n        sections: [\n          {\n            title: \"ELEGIR UNA OPCI√ìN\",\n            rows: rows\n          }\n        ]\n      }\n    },\n    \n    // Metadatos para el siguiente nodo\n    contactNumber: contactNumber,\n    estadoActual: nuevoEstado,\n    bloqueActual: esVerMas ? 'segundo' : 'primero',\n    totalEspecialidades: todasLasRows.length\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[6784,112],"id":"83014b31-4530-481d-babf-9b83ce86a61f","name":"LISTA_ESPECIALIDADES_BLOQUES"},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"mhwp4qt6r2d7ymm","returnAll":true,"options":{"fields":[],"where":"=(Codigo,eq,{{ $json.metadata.codigoEspecialidad }})"}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[6560,256],"id":"5bb5a225-7476-4425-b5c7-959500633839","name":"get_medicos2","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"operation":"set","key":"=status:{{ $('LISTA_MEDICOS').item.json.to }}","value":"={{ $('LISTA_MEDICOS').first().json.estadoActual }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[7232,256],"id":"6e479b57-0111-4acc-b1fc-3cc3d26a1ac5","name":"ü©∫ MEDICOS2","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"// ============================================\n// LISTA DE M√âDICOS POR ESPECIALIDAD\n// ============================================\n// Muestra los m√©dicos disponibles para la especialidad seleccionada\n// ============================================\n\n// Obtener todos los m√©dicos del input\nconst items = $input.all();\n\n// Obtener contactNumber desde m√∫ltiples fuentes posibles\nlet contactNumber;\ntry {\n  // Intentar obtener del nodo clasificador\n  contactNumber = $('msg_clasificador').first().json.contactNumber;\n} catch (e) {\n  try {\n    // Si no, intentar del router principal\n    contactNumber = $('ROUTER PRINCIPAL').first().json.contactNumber;\n  } catch (e2) {\n    try {\n      // Si no, intentar del switch gesti√≥n turnos\n      contactNumber = $('SWITCH GESTI√ìN TURNOS').first().json.contactNumber;\n    } catch (e3) {\n      // √öltimo recurso: buscar en cualquier item del input\n      contactNumber = items[0]?.json?.contactNumber || $json.contactNumber;\n    }\n  }\n}\n\n// Obtener estado actual y metadata\nlet estadoActual;\nlet especialidadSeleccionada;\nlet codigoEspecialidad;\ntry {\n  const clasificador = $('msg_clasificador').first().json;\n  estadoActual = clasificador.estadoActual || clasificador.nuevoEstado || 'TURNOS:MEDICOS';\n  especialidadSeleccionada = clasificador.metadata?.especialidad || 'Especialidad';\n  codigoEspecialidad = clasificador.metadata?.codigoEspecialidad || '';\n} catch (e) {\n  estadoActual = $json.estadoActual || $json.nuevoEstado || 'TURNOS:MEDICOS';\n  especialidadSeleccionada = $json.especialidad || 'Especialidad';\n  codigoEspecialidad = $json.codigoEspecialidad || '';\n}\n\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\nconsole.log('üë®‚Äç‚öïÔ∏è PREPARANDO LISTA DE M√âDICOS');\nconsole.log('üì± Contact Number:', contactNumber);\nconsole.log('üìä Estado actual:', estadoActual);\nconsole.log('ü©∫ Especialidad:', especialidadSeleccionada);\nconsole.log('üî¢ C√≥digo especialidad:', codigoEspecialidad);\nconsole.log('üì¶ Total m√©dicos:', items.length);\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n\n// Determinar qu√© bloque mostrar basado en el estado\nconst MEDICOS_POR_BLOQUE = 9;\nlet indiceInicio = 0;\nlet indiceFin = MEDICOS_POR_BLOQUE;\nlet mostrarBotonVerMas = false;\nlet mostrarBotonVerAnteriores = false;\n\nif (estadoActual === 'TURNOS:MEDICOS') {\n  // Primer bloque: m√©dicos 0-8\n  indiceInicio = 0;\n  indiceFin = MEDICOS_POR_BLOQUE;\n  mostrarBotonVerMas = items.length > MEDICOS_POR_BLOQUE;\n  mostrarBotonVerAnteriores = false;\n  console.log('üìç Mostrando PRIMER BLOQUE (m√©dicos 1-9)');\n} else if (estadoActual === 'TURNOS:MEDICOS:VER_MAS') {\n  // Segundo bloque: m√©dicos 9 en adelante\n  indiceInicio = MEDICOS_POR_BLOQUE;\n  indiceFin = items.length; // Mostrar todos los restantes\n  mostrarBotonVerMas = false;\n  mostrarBotonVerAnteriores = true;\n  console.log(`üìç Mostrando SEGUNDO BLOQUE (m√©dicos ${indiceInicio + 1}-${indiceFin})`);\n}\n\nconsole.log(`üéØ Rango a mostrar: ${indiceInicio} a ${indiceFin}`);\nconsole.log(`‚ûï Ver M√°s: ${mostrarBotonVerMas}`);\nconsole.log(`‚¨ÖÔ∏è Ver Anteriores: ${mostrarBotonVerAnteriores}`);\n\n// Filtrar m√©dicos del bloque actual\nconst medicosBloque = items.slice(indiceInicio, indiceFin);\nconsole.log(`‚úÇÔ∏è M√©dicos filtrados para este bloque: ${medicosBloque.length}`);\n\n// Crear el array de rows din√°micamente\nconst rows = medicosBloque.map(item => {\n  const medico = item.json.Medico;\n  const matricula = item.json.Matricula;\n  \n  // Convertir a may√∫sculas\n  let nombreMedico = medico.toUpperCase();\n  \n  // Si tiene par√©ntesis, tomar solo lo que est√° antes\n  if (nombreMedico.includes('(')) {\n    nombreMedico = nombreMedico.split('(')[0].trim();\n  }\n  \n  // Si tiene barra, tomar solo la primera parte\n  if (nombreMedico.includes('/')) {\n    nombreMedico = nombreMedico.split('/')[0].trim();\n  }\n  \n  // Separar palabras\n  const palabras = nombreMedico.split(' ');\n  \n  // PRIORIDAD 1: Intentar con APELLIDO NOMBRE-MATRICULA\n  let title = `${nombreMedico}-${matricula}`;\n  \n  // Si supera 24 caracteres, usar solo APELLIDO-MATRICULA\n  if (title.length > 24 && palabras.length >= 2) {\n    // Tomar solo el primer apellido (primera palabra)\n    const apellido = palabras[0];\n    title = `${apellido}-${matricula}`;\n    \n    // Si a√∫n supera 24 caracteres, recortar el apellido\n    if (title.length > 24) {\n      const espacioDisponible = 24 - matricula.toString().length - 1; // -1 por el gui√≥n\n      const apellidoRecortado = apellido.substring(0, espacioDisponible);\n      title = `${apellidoRecortado}-${matricula}`;\n    }\n  }\n  // Si tiene solo una palabra y supera 24, recortar\n  else if (title.length > 24) {\n    const espacioDisponible = 24 - matricula.toString().length - 1;\n    const nombreRecortado = nombreMedico.substring(0, espacioDisponible);\n    title = `${nombreRecortado}-${matricula}`;\n  }\n  \n  // Crear descripci√≥n completa en may√∫sculas\n  let description = medico.toUpperCase();\n  \n  // WhatsApp permite M√ÅXIMO 72 caracteres en ROW_DESCRIPTION\n  if (description.length > 72) {\n    description = description.substring(0, 69) + '...';\n  }\n  \n  return {\n    id: matricula,\n    title: title,\n    description: description\n  };\n});\n\nconsole.log('‚úÖ M√©dicos procesados:', rows.length);\n\n// Agregar botones de navegaci√≥n si es necesario\nconst botonesNavegacion = [];\n\nif (mostrarBotonVerAnteriores) {\n  botonesNavegacion.push({\n    id: 'ver-anteriores',\n    title: '‚¨ÖÔ∏è VER ANTERIORES',\n    description: 'Ver m√©dicos anteriores'\n  });\n}\n\nif (mostrarBotonVerMas) {\n  botonesNavegacion.push({\n    id: 'ver-mas',\n    title: '‚ûï VER M√ÅS M√âDICOS',\n    description: 'Ver m√°s m√©dicos disponibles'\n  });\n}\n\n// Agregar botones al final de las rows\nconst rowsFinales = [...rows, ...botonesNavegacion];\nconsole.log(`üîò Botones agregados: ${botonesNavegacion.length}`);\n\n// Preparar texto del body seg√∫n el bloque\nlet bodyText;\nif (estadoActual === 'TURNOS:MEDICOS') {\n  bodyText = `*‚úÖ ENCONTRAMOS ${items.length} M√âDICO${items.length > 1 ? 'S' : ''} DISPONIBLE${items.length > 1 ? 'S' : ''}*\\n\\n*ü©∫ ESPECIALIDAD:*\\n${especialidadSeleccionada}\\n\\n*üëá MOSTRANDO ${medicosBloque.length} DE ${items.length} PROFESIONALES:*`;\n} else {\n  bodyText = `*üë®‚Äç‚öïÔ∏è M√ÅS PROFESIONALES DISPONIBLES*\\n\\n*ü©∫ ESPECIALIDAD:*\\n${especialidadSeleccionada}\\n\\n*üëá MOSTRANDO M√âDICOS ${indiceInicio + 1} AL ${indiceFin} (TOTAL: ${items.length}):*`;\n}\n\n// Retornar el JSON completo con la estructura de WhatsApp\nreturn [{\n  json: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: contactNumber,\n    type: \"interactive\",\n    interactive: {\n      type: \"list\",\n      header: {\n        type: \"text\",\n        text: \"üë®‚Äç‚öïÔ∏è PROFESIONALES\"\n      },\n      body: {\n        text: bodyText\n      },\n      footer: {\n        text: \"üìÖ LUN-VIE 8-20HS\"\n      },\n      action: {\n        button: \"VER M√âDICOS\",\n        sections: [\n          {\n            title: \"ELEGIR PROFESIONAL\",\n            rows: rowsFinales\n          }\n        ]\n      }\n    },\n    \n    // Metadatos para el siguiente nodo\n    contactNumber: contactNumber,\n    estadoActual: estadoActual,\n    especialidadSeleccionada: especialidadSeleccionada,\n    codigoEspecialidad: codigoEspecialidad,\n    totalMedicos: items.length,\n    medicosMostrados: medicosBloque.length\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[6784,256],"id":"816eb364-229b-45d8-bdbc-e9dffc8f5492","name":"LISTA_MEDICOS"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.recipient_type }}"},{"name":"to","value":"={{ $json.to }}"},{"name":"type","value":"={{ $json.type }}"},{"name":"interactive","value":"={{ $json.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[7008,256],"id":"81b8e06c-b3ff-4b05-b2c6-f50f03937e2b","name":"Medicos2","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"workflowId":{"__rl":true,"value":"kmoVJGP4RL3PTi16","mode":"list","cachedResultName":"SUB - HORARIOS_TURNOS_PROXIMOS"},"workflowInputs":{"mappingMode":"defineBelow","value":{"matricula":"={{ $('msg_clasificador').item.json.metadata.matricula.toNumber() }}","dni":"={{ $json.DATOS_PACIENTE.paciente_dni.toNumber() }}","fechaDesde":"={{ $now.toISO().toDateTime().format('yyyyMMdd').toNumber()}}"},"matchingColumns":[],"schema":[{"id":"matricula","displayName":"matricula","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"fechaDesde","displayName":"fechaDesde","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[6768,1008],"id":"88aecb5f-dfcc-4934-ba91-22c18f9fea59","name":"üìÖ Horarios Proximos"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json?.body?.messaging_product || $json.messaging_product }}"},{"name":"recipient_type","value":"={{ $json?.body?.recipient_type || $json.recipient_type }}"},{"name":"to","value":"={{ $('msg_clasificador').first().json.contactNumber }}"},{"name":"type","value":"={{ $json?.body?.type || $json.type }}"},{"name":"interactive","value":"={{ $json?.body?.interactive || $json.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[7216,1008],"id":"63f7f8d7-0f69-4db5-b49b-c9ce06646f1e","name":"üïê Fechas disponibles ","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"jsCode":"// ============================================\n// üìÖ LISTA DE HORARIOS DISPONIBLES\n// ============================================\n// Muestra lista interactiva con horarios disponibles\n// ============================================\n\n// Obtener todos los horarios del input\nconst fechasLibres = $input.first().json.fechas_libres;\n\n// Obtener DNI (de varias fuentes)\nlet dni = null;\ntry {\n  dni = Number($input.first().json.DNI || $input.first().json.dni);\n  console.log('‚úÖ DNI obtenido:', dni);\n} catch (e) {\n  console.log('‚ö†Ô∏è No se encontr√≥ DNI en $input');\n}\n\n// Obtener matr√≠cula (de varias fuentes)\nlet matricula = null;\ntry {\n  matricula = Number($input.first().json.matricula);\n  console.log('‚úÖ Matr√≠cula obtenida:', matricula);\n} catch (e) {\n  console.log('‚ö†Ô∏è No se encontr√≥ matr√≠cula en $input');\n}\n\n// Obtener m√©dico (opcional, para logs)\nlet medico = null;\ntry {\n  medico = $input.first().json.medico || $input.first().json.medicoSeleccionado;\n  console.log('‚úÖ M√©dico obtenido:', medico);\n} catch (e) {\n  console.log('‚ö†Ô∏è No se encontr√≥ m√©dico en $input');\n}\n\n// Obtener especialidad seleccionada (para volver a elegir m√©dico)\nlet especialidadSeleccionada = null;\nlet codigoEspecialidad = null;\n\ntry {\n  especialidadSeleccionada = $input.first().json.especialidadSeleccionada;\n  codigoEspecialidad = $input.first().json.codigoEspecialidad;\n  console.log('‚úÖ Especialidad:', especialidadSeleccionada, '- C√≥digo:', codigoEspecialidad);\n} catch (e) {\n  console.log('‚ö†Ô∏è No se encontr√≥ especialidad en $input');\n}\n\n// Si no se encontr√≥, buscar en Redis\nif (!especialidadSeleccionada || !codigoEspecialidad) {\n  try {\n    const redisValue = $('Redis').first().json.value;\n    const redisData = typeof redisValue === 'string' ? JSON.parse(redisValue) : redisValue;\n    \n    if (redisData && redisData.metadata) {\n      especialidadSeleccionada = redisData.metadata.especialidadSeleccionada;\n      codigoEspecialidad = redisData.metadata.codigoEspecialidad;\n      console.log('‚úÖ Especialidad desde Redis:', especialidadSeleccionada, '- C√≥digo:', codigoEspecialidad);\n    }\n  } catch (e) {\n    console.log('‚ö†Ô∏è No se pudo obtener especialidad desde Redis');\n  }\n}\n\n// Obtener contactNumber (de varias fuentes posibles)\nlet contactNumber = null;\ntry {\n  // Opci√≥n 1: Desde $input\n  contactNumber = $input.first().json.contactNumber;\n} catch (e) {\n  console.log('‚ö†Ô∏è No se encontr√≥ contactNumber en $input');\n}\n\n// Opci√≥n 2: Desde PREPARAR_DATOS_HORARIOS\nif (!contactNumber) {\n  try {\n    contactNumber = $('PREPARAR_DATOS_HORARIOS').first().json.contactNumber;\n  } catch (e) {\n    console.log('‚ö†Ô∏è No se encontr√≥ contactNumber en PREPARAR_DATOS_HORARIOS');\n  }\n}\n\n// Opci√≥n 3: Desde Redis\nif (!contactNumber) {\n  try {\n    const redisValue = $('Redis').first().json.value;\n    const redisData = typeof redisValue === 'string' ? JSON.parse(redisValue) : redisValue;\n    contactNumber = redisData.contactNumber;\n  } catch (e) {\n    console.log('‚ö†Ô∏è No se encontr√≥ contactNumber en Redis');\n  }\n}\n\n// Opci√≥n 4: Desde DATOS\nif (!contactNumber) {\n  try {\n    contactNumber = $('GET_PACIENTE_REGISTRADO').first().json.contactNumber;\n  } catch (e) {\n    console.log('‚ö†Ô∏è No se encontr√≥ contactNumber en DATOS');\n  }\n}\n\nconsole.log('üì± Contact Number:', contactNumber);\n\n// Si no hay fechas disponibles, devolver mensaje con botones\nif (!fechasLibres || fechasLibres.length === 0) {\n  console.log('‚ùå No hay fechas disponibles');\n  console.log('üìã Preparando opciones de navegaci√≥n...');\n  console.log('   Especialidad:', especialidadSeleccionada);\n  console.log('   C√≥digo:', codigoEspecialidad);\n  console.log('   M√©dico sin turnos:', medico);\n  \n  return [{\n    json: {\n      // Mensaje de WhatsApp\n      body: {\n        messaging_product: \"whatsapp\",\n        recipient_type: \"individual\",\n        to: contactNumber,\n        type: \"interactive\",\n        interactive: {\n          type: \"button\",\n          header: {\n            type: \"text\",\n            text: \"‚ùå SIN TURNOS DISPONIBLES\"\n          },\n          body: {\n            text: `*LO SENTIMOS, EL DR/A ${medico || 'SELECCIONADO/A'} NO TIENE TURNOS DISPONIBLES EN ESTE MOMENTO*\\n\\n*¬øQU√â DESEAS HACER?*\\n\\n*üë®‚Äç‚öïÔ∏è ELEGIR OTRO M√âDICO*\\n‚Üí VER OTROS PROFESIONALES DE ${especialidadSeleccionada || 'LA ESPECIALIDAD'}\\n\\n*üìû CONTACTAR ADMINISTRACI√ìN*\\n‚Üí *(0221) 490-6310*\\n‚Üí *LUN-VIE 8-20HS*`\n          },\n          footer: {\n            text: \"‚ù§Ô∏è CUIDAMOS TU SALUD CARDIOVASCULAR\"\n          },\n          action: {\n            buttons: [\n              {\n                type: \"reply\",\n                reply: {\n                  id: \"elegir-otro-medico\",\n                  title: \"ELEGIR OTRO M√âDICO\"\n                }\n              },\n              {\n                type: \"reply\",\n                reply: {\n                  id: \"menu-principal\",\n                  title: \"MENU PRINCIPAL\"\n                }\n              }\n            ]\n          }\n        }\n      },\n      \n      // Estado y metadata para Redis\n      categoria: 'SIN_TURNOS',\n      contactNumber: contactNumber,\n      DNI: dni,\n      estadoActual: 'TURNOS:SIN_HORARIOS',  // ‚¨ÖÔ∏è NUEVO ESTADO\n      metadata: {\n        dni: dni,\n        especialidadSeleccionada: especialidadSeleccionada,\n        codigoEspecialidad: codigoEspecialidad,\n        medicoSinTurnos: medico,  // Guardar qu√© m√©dico no ten√≠a turnos\n        matriculaSinTurnos: matricula\n      }\n    }\n  }];\n}\n\nconsole.log(`‚úÖ Fechas disponibles: ${fechasLibres.length}`);\n\n// Limitar a m√°ximo 9 horarios\nconst fechasLimitadas = fechasLibres.slice(0, 9);\n\n// Crear mapeo de horarios con Unix timestamp\nconst horariosMap = {};\n\n// Crear el array de rows din√°micamente\nconst rows = fechasLimitadas.map(item => {\n  // Obtener la fecha y hora del formato \"2025-10-14,\\n 11:20\"\n  const fechaHoraRaw = item.fecha_y_hora;\n  \n  // Limpiar y separar fecha y hora\n  const [fecha, hora] = fechaHoraRaw.replace(/\\n/g, '').split(',').map(s => s.trim());\n  \n  // Crear objeto DateTime\n  const dt = DateTime.fromISO(`${fecha}T${hora}`, { \n    zone: 'America/Argentina/Buenos_Aires' \n  });\n  \n  // Obtener d√≠a de la semana en espa√±ol\n  const diasSemana = ['DOM', 'LUN', 'MAR', 'MI√â', 'JUE', 'VIE', 'S√ÅB'];\n  const diaSemana = diasSemana[dt.weekday % 7];\n  \n  // Formatear fecha como DD/MM\n  const fechaFormateada = dt.toFormat('dd/MM');\n  \n  // Crear el title: D√çA DD/MM - HH:MM\n  let title = `${diaSemana} ${fechaFormateada} - ${hora}`;\n  \n  // Si a√∫n es muy largo, cortar a 24 caracteres\n  if (title.length > 24) {\n    title = title.substring(0, 21) + '...';\n  }\n  \n  // Crear descripci√≥n completa EN MAY√öSCULAS\n  let description = `${diaSemana} ${dt.toFormat('dd/MM/yyyy')} A LAS ${hora} HS`;\n  \n  // WhatsApp permite M√ÅXIMO 72 caracteres en ROW_DESCRIPTION\n  if (description.length > 72) {\n    description = description.substring(0, 69) + '...';\n  }\n  \n  // ID √∫nico: combinar fecha y hora sin separadores\n  const id = `${fecha.replace(/-/g, '')}-${hora.replace(/:/g, '')}`;\n  \n  // Convertir a Unix timestamp (milisegundos)\n  const fechaUnix = dt.toMillis();\n  \n  // Convertir hora a formato HHMM (string de 4 d√≠gitos)\n  const horaFormato = hora.replace(':', '').padStart(4, '0');\n  \n  // Guardar en el mapa para uso posterior\n  horariosMap[id] = {\n    fechaUnix: fechaUnix,           // Unix timestamp en ms\n    hora: horaFormato,               // \"1540\" formato HHMM\n    fechaOriginal: fecha,            // \"2025-10-14\"\n    horaOriginal: hora,              // \"15:40\"\n    title: title                     // Para mostrar al usuario\n  };\n  \n  return {\n    id: id,\n    title: title,\n    description: description\n  };\n});\n\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\nconsole.log('‚úÖ Lista de horarios generada');\nconsole.log(`üìã Cantidad de horarios: ${rows.length}`);\nconsole.log('üìÖ Mapa de horarios:', JSON.stringify(horariosMap, null, 2));\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n\n// Retornar el JSON completo con la estructura de WhatsApp\nreturn [{\n  json: {\n    // Mensaje de WhatsApp\n    body: {\n      messaging_product: \"whatsapp\",\n      recipient_type: \"individual\",\n      to: contactNumber,\n      type: \"interactive\",\n      interactive: {\n        type: \"list\",\n        header: {\n          type: \"text\",\n          text: \"üè• TURNOS DISPONIBLES\"\n        },\n        body: {\n          text: `*ENCONTRAMOS ${fechasLimitadas.length} TURNO${fechasLimitadas.length > 1 ? 'S' : ''} DISPONIBLE${fechasLimitadas.length > 1 ? 'S' : ''}*\\n\\n*üìÖ SELECCION√Å LA FECHA Y HORA DE TU PREFERENCIA*\\n\\nüëá *TOC√Å EL BOT√ìN PARA VER LOS HORARIOS*`\n        },\n        footer: {\n          text: \"‚ù§Ô∏è ICLP - INSTITUTO CARDIOL√ìGICO\"\n        },\n        action: {\n          button: \"VER TURNOS\",\n          sections: [\n            {\n              title: \"SELECCIONAR TURNO\",\n              rows: rows\n            }\n          ]\n        }\n      }\n    },\n    \n    // Estado y metadata para Redis\n    categoria: 'MOSTRAR_HORARIOS',\n    contactNumber: contactNumber,\n    DNI: dni,  // ‚¨ÖÔ∏è PASAR DNI AL SIGUIENTE NODO\n    matricula: matricula,  // ‚¨ÖÔ∏è PASAR MATR√çCULA AL SIGUIENTE NODO\n    estadoActual: 'TURNOS:HORARIOS',  // ‚¨ÖÔ∏è ESTADO CLAVE\n    metadata: {\n      dni: dni,                           // ‚¨ÖÔ∏è DNI\n      matricula: matricula,                // ‚¨ÖÔ∏è MATR√çCULA\n      medico: medico,                      // ‚¨ÖÔ∏è M√âDICO\n      horariosMap: horariosMap,            // ‚¨ÖÔ∏è MAPEO DE HORARIOS CON UNIX TIMESTAMP\n      cantidadHorarios: fechasLimitadas.length\n    }\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[6992,1008],"id":"effaf43b-97d4-4e04-abf1-ef1c353804fd","name":"üïê LISTA-HORARIOS"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"4d1b9696-f935-4e73-91ea-ff5b6429ad5e","leftValue":"={{ $json.contactNumber === \n'+5492254596618'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-1344,-272],"id":"8011bbe7-b322-4650-8dce-c5fac5d5a1f2","name":"If1"},{"parameters":{"method":"POST","url":"={{ $('Variables').item.json.chatwootUrl }}/api/v1/accounts/{{ $('Variables').item.json.accountId }}/conversations/{{ $('Variables').item.json.conversationId }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('Variables').item.json.agenteBotTokenWhatsapp }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"content","value":"=üõ†Ô∏èüè• ESTAMOS TRABAJANDO EN LA AUTOMATIZACI√ìN DE LA CL√çNICA\n‚òéÔ∏è *ADMINISTRACI√ìN:* 221 490 6310\nü§ù DISCULP√Å LAS MOLESTIAS"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1072,-256],"id":"d899590a-b028-4e60-bcbe-617dd031cad1","name":"sendRespondCw1"},{"parameters":{"jsCode":"// ============================================\n// REDIS GET - PARSER\n// ============================================\n// Parsea el JSON almacenado en Redis para extraer:\n// - status (estadoActual)\n// - metadata (codigoEspecialidad, dni, etc.)\n// ============================================\n\nconst redisOutput = $input.first().json.status; // Viene del nodo Redis GET\n\nlet estado = null;\nlet metadata = {};\n\n// Si Redis devuelve algo, parsearlo\nif (redisOutput) {\n  try {\n    // Intentar parsear como JSON\n    const parsed = JSON.parse(redisOutput);\n    estado = parsed.status || null;\n    metadata = parsed.metadata || {};\n    \n    console.log('‚úÖ Redis parseado correctamente');\n    console.log('üìä Estado:', estado);\n    console.log('üì¶ Metadata:', JSON.stringify(metadata));\n  } catch (e) {\n    // Si no es JSON v√°lido, usar el valor directo como estado\n    console.log('‚ö†Ô∏è Redis no es JSON, usando valor directo');\n    estado = redisOutput;\n    metadata = {};\n  }\n} else {\n  console.log('‚ÑπÔ∏è Redis vac√≠o (primera conversaci√≥n)');\n  estado = null;\n  metadata = {};\n}\n\n// Retornar en formato que msg_clasificador espera\nreturn [{\n  json: {\n    status: estado,           // Estado actual para el clasificador\n    metadata: metadata,       // Metadata preservado\n    contactNumber: $('Filtro Tipo Mensaje').first().json.contactNumber\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-192,-384],"id":"fd3e3cc5-7847-4cbf-84a3-3a14dbc1a767","name":"Parsear Redis"},{"parameters":{"jsCode":"// ============================================\n// REDIS SET - PREPARADOR\n// ============================================\n// Prepara los datos que se guardar√°n en Redis:\n// - status (estadoActual)\n// - metadata (codigoEspecialidad, dni, especialidad, etc.)\n// - timestamp\n// - pacienteRegistrado (del nodo anterior)\n// ============================================\n\nconst contactNumber = $json.contactNumber;\nconst estadoActual = $json.estadoActual || $json.nuevoEstado;\nconst metadata = $json.metadata || {};\n\n// Obtener estado de paciente del nodo anterior (clasificador)\nconst pacienteRegistrado = $json.pacienteRegistrado || false;\nconst datosCliente = $json.datosCliente || null;\n\n// Construir el valor a guardar en Redis (formato JSON)\nconst redisValue = JSON.stringify({\n  status: estadoActual,\n  metadata: metadata,\n  timestamp: new Date().toISOString()\n});\n\n// Construir la key de Redis\nconst redisKey = `status:${contactNumber}`;\n\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\nconsole.log('üíæ PREPARANDO DATOS PARA REDIS');\nconsole.log('üîë Key:', redisKey);\nconsole.log('üìä Estado:', estadoActual);\nconsole.log('üè• Paciente Registrado:', pacienteRegistrado);\nif (datosCliente) {\n  console.log('üë§ Datos Cliente:', JSON.stringify(datosCliente));\n}\nconsole.log('üì¶ Metadata:', JSON.stringify(metadata));\nconsole.log('üíø Valor completo:', redisValue);\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n\n// Retornar TODOS los datos: Redis + Clasificador + Estado Paciente\nreturn [{\n  json: {\n    // Datos para Redis SET\n    key: redisKey,\n    value: redisValue,\n    ttl: 600,  // 10 minutos de expiraci√≥n\n    \n    // Estado del paciente (del nodo anterior)\n    pacienteRegistrado: pacienteRegistrado,\n    datosCliente: datosCliente,\n    \n    // Datos del clasificador (para ROUTER PRINCIPAL)\n    categoria: $json.categoria,\n    mensaje: $json.mensaje,\n    contactNumber: contactNumber,\n    estadoActual: estadoActual,\n    estadoAnterior: $json.estadoAnterior,\n    metadata: metadata,\n    nuevoEstado: estadoActual,\n    \n    // Alias para compatibilidad\n    redisKey: redisKey,\n    redisValue: estadoActual,\n    _context: $json._context || {}\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[416,-384],"id":"e7e01d52-b263-4e09-a2bd-cb7bbf69805e","name":"Preparar Redis"},{"parameters":{"operation":"set","key":"={{ $json.key }}","value":"={{ $json.value }}","expire":true,"ttl":"={{ $json.ttl }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[768,-384],"id":"2721b37d-c627-4905-8123-1787030fff2d","name":"Redis","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"httpMethod":"POST","path":"agentes/v1/iclp","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-2480,-624],"id":"f0f7fc3e-907f-40d0-b590-889c52e4a306","name":"Entrada","webhookId":"c750562d-ea1f-43c4-abd9-173117a9f97f"},{"parameters":{"operation":"set","key":"=status:{{ $('msg1').item.json.body.to }}","value":"={{ $('msg1').item.json.estadoActual }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[7024,-464],"id":"2c9b9fae-0065-496d-9aaa-747c728b945d","name":"STATUS:MENU=","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"// ============================================\n// MENSAJE: SELECCIONAR TIPO DE TURNO\n// ============================================\n// Muestra las opciones: Turnos Consultorio o Turnos Estudio\n// ============================================\n\nconst contactNumber = $json.contactNumber;\n\n// Mensaje con botones para elegir tipo de turno\nconst mensajeBody = {\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": contactNumber,\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ü´Ä INSTITUTO DE CARDIOLOG√çA LA PLATA\"\n    },\n    \"body\": {\n      \"text\": \"Recuerda que MOMENT√ÅNEAMENTE SOLO DAMOS LOS TURNOS M√ÅS PR√ìXIMOS\\n\\nSi necesita una fecha m√°s lejana elija la opci√≥n de administraci√≥n\"\n    },\n    \"footer\": {\n      \"text\": \"üìÖ Lun-Vie 8-20hs\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"con-consultorio\",\n            \"title\": \"TURNOS CONSULTORIO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"con-estudio\",\n            \"title\": \"TURNOS ESTUDIO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"volver-atras\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n};\n\n// Log\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\nconsole.log('üìÖ SELECCIONAR TIPO DE TURNO');\nconsole.log('üì± Destinatario:', contactNumber);\nconsole.log('üéØ Estado: TURNOS:TIPO_TURNO');\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n\n// Retornar\nreturn [{\n  json: {\n    body: mensajeBody,\n    categoria: 'INICIAR_TOMAR_TURNO',\n    contactNumber: contactNumber,\n    estadoActual: 'TURNOS:TIPO_TURNO'\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[6576,-464],"id":"59b04e5a-167d-40a2-a397-eef717d8d114","name":"msg1"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.body.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.body.recipient_type }}"},{"name":"to","value":"={{ $json.body.to }}"},{"name":"type","value":"={{ $json.body.type }}"},{"name":"interactive","value":"={{ $json.body.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[6800,-640],"id":"31e55824-d40c-4135-bd11-f7c3490d2f99","name":"[MENU] - GESTION MIS TURNOS","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.body.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.body.recipient_type }}"},{"name":"to","value":"={{ $json.body.to }}"},{"name":"type","value":"={{ $json.body.type }}"},{"name":"interactive","value":"={{ $json.body.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[6800,-464],"id":"71b7f99e-310f-4f04-a84b-d76e3e01915a","name":"[MENU] - TURNOS","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"delete","key":"status:+5492254596618"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-480,320],"id":"90bf42b6-c980-4975-ba89-67318c358ade","name":"Redis1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"categoria-validar-dni","leftValue":"={{ $json.categoria === 'INGRESO_DNI '|| $json.categoria === 'SOLICITAR_DNI' || $json.estadoAnterior === 'PACIENTE_REGISTRADO_ERROR' ||  $json.estadoActual.includes('DATOS:DNI_VALIDADO:') }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"üîç VALIDAR DNI (IA)"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"menu-inicial","leftValue":"={{ $json.mensaje === 'MEN√ö PRINCIPAL' || $json.mensaje === 'MENU PRINCIPAL' || $('msg_clasificador').item.json.categoria === 'MENU_INICIAL' || $json.categoria === 'fallback' && $json.estadoAnterior !== 'PACIENTE_NUEVO_ERROR'}}","rightValue":"MENU_INICIAL","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"üè† MENU INICIAL"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"nav-turnos","leftValue":"={{ $json.categoria === 'NAV_TURNOS' && $json.pacienteRegistrado === false ||  $json.categoria ==='TURNO_CONSULTORIO' && $json.mensaje.includes('hola')}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"üìÖ NAVEGACI√ìN TURNOS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"nav-info","leftValue":"={{ $json.categoria }}","rightValue":"NAV_INFO","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"‚ÑπÔ∏è NAVEGACI√ìN INFO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"nav-admin","leftValue":"={{ $json.categoria }}","rightValue":"NAV_ADMIN","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"üè¢ ADMINISTRACI√ìN"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"derivar-humano","leftValue":"={{ $json.categoria }}","rightValue":"DERIVAR_HUMANO","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"üë§ DERIVAR HUMANO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"gestion-turnos","leftValue":"={{ ['NUEVO_PACIENTE', 'PACIENTE_REGISTRADO', 'INICIAR_TOMAR_TURNO', 'CONFIRMAR_DATOS_DNI', 'INICIAR_CANCELAR_TURNO', 'LISTAR_MIS_TURNOS', 'TURNO_CONSULTORIO', 'TURNO_ESTUDIO', 'VER_MAS_ESPECIALIDADES', 'VER_MAS_MEDICOS', 'SELECCION_ESPECIALIDAD', 'SELECCION_MEDICO', 'SELECCION_HORARIO', 'TOMAR_TURNO', 'CANCELAR_TURNO', 'MIS_TURNOS', 'VOLVER_MEDICOS', 'EJECUTAR_POST_TURNO','ELIMINAR_TURNO'].includes($json.categoria) || $json.mensaje === 'PACIENTE REGISTRADO' || $json.mensaje ==='CONTINUAR' && $json.estadoAnterior === 'PACIENTE_NUEVO' ||$json.mensaje ==='CONTINUAR' && $json.estadoAnterior === 'PACIENTE_NUEVO_REGISTRADO'  || $json.estadoAnterior === 'PACIENTE_REGISTRADO_ERROR' || $('msg_clasificador').item.json.pacienteRegistrado === true && $('msg_clasificador').item.json.categoria === 'NAV_TURNOS' || $json.mensaje ==='MIS TURNOS' ||$json.categoria === 'EJECUTAR_CANCELACION_TURNO' }}","rightValue":"","operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"renameOutput":true,"outputKey":"üé´ GESTI√ìN TURNOS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"datos-paciente","leftValue":"={{ ['INGRESO_DNI', 'INGRESO_DATOS_PACIENTE'].includes($json.categoria) || $json.estadoAnterior ==='PACIENTE_NUEVO_ERROR' || $json.mensaje === 'CANCELAR TURNO' }}","rightValue":"","operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"renameOutput":true,"outputKey":"üìù DATOS PACIENTE"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"confirmaciones","leftValue":"={{ $json.categoria.includes('CONFIRMAR') || $json.categoria.includes('CONTINUAR') }}","rightValue":"","operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"renameOutput":true,"outputKey":"‚úÖ CONFIRMACIONES"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"info-opciones","leftValue":"={{ $json.categoria.startsWith('INFO_') || $json.mensaje.includes('INFO GENERAL')}}","rightValue":"","operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"renameOutput":true,"outputKey":"üí° INFO OPCIONES"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"volver","leftValue":"={{ $json.categoria }}","rightValue":"VOLVER_ATRAS","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"‚¨ÖÔ∏è VOLVER"}]},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[1072,-512],"id":"bd79d3f1-a515-4c79-a84e-a9b7492c5b4a","name":"üîÄ ROUTER PRINCIPAL"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":1},"conditions":[{"id":"confirmar-datos-dni","leftValue":"={{ $json.categoria === 'CONFIRMAR_DATOS_DNI' || $json.pacienteRegistrado === true && $json.categoria !== 'TOMAR_TURNO' }}","rightValue":"CONFIRMAR_DATOS_DNI","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"üìã MEN√ö GESTI√ìN TURNOS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":1},"conditions":[{"id":"tomar-turno-menu","leftValue":"={{ $json.categoria === 'TOMAR_TURNO' ||$json.estadoAnterior === 'PACIENTE_NUEVO_REGISTRADO' &&  $json.mensaje === 'CONTINUAR'  }}","rightValue":"TOMAR_TURNO","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ü©∫ MEN√ö TIPO TURNO"}]},"options":{"looseTypeValidation":true}},"id":"3945e497-2a87-4b0b-9288-73014456d0c2","name":"SWITCH: Tipo Men√∫ Tomar Turno","type":"n8n-nodes-base.switch","typeVersion":3,"position":[5792,-544]},{"parameters":{"operation":"set","key":"=status:{{ $('Variables').first().json.contactNumber }}","value":"PACIENTE_REGISTRADO_ERROR","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3840,-2000],"id":"d9e5e06e-cd72-4c43-b835-7b4b71cdfa57","name":"DATO_INCORRECTO","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"// Obtener datos del nodo DATOS_PACIENTE\nconst inputData = $('DATOS_PACIENTE').first().json.Datos;\nconsole.log('Input completo:', JSON.stringify(inputData, null, 2));\n\n// Parsear datos si es string\nconst datosParsed = typeof inputData === 'string' ? JSON.parse(inputData) : inputData;\n\n// Extraer DNI\nconst dni = Number(datosParsed.paciente_dni);\nconsole.log('DNI final:', dni);\n\n// Validar que se encontr√≥ el DNI\nif (!dni || isNaN(dni)) {\n  throw new Error('No se pudo encontrar el DNI en los datos de entrada');\n}\n\n// Extraer nombre completo\nconst nombre_completo = datosParsed.paciente_nombre;\nconsole.log('Nombre completo:', nombre_completo);\n\n// Extraer celular\nconst celular_paciente = datosParsed.paciente_celular;\nconsole.log('Celular:', celular_paciente);\n\n// Obtener la matr√≠cula completa del input (ROGGIERO-16118)\nconst matriculaCompleta = $('MATRICULA').first().json.matricula;\nconsole.log('Matr√≠cula completa:', matriculaCompleta);\n\n// Separar por gui√≥n para obtener m√©dico y matr√≠cula\nconst partes = matriculaCompleta.split('-');\n\n// Extraer el NOMBRE del m√©dico (ROGGIERO)\nconst medico = partes[0].trim();\nconsole.log('M√©dico:', medico);\n\n// Extraer solo el N√öMERO de matr√≠cula (16118)\nconst matricula = Number(partes[1].trim());\nconsole.log('Matr√≠cula extra√≠da:', matricula);\n\n// Obtener el horario del nodo Filter1 (MI√â 22/10 - 15:40)\nconst horarioCompleto = $('Filter1').first().json.message;\nconsole.log('Horario completo:', horarioCompleto);\n\n// Extraer fecha y hora del formato \"MI√â 22/10 - 15:40\"\nconst partesFechaHora = horarioCompleto.split(' - ');\nconst partesFecha = partesFechaHora[0].split(' ')[1]; // \"22/10\"\nconst horaOriginal = partesFechaHora[1]; // \"15:40\"\n\n// Convertir fecha \"22/10\" a Unix timestamp (milisegundos)\nconst [dia, mes] = partesFecha.split('/');\nconst anio = new Date().getFullYear(); // 2025\n\n// Crear fecha en formato ISO con zona horaria de Argentina\nconst fechaISO = `${anio}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}T00:00:00.000-03:00`;\nconst fecha = new Date(fechaISO).getTime();\nconsole.log('Fecha en Unix (ms):', fecha);\n\n// Convertir hora \"15:40\" a \"1540\" o \"08:20\" a \"0820\" (mantener como string con 4 d√≠gitos)\nconst hora = horaOriginal.replace(':', '').padStart(4, '0');\nconsole.log('Hora convertida:', hora);\n\n// Retornar el resultado en el formato solicitado\nreturn [{\n  json: {\n    datos: {\n      dni: dni,\n      fecha: fecha,\n      hora: hora,\n      nombre_completo: nombre_completo,\n      celular_paciente: celular_paciente,\n      medico: medico,\n      matricula: matricula\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3920,624],"id":"131fc023-6737-4520-a436-98d4532b838b","name":"Code2"},{"parameters":{"operation":"get","propertyName":"matricula","key":"=MEDICO:{{ $('Filter1').first().json.contactNumber.replace('+', '') }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3696,624],"id":"458dec31-0561-48db-b76d-028c029ebcf0","name":"MATRICULA","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filtro Tipo Mensaje').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"üíô CENTRO CARDIOL√ìGICO\"\n    },\n    \"body\": {\n      \"text\": \"*_CONFIRMACI√ìN DE TURNO_*\\n\\n*ü©∫ DATOS DEL TURNO:*\\n\\n‚ù§Ô∏è *M√âDICO CARDI√ìLOGO*\\nDR./DRA. {{ $('datos').item.json.datos.parseJson().medico }} \\n\\nüìÜ *FECHA DE ATENCI√ìN*\\n{{ $('üîÄ SWITCH GESTI√ìN TURNOS').first().json.mensaje }}\\n\\n*üíô POR FAVOR, CONFIRM√Å TU ASISTENCIA*\"\n    },\n    \"footer\": {\n      \"text\": \"‚ù§Ô∏è TU SALUD CARDIOVASCULAR ES PRIORIDAD\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"si-confirmo\",\n            \"title\": \"CONFIRMAR TURNO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"volver-atras\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[7200,1232],"id":"088f8d07-7ae7-49df-8f09-03ec0f31111c","name":"üìÖ Confirmar turno","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=turno:{{ $('Filter1').first().json.contactNumber }}","value":"={{ JSON.stringify($json.datos) }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[4144,624],"id":"a0b09531-0fbc-438e-af4b-583abe3faf48","name":"Datos para confirmar turno","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"=Datos","key":"=DATOS_PACIENTE:","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3472,624],"id":"e866f2dc-ab17-4e9a-bffb-0eea4acd4571","name":"DATOS_PACIENTE","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=status:{{ $('msg_clasificador').item.json.contactNumber }}","value":"TURNOS:CONFIRMAR","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[7648,1232],"id":"aef8bdb0-3326-4043-837e-e2e965afd273","name":"Redis2","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=status:{{ $('msg_clasificador').first().json.contactNumber }}","value":"={{ $('üïê LISTA-HORARIOS').item.json.estadoActual }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[7440,1008],"id":"e330b4e4-fd08-4e7a-a1cc-689f6b3a0f4a","name":"ü©∫ FECHA","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"$('üîÄ SWITCH GESTI√ìN TURNOS1').first().json.mensaje\n\n$input.first().json.DNI"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3248,624],"id":"7ca5f376-cc63-41a2-9580-01c2e18e864e","name":"PREPARAR_CONFIRMAR_TURNO"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"nuevo-paciente","leftValue":"={{ $json.categoria }}","rightValue":"NUEVO_PACIENTE","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"‚ûï NUEVO PACIENTE"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"paciente-registrado","leftValue":"={{ $json.categoria === '' || $json.mensaje === 'PACIENTE REGISTRADO'}}","rightValue":"PACIENTE_REGISTRADO","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"‚úÖ PACIENTE REGISTRADO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"tomar-turno","leftValue":"={{ ['INICIAR_TOMAR_TURNO', 'CONFIRMAR_DATOS_DNI', 'TOMAR_TURNO'].includes($json.categoria) || $json.estadoAnterior === 'PACIENTE_NUEVO_REGISTRADO' && $json.mensaje === 'CONTINUAR' || $json.mensaje === 'TOMAR TURNO' || $json.pacienteRegistrado === true && $json.mensaje !== 'TURNOS CONSULTORIO' && $json.mensaje !== 'TURNOS ESTUDIO' && $json.categoria !== 'SELECCION_ESPECIALIDAD' && $json.categoria !== 'SELECCION_MEDICO' && $json.categoria !== 'SELECCION_HORARIO' && $json.categoria !== 'CANCELAR_TURNO' && \n$json.categoria !== 'EJECUTAR_POST_TURNO' &&\n$json.categoria !== 'ELIMINAR_TURNO' && \n$json.categoria !== 'VER_MAS_ESPECIALIDADES' &&\n$json.categoria !== 'TURNO_CONSULTORIO' &&\n$json.mensaje !== 'MIS TURNOS' &&\n$json.categoria !== 'EJECUTAR_CANCELACION_TURNO'}}","rightValue":"","operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"renameOutput":true,"outputKey":"üìÖ TOMAR TURNO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"listar-turnos","leftValue":"={{ ['LISTAR_MIS_TURNOS', 'MIS_TURNOS'].includes($json.categoria) }}","rightValue":"","operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"renameOutput":true,"outputKey":"üìã MIS TURNOS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"turno-consultorio","leftValue":"={{ $json.categoria }}","rightValue":"TURNO_CONSULTORIO","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"ü©∫ TURNO CONSULTORIO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"turno-estudio","leftValue":"={{ $json.categoria === 'TURNO_ESTUDIO' ||  $json.categoria === 'TURNO_CONSULTORIO' && $json.mensaje ==='TURNOS ESTUDIO'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"üî¨ TURNO ESTUDIO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"ver-mas-especialidades","leftValue":"={{ $json.categoria }}","rightValue":"VER_MAS_ESPECIALIDADES","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"‚ûï VER M√ÅS ESPECIALIDADES"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"ver-mas-medicos","leftValue":"={{ $json.categoria }}","rightValue":"VER_MAS_MEDICOS","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"‚ûï VER M√ÅS M√âDICOS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"seleccion-especialidad","leftValue":"={{ ['SELECCION_ESPECIALIDAD', 'VOLVER_MEDICOS'].includes($json.categoria) }}","rightValue":"","operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"renameOutput":true,"outputKey":"ü©∫ SELECCI√ìN ESPECIALIDAD"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"seleccion-medico","leftValue":"={{ $json.categoria }}","rightValue":"SELECCION_MEDICO","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"üë®‚Äç‚öïÔ∏è SELECCI√ìN M√âDICO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"seleccion-horario","leftValue":"={{ $json.categoria }}","rightValue":"SELECCION_HORARIO","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"‚è∞ SELECCI√ìN HORARIO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"ee3917ed-5fc7-444d-a6b3-6b6c0a7daaaa","leftValue":"={{ $json.categoria }}","rightValue":"EJECUTAR_POST_TURNO","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"EJECUTAR TURNO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"8764b955-7499-4f00-8106-de7eae17539b","leftValue":"={{ $json.categoria === 'ELIMINAR_TURNO' && $json.estadoAnterior ==='CANCELAR-TURNO' || $json.categoria === 'EJECUTAR_CANCELACION_TURNO'}}","rightValue":"ELIMINAR_TURNO","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"‚ùå ELIMINAR TURNO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"cancelar-turno","leftValue":"={{ ['INICIAR_CANCELAR_TURNO', 'CANCELAR_TURNO'].includes($json.categoria) || $json.mensaje === 'CANCELAR TURNO' }}","rightValue":"","operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"renameOutput":true,"outputKey":"‚ùå CANCELAR TURNO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"cac1d24c-59e0-47e8-92cb-a70111fc41d6","leftValue":"={{ $json.mensaje === 'MIS TURNOS' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"MIS TURNOS"}]},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[4448,-224],"id":"e0bdaa79-afed-4e82-a5a6-c9afa1fcad52","name":"üîÄ SWITCH GESTI√ìN TURNOS"},{"parameters":{"operation":"get","propertyName":"datos","key":"=DATOS_TURNO:{{ $('msg_clasificador').item.json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[6544,1456],"id":"fb7f6200-d650-4096-92fe-e36f097fc68d","name":"Datos para confirmar turno1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"workflowId":{"__rl":true,"value":"e7UD4t6GrwYxGW6Q","mode":"list","cachedResultName":"SUB - POST_TURNO"},"workflowInputs":{"mappingMode":"defineBelow","value":{"dni":"={{ $('üîÄ SWITCH GESTI√ìN TURNOS').item.json.datosCliente.paciente_dni }}","fecha":"={{ DateTime.fromFormat($json.datos.parseJson().fecha.toString(), 'yyyyMMdd').toMillis() }}","hora":"={{ $json.datos.parseJson().hora.toNumber() }}","nombre_completo":"={{ $json.datos.parseJson().nombre }}","celular_paciente":"={{ $json.datos.parseJson().celular }}","matricula":"={{ $json.datos.parseJson().matricula.toNumber() }}","celuar_whatsapp":"={{ $('msg_clasificador').first().json.contactNumber }}"},"matchingColumns":[],"schema":[{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"fecha","displayName":"fecha","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"hora","displayName":"hora","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"nombre_completo","displayName":"nombre_completo","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"celular_paciente","displayName":"celular_paciente","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"matricula","displayName":"matricula","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"celuar_whatsapp","displayName":"celuar_whatsapp","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":true,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[6768,1456],"id":"12c9eb3c-646b-47fc-b7c1-e913f7458118","name":"EJECUTAR TURNO"},{"parameters":{"operation":"get","propertyName":"datos","key":"=DATOS_TURNO:{{ $json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[6544,1232],"id":"391d846d-410b-4c7e-ae44-d0532e0878a0","name":"datos","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=PACIENTE_REGISTRADO:{{ $('Variables').first().json.contactNumber }}","value":"={{ $('Get_Paciente1').item.json.output}}","expire":true,"ttl":3600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[4560,-1552],"id":"443d1d0c-6562-4d6f-80bc-12b13cf5a23c","name":"PACIENTE_REGISTRADO","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"PACIENTE","key":"=PACIENTE_REGISTRADO:{{ $('msg_clasificador').item.json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[6976,1232],"id":"2e0ac063-b391-4d33-b6a6-dc56a01866ba","name":"DATOS_PACIENTE_REGISTRADO","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"// ============================================\n// PREPARADOR DE TURNO - SOLUCI√ìN BASADA EN IMAGEN\n// ============================================\n\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\nconsole.log('üîç INICIO - Debugging de Matr√≠cula');\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n\n// ============================================\n// 1. INTENTAR M√öLTIPLES FORMAS DE ACCEDER A DATOS\n// ============================================\nconst matricula_paciente = $('datos').first().json.datos.matricula;\nlet datosBase = null;\n\nconsole.log('\\nüìä INTENTANDO ACCEDER AL NODO datos:');\n\n// Intento 1: Acceso directo a .json\ntry {\n    datosBase = $('datos').first().json;\n    console.log('‚úÖ Intento 1 - $(\"datos\").first().json:');\n    console.log(JSON.stringify(datosBase, null, 2));\n    console.log('   Matr√≠cula:', datosBase.matricula);\n} catch (e) {\n    console.log('‚ùå Intento 1 fall√≥:', e.message);\n}\n\n// Intento 2: Acceso con .json.datos\nif (!datosBase || !datosBase.matricula) {\n    try {\n        datosBase = $('datos').first().json.datos;\n        console.log('‚úÖ Intento 2 - $(\"datos\").first().json.datos:');\n        console.log(JSON.stringify(datosBase, null, 2));\n        console.log('   Matr√≠cula:', datosBase.matricula);\n    } catch (e) {\n        console.log('‚ùå Intento 2 fall√≥:', e.message);\n    }\n}\n\n// Intento 3: Desde el primer item\nif (!datosBase || !datosBase.matricula) {\n    try {\n        datosBase = $('datos').item(0).json;\n        console.log('‚úÖ Intento 3 - $(\"datos\").item(0).json:');\n        console.log(JSON.stringify(datosBase, null, 2));\n        console.log('   Matr√≠cula:', datosBase.matricula);\n    } catch (e) {\n        console.log('‚ùå Intento 3 fall√≥:', e.message);\n    }\n}\n\n// Intento 4: Acceso con all()\nif (!datosBase || !datosBase.matricula) {\n    try {\n        const todosLosDatos = $('datos').all();\n        if (todosLosDatos && todosLosDatos.length > 0) {\n            datosBase = todosLosDatos[0].json;\n            console.log('‚úÖ Intento 4 - $(\"datos\").all()[0].json:');\n            console.log(JSON.stringify(datosBase, null, 2));\n            console.log('   Matr√≠cula:', datosBase.matricula);\n        }\n    } catch (e) {\n        console.log('‚ùå Intento 4 fall√≥:', e.message);\n    }\n}\n\n// Verificar si obtuvimos los datos\nif (!datosBase) {\n    console.log('üö® ERROR CR√çTICO: No se pudieron obtener los datos del nodo');\n    throw new Error('No se pudo acceder al nodo datos');\n}\n\nconsole.log('\\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\nconsole.log('‚úÖ DATOS BASE OBTENIDOS:');\nconsole.log('   DNI:', datosBase.dni);\nconsole.log('   Matr√≠cula:', datosBase.matricula);\nconsole.log('   M√©dico:', datosBase.medico);\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n\n// Si la matr√≠cula a√∫n es null, intentar extraerla del m√©dico\nlet matriculaFinal = datosBase.matricula;\n\nif (!matriculaFinal || matriculaFinal === null || matriculaFinal === 'null') {\n    console.log('\\n‚ö†Ô∏è Matr√≠cula es null, intentando extraer del m√©dico...');\n    \n    if (datosBase.medico) {\n        const match = datosBase.medico.match(/-(\\d+)$/);\n        if (match) {\n            matriculaFinal = match[1];\n            console.log('‚úÖ Matr√≠cula extra√≠da del m√©dico:', matriculaFinal);\n        }\n    }\n    \n    if (!matriculaFinal && datosBase.medicoSeleccionado) {\n        const match = datosBase.medicoSeleccionado.match(/-(\\d+)$/);\n        if (match) {\n            matriculaFinal = match[1];\n            console.log('‚úÖ Matr√≠cula extra√≠da del medicoSeleccionado:', matriculaFinal);\n        }\n    }\n}\n\nconsole.log('\\nüéØ MATR√çCULA FINAL:', matriculaFinal);\n\n// ============================================\n// 2. OBTENER DATOS DEL PACIENTE\n// ============================================\n\nconst pacienteData = $('DATOS_PACIENTE_REGISTRADO').first().json.PACIENTE;\nconst nombrePaciente = pacienteData.paciente_nombre;\nconst celularPaciente = pacienteData.paciente_celular;\nconst dni_paciente = pacienteData.paciente_dni;\n\n\n// 3. EXTRAER FECHA Y HORA DEL MENSAJE\n// ============================================\n\nconsole.log('\\nüìÖ EXTRAYENDO FECHA Y HORA:');\n\nconst mensajeHora = $('msg_clasificador').first().json.mensaje;\nconsole.log('   Mensaje:', mensajeHora);\n\nconst fechaHoraMatch = mensajeHora.match(/(\\d{1,2})\\/(\\d{1,2})\\s*-\\s*(\\d{1,2}):(\\d{2})/);\n\nlet fechaLimpia = \"\";\nlet horaLimpia = \"\";\n\nif (fechaHoraMatch) {\n    const dia = fechaHoraMatch[1].padStart(2, '0');\n    const mes = fechaHoraMatch[2].padStart(2, '0');\n    const a√±o = new Date().getFullYear();\n    \n    fechaLimpia = `${a√±o}${mes}${dia}`;\n    \n    const horas = fechaHoraMatch[3].padStart(2, '0');\n    const minutos = fechaHoraMatch[4];\n    horaLimpia = horas + minutos;\n    \n    console.log('   Fecha:', fechaLimpia);\n    console.log('   Hora:', horaLimpia);\n}\n\n// ============================================\n// 4. CREAR OBJETO DE TURNO\n// ============================================\n\nconsole.log('\\nüì¶ CREANDO OBJETO DE TURNO:');\n\nconst dato_turno = {\n    datos_turno: {\n        dni: dni_paciente,\n        fecha: fechaLimpia,\n        celular: celularPaciente,\n        medico: datosBase.medico,\n        matricula: $('matricula').first().json.matricula,\n        medicoSeleccionado: datosBase.medicoSeleccionado,\n        nombre: nombrePaciente,\n        hora: horaLimpia\n    }\n};\n\nconsole.log('\\n‚úÖ OBJETO TURNO FINAL:');\nconsole.log(JSON.stringify(dato_turno, null, 2));\n\nconsole.log('\\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\nconsole.log('‚úÖ FIN DE DEBUGGING');\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n\nreturn dato_turno;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[7424,1232],"id":"0dcd96ad-0896-4938-ac7b-cf2b3c6204ac","name":"DATOS_COMBINADOS"},{"parameters":{"operation":"get","propertyName":"DATOS_PACIENTE","key":"=PACIENTE_REGISTRADO:{{ $('Variables').first().json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[6544,1008],"id":"79d38d85-ea1e-4759-9a8c-cdca533f287d","name":"GET_PACIENTE_REGISTRADO","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"// Extraer datos del paciente\nconst nombre = $('GET_PACIENTE_REGISTRADO').first().json.DATOS_PACIENTE.paciente_nombre;\nconst celular = $('GET_PACIENTE_REGISTRADO').first().json.DATOS_PACIENTE.paciente_celular;\nconst dni = $('GET_PACIENTE_REGISTRADO').first().json.DATOS_PACIENTE.paciente_dni;\n\n// Extraer datos del m√©dico\nconst matricula = $('Preparar Redis').first().json.metadata.matricula;\nconst medico = $('Preparar Redis').first().json.metadata.medico;\n\n// Obtener fecha de hoy\nconst fecha = Number(DateTime.now().setZone('America/Argentina/Buenos_Aires').toFormat('yyyyMMdd'));\n\n// Crear objeto JSON final\nconst dato_turno = {\n  datos:{\n    dni: dni,\n    matricula: matricula,\n    fecha: fecha,\n    celular: celular,\n    medico: medico,\n    medicoSeleccionado: medico,\n    nombre: nombre\n  }\n};\n\n// Retornar el objeto\nreturn dato_turno;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[7664,1008],"id":"7a3ea513-c627-4e41-85c7-c32e44d79021","name":"Code3"},{"parameters":{"operation":"set","key":"=DATOS_TURNO:{{ $('msg_clasificador').item.json.contactNumber }}","value":"={{ JSON.stringify($('DATOS_COMBINADOS').item.json.datos_turno) }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[7872,1232],"id":"1fe5efe9-b9ca-49d8-9743-7bc050f9cc00","name":"DATOS_TURNO_PACIENTE","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"url":"http://iclp.ddns.net:7080/ws-turnos-rest-simple/api/turnos/lista-turnos-actuales","sendQuery":true,"queryParameters":{"parameters":[{"name":"usuario","value":"WSTRRED"},{"name":"password","value":"Y2xpb25lcw"},{"name":"dni","value":"={{ $json.DATOS_PACIENTE.paciente_dni }}"},{"name":"fecha","value":"={{ $now.setZone('America/Argentina/Buenos_Aires').toFormat('yyyyLLdd') }}"}]},"options":{"response":{"response":{"neverError":true,"responseFormat":"json"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[6784,768],"id":"2335e5e0-ce18-4c4c-b54d-068be13f6672","name":"get_turnos_agendados1"},{"parameters":{"assignments":{"assignments":[{"id":"8c6cf375-6158-46f1-8b42-593cf42fff40","name":"lista","value":"={{ $json.lista[0] }}","type":"object"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[7008,768],"id":"7d3cf79a-821c-44ce-b6b4-f230d4f5594c","name":"datos1"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.recipient_type }}"},{"name":"to","value":"={{ $('msg_clasificador').first().json.contactNumber }}"},{"name":"type","value":"={{ $json.type }}"},{"name":"interactive","value":"={{ $json.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[7456,768],"id":"b5dae97a-ddf7-4ad1-9273-84b743b3bb88","name":"MIS TURNOS1","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"jsCode":"// Obtener la lista de turnos\nconst turnos = $input.all();\n\n// Funci√≥n para validar si un turno tiene datos v√°lidos\nfunction turnoValido(turno) {\n  const datos = turno.json.lista || turno.json;\n  \n  // Verificar que tenga al menos fecha y hora v√°lidas\n  const tieneFecha = datos.fechaString && datos.fechaString !== 'Sin fecha' && datos.fechaString.length > 0;\n  const tieneHora = datos.hora5digitos && datos.hora5digitos !== 'Sin hora' && datos.hora5digitos.length > 0;\n  const tieneNombre = datos.nombreMedico && datos.nombreMedico !== 'Sin nombre' && datos.nombreMedico.length > 0;\n  \n  return tieneFecha && tieneHora && tieneNombre;\n}\n\n// Filtrar solo turnos v√°lidos\nconst turnosValidos = turnos.filter(turnoValido);\n\n// Verificar si hay turnos v√°lidos\nif (!turnosValidos || turnosValidos.length === 0) {\n  return [{\n    json: {\n      messaging_product: \"whatsapp\",\n      recipient_type: \"individual\",\n      to:$('DATOS_PACIENTE1').first().json.DATOS_PACIENTE.paciente_celular ,\n      type: \"interactive\",\n      interactive: {\n        type: \"button\",\n        body: {\n          text: \"‚ùå NO TEN√âS TURNOS PROGRAMADOS EN ESTE MOMENTO\"\n        },\n        footer: {\n          text: \"üìÖ Lun-Vie 8-20hs\"\n        },\n        action: {\n          buttons: [\n            {\n              type: \"reply\",\n              reply: {\n                id: \"menu-principal\",\n                title: \"MENU PRINCIPAL\"\n              }\n            }\n          ]\n        }\n      }\n    }\n  }];\n}\n\n// Crear rows para la lista de turnos\nconst rows = [];\n\nfor (let i = 0; i < turnosValidos.length; i++) {\n  const turno = turnosValidos[i].json.lista || turnosValidos[i].json;\n  \n  const fechaString = turno.fechaString;\n  const hora5digitos = turno.hora5digitos;\n  const nombreMedico = turno.nombreMedico;\n  const matricula = turno.matricula || '';\n  \n  // Separar apellido del m√©dico y tipo de estudio\n  const partes = nombreMedico.split(' ');\n  const apellido = partes.length > 1 ? partes[partes.length - 1] : nombreMedico;\n  const tipoEstudio = partes.length > 1 ? partes.slice(0, -1).join(' ') : 'CONSULTA';\n  \n  // Formatear fecha de \"20251016\" a \"16-10-2025\"\n  let fechaFormateada = fechaString;\n  if (fechaString.length === 8) {\n    const a√±o = fechaString.substring(0, 4);\n    const mes = fechaString.substring(4, 6);\n    const dia = fechaString.substring(6, 8);\n    fechaFormateada = `${dia}-${mes}-${a√±o}`;\n  }\n  \n  // Crear title corto (m√°ximo 24 caracteres)\n  let title = `${apellido}-${fechaFormateada}`;\n  if (title.length > 24) {\n    title = title.substring(0, 21) + '...';\n  }\n  \n  // Crear description (m√°ximo 72 caracteres)\n  let description = `${tipoEstudio} - ${hora5digitos}`;\n  if (description.length > 72) {\n    description = description.substring(0, 69) + '...';\n  }\n  \n  // ID √∫nico para el turno (fecha + hora + matricula)\n  const id = `turno-${fechaString}-${hora5digitos.replace(':', '')}-${matricula}`;\n  \n  rows.push({\n    id: id,\n    title: title,\n    description: description\n  });\n}\n\n// Limitar a 9 turnos m√°ximo\nconst rowsLimitados = rows.slice(0, 9);\n\n// Retornar lista interactiva\nreturn [{\n  json: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: $('DATOS_PACIENTE1').first().json.DATOS_PACIENTE.paciente_celular ,\n    type: \"interactive\",\n    interactive: {\n      type: \"list\",\n      header: {\n        type: \"text\",\n        text: \"üóëÔ∏è CANCELAR TURNO\"\n      },\n      body: {\n        text: \"SELECCION√Å EL TURNO QUE QUER√âS CANCELAR\"\n      },\n      footer: {\n        text: \"üìÖ Lun-Vie 8-20hs\"\n      },\n      action: {\n        button: \"VER TURNOS\",\n        sections: [\n          {\n            title: \"TUS TURNOS\",\n            rows: rowsLimitados\n          }\n        ]\n      }\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[7232,768],"id":"ced47ee3-4c1b-4724-b5d9-4651cc5bd0db","name":"üö´ CANCELAR TURNO"},{"parameters":{"operation":"set","key":"=DATOS_MEDICO:{{ $('DATOS_PACIENTE1').item.json.DATOS_PACIENTE.paciente_celular }}","value":"={{ JSON.stringify($('datos1').item.json.lista) }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[7680,768],"id":"4d4cda28-73a9-4ad5-818d-e463dd1f1771","name":"Datos turnos","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"DATOS_PACIENTE","key":"=PACIENTE_REGISTRADO:{{ $('msg_clasificador').item.json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[6560,768],"id":"7785fe40-2422-4e21-b358-fb6c5a746bd3","name":"DATOS_PACIENTE1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"content":"###  MUESTRA LAS FECHAS A ELIMINAR SI EXISTEN","height":224,"width":1696,"color":3},"type":"n8n-nodes-base.stickyNote","position":[6464,704],"typeVersion":1,"id":"a412552f-53bf-44de-82d8-6ed8df009e6e","name":"Sticky Note9"},{"parameters":{"operation":"set","key":"=status:{{ $('DATOS_PACIENTE1').item.json.DATOS_PACIENTE.paciente_celular }}","value":"CANCELAR-TURNO","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[7904,768],"id":"b190cf19-3baa-4436-bff1-ec1923c7104a","name":"STATUS=CANCELAR-TURNO","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $json.celular }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"‚úÖ *TURNO CANCELADO EXITOSAMENTE*\\n\\nüóìÔ∏è Tu turno ha sido cancelado correctamente.\\n\\nüìã *Detalles de la cancelaci√≥n:*\\n‚Ä¢ M√©dico: Dr./Dra. {{ $json.nombreMedico }}\\n‚Ä¢ Fecha: {{ $json.fecha }}\\n‚Ä¢ Hora: {{ $json.hora }}hs\\n\\nüí° *¬øNecesit√°s reagendar?*\\nPod√©s solicitar un nuevo turno cuando lo necesites.\\n\\n*Tambi√©n pod√©s contactarnos:*\\n‚Ä¢ Tel√©fono: (0221) 4906310\\n‚Ä¢ Horarios: Lunes a Viernes 8:00-20:00hs\\n\\n¬°Esperamos verte pronto! ‚ù§Ô∏è\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[7088,512],"id":"6a763e68-8c13-407b-9198-7c06045cd07f","name":"üö´ TURNO-CANCELADO","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"delete","key":"=status:{{ $('msg_clasificador').first().json.contactNumber }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[7264,512],"id":"afc9924c-44bc-4f89-9f98-17e211f774be","name":"DELETE - STATUS MENU2","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"workflowId":{"__rl":true,"value":"54erSSiJNvNSRnpK","mode":"list","cachedResultName":"SUB - DELETE TURNO"},"workflowInputs":{"mappingMode":"defineBelow","value":{"matricula":"={{ $json.delete.parseJson().matricula }}","fecha":"={{ $json.delete.parseJson().fechaString.toNumber() }}","hora":"={{ $json.delete.parseJson().hora.toNumber() }}","num_conver":"={{ $('Filtro Tipo Mensaje').item.json.conversationId }}","celular":"={{ $('msg_clasificador').item.json.contactNumber }}"},"matchingColumns":[],"schema":[{"id":"matricula","displayName":"matricula","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"fecha","displayName":"fecha","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"hora","displayName":"hora","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"num_conver","displayName":"num_conver","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"celular","displayName":"celular","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[6736,512],"id":"bd847f42-3a9d-45b2-8fb2-68d47adf6e31","name":"DELETE_TURNO"},{"parameters":{"content":"###  ELIMINAR UN TURNO","height":224,"width":976,"color":3},"type":"n8n-nodes-base.stickyNote","position":[6464,448],"typeVersion":1,"id":"7d254e6b-abc1-4ff3-8ef3-25cd66671d61","name":"Sticky Note5"},{"parameters":{"operation":"get","propertyName":"delete","key":"=DATOS_MEDICO:{{ $json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[6544,512],"id":"b763a733-a0f6-4345-b0a3-ccbc4f45b984","name":"Redis3","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"// Parsear el JSON que viene como string\nconst deleteData = JSON.parse($('Redis3').item.json.delete);\n\n// Convertir fecha Unix (milisegundos) a formato legible DD/MM/YYYY\nconst fechaUnix = deleteData.fecha;\nconst fechaObj = new Date(fechaUnix);\nconst dia = String(fechaObj.getDate()).padStart(2, '0');\nconst mes = String(fechaObj.getMonth() + 1).padStart(2, '0'); // Los meses empiezan en 0\nconst a√±o = fechaObj.getFullYear();\nconst fechaLegible = `${dia}/${mes}/${a√±o}`;\n\n// Convertir hora de \"1540\" a \"15:40\"\nconst horaString = deleteData.hora;\nconst horaLegible = horaString.slice(0, 2) + ':' + horaString.slice(2);\n\n// Retornar todos los datos formateados\nreturn [{\n  json: {\n    matricula: deleteData.matricula,\n    fechaOriginal: deleteData.fecha,\n    fecha: fechaLegible, // \"14/11/2025\"\n    horaOriginal: deleteData.hora,\n    hora: horaLegible, // \"15:40\"\n    horasDigitos: deleteData.horasDigitos,\n    fechaString: deleteData.fechaString,\n    nombreMedico: deleteData.nombreMedico,\n    nombrePaciente: deleteData.nombrePaciente,\n    celular: deleteData.celular,\n    especialidad: deleteData.especialidad,\n    dni: deleteData.dni,\n    obraSocial: deleteData.obraSocial\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[6912,512],"id":"29ba2a0a-3868-4aac-8eec-7dfb8e1aa267","name":"Code4"},{"parameters":{"workflowId":{"__rl":true,"value":"xBZYzq5pKXYbUGV7","mode":"list","cachedResultName":"SUB - ETIQUETE: TURNO_ESTUDIO"},"workflowInputs":{"mappingMode":"defineBelow","value":{"humano":true,"accountId":"={{ $('Variables').item.json.accountId }}","conversationId":"={{ $('Variables').item.json.conversationId.toString() }}","contactId":"={{ $('Variables').item.json.contactId.toString() }}","message":"={{ $('Variables').item.json.message }}","inboxId":"={{ $('Variables').item.json.inboxId.toString() }}","chatwootUrlBase":"={{ $('Variables').item.json.chatwootUrl }}","tokenChatwoot":"={{ $('Variables').item.json.agenteBotTokenWhatsapp }}","tipoIntencion":"turnos-estudios"},"matchingColumns":[],"schema":[{"id":"accountId","displayName":"accountId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"conversationId","displayName":"conversationId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"contactId","displayName":"contactId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"message","displayName":"message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"inboxId","displayName":"inboxId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"humano","displayName":"humano","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"boolean"},{"id":"chatwootUrlBase","displayName":"chatwootUrlBase","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"tokenChatwoot","displayName":"tokenChatwoot","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"tipoIntencion","displayName":"tipoIntencion","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[6560,-144],"id":"f430fbfd-ff75-43d7-aa77-ebdbf1ca1612","name":"TURNOS ESTUDIO"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[2992,1328],"id":"14ca473d-703e-44ed-9c2e-dc39f3cf7f39","name":"OpenRouter Chat Model2","credentials":{"openRouterApi":{"id":"ZlcbniUoDvrFqCIJ","name":"OpenRouter ICLP"}}},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"m1kjf7ed0befl04","returnAll":true,"options":{}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[2544,1104],"id":"b876dfea-5e8d-4b50-a337-6051288936d6","name":"obrasociales","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"jsCode":"return {\n    total: $input.all().length,\n    obrasociales: $input.all().map(item => ({\n        Id_os: item.json.Id,\n        nombre_obrasocial: item.json.nombre_obrasocial,\n        obrasocial: item.json.obrasocial\n    }))\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2768,1104],"id":"1e56a3b3-2eaf-4c1b-9b68-709fde961c24","name":"Code6"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('msg_clasificador').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ü´Ä ICLP - GESTI√ìN DE TURNOS\"\n    },\n    \"body\": {\n      \"text\": \"‚úÖ *¬°PERFECTO!*\\n\\n*SUS DATOS FUERON REGISTRADOS CORRECTAMENTE*\\n\\n*INFORMACI√ìN REGISTRADA:*\\n\\nüë§ *NOMBRE:*{{ $json.datos.paciente_nombre }} \\nüÜî *DNI:* {{ $json.datos.paciente_dni }}\\nüìû *TEL√âFONO:* {{ $json.datos.paciente_celular }}\\nüè• *OBRA SOCIAL:* {{ $json.datos.nombre_obrasocial }}\\n\\n*PRESIONE CONTINUAR PARA GESTIONAR SU TURNO CARDIOL√ìGICO*\\n\\n_¬øDetect√≥ alg√∫n error? Comun√≠quese al (0221) 490-6310_\"\n    },\n    \"footer\": {\n      \"text\": \"üìÖ LUN-VIE 8-20HS\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"CONTINUAR\",\n            \"title\": \"CONTINUAR\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"MENU-PRINCIPAL\",\n            \"title\": \"MEN√ö PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[4064,1200],"id":"14b4071f-2c11-4470-8f19-d45f29b2c52d","name":"‚úÖ DATOS VALIDADOS3","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"delete","key":"={{ $('msg_clasificador').first().json.contactNumber }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[4288,1200],"id":"dadd9680-2e94-46f7-a417-53220ae6636f","name":"ü§ñ RESET AGENTE","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[3568,1504],"id":"2245b102-0c44-40a3-9a5c-5f8ca056ce88","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"mE1IL02M9AnIg3tD","name":"OpenAi Credenciales ICLP"}}},{"parameters":{"workflowId":{"__rl":true,"value":"5yeTNub4mGFgBUpp","mode":"list","cachedResultName":"SUB - POST_PACIENTE"},"workflowInputs":{"mappingMode":"defineBelow","value":{"dni":"={{ $json.output.DNI.toString() }}","paciente":"={{ $json.output.NOMBRE }}","direccion":"={{ $json.output.DIRECCION }}","celular":"={{ $json.output.TELEFONO.toString() }}","obraSocial":"={{ $json.output.OBRA_SOCIAL }}","nombreobrasocial":"={{ $json.output.NOMBRE_OBRA_SOCIAL }}"},"matchingColumns":[],"schema":[{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"paciente","displayName":"paciente","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"direccion","displayName":"direccion","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"celular","displayName":"celular","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"obraSocial","displayName":"obraSocial","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"nombreobrasocial","displayName":"nombreobrasocial","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[3840,1200],"id":"bd45b289-e96e-4741-9379-81a6060a91b1","name":"POST_PACIENTE"},{"parameters":{"operation":"set","key":"=DATOS_PACIENTE:{{ $('üîÄ ROUTER PRINCIPAL').first().json.contactNumber }}","value":"={{ JSON.stringify($('POST_PACIENTE').item.json.datos) }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[4512,1200],"id":"11acfbe7-967e-4307-828a-b1bd6e20c085","name":"DATOS_PACIENTE REGISTRADO","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=status:{{ $('üîÄ ROUTER PRINCIPAL').first().json.contactNumber }}","value":"PACIENTE_NUEVO_REGISTRADO","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[4736,1200],"id":"0bd2e333-fec4-451a-b75b-05e5444f53c3","name":"STATUS=PACIENTE_NUEVO","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"068a964d-25b6-4a1f-8e05-c47dd2fea4b7","leftValue":"={{ $json.output.ERROR }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[3616,1104],"id":"5857d3f4-9d19-4823-93ec-0720d9c965de","name":"Error informacion de usuario1"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('msg_clasificador').first().json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"‚ö†Ô∏è {{ $json.output.ERROR_MESSAGE }}\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3840,1008],"id":"b7901d52-0121-4ff9-839d-3b9acb64e81f","name":"‚ö†Ô∏è DATOS INCORRECTOS1","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"promptType":"define","text":"={{ $('üîÄ ROUTER PRINCIPAL').first().json.mensaje }}","hasOutputParser":true,"options":{"systemMessage":"=# ROL\nSos un colector/validador de datos cl√≠nicos. Siempre devolv√©s UN √∫nico objeto JSON. Sin texto extra ni markdown. No uses comillas en n√∫meros.\n\n# CONTEXTO\n$OBRAS_SOCIALES := {{ JSON.stringify($json.obrasociales) }}  // usar EXCLUSIVAMENTE este listado\nCada item: { obrasocial: string, nombre_obrasocial: string }\n\n# CONTRATO DE SALIDA\n{\n  \"status\": \"ASK\" | \"FINAL\",\n  \"ask\": \"string\",                      // UNA pregunta breve, natural y amigable por el dato que falta o hay que corregir\n  \"missing\": [\"NOMBRE\",\"DNI\",\"OBRA_SOCIAL\",\"DIRECCION\",\"TELEFONO\"],\n  \"data\": {\n    \"NOMBRE\": \"string\",\n    \"DNI\": number,\n    \"OBRA_SOCIAL\": \"string\",\n    \"NOMBRE_OBRA_SOCIAL\": \"string\",\n    \"DIRECCION\": \"string\",\n    \"TELEFONO\": number\n  },\n  \"ERROR\": true | false,\n  \"ERROR_MESSAGE\": \"string\"\n}\n\n# REGLAS DE CONVERSACI√ìN (ORDEN)\nValid√°/ped√≠ en este orden: NOMBRE ‚Üí DNI ‚Üí OBRA_SOCIAL ‚Üí DIRECCION ‚Üí TELEFONO.\n\n# REGLAS DE ERROR Y MENSAJES\n- En status=\"ASK\":\n  A) **Si existe alg√∫n dato inv√°lido YA PROVISTO** (seg√∫n el orden), entonces:\n     - ERROR=true\n     - ERROR_MESSAGE = mensaje natural y conversacional del primer inv√°lido\n     - ask = pregunta amigable para **corregir ese mismo dato** (no avanzar)\n  B) **Si NO hay inv√°lidos, pero faltan datos**, entonces:\n     - ERROR=true\n     - ERROR_MESSAGE = mensaje natural indicando qu√© datos faltan\n     - ask = pregunta amigable por el **pr√≥ximo** dato faltante (siguiendo el orden)\n- En status=\"FINAL\":\n  - Ejecut√° validaciones estrictas. Si algo falla ‚Üí ERROR=true y ERROR_MESSAGE natural con **solo** el primer error; si todo ok ‚Üí ERROR=false y ERROR_MESSAGE=\"\"\n\n# VALIDACIONES (estrictas, SOLO aplican cuando el campo YA fue provisto; en FINAL se aplican a todos)\n1) NOMBRE: al menos dos palabras alfab√©ticas\n   - error natural: \"Necesito su nombre completo (nombre y apellido) para registrarlo en el sistema\"\n   \n2) DNI: ^\\\\d{7,8}$ (solo n√∫meros, sin puntos/espacios)\n   - error natural: \"El DNI que me pas√≥ no es v√°lido. Por favor, env√≠eme solo los n√∫meros, sin puntos ni espacios (ejemplo: 35946257)\"\n   \n3) OBRA_SOCIAL:\n   - \"no/sin obra social/particular\" ‚áí OBRA_SOCIAL=\"PART\", NOMBRE_OBRA_SOCIAL=\"PARTICULAR\"\n   - nombre informado ‚áí normalizar y buscar en $OBRAS_SOCIALES (exacto o inclusi√≥n); si no hay match ‚Üí \"Disculpe, la obra social que mencion√≥ no figura en nuestro sistema. ¬øPodr√≠a verificar el nombre o indicar si es particular?\"\n   - si no se inform√≥ ‚áí se considera **faltante** (no inv√°lido)\n   \n4) DIRECCION: debe incluir calle y **al menos un d√≠gito**\n   - error natural: \"Me falta la direcci√≥n completa. Por favor, ind√≠queme calle y n√∫mero (ejemplo: Calle 50 N¬∞123)\"\n   \n5) TELEFONO: ^\\\\d{10}$ (solo n√∫meros)\n   - error natural: \"El tel√©fono debe tener 10 d√≠gitos. Por favor, env√≠elo completo con c√≥digo de √°rea, solo n√∫meros (ejemplo: 2214567890)\"\n\n# TONO DE LOS MENSAJES\n- Us√° tratamiento formal (usted) pero amigable\n- S√© conversacional, no rob√≥tico\n- Record√° y reconoc√© los datos que ya ten√©s (\"Perfecto, ya tengo su nombre...\")\n- Cuando pidas el siguiente dato, pod√©s hacer referencia a lo que ya obtuviste\n- Los mensajes deben ser breves pero claros\n\n# FORMATO\n- Strings faltantes = \"\" ; n√∫meros faltantes = 0\n- ERROR = true si falta o est√° inv√°lido **cualquier** campo. ERROR=false solo si los 5 est√°n completos y v√°lidos\n\n# EJEMPLOS (NO IMPRIMIR)\n\n## Caso: usuario solo env√≠a NOMBRE (\"Hector miralles\")\n{\n  \"status\":\"ASK\",\n  \"ask\":\"Perfecto, Hector. Ahora necesito su DNI, por favor (7 u 8 d√≠gitos, sin puntos)\",\n  \"missing\":[\"DNI\",\"OBRA_SOCIAL\",\"DIRECCION\",\"TELEFONO\"],\n  \"data\":{\"NOMBRE\":\"Hector miralles\",\"DNI\":0,\"OBRA_SOCIAL\":\"\",\"NOMBRE_OBRA_SOCIAL\":\"\",\"DIRECCION\":\"\",\"TELEFONO\":0},\n  \"ERROR\": true,\n  \"ERROR_MESSAGE\": \"A√∫n faltan algunos datos: DNI, obra social, direcci√≥n y tel√©fono\"\n}\n\n## Caso: DNI provisto pero con puntos (\"12.345.678\")\n{\n  \"status\":\"ASK\",\n  \"ask\":\"Disculpe, necesito el DNI sin puntos. ¬øPuede enviarlo solo con n√∫meros? Por ejemplo: 12345678\",\n  \"missing\":[\"OBRA_SOCIAL\",\"DIRECCION\",\"TELEFONO\"],\n  \"data\":{\"NOMBRE\":\"Hector miralles\",\"DNI\":0,\"OBRA_SOCIAL\":\"\",\"NOMBRE_OBRA_SOCIAL\":\"\",\"DIRECCION\":\"\",\"TELEFONO\":0},\n  \"ERROR\": true,\n  \"ERROR_MESSAGE\": \"El DNI que me pas√≥ no es v√°lido. Por favor, env√≠eme solo los n√∫meros, sin puntos ni espacios (ejemplo: 35946257)\"\n}\n\n## Caso: Ya tenemos nombre y DNI v√°lido, pedimos obra social\n{\n  \"status\":\"ASK\",\n  \"ask\":\"Excelente. ¬øTiene obra social o es particular?\",\n  \"missing\":[\"OBRA_SOCIAL\",\"DIRECCION\",\"TELEFONO\"],\n  \"data\":{\"NOMBRE\":\"Hector Miralles\",\"DNI\":12345678,\"OBRA_SOCIAL\":\"\",\"NOMBRE_OBRA_SOCIAL\":\"\",\"DIRECCION\":\"\",\"TELEFONO\":0},\n  \"ERROR\": true,\n  \"ERROR_MESSAGE\": \"Me faltan los siguientes datos: obra social, direcci√≥n y tel√©fono\"\n}\n\n## Caso: Obra social no encontrada\n{\n  \"status\":\"ASK\",\n  \"ask\":\"Disculpe, la obra social 'Medicus Plus' no figura en nuestro sistema. ¬øPodr√≠a verificar el nombre exacto o indicarme si es particular?\",\n  \"missing\":[\"DIRECCION\",\"TELEFONO\"],\n  \"data\":{\"NOMBRE\":\"Hector Miralles\",\"DNI\":12345678,\"OBRA_SOCIAL\":\"\",\"NOMBRE_OBRA_SOCIAL\":\"\",\"DIRECCION\":\"\",\"TELEFONO\":0},\n  \"ERROR\": true,\n  \"ERROR_MESSAGE\": \"Disculpe, la obra social que mencion√≥ no figura en nuestro sistema. ¬øPodr√≠a verificar el nombre o indicar si es particular?\"\n}\n\n## FINAL OK (todo completo y v√°lido)\n{\n  \"status\":\"FINAL\",\n  \"ask\":\"\",\n  \"missing\":[],\n  \"data\":{\"NOMBRE\":\"Hector Miralles\",\"DNI\":12345678,\"OBRA_SOCIAL\":\"1\",\"NOMBRE_OBRA_SOCIAL\":\"Ioma\",\"DIRECCION\":\"Calle 50 123\",\"TELEFONO\":2215551234},\n  \"ERROR\": false,\n  \"ERROR_MESSAGE\":\"\"\n}\n\n## Caso: Usuario env√≠a todo junto pero direcci√≥n incompleta\n{\n  \"status\":\"ASK\",\n  \"ask\":\"Casi listo. Me falta el n√∫mero de su direcci√≥n. ¬øEn qu√© n√∫mero de la Calle 50 vive?\",\n  \"missing\":[\"TELEFONO\"],\n  \"data\":{\"NOMBRE\":\"Hector Miralles\",\"DNI\":12345678,\"OBRA_SOCIAL\":\"1\",\"NOMBRE_OBRA_SOCIAL\":\"Ioma\",\"DIRECCION\":\"\",\"TELEFONO\":0},\n  \"ERROR\": true,\n  \"ERROR_MESSAGE\": \"Me falta la direcci√≥n completa. Por favor, ind√≠queme calle y n√∫mero (ejemplo: Calle 50 N¬∞123)\"\n}"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[3056,1104],"id":"191b234c-97b0-441c-969b-ca0f66b1174b","name":"AI Agent1"},{"parameters":{"jsonSchemaExample":"{\n  \"NOMBRE\": \"Juan P√©rez\",\n  \"DNI\": 0,\n  \"OBRA_SOCIAL\": \"724\",\n  \"NOMBRE_OBRA_SOCIAL\": \"Osde\",\n  \"DIRECCION\": \"Calle 50 N 123\",\n  \"TELEFONO\": 2215551234,\n  \"ERROR\": true,\n  \"ERROR_MESSAGE\": \"DNI inv√°lido. Debe tener 7 u 8 d√≠gitos sin puntos (ej: 12345678). Por favor, proporcion√° tu DNI sin puntos.\"\n}","autoFix":true},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[3248,1328],"id":"00b22835-eb11-4442-a6ab-377baae0fbd8","name":"Structured Output Parser"},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Variables').first().json.contactNumber }}","sessionTTL":600,"contextWindowLength":10},"type":"@n8n/n8n-nodes-langchain.memoryRedisChat","typeVersion":1.5,"position":[3120,1328],"id":"deb32e67-489a-4053-90e3-d6a7a2f275b7","name":"Redis Chat Memory1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"content":"## POST TURNO","height":704,"width":1712,"color":5},"type":"n8n-nodes-base.stickyNote","position":[6464,944],"typeVersion":1,"id":"5882c60b-c71f-4e2a-961d-b89ce2f62d72","name":"Sticky Note1"},{"parameters":{"content":"## ESPECIALIDADES Y MEDICOS","height":368,"width":976,"color":4},"type":"n8n-nodes-base.stickyNote","position":[6464,48],"typeVersion":1,"id":"13dc3b34-40e7-4436-8e3a-f9c5aa067714","name":"Sticky Note4"},{"parameters":{"content":"## TURNOS ESTUDIO","height":288,"width":288,"color":7},"type":"n8n-nodes-base.stickyNote","position":[6464,-256],"typeVersion":1,"id":"173bfb18-f21d-4b53-898d-1ecde673b2b1","name":"Sticky Note6"},{"parameters":{"operation":"set","key":"=status:{{ $('üîÄ ROUTER PRINCIPAL').first().json.contactNumber }}","value":"PACIENTE_NUEVO_ERROR","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[4064,1008],"id":"28a7f4cf-8d1a-4c09-99d1-d2cca913e99d","name":"STATUS=PACIENTE_NUEVO1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"0ff6738a-d69a-4bd6-9e26-fee07ed3e8f5","leftValue":"={{ $json.output.status_verificacion }}","rightValue":"no_encontrado","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[3888,-1648],"id":"975f0588-acd4-480b-aa4b-0c3459da4dc6","name":"no_encontrado?"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Variables').first().json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"‚ö†Ô∏è {{ $('Get_Paciente1').item.json.output.mensaje_usuario }}\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[4112,-1808],"id":"a781e620-57fd-4196-aeb7-122133250f65","name":"‚ö†Ô∏è DATOS INCORRECTOS2","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Variables').first().json.contactNumber }}","value":"PACIENTE_REGISTRADO_ERROR","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[4336,-1808],"id":"56ce5226-1897-420f-afbf-fa20ff1868f8","name":"DATO_INCORRECTO1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"paciente","key":"=PACIENTE_REGISTRADO:{{ $('Filtro Tipo Mensaje').item.json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-720,-384],"id":"27d52b48-ccb6-423d-b594-a261b72b1c96","name":"PACIENTE","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"=DATOS_TURNO:{{ $('msg_clasificador').item.json.contactNumber }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[6992,1456],"id":"9421a38a-20bf-428e-b269-ee5c29f9f081","name":"DATOS","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=DATOS_TURNO:{{ $('msg_clasificador').first().json.contactNumber }}","value":"={{ JSON.stringify($json.datos) }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[7888,1008],"id":"2e75f6aa-b575-4bf1-8e22-9a0137f267ec","name":"DATOS1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"assignments":{"assignments":[{"id":"5243c907-4f75-4ea4-b100-d760922caf8d","name":"matricula","value":"={{ $json.datos.parseJson().matricula }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[6752,1232],"id":"351158f1-230c-4363-8ba2-3c09bdee8d83","name":"matricula"},{"parameters":{"url":"http://iclp.ddns.net:7080/ws-turnos-rest-simple/api/turnos/lista-turnos-actuales","sendQuery":true,"queryParameters":{"parameters":[{"name":"usuario","value":"WSTRRED"},{"name":"password","value":"Y2xpb25lcw"},{"name":"dni","value":"={{ $json.datos.paciente_dni.toNumber() }}"},{"name":"fecha","value":"={{ $now.setZone('America/Argentina/Buenos_Aires').toFormat('yyyyLLdd') }}"}]},"options":{"response":{"response":{"neverError":true,"responseFormat":"json"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[6784,1760],"id":"d6c17b78-e053-4609-8372-c8936c5efc75","name":"get_turnos_agendados2"},{"parameters":{"assignments":{"assignments":[{"id":"8c6cf375-6158-46f1-8b42-593cf42fff40","name":"lista","value":"={{ $json.lista[0] }}","type":"object"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[7008,1760],"id":"707ab157-d1a7-4d1f-8ace-b4c31faa282b","name":"datos3"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.recipient_type }}"},{"name":"to","value":"={{ $('msg_clasificador').first().json.contactNumber }}"},{"name":"type","value":"={{ $json.type }}"},{"name":"interactive","value":"={{ $json.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[7456,1760],"id":"607a65ac-5927-4657-9889-08498160e6fb","name":"MIS TURNOS2","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"jsCode":"// Obtener el objeto lista (que es un objeto, no un array)\nconst turno = $input.first().json.lista;\n\n// Verificar si existe el turno\nif (!turno || Object.keys(turno).length === 0) {\n  return [{\n    json: {\n      messaging_product: \"whatsapp\",\n      recipient_type: \"individual\",\n      to: $('GET_PACIENTE1').first().json.datos.paciente_celular,\n      type: \"interactive\",\n      interactive: {\n        type: \"button\",\n        body: {\n          text: \"‚ùå NO TEN√âS TURNOS PROGRAMADOS EN ESTE MOMENTO\"\n        },\n        footer: {\n          text: \"üìÖ Lun-Vie 8-20hs\"\n        },\n        action: {\n          buttons: [\n            {\n              type: \"reply\",\n              reply: {\n                id: \"volver-atras\",\n                title: \"VOLVER ATR√ÅS\"\n              }\n            }\n          ]\n        }\n      }\n    }\n  }];\n}\n\n// Extraer datos del turno\nconst fechaString = turno.fechaString || 'Sin fecha'; // Ejemplo: \"20251016\"\nconst hora5digitos = turno.hora5digitos || 'Sin hora'; // Ejemplo: \"10:20\"\nconst nombreMedico = turno.nombreMedico || 'Sin nombre'; // Ejemplo: \"ERGOMETRIA BARBIERI\"\nconst matricula = turno.matricula || 'Sin matr√≠cula'; // Ejemplo: \"139\"\n\n// Separar apellido del m√©dico y tipo de estudio\n// Ejemplo: \"ERGOMETRIA BARBIERI\" -> apellido=\"BARBIERI\", estudio=\"ERGOMETRIA\"\nconst partes = nombreMedico.split(' ');\nconst apellido = partes.length > 1 ? partes[partes.length - 1] : nombreMedico;\nconst tipoEstudio = partes.length > 1 ? partes.slice(0, -1).join(' ') : 'CONSULTA';\n\n// Formatear fecha de \"20251016\" a \"16-10-2025\"\nlet fechaFormateada = fechaString;\nif (fechaString.length === 8) {\n  const a√±o = fechaString.substring(0, 4);\n  const mes = fechaString.substring(4, 6);\n  const dia = fechaString.substring(6, 8);\n  fechaFormateada = `${dia}-${mes}-${a√±o}`;\n}\n\n// Construir el mensaje con formato mejorado\nconst mensajeTurnos = `üìã *TUS TURNOS PROGRAMADOS:*\\n\\nüë®‚Äç‚öïÔ∏è *Turno con:* Dr. ${apellido} | Matr√≠cula ${matricula}\\nü©∫ *Tipo de estudio:* ${tipoEstudio}\\nüìÖ *Fecha:* ${fechaFormateada} a las ${hora5digitos}`;\n\n// Retornar el mensaje con bot√≥n\nreturn [{\n  json: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: $('GET_PACIENTE1').first().json.datos.paciente_celular,\n    type: \"interactive\",\n    interactive: {\n      type: \"button\",\n      body: {\n        text: mensajeTurnos\n      },\n      footer: {\n        text: \"üìÖ Lun-Vie 8-20hs\"\n      },\n      action: {\n        buttons: [\n          {\n            type: \"reply\",\n            reply: {\n              id: \"volver-atras\",\n              title: \"VOLVER ATR√ÅS\"\n            }\n          }\n        ]\n      }\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[7232,1760],"id":"2a8f1654-752d-4aab-9a29-c015a412142b","name":"üìã LISTAR TURNOS1"},{"parameters":{"operation":"get","propertyName":"datos","key":"=PACIENTE_REGISTRADO:{{ $('Variables').first().json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[6544,1760],"id":"c0ec66c6-a812-48b3-a529-532bbb925ad7","name":"GET_PACIENTE1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"content":"## PRESIONAN \"MIS TURNOS\"","height":272,"width":1184,"color":7},"type":"n8n-nodes-base.stickyNote","position":[6464,1664],"typeVersion":1,"id":"0d244138-7595-4a98-9045-9713049a6eec","name":"Sticky Note7"},{"parameters":{"content":"## MENU\n* MIS TURNOS\n* Turnos estudio-TURNOS CONSULTORIO","height":480,"width":752,"color":2},"type":"n8n-nodes-base.stickyNote","position":[6464,-768],"typeVersion":1,"id":"c86a3b1f-7cff-41e1-950e-033192e031f1","name":"Sticky Note8"},{"parameters":{"content":"## CREAR PACIENTE O REGISTRARSE","height":464,"width":960,"color":5},"type":"n8n-nodes-base.stickyNote","position":[6464,-1248],"typeVersion":1,"id":"2f138eb5-7b3f-4f40-9191-d34c41b25442","name":"Sticky Note10"},{"parameters":{"operation":"delete","key":"PACIENTE_REGISTRADO:+5492254596618"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-272,320],"id":"8f4a8f76-7919-4bf8-838a-0850c871ee70","name":"Redis4","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"contador:5492254596618"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-64,320],"id":"752a200f-ce21-41f1-8346-820d7b736afd","name":"Redis5","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}}],"connections":{"Variables":{"main":[[{"node":"Filtrar n√∫meros de prueba","type":"main","index":0}]]},"Filtro Tipo Mensaje":{"main":[[],[{"node":"MSG ENVIADO?","type":"main","index":0}],[{"node":"HTTP Request4","type":"main","index":0}]]},"üîç Get Estado Actual":{"main":[[{"node":"Parsear Redis","type":"main","index":0}]]},"üì± Mensaje Menu Principal":{"main":[[{"node":"üíæ Set Estado MENU","type":"main","index":0}]]},"üìÖ Turnos - PACIENTE NUEVO - PACIENTE REGISTRADO - ":{"main":[[{"node":"üíæ Set Estado MENU1","type":"main","index":0}]]},"CREAR PACIENTE":{"main":[[{"node":"‚è±Ô∏è STATUS PRIMERA VEZ","type":"main","index":0}]]},"üé´ Router Gesti√≥n Turnos":{"main":[[{"node":"CREAR PACIENTE","type":"main","index":0}]]},"üì± Mensaje Info General":{"main":[[{"node":"üíæ Set Estado MENU2","type":"main","index":0}]]},"Code":{"main":[[{"node":"üîÄ SWITCH INFO FLUJOS","type":"main","index":0}]]},"Medicos":{"main":[[{"node":"‚è±Ô∏è STATUS PRIMERA VEZ1","type":"main","index":0}]]},"üíæ Set Estado MENU2":{"main":[[{"node":"HTTP Request1","type":"main","index":0}]]},"üíæ Set Estado MENU":{"main":[[{"node":"HTTP Request2","type":"main","index":0}]]},"üíæ Set Estado MENU1":{"main":[[{"node":"HTTP Request3","type":"main","index":0}]]},"HTTP Request4":{"main":[[{"node":"PACIENTE","type":"main","index":0}]]},"msg_clasificador":{"main":[[{"node":"Preparar Redis","type":"main","index":0}]]},"‚è±Ô∏è STATUS PRIMERA VEZ":{"main":[[{"node":"HTTP Request5","type":"main","index":0}]]},"üè¢ Administraci√≥n":{"main":[[{"node":"HTTP Request6","type":"main","index":0}]]},"Filtrar n√∫meros de prueba":{"main":[[{"node":"Filtro Tipo Mensaje","type":"main","index":0}]]},"HTTP Request6":{"main":[[{"node":"üíæ Set Estado MENU3","type":"main","index":0}]]},"ETIQUETA CONSULTA-RECLAMO":{"main":[[{"node":"HTTP Request7","type":"main","index":0}]]},"HTTP Request8":{"main":[[{"node":"sendRespondCw","type":"main","index":0}]]},"sendRespondCw":{"main":[[{"node":"contador","type":"main","index":0}]]},"MSG ENVIADO?":{"main":[[{"node":"If","type":"main","index":0}]]},"If":{"main":[[],[{"node":"HTTP Request8","type":"main","index":0}]]},"ESPECIALIDADES2":{"main":[[{"node":"ENVIA-> MENU-SACAR TURNO","type":"main","index":0}]]},"MEDICOS":{"main":[[{"node":"ENVIA-> MENU-SACAR TURNO1","type":"main","index":0}]]},"Msg preparado":{"main":[[{"node":"MEDICOS","type":"main","index":0}]]},"get_medicos1":{"main":[[{"node":"Msg preparado","type":"main","index":0}]]},"get_especialidades":{"main":[[{"node":"Msg preparado1","type":"main","index":0}]]},"Msg preparado1":{"main":[[{"node":"ESPECIALIDADES2","type":"main","index":0}]]},"üîÄ SWITCH INFO FLUJOS":{"main":[[{"node":"get_medicos1","type":"main","index":0}],[{"node":"get_especialidades","type":"main","index":0}],[{"node":"Medicos","type":"main","index":0}]]},"üé´ Router Gesti√≥n Turnos1":{"main":[[{"node":"PACIENTE REGISTRADO","type":"main","index":0}]]},"PACIENTE REGISTRADO":{"main":[[{"node":"‚è±Ô∏è STATUS PRIMERA VEZ2","type":"main","index":0}]]},"üîÄ SWITCH DATOS PACIENTE":{"main":[[{"node":"üé´ Router Gesti√≥n Turnos1","type":"main","index":0}],[{"node":"obrasociales","type":"main","index":0}],[{"node":"obrasociales","type":"main","index":0}]]},"PACIENTE REGISTRADO1":{"main":[[{"node":"SOLICITAR DNI","type":"main","index":0}]]},"SOLICITAR DNI":{"main":[[{"node":"‚è±Ô∏è STATUS PRIMERA VEZ3","type":"main","index":0}]]},"Error informacion de usuario":{"main":[[{"node":"‚ö†Ô∏è DATOS INCORRECTOS","type":"main","index":0}],[{"node":"Get_Paciente1","type":"main","index":0}]]},"OpenRouter Chat Model1":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"Structured Output Parser1":{"ai_outputParser":[[{"node":"AI Agent","type":"ai_outputParser","index":0}]]},"AI Agent":{"main":[[{"node":"Error informacion de usuario","type":"main","index":0}]]},"Get_Paciente1":{"main":[[{"node":"no_encontrado?","type":"main","index":0}]]},"‚úÖ DATOS VALIDADOS":{"main":[[{"node":"DNI VERIFICADO","type":"main","index":0}]]},"obra_social1":{"main":[[{"node":"Code8","type":"main","index":0}]]},"Code8":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"Redis Chat Memory":{"ai_memory":[[{"node":"AI Agent","type":"ai_memory","index":0}]]},"msg":{"main":[[{"node":"[MENU] - GESTION MIS TURNOS","type":"main","index":0}]]},"ü©ª ESPECIALIDADES1":{"main":[[{"node":"ESPECIALIDADES1","type":"main","index":0}]]},"Get_Especialidades1":{"main":[[{"node":"LISTA_ESPECIALIDADES_BLOQUES","type":"main","index":0}]]},"LISTA_ESPECIALIDADES_BLOQUES":{"main":[[{"node":"ü©ª ESPECIALIDADES1","type":"main","index":0}]]},"get_medicos2":{"main":[[{"node":"LISTA_MEDICOS","type":"main","index":0}]]},"LISTA_MEDICOS":{"main":[[{"node":"Medicos2","type":"main","index":0}]]},"Medicos2":{"main":[[{"node":"ü©∫ MEDICOS2","type":"main","index":0}]]},"üìÖ Horarios Proximos":{"main":[[{"node":"üïê LISTA-HORARIOS","type":"main","index":0}]]},"üïê Fechas disponibles ":{"main":[[{"node":"ü©∫ FECHA","type":"main","index":0}]]},"üïê LISTA-HORARIOS":{"main":[[{"node":"üïê Fechas disponibles ","type":"main","index":0}]]},"DNI VERIFICADO":{"main":[[{"node":"PACIENTE_REGISTRADO","type":"main","index":0}]]},"If1":{"main":[[],[{"node":"sendRespondCw1","type":"main","index":0}]]},"Parsear Redis":{"main":[[{"node":"msg_clasificador","type":"main","index":0}]]},"Preparar Redis":{"main":[[{"node":"Redis","type":"main","index":0}]]},"Redis":{"main":[[{"node":"üîÄ ROUTER PRINCIPAL","type":"main","index":0}]]},"Entrada":{"main":[[{"node":"Variables","type":"main","index":0}]]},"msg1":{"main":[[{"node":"[MENU] - TURNOS","type":"main","index":0}]]},"[MENU] - GESTION MIS TURNOS":{"main":[[{"node":"STATUS:MENU=1","type":"main","index":0}]]},"[MENU] - TURNOS":{"main":[[{"node":"STATUS:MENU=","type":"main","index":0}]]},"üîÄ ROUTER PRINCIPAL":{"main":[[{"node":"obra_social1","type":"main","index":0}],[{"node":"üì± Mensaje Menu Principal","type":"main","index":0}],[{"node":"üìÖ Turnos - PACIENTE NUEVO - PACIENTE REGISTRADO - ","type":"main","index":0}],[{"node":"üì± Mensaje Info General","type":"main","index":0}],[{"node":"üè¢ Administraci√≥n","type":"main","index":0}],[{"node":"ETIQUETA CONSULTA-RECLAMO","type":"main","index":0}],[{"node":"üîÄ SWITCH GESTI√ìN TURNOS","type":"main","index":0}],[{"node":"üîÄ SWITCH DATOS PACIENTE","type":"main","index":0}],[],[{"node":"Code","type":"main","index":0}]]},"SWITCH: Tipo Men√∫ Tomar Turno":{"main":[[{"node":"msg","type":"main","index":0}],[{"node":"msg1","type":"main","index":0}]]},"‚ö†Ô∏è DATOS INCORRECTOS":{"main":[[{"node":"DATO_INCORRECTO","type":"main","index":0}]]},"Code2":{"main":[[{"node":"Datos para confirmar turno","type":"main","index":0}]]},"MATRICULA":{"main":[[{"node":"Code2","type":"main","index":0}]]},"üìÖ Confirmar turno":{"main":[[{"node":"DATOS_COMBINADOS","type":"main","index":0}]]},"Datos para confirmar turno":{"main":[[]]},"DATOS_PACIENTE":{"main":[[{"node":"MATRICULA","type":"main","index":0}]]},"Redis2":{"main":[[{"node":"DATOS_TURNO_PACIENTE","type":"main","index":0}]]},"PREPARAR_CONFIRMAR_TURNO":{"main":[[{"node":"DATOS_PACIENTE","type":"main","index":0}]]},"ü©∫ FECHA":{"main":[[{"node":"Code3","type":"main","index":0}]]},"‚è±Ô∏è STATUS PRIMERA VEZ2":{"main":[[{"node":"PREPARAR_CONFIRMAR_TURNO","type":"main","index":0}]]},"üîÄ SWITCH GESTI√ìN TURNOS":{"main":[[{"node":"üé´ Router Gesti√≥n Turnos","type":"main","index":0}],[{"node":"PACIENTE REGISTRADO1","type":"main","index":0}],[{"node":"SWITCH: Tipo Men√∫ Tomar Turno","type":"main","index":0}],[],[{"node":"Get_Especialidades1","type":"main","index":0}],[{"node":"TURNOS ESTUDIO","type":"main","index":0}],[{"node":"Get_Especialidades1","type":"main","index":0}],[{"node":"get_medicos2","type":"main","index":0}],[{"node":"get_medicos2","type":"main","index":0}],[{"node":"GET_PACIENTE_REGISTRADO","type":"main","index":0}],[{"node":"datos","type":"main","index":0}],[{"node":"Datos para confirmar turno1","type":"main","index":0}],[{"node":"Redis3","type":"main","index":0}],[{"node":"DATOS_PACIENTE1","type":"main","index":0}],[{"node":"GET_PACIENTE1","type":"main","index":0}]]},"Datos para confirmar turno1":{"main":[[{"node":"EJECUTAR TURNO","type":"main","index":0}]]},"datos":{"main":[[{"node":"matricula","type":"main","index":0}]]},"DATOS_PACIENTE_REGISTRADO":{"main":[[{"node":"üìÖ Confirmar turno","type":"main","index":0}]]},"DATOS_COMBINADOS":{"main":[[{"node":"Redis2","type":"main","index":0}]]},"GET_PACIENTE_REGISTRADO":{"main":[[{"node":"üìÖ Horarios Proximos","type":"main","index":0}]]},"Code3":{"main":[[{"node":"DATOS1","type":"main","index":0}]]},"get_turnos_agendados1":{"main":[[{"node":"datos1","type":"main","index":0}]]},"datos1":{"main":[[{"node":"üö´ CANCELAR TURNO","type":"main","index":0}]]},"MIS TURNOS1":{"main":[[{"node":"Datos turnos","type":"main","index":0}]]},"üö´ CANCELAR TURNO":{"main":[[{"node":"MIS TURNOS1","type":"main","index":0}]]},"Datos turnos":{"main":[[{"node":"STATUS=CANCELAR-TURNO","type":"main","index":0}]]},"DATOS_PACIENTE1":{"main":[[{"node":"get_turnos_agendados1","type":"main","index":0}]]},"üö´ TURNO-CANCELADO":{"main":[[{"node":"DELETE - STATUS MENU2","type":"main","index":0}]]},"DELETE_TURNO":{"main":[[{"node":"Code4","type":"main","index":0}]]},"Redis3":{"main":[[{"node":"DELETE_TURNO","type":"main","index":0}]]},"Code4":{"main":[[{"node":"üö´ TURNO-CANCELADO","type":"main","index":0}]]},"OpenRouter Chat Model2":{"ai_languageModel":[[{"node":"AI Agent1","type":"ai_languageModel","index":0}]]},"obrasociales":{"main":[[{"node":"Code6","type":"main","index":0}]]},"Code6":{"main":[[{"node":"AI Agent1","type":"main","index":0}]]},"‚úÖ DATOS VALIDADOS3":{"main":[[{"node":"ü§ñ RESET AGENTE","type":"main","index":0}]]},"ü§ñ RESET AGENTE":{"main":[[{"node":"DATOS_PACIENTE REGISTRADO","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"Structured Output Parser","type":"ai_languageModel","index":0}]]},"POST_PACIENTE":{"main":[[{"node":"‚úÖ DATOS VALIDADOS3","type":"main","index":0}]]},"DATOS_PACIENTE REGISTRADO":{"main":[[{"node":"STATUS=PACIENTE_NUEVO","type":"main","index":0}]]},"Error informacion de usuario1":{"main":[[{"node":"‚ö†Ô∏è DATOS INCORRECTOS1","type":"main","index":0}],[{"node":"POST_PACIENTE","type":"main","index":0}]]},"‚ö†Ô∏è DATOS INCORRECTOS1":{"main":[[{"node":"STATUS=PACIENTE_NUEVO1","type":"main","index":0}]]},"AI Agent1":{"main":[[{"node":"Error informacion de usuario1","type":"main","index":0}]]},"Structured Output Parser":{"ai_outputParser":[[{"node":"AI Agent1","type":"ai_outputParser","index":0}]]},"Redis Chat Memory1":{"ai_memory":[[{"node":"AI Agent1","type":"ai_memory","index":0}]]},"no_encontrado?":{"main":[[{"node":"‚ö†Ô∏è DATOS INCORRECTOS2","type":"main","index":0}],[{"node":"‚úÖ DATOS VALIDADOS","type":"main","index":0}]]},"‚ö†Ô∏è DATOS INCORRECTOS2":{"main":[[{"node":"DATO_INCORRECTO1","type":"main","index":0}]]},"PACIENTE":{"main":[[{"node":"üîç Get Estado Actual","type":"main","index":0}]]},"EJECUTAR TURNO":{"main":[[{"node":"DATOS","type":"main","index":0}]]},"matricula":{"main":[[{"node":"DATOS_PACIENTE_REGISTRADO","type":"main","index":0}]]},"get_turnos_agendados2":{"main":[[{"node":"datos3","type":"main","index":0}]]},"datos3":{"main":[[{"node":"üìã LISTAR TURNOS1","type":"main","index":0}]]},"üìã LISTAR TURNOS1":{"main":[[{"node":"MIS TURNOS2","type":"main","index":0}]]},"GET_PACIENTE1":{"main":[[{"node":"get_turnos_agendados2","type":"main","index":0}]]},"Redis1":{"main":[[{"node":"Redis4","type":"main","index":0}]]},"Redis4":{"main":[[]]}},"settings":{"executionOrder":"v1","timezone":"America/Argentina/Buenos_Aires","callerPolicy":"workflowsFromSameOwner"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Entrada":[{"json":{"headers":{"host":"hooks.autoclinicas.com","user-agent":"rest-client/2.1.0 (linux-musl x86_64) ruby/3.4.4p34","content-length":"1938","accept":"application/json","accept-encoding":"gzip;q=1.0,deflate;q=0.6,identity;q=0.3","content-type":"application/json","x-forwarded-for":"206.81.1.93","x-forwarded-host":"hooks.autoclinicas.com","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"f2c799d0c305","x-real-ip":"206.81.1.93"},"params":{},"query":{},"body":{"additional_attributes":{},"can_reply":true,"channel":"Channel::Whatsapp","contact_inbox":{"id":12978,"contact_id":7045,"inbox_id":13,"source_id":"5492215453499","created_at":"2025-10-26T02:51:15.663Z","updated_at":"2025-10-26T02:51:15.663Z","hmac_verified":false,"pubsub_token":"wMhF32RdsKMmv3UALuu5ivyL"},"id":8942,"inbox_id":13,"messages":[{"id":121522,"content":"S√ÅB 01/11 - 11:00","account_id":2,"inbox_id":13,"conversation_id":8942,"message_type":0,"created_at":1761564313,"updated_at":"2025-10-27T11:25:13.598Z","private":false,"status":"sent","source_id":"wamid.HBgNNTQ5MjIxNTQ1MzQ5ORUCABIYFDNBRTI0QzM3ODNFMjM3QkI3NzdEAA==","content_type":"text","content_attributes":{"in_reply_to_external_id":null,"in_reply_to":null},"sender_type":"Contact","sender_id":7045,"external_source_ids":{},"additional_attributes":{},"processed_message_content":"S√ÅB 01/11 - 11:00","sentiment":{},"conversation":{"assignee_id":null,"unread_count":1,"last_activity_at":1761564313,"contact_inbox":{"source_id":"5492215453499"}},"sender":{"additional_attributes":{},"custom_attributes":{},"email":null,"id":7045,"identifier":null,"name":"Fer üåüü¶Ñ","phone_number":"+5492215453499","thumbnail":"","blocked":false,"type":"contact"}}],"labels":[],"meta":{"sender":{"additional_attributes":{},"custom_attributes":{},"email":null,"id":7045,"identifier":null,"name":"Fer üåüü¶Ñ","phone_number":"+5492215453499","thumbnail":"","blocked":false,"type":"contact"},"assignee":null,"team":{"id":1,"name":"recepcionistas"},"hmac_verified":false},"status":"open","custom_attributes":{},"snoozed_until":null,"unread_count":1,"first_reply_created_at":null,"priority":null,"waiting_since":1761447075,"agent_last_seen_at":1761564289,"contact_last_seen_at":0,"last_activity_at":1761564313,"timestamp":1761564313,"created_at":1761447075,"updated_at":1761564313.602689,"applied_sla":null,"sla_events":[],"sla_policy_id":null,"event":"automation_event.message_created"},"webhookUrl":"https://hooks.autoclinicas.com/webhook/agentes/v1/iclp","executionMode":"production"}}]},"versionId":"6d9e4d06-443c-4ad2-9207-b2a8fbc3756e","triggerCount":1,"shared":[{"createdAt":"2025-10-24T05:06:16.254Z","updatedAt":"2025-10-24T05:06:16.254Z","role":"workflow:owner","workflowId":"gIhBDLybkhqRwiWz","projectId":"R66ikVn5xqf0nYcA"}],"tags":[{"createdAt":"2025-10-18T05:48:24.047Z","updatedAt":"2025-10-18T05:48:24.047Z","id":"9MPkCQDvT4HFCUIK","name":"ClinicAI-v1.33"}]}