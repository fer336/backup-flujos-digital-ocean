{"createdAt":"2025-10-20T05:55:43.481Z","updatedAt":"2025-10-24T05:05:32.780Z","id":"mhp1WkQm8lsNRsma","name":"MASTER-REFACTORIZACION","active":false,"isArchived":true,"nodes":[{"parameters":{"httpMethod":"POST","path":"agentes/v1/iclp","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1504,208],"id":"4a3817d9-ef97-4fef-927d-5989a59f9287","name":"ğŸ”” Webhook Entrada","webhookId":"c750562d-ea1f-43c4-abd9-173117a9f97f"},{"parameters":{"assignments":{"assignments":[{"id":"1","name":"phone","value":"={{ $json.body.messages[0].sender.phone_number }}","type":"string"},{"id":"2","name":"message","value":"={{ $json.body.messages[0].content }}","type":"string"},{"id":"3","name":"contactId","value":"={{ $json.body.messages[0].sender.id }}","type":"number"},{"id":"4","name":"conversationId","value":"={{ $json.body.id }}","type":"number"},{"id":"5","name":"senderType","value":"={{ $json.body.messages[0].sender.type }}","type":"string"},{"id":"6","name":"event","value":"={{ $json.body.event }}","type":"string"},{"id":"7","name":"contentType","value":"={{ $json.body.messages[0].content_type }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1280,208],"id":"370c6928-6739-4fe9-9f0f-40476778bad7","name":"ğŸ“‹ Extraer Datos"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"1","leftValue":"={{ $json.senderType }}","rightValue":"agent_bot","operator":{"type":"string","operation":"notEquals"}},{"id":"2","leftValue":"={{ $json.event }}","rightValue":"message_created","operator":{"type":"string","operation":"equals"}},{"id":"3","leftValue":"={{ $json.contentType }}","rightValue":"text","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[-1056,208],"id":"01be4371-0e15-44c5-82ec-f1ed5a48a6d1","name":"ğŸ” Filtrar Mensajes"},{"parameters":{"operation":"get","key":"=session:{{ $json.phone }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-832,208],"id":"1836c63e-0182-49ea-b266-9f897ba8d97b","name":"ğŸ“¥ Get Session","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"// ============================================================\n// ğŸ¤– ICLP - ESTADO HANDLER PRINCIPAL\n// ============================================================\n\nconst phone = $('ğŸ“‹ Extraer Datos').first().json.phone;\nconst mensaje = $('ğŸ“‹ Extraer Datos').first().json.message;\nconst conversationId = $('ğŸ“‹ Extraer Datos').first().json.conversationId;\n\n// ============================================================\n// ğŸ“¦ INICIALIZAR O RECUPERAR SESIÃ“N\n// ============================================================\n\nlet sesion;\ntry {\n  const sessionData = $('ğŸ“¥ Get Session').first().json.session;\n  sesion = sessionData ? JSON.parse(sessionData) : null;\n} catch (e) {\n  sesion = null;\n}\n\nif (!sesion) {\n  sesion = {\n    estado: 'menu_principal',\n    contexto: {},\n    historial: ['inicio'],\n    timestamp: Date.now(),\n    intentos: 0\n  };\n}\n\n// ============================================================\n// ğŸ¯ FUNCIONES AUXILIARES\n// ============================================================\n\nfunction normalizarMensaje(msg) {\n  return msg.trim().toUpperCase();\n}\n\nfunction esBotonInteractivo(msg) {\n  const botones = [\n    'TURNOS', 'INFO GENERAL', 'ADMINISTRACION',\n    'NUEVO PACIENTE', 'PACIENTE REGISTRADO',\n    'CONTINUAR', 'MENU PRINCIPAL', 'VOLVER ATRAS',\n    'TOMAR TURNO', 'CANCELAR TURNO', 'MIS TURNO/S',\n    'SI, CONFIRMO', 'CONFIRMAR TURNO',\n    'TURNOS CONSULTORIO', 'TURNOS ESTUDIO',\n    'VER MAS', 'VOLVER'\n  ];\n  return botones.includes(normalizarMensaje(msg));\n}\n\nfunction esDNI(msg) {\n  return /^\\d{7,8}$/.test(msg.trim());\n}\n\nfunction esCodigoEspecialidad(msg) {\n  // Formato: ESPECIALIDAD-123\n  return /^[A-Z]+-\\d+$/.test(msg);\n}\n\nfunction esMatriculaMedico(msg) {\n  // Formato: APELLIDO-12345\n  return /^[A-Z]+-\\d+$/.test(msg) && !esCodigoEspecialidad(msg);\n}\n\nfunction esFechaHora(msg) {\n  // Formato: MIÃ‰ 22/10 - 15:40\n  return /^[A-Z]{3}\\s\\d{2}\\/\\d{2}\\s-\\s\\d{2}:\\d{2}$/.test(msg);\n}\n\nfunction extraerCodigo(msg) {\n  const match = msg.match(/-([\\d]+)$/);\n  return match ? match[1] : null;\n}\n\n// ============================================================\n// ğŸ“‹ GENERADOR DE MENSAJES WHATSAPP\n// ============================================================\n\nconst templates = {\n  menu_principal: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: phone,\n    type: \"interactive\",\n    interactive: {\n      type: \"button\",\n      header: {\n        type: \"image\",\n        image: { link: \"https://i.imgur.com/cSVuheF.png\" }\n      },\n      body: {\n        text: \"ğŸ‘‹ Â¡HOLA! BIENVENIDO AL ICLP\\n\\nğŸ¤– BOT: DISPONIBLE 24/7\\n\\nğŸ“ ATENCIÃ“N TELEFÃ“NICA:\\nLUNES A VIERNES 8-20HS | SÃBADO 8-13HS\\n\\nSELECCIONÃ UNA OPCIÃ“N:\\n\\nğŸ“… TURNOS (BOT)\\n- AGENDAR, CONSULTAR O CANCELAR\\n\\nâ„¹ï¸ INFO GENERAL (BOT)\\n- HORARIOS, UBICACIÃ“N Y MÃS\\n\\nğŸ¢ ADMINISTRACIÃ“N\\n* RESPUESTA EN HORARIO DE ATENCIÃ“N\"\n      },\n      footer: { text: \"SELECCIONÃ UNA OPCIÃ“N ğŸ‘‡\" },\n      action: {\n        buttons: [\n          { type: \"reply\", reply: { id: \"turnos\", title: \"ğŸ“… TURNOS\" }},\n          { type: \"reply\", reply: { id: \"info\", title: \"â„¹ï¸ INFO GENERAL\" }},\n          { type: \"reply\", reply: { id: \"admin\", title: \"ğŸ¢ ADMINISTRACION\" }}\n        ]\n      }\n    }\n  },\n\n  tipo_paciente: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: phone,\n    type: \"interactive\",\n    interactive: {\n      type: \"button\",\n      header: { type: \"text\", text: \"ğŸ«€ INSTITUTO DE CARDIOLOGÃA LA PLATA\" },\n      body: {\n        text: \"ğŸ“‹ PARA SACAR UN TURNO, SELECCIONÃ:\\n\\nğŸ†• NUEVO PACIENTE\\nâ†’ Si es tu primera vez\\n\\nğŸ‘¤ PACIENTE REGISTRADO\\nâ†’ Si ya tenÃ©s historial con nosotros\\n\\nğŸ  MENÃš PRINCIPAL\\nâ†’ Ver horarios, ubicaciÃ³n y mÃ¡s info\"\n      },\n      footer: { text: \"LUN-VIE 8-20HS\" },\n      action: {\n        buttons: [\n          { type: \"reply\", reply: { id: \"nuevo\", title: \"NUEVO PACIENTE\" }},\n          { type: \"reply\", reply: { id: \"registrado\", title: \"PACIENTE REGISTRADO\" }},\n          { type: \"reply\", reply: { id: \"menu\", title: \"MENU PRINCIPAL\" }}\n        ]\n      }\n    }\n  },\n\n  solicitar_dni: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: phone,\n    type: \"interactive\",\n    interactive: {\n      type: \"button\",\n      body: {\n        text: \"*ğŸ“‹ PACIENTE REGISTRADO*\\n\\n*PARA CONTINUAR CON SU TURNO, NECESITO SU DNI:*\\n\\n*ğŸ” FORMATO:*\\nENVÃE SOLO SU NÃšMERO DE DNI (SIN PUNTOS NI ESPACIOS)\\n\\n*EJEMPLO:*\\n_35987654_\\n\\nğŸ‘‡ *ESCRIBA SU DNI Y ENVÃELO*\"\n      },\n      footer: { text: \"ğŸ“… LUN-VIE 8-20HS\" },\n      action: {\n        buttons: [\n          { type: \"reply\", reply: { id: \"volver\", title: \"MENU PRINCIPAL\" }}\n        ]\n      }\n    }\n  },\n\n  dni_invalido: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: phone,\n    type: \"text\",\n    text: {\n      body: \"âŒ *DNI INVÃLIDO*\\n\\nEl DNI debe tener 7 u 8 dÃ­gitos sin puntos ni espacios.\\n\\n*EJEMPLO:* 35946257\\n\\nPor favor, intÃ©ntelo nuevamente.\"\n    }\n  },\n\n  dni_no_encontrado: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: phone,\n    type: \"text\",\n    text: {\n      body: \"âŒ *LO SENTIMOS*\\n\\nEL DNI QUE NOS PROPORCIONÃ“ NO SE ENCUENTRA REGISTRADO EN NUESTRO SISTEMA.\\n\\nâœ… *Â¿QUÃ‰ PUEDE HACER?*\\n\\n*1ï¸âƒ£ VERIFIQUE EL DNI*\\nASEGÃšRESE DE HABERLO INGRESADO CORRECTAMENTE\\n\\n*2ï¸âƒ£ REGÃSTRESE COMO NUEVO PACIENTE*\\nVUELVA AL MENÃš PRINCIPAL Y SELECCIONE *NUEVO PACIENTE*\\n\\nğŸ“ *Â¿NECESITA AYUDA?*\\n(0221) 490-6310\\nLUN-VIE 8-20HS\"\n    }\n  },\n\n  gestion_turnos: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: phone,\n    type: \"interactive\",\n    interactive: {\n      type: \"button\",\n      header: { type: \"text\", text: \"ğŸ«€ ICLP - GESTIÃ“N DE TURNOS\" },\n      body: {\n        text: \"*ğŸ“‹ GESTIÃ“N DE TURNOS*\\n\\n*Â¿QUÃ‰ DESEA HACER?*\\n\\n*ğŸ“… TOMAR TURNO*\\nâ†’ AGENDAR UNA NUEVA CONSULTA\\n\\n*âŒ CANCELAR TURNO*\\nâ†’ ANULAR UN TURNO PROGRAMADO\\n\\n*ğŸ“‹ MIS TURNO/S*\\nâ†’ VER SUS PRÃ“XIMAS CITAS\\n\\nğŸ‘‡ *SELECCIONE UNA OPCIÃ“N*\"\n      },\n      footer: { text: \"ğŸ“… LUN-VIE 8-20HS\" },\n      action: {\n        buttons: [\n          { type: \"reply\", reply: { id: \"tomar\", title: \"TOMAR TURNO\" }},\n          { type: \"reply\", reply: { id: \"cancelar\", title: \"CANCELAR TURNO\" }},\n          { type: \"reply\", reply: { id: \"misturnos\", title: \"MIS TURNO/S\" }}\n        ]\n      }\n    }\n  },\n\n  tipo_turno: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: phone,\n    type: \"interactive\",\n    interactive: {\n      type: \"button\",\n      header: { type: \"text\", text: \"ğŸ«€ INSTITUTO DE CARDIOLOGÃA LA PLATA\" },\n      body: {\n        text: \"Recuerda que MOMENTÃNEAMENTE SOLO DAMOS LOS TURNOS MÃS PRÃ“XIMOS\\n\\nSi necesita una fecha mÃ¡s lejana elija la opciÃ³n de administraciÃ³n\"\n      },\n      footer: { text: \"ğŸ“… Lun-Vie 8-20hs\" },\n      action: {\n        buttons: [\n          { type: \"reply\", reply: { id: \"consultorio\", title: \"TURNOS CONSULTORIO\" }},\n          { type: \"reply\", reply: { id: \"estudio\", title: \"TURNOS ESTUDIO\" }},\n          { type: \"reply\", reply: { id: \"volver\", title: \"MENU PRINCIPAL\" }}\n        ]\n      }\n    }\n  },\n\n  solicitar_datos_nuevos: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: phone,\n    type: \"interactive\",\n    interactive: {\n      type: \"button\",\n      body: {\n        text: \"*ğŸ“ REGISTRO DE NUEVO PACIENTE*\\n\\n*AL SER TU PRIMERA VEZ, NECESITAMOS TUS DATOS:*\\n\\nâ†’ NOMBRE Y APELLIDO\\nâ†’ DNI\\nâ†’ OBRA SOCIAL\\nâ†’ TELÃ‰FONO\\nâ†’ DOMICILIO\\n\\n*ğŸ“‹ FORMATO:*\\nENVIÃ TUS DATOS EN UN SOLO MENSAJE, ASÃ:\\n\\n_JUAN PEREZ_\\n_35946257_\\n_OSDE_\\n_2214567890_\\n_CALLE 50 NÂ°123, LA PLATA_\\n\\nğŸ‘‡ *ESCRIBÃ TUS DATOS Y ENVIALOS*\"\n      },\n      action: {\n        buttons: [\n          { type: \"reply\", reply: { id: \"volver\", title: \"MENU PRINCIPAL\" }}\n        ]\n      }\n    }\n  },\n\n  info_general: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: phone,\n    type: \"interactive\",\n    interactive: {\n      type: \"list\",\n      header: { type: \"text\", text: \"ğŸ«€ INSTITUTO DE CARDIOLOGÃA LA PLATA\" },\n      body: {\n        text: \"ğŸ“‹ MENÃš PRINCIPAL\\n\\nPRESIONÃ 'ABRIR MENÃš' Y ELEGÃ UNA OPCIÃ“N:\\n\\nâ†’ ğŸ• HORARIOS DE ATENCIÃ“N\\nâ†’ ğŸ“ UBICACIÃ“N DE LA CLÃNICA\\nâ†’ ğŸ’» PORTAL DE PACIENTES\\nâ†’ ğŸ“§ SOLICITAR RECETAS\\nâ†’ ğŸ‘¨â€âš•ï¸ NUESTROS MÃ‰DICOS\\nâ†’ ğŸ©º ESPECIALIDADES MÃ‰DICAS\"\n      },\n      footer: { text: \"ğŸ“… LUN-VIE 8-20HS\" },\n      action: {\n        button: \"ABRIR MENÃš\",\n        sections: [{\n          title: \"ELEGÃ UNA OPCIÃ“N ğŸ‘‡\",\n          rows: [\n            { id: \"horarios\", title: \"ğŸ• HORARIOS\", description: \"â†’ HORARIOS DE ATENCIÃ“N\" },\n            { id: \"direccion\", title: \"ğŸ“ DIRECCIÃ“N\", description: \"â†’ UBICACIÃ“N ICLP\" },\n            { id: \"portal\", title: \"ğŸ’» PORTAL PACIENTES\", description: \"â†’ ACCESO AL PORTAL\" },\n            { id: \"recetas\", title: \"ğŸ“§ EMAIL RECETAS\", description: \"â†’ SOLICITAR RECETAS\" },\n            { id: \"medicos\", title: \"ğŸ‘¨â€âš•ï¸ MÃ‰DICOS\", description: \"â†’ VER ESPECIALISTAS\" },\n            { id: \"especialidades\", title: \"ğŸ©º ESPECIALIDADES\", description: \"â†’ LISTA COMPLETA\" },\n            { id: \"menu\", title: \"VOLVER AL MENU PRINCIPAL\", description: \"MENU PRINCIPAL\" }\n          ]\n        }]\n      }\n    }\n  },\n\n  administracion: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: phone,\n    type: \"interactive\",\n    interactive: {\n      type: \"button\",\n      header: { type: \"text\", text: \"ğŸ«€ INSTITUTO DE CARDIOLOGÃA LA PLATA\" },\n      body: {\n        text: \"ğŸ¢ ADMINISTRACIÃ“N\\n\\nTE CONECTAREMOS CON UNA RECEPCIONISTA PARA:\\n\\nâœ… REPROGRAMAR UN TURNO\\nâœ… CONSULTAS O RECLAMOS URGENTES\\nâœ… DERIVACIÃ“N URGENTE\\n\\nâ° HORARIO DE RESPUESTA:\\nLUNES A VIERNES: 8-20HS | SÃBADO 8-13HS\\n\\nğŸ’¡ SI NECESITÃS:\\n- AGENDAR TURNO NUEVO â†’ USÃ EL BOT\\n- CANCELAR TURNO â†’ USÃ EL BOT\\n- INFO GENERAL â†’ USÃ EL BOT\\n\\nğŸ“ OTRO MEDIO:\\n221 4906310\\n\\nÂ¿QUERÃ‰S CONTINUAR?\"\n      },\n      footer: { text: \"LUN-VIE 8-20HS\" },\n      action: {\n        buttons: [\n          { type: \"reply\", reply: { id: \"si\", title: \"SI, CONFIRMO\" }},\n          { type: \"reply\", reply: { id: \"volver\", title: \"MENU PRINCIPAL\" }}\n        ]\n      }\n    }\n  }\n};\n\nfunction generarMensaje(tipo, datos = {}) {\n  const template = templates[tipo];\n  if (!template) return templates.menu_principal;\n  \n  // Personalizar con datos si es necesario\n  if (tipo === 'confirmar_datos' && datos.nombre) {\n    return {\n      ...template,\n      interactive: {\n        ...template.interactive,\n        body: {\n          text: `*HOLA ${datos.nombre} âœ…*\\n\\n*ğŸ“‹ SUS DATOS EN NUESTRO SISTEMA:*\\n\\nğŸ‘¤ *NOMBRE:* ${datos.nombre}\\nğŸ†” *DNI:* ${datos.dni}\\nğŸ“ *TELÃ‰FONO:* ${datos.telefono}\\n\\nâœ… *SI LOS DATOS SON CORRECTOS, PRESIONE CONTINUAR*\\n\\nâš ï¸ *Â¿HAY ALGÃšN ERROR?*\\nCOMUNÃQUESE CON ADMINISTRACIÃ“N:\\nğŸ“ (0221) 490-6310`\n        }\n      }\n    };\n  }\n  \n  return template;\n}\n\n// ============================================================\n// ğŸ”„ MÃQUINA DE ESTADOS\n// ============================================================\n\nconst estadosConfig = {\n  \n  // ========== MENÃš PRINCIPAL ==========\n  'menu_principal': {\n    acciones: {\n      'ğŸ“… TURNOS': () => ({\n        siguiente: 'tipo_paciente',\n        respuesta: generarMensaje('tipo_paciente'),\n        accion: 'enviar_mensaje'\n      }),\n      'TURNOS': () => ({\n        siguiente: 'tipo_paciente',\n        respuesta: generarMensaje('tipo_paciente'),\n        accion: 'enviar_mensaje'\n      }),\n      'â„¹ï¸ INFO GENERAL': () => ({\n        siguiente: 'info_general',\n        respuesta: generarMensaje('info_general'),\n        accion: 'enviar_mensaje'\n      }),\n      'INFO GENERAL': () => ({\n        siguiente: 'info_general',\n        respuesta: generarMensaje('info_general'),\n        accion: 'enviar_mensaje'\n      }),\n      'ğŸ¢ ADMINISTRACION': () => ({\n        siguiente: 'admin_confirmacion',\n        respuesta: generarMensaje('administracion'),\n        accion: 'enviar_mensaje'\n      }),\n      'ADMINISTRACION': () => ({\n        siguiente: 'admin_confirmacion',\n        respuesta: generarMensaje('administracion'),\n        accion: 'enviar_mensaje'\n      }),\n      'default': () => ({\n        siguiente: 'menu_principal',\n        respuesta: generarMensaje('menu_principal'),\n        accion: 'enviar_mensaje'\n      })\n    }\n  },\n\n  // ========== TIPO DE PACIENTE ==========\n  'tipo_paciente': {\n    acciones: {\n      'NUEVO PACIENTE': () => ({\n        siguiente: 'recolectar_datos',\n        respuesta: generarMensaje('solicitar_datos_nuevos'),\n        accion: 'enviar_mensaje'\n      }),\n      'PACIENTE REGISTRADO': () => ({\n        siguiente: 'solicitar_dni',\n        respuesta: generarMensaje('solicitar_dni'),\n        accion: 'enviar_mensaje'\n      }),\n      'MENU PRINCIPAL': () => ({\n        siguiente: 'menu_principal',\n        respuesta: generarMensaje('menu_principal'),\n        accion: 'enviar_mensaje'\n      }),\n      'default': () => ({\n        siguiente: 'tipo_paciente',\n        respuesta: generarMensaje('tipo_paciente'),\n        accion: 'enviar_mensaje'\n      })\n    }\n  },\n\n  // ========== SOLICITAR DNI ==========\n  'solicitar_dni': {\n    acciones: {\n      'validar_dni': (msg) => {\n        if (!esDNI(msg)) {\n          sesion.intentos++;\n          if (sesion.intentos > 2) {\n            return {\n              siguiente: 'menu_principal',\n              respuesta: generarMensaje('menu_principal'),\n              accion: 'enviar_mensaje',\n              limpiar: true\n            };\n          }\n          return {\n            siguiente: 'solicitar_dni',\n            respuesta: generarMensaje('dni_invalido'),\n            accion: 'enviar_mensaje'\n          };\n        }\n        \n        // Guardar DNI y pedir validaciÃ³n externa\n        sesion.contexto.dni = msg.trim();\n        return {\n          siguiente: 'validando_dni',\n          respuesta: null,\n          accion: 'buscar_paciente',\n          datos: { dni: msg.trim(), telefono: phone }\n        };\n      },\n      'MENU PRINCIPAL': () => ({\n        siguiente: 'menu_principal',\n        respuesta: generarMensaje('menu_principal'),\n        accion: 'enviar_mensaje',\n        limpiar: true\n      }),\n      'default': (msg) => {\n        return estadosConfig['solicitar_dni'].acciones.validar_dni(msg);\n      }\n    }\n  },\n\n  // ========== VALIDANDO DNI (Estado intermedio) ==========\n  'validando_dni': {\n    // Este estado se resuelve en el subflujo Get_Paciente\n    // No tiene acciones directas del usuario\n  },\n\n  // ========== CONFIRMAR DATOS PACIENTE ==========\n  'confirmar_datos': {\n    acciones: {\n      'CONTINUAR': () => ({\n        siguiente: 'gestion_turnos',\n        respuesta: generarMensaje('gestion_turnos'),\n        accion: 'enviar_mensaje'\n      }),\n      'MENU PRINCIPAL': () => ({\n        siguiente: 'menu_principal',\n        respuesta: generarMensaje('menu_principal'),\n        accion: 'enviar_mensaje',\n        limpiar: true\n      })\n    }\n  },\n\n  // ========== GESTIÃ“N DE TURNOS ==========\n  'gestion_turnos': {\n    acciones: {\n      'TOMAR TURNO': () => ({\n        siguiente: 'tipo_turno',\n        respuesta: generarMensaje('tipo_turno'),\n        accion: 'enviar_mensaje'\n      }),\n      'CANCELAR TURNO': () => ({\n        siguiente: 'cancelar_turno',\n        respuesta: null,\n        accion: 'listar_turnos_cancelar'\n      }),\n      'MIS TURNO/S': () => ({\n        siguiente: 'mis_turnos',\n        respuesta: null,\n        accion: 'listar_mis_turnos'\n      }),\n      'default': () => ({\n        siguiente: 'gestion_turnos',\n        respuesta: generarMensaje('gestion_turnos'),\n        accion: 'enviar_mensaje'\n      })\n    }\n  },\n\n  // ========== TIPO DE TURNO ==========\n  'tipo_turno': {\n    acciones: {\n      'TURNOS CONSULTORIO': () => ({\n        siguiente: 'seleccionar_especialidad',\n        respuesta: null,\n        accion: 'listar_especialidades'\n      }),\n      'TURNOS ESTUDIO': () => ({\n        siguiente: 'admin_confirmacion',\n        respuesta: generarMensaje('administracion'),\n        accion: 'etiqueta_estudio'\n      }),\n      'MENU PRINCIPAL': () => ({\n        siguiente: 'menu_principal',\n        respuesta: generarMensaje('menu_principal'),\n        accion: 'enviar_mensaje',\n        limpiar: true\n      })\n    }\n  },\n\n  // ========== RECOLECTAR DATOS NUEVOS ==========\n  'recolectar_datos': {\n    acciones: {\n      'procesar_datos': (msg) => {\n        // AquÃ­ se procesan los datos con el AI Agent\n        return {\n          siguiente: 'procesando_datos',\n          respuesta: null,\n          accion: 'validar_datos_ai',\n          datos: { mensaje: msg }\n        };\n      },\n      'MENU PRINCIPAL': () => ({\n        siguiente: 'menu_principal',\n        respuesta: generarMensaje('menu_principal'),\n        accion: 'enviar_mensaje',\n        limpiar: true\n      }),\n      'default': (msg) => {\n        return estadosConfig['recolectar_datos'].acciones.procesar_datos(msg);\n      }\n    }\n  },\n\n  // ========== INFO GENERAL ==========\n  'info_general': {\n    acciones: {\n      'ğŸ• HORARIOS': () => ({\n        siguiente: 'info_general',\n        respuesta: {\n          messaging_product: \"whatsapp\",\n          recipient_type: \"individual\",\n          to: phone,\n          type: \"text\",\n          text: {\n            body: \"ğŸ•’ *HORARIO DE ATENCIÃ“N*\\n\\nğŸ“… *Nuestros horarios son:*\\nâ€¢ Lunes a Viernes: 08:00 - 20:00hs\\nâ€¢ SÃ¡bados: 08:00 - 13:00hs\\nâ€¢ Domingos: CERRADO\\n\\nğŸ“ *Contacto:*\\nTelÃ©fono: (0221) 4906310\\n\\nÂ¡Te esperamos! ğŸ’™\"\n          }\n        },\n        accion: 'enviar_mensaje'\n      }),\n      'HORARIOS': () => estadosConfig['info_general'].acciones['ğŸ• HORARIOS'](),\n      'ğŸ“ DIRECCIÃ“N': () => ({\n        siguiente: 'info_general',\n        respuesta: {\n          messaging_product: \"whatsapp\",\n          recipient_type: \"individual\",\n          to: phone,\n          type: \"text\",\n          text: {\n            preview_url: true,\n            body: \"ğŸ“ *UBICACIÃ“N*\\n\\nğŸ¥ *INSTITUTO DE CARDIOLOGÃA LA PLATA*\\n\\nğŸ“Œ *DirecciÃ³n:*\\nCalle 6 NÂ°212 (entre 36 y 37)\\nLa Plata, Buenos Aires\\n\\nğŸ—ºï¸ *Ver en Google Maps:*\\nhttps://maps.app.goo.gl/ij23zZscf3vTKQV56\\n\\nğŸ“ *TelÃ©fono:*\\n(0221) 4906310\\n\\nÂ¡Te esperamos! ğŸ’š\"\n          }\n        },\n        accion: 'enviar_mensaje'\n      }),\n      'DIRECCION': () => estadosConfig['info_general'].acciones['ğŸ“ DIRECCIÃ“N'](),\n      'MENU PRINCIPAL': () => ({\n        siguiente: 'menu_principal',\n        respuesta: generarMensaje('menu_principal'),\n        accion: 'enviar_mensaje'\n      }),\n      'default': () => ({\n        siguiente: 'info_general',\n        respuesta: generarMensaje('info_general'),\n        accion: 'enviar_mensaje'\n      })\n    }\n  },\n\n  // ========== ADMIN CONFIRMACIÃ“N ==========\n  'admin_confirmacion': {\n    acciones: {\n      'SI, CONFIRMO': () => ({\n        siguiente: 'menu_principal',\n        respuesta: generarMensaje('menu_principal'),\n        accion: 'activar_humano',\n        limpiar: true\n      }),\n      'MENU PRINCIPAL': () => ({\n        siguiente: 'menu_principal',\n        respuesta: generarMensaje('menu_principal'),\n        accion: 'enviar_mensaje',\n        limpiar: true\n      })\n    }\n  }\n};\n\n// ============================================================\n// âš™ï¸ PROCESADOR DE ESTADO\n// ============================================================\n\nasync function procesarEstado(estadoActual, mensaje) {\n  const msgNormalizado = normalizarMensaje(mensaje);\n  const config = estadosConfig[estadoActual];\n  \n  if (!config) {\n    return {\n      siguiente: 'menu_principal',\n      respuesta: generarMensaje('menu_principal'),\n      accion: 'enviar_mensaje',\n      limpiar: true\n    };\n  }\n\n  // Buscar acciÃ³n especÃ­fica\n  let accion = config.acciones[msgNormalizado] \n    || config.acciones[mensaje] \n    || config.acciones.default;\n  \n  if (!accion && config.acciones.procesar_datos) {\n    accion = config.acciones.procesar_datos;\n  }\n  \n  if (!accion && config.acciones.validar_dni) {\n    accion = config.acciones.validar_dni;\n  }\n  \n  if (!accion) {\n    return {\n      siguiente: estadoActual,\n      respuesta: { \n        messaging_product: \"whatsapp\",\n        recipient_type: \"individual\",\n        to: phone,\n        type: \"text\",\n        text: { body: \"â“ OpciÃ³n no vÃ¡lida. Por favor, seleccione una opciÃ³n del menÃº.\" }\n      },\n      accion: 'enviar_mensaje'\n    };\n  }\n\n  return await accion(mensaje);\n}\n\n// ============================================================\n// ğŸš€ EJECUCIÃ“N PRINCIPAL\n// ============================================================\n\nconst resultado = await procesarEstado(sesion.estado, mensaje);\n\n// Actualizar sesiÃ³n\nsesion.estado = resultado.siguiente;\nsesion.historial.push(resultado.siguiente);\nsesion.timestamp = Date.now();\n\nif (resultado.limpiar) {\n  sesion.contexto = {};\n  sesion.intentos = 0;\n}\n\nif (resultado.datos) {\n  sesion.contexto = { ...sesion.contexto, ...resultado.datos };\n}\n\n// ============================================================\n// ğŸ“¤ OUTPUT\n// ============================================================\n\nreturn [{\n  json: {\n    sesion: sesion,\n    respuesta: resultado.respuesta,\n    accion: resultado.accion || 'enviar_mensaje',\n    phone: phone,\n    conversationId: conversationId,\n    contexto: sesion.contexto\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-608,208],"id":"3459eb45-c1c0-45f7-8017-f5d7007f81d6","name":"ğŸ¤– Estado Handler"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"1","leftValue":"={{ $json.accion }}","rightValue":"enviar_mensaje","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Enviar Mensaje"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2","leftValue":"={{ $json.accion }}","rightValue":"buscar_paciente","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Buscar Paciente"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3","leftValue":"={{ $json.accion }}","rightValue":"listar_especialidades","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Listar Especialidades"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"4","leftValue":"={{ $json.accion }}","rightValue":"validar_datos_ai","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Validar con AI"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"5","leftValue":"={{ $json.accion }}","rightValue":"activar_humano","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Activar Humano"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-384,160],"id":"85fa29f6-a147-4ab1-86c0-1a8b614612d0","name":"ğŸ”€ Router Acciones"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify($json.respuesta) }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-160,-80],"id":"61894fb6-6e92-463b-bc78-c10609038de3","name":"ğŸ“¤ Enviar WhatsApp","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=session:{{ $json.phone }}","value":"={{ JSON.stringify($json.sesion) }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[64,-80],"id":"86251adf-81fe-47f6-9341-3d7d1d8672a4","name":"ğŸ’¾ Save Session","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"workflowId":{"__rl":true,"value":"oB7pjyME2Gvo5moH","mode":"list","cachedResultName":"SUB - GET_PACIENTE"},"workflowInputs":{"mappingMode":"defineBelow","value":{"dni":"={{ $json.contexto.dni }}","telefono":"={{ $json.phone }}"},"schema":[{"id":"dni","displayName":"dni","type":"string"},{"id":"telefono","displayName":"telefono","type":"string"}]},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-160,112],"id":"58ce5c52-afd7-48d0-98e5-7ba644926554","name":"ğŸ” Buscar Paciente"},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"mi8p2u7tvuplzt5","limit":9,"options":{}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[-160,304],"id":"1dd31432-436a-4313-a8c5-10a5371a8ceb","name":"ğŸ“‹ Listar Especialidades","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"workflowId":{"__rl":true,"value":"gsbUq8JFSpw8U7yR","mode":"list","cachedResultName":"Etiqueta_Consulta_Reclamo"},"workflowInputs":{"mappingMode":"defineBelow","value":{"humano":true,"accountId":2,"conversationId":"={{ $json.conversationId }}","contactId":"={{ $('ğŸ“‹ Extraer Datos').first().json.contactId }}","message":"={{ $('ğŸ“‹ Extraer Datos').first().json.message }}","inboxId":13,"chatwootUrlBase":"https://chatw.automatizaciones.ai","tokenChatwoot":"JFi43nzvEPDBCaxaFrkhVvdM","tipoIntencion":"consultas-reclamos"}},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-160,496],"id":"6c988151-ff21-403d-804c-df820f0a7db6","name":"ğŸ‘¤ Activar Humano"}],"connections":{"ğŸ”” Webhook Entrada":{"main":[[{"node":"ğŸ“‹ Extraer Datos","type":"main","index":0}]]},"ğŸ“‹ Extraer Datos":{"main":[[{"node":"ğŸ” Filtrar Mensajes","type":"main","index":0}]]},"ğŸ” Filtrar Mensajes":{"main":[[{"node":"ğŸ“¥ Get Session","type":"main","index":0}]]},"ğŸ“¥ Get Session":{"main":[[{"node":"ğŸ¤– Estado Handler","type":"main","index":0}]]},"ğŸ¤– Estado Handler":{"main":[[{"node":"ğŸ”€ Router Acciones","type":"main","index":0}]]},"ğŸ”€ Router Acciones":{"main":[[{"node":"ğŸ“¤ Enviar WhatsApp","type":"main","index":0}],[{"node":"ğŸ” Buscar Paciente","type":"main","index":0}],[{"node":"ğŸ“‹ Listar Especialidades","type":"main","index":0}],[],[{"node":"ğŸ‘¤ Activar Humano","type":"main","index":0}]]},"ğŸ“¤ Enviar WhatsApp":{"main":[[{"node":"ğŸ’¾ Save Session","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"bff77d27-bec8-49d6-8c11-7814aa568567","triggerCount":0,"shared":[{"createdAt":"2025-10-20T05:55:43.481Z","updatedAt":"2025-10-20T05:55:43.481Z","role":"workflow:owner","workflowId":"mhp1WkQm8lsNRsma","projectId":"R66ikVn5xqf0nYcA"}],"tags":[{"createdAt":"2025-10-18T05:48:24.047Z","updatedAt":"2025-10-18T05:48:24.047Z","id":"9MPkCQDvT4HFCUIK","name":"ClinicAI-v1.33"}]}