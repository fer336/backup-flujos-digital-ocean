{"createdAt":"2025-10-27T11:07:42.590Z","updatedAt":"2025-10-31T00:57:02.688Z","id":"o9rLeUkItUVZNKxd","name":"MASTER - ESTABLE","active":false,"isArchived":false,"nodes":[{"parameters":{"assignments":{"assignments":[{"id":"account-id","name":"accountId","value":"={{ $json.body.messages[0].account_id }}","type":"number"},{"id":"message","name":"message","value":"={{ $json.body.messages[0].content }}","type":"string"},{"id":"inbox-id","name":"inboxId","value":"={{ $json.body.contact_inbox.inbox_id }}","type":"number"},{"id":"contact-id","name":"contactId","value":"={{ $json.body.messages[0].sender.id }}","type":"number"},{"id":"contact-name","name":"contactName","value":"={{ $json.body.messages[0].sender.name }}","type":"string"},{"id":"contact-number","name":"contactNumber","value":"={{ $json.body.messages[0].sender.phone_number }}","type":"string"},{"id":"conversation-id","name":"conversationId","value":"={{ $json.body.id }}","type":"number"},{"id":"multimedia","name":"multimedia","value":"={{ $json?.body?.messages?.[0]?.attachments?.[0]?.file_type ? true : false }}","type":"boolean"},{"id":"humano","name":"humano","value":"={{ $json.body.custom_attributes.humano }}","type":"boolean"},{"id":"chatwoot-url","name":"chatwootUrl","value":"https://chatw.automatizaciones.ai","type":"string"},{"id":"token-bot","name":"agenteBotTokenWhatsapp","value":"JFi43nzvEPDBCaxaFrkhVvdM","type":"string"},{"id":"fcd30a41-417f-4ca5-8b22-7ee673628621","name":"rowId","value":"","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-5984,1392],"id":"7596049f-384c-405f-a023-a5b3af21edbf","name":"Variables"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.multimedia }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true},"id":"multimedia-check"}],"combinator":"and"},"renameOutput":true,"outputKey":"tieneMultimedia"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"humano-check","leftValue":"={{ $json.humano }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"tieneHumano"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"texto-check","leftValue":"={{ $json.message }}","rightValue":"Texto","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"tieneTexto"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-5456,1488],"id":"289db163-ad73-45ba-8772-13eaa0d2ee6f","name":"Filtro Tipo Mensaje"},{"parameters":{"operation":"get","propertyName":"status","key":"=status:{{ $('Filtro Tipo Mensaje').item.json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3744,1632],"id":"d9982974-aecf-48da-9655-8bd23351c40c","name":"üîç Get Estado Actual","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Variables').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"image\",\n      \"image\": {\n        \"link\": \"https://i.imgur.com/cSVuheF.png\"\n      }\n    },\n    \"body\": {\n      \"text\": \"üëã ¬°HOLA! BIENVENIDO AL ICLP\\n\\nü§ñ BOT: DISPONIBLE 24/7\\n\\nüìû ATENCI√ìN TELEF√ìNICA Y ADMINISTRATIVA:\\nLUNES A VIERNES 8-20HS | S√ÅBADO 8-13HS\\n\\nSELECCION√Å UNA OPCI√ìN:\\n\\nüìÖ TURNOS (BOT)\\n- AGENDAR, CONSULTAR O CANCELAR\\n\\n‚ÑπÔ∏è INFO GENERAL (BOT)\\n- HORARIOS, UBICACI√ìN Y M√ÅS\\n\\nüè¢ ADMINISTRACI√ìN (PERSONAL ADMINISTRATIVO)\\n* CONSULTAS Y RECLAMOS\\n* RESPUESTA EN HORARIO DE ATENCI√ìN\"\n    },\n    \"footer\": {\n      \"text\": \"SELECCION√Å UNA OPCI√ìN üëá\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"turnos\",\n            \"title\": \"üìÖ TURNOS\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"info-general\",\n            \"title\": \"‚ÑπÔ∏è INFO GENERAL\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"administracion\",\n            \"title\": \"üè¢ ADMINISTRACION\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-912,768],"id":"da09b176-d69d-430b-8a7a-af2f01859c97","name":"üì± Mensaje Menu Principal","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Variables').first().json.contactNumber }}","value":"={{ $('msg_clasificador').item.json.nuevoEstado }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-688,768],"id":"7a892253-ff0e-4b89-80cc-8db4c0e2dd08","name":"üíæ Set Estado MENU","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"// Router para gesti√≥n de turnos\nconst categoria = $('msg_clasificador').first().json.categoria;\nconst contactNumber = $('Variables').first().json.contactNumber;\n\n// Mapeo de acciones\nconst accion = {\n  categoria: categoria,\n  contactNumber: contactNumber,\n  // Determinar qu√© hacer\n  accion: null\n};\n\nswitch(categoria) {\n  case 'NUEVO_PACIENTE':\n    accion.accion = 'MOSTRAR_FORM_NUEVO_PACIENTE';\n    break;\n  case 'PACIENTE_REGISTRADO':\n    accion.accion = 'SOLICITAR_DNI';\n    break;\n  case 'INICIAR_TOMAR_TURNO':\n    accion.accion = 'MENU_TOMAR_TURNO';\n    break;\n  case 'INICIAR_CANCELAR_TURNO':\n    accion.accion = 'LISTAR_TURNOS_CANCELAR';\n    break;\n  case 'LISTAR_MIS_TURNOS':\n    accion.accion = 'MOSTRAR_MIS_TURNOS';\n    break;\n  default:\n    accion.accion = 'DESCONOCIDO';\n}\n\nreturn [{ json: accion }];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2752,816],"id":"1f5f04a1-44ea-4c74-b78c-c098538a7a00","name":"üé´ Router Gesti√≥n Turnos"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Variables').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"list\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ü´Ä INSTITUTO DE CARDIOLOG√çA LA PLATA\"\n    },\n    \"body\": {\n      \"text\": \"üìã MEN√ö PRINCIPAL\\n\\nPRESION√Å 'ABRIR MEN√ö' Y ELEG√ç UNA OPCI√ìN:\\n\\n‚Üí üïê HORARIOS DE ATENCI√ìN\\n\\n‚Üí üìç UBICACI√ìN DE LA CL√çNICA\\n\\n‚Üí üíª PORTAL DE PACIENTES\\n\\n‚Üí üìß SOLICITAR RECETAS\\n\\n‚Üí üë®‚Äç‚öïÔ∏è NUESTROS M√âDICOS\\n\\n‚Üí ü©∫ ESPECIALIDADES M√âDICAS\"\n    },\n    \"footer\": {\n      \"text\": \"üìÖ LUN-VIE 8-20HS\"\n    },\n    \"action\": {\n      \"button\": \"ABRIR MEN√ö\",\n      \"sections\": [\n        {\n          \"title\": \"ELEG√ç UNA OPCI√ìN üëá\",\n          \"rows\": [\n            {\n              \"id\": \"horarios\",\n              \"title\": \"üïê HORARIOS\",\n              \"description\": \"‚Üí HORARIOS DE ATENCI√ìN\"\n            },\n            {\n              \"id\": \"direccion\",\n              \"title\": \"üìç DIRECCI√ìN\",\n              \"description\": \"‚Üí UBICACI√ìN ICLP\"\n            },\n            {\n              \"id\": \"portal-paciente\",\n              \"title\": \"üíª PORTAL PACIENTES\",\n              \"description\": \"‚Üí ACCESO AL PORTAL\"\n            },\n            {\n              \"id\": \"email-recetas\",\n              \"title\": \"üìß EMAIL RECETAS\",\n              \"description\": \"‚Üí SOLICITAR RECETAS\"\n            },\n            {\n              \"id\": \"medicos\",\n              \"title\": \"üë®‚Äç‚öïÔ∏è M√âDICOS\",\n              \"description\": \"‚Üí VER ESPECIALISTAS\"\n            },\n            {\n              \"id\": \"especialidades\",\n              \"title\": \"ü©∫ ESPECIALIDADES\",\n              \"description\": \"‚Üí LISTA COMPLETA\"\n            },\n            {\n              \"id\": \"menu-principal\",\n              \"title\": \"VOLVER AL MENU PRINCIPAL\",\n              \"description\": \"MENU PRINCIPAL\"\n            }\n          ]\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-912,1216],"id":"20f387a8-d6db-42f9-b417-eb702bcb44c6","name":"üì± Mensaje Info General","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ü´Ä INSTITUTO DE CARDIOLOG√çA LA PLATA\"\n    },\n    \"body\": {\n      \"text\": \"üìã PARA SACAR UN TURNO, SELECCION√Å:\\n\\nüÜï NUEVO PACIENTE\\n‚Üí Si es tu primera vez\\n\\nüë§ PACIENTE REGISTRADO\\n‚Üí Si ya ten√©s historial con nosotros\\n\\nüè† MEN√ö PRINCIPAL\\n‚Üí Ver horarios, ubicaci√≥n y m√°s info\"\n    },\n    \"footer\": {\n      \"text\": \"LUN-VIE 8-20HS\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"primera-vez\",\n            \"title\": \"NUEVO PACIENTE\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"ya-atendido\",\n            \"title\": \"PACIENTE REGISTRADO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"volver-atras\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-912,992],"id":"4935f620-6583-4078-9337-e8954be818bc","name":"üìÖ Turnos - PACIENTE NUEVO - PACIENTE REGISTRADO - ","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Variables').first().json.contactNumber }}","value":"={{ $('msg_clasificador').item.json.nuevoEstado }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-688,992],"id":"14ef8e1a-a234-48b7-b0bf-c7e50934e5c0","name":"üíæ Set Estado MENU1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=status:{{ $('msg_clasificador').first().json.contactNumber }}","value":"={{ $('msg_clasificador').item.json.nuevoEstado }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3200,816],"id":"d9575b1a-b66f-4a2c-a19d-da84e6f380de","name":"‚è±Ô∏è STATUS PRIMERA VEZ","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"*üìù REGISTRO DE NUEVO PACIENTE*\\n\\n*AL SER TU PRIMERA VEZ, NECESITAMOS TUS DATOS:*\\n\\n‚Üí APELLIDO y NOMBRE\\n‚Üí DNI\\n‚Üí OBRA SOCIAL\\n‚Üí TEL√âFONO\\n‚Üí DOMICILIO\\n\\n*üìã FORMATO:*\\nENVI√Å TUS DATOS EN UN SOLO MENSAJE, AS√ç:\\n\\n_JUAN PEREZ_\\n_42028079_\\n_OSDE_\\n_2214567890_\\n_CALLE 50 N¬∞123, LA PLATA_\\n\\nüëá *ESCRIB√ç TUS DATOS Y ENVIALOS*\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"volver-atras\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2976,816],"id":"e5ca6a22-f16a-4bd1-97e5-7783df8754f1","name":"CREAR PACIENTE","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Variables').first().json.contactNumber }}","value":"={{ $('msg_clasificador').item.json.nuevoEstado }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-688,1216],"id":"eebb96c4-88bd-4870-b653-0ebb15d32e96","name":"üíæ Set Estado MENU2","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"// ============================================\n// PREPARADOR DE MENSAJES DE INFORMACI√ìN\n// ============================================\n// Prepara el body del HTTP Request seg√∫n la categor√≠a\n// ============================================\n\n// Obtener datos del nodo anterior\nconst categoria = $json.categoria;\nconst contactNumber = $json.contactNumber;\nconst mensaje = $json.mensaje || '';\n\n// Categor√≠as que requieren flujos especiales (no mensajes directos)\nconst FLUJOS_ESPECIALES = {\n  INFO_MEDICOS: 'medicos',\n  INFO_ESPECIALIDADES: 'especialidades'\n};\n\n// Mapeo de categor√≠as a mensajes directos\nconst MENSAJES = {\n  INFO_PORTAL: {\n    \"messaging_product\": \"whatsapp\",\n    \"recipient_type\": \"individual\",\n    \"to\": contactNumber,\n    \"type\": \"text\",\n    \"text\": {\n      \"preview_url\": true,\n      \"body\": \"üíª *PORTAL DEL PACIENTE*\\n\\nüåê *Acceso:*\\nwww.iclp.com.ar ‚Üí \\\"PORTAL PACIENTES\\\"\\n\\nüîê *Tus datos de acceso:*\\n‚Ä¢ Usuario: [TU DNI] (sin puntos)\\n‚Ä¢ Contrase√±a: p + √∫ltimos 5 n√∫meros del DNI\\n\\nüìù *Ejemplo:*\\nDNI 12345678 ‚Üí Contrase√±a: p45678\\n\\n¬øNecesit√°s ayuda? ¬°Contactanos! üíô\"\n    }\n  },\n  \n  INFO_DIRECCION: {\n    \"messaging_product\": \"whatsapp\",\n    \"recipient_type\": \"individual\",\n    \"to\": contactNumber,\n    \"type\": \"text\",\n    \"text\": {\n      \"preview_url\": true,\n      \"body\": \"üìç *UBICACI√ìN*\\n\\nüè• *INSTITUTO DE CARDIOLOG√çA LA PLATA*\\n\\nüìå *Direcci√≥n:*\\nCalle 6 N¬∞212 (entre 36 y 37)\\nLa Plata, Buenos Aires\\n\\nüó∫Ô∏è *Ver en Google Maps:*\\nhttps://maps.app.goo.gl/ij23zZscf3vTKQV56\\n\\nüìû *Tel√©fono:*\\n(0221) 4906310\\n\\n¬°Te esperamos! üíö\"\n    }\n  },\n  \n  INFO_RECETAS: {\n    \"messaging_product\": \"whatsapp\",\n    \"recipient_type\": \"individual\",\n    \"to\": contactNumber,\n    \"type\": \"text\",\n    \"text\": {\n      \"preview_url\": false,\n      \"body\": \"üíä *RECETAS M√âDICAS*\\n\\n‚ú® ¬°Te explico c√≥mo pedir tus recetas!\\n\\nüìß *MANERA M√ÅS F√ÅCIL - POR EMAIL*\\n‚úâÔ∏è Correo: recetas@iclpsrl.com.ar\\n\\nüìù *Envianos:*\\n‚Ä¢ Apellido y nombre\\n‚Ä¢ Obra social\\n‚Ä¢ N√∫mero de afiliado\\n‚Ä¢ Nombre del m√©dico\\n\\nüö® *ATENCI√ìN ESPECIAL - Dr. Fabi√°n Barba*\\nüì≤ Sus recetas solo por WhatsApp:\\n2216810260\\n\\n¬øNecesit√°s ayuda? ¬°Estamos para ayudarte! üíö\"\n    }\n  },\n  \n  INFO_HORARIOS: {\n    \"messaging_product\": \"whatsapp\",\n    \"recipient_type\": \"individual\",\n    \"to\": contactNumber,\n    \"type\": \"text\",\n    \"text\": {\n      \"preview_url\": false,\n      \"body\": \"üïí *HORARIO DE ATENCI√ìN*\\n\\nüìÖ *Nuestros horarios son:*\\n‚Ä¢ Lunes a Viernes: 08:00 - 20:00hs\\n‚Ä¢ S√°bados: 08:00 - 13:00hs\\n‚Ä¢ Domingos: CERRADO\\n\\nüìû *Contacto:*\\nTel√©fono: (0221) 4906310\\n\\n¬°Te esperamos! üíô\"\n    }\n  }\n};\n\n// ============================================\n// DETERMINAR TIPO DE FLUJO\n// ============================================\n\n// 1. Verificar si es un flujo especial (m√©dicos o especialidades)\nif (FLUJOS_ESPECIALES[categoria]) {\n  const tipoFlujo = FLUJOS_ESPECIALES[categoria];\n  \n  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n  console.log('üîÄ FLUJO ESPECIAL DETECTADO');\n  console.log('üéØ Categor√≠a:', categoria);\n  console.log('üìã Tipo de flujo:', tipoFlujo);\n  console.log('üì± Destinatario:', contactNumber);\n  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n  \n  return [{\n    json: {\n      tipoFlujo: tipoFlujo,           // \"medicos\" o \"especialidades\"\n      categoria: categoria,\n      contactNumber: contactNumber,\n      esFlujoDirecto: false           // Requiere procesamiento adicional\n    }\n  }];\n}\n\n// 2. Si tiene mensaje predefinido, usarlo\nif (MENSAJES[categoria]) {\n  const mensajeBody = MENSAJES[categoria];\n  \n  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n  console.log('üì§ MENSAJE DIRECTO');\n  console.log('üéØ Categor√≠a:', categoria);\n  console.log('üì± Destinatario:', contactNumber);\n  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n  \n  return [{\n    json: {\n      body: mensajeBody,\n      categoria: categoria,\n      contactNumber: contactNumber,\n      esFlujoDirecto: true,           // Mensaje listo para enviar\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\n// 3. Mensaje de texto simple (fallback)\nconst mensajeBody = {\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": contactNumber,\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": mensaje\n  }\n};\n\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\nconsole.log('üìù MENSAJE TEXTO SIMPLE');\nconsole.log('üéØ Categor√≠a:', categoria);\nconsole.log('üì± Destinatario:', contactNumber);\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n\nreturn [{\n  json: {\n    body: mensajeBody,\n    categoria: categoria,\n    contactNumber: contactNumber,\n    esFlujoDirecto: true,\n    timestamp: new Date().toISOString()\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1248,4416],"id":"782b59e3-26a3-4c12-bb49-914f42e910e5","name":"Code"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.body.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.body.recipient_type }}"},{"name":"to","value":"={{ $json.body.to }}"},{"name":"type","value":"={{ $json.body.type }}"},{"name":"text","value":"={{ $json.body.text }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-688,4784],"id":"0f6e74a9-4a89-41ea-aee8-011ce52f1ab4","name":"Medicos","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=status:{{ $('msg_clasificador').first().json.contactNumber }}","value":"={{ $('msg_clasificador').item.json.nuevoEstado }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-432,4784],"id":"1afb1bd9-13b6-4f90-994b-c88db9e4627b","name":"‚è±Ô∏è STATUS PRIMERA VEZ1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"status\": \"read\",\n  \"message_id\": \"{{ $('Entrada').item.json.body.messages[0].source_id }}\",\n  \"typing_indicator\": {\n    \"type\": \"text\"\n  }\n} ","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-464,1216],"id":"43151f87-8e7e-4c98-ae14-5afc3381c9d0","name":"HTTP Request1","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"status\": \"read\",\n  \"message_id\": \"{{ $('Entrada').item.json.body.messages[0].source_id }}\",\n  \"typing_indicator\": {\n    \"type\": \"text\"\n  }\n} ","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-464,768],"id":"846db83b-4d43-4c6a-b0c9-823a41e632d6","name":"HTTP Request2","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"status\": \"read\",\n  \"message_id\": \"{{ $('Entrada').item.json.body.messages[0].source_id }}\",\n  \"typing_indicator\": {\n    \"type\": \"text\"\n  }\n} ","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-464,992],"id":"00e82f22-b35b-493b-862e-341d5f86a16f","name":"HTTP Request3","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"status\": \"read\",\n  \"message_id\": \"{{ $('Entrada').first().json.body.messages[0].source_id }}\",\n  \"typing_indicator\": {\n    \"type\": \"text\"\n  }\n} ","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-4832,1456],"id":"a835035b-83c6-4b90-b390-d2fb60651711","name":"HTTP Request4","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"jsCode":"// ============================================\n// CLASIFICADOR DE MENSAJES - SISTEMA JER√ÅRQUICO\n// ============================================\n// Autor: Sistema de Gesti√≥n de Turnos ICLP\n// Versi√≥n: 2.0\n// ============================================\n\n// ============================================\n// 1. CONFIGURACI√ìN Y CONSTANTES\n// ============================================\n\nconst PATRONES = {\n  MENU: {\n    TURNOS: 'üìÖ TURNOS',\n    INFO: '‚ÑπÔ∏è INFO GENERAL',\n    ADMIN: 'üè¢ ADMINISTRACION',\n    VOLVER: 'MENU PRINCIPAL'\n  },\n  \n  TURNOS: {\n    NUEVO: 'NUEVO PACIENTE',\n    REGISTRADO: 'PACIENTE REGISTRADO',\n    TOMAR: 'TOMAR TURNO',\n    CANCELAR: 'CANCELAR TURNO',\n    MIS_TURNOS: 'MIS TURNO/S'\n  },\n  \n  TIPOS: {\n    CONSULTORIO: 'TURNOS CONSULTORIO',\n    ESTUDIO: 'TURNOS ESTUDIO'\n  },\n  \n  INFO: {\n    HORARIOS: 'üïê HORARIOS',\n    DIRECCION: 'üìç DIRECCI√ìN',\n    PORTAL: 'üíª PORTAL PACIENTES',\n    RECETAS: 'üìß EMAIL RECETAS',\n    MEDICOS: 'üë®‚Äç‚öïÔ∏è M√âDICOS',\n    ESPECIALIDADES: 'ü©∫ ESPECIALIDADES'\n  },\n  \n  ACCION: {\n    CONTINUAR: ['CONTINUAR', 'SI, CONFIRMO', 'S√ç, CONFIRMO', 'CONFIRMAR TURNO'],\n    VOLVER: ['VOLVER ATRAS', 'VOLVER ATR√ÅS', 'MENU PRINCIPAL', 'VOLVER AL MENU PRINCIPAL', '‚¨ÖÔ∏è VOLVER ATRAS']\n  }\n};\n\n\n// ============================================\n// 2. UTILIDADES - VALIDACI√ìN DE FORMATOS\n// ============================================\n\n/**\n * Valida si el texto es una selecci√≥n de lista (formato: TEXTO-COD o TEXTO-123)\n * @param {string} texto - Texto a validar\n * @returns {boolean}\n */\nfunction esSeleccionLista(texto) {\n  // Acepta formatos: CARDIOLOG√çA-CAR, NEUROLOG√çA-123, etc.\n  return /^[A-Z√Ä-√ö√ë\\s]+-[A-Z0-9]+$/i.test(texto);\n}\n\n/**\n * Valida si el texto es una selecci√≥n de horario (formato: MI√â 22/10 - 15:40)\n * @param {string} texto - Texto a validar\n * @returns {boolean}\n */\nfunction esSeleccionHorario(texto) {\n  return /^[A-Z√â]{3}\\s\\d{1,2}\\/\\d{1,2}\\s-\\s\\d{2}:\\d{2}$/.test(texto);\n}\n\n/**\n * Extrae el DNI de un texto, ignorando palabras y caracteres adicionales\n * @param {string} texto - Texto que puede contener un DNI\n * @returns {string|null} - DNI encontrado o null\n */\nfunction extraerDNI(texto) {\n  // Convertir a string\n  const textoStr = texto.toString().trim();\n  \n  // Remover TODOS los caracteres que no sean d√≠gitos\n  const soloDigitos = textoStr.replace(/\\D/g, '');\n  \n  // Buscar secuencia de 7-8 d√≠gitos consecutivos\n  const patron = /\\d{7,8}/;\n  const match = soloDigitos.match(patron);\n  \n  if (!match) return null;\n  \n  // Retornar los primeros 7-8 d√≠gitos encontrados\n  const dni = match[0];\n  \n  // Si tiene m√°s de 8 d√≠gitos, tomar solo los primeros 8\n  return dni.length > 8 ? dni.substring(0, 8) : dni;\n}\n\n/**\n * Valida si el texto contiene un DNI v√°lido (7-8 d√≠gitos)\n * @param {string} texto - Texto a validar\n * @returns {boolean}\n */\nfunction esDNI(texto) {\n  return extraerDNI(texto) !== null;\n}\n\n/**\n * Valida si el texto es un identificador de turno para cancelar\n * @param {string} texto - Texto a validar\n * @returns {boolean}\n */\nfunction esTurnoParaCancelar(texto) {\n  return /^[A-Z]+-\\d{2}-\\d{2}-\\d{4}(-\\d+)?/.test(texto) || \n         /^turno-\\d{8}-\\d{4}-\\d+/.test(texto);\n}\n\n/**\n * Verifica si el paciente est√° registrado en el sistema\n * Obtiene los datos del nodo 'PACIENTE EXISTE?' y verifica el campo 'PACIENTE REGISTRADO'\n * @returns {boolean} true si el paciente est√° registrado, false si no\n */\nfunction esPacienteRegistrado() {\n  try {\n    // Intentar obtener datos del nodo 'PACIENTE EXISTE?'\n    const pacienteData = $('PACIENTE EXISTE?').first().json['PACIENTE REGISTRADO'];\n    \n    // Si es null o undefined ‚Üí paciente NO registrado\n    if (pacienteData === null || pacienteData === undefined) {\n      console.log('‚ùå Paciente NO registrado (campo null/undefined)');\n      return false;\n    }\n    \n    // Si tiene alg√∫n valor ‚Üí paciente registrado\n    console.log('‚úÖ Paciente registrado detectado:', JSON.stringify(pacienteData));\n    return true;\n    \n  } catch (error) {\n    // Si el nodo no existe o hay error, asumir que no est√° registrado\n    console.log('‚ö†Ô∏è No se pudo verificar paciente (nodo no existe o error):', error.message);\n    return false;\n  }\n}\n\n// ============================================\n// 3. GESTI√ìN DE ESTADOS\n// ============================================\n\n/**\n * Normaliza el estado al formato jer√°rquico\n * @param {string} estado - Estado a normalizar\n * @returns {string} Estado normalizado\n */\nfunction normalizarEstado(estado) {\n  // Sin estado\n  if (!estado || estado === '') return '';\n  \n  // Ya est√° normalizado (formato: SECCION:SUBSECCION)\n  if (estado.includes(':')) return estado;\n  \n  // Estados con DNI (formato especial: DNI:12345678)\n  if (estado.startsWith('DNI:')) {\n    const dni = estado.replace('DNI:', '');\n    return `DATOS:DNI_VALIDADO:${dni}`;\n  }\n  \n  // Retornar el estado tal cual si no requiere normalizaci√≥n\n  return estado;\n}\n\n/**\n * Extrae el contexto del estado jer√°rquico\n * @param {string} estado - Estado en formato jer√°rquico\n * @returns {object} Contexto con secci√≥n, subsecci√≥n y datos\n */\nfunction obtenerContexto(estado) {\n  if (!estado) {\n    return { seccion: null, subseccion: null, datos: null };\n  }\n  \n  const partes = estado.split(':');\n  return {\n    seccion: partes[0] || null,\n    subseccion: partes[1] || null,\n    datos: partes[2] || null\n  };\n}\n\n// ============================================\n// 4. REGLAS DE CLASIFICACI√ìN\n// ============================================\n\n/**\n * Reglas para el men√∫ principal\n */\nfunction clasificarMenuPrincipal(mensaje, estado) {\n  // Verificar que estamos en el men√∫ principal\n  if (estado !== 'MENU_PRINCIPAL' && estado !== 'MENU_INICIAL') {\n    console.log('‚è≠Ô∏è clasificarMenuPrincipal: Estado no es MENU_PRINCIPAL, saltando...');\n    return null;\n  }\n  \n  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n  console.log('üîç clasificarMenuPrincipal()');\n  console.log('üì© Mensaje:', JSON.stringify(mensaje));\n  console.log('üè∑Ô∏è  Estado:', estado);\n  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n  \n  // TURNOS - Detectar con o sin emoji (m√°s robusto)\n  console.log('üîé Verificando TURNOS...');\n  console.log('   mensaje === PATRONES.MENU.TURNOS:', mensaje === PATRONES.MENU.TURNOS);\n  console.log('   mensaje.includes(\"TURNOS\"):', mensaje.includes('TURNOS'));\n  console.log('   mensaje === \"üé´ TURNOS\":', mensaje === 'üé´ TURNOS');\n  \n  if (mensaje === PATRONES.MENU.TURNOS || mensaje.includes('TURNOS') || mensaje === 'üé´ TURNOS') {\n    console.log('‚úÖ Detectado bot√≥n TURNOS - Navegando a gesti√≥n de turnos');\n    return { categoria: 'NAV_TURNOS', nuevoEstado: 'TURNOS:TIPO_PACIENTE' };\n  }\n  \n  // INFO GENERAL - Detectar con o sin emoji\n  if (mensaje === PATRONES.MENU.INFO || mensaje.includes('INFO GENERAL')) {\n    console.log('‚úÖ Detectado bot√≥n INFO GENERAL');\n    return { categoria: 'NAV_INFO', nuevoEstado: 'INFO:MENU' };\n  }\n  \n  // ADMINISTRACI√ìN - Detectar con o sin emoji\n  if (mensaje === PATRONES.MENU.ADMIN || mensaje.includes('ADMINISTRACION')) {\n    console.log('‚úÖ Detectado bot√≥n ADMINISTRACI√ìN');\n    return { categoria: 'NAV_ADMIN', nuevoEstado: 'ADMIN:CONFIRMAR' };\n  }\n  \n  // DNI directo\n  if (esDNI(mensaje)) {\n    console.log('‚úÖ Detectado DNI directo');\n    return { \n      categoria: 'INGRESO_DNI', \n      nuevoEstado: `DATOS:DNI_VALIDADO:${mensaje}` \n    };\n  }\n  \n  console.log('‚ùå No se detect√≥ ninguna opci√≥n del men√∫ principal');\n  return null;\n}\n\n/**\n * Reglas para gesti√≥n de turnos\n */\nfunction clasificarGestionTurnos(mensaje, estado, ctx) {\n  // Tipo de paciente\n  if (estado === 'TURNOS:TIPO_PACIENTE') {\n    if (mensaje === PATRONES.TURNOS.NUEVO) {\n      return { categoria: 'NUEVO_PACIENTE', nuevoEstado: 'DATOS:RECOLECCION' };\n    }\n    if (mensaje === PATRONES.TURNOS.REGISTRADO) {\n      return { categoria: 'PACIENTE_REGISTRADO', nuevoEstado: 'DATOS:SOLICITAR_DNI' };\n    }\n  }\n  \n  // Usuario con DNI validado\n  if (ctx.seccion === 'DATOS' && ctx.subseccion === 'DNI_VALIDADO') {\n    const dni = ctx.datos;\n    \n    // Usuario confirma sus datos despu√©s de validar DNI\n    if (PATRONES.ACCION.CONTINUAR.includes(mensaje)) {\n      return { \n        categoria: 'CONFIRMAR_DATOS_DNI', \n        nuevoEstado: 'TURNOS:TIPO_TURNO', \n        metadata: { dni } \n      };\n    }\n    \n    if (mensaje === PATRONES.TURNOS.TOMAR) {\n      return { \n        categoria: 'INICIAR_TOMAR_TURNO', \n        nuevoEstado: 'TURNOS:TIPO_TURNO', \n        metadata: { dni } \n      };\n    }\n    \n    if (mensaje === PATRONES.TURNOS.CANCELAR) {\n      return { \n        categoria: 'INICIAR_CANCELAR_TURNO', \n        nuevoEstado: 'CANCELAR:LISTAR', \n        metadata: { dni } \n      };\n    }\n    \n    if (mensaje === PATRONES.TURNOS.MIS_TURNOS) {\n      return { \n        categoria: 'LISTAR_MIS_TURNOS', \n        nuevoEstado: estado, \n        metadata: { dni } \n      };\n    }\n  }\n  \n  // Tipo de turno\n  if (estado === 'TURNOS:TIPO_TURNO') {\n    if (mensaje === PATRONES.TIPOS.CONSULTORIO) {\n      return { categoria: 'TURNO_CONSULTORIO', nuevoEstado: 'TURNOS:ESPECIALIDADES' };\n    }\n    if (mensaje === PATRONES.TIPOS.ESTUDIO) {\n      return { categoria: 'TURNO_ESTUDIO', nuevoEstado: 'TURNOS:ESPECIALIDADES_ESTUDIO' };\n    }\n  }\n  \n  // MEN√ö GESTI√ìN DE TURNOS (despu√©s de confirmar DNI)\n  if (estado === 'MENU:GESTION_TURNOS') {\n    if (mensaje === PATRONES.TURNOS.TOMAR) {\n      return { \n        categoria: 'TOMAR_TURNO', \n        nuevoEstado: 'TURNOS:ESPECIALIDADES'\n      };\n    }\n    if (mensaje === PATRONES.TURNOS.CANCELAR) {\n      return { \n        categoria: 'CANCELAR_TURNO', \n        nuevoEstado: 'CANCELAR:LISTAR'\n      };\n    }\n    if (mensaje === PATRONES.TURNOS.MIS_TURNOS) {\n      return { \n        categoria: 'MIS_TURNOS', \n        nuevoEstado: 'TURNOS:MIS_TURNOS'\n      };\n    }\n  }\n  \n  return null;\n}\n\n/**\n * Reglas para selecciones (especialidad, m√©dico, horario)\n */\nfunction clasificarSelecciones(mensaje, estado) {\n  // Bot√≥n ELEGIR OTRO M√âDICO (cuando no hay turnos disponibles)\n  const esBotonElegirOtroMedico = mensaje === 'ELEGIR OTRO M√âDICO' ||\n                                   mensaje === 'üë®‚Äç‚öïÔ∏è ELEGIR OTRO M√âDICO' ||\n                                   mensaje.includes('ELEGIR OTRO M√âDICO') ||\n                                   mensaje.toLowerCase().includes('elegir otro m√©dico') ||\n                                   mensaje.toLowerCase().includes('elegir otro medico');\n  \n  if (estado === 'TURNOS:SIN_HORARIOS' && esBotonElegirOtroMedico) {\n    console.log('‚úÖ Detectado bot√≥n ELEGIR OTRO M√âDICO - Volviendo a lista de m√©dicos');\n    console.log('üì© Mensaje recibido:', mensaje);\n    return { \n      categoria: 'VOLVER_MEDICOS', \n      nuevoEstado: 'TURNOS:MEDICOS'  // Volver a la lista de m√©dicos\n    };\n  }\n  \n  // Bot√≥n VER M√ÅS ESPECIALIDADES (Chatwoot env√≠a el title)\n  if (estado === 'TURNOS:ESPECIALIDADES' && mensaje === '‚ûï VER M√ÅS ESPECIALIDADES') {\n    return { \n      categoria: 'VER_MAS_ESPECIALIDADES', \n      nuevoEstado: 'TURNOS:ESPECIALIDADES:VER_MAS'\n    };\n  }\n  \n  // Bot√≥n VER ANTERIORES (desde segundo bloque)\n  const esBotonVolver = mensaje === '‚¨ÖÔ∏è VER ANTERIORES' || \n                        mensaje === 'VER ANTERIORES' ||\n                        mensaje.includes('VER ANTERIORES') ||\n                        mensaje.toLowerCase().includes('ver anteriores');\n  \n  if (estado === 'TURNOS:ESPECIALIDADES:VER_MAS' && esBotonVolver) {\n    console.log('‚úÖ Detectado bot√≥n VER ANTERIORES - Volviendo al primer bloque');\n    console.log('üì© Mensaje recibido:', mensaje);\n    return { \n      categoria: 'TURNO_CONSULTORIO', \n      nuevoEstado: 'TURNOS:ESPECIALIDADES'\n    };\n  }\n  \n  // Especialidad (primer bloque)\n  if (estado === 'TURNOS:ESPECIALIDADES' && esSeleccionLista(mensaje)) {\n    console.log('‚úÖ Especialidad seleccionada (primer bloque):', mensaje);\n    // Extraer c√≥digo de especialidad (ejemplo: CARDIOLOG√çA-CAR ‚Üí CAR)\n    const codigoEspecialidad = mensaje.split('-').pop();\n    return { \n      categoria: 'SELECCION_ESPECIALIDAD', \n      nuevoEstado: 'TURNOS:MEDICOS', \n      metadata: { \n        especialidad: mensaje,\n        codigoEspecialidad: codigoEspecialidad\n      } \n    };\n  }\n  \n  // Especialidad (segundo bloque - VER M√ÅS)\n  if (estado === 'TURNOS:ESPECIALIDADES:VER_MAS' && esSeleccionLista(mensaje)) {\n    console.log('‚úÖ Especialidad seleccionada (segundo bloque):', mensaje);\n    // Extraer c√≥digo de especialidad (ejemplo: CARDIOLOG√çA-CAR ‚Üí CAR)\n    const codigoEspecialidad = mensaje.split('-').pop();\n    return { \n      categoria: 'SELECCION_ESPECIALIDAD', \n      nuevoEstado: 'TURNOS:MEDICOS', \n      metadata: { \n        especialidad: mensaje,\n        codigoEspecialidad: codigoEspecialidad\n      } \n    };\n  }\n  \n  // ============================================\n  // üìÑ PAGINACI√ìN DE M√âDICOS\n  // ============================================\n  \n  // Funci√≥n para extraer n√∫mero de p√°gina del t√≠tulo del bot√≥n\n  function extraerNumeroPagina(mensaje) {\n    // Buscar patr√≥n (N) donde N es un n√∫mero\n    const match = mensaje.match(/\\((\\d+)\\)/);\n    if (match) {\n      return parseInt(match[1]);\n    }\n    return null;\n  }\n  \n  // Bot√≥n: ‚ûï VER M√ÅS (N) - ir a p√°gina N\n  if (estado === 'TURNOS:MEDICOS' && mensaje.includes('VER M√ÅS')) {\n    const paginaDestino = extraerNumeroPagina(mensaje);\n    \n    if (paginaDestino) {\n      console.log(`üìÑ VER M√ÅS - Navegando a p√°gina ${paginaDestino}`);\n      \n      const metadata = {\n        paginaMedicos: paginaDestino\n      };\n      \n      // Preservar c√≥digo de especialidad y especialidad\n      if (globalThis._metadataPrevio?.codigoEspecialidad) {\n        metadata.codigoEspecialidad = globalThis._metadataPrevio.codigoEspecialidad;\n      }\n      if (globalThis._metadataPrevio?.especialidadSeleccionada) {\n        metadata.especialidad = globalThis._metadataPrevio.especialidadSeleccionada;\n      }\n      if (globalThis._metadataPrevio?.especialidad) {\n        metadata.especialidad = globalThis._metadataPrevio.especialidad;\n      }\n      \n      console.log('üì¶ Metadata actualizado:', JSON.stringify(metadata));\n      \n      return { \n        categoria: 'SELECCION_ESPECIALIDAD', \n        nuevoEstado: 'TURNOS:MEDICOS',\n        metadata: metadata\n      };\n    }\n  }\n  \n  // Bot√≥n: ‚¨ÖÔ∏è ANTERIORES (N) - ir a p√°gina N\n  if (estado === 'TURNOS:MEDICOS' && mensaje.includes('ANTERIORES')) {\n    const paginaDestino = extraerNumeroPagina(mensaje);\n    \n    if (paginaDestino) {\n      console.log(`üìÑ ANTERIORES - Navegando a p√°gina ${paginaDestino}`);\n      \n      const metadata = {\n        paginaMedicos: paginaDestino\n      };\n      \n      // Preservar c√≥digo de especialidad y especialidad\n      if (globalThis._metadataPrevio?.codigoEspecialidad) {\n        metadata.codigoEspecialidad = globalThis._metadataPrevio.codigoEspecialidad;\n      }\n      if (globalThis._metadataPrevio?.especialidadSeleccionada) {\n        metadata.especialidad = globalThis._metadataPrevio.especialidadSeleccionada;\n      }\n      if (globalThis._metadataPrevio?.especialidad) {\n        metadata.especialidad = globalThis._metadataPrevio.especialidad;\n      }\n      \n      console.log('üì¶ Metadata actualizado:', JSON.stringify(metadata));\n      \n      return { \n        categoria: 'SELECCION_ESPECIALIDAD', \n        nuevoEstado: 'TURNOS:MEDICOS',\n        metadata: metadata\n      };\n    }\n  }\n  \n  // Bot√≥n: ‚¨ÖÔ∏è INICIO - regresar a p√°gina 1\n  if (estado === 'TURNOS:MEDICOS' && (mensaje === '‚¨ÖÔ∏è INICIO' || mensaje === 'INICIO' || mensaje.includes('INICIO'))) {\n    console.log('üìÑ INICIO - Regresando a p√°gina 1');\n    \n    const metadata = {\n      paginaMedicos: 1\n    };\n    \n    // Preservar c√≥digo de especialidad y especialidad\n    if (globalThis._metadataPrevio?.codigoEspecialidad) {\n      metadata.codigoEspecialidad = globalThis._metadataPrevio.codigoEspecialidad;\n    }\n    if (globalThis._metadataPrevio?.especialidadSeleccionada) {\n      metadata.especialidad = globalThis._metadataPrevio.especialidadSeleccionada;\n    }\n    if (globalThis._metadataPrevio?.especialidad) {\n      metadata.especialidad = globalThis._metadataPrevio.especialidad;\n    }\n    \n    console.log('üì¶ Metadata actualizado:', JSON.stringify(metadata));\n    \n    return { \n      categoria: 'SELECCION_ESPECIALIDAD', \n      nuevoEstado: 'TURNOS:MEDICOS',\n      metadata: metadata\n    };\n  }\n  \n  // M√©dico seleccionado (cualquier p√°gina)\n  if (estado === 'TURNOS:MEDICOS' && esSeleccionLista(mensaje)) {\n    console.log('‚úÖ M√©dico seleccionado:', mensaje);\n    // Extraer matr√≠cula (ejemplo: PONCE VENA-112196 ‚Üí 112196)\n    const matricula = mensaje.split('-').pop().trim();\n    console.log('üî¢ Matr√≠cula extra√≠da:', matricula);\n    \n    return { \n      categoria: 'SELECCION_MEDICO', \n      nuevoEstado: 'TURNOS:HORARIOS', \n      metadata: { \n        medico: mensaje,\n        matricula: matricula,\n        paginaMedicos: 1 // Resetear p√°gina cuando se selecciona m√©dico\n      } \n    };\n  }\n  \n  // Horario\n  if (estado === 'TURNOS:HORARIOS' && esSeleccionHorario(mensaje)) {\n    return { \n      categoria: 'SELECCION_HORARIO', \n      nuevoEstado: 'TURNOS:CONFIRMAR', \n      metadata: { horario: mensaje } \n    };\n  }\n  \n  // Confirmar turno - Directamente ejecutar POST\n  if (estado === 'TURNOS:CONFIRMAR' && PATRONES.ACCION.CONTINUAR.includes(mensaje)) {\n    console.log('‚úÖ Confirmaci√≥n de turno detectada - Ejecutando POST');\n    return { \n      categoria: 'EJECUTAR_POST_TURNO',  // ‚¨ÖÔ∏è CAMBIO DIRECTO\n      nuevoEstado: 'MENU_PRINCIPAL' \n    };\n  }\n  \n  return null;\n}\n\n/**\n * Reglas para recolecci√≥n de datos\n */\nfunction clasificarDatos(mensaje, estado) {\n  // Solicitar DNI - Usuario ingresa DNI para validaci√≥n (primera vez)\n  if (estado === 'DATOS:SOLICITAR_DNI') {\n    const dniExtraido = extraerDNI(mensaje);\n    if (dniExtraido) {\n      console.log('‚úÖ DNI extra√≠do:', dniExtraido, 'del mensaje:', mensaje);\n      return { \n        categoria: 'VALIDAR_DNI', \n        nuevoEstado: `DATOS:DNI_VALIDADO:${dniExtraido}`,\n        metadata: { dni: dniExtraido }\n      };\n    }\n  }\n  \n  // DNI no encontrado (0) - Usuario reintenta con otro DNI\n  if (estado === 'DATOS:DNI_VALIDADO:0') {\n    const dniExtraido = extraerDNI(mensaje);\n    if (dniExtraido) {\n      console.log('üîÑ Reintentando validaci√≥n de DNI:', dniExtraido);\n      return { \n        categoria: 'VALIDAR_DNI', \n        nuevoEstado: `DATOS:DNI_VALIDADO:${dniExtraido}`,\n        metadata: { dni: dniExtraido }\n      };\n    }\n  }\n  \n  // Recolecci√≥n inicial de datos\n  if (estado === 'DATOS:RECOLECCION') {\n  if (!PATRONES.ACCION.VOLVER.includes(mensaje) && mensaje !== 'CONTINUAR') {\n      return { categoria: 'INGRESO_DATOS_PACIENTE', nuevoEstado: 'DATOS:RECOLECTADOS' };\n    }\n  }\n  \n  // Datos ya recolectados, esperando confirmaci√≥n\n  if (estado === 'DATOS:RECOLECTADOS') {\n  if (PATRONES.ACCION.CONTINUAR.includes(mensaje)) {\n    return { categoria: 'CONFIRMAR_PACIENTE_NUEVO', nuevoEstado: 'DATOS:PACIENTE_NUEVO' };\n    }\n  }\n  \n  return null;\n}\n\n/**\n * Reglas para cancelaci√≥n de turnos\n */\nfunction clasificarCancelacion(mensaje, estado) {\n  // Usuario confirma que quiere eliminar el turno\n  if (estado === 'CANCELAR-TURNO' || estado === 'CANCELAR:TURNO') {\n    console.log('‚úÖ Detectado estado CANCELAR-TURNO - Ejecutando eliminaci√≥n');\n    return { \n      categoria: 'ELIMINAR_TURNO', \n      nuevoEstado: 'MENU_PRINCIPAL' \n    };\n  }\n  \n  // Usuario selecciona un turno de la lista para cancelar\n  if (estado === 'CANCELAR:LISTAR' && esTurnoParaCancelar(mensaje)) {\n    return { \n      categoria: 'EJECUTAR_CANCELACION_TURNO', \n      nuevoEstado: 'CANCELAR-TURNO',  // Cambiar al estado de confirmaci√≥n\n      metadata: { turno_id: mensaje } \n    };\n  }\n  \n  return null;\n}\n\n/**\n * Reglas para informaci√≥n general\n */\nfunction clasificarInformacion(mensaje, estado) {\n  const infoMap = {\n    [PATRONES.INFO.HORARIOS]: 'INFO_HORARIOS',\n    [PATRONES.INFO.DIRECCION]: 'INFO_DIRECCION',\n    [PATRONES.INFO.PORTAL]: 'INFO_PORTAL',\n    [PATRONES.INFO.RECETAS]: 'INFO_RECETAS',\n    [PATRONES.INFO.MEDICOS]: 'INFO_MEDICOS',\n    [PATRONES.INFO.ESPECIALIDADES]: 'INFO_ESPECIALIDADES'\n  };\n  \n  if (infoMap[mensaje]) {\n    return { categoria: infoMap[mensaje], nuevoEstado: estado };\n  }\n  \n  return null;\n}\n\n/**\n * Reglas para navegaci√≥n hacia atr√°s\n */\nfunction clasificarVolverAtras(mensaje, estado) {\n  if (!PATRONES.ACCION.VOLVER.includes(mensaje)) return null;\n  \n  const navegacionAtras = {\n    'TURNOS:HORARIOS': 'TURNOS:MEDICOS',\n    'TURNOS:MEDICOS': 'TURNOS:ESPECIALIDADES',\n    'TURNOS:ESPECIALIDADES': 'TURNOS:TIPO_TURNO',\n    'TURNOS:ESPECIALIDADES:VER_MAS': 'TURNOS:ESPECIALIDADES',\n    'TURNOS:CONFIRMAR': 'TURNOS:HORARIOS',\n    'CANCELAR:LISTAR': 'MENU_PRINCIPAL',\n    'DATOS:RECOLECTADOS': 'DATOS:RECOLECCION',\n    'INFO:MENU': 'MENU_PRINCIPAL'\n  };\n  \n  const nuevoEstado = navegacionAtras[estado] || 'MENU_PRINCIPAL';\n  \n  // Si volvemos al men√∫ principal, usar categor√≠a MENU_INICIAL\n  const categoria = (nuevoEstado === 'MENU_PRINCIPAL') ? 'MENU_INICIAL' : 'VOLVER_ATRAS';\n  \n  return { categoria, nuevoEstado };\n}\n\n/**\n * Reglas para administraci√≥n\n */\nfunction clasificarAdmin(mensaje, estado) {\n  if (estado === 'ADMIN:CONFIRMAR' && mensaje === 'SI, CONFIRMO') {\n    return { categoria: 'DERIVAR_HUMANO', nuevoEstado: 'ADMIN:HUMANO_ACTIVO' };\n  }\n  \n  return null;\n}\n\n// ============================================\n// 5. CLASIFICADOR PRINCIPAL\n// ============================================\n\n/**\n * Clasificador principal - Ejecuta todas las reglas en orden\n * @param {string} mensaje - Mensaje del usuario\n * @param {string} estado - Estado actual\n * @returns {object} Resultado con categor√≠a y nuevo estado\n */\nfunction clasificar(mensaje, estado) {\n  const ctx = obtenerContexto(estado);\n  \n  // 1. INICIO / SIN ESTADO\n  if (!estado || estado === '') {\n    return { categoria: 'MENU_INICIAL', nuevoEstado: 'MENU_PRINCIPAL' };\n  }\n  \n  // 2. VOLVER AL MEN√ö PRINCIPAL\n  if (mensaje === 'MENU PRINCIPAL') {\n    return { categoria: 'MENU_INICIAL', nuevoEstado: 'MENU_PRINCIPAL' };\n  }\n  \n  // 3. BOT√ìN ADMINISTRACI√ìN (desde cualquier estado)\n  if (mensaje === 'üè¢ ADMINISTRACION') {\n    return { categoria: 'NAV_ADMIN', nuevoEstado: 'ADMIN:CONFIRMAR' };\n  }\n  \n  // 4. EJECUTAR REGLAS EN ORDEN\n  const reglas = [\n    clasificarMenuPrincipal,\n    clasificarGestionTurnos,\n    clasificarSelecciones,\n    clasificarDatos,\n    clasificarCancelacion,\n    clasificarInformacion,\n    clasificarVolverAtras,\n    clasificarAdmin\n  ];\n  \n  for (const regla of reglas) {\n    const resultado = regla(mensaje, estado, ctx);\n    if (resultado) return resultado;\n  }\n  \n  // 5. FALLBACK INTELIGENTE - Devuelve categor√≠a basada en el estado actual\n  return obtenerCategoriaDeEstado(estado);\n}\n\n/**\n * Obtiene una categor√≠a por defecto basada en el estado actual\n * Esto permite que el flujo contin√∫e incluso cuando no se reconoce el mensaje\n * @param {string} estado - Estado actual del usuario\n * @returns {object} Resultado con categor√≠a y estado\n */\nfunction obtenerCategoriaDeEstado(estado) {\n  console.log('‚ö†Ô∏è FALLBACK INTELIGENTE - No se reconoci√≥ el mensaje');\n  console.log('üìç Estado actual:', estado);\n  \n  // Mapa de estados a categor√≠as por defecto\n  const estadoACategoriaMap = {\n    // Estados de Datos\n    'DATOS:SOLICITAR_DNI': { categoria: 'SOLICITAR_DNI', nuevoEstado: 'DATOS:SOLICITAR_DNI' },\n    'DATOS:DNI_VALIDADO': { categoria: 'MENU_GESTION_TURNOS', nuevoEstado: 'MENU:GESTION_TURNOS' },\n    \n    // Estados del Men√∫ de Gesti√≥n\n    'MENU:GESTION_TURNOS': { categoria: 'MENU_GESTION_TURNOS', nuevoEstado: 'MENU:GESTION_TURNOS' },\n    'TURNOS:TIPO_TURNO': { categoria: 'MENU_TIPO_TURNO', nuevoEstado: 'TURNOS:TIPO_TURNO' },\n    \n    // Estados de Turnos - Especialidades\n    'TURNOS:ESPECIALIDADES': { categoria: 'TURNO_CONSULTORIO', nuevoEstado: 'TURNOS:ESPECIALIDADES' },\n    'TURNOS:ESPECIALIDADES:VER_MAS': { categoria: 'VER_MAS_ESPECIALIDADES', nuevoEstado: 'TURNOS:ESPECIALIDADES:VER_MAS' },\n    'TURNOS:ESPECIALIDADES_ESTUDIO': { categoria: 'TURNO_ESTUDIO', nuevoEstado: 'TURNOS:ESPECIALIDADES_ESTUDIO' },\n    \n    // Estados de Turnos - M√©dicos\n    'TURNOS:MEDICOS': { categoria: 'SELECCION_ESPECIALIDAD', nuevoEstado: 'TURNOS:MEDICOS' },\n    \n    // Estados de Turnos - Horarios\n    'TURNOS:HORARIOS': { categoria: 'SELECCION_MEDICO', nuevoEstado: 'TURNOS:HORARIOS' },\n    'TURNOS:SIN_HORARIOS': { categoria: 'SELECCION_MEDICO', nuevoEstado: 'TURNOS:MEDICOS' },\n    'TURNOS:CONFIRMAR': { categoria: 'SELECCION_HORARIO', nuevoEstado: 'TURNOS:CONFIRMAR' },\n    \n    // Estados de Cancelaci√≥n\n    'CANCELAR:LISTAR': { categoria: 'CANCELAR_TURNO', nuevoEstado: 'CANCELAR:LISTAR' },\n    'CANCELAR-TURNO': { categoria: 'EJECUTAR_CANCELACION_TURNO', nuevoEstado: 'CANCELAR-TURNO' },\n    'CANCELAR:TURNO': { categoria: 'EJECUTAR_CANCELACION_TURNO', nuevoEstado: 'CANCELAR:TURNO' },\n    \n    // Estados de Mis Turnos\n    'TURNOS:MIS_TURNOS': { categoria: 'MIS_TURNOS', nuevoEstado: 'TURNOS:MIS_TURNOS' },\n    \n    // Estados de Administraci√≥n\n    'ADMIN:CONFIRMAR': { categoria: 'NAV_ADMIN', nuevoEstado: 'ADMIN:CONFIRMAR' },\n    'ADMIN:HUMANO_ACTIVO': { categoria: 'DERIVAR_HUMANO', nuevoEstado: 'ADMIN:HUMANO_ACTIVO' },\n    \n    // Men√∫ Principal\n    'MENU_PRINCIPAL': { categoria: 'MENU_INICIAL', nuevoEstado: 'MENU_PRINCIPAL' }\n  };\n  \n  // Buscar categor√≠a por estado exacto\n  if (estadoACategoriaMap[estado]) {\n    const resultado = estadoACategoriaMap[estado];\n    console.log('‚úÖ Categor√≠a encontrada para estado:', resultado.categoria);\n    return resultado;\n  }\n  \n  // Si no encuentra exacto, buscar por prefijo\n  if (estado.startsWith('DATOS:DNI_VALIDADO:')) {\n    console.log('‚úÖ Detectado DNI validado - Redirigiendo a men√∫ gesti√≥n');\n    return { categoria: 'MENU_GESTION_TURNOS', nuevoEstado: 'MENU:GESTION_TURNOS' };\n  }\n  \n  if (estado.startsWith('TURNOS:')) {\n    console.log('‚úÖ Usuario en flujo de turnos - Manteniendo contexto');\n    return { categoria: 'TURNO_CONSULTORIO', nuevoEstado: estado };\n  }\n  \n  if (estado.startsWith('CANCELAR:')) {\n    console.log('‚úÖ Usuario en cancelaci√≥n - Manteniendo contexto');\n    return { categoria: 'CANCELAR_TURNO', nuevoEstado: estado };\n  }\n  \n  if (estado.startsWith('DATOS:')) {\n    console.log('‚úÖ Usuario en registro de datos');\n    return { categoria: 'SOLICITAR_DNI', nuevoEstado: 'DATOS:SOLICITAR_DNI' };\n  }\n  \n  // √öltimo recurso: volver al men√∫ principal\n  console.log('‚ö†Ô∏è Estado no reconocido - Redirigiendo a men√∫ principal');\n  return { categoria: 'MENU_INICIAL', nuevoEstado: 'MENU_PRINCIPAL' };\n}\n\n// ============================================\n// 6. EJECUCI√ìN Y LOGGING\n// ============================================\n\n/**\n * Registra informaci√≥n de depuraci√≥n\n */\nfunction logDebug(mensaje, estadoRaw, estado, resultado) {\n  const dniExtraido = extraerDNI(mensaje);\n  \n  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n  console.log('üì± Mensaje:', mensaje);\n  console.log('üìè Longitud:', mensaje.length);\n  console.log('üî§ Tipo:', typeof mensaje);\n  console.log('üß™ Es DNI?:', esDNI(mensaje));\n  if (dniExtraido) {\n    console.log('üÜî DNI Extra√≠do:', dniExtraido);\n  }\n  console.log('üè∑Ô∏è  Estado Raw:', estadoRaw || '(sin estado)');\n  console.log('üè∑Ô∏è  Estado Normalizado:', estado || '(sin estado)');\n  console.log('üéØ Categor√≠a:', resultado.categoria);\n  console.log('üîÑ Nuevo Estado:', resultado.nuevoEstado);\n  if (resultado.metadata) {\n    console.log('üì¶ Metadata:', JSON.stringify(resultado.metadata));\n  }\n  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n}\n\n/**\n * Construye el contexto enriquecido\n */\nfunction construirContexto(resultado) {\n  const nuevoCtx = obtenerContexto(resultado.nuevoEstado);\n  \n  return {\n    seccion: nuevoCtx.seccion,\n    subseccion: nuevoCtx.subseccion,\n    es_usuario_registrado: resultado.nuevoEstado.startsWith('DATOS:DNI_VALIDADO'),\n    en_proceso_turno: resultado.nuevoEstado.startsWith('TURNOS:'),\n    en_cancelacion: resultado.nuevoEstado.startsWith('CANCELAR:')\n  };\n}\n\n// ============================================\n// 7. MAIN - PUNTO DE ENTRADA\n// ============================================\n\n// Obtener datos de entrada\nconst estadoRaw = $json.status || $json.value || $json.result || '';\nconst mensajeRaw = $('Variables').first().json.message;\nconst mensaje = mensajeRaw.toString().trim();\nconst contactNumber = $('Variables').first().json.contactNumber;\n\n// ============================================\n// üîç DEBUG: Informaci√≥n del mensaje\n// ============================================\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\nconsole.log('üîç DEBUG MENSAJE');\nconsole.log('üì© mensajeRaw:', mensajeRaw);\nconsole.log('üìè Tipo de mensajeRaw:', typeof mensajeRaw);\nconsole.log('üì© mensaje (despu√©s de toString y trim):', mensaje);\nconsole.log('üìè Tipo de mensaje:', typeof mensaje);\nconsole.log('üìè Longitud:', mensaje.length);\nconsole.log('üî§ Caracteres:', JSON.stringify(mensaje));\nconsole.log('üÜî C√≥digos de caracteres:', mensaje.split('').map(c => c.charCodeAt(0)));\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n\n// Intentar obtener metadata del nodo anterior (para preservar c√≥digo de especialidad, etc.)\nlet metadataPrevio = {};\ntry {\n  // Primero intentar del $json actual (puede venir del nodo Redis GET)\n  if ($json.metadata && Object.keys($json.metadata).length > 0) {\n    metadataPrevio = $json.metadata;\n    console.log('‚úÖ Metadata encontrado en $json');\n  } else {\n    // Intentar del nodo Get Estado Actual\n    metadataPrevio = $('Get Estado Actual').first().json.metadata || {};\n    console.log('‚úÖ Metadata encontrado en Get Estado Actual');\n  }\n} catch (e) {\n  try {\n    // Intentar del nodo LISTA_MEDICOS\n    const listaMedicos = $('LISTA_MEDICOS').first().json;\n    metadataPrevio = {\n      codigoEspecialidad: listaMedicos.codigoEspecialidad,\n      especialidadSeleccionada: listaMedicos.especialidadSeleccionada\n    };\n    console.log('‚úÖ Metadata encontrado en LISTA_MEDICOS');\n  } catch (e2) {\n    try {\n      // Intentar del nodo LISTA_ESPECIALIDADES\n      metadataPrevio = $('LISTA_ESPECIALIDADES').first().json;\n      console.log('‚úÖ Metadata encontrado en LISTA_ESPECIALIDADES');\n    } catch (e3) {\n      metadataPrevio = {};\n      console.log('‚ö†Ô∏è No se encontr√≥ metadata previo');\n    }\n  }\n}\n\nconsole.log('üì¶ Metadata previo final:', JSON.stringify(metadataPrevio));\n\n// Hacer metadata previo disponible globalmente para las funciones clasificadoras\nglobalThis._metadataPrevio = metadataPrevio;\n\n// Normalizar estado\nconst estado = normalizarEstado(estadoRaw);\n\n// ============================================\n// üö® DETECCI√ìN DE ERROR_MESSAGE (Errores de Registro)\n// ============================================\n// Si hay un error de registro (DNI incorrecto, nombre incompleto, etc.)\n// debe devolver ERROR_REGISTRO para volver al flujo de datos\nconst hasError = $json.hasError || false;\nconst errorMessage = $json.errorMessage || null;\n\nif (hasError && errorMessage) {\n  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n  console.log('üö® ERROR DE REGISTRO DETECTADO');\n  console.log('üìù Mensaje de error:', errorMessage);\n  console.log('üîÑ Redirigiendo al flujo de datos para reintentar');\n  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n  \n  // Retornar inmediatamente con categor√≠a ERROR_REGISTRO\n  return [{\n    json: {\n      categoria: 'ERROR_REGISTRO',\n      mensaje: mensaje,\n      contactNumber: contactNumber,\n      estadoActual: 'DATOS:ERROR_REGISTRO',\n      estadoAnterior: estado,\n      metadata: {\n        errorMessage: errorMessage,\n        errorOriginal: errorMessage\n      },\n      redisKey: `state:${contactNumber}`,\n      redisValue: 'DATOS:ERROR_REGISTRO',\n      nuevoEstado: 'DATOS:ERROR_REGISTRO',\n      _context: {\n        seccion: 'DATOS',\n        subseccion: 'ERROR_REGISTRO',\n        es_usuario_registrado: false,\n        en_proceso_turno: false,\n        en_cancelacion: false,\n        tiene_error: true\n      }\n    }\n  }];\n}\n\n// Log de entrada\nconst dniEnMensaje = extraerDNI(mensaje);\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ ENTRADA ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\nconsole.log('üì© Mensaje raw:', JSON.stringify(mensajeRaw));\nconsole.log('üì© Mensaje procesado:', mensaje);\nconsole.log('üìè Longitud:', mensaje.length);\nconsole.log('üìè Tipo:', typeof mensajeRaw);\nconsole.log('üß™ Es DNI?:', esDNI(mensaje));\nif (dniEnMensaje) {\n  console.log('üÜî DNI encontrado:', dniEnMensaje);\n}\nconsole.log('üè∑Ô∏è  Estado raw:', estadoRaw);\nconsole.log('üè∑Ô∏è  Estado normalizado:', estado);\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n\n// Clasificar\nconst resultado = clasificar(mensaje, estado);\n\n// Log de depuraci√≥n\nlogDebug(mensaje, estadoRaw, estado, resultado);\n\n// Retornar resultado estructurado\nreturn [{\n  json: {\n    // Datos principales\n    categoria: resultado.categoria,\n    mensaje: mensaje,\n    contactNumber: contactNumber,\n    \n    // Estados para Redis\n    estadoActual: resultado.nuevoEstado,      // Estado a guardar en Redis\n    estadoAnterior: estado,                   // Estado previo (para volver atr√°s)\n    \n    // Metadata\n    metadata: resultado.metadata || {},\n    \n    // Redis keys (compatibilidad)\n    redisKey: `state:${contactNumber}`,\n    redisValue: resultado.nuevoEstado,\n    \n    // Alias para compatibilidad con c√≥digo existente\n    nuevoEstado: resultado.nuevoEstado,\n    \n    // Contexto enriquecido\n    _context: construirContexto(resultado)\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-3232,1632],"id":"a7de34c4-5060-42e5-a957-3b1eedc849bd","name":"msg_clasificador"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Preparar Redis').item.json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ü´Ä INSTITUTO DE CARDIOLOG√çA LA PLATA\"\n    },\n    \"body\": {\n      \"text\": \"üè¢ ADMINISTRACI√ìN\\n\\nTE CONECTAREMOS CON UNA ADMINISTRATIVA\\n\\nRECUERDA:\\n\\n‚è∞ HORARIO DE RESPUESTA:\\nLUNES A VIERNES: 8-20HS | S√ÅBADO 8-13HS\\n\\nüìû OTRO MEDIO DONDE POD√âS RECIBIR ASISTENCIA:\\n221 4906310\\n\\n¬øQUER√âS CONTINUAR?\"\n    },\n    \"footer\": {\n      \"text\": \"LUN-VIE 8-20HS | S√ÅB 8-13HS\"\n    },\n    \"action\": {\n      \"buttons\": [\n                {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"volver-atras\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-912,1440],"id":"146bece1-d6a0-41d6-934f-e7a5f9ec0794","name":"üè¢ Administraci√≥n","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}},"disabled":true},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"status\": \"read\",\n  \"message_id\": \"{{ $('Entrada').item.json.body.messages[0].source_id }}\",\n  \"typing_indicator\": {\n    \"type\": \"text\"\n  }\n} ","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3424,816],"id":"55193419-7004-4b8d-934c-6cc674cd6d29","name":"HTTP Request5","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"status\": \"read\",\n  \"message_id\": \"{{ $('Entrada').item.json.body.messages[0].source_id }}\",\n  \"typing_indicator\": {\n    \"type\": \"text\"\n  }\n} ","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-688,1440],"id":"11e9b06b-7504-4ce0-84dc-fb907a44d8c2","name":"HTTP Request6","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}},"disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"057155d2-7320-48de-8ed5-bf00dcc72b38","leftValue":"={{ $json.body.messages[0].sender.phone_number }}","rightValue":"+5492213994411","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"d0c07208-2eca-4ffc-ae49-063a0363cf6e","leftValue":"={{ $json.body.messages[0].sender.phone_number }}","rightValue":"+595985624358","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"c20fad56-f470-4653-b327-8ce2b684deaa","leftValue":"={{ $json.body.messages[0].sender.phone_number }}","rightValue":"+5492254596618","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"41ecf46b-61e9-4d1b-9bc9-9ed63e9817e3","leftValue":"={{ $json.body.messages[0].sender.phone_number }}","rightValue":"+34629235015","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"or"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[-5728,1408],"id":"a5c59d94-35e3-4261-aedf-714c5fc0164f","name":"Filtrar n√∫meros de prueba","disabled":true},{"parameters":{"dataToSave":{"values":[{"key":"conversationId","value":"={{ $json.body.id }}"},{"key":"contactNumber","value":"={{ $json.body.contact_inbox.source_id }}"}]}},"type":"n8n-nodes-base.executionData","typeVersion":1,"position":[-5984,1216],"id":"02671aba-9796-4132-ba84-e4470df52fc8","name":"Execution Data1"},{"parameters":{"operation":"delete","key":"=status:{{ $('Variables').first().json.contactNumber }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-464,1440],"id":"30b4d46e-c368-4b36-85f5-adb00805a8c1","name":"üíæ Set Estado MENU3","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"workflowId":{"__rl":true,"value":"gsbUq8JFSpw8U7yR","mode":"list","cachedResultName":"SUB - ETIQUETA: CONSULTA_RECLAMO"},"workflowInputs":{"mappingMode":"defineBelow","value":{"humano":true,"accountId":"={{ $('Filtro Tipo Mensaje').item.json.accountId }}","conversationId":"={{ $('Filtro Tipo Mensaje').item.json.conversationId.toString() }}","contactId":"={{ $('Filtro Tipo Mensaje').item.json.contactId.toString() }}","message":"={{ $('Filtro Tipo Mensaje').item.json.message }}","inboxId":"={{ $('Filtro Tipo Mensaje').item.json.inboxId.toString() }}","chatwootUrlBase":"={{ $('Filtro Tipo Mensaje').item.json.chatwootUrl }}","tokenChatwoot":"={{ $('Filtro Tipo Mensaje').item.json.agenteBotTokenWhatsapp }}","tipoIntencion":"consultas-reclamos"},"matchingColumns":[],"schema":[{"id":"accountId","displayName":"accountId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"conversationId","displayName":"conversationId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"contactId","displayName":"contactId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"message","displayName":"message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"inboxId","displayName":"inboxId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"humano","displayName":"humano","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"boolean"},{"id":"chatwootUrlBase","displayName":"chatwootUrlBase","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"tokenChatwoot","displayName":"tokenChatwoot","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"tipoIntencion","displayName":"tipoIntencion","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-880,2128],"id":"bedcddbc-9bbf-4eb2-879c-bbb9ca974025","name":"ETIQUETA CONSULTA-RECLAMO"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"status\": \"read\",\n  \"message_id\": \"{{ $('Entrada').item.json.body.messages[0].source_id }}\",\n  \"typing_indicator\": {\n    \"type\": \"text\"\n  }\n} ","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-528,2128],"id":"d224944b-bd2c-4d8e-b134-d162643024c8","name":"HTTP Request7","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"status\": \"read\",\n  \"message_id\": \"{{ $('Entrada').first().json.body.messages[0].source_id }}\",\n  \"typing_indicator\": {\n    \"type\": \"text\"\n  }\n} ","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-4640,1296],"id":"c2591736-644c-473f-9510-99ef505f20b5","name":"HTTP Request8","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"={{ $('Filtro Tipo Mensaje').item.json.chatwootUrl }}/api/v1/accounts/{{ $('Filtro Tipo Mensaje').item.json.accountId }}/conversations/{{ $('Filtro Tipo Mensaje').item.json.conversationId }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('Filtro Tipo Mensaje').item.json.agenteBotTokenWhatsapp }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"content","value":"=üè∑Ô∏è Su consulta ya qued√≥ registrada y etiquetada para que un supervisor del √°rea administrativa se comunique con usted.\n\nüë§ En breve recibir√° atenci√≥n personalizada.\n‚è∏Ô∏è El men√∫ autom√°tico permanecer√° pausado por el momento.\n\n‚ù§Ô∏è *Gracias por tu confianza.*\n_Instituto de Cardiolog√≠a La Plata_"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-4400,1216],"id":"219a3338-e08f-4115-bbee-ab103ad21b19","name":"sendRespondCw"},{"parameters":{"operation":"incr","key":"=contador:{{ $('Filtro Tipo Mensaje').item.json.contactNumber }}","expire":true,"ttl":3600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-4176,1296],"id":"5103f3e3-3d8c-4db3-b389-2700d1bb1407","name":"contador","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"mensaje_enviado","key":"=contador:{{ $('Filtro Tipo Mensaje').item.json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-5120,1216],"id":"8b34a58f-da7c-488c-b2f1-fbbb81e002de","name":"MSG ENVIADO?","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"28730a7e-22e0-4e24-9233-e808f6b6826c","leftValue":"={{ $json.mensaje_enviado >= 1 && $json.mensaje_enviado !== null }}","rightValue":"null","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-4880,1216],"id":"ee5471ea-c1df-448d-9628-258369f546c9","name":"If"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filtro Tipo Mensaje').first().json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": {{ JSON.stringify($json.mensaje) }}\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-304,4416],"id":"c61bc6a7-0a36-4b61-8196-38c8a2a285c6","name":"ESPECIALIDADES2","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"content":"## INFO GENERAL - MEDICOS","height":304,"width":992,"color":4},"type":"n8n-nodes-base.stickyNote","position":[-880,3968],"typeVersion":1,"id":"62ec9a81-c4ea-4c1d-a3f1-af60ff131390","name":"Sticky Note2"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filtro Tipo Mensaje').first().json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": {{ JSON.stringify($json.mensaje) }}\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-320,4064],"id":"e878a862-4008-4d29-bc5a-a6f7f4fb08cd","name":"MEDICOS","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"jsCode":"// Obtener todos los m√©dicos\nconst items = $input.all();\n\n// Crear un objeto para agrupar m√©dicos por especialidad\nconst medicosPorEspecialidad = {};\n\nitems.forEach(item => {\n  const medico = item.json.Medico;\n  const especialidad = item.json.Especialidad;\n  \n  if (!medicosPorEspecialidad[especialidad]) {\n    medicosPorEspecialidad[especialidad] = [];\n  }\n  \n  // Evitar duplicados\n  if (!medicosPorEspecialidad[especialidad].includes(medico)) {\n    medicosPorEspecialidad[especialidad].push(medico);\n  }\n});\n\n// Ordenar especialidades alfab√©ticamente\nconst especialidadesOrdenadas = Object.keys(medicosPorEspecialidad).sort();\n\n// Crear el listado formateado\nlet listadoMedicos = '';\nespecialidadesOrdenadas.forEach(especialidad => {\n  listadoMedicos += `\\nüìå *${especialidad}*\\n`;\n  \n  // Ordenar m√©dicos alfab√©ticamente\n  const medicos = medicosPorEspecialidad[especialidad].sort();\n  \n  medicos.forEach(medico => {\n    listadoMedicos += `   ‚Ä¢ Dr./Dra. ${medico}\\n`;\n  });\n});\n\n// Crear el mensaje completo con las nuevas instrucciones\nconst mensaje = `üë®‚Äç‚öïÔ∏è *NUESTROS PROFESIONALES*\\n\\nüè• *CONTAMOS CON LOS SIGUIENTES M√âDICOS ESPECIALISTAS:*${listadoMedicos}\\n\\nüìû *CONTACTO:*\\n(0221) 4906310\\nLUNES A VIERNES: 8:00-20:00HS`;\n\n// Mensaje para bot√≥n interactivo\nconst mensajeBoton = `üìã IR AL MEN√ö PRINCIPAL O DIRECTAMENTE SACAR TURNO`;\n\n// Retornar el resultado en JSON\nreturn [{\n  json: {\n    listadoMedicos: listadoMedicos.trim(),\n    mensaje: mensaje,\n    mensajeBoton: mensajeBoton,\n    medicosPorEspecialidad: medicosPorEspecialidad,\n    totalEspecialidades: especialidadesOrdenadas.length,\n    totalMedicos: items.length,\n    // Estructura completa para mensaje interactivo\n    interactive_body: mensajeBoton,\n    interactive_button_id: \"menu_principal\",\n    interactive_button_title: \"MENU PRINCIPAL\"\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-544,4064],"id":"328f1a6a-3772-4d6e-a719-be726830c057","name":"Msg preparado"},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"mhwp4qt6r2d7ymm","returnAll":true,"options":{}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[-768,4064],"id":"f42541c6-2f46-49ef-a552-d8932f5c9b7a","name":"get_medicos1","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"mi8p2u7tvuplzt5","returnAll":true,"options":{}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[-752,4416],"id":"b0549ecc-8277-4c53-bac7-6a51364d0e0d","name":"get_especialidades","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"jsCode":"// Obtener todas las especialidades\nconst items = $input.all();\n\n// Extraer las especialidades y eliminar duplicados\nconst especialidades = [...new Set(items.map(item => item.json.Especialidad))];\n\n// Ordenar alfab√©ticamente\nespecialidades.sort();\n\n// Crear el listado formateado para WhatsApp\nconst listadoEspecialidades = especialidades\n  .map((esp, index) => `${index + 1}. ${esp.toUpperCase()}`)\n  .join('\\n');\n\n// Crear el mensaje completo en may√∫sculas\nconst mensaje = `üè• *ESPECIALIDADES DISPONIBLES*\\n\\nüìã *CONTAMOS CON LAS SIGUIENTES ESPECIALIDADES:*\\n\\n${listadoEspecialidades}\\n\\nüëá *PRESIONE SI QUIERE SACAR UN TURNO Y SIGA LAS INDICACIONES*\\n\\nüìû *CONTACTO:*\\n(0221) 4906310\\nLUNES A VIERNES: 8:00-20:00HS`;\n\n// Mensaje para bot√≥n interactivo\nconst mensajeBoton = `üìã SACAR UN TURNO O IR AL  MENU PRINCIPAL`;\n\n// Retornar tanto el array como el mensaje\nreturn [{\n  json: {\n    especialidades: especialidades,\n    total: especialidades.length,\n    listadoEspecialidades: listadoEspecialidades,\n    mensaje: mensaje,\n    mensajeBoton: mensajeBoton,\n    // Estructura completa para mensaje interactivo\n    interactive_body: mensajeBoton,\n    interactive_button_id: \"menu_principal\",\n    interactive_button_title: \"MENU PRINCIPAL\"\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-528,4416],"id":"9c8e288a-3387-47e3-8310-ebdbffb4972b","name":"Msg preparado1"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filtro Tipo Mensaje').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"{{ $('Msg preparado1').item.json.mensajeBoton }}\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"sacar_turno\",\n            \"title\": \"TOMAR TURNO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"menu_principal\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-96,4416],"id":"e9fe6f19-aaed-44a0-8f08-77b04527328c","name":"ENVIA-> MENU-SACAR TURNO","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filtro Tipo Mensaje').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"{{ $('Msg preparado').item.json.mensajeBoton }}\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"sacar_turno\",\n            \"title\": \"TOMAR TURNO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"menu_principal\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-112,4064],"id":"1611927e-0e8e-47cc-aca4-4b83d96de573","name":"ENVIA-> MENU-SACAR TURNO1","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"content":"## INFO GENERAL - ESPECIALIDADES","height":304,"width":992,"color":5},"type":"n8n-nodes-base.stickyNote","position":[-880,4304],"typeVersion":1,"id":"f64270f6-2caa-4da0-bc33-b621197874af","name":"Sticky Note3"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"flujo-medicos","leftValue":"={{ $json.tipoFlujo }}","rightValue":"medicos","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"üë®‚Äç‚öïÔ∏è M√âDICOS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"flujo-especialidades","leftValue":"={{ $json.tipoFlujo }}","rightValue":"especialidades","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"ü©∫ ESPECIALIDADES"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"flujo-directo","leftValue":"={{ $json.esFlujoDirecto }}","rightValue":"","operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"renameOutput":true,"outputKey":"üí¨ MENSAJE DIRECTO"}]},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-1040,4400],"id":"b4dc3037-a11d-4cc6-b5c2-88a8a7f9bbf5","name":"üîÄ SWITCH INFO FLUJOS"},{"parameters":{"content":"## INFO GENERAL - OTROS MENSAJES","height":304,"width":992,"color":5},"type":"n8n-nodes-base.stickyNote","position":[-880,4640],"typeVersion":1,"id":"75b3fa62-47bd-4a62-a44d-f5de289fcda6","name":"Sticky Note"},{"parameters":{"operation":"set","key":"=status:{{ $('msg').item.json.body.to }}","value":"={{ $('msg').item.json.estadoActual }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3200,1376],"id":"17f47ae5-3c21-42d9-b37d-5e56be13f26b","name":"STATUS:MENU=1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"\n\nconst contactNumber = $json.contactNumber;\n\n// Mensaje con botones para elegir tipo de turno\nconst mensajeBody = {\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": contactNumber,\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ü´Ä INSTITUTO DE CARDIOLOG√çA LA PLATA\"\n    },\n    \"body\": {\n      \"text\": \"Recuerda que MOMENT√ÅNEAMENTE SOLO DAMOS LOS TURNOS M√ÅS PR√ìXIMOS\\n\\nSi necesita una fecha m√°s lejana elija la opci√≥n de administraci√≥n\"\n    },\n    \"footer\": {\n      \"text\": \"üìÖ Lun-Vie 8-20hs\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"con-consultorio\",\n            \"title\": \"TURNOS CONSULTORIO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"con-estudio\",\n            \"title\": \"TURNOS ESTUDIO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"volver-atras\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n};\n\n// Log\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\nconsole.log('üìÖ SELECCIONAR TIPO DE TURNO');\nconsole.log('üì± Destinatario:', contactNumber);\nconsole.log('üéØ Estado: TURNOS:TIPO_TURNO');\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n\n// Retornar\nreturn [{\n  json: {\n    body: mensajeBody,\n    categoria: 'INICIAR_TOMAR_TURNO',\n    contactNumber: contactNumber,\n    estadoActual: 'TURNOS:TIPO_TURNO'\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-784,2640],"id":"e20c1a8c-9905-47a1-b6e6-ef465e19849e","name":"üé´ Router Gesti√≥n Turnos1"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.body.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.body.recipient_type }}"},{"name":"to","value":"={{ $json.body.to }}"},{"name":"type","value":"={{ $json.body.type }}"},{"name":"interactive","value":"={{ $json.body.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-560,2640],"id":"bf3bb5a2-e22d-41db-953c-a1594c698a84","name":"PACIENTE REGISTRADO","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=status:{{ $('msg_clasificador').first().json.contactNumber }}","value":"={{ $('üé´ Router Gesti√≥n Turnos1').item.json.estadoActual }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-336,2640],"id":"31658330-2710-46df-b373-b0e82b6bb406","name":"‚è±Ô∏è STATUS PRIMERA VEZ2","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"validar-dni","leftValue":"={{ $json.categoria }}","rightValue":"VALIDAR_DNI","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"üîç VALIDAR DNI (IA)"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"ingreso-dni-menu","leftValue":"={{ $json.categoria }}","rightValue":"INGRESO_DNI","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"üìã DNI DESDE MENU"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"ingreso-datos","leftValue":"={{ ['INGRESO_DATOS_PACIENTE','SOLICITAR_DNI'].includes($json.categoria) || $json.estadoAnterior === 'PACIENTE_NUEVO_ERROR'}}","rightValue":"INGRESO_DATOS_PACIENTE","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"üìù INGRESO DATOS"}]},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-1008,2864],"id":"2f6fcf53-254e-4dad-ac45-957379b579f8","name":"üîÄ SWITCH DATOS PACIENTE"},{"parameters":{"jsCode":"// ============================================\n// MENSAJE: SOLICITAR DNI\n// ============================================\n// Solicita al usuario que ingrese su DNI para validaci√≥n\n// ============================================\n\nconst contactNumber = $json.contactNumber;\n\n// Mensaje solicitando DNI\nconst mensajeBody = {\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": contactNumber,\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"‚úÖ *PACIENTE REGISTRADO*\\n\\n‚ö†Ô∏è *IMPORTANTE: NO PRESIONE NING√öN BOT√ìN*\\n\\nüîπ *ESCRIBA Y ENV√çE SU N√öMERO DE DNI*\\n(Sin puntos, sin espacios, solo n√∫meros)\\n\\nüìù *EJEMPLO:*\\n35987654\\n\\nüëá *ESCRIBA SU DNI EN EL MENSAJE Y ENVIELO*\"\n    },\n    \"footer\": {\n      \"text\": \"üìÖ LUN-VIE 8-20HS\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"volver-atras\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n};\n\n// Log\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\nconsole.log('üìù SOLICITAR DNI');\nconsole.log('üì± Destinatario:', contactNumber);\nconsole.log('üéØ Estado: DATOS:SOLICITAR_DNI');\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n\n// Retornar\nreturn [{\n  json: {\n    body: mensajeBody,\n    categoria: 'PACIENTE_REGISTRADO',\n    contactNumber: contactNumber,\n    estadoActual: 'DATOS:SOLICITAR_DNI'\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2752,1040],"id":"b1ab6dae-2bd3-4a8a-a01a-10671f67601a","name":"PACIENTE REGISTRADO1"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.body.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.body.recipient_type }}"},{"name":"to","value":"={{ $json.body.to }}"},{"name":"type","value":"={{ $json.body.type }}"},{"name":"interactive","value":"={{ $json.body.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2976,1040],"id":"ddfb4062-cdfa-42e0-bc57-69a4b43440e5","name":"SOLICITAR DNI","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=status:{{ $('msg_clasificador').first().json.contactNumber }}","value":"={{ $('üîÄ SWITCH GESTI√ìN TURNOS').item.json.estadoActual }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3200,1040],"id":"2a56747a-1a9d-461f-bebd-00c7376bd287","name":"‚è±Ô∏è STATUS PRIMERA VEZ3","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"068a964d-25b6-4a1f-8e05-c47dd2fea4b7","leftValue":"={{ $json.output.ERROR }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[16,144],"id":"c3ce781c-5493-461e-a815-ab438042601d","name":"Error informacion de usuario"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Variables').first().json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"‚ö†Ô∏è {{ $json.output.ERROR_MESSAGE }}\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[256,16],"id":"6503c181-a7a6-4295-b7af-4fd0827d45b0","name":"‚ö†Ô∏è DATOS INCORRECTOS","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[-560,0],"id":"6e4efd48-3a0c-4a25-a727-45dda100342a","name":"OpenRouter Chat Model1","credentials":{"openRouterApi":{"id":"ZlcbniUoDvrFqCIJ","name":"OpenRouter ICLP"}}},{"parameters":{"jsonSchemaExample":"{  \n  \"DNI\": \"string\",  \n  \"ERROR\": false,\n  \"ERROR_MESSAGE\": \"\"\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-144,-32],"id":"22105da1-801f-48fd-8c4f-29cd636904e0","name":"Structured Output Parser1"},{"parameters":{"promptType":"define","text":"=dni usuario :{{ $('üîÄ ROUTER PRINCIPAL').first().json.mensaje }}","hasOutputParser":true,"options":{"systemMessage":"=# TAREA\n\n- Analizar el contido que llega y ordenarlo en un objeto JSON\n\n{\n  \n  \"DNI\":\"\",\n  \"ERROR\": false,\n  \"ERROR_MESSAGE\": \"\"\n}\n\n# IMPORTANTE\n\n- Debes analizar si el dni esta bien escrito, debe contener entre 7 y 8 digitos ya que los usuarios mayores poseen 7 digitos y los mas actuales 8 digitos.\n- No deben contener espacios ni puntos, si el mensaje del usuario es > DNI 35.946.257 debes formatearlo solo al numero 35946257\n- Si da error debes preparar un mensaje de devolucion para colocarlo en ERROR_MESSAGE"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[-384,144],"id":"378018e6-f2c4-4f8f-9800-ed9a094ed7b4","name":"AI Agent"},{"parameters":{"workflowId":{"__rl":true,"value":"oB7pjyME2Gvo5moH","mode":"list","cachedResultName":"SUB - GET_PACIENTE"},"workflowInputs":{"mappingMode":"defineBelow","value":{"dni":"={{ $json.output.DNI || $('DNI1').item.json.status.replace('DNI:', '') ||$('YA SE ACTIVO MENU?').item.json.status.replace('DNI:', '')  }}","telefono":"={{ $('Variables').first().json.contactNumber }}"},"matchingColumns":["dni"],"schema":[{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"telefono","displayName":"telefono","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[272,368],"id":"c9b9e07d-dcbd-41f8-bc40-12a39cc2969b","name":"Get_Paciente1"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Variables').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ü´Ä INSTITUTO DE CARDIOLOG√çA LA PLATA\"\n    },\n    \"body\": {\n      \"text\": \"*HOLA {{ $json.output.paciente_nombre }}* ‚úì\\n\\n*üìã VERIFICACI√ìN DE DATOS*\\n\\nCONFIRM√Å QUE TU INFORMACI√ìN SEA CORRECTA:\\n\\n‚ñ™Ô∏è *NOMBRE:* {{ $json.output.paciente_nombre }}\\n\\n‚ñ™Ô∏è *DNI:* {{ $json.output.paciente_dni }}\\n\\n‚ñ™Ô∏è *TEL√âFONO:* {{ $json.output.paciente_celular }}\\n\\n‚úì *¬øLOS DATOS SON CORRECTOS?*\\nPRESION√Å CONTINUAR\\n\\nüí¨ *¬øNECESIT√ÅS CORREGIR ALGO?*\\nCOMUNICATE CON ADMINISTRACI√ìN:\\n*üìû (0221) 490-6310*\"\n    },\n    \"footer\": {\n      \"text\": \"LUN-VIE 8-20HS | S√ÅB 8-13HS\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"CONTINUAR\",\n            \"title\": \"CONTINUAR\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"MENU-PRINCIPAL\",\n            \"title\": \"MEN√ö PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[752,464],"id":"fbc17ba1-19a4-4ac5-ba51-6fdc69c27c8e","name":"‚úÖ DATOS VALIDADOS","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"m1kjf7ed0befl04","returnAll":true,"options":{}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[-896,144],"id":"4a4d8c9f-ba98-4c24-a9c4-57310b1efdf2","name":"obra_social1","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"jsCode":"return {\n    total: $input.all().length,\n    obrasociales: $input.all().map(item => ({\n        Id_os: item.json.Id,\n        nombre_obrasocial: item.json.nombre_obrasocial,\n        obrasocial: item.json.obrasocial\n    }))\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-672,144],"id":"b1206c20-17a0-4aed-aacd-a2ff37b6eea4","name":"Code8"},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Variables').first().json.contactNumber }}","sessionTTL":600,"contextWindowLength":10},"type":"@n8n/n8n-nodes-langchain.memoryRedisChat","typeVersion":1.5,"position":[-560,416],"id":"ecc071aa-c6b1-49ca-8bf3-0712a3d68643","name":"Redis Chat Memory","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Variables').first().json.contactNumber }}","value":"=DATOS:DNI_VALIDADO:{{ $('Get_Paciente1').item.json.output.paciente_dni }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[976,464],"id":"d1003f49-aa3e-4b5b-b060-cbb3aa765f68","name":"DNI VERIFICADO","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"const contactNumber = $json.contactNumber;\n\n// Mensaje con botones de gesti√≥n de turnos\nconst mensajeBody = {\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": contactNumber,\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ü´Ä ICLP - GESTI√ìN DE TURNOS\"\n    },\n    \"body\": {\n      \"text\": \"*üìã GESTI√ìN DE TURNOS*\\n\\n*¬øQU√â DESEA HACER?*\\n\\n*üìÖ TOMAR TURNO*\\n‚Üí AGENDAR UNA NUEVA CONSULTA CON NUESTROS ESPECIALISTAS\\n\\n*‚ùå CANCELAR TURNO*\\n‚Üí ANULAR UN TURNO YA PROGRAMADO\\n\\n*üìù MIS TURNO/S*\\n‚Üí VER SUS PR√ìXIMAS CITAS AGENDADAS\\n\\nüëá *SELECCIONE UNA OPCI√ìN PARA CONTINUAR*\"\n    },\n    \"footer\": {\n      \"text\": \"üìÖ LUN-VIE 8-20HS\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"tomar-turno\",\n            \"title\": \"TOMAR TURNO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"cancelar-turno\",\n            \"title\": \"CANCELAR TURNO\"\n          }          \n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"mis-turnos\",\n            \"title\": \"MIS TURNOS\"\n          }        \n        }\n      ]\n    }\n  }\n};\n\n// Log\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\nconsole.log('üìã MEN√ö GESTI√ìN DE TURNOS');\nconsole.log('üì± Destinatario:', contactNumber);\nconsole.log('üéØ Estado: MENU:GESTION_TURNOS');\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n\n// Retornar\nreturn [{\n  json: {\n    body: mensajeBody,\n    categoria: 'MENU_GESTION_TURNOS',\n    contactNumber: contactNumber,\n    estadoActual: 'MENU:GESTION_TURNOS'\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2752,1376],"id":"443d5727-e118-481a-b4ad-870afb2fd265","name":"msg"},{"parameters":{"operation":"set","key":"=status:{{ $('LISTA_ESPECIALIDADES_BLOQUES').item.json.to }}","value":"={{ $('LISTA_ESPECIALIDADES_BLOQUES').item.json.estadoActual }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3392,2128],"id":"555d4538-249b-463e-a8f9-222dc2ec12a0","name":"ESPECIALIDADES1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.recipient_type }}"},{"name":"to","value":"={{ $json.to }}"},{"name":"type","value":"={{ $json.type }}"},{"name":"interactive","value":"={{ $json.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3168,2128],"id":"b1ace980-edba-42c9-b1b9-a68831fd3ae4","name":"ü©ª ESPECIALIDADES1","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"mi8p2u7tvuplzt5","returnAll":true,"options":{"sort":{"property":[{"field":"Especialidad"}]}}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[2720,2128],"id":"657d8ef5-0d4a-43cf-ae68-54fb32d693a2","name":"Get_Especialidades1","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"jsCode":"// ============================================\n// LISTA DE ESPECIALIDADES CON BLOQUES\n// ============================================\n// Divide las especialidades en dos bloques:\n// - Primer bloque: 9 especialidades + bot√≥n VER M√ÅS\n// - Segundo bloque: Especialidades restantes\n// ============================================\n\n// Obtener todas las especialidades del input\nconst items = $input.all();\n\n// Obtener contactNumber desde m√∫ltiples fuentes posibles\nlet contactNumber;\ntry {\n  // Intentar obtener del nodo clasificador\n  contactNumber = $('msg_clasificador').first().json.contactNumber;\n} catch (e) {\n  try {\n    // Si no, intentar del router principal\n    contactNumber = $('ROUTER PRINCIPAL').first().json.contactNumber;\n  } catch (e2) {\n    try {\n      // Si no, intentar del switch gesti√≥n turnos\n      contactNumber = $('SWITCH GESTI√ìN TURNOS').first().json.contactNumber;\n    } catch (e3) {\n      // √öltimo recurso: buscar en cualquier item del input\n      contactNumber = items[0]?.json?.contactNumber || $json.contactNumber;\n    }\n  }\n}\n\n// Verificar el estado actual para determinar qu√© bloque mostrar\nlet estadoActual;\ntry {\n  estadoActual = $('msg_clasificador').first().json.estadoActual || \n                 $('msg_clasificador').first().json.nuevoEstado || \n                 $json.estadoActual || \n                 $json.nuevoEstado || \n                 'TURNOS:ESPECIALIDADES';\n} catch (e) {\n  estadoActual = $json.estadoActual || $json.nuevoEstado || 'TURNOS:ESPECIALIDADES';\n}\n\nconst esVerMas = estadoActual === 'TURNOS:ESPECIALIDADES:VER_MAS';\n\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\nconsole.log('ü©∫ PREPARANDO ESPECIALIDADES');\nconsole.log('üì± Contact Number:', contactNumber);\nconsole.log('üìä Estado actual:', estadoActual);\nconsole.log('üìã Bloque:', esVerMas ? 'VER M√ÅS (segundo)' : 'PRINCIPAL (primero)');\nconsole.log('üì¶ Total especialidades:', items.length);\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n\n// Crear el array de rows para TODAS las especialidades\nconst todasLasRows = items.map(item => {\n  const especialidad = item.json.Especialidad;\n  const codigo = item.json.Codigo;\n  \n  // Convertir a may√∫sculas\n  let nombreEspecialidad = especialidad.toUpperCase();\n  \n  // Si tiene par√©ntesis, tomar solo lo que est√° antes\n  if (nombreEspecialidad.includes('(')) {\n    nombreEspecialidad = nombreEspecialidad.split('(')[0].trim();\n  }\n  \n  // Si tiene barra, tomar solo la primera parte\n  if (nombreEspecialidad.includes('/')) {\n    nombreEspecialidad = nombreEspecialidad.split('/')[0].trim();\n  }\n  \n  // Si tiene m√∫ltiples palabras, tomar solo la primera palabra\n  if (nombreEspecialidad.includes(' ')) {\n    nombreEspecialidad = nombreEspecialidad.split(' ')[0];\n  }\n  \n  // Crear el title con formato: ESPECIALIDAD-CODIGO\n  let title = `${nombreEspecialidad}-${codigo}`;\n  \n  // Si a√∫n es muy largo, cortar a 24 caracteres\n  if (title.length > 24) {\n    title = title.substring(0, 21) + '...';\n  }\n  \n  // Crear descripci√≥n completa\n  let description = especialidad;\n  \n  // WhatsApp permite M√ÅXIMO 72 caracteres en ROW_DESCRIPTION\n  if (description.length > 72) {\n    description = description.substring(0, 69) + '...';\n  }\n  \n  return {\n    id: codigo,\n    title: title,\n    description: description\n  };\n});\n\n// Dividir en dos bloques\nconst primerBloque = todasLasRows.slice(0, 9);\nconst segundoBloque = todasLasRows.slice(9);\n\n// Seleccionar qu√© bloque mostrar\nlet rows;\nlet headerText;\nlet bodyText;\nlet nuevoEstado;\n\nif (esVerMas) {\n  // SEGUNDO BLOQUE (VER M√ÅS)\n  rows = segundoBloque;\n  headerText = \"üìã M√ÅS ESPECIALIDADES\";\n  bodyText = \"*Estas son las especialidades restantes:*\\n\\nüëá *SELECCION√Å LA ESPECIALIDAD QUE NECESIT√ÅS*\\n\\nLuego podr√°s elegir el m√©dico y horario disponible.\";\n  nuevoEstado = 'TURNOS:ESPECIALIDADES:VER_MAS';\n  \n  // Agregar bot√≥n \"VOLVER\" para regresar al primer bloque\n  rows.push({\n    id: \"volver-especialidades-anterior\",\n    title: \"‚¨ÖÔ∏è VER ANTERIORES\",\n    description: \"Regresar a las primeras especialidades\"\n  });\n  \n  console.log('‚úÖ Mostrando segundo bloque:', segundoBloque.length, 'especialidades + bot√≥n VOLVER');\n} else {\n  // PRIMER BLOQUE (con bot√≥n VER M√ÅS)\n  rows = primerBloque;\n  headerText = \"ü©∫ ESPECIALIDADES\";\n  bodyText = \"*‚ö†Ô∏è TURNOS ESPECIALES*\\n\\nLos siguientes m√©dicos asignan turnos *MES A MES:*\\n\\n‚Ä¢ *_HONAINE_*\\n‚Ä¢ *_PEDERSOLI_*\\n‚Ä¢ *_COSTA MARIANO_*\\n‚Ä¢ *_GENONI_*\\n\\nüìû Contact√° a:\\n*221 4906310*\\n(Administraci√≥n)\\n\\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n\\n*¬øQUER√âS VER LAS ESPECIALIDADES?*\\nüëá *MARC√Å ABAJO*\";\n  nuevoEstado = 'TURNOS:ESPECIALIDADES';\n  \n  // Agregar bot√≥n \"VER M√ÅS\" solo si hay m√°s especialidades\n  if (segundoBloque.length > 0) {\n    rows.push({\n      id: \"ver-mas\",\n      title: \"‚ûï VER M√ÅS ESPECIALIDADES\",\n      description: \"Ver m√°s opciones disponibles\"\n    });\n    console.log('‚úÖ Mostrando primer bloque:', primerBloque.length, 'especialidades + bot√≥n VER M√ÅS');\n  } else {\n    console.log('‚úÖ Mostrando todas las especialidades:', rows.length, '(no hay bot√≥n VER M√ÅS)');\n  }\n}\n\n// Retornar el JSON completo con la estructura de WhatsApp\nreturn [{\n  json: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: contactNumber,\n    type: \"interactive\",\n    interactive: {\n      type: \"list\",\n      header: {\n        type: \"text\",\n        text: headerText\n      },\n      body: {\n        text: bodyText\n      },\n      footer: {\n        text: \"üìÖ LUN-VIE 8-20HS\"\n      },\n      action: {\n        button: \"VER ESPECIALIDADES\",\n        sections: [\n          {\n            title: \"ELEGIR UNA OPCI√ìN\",\n            rows: rows\n          }\n        ]\n      }\n    },\n    \n    // Metadatos para el siguiente nodo\n    contactNumber: contactNumber,\n    estadoActual: nuevoEstado,\n    bloqueActual: esVerMas ? 'segundo' : 'primero',\n    totalEspecialidades: todasLasRows.length\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2944,2128],"id":"4dad46f7-d089-4132-ac06-31544e13ef73","name":"LISTA_ESPECIALIDADES_BLOQUES"},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"mhwp4qt6r2d7ymm","returnAll":true,"options":{"fields":[],"where":"=(Codigo,eq,{{ $('Preparar Redis').item?.json?.metadata?.codigoEspecialidad || $('ESPECIALIDAD').item.json.especialidad }})"}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[2720,2288],"id":"312dbdd7-2289-4225-b4ef-898085f4a4d4","name":"get_medicos2","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"operation":"set","key":"=status:{{ $('LISTA_MEDICOS').item.json.to }}","value":"={{ $('LISTA_MEDICOS').first().json.estadoActual }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3392,2288],"id":"771e9987-58ee-4d27-9955-613e7f441408","name":"ü©∫ MEDICOS2","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"const items = $input.all();\n\nlet contactNumber;\ntry {\n  contactNumber = $('msg_clasificador').first().json.contactNumber;\n} catch (e) {\n  try {\n    contactNumber = $('ROUTER PRINCIPAL').first().json.contactNumber;\n  } catch (e2) {\n    try {\n      contactNumber = $('SWITCH GESTI√ìN TURNOS').first().json.contactNumber;\n    } catch (e3) {\n      contactNumber = items[0]?.json?.contactNumber || $json.contactNumber;\n    }\n  }\n}\n\nlet estadoActual;\nlet especialidadSeleccionada;\nlet codigoEspecialidad;\nlet paginaActual = 1;\n\ntry {\n  const clasificador = $('msg_clasificador').first().json;\n  estadoActual = clasificador.estadoActual || clasificador.nuevoEstado || 'TURNOS:MEDICOS';\n  especialidadSeleccionada = clasificador.metadata?.especialidad || 'Especialidad';\n  codigoEspecialidad = clasificador.metadata?.codigoEspecialidad || '';\n  paginaActual = clasificador.metadata?.paginaMedicos || 1;\n} catch (e) {\n  estadoActual = $json.estadoActual || $json.nuevoEstado || 'TURNOS:MEDICOS';\n  especialidadSeleccionada = $json.especialidad || 'Especialidad';\n  codigoEspecialidad = $json.codigoEspecialidad || '';\n  paginaActual = $json.metadata?.paginaMedicos || 1;\n}\n\nconst totalMedicos = items.length;\nlet totalPaginas, indiceInicio, indiceFin, medicosPorPagina;\nlet esPrimeraPagina, esUltimaPagina, esPaginaIntermedia;\n\nif (totalMedicos <= 9) {\n  totalPaginas = 1;\n  indiceInicio = 0;\n  indiceFin = totalMedicos;\n  medicosPorPagina = totalMedicos;\n  esPrimeraPagina = true;\n  esUltimaPagina = true;\n  esPaginaIntermedia = false;\n} else {\n  const medicosRestantes = totalMedicos - 9;\n  const paginasAdicionales = Math.ceil(medicosRestantes / 8);\n  totalPaginas = 1 + paginasAdicionales;\n  \n  esPrimeraPagina = (paginaActual === 1);\n  esUltimaPagina = (paginaActual === totalPaginas);\n  esPaginaIntermedia = !esPrimeraPagina && !esUltimaPagina;\n  \n  if (esPrimeraPagina) {\n    indiceInicio = 0;\n    indiceFin = 9;\n    medicosPorPagina = 9;\n  } else {\n    indiceInicio = 9 + ((paginaActual - 2) * 8);\n    \n    if (esUltimaPagina) {\n      indiceFin = totalMedicos;\n      medicosPorPagina = indiceFin - indiceInicio;\n    } else {\n      indiceFin = indiceInicio + 8;\n      medicosPorPagina = 8;\n    }\n  }\n}\n\nconst medicosBloque = items.slice(indiceInicio, indiceFin);\n\nconst rows = medicosBloque.map((item, index) => {\n  const medico = item.json.Medico;\n  const matricula = item.json.Matricula;\n  const especialidad = item.json.Especialidad || item.json.especialidad || '';\n  \n  const indiceGlobal = indiceInicio + index;\n  const idUnico = `med-${matricula}-${indiceGlobal}`;\n  \n  let nombreCompleto = medico.toUpperCase();\n  \n  if (nombreCompleto.includes('(')) {\n    nombreCompleto = nombreCompleto.split('(')[0].trim();\n  }\n  \n  if (nombreCompleto.includes('/')) {\n    nombreCompleto = nombreCompleto.split('/')[0].trim();\n  }\n  \n  const palabras = nombreCompleto.split(' ');\n  let apellido = palabras[0];\n  \n  const matriculaStr = String(matricula);\n  const separador = '-';\n  const espacioDisponible = 24 - matriculaStr.length - separador.length;\n  \n  if (apellido.length > espacioDisponible) {\n    apellido = apellido.substring(0, espacioDisponible);\n  }\n  \n  let title = `${apellido}${separador}${matriculaStr}`;\n  \n  if (title.length > 24) {\n    title = title.substring(0, 24);\n  }\n  \n  let description = medico.toUpperCase();\n  \n  if (especialidad && especialidad.trim() !== '') {\n    description = `${description} - ${especialidad}`;\n  }\n  \n  if (description.length > 72) {\n    description = description.substring(0, 69) + '...';\n  }\n  \n  return {\n    id: idUnico,\n    title: title,\n    description: description\n  };\n});\n\nconst botonesNavegacion = [];\n\nif (totalMedicos > 9) {\n  if (esPrimeraPagina && !esUltimaPagina) {\n    botonesNavegacion.push({\n      id: 'ver-mas-medicos',\n      title: `‚ûï VER M√ÅS (${paginaActual + 1})`,\n      description: `Ver p√°gina ${paginaActual + 1} de ${totalPaginas}`\n    });\n  } else if (esPaginaIntermedia) {\n    botonesNavegacion.push({\n      id: 'ver-anteriores-medicos',\n      title: `‚¨ÖÔ∏è ANTERIORES (${paginaActual - 1})`,\n      description: `Volver a p√°gina ${paginaActual - 1}`\n    });\n    botonesNavegacion.push({\n      id: 'ver-mas-medicos',\n      title: `‚ûï VER M√ÅS (${paginaActual + 1})`,\n      description: `Ver p√°gina ${paginaActual + 1} de ${totalPaginas}`\n    });\n  } else if (esUltimaPagina && !esPrimeraPagina) {\n    botonesNavegacion.push({\n      id: 'volver-inicio-medicos',\n      title: '‚¨ÖÔ∏è INICIO',\n      description: 'Ver primera p√°gina'\n    });\n  }\n}\n\nconst rowsFinales = [...rows, ...botonesNavegacion];\n\nif (rowsFinales.length > 10) {\n  throw new Error(`ERROR: Se excedi√≥ el l√≠mite de 10 filas. Total: ${rowsFinales.length}`);\n}\n\nlet bodyText;\nif (totalPaginas === 1) {\n  bodyText = `*‚úÖ ${totalMedicos} M√âDICO${totalMedicos > 1 ? 'S' : ''} DISPONIBLE${totalMedicos > 1 ? 'S' : ''}*\\n\\n*ü©∫ ESPECIALIDAD:*\\n${especialidadSeleccionada}\\n\\n*üëá SELECCION√Å TU PROFESIONAL:*`;\n} else {\n  const rangoInicio = indiceInicio + 1;\n  const rangoFin = indiceFin;\n  bodyText = `*üë®‚Äç‚öïÔ∏è PROFESIONALES DISPONIBLES*\\n\\n*ü©∫ ESPECIALIDAD:*\\n${especialidadSeleccionada}\\n\\n*üìÑ P√ÅGINA ${paginaActual} DE ${totalPaginas}*\\n*üìã MOSTRANDO ${rangoInicio}-${rangoFin} DE ${totalMedicos} M√âDICOS*\\n\\n*üëá SELECCION√Å TU PROFESIONAL:*`;\n}\n\nreturn [{\n  json: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: contactNumber,\n    type: \"interactive\",\n    interactive: {\n      type: \"list\",\n      header: {\n        type: \"text\",\n        text: \"üë®‚Äç‚öïÔ∏è PROFESIONALES\"\n      },\n      body: {\n        text: bodyText\n      },\n      footer: {\n        text: \"üìÖ LUN-VIE 8-20HS\"\n      },\n      action: {\n        button: \"VER M√âDICOS\",\n        sections: [\n          {\n            title: \"ELEGIR PROFESIONAL\",\n            rows: rowsFinales\n          }\n        ]\n      }\n    },\n    contactNumber: contactNumber,\n    estadoActual: 'TURNOS:MEDICOS',\n    categoria: 'LISTA_MEDICOS',\n    metadata: {\n      especialidad: especialidadSeleccionada,\n      codigoEspecialidad: codigoEspecialidad,\n      paginaMedicos: paginaActual,\n      totalPaginas: totalPaginas,\n      totalMedicos: totalMedicos,\n      medicosMostrados: medicosBloque.length\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2944,2288],"id":"fdaeecf8-68fd-469e-91c8-ad63b52ceeef","name":"LISTA_MEDICOS"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.recipient_type }}"},{"name":"to","value":"={{ $json.to }}"},{"name":"type","value":"={{ $json.type }}"},{"name":"interactive","value":"={{ $json.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3168,2288],"id":"a28b0df7-b765-4f76-a4c5-f52181ca2138","name":"Medicos2","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"workflowId":{"__rl":true,"value":"kmoVJGP4RL3PTi16","mode":"list","cachedResultName":"SUB - HORARIOS_TURNOS_PROXIMOS"},"workflowInputs":{"mappingMode":"defineBelow","value":{"matricula":"={{ $('Preparar Redis').first().json.value.parseJson().metadata.matricula.toNumber()  }}","dni":"={{ $('PACIENTE').item.json.paciente.paciente_dni.toNumber() }}","fechaDesde":"={{ $now.toISO().toDateTime().format('yyyyMMdd').toNumber()}}"},"matchingColumns":[],"schema":[{"id":"matricula","displayName":"matricula","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"fechaDesde","displayName":"fechaDesde","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[3152,3024],"id":"3f556893-104b-43b7-93aa-4c4031c00cc3","name":"üìÖ Horarios Proximos"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json?.body?.messaging_product || $json.messaging_product }}"},{"name":"recipient_type","value":"={{ $json?.body?.recipient_type || $json.recipient_type }}"},{"name":"to","value":"={{ $('msg_clasificador').first().json.contactNumber }}"},{"name":"type","value":"={{ $json?.body?.type || $json.type }}"},{"name":"interactive","value":"={{ $json?.body?.interactive || $json.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3568,3024],"id":"b7c5706b-3a46-41f4-8acc-d3e403322021","name":"üïê Fechas disponibles ","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"jsCode":"// ============================================\n// üìÖ LISTA DE HORARIOS DISPONIBLES\n// ============================================\n// Muestra lista interactiva con horarios disponibles\n// ============================================\n\n// Obtener todos los horarios del input\nconst fechasLibres = $input.first().json.fechas_libres;\n\n// Obtener DNI (de varias fuentes)\nlet dni = null;\ntry {\n  dni = Number($input.first().json.DNI || $input.first().json.dni);\n  console.log('‚úÖ DNI obtenido:', dni);\n} catch (e) {\n  console.log('‚ö†Ô∏è No se encontr√≥ DNI en $input');\n}\n\n// Obtener matr√≠cula (de varias fuentes)\nlet matricula = null;\ntry {\n  matricula = Number($input.first().json.matricula);\n  console.log('‚úÖ Matr√≠cula obtenida:', matricula);\n} catch (e) {\n  console.log('‚ö†Ô∏è No se encontr√≥ matr√≠cula en $input');\n}\n\n// Obtener m√©dico (opcional, para logs)\nlet medico = null;\ntry {\n  medico = $input.first().json.medico || $input.first().json.medicoSeleccionado;\n  console.log('‚úÖ M√©dico obtenido:', medico);\n} catch (e) {\n  console.log('‚ö†Ô∏è No se encontr√≥ m√©dico en $input');\n}\n\n// Obtener especialidad seleccionada (para volver a elegir m√©dico)\nlet especialidadSeleccionada = null;\nlet codigoEspecialidad = null;\n\ntry {\n  especialidadSeleccionada = $input.first().json.especialidadSeleccionada;\n  codigoEspecialidad = $input.first().json.codigoEspecialidad;\n  console.log('‚úÖ Especialidad:', especialidadSeleccionada, '- C√≥digo:', codigoEspecialidad);\n} catch (e) {\n  console.log('‚ö†Ô∏è No se encontr√≥ especialidad en $input');\n}\n\n// Si no se encontr√≥, buscar en Redis\nif (!especialidadSeleccionada || !codigoEspecialidad) {\n  try {\n    const redisValue = $('ESPECIALIDAD').first().json.value;\n    const redisData = typeof redisValue === 'string' ? JSON.parse(redisValue) : redisValue;\n    \n    if (redisData && redisData.metadata) {\n      especialidadSeleccionada = redisData.metadata.especialidadSeleccionada;\n      codigoEspecialidad = redisData.metadata.codigoEspecialidad;\n      console.log('‚úÖ Especialidad desde Redis:', especialidadSeleccionada, '- C√≥digo:', codigoEspecialidad);\n    }\n  } catch (e) {\n    console.log('‚ö†Ô∏è No se pudo obtener especialidad desde Redis');\n  }\n}\n\n// Obtener contactNumber (de varias fuentes posibles)\nlet contactNumber = null;\ntry {\n  // Opci√≥n 1: Desde $input\n  contactNumber = $input.first().json.contactNumber;\n} catch (e) {\n  console.log('‚ö†Ô∏è No se encontr√≥ contactNumber en $input');\n}\n\n// Opci√≥n 2: Desde PREPARAR_DATOS_HORARIOS\nif (!contactNumber) {\n  try {\n    contactNumber = $('PREPARAR_DATOS_HORARIOS').first().json.contactNumber;\n  } catch (e) {\n    console.log('‚ö†Ô∏è No se encontr√≥ contactNumber en PREPARAR_DATOS_HORARIOS');\n  }\n}\n\n// Opci√≥n 3: Desde Redis\nif (!contactNumber) {\n  try {\n    const redisValue = $('ESPECIALIDAD').first().json.value;\n    const redisData = typeof redisValue === 'string' ? JSON.parse(redisValue) : redisValue;\n    contactNumber = redisData.contactNumber;\n  } catch (e) {\n    console.log('‚ö†Ô∏è No se encontr√≥ contactNumber en Redis');\n  }\n}\n\n// Opci√≥n 4: Desde DATOS\nif (!contactNumber) {\n  try {\n    contactNumber = $('GET_PACIENTE_REGISTRADO').first().json.contactNumber;\n  } catch (e) {\n    console.log('‚ö†Ô∏è No se encontr√≥ contactNumber en DATOS');\n  }\n}\n\nconsole.log('üì± Contact Number:', contactNumber);\n\n// Si no hay fechas disponibles, devolver mensaje con botones\nif (!fechasLibres || fechasLibres.length === 0) {\n  console.log('‚ùå No hay fechas disponibles');\n  console.log('üìã Preparando opciones de navegaci√≥n...');\n  console.log('   Especialidad:', especialidadSeleccionada);\n  console.log('   C√≥digo:', codigoEspecialidad);\n  console.log('   M√©dico sin turnos:', medico);\n  \n  return [{\n    json: {\n      // Mensaje de WhatsApp\n      body: {\n        messaging_product: \"whatsapp\",\n        recipient_type: \"individual\",\n        to: contactNumber,\n        type: \"interactive\",\n        interactive: {\n          type: \"button\",\n          header: {\n            type: \"text\",\n            text: \"‚ùå SIN TURNOS DISPONIBLES\"\n          },\n          body: {\n            text: `*LO SENTIMOS, EL DR/A ${medico || 'SELECCIONADO/A'} NO TIENE TURNOS DISPONIBLES EN ESTE MOMENTO*\\n\\n*¬øQU√â DESEAS HACER?*\\n\\n*üë®‚Äç‚öïÔ∏è ELEGIR OTRO M√âDICO*\\n‚Üí VER OTROS PROFESIONALES DE ${especialidadSeleccionada || 'LA ESPECIALIDAD'}\\n\\n*üìû CONTACTAR ADMINISTRACI√ìN*\\n‚Üí *(0221) 490-6310*\\n‚Üí *LUN-VIE 8-20HS*`\n          },\n          footer: {\n            text: \"‚ù§Ô∏è CUIDAMOS TU SALUD CARDIOVASCULAR\"\n          },\n          action: {\n            buttons: [\n              {\n                type: \"reply\",\n                reply: {\n                  id: \"elegir-otro-medico\",\n                  title: \"ELEGIR OTRO M√âDICO\"\n                }\n              },\n              {\n                type: \"reply\",\n                reply: {\n                  id: \"menu-principal\",\n                  title: \"MENU PRINCIPAL\"\n                }\n              }\n            ]\n          }\n        }\n      },\n      \n      // Estado y metadata para Redis\n      categoria: 'SIN_TURNOS',\n      contactNumber: contactNumber,\n      DNI: dni,\n      estadoActual: 'TURNOS:SIN_HORARIOS',  // ‚¨ÖÔ∏è NUEVO ESTADO\n      metadata: {\n        dni: dni,\n        especialidadSeleccionada: especialidadSeleccionada,\n        codigoEspecialidad: codigoEspecialidad,\n        medicoSinTurnos: medico,  // Guardar qu√© m√©dico no ten√≠a turnos\n        matriculaSinTurnos: matricula\n      }\n    }\n  }];\n}\n\nconsole.log(`‚úÖ Fechas disponibles: ${fechasLibres.length}`);\n\n// Limitar a m√°ximo 9 horarios\nconst fechasLimitadas = fechasLibres.slice(0, 9);\n\n// Crear mapeo de horarios con Unix timestamp\nconst horariosMap = {};\n\n// Crear el array de rows din√°micamente\nconst rows = fechasLimitadas.map(item => {\n  // Obtener la fecha y hora del formato \"2025-10-14,\\n 11:20\"\n  const fechaHoraRaw = item.fecha_y_hora;\n  \n  // Limpiar y separar fecha y hora\n  const [fecha, hora] = fechaHoraRaw.replace(/\\n/g, '').split(',').map(s => s.trim());\n  \n  // Crear objeto DateTime\n  const dt = DateTime.fromISO(`${fecha}T${hora}`, { \n    zone: 'America/Argentina/Buenos_Aires' \n  });\n  \n  // Obtener d√≠a de la semana en espa√±ol\n  const diasSemana = ['DOM', 'LUN', 'MAR', 'MI√â', 'JUE', 'VIE', 'S√ÅB'];\n  const diaSemana = diasSemana[dt.weekday % 7];\n  \n  // Formatear fecha como DD/MM\n  const fechaFormateada = dt.toFormat('dd/MM');\n  \n  // Crear el title: D√çA DD/MM - HH:MM\n  let title = `${diaSemana} ${fechaFormateada} - ${hora}`;\n  \n  // Si a√∫n es muy largo, cortar a 24 caracteres\n  if (title.length > 24) {\n    title = title.substring(0, 21) + '...';\n  }\n  \n  // Crear descripci√≥n completa EN MAY√öSCULAS\n  let description = `${diaSemana} ${dt.toFormat('dd/MM/yyyy')} A LAS ${hora} HS`;\n  \n  // WhatsApp permite M√ÅXIMO 72 caracteres en ROW_DESCRIPTION\n  if (description.length > 72) {\n    description = description.substring(0, 69) + '...';\n  }\n  \n  // ID √∫nico: combinar fecha y hora sin separadores\n  const id = `${fecha.replace(/-/g, '')}-${hora.replace(/:/g, '')}`;\n  \n  // Convertir a Unix timestamp (milisegundos)\n  const fechaUnix = dt.toMillis();\n  \n  // Convertir hora a formato HHMM (string de 4 d√≠gitos)\n  const horaFormato = hora.replace(':', '').padStart(4, '0');\n  \n  // Guardar en el mapa para uso posterior\n  horariosMap[id] = {\n    fechaUnix: fechaUnix,           // Unix timestamp en ms\n    hora: horaFormato,               // \"1540\" formato HHMM\n    fechaOriginal: fecha,            // \"2025-10-14\"\n    horaOriginal: hora,              // \"15:40\"\n    title: title                     // Para mostrar al usuario\n  };\n  \n  return {\n    id: id,\n    title: title,\n    description: description\n  };\n});\n\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\nconsole.log('‚úÖ Lista de horarios generada');\nconsole.log(`üìã Cantidad de horarios: ${rows.length}`);\nconsole.log('üìÖ Mapa de horarios:', JSON.stringify(horariosMap, null, 2));\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n\n// Retornar el JSON completo con la estructura de WhatsApp\nreturn [{\n  json: {\n    // Mensaje de WhatsApp\n    body: {\n      messaging_product: \"whatsapp\",\n      recipient_type: \"individual\",\n      to: contactNumber,\n      type: \"interactive\",\n      interactive: {\n        type: \"list\",\n        header: {\n          type: \"text\",\n          text: \"üè• TURNOS DISPONIBLES\"\n        },\n        body: {\n          text: `*ENCONTRAMOS ${fechasLimitadas.length} TURNO${fechasLimitadas.length > 1 ? 'S' : ''} DISPONIBLE${fechasLimitadas.length > 1 ? 'S' : ''}*\\n\\n*üìÖ SELECCION√Å LA FECHA Y HORA DE TU PREFERENCIA*\\n\\nüëá *TOC√Å EL BOT√ìN PARA VER LOS HORARIOS*`\n        },\n        footer: {\n          text: \"‚ù§Ô∏è ICLP - INSTITUTO CARDIOL√ìGICO\"\n        },\n        action: {\n          button: \"VER TURNOS\",\n          sections: [\n            {\n              title: \"SELECCIONAR TURNO\",\n              rows: rows\n            }\n          ]\n        }\n      }\n    },\n    \n    // Estado y metadata para Redis\n    categoria: 'MOSTRAR_HORARIOS',\n    contactNumber: contactNumber,\n    DNI: dni,  // ‚¨ÖÔ∏è PASAR DNI AL SIGUIENTE NODO\n    matricula: matricula,  // ‚¨ÖÔ∏è PASAR MATR√çCULA AL SIGUIENTE NODO\n    estadoActual: 'TURNOS:HORARIOS',  // ‚¨ÖÔ∏è ESTADO CLAVE\n    metadata: {\n      dni: dni,                           // ‚¨ÖÔ∏è DNI\n      matricula: matricula,                // ‚¨ÖÔ∏è MATR√çCULA\n      medico: medico,                      // ‚¨ÖÔ∏è M√âDICO\n      horariosMap: horariosMap,            // ‚¨ÖÔ∏è MAPEO DE HORARIOS CON UNIX TIMESTAMP\n      cantidadHorarios: fechasLimitadas.length\n    }\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3344,3024],"id":"311c734b-6cf5-4fc3-af64-d7a1d403fc8c","name":"üïê LISTA-HORARIOS"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"4d1b9696-f935-4e73-91ea-ff5b6429ad5e","leftValue":"={{ $json.contactNumber === \n'+5492254596618'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-5120,1744],"id":"36c588a4-5deb-4b96-ac0c-f8c027db6a4a","name":"If1"},{"parameters":{"method":"POST","url":"={{ $('Variables').item.json.chatwootUrl }}/api/v1/accounts/{{ $('Variables').item.json.accountId }}/conversations/{{ $('Variables').item.json.conversationId }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('Variables').item.json.agenteBotTokenWhatsapp }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"content","value":"=üõ†Ô∏èüè• ESTAMOS TRABAJANDO EN LA AUTOMATIZACI√ìN DE LA CL√çNICA\n‚òéÔ∏è *ADMINISTRACI√ìN:* 221 490 6310\nü§ù DISCULP√Å LAS MOLESTIAS"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-4848,1760],"id":"915cb316-1859-42eb-862c-41316dd08659","name":"sendRespondCw1"},{"parameters":{"jsCode":"// ============================================\n// REDIS GET - PARSER\n// ============================================\n// Parsea el JSON almacenado en Redis para extraer:\n// - status (estadoActual)\n// - metadata (codigoEspecialidad, dni, etc.)\n// ============================================\n\nconst redisOutput = $input.first().json.status; // Viene del nodo Redis GET\n\nlet estado = null;\nlet metadata = {};\n\n// Si Redis devuelve algo, parsearlo\nif (redisOutput) {\n  try {\n    // Intentar parsear como JSON\n    const parsed = JSON.parse(redisOutput);\n    estado = parsed.status || null;\n    metadata = parsed.metadata || {};\n    \n    console.log('‚úÖ Redis parseado correctamente');\n    console.log('üìä Estado:', estado);\n    console.log('üì¶ Metadata:', JSON.stringify(metadata));\n  } catch (e) {\n    // Si no es JSON v√°lido, usar el valor directo como estado\n    console.log('‚ö†Ô∏è Redis no es JSON, usando valor directo');\n    estado = redisOutput;\n    metadata = {};\n  }\n} else {\n  console.log('‚ÑπÔ∏è Redis vac√≠o (primera conversaci√≥n)');\n  estado = null;\n  metadata = {};\n}\n\n// Retornar en formato que msg_clasificador espera\nreturn [{\n  json: {\n    status: estado,           // Estado actual para el clasificador\n    metadata: metadata,       // Metadata preservado\n    contactNumber: $('Filtro Tipo Mensaje').first().json.contactNumber\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-3552,1632],"id":"b4bea300-1492-471b-b11a-036be81f7f40","name":"Parsear Redis"},{"parameters":{"jsCode":"// ============================================\n// REDIS SET - PREPARADOR\n// ============================================\nconst contactNumber = $json.contactNumber;\nconst estadoActual = $json.estadoActual || $json.nuevoEstado;\nconst metadata = $json.metadata || {};\n\n// ============================================\n// VALIDACI√ìN CORRECTA DEL PACIENTE\n// ============================================\nconst datosPacienteRedis = $('PACIENTE').first().json.paciente;\n\nconst pacienteRegistrado = datosPacienteRedis !== null && \n                          datosPacienteRedis !== undefined &&\n                          Object.keys(datosPacienteRedis || {}).length > 0;\n\nconst datosCliente = pacienteRegistrado ? datosPacienteRedis : null;\n\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\nconsole.log('üîç VALIDACI√ìN DE PACIENTE');\nconsole.log('üì• Datos recibidos:', JSON.stringify(datosPacienteRedis));\nconsole.log('‚úÖ ¬øEst√° registrado?:', pacienteRegistrado);\nconsole.log('üë§ Datos cliente:', datosCliente ? JSON.stringify(datosCliente) : 'null');\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n\n// ============================================\n// EXTRACCI√ìN DE MATR√çCULA DEL M√âDICO\n// ============================================\nlet mensajeOriginal = $input.first().json.mensaje;\nlet mensajeProcesado = mensajeOriginal;\nconst categoria = $input.first().json.categoria;\n\n// Si la categor√≠a es SELECCION_MEDICO y el mensaje tiene formato TEXTO-NUMEROS\nif (categoria === 'SELECCION_MEDICO' && mensajeOriginal) {\n  // Regex para extraer solo los n√∫meros despu√©s del guion\n  const regex = /^[A-Z]+-(\\d+)$/i;\n  const match = mensajeOriginal.match(regex);\n  \n  if (match && match[1]) {\n    mensajeProcesado = match[1]; // Solo la matr√≠cula\n    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n    console.log('üë®‚Äç‚öïÔ∏è EXTRACCI√ìN DE MATR√çCULA');\n    console.log('üìù Mensaje original:', mensajeOriginal);\n    console.log('üÜî Matr√≠cula extra√≠da:', mensajeProcesado);\n    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n  }\n}\n\n// Construir el valor a guardar en Redis\nconst redisValue = JSON.stringify({\n  status: estadoActual,\n  metadata: metadata,\n  timestamp: new Date().toISOString()\n});\n\nconst redisKey = `status:${contactNumber}`;\n\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\nconsole.log('üíæ PREPARANDO DATOS PARA REDIS');\nconsole.log('üîë Key:', redisKey);\nconsole.log('üìä Estado:', estadoActual);\nconsole.log('üìÇ Categor√≠a:', categoria);\nconsole.log('üí¨ Mensaje procesado:', mensajeProcesado);\nconsole.log('üè• Paciente Registrado:', pacienteRegistrado);\nconsole.log('üì¶ Metadata:', JSON.stringify(metadata));\nconsole.log('üíø Valor completo:', redisValue);\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n\n// Retornar TODOS los datos\nreturn [{\n  json: {\n    // Datos para Redis SET\n    key: redisKey,\n    value: redisValue,\n    ttl: 600,\n    \n    // Estado del paciente (VALIDADO CORRECTAMENTE)\n    pacienteRegistrado: pacienteRegistrado,\n    datosCliente: datosCliente,\n    \n    // Datos del clasificador\n    categoria: categoria,\n    mensaje: mensajeProcesado,  // Mensaje procesado (matr√≠cula si aplica)\n    mensajeOriginal: mensajeOriginal,  // Guardamos el original tambi√©n\n    contactNumber: contactNumber,\n    estadoActual: estadoActual,\n    estadoAnterior: $json.estadoAnterior,\n    metadata: metadata,\n    nuevoEstado: estadoActual,\n    \n    // Alias para compatibilidad\n    redisKey: redisKey,\n    redisValue: estadoActual,\n    _context: $json._context || {}\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-2944,1632],"id":"0c02572a-f0a8-48ba-a9e5-2f711e0ad94b","name":"Preparar Redis"},{"parameters":{"httpMethod":"POST","path":"agentes/v1/iclp","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-6256,1392],"id":"52e732e6-7030-426a-9875-6ca361d1795d","name":"Entrada","webhookId":"e943f66a-f2ce-4bfc-9ca9-1159266dc23a"},{"parameters":{"operation":"set","key":"=status:{{ $('msg1').item.json.body.to }}","value":"={{ $('msg1').item.json.estadoActual }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3200,1552],"id":"d17c1e75-4609-4efe-8268-56fa82bbeaba","name":"STATUS:MENU=","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"// ============================================\n// MENSAJE: SELECCIONAR TIPO DE TURNO\n// ============================================\n// Muestra las opciones: Turnos Consultorio o Turnos Estudio\n// ============================================\n\nconst contactNumber = $json.contactNumber;\n\n// Mensaje con botones para elegir tipo de turno\nconst mensajeBody = {\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": contactNumber,\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ü´Ä INSTITUTO DE CARDIOLOG√çA LA PLATA\"\n    },\n    \"body\": {\n      \"text\": \"Recuerda que MOMENT√ÅNEAMENTE SOLO DAMOS LOS TURNOS M√ÅS PR√ìXIMOS\\n\\nSi necesita una fecha m√°s lejana elija la opci√≥n de administraci√≥n\"\n    },\n    \"footer\": {\n      \"text\": \"üìÖ Lun-Vie 8-20hs\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"con-consultorio\",\n            \"title\": \"TURNOS CONSULTORIO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"con-estudio\",\n            \"title\": \"TURNOS ESTUDIO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"volver-atras\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n};\n\n// Log\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\nconsole.log('üìÖ SELECCIONAR TIPO DE TURNO');\nconsole.log('üì± Destinatario:', contactNumber);\nconsole.log('üéØ Estado: TURNOS:TIPO_TURNO');\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n\n// Retornar\nreturn [{\n  json: {\n    body: mensajeBody,\n    categoria: 'INICIAR_TOMAR_TURNO',\n    contactNumber: contactNumber,\n    estadoActual: 'TURNOS:TIPO_TURNO'\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2752,1552],"id":"9c1b2942-7765-422c-91d7-d91140bb2f34","name":"msg1"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.body.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.body.recipient_type }}"},{"name":"to","value":"={{ $json.body.to }}"},{"name":"type","value":"={{ $json.body.type }}"},{"name":"interactive","value":"={{ $json.body.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2976,1376],"id":"23c66cab-7263-48a0-847d-307fb8976859","name":"[MENU] - GESTION MIS TURNOS","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.body.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.body.recipient_type }}"},{"name":"to","value":"={{ $json.body.to }}"},{"name":"type","value":"={{ $json.body.type }}"},{"name":"interactive","value":"={{ $json.body.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2976,1552],"id":"3e36ec28-2413-4db4-838b-8096a2bab6a5","name":"[MENU] - TURNOS","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"delete","key":"status:+5492254596618"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-4256,2336],"id":"74fc8e07-c769-45b8-ba77-1763945b0b46","name":"Redis1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"categoria-validar-dni","leftValue":"={{ $json.categoria === 'INGRESO_DNI '|| $json.categoria === 'SOLICITAR_DNI' || $json.estadoAnterior === 'PACIENTE_REGISTRADO_ERROR' ||  $json.estadoActual.includes('DATOS:DNI_VALIDADO:') }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"üîç VALIDAR DNI (IA)"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"menu-inicial","leftValue":"={{ $json.mensaje === 'MEN√ö PRINCIPAL' || $json.mensaje === 'MENU PRINCIPAL' || $('msg_clasificador').item.json.categoria === 'MENU_INICIAL' || $json.categoria === 'fallback' && $json.estadoAnterior !== 'PACIENTE_NUEVO_ERROR'}}","rightValue":"MENU_INICIAL","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"üè† MENU INICIAL"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"nav-turnos","leftValue":"={{ $json.categoria === 'NAV_TURNOS' && $json.pacienteRegistrado === false ||  $json.categoria ==='TURNO_CONSULTORIO' && $json.mensaje.includes('hola')}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"üìÖ NAVEGACI√ìN TURNOS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"nav-info","leftValue":"={{ $json.categoria }}","rightValue":"NAV_INFO","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"‚ÑπÔ∏è NAVEGACI√ìN INFO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"nav-admin","leftValue":"={{ $json.categoria }}","rightValue":"NAV_ADMIN","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"üè¢ ADMINISTRACI√ìN"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"derivar-humano","leftValue":"={{ $json.categoria }}","rightValue":"DERIVAR_HUMANO","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"üë§ DERIVAR HUMANO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"gestion-turnos","leftValue":"={{ ['NUEVO_PACIENTE', 'PACIENTE_REGISTRADO', 'INICIAR_TOMAR_TURNO', 'CONFIRMAR_DATOS_DNI', 'INICIAR_CANCELAR_TURNO', 'LISTAR_MIS_TURNOS', 'TURNO_CONSULTORIO', 'TURNO_ESTUDIO', 'VER_MAS_ESPECIALIDADES', 'VER_MAS_MEDICOS', 'SELECCION_ESPECIALIDAD', 'SELECCION_MEDICO', 'SELECCION_HORARIO', 'TOMAR_TURNO', 'CANCELAR_TURNO', 'MIS_TURNOS', 'VOLVER_MEDICOS', 'EJECUTAR_POST_TURNO','ELIMINAR_TURNO'].includes($json.categoria) || $json.mensaje === 'PACIENTE REGISTRADO' || $json.mensaje ==='CONTINUAR' && $json.estadoAnterior === 'PACIENTE_NUEVO' ||$json.mensaje ==='CONTINUAR' && $json.estadoAnterior === 'PACIENTE_NUEVO_REGISTRADO'  || $json.estadoAnterior === 'PACIENTE_REGISTRADO_ERROR' || $json.pacienteRegistrado && $('msg_clasificador').item.json.categoria === 'NAV_TURNOS' || $json.mensaje ==='MIS TURNOS' ||$json.categoria === 'EJECUTAR_CANCELACION_TURNO' }}","rightValue":"","operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"renameOutput":true,"outputKey":"üé´ GESTI√ìN TURNOS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"datos-paciente","leftValue":"={{ ['INGRESO_DNI', 'INGRESO_DATOS_PACIENTE'].includes($json.categoria) || $json.estadoAnterior ==='PACIENTE_NUEVO_ERROR' || $json.mensaje === 'CANCELAR TURNO' }}","rightValue":"","operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"renameOutput":true,"outputKey":"üìù DATOS PACIENTE"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"confirmaciones","leftValue":"={{ $json.categoria.includes('CONFIRMAR') || $json.categoria.includes('CONTINUAR') }}","rightValue":"","operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"renameOutput":true,"outputKey":"‚úÖ CONFIRMACIONES"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"info-opciones","leftValue":"={{ $json.categoria.startsWith('INFO_') || $json.mensaje.includes('INFO GENERAL')}}","rightValue":"","operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"renameOutput":true,"outputKey":"üí° INFO OPCIONES"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"volver","leftValue":"={{ $json.categoria }}","rightValue":"VOLVER_ATRAS","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"‚¨ÖÔ∏è VOLVER"}]},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-2288,1504],"id":"8b8c2a0f-7035-4493-9815-ec171c23ac31","name":"üîÄ ROUTER PRINCIPAL"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":1},"conditions":[{"id":"confirmar-datos-dni","leftValue":"={{ $json.categoria === 'CONFIRMAR_DATOS_DNI' || $json.pacienteRegistrado === true && $json.categoria !== 'TOMAR_TURNO' }}","rightValue":"CONFIRMAR_DATOS_DNI","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"üìã MEN√ö GESTI√ìN TURNOS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":1},"conditions":[{"id":"tomar-turno-menu","leftValue":"={{ $json.categoria === 'TOMAR_TURNO' ||$json.estadoAnterior === 'PACIENTE_NUEVO_REGISTRADO' &&  $json.mensaje === 'CONTINUAR'  }}","rightValue":"TOMAR_TURNO","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"ü©∫ MEN√ö TIPO TURNO"}]},"options":{"looseTypeValidation":true}},"id":"72017d3a-a4f0-4b67-a0c3-6db916e616da","name":"SWITCH: Tipo Men√∫ Tomar Turno","type":"n8n-nodes-base.switch","typeVersion":3,"position":[2432,1472]},{"parameters":{"operation":"set","key":"=status:{{ $('Variables').first().json.contactNumber }}","value":"PACIENTE_REGISTRADO_ERROR","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[480,16],"id":"664d8d63-09bd-4d02-b740-ded25fbc7b49","name":"DATO_INCORRECTO","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"// Obtener datos del nodo DATOS_PACIENTE\nconst inputData = $('DATOS_PACIENTE').first().json.Datos;\nconsole.log('Input completo:', JSON.stringify(inputData, null, 2));\n\n// Parsear datos si es string\nconst datosParsed = typeof inputData === 'string' ? JSON.parse(inputData) : inputData;\n\n// Extraer DNI\nconst dni = Number(datosParsed.paciente_dni);\nconsole.log('DNI final:', dni);\n\n// Validar que se encontr√≥ el DNI\nif (!dni || isNaN(dni)) {\n  throw new Error('No se pudo encontrar el DNI en los datos de entrada');\n}\n\n// Extraer nombre completo\nconst nombre_completo = datosParsed.paciente_nombre;\nconsole.log('Nombre completo:', nombre_completo);\n\n// Extraer celular\nconst celular_paciente = datosParsed.paciente_celular;\nconsole.log('Celular:', celular_paciente);\n\n// Obtener la matr√≠cula completa del input (ROGGIERO-16118)\nconst matriculaCompleta = $('MATRICULA').first().json.matricula;\nconsole.log('Matr√≠cula completa:', matriculaCompleta);\n\n// Separar por gui√≥n para obtener m√©dico y matr√≠cula\nconst partes = matriculaCompleta.split('-');\n\n// Extraer el NOMBRE del m√©dico (ROGGIERO)\nconst medico = partes[0].trim();\nconsole.log('M√©dico:', medico);\n\n// Extraer solo el N√öMERO de matr√≠cula (16118)\nconst matricula = Number(partes[1].trim());\nconsole.log('Matr√≠cula extra√≠da:', matricula);\n\n// Obtener el horario del nodo Filter1 (MI√â 22/10 - 15:40)\nconst horarioCompleto = $('Filter1').first().json.message;\nconsole.log('Horario completo:', horarioCompleto);\n\n// Extraer fecha y hora del formato \"MI√â 22/10 - 15:40\"\nconst partesFechaHora = horarioCompleto.split(' - ');\nconst partesFecha = partesFechaHora[0].split(' ')[1]; // \"22/10\"\nconst horaOriginal = partesFechaHora[1]; // \"15:40\"\n\n// Convertir fecha \"22/10\" a Unix timestamp (milisegundos)\nconst [dia, mes] = partesFecha.split('/');\nconst anio = new Date().getFullYear(); // 2025\n\n// Crear fecha en formato ISO con zona horaria de Argentina\nconst fechaISO = `${anio}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}T00:00:00.000-03:00`;\nconst fecha = new Date(fechaISO).getTime();\nconsole.log('Fecha en Unix (ms):', fecha);\n\n// Convertir hora \"15:40\" a \"1540\" o \"08:20\" a \"0820\" (mantener como string con 4 d√≠gitos)\nconst hora = horaOriginal.replace(':', '').padStart(4, '0');\nconsole.log('Hora convertida:', hora);\n\n// Retornar el resultado en el formato solicitado\nreturn [{\n  json: {\n    datos: {\n      dni: dni,\n      fecha: fecha,\n      hora: hora,\n      nombre_completo: nombre_completo,\n      celular_paciente: celular_paciente,\n      medico: medico,\n      matricula: matricula\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[560,2640],"id":"51bcd7f8-4776-4cc7-b88e-c450e6778a1d","name":"Code2"},{"parameters":{"operation":"get","propertyName":"matricula","key":"=MEDICO:{{ $('Filter1').first().json.contactNumber.replace('+', '') }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[336,2640],"id":"03df6dfc-ba13-48d2-b1b5-b104af92098a","name":"MATRICULA","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Filtro Tipo Mensaje').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"üíô CENTRO CARDIOL√ìGICO\"\n    },\n    \"body\": {\n      \"text\": \"*_CONFIRMACI√ìN DE TURNO_*\\n\\n*ü©∫ DATOS DEL TURNO:*\\n\\n‚ù§Ô∏è *M√âDICO CARDI√ìLOGO*\\nDR./DRA. {{ $('datos').item.json.datos.parseJson().medico }} \\n\\nüìÜ *FECHA DE ATENCI√ìN*\\n{{ $('üîÄ SWITCH GESTI√ìN TURNOS').first().json.mensaje }}\\n\\n*üíô POR FAVOR, CONFIRM√Å TU ASISTENCIA*\"\n    },\n    \"footer\": {\n      \"text\": \"‚ù§Ô∏è TU SALUD CARDIOVASCULAR ES PRIORIDAD\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"si-confirmo\",\n            \"title\": \"CONFIRMAR TURNO\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"volver-atras\",\n            \"title\": \"MENU PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3376,3248],"id":"47c52f68-f2fb-4625-bd2f-69b5ca382d65","name":"üìÖ Confirmar turno","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=turno:{{ $('Filter1').first().json.contactNumber }}","value":"={{ JSON.stringify($json.datos) }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[784,2640],"id":"2d085b3d-4350-4a30-9609-db0b9680a67d","name":"Datos para confirmar turno","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"=Datos","key":"=DATOS_PACIENTE:","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[112,2640],"id":"c33a9367-7166-48fa-9dca-11fd76bfd869","name":"DATOS_PACIENTE","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=status:{{ $('msg_clasificador').item.json.contactNumber }}","value":"TURNOS:CONFIRMAR","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3824,3248],"id":"3de811f9-dfdc-4f87-b02e-d2a4f6b56cc2","name":"Redis2","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=status:{{ $('msg_clasificador').first().json.contactNumber }}","value":"={{ $('üïê LISTA-HORARIOS').item.json.estadoActual }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3792,3024],"id":"3183f402-cb85-47e8-8686-b71533e868cb","name":"ü©∫ FECHA","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"$('üîÄ SWITCH GESTI√ìN TURNOS1').first().json.mensaje\n\n$input.first().json.DNI"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-112,2640],"id":"d5757e0a-be18-4c32-8c71-f21f5d14b5ba","name":"PREPARAR_CONFIRMAR_TURNO"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"nuevo-paciente","leftValue":"={{ $json.categoria }}","rightValue":"NUEVO_PACIENTE","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"‚ûï NUEVO PACIENTE"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"paciente-registrado","leftValue":"={{ $json.categoria === '' || $json.mensaje === 'PACIENTE REGISTRADO'}}","rightValue":"PACIENTE_REGISTRADO","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"‚úÖ PACIENTE REGISTRADO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"tomar-turno","leftValue":"={{ ['INICIAR_TOMAR_TURNO', 'CONFIRMAR_DATOS_DNI', 'TOMAR_TURNO'].includes($json.categoria) || $json.estadoAnterior === 'PACIENTE_NUEVO_REGISTRADO' && $json.mensaje === 'CONTINUAR' || $json.mensaje === 'TOMAR TURNO' || $json.pacienteRegistrado === true && $json.mensaje !== 'TURNOS CONSULTORIO' && $json.mensaje !== 'TURNOS ESTUDIO' && $json.categoria !== 'SELECCION_ESPECIALIDAD' && $json.categoria !== 'SELECCION_MEDICO' && $json.categoria !== 'SELECCION_HORARIO' && $json.categoria !== 'CANCELAR_TURNO' && \n$json.categoria !== 'EJECUTAR_POST_TURNO' &&\n$json.categoria !== 'ELIMINAR_TURNO' && \n$json.categoria !== 'VER_MAS_ESPECIALIDADES' &&\n$json.categoria !== 'TURNO_CONSULTORIO' &&\n$json.mensaje !== 'MIS TURNOS' &&\n$json.categoria !== 'EJECUTAR_CANCELACION_TURNO'  }}","rightValue":"","operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"renameOutput":true,"outputKey":"üìÖ TOMAR TURNO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"listar-turnos","leftValue":"={{ ['LISTAR_MIS_TURNOS', 'MIS_TURNOS'].includes($json.categoria) }}","rightValue":"","operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"renameOutput":true,"outputKey":"üìã MIS TURNOS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"turno-consultorio","leftValue":"={{ $json.categoria }}","rightValue":"TURNO_CONSULTORIO","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"ü©∫ TURNO CONSULTORIO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"turno-estudio","leftValue":"={{ $json.categoria === 'TURNO_ESTUDIO' ||  $json.categoria === 'TURNO_CONSULTORIO' && $json.mensaje ==='TURNOS ESTUDIO'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"üî¨ TURNO ESTUDIO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"ver-mas-especialidades","leftValue":"={{ $json.categoria }}","rightValue":"VER_MAS_ESPECIALIDADES","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"‚ûï VER M√ÅS ESPECIALIDADES"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"ver-mas-medicos","leftValue":"={{ $json.categoria === 'VER_MAS_MEDICOS' || $json.mensaje.includes('‚ûï VER M√ÅS') }}","rightValue":"VER_MAS_MEDICOS","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"‚ûï VER M√ÅS M√âDICOS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"seleccion-especialidad","leftValue":"={{ ['SELECCION_ESPECIALIDAD', 'VOLVER_MEDICOS'].includes($json.categoria) }}","rightValue":"","operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"renameOutput":true,"outputKey":"ü©∫ SELECCI√ìN ESPECIALIDAD"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"seleccion-medico","leftValue":"={{ $json.categoria }}","rightValue":"SELECCION_MEDICO","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"üë®‚Äç‚öïÔ∏è SELECCI√ìN M√âDICO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"seleccion-horario","leftValue":"={{ $json.categoria }}","rightValue":"SELECCION_HORARIO","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"‚è∞ SELECCI√ìN HORARIO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"ee3917ed-5fc7-444d-a6b3-6b6c0a7daaaa","leftValue":"={{ $json.categoria }}","rightValue":"EJECUTAR_POST_TURNO","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"EJECUTAR TURNO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"8764b955-7499-4f00-8106-de7eae17539b","leftValue":"={{ $json.categoria === 'ELIMINAR_TURNO' && $json.estadoAnterior ==='CANCELAR-TURNO' && $json.mensaje !== 'MIS TURNOS' || $json.categoria === 'EJECUTAR_CANCELACION_TURNO' && $json.mensaje ==='MIS TURNOS'}}","rightValue":"ELIMINAR_TURNO","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"‚ùå ELIMINAR TURNO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"cancelar-turno","leftValue":"={{ ['INICIAR_CANCELAR_TURNO', 'CANCELAR_TURNO'].includes($json.categoria) || $json.mensaje === 'CANCELAR TURNO' }}","rightValue":"","operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"renameOutput":true,"outputKey":"‚ùå CANCELAR TURNO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"cac1d24c-59e0-47e8-92cb-a70111fc41d6","leftValue":"={{ $json.mensaje === 'MIS TURNOS' }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"MIS TURNOS"}]},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[928,1456],"id":"c8554a58-11db-4eb3-8f54-fe55d26e97ed","name":"üîÄ SWITCH GESTI√ìN TURNOS"},{"parameters":{"operation":"get","propertyName":"datos","key":"=DATOS_TURNO:{{ $('msg_clasificador').item.json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2720,3472],"id":"0969c7e8-6c08-4a65-97ac-ddc926e2fd77","name":"Datos para confirmar turno1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"workflowId":{"__rl":true,"value":"e7UD4t6GrwYxGW6Q","mode":"list","cachedResultName":"SUB - POST_TURNO"},"workflowInputs":{"mappingMode":"defineBelow","value":{"dni":"={{ $('PACIENTE').first().json.paciente.paciente_dni }}","fecha":"={{ DateTime.fromFormat($json.datos.parseJson().fecha.toString(), 'yyyyMMdd').toMillis() }}","hora":"={{ $json.datos.parseJson().hora }}","nombre_completo":"={{ $json.datos.parseJson().nombre }}","celular_paciente":"={{ $json.datos.parseJson().celular }}","matricula":"={{ $json.datos.parseJson().matricula.toNumber() }}","celuar_whatsapp":"={{ $('msg_clasificador').first().json.contactNumber }}"},"matchingColumns":[],"schema":[{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"fecha","displayName":"fecha","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"hora","displayName":"hora","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"nombre_completo","displayName":"nombre_completo","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"celular_paciente","displayName":"celular_paciente","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"matricula","displayName":"matricula","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false},{"id":"celuar_whatsapp","displayName":"celuar_whatsapp","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":true,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[2944,3472],"id":"f2c8f5a0-504c-434f-bcea-7a62e393f4b5","name":"EJECUTAR TURNO"},{"parameters":{"operation":"get","propertyName":"datos","key":"=DATOS_TURNO:{{ $json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2720,3248],"id":"01508e7f-dd9a-4467-b1ae-0f50ee4f136e","name":"datos","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=PACIENTE_REGISTRADO:{{ $('Variables').first().json.contactNumber }}","value":"={{ $('Get_Paciente1').item.json.output}}","expire":true,"ttl":3600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1200,464],"id":"08526ff9-f8f6-473c-adda-06d09e2d46b8","name":"PACIENTE_REGISTRADO","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"PACIENTE","key":"=PACIENTE_REGISTRADO:{{ $('msg_clasificador').item.json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3152,3248],"id":"10bb6c9f-a502-483e-bd4b-9ce653eb9db4","name":"DATOS_PACIENTE_REGISTRADO","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"// ============================================\n// PREPARADOR DE TURNO - SOLUCI√ìN BASADA EN IMAGEN\n// ============================================\n\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\nconsole.log('üîç INICIO - Debugging de Matr√≠cula');\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n\n// ============================================\n// 1. INTENTAR M√öLTIPLES FORMAS DE ACCEDER A DATOS\n// ============================================\nconst matricula_paciente = $('datos').first().json.datos.matricula;\nlet datosBase = null;\n\nconsole.log('\\nüìä INTENTANDO ACCEDER AL NODO datos:');\n\n// Intento 1: Acceso directo a .json\ntry {\n    datosBase = $('datos').first().json;\n    console.log('‚úÖ Intento 1 - $(\"datos\").first().json:');\n    console.log(JSON.stringify(datosBase, null, 2));\n    console.log('   Matr√≠cula:', datosBase.matricula);\n} catch (e) {\n    console.log('‚ùå Intento 1 fall√≥:', e.message);\n}\n\n// Intento 2: Acceso con .json.datos\nif (!datosBase || !datosBase.matricula) {\n    try {\n        datosBase = $('datos').first().json.datos;\n        console.log('‚úÖ Intento 2 - $(\"datos\").first().json.datos:');\n        console.log(JSON.stringify(datosBase, null, 2));\n        console.log('   Matr√≠cula:', datosBase.matricula);\n    } catch (e) {\n        console.log('‚ùå Intento 2 fall√≥:', e.message);\n    }\n}\n\n// Intento 3: Desde el primer item\nif (!datosBase || !datosBase.matricula) {\n    try {\n        datosBase = $('datos').item(0).json;\n        console.log('‚úÖ Intento 3 - $(\"datos\").item(0).json:');\n        console.log(JSON.stringify(datosBase, null, 2));\n        console.log('   Matr√≠cula:', datosBase.matricula);\n    } catch (e) {\n        console.log('‚ùå Intento 3 fall√≥:', e.message);\n    }\n}\n\n// Intento 4: Acceso con all()\nif (!datosBase || !datosBase.matricula) {\n    try {\n        const todosLosDatos = $('datos').all();\n        if (todosLosDatos && todosLosDatos.length > 0) {\n            datosBase = todosLosDatos[0].json;\n            console.log('‚úÖ Intento 4 - $(\"datos\").all()[0].json:');\n            console.log(JSON.stringify(datosBase, null, 2));\n            console.log('   Matr√≠cula:', datosBase.matricula);\n        }\n    } catch (e) {\n        console.log('‚ùå Intento 4 fall√≥:', e.message);\n    }\n}\n\n// Verificar si obtuvimos los datos\nif (!datosBase) {\n    console.log('üö® ERROR CR√çTICO: No se pudieron obtener los datos del nodo');\n    throw new Error('No se pudo acceder al nodo datos');\n}\n\nconsole.log('\\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\nconsole.log('‚úÖ DATOS BASE OBTENIDOS:');\nconsole.log('   DNI:', datosBase.dni);\nconsole.log('   Matr√≠cula:', datosBase.matricula);\nconsole.log('   M√©dico:', datosBase.medico);\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n\n// Si la matr√≠cula a√∫n es null, intentar extraerla del m√©dico\nlet matriculaFinal = datosBase.matricula;\n\nif (!matriculaFinal || matriculaFinal === null || matriculaFinal === 'null') {\n    console.log('\\n‚ö†Ô∏è Matr√≠cula es null, intentando extraer del m√©dico...');\n    \n    if (datosBase.medico) {\n        const match = datosBase.medico.match(/-(\\d+)$/);\n        if (match) {\n            matriculaFinal = match[1];\n            console.log('‚úÖ Matr√≠cula extra√≠da del m√©dico:', matriculaFinal);\n        }\n    }\n    \n    if (!matriculaFinal && datosBase.medicoSeleccionado) {\n        const match = datosBase.medicoSeleccionado.match(/-(\\d+)$/);\n        if (match) {\n            matriculaFinal = match[1];\n            console.log('‚úÖ Matr√≠cula extra√≠da del medicoSeleccionado:', matriculaFinal);\n        }\n    }\n}\n\nconsole.log('\\nüéØ MATR√çCULA FINAL:', matriculaFinal);\n\n// ============================================\n// 2. OBTENER DATOS DEL PACIENTE\n// ============================================\n\nconst pacienteData = $('DATOS_PACIENTE_REGISTRADO').first().json.PACIENTE;\nconst nombrePaciente = pacienteData.paciente_nombre;\nconst celularPaciente = pacienteData.paciente_celular;\nconst dni_paciente = pacienteData.paciente_dni;\n\n\n// 3. EXTRAER FECHA Y HORA DEL MENSAJE\n// ============================================\n\nconsole.log('\\nüìÖ EXTRAYENDO FECHA Y HORA:');\n\nconst mensajeHora = $('msg_clasificador').first().json.mensaje;\nconsole.log('   Mensaje:', mensajeHora);\n\nconst fechaHoraMatch = mensajeHora.match(/(\\d{1,2})\\/(\\d{1,2})\\s*-\\s*(\\d{1,2}):(\\d{2})/);\n\nlet fechaLimpia = \"\";\nlet horaLimpia = \"\";\n\nif (fechaHoraMatch) {\n    const dia = fechaHoraMatch[1].padStart(2, '0');\n    const mes = fechaHoraMatch[2].padStart(2, '0');\n    const a√±o = new Date().getFullYear();\n    \n    fechaLimpia = `${a√±o}${mes}${dia}`;\n    \n    const horas = fechaHoraMatch[3].padStart(2, '0');\n    const minutos = fechaHoraMatch[4];\n    horaLimpia = horas + minutos;\n    \n    console.log('   Fecha:', fechaLimpia);\n    console.log('   Hora:', horaLimpia);\n}\n\n// ============================================\n// 4. CREAR OBJETO DE TURNO\n// ============================================\n\nconsole.log('\\nüì¶ CREANDO OBJETO DE TURNO:');\n\nconst dato_turno = {\n    datos_turno: {\n        dni: dni_paciente,\n        fecha: fechaLimpia,\n        celular: celularPaciente,\n        medico: datosBase.medico,\n        matricula: $('matricula').first().json.matricula,\n        medicoSeleccionado: datosBase.medicoSeleccionado,\n        nombre: nombrePaciente,\n        hora: horaLimpia\n    }\n};\n\nconsole.log('\\n‚úÖ OBJETO TURNO FINAL:');\nconsole.log(JSON.stringify(dato_turno, null, 2));\n\nconsole.log('\\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\nconsole.log('‚úÖ FIN DE DEBUGGING');\nconsole.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n\nreturn dato_turno;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3600,3248],"id":"22cb4f46-4e39-4d97-9494-ae07983af4cf","name":"DATOS_COMBINADOS"},{"parameters":{"operation":"get","propertyName":"DATOS_PACIENTE","key":"=PACIENTE_REGISTRADO:{{ $('Variables').first().json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2720,3024],"id":"71cff0fc-35e1-4d57-a1e2-2add2a4e408f","name":"GET_PACIENTE_REGISTRADO","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"// Extraer datos del paciente\nconst nombre = $('GET_PACIENTE_REGISTRADO').first().json.DATOS_PACIENTE.paciente_nombre;\nconst celular = $('GET_PACIENTE_REGISTRADO').first().json.DATOS_PACIENTE.paciente_celular;\nconst dni = $('GET_PACIENTE_REGISTRADO').first().json.DATOS_PACIENTE.paciente_dni;\n\n// Extraer datos del m√©dico\nconst matricula = $('Preparar Redis').first().json.metadata.matricula;\nconst medico = $('Preparar Redis').first().json.metadata.medico;\n\n// Obtener fecha de hoy\nconst fecha = Number(DateTime.now().setZone('America/Argentina/Buenos_Aires').toFormat('yyyyMMdd'));\n\n// Crear objeto JSON final\nconst dato_turno = {\n  datos:{\n    dni: dni,\n    matricula: matricula,\n    fecha: fecha,\n    celular: celular,\n    medico: medico,\n    medicoSeleccionado: medico,\n    nombre: nombre\n  }\n};\n\n// Retornar el objeto\nreturn dato_turno;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[4016,3024],"id":"43afdcb4-f204-46b8-a71f-87301952700c","name":"Code3"},{"parameters":{"operation":"set","key":"=DATOS_TURNO:{{ $('msg_clasificador').item.json.contactNumber }}","value":"={{ JSON.stringify($('DATOS_COMBINADOS').item.json.datos_turno) }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[4048,3248],"id":"210c4c5a-d500-4566-bd89-cbdc761a371b","name":"DATOS_TURNO_PACIENTE","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"url":"http://iclp.ddns.net:7080/ws-turnos-rest-simple/api/turnos/lista-turnos-actuales","sendQuery":true,"queryParameters":{"parameters":[{"name":"usuario","value":"WSTRRED"},{"name":"password","value":"Y2xpb25lcw"},{"name":"dni","value":"={{ $json.DATOS_PACIENTE.paciente_dni }}"},{"name":"fecha","value":"={{ $now.setZone('America/Argentina/Buenos_Aires').toFormat('yyyyLLdd') }}"}]},"options":{"response":{"response":{"neverError":true,"responseFormat":"json"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2960,2784],"id":"eb90130f-aa51-42f0-ad28-95dfb8e63eaa","name":"get_turnos_agendados1"},{"parameters":{"assignments":{"assignments":[{"id":"8c6cf375-6158-46f1-8b42-593cf42fff40","name":"lista","value":"={{ $json.lista[0] }}","type":"object"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[3184,2784],"id":"ed3d787a-5574-41cd-9e62-562169442adf","name":"datos1"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.recipient_type }}"},{"name":"to","value":"={{ $('msg_clasificador').first().json.contactNumber }}"},{"name":"type","value":"={{ $json.type }}"},{"name":"interactive","value":"={{ $json.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3632,2784],"id":"304ffd12-cdf1-4c04-ad94-123b8848311e","name":"MIS TURNOS1","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"jsCode":"// Obtener la lista de turnos\nconst turnos = $input.all();\n\n// Funci√≥n para validar si un turno tiene datos v√°lidos\nfunction turnoValido(turno) {\n  const datos = turno.json.lista || turno.json;\n  \n  // Verificar que tenga al menos fecha y hora v√°lidas\n  const tieneFecha = datos.fechaString && datos.fechaString !== 'Sin fecha' && datos.fechaString.length > 0;\n  const tieneHora = datos.hora5digitos && datos.hora5digitos !== 'Sin hora' && datos.hora5digitos.length > 0;\n  const tieneNombre = datos.nombreMedico && datos.nombreMedico !== 'Sin nombre' && datos.nombreMedico.length > 0;\n  \n  return tieneFecha && tieneHora && tieneNombre;\n}\n\n// Filtrar solo turnos v√°lidos\nconst turnosValidos = turnos.filter(turnoValido);\n\n// Verificar si hay turnos v√°lidos\nif (!turnosValidos || turnosValidos.length === 0) {\n  return [{\n    json: {\n      messaging_product: \"whatsapp\",\n      recipient_type: \"individual\",\n      to:$('DATOS_PACIENTE1').first().json.DATOS_PACIENTE.paciente_celular ,\n      type: \"interactive\",\n      interactive: {\n        type: \"button\",\n        body: {\n          text: \"‚ùå NO TEN√âS TURNOS PROGRAMADOS EN ESTE MOMENTO\"\n        },\n        footer: {\n          text: \"üìÖ Lun-Vie 8-20hs\"\n        },\n        action: {\n          buttons: [\n            {\n              type: \"reply\",\n              reply: {\n                id: \"menu-principal\",\n                title: \"MENU PRINCIPAL\"\n              }\n            }\n          ]\n        }\n      }\n    }\n  }];\n}\n\n// Crear rows para la lista de turnos\nconst rows = [];\n\nfor (let i = 0; i < turnosValidos.length; i++) {\n  const turno = turnosValidos[i].json.lista || turnosValidos[i].json;\n  \n  const fechaString = turno.fechaString;\n  const hora5digitos = turno.hora5digitos;\n  const nombreMedico = turno.nombreMedico;\n  const matricula = turno.matricula || '';\n  \n  // Separar apellido del m√©dico y tipo de estudio\n  const partes = nombreMedico.split(' ');\n  const apellido = partes.length > 1 ? partes[partes.length - 1] : nombreMedico;\n  const tipoEstudio = partes.length > 1 ? partes.slice(0, -1).join(' ') : 'CONSULTA';\n  \n  // Formatear fecha de \"20251016\" a \"16-10-2025\"\n  let fechaFormateada = fechaString;\n  if (fechaString.length === 8) {\n    const a√±o = fechaString.substring(0, 4);\n    const mes = fechaString.substring(4, 6);\n    const dia = fechaString.substring(6, 8);\n    fechaFormateada = `${dia}-${mes}-${a√±o}`;\n  }\n  \n  // Crear title corto (m√°ximo 24 caracteres)\n  let title = `${apellido}-${fechaFormateada}`;\n  if (title.length > 24) {\n    title = title.substring(0, 21) + '...';\n  }\n  \n  // Crear description (m√°ximo 72 caracteres)\n  let description = `${tipoEstudio} - ${hora5digitos}`;\n  if (description.length > 72) {\n    description = description.substring(0, 69) + '...';\n  }\n  \n  // ID √∫nico para el turno (fecha + hora + matricula)\n  const id = `turno-${fechaString}-${hora5digitos.replace(':', '')}-${matricula}`;\n  \n  rows.push({\n    id: id,\n    title: title,\n    description: description\n  });\n}\n\n// Limitar a 9 turnos m√°ximo\nconst rowsLimitados = rows.slice(0, 9);\n\n// Retornar lista interactiva\nreturn [{\n  json: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: $('DATOS_PACIENTE1').first().json.DATOS_PACIENTE.paciente_celular ,\n    type: \"interactive\",\n    interactive: {\n      type: \"list\",\n      header: {\n        type: \"text\",\n        text: \"üóëÔ∏è CANCELAR TURNO\"\n      },\n      body: {\n        text: \"SELECCION√Å EL TURNO QUE QUER√âS CANCELAR\"\n      },\n      footer: {\n        text: \"üìÖ Lun-Vie 8-20hs\"\n      },\n      action: {\n        button: \"VER TURNOS\",\n        sections: [\n          {\n            title: \"TUS TURNOS\",\n            rows: rowsLimitados\n          }\n        ]\n      }\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3408,2784],"id":"4d56ad43-0c5b-4d4f-8d39-035cb475aaa4","name":"üö´ CANCELAR TURNO"},{"parameters":{"operation":"set","key":"=DATOS_MEDICO:{{ $('Parsear Redis').item.json.contactNumber }}","value":"={{ JSON.stringify($('datos1').item.json.lista) }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3856,2784],"id":"2bea77de-0786-4b1d-a97b-2c2c1f2fca55","name":"Datos turnos","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"DATOS_PACIENTE","key":"=PACIENTE_REGISTRADO:{{ $('msg_clasificador').item.json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2736,2784],"id":"e36fb0a6-da0b-4aa8-a694-2cedcaf29aa2","name":"DATOS_PACIENTE1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"content":"###  MUESTRA LAS FECHAS A ELIMINAR SI EXISTEN","height":224,"width":1696,"color":3},"type":"n8n-nodes-base.stickyNote","position":[2688,2720],"typeVersion":1,"id":"093df77c-f881-4026-9e58-8e59fefbdbe0","name":"Sticky Note9"},{"parameters":{"operation":"set","key":"=status:{{ $('Parsear Redis').item.json.contactNumber }}","value":"CANCELAR-TURNO","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[4080,2784],"id":"b167b7e1-8f7d-4bed-bf5a-e0abac3080f4","name":"STATUS=CANCELAR-TURNO","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"=status:{{ $('msg_clasificador').first().json.contactNumber }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3280,2528],"id":"2bdd5fb1-c0d2-4c22-9e75-137fc7feec43","name":"DELETE - STATUS MENU2","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"workflowId":{"__rl":true,"value":"lsdxfv73onWtf115","mode":"list","cachedResultName":"SUB - DELETE TURNO copy"},"workflowInputs":{"mappingMode":"defineBelow","value":{"matricula":"={{ $json.delete.parseJson().matricula }}","fecha":"={{ $json.delete.parseJson().fechaString.toNumber() }}","hora":"={{ $json.delete.parseJson().hora.toNumber() }}","num_conver":"={{ $('Filtro Tipo Mensaje').item.json.conversationId }}","celular":"={{ $('msg_clasificador').item.json.contactNumber }}"},"matchingColumns":[],"schema":[{"id":"matricula","displayName":"matricula","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"fecha","displayName":"fecha","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"hora","displayName":"hora","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"num_conver","displayName":"num_conver","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"celular","displayName":"celular","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[2912,2528],"id":"2755c0eb-0794-4bf6-a737-2f962f534e14","name":"DELETE_TURNO"},{"parameters":{"content":"###  ELIMINAR UN TURNO","height":224,"width":976,"color":3},"type":"n8n-nodes-base.stickyNote","position":[2688,2464],"typeVersion":1,"id":"0fa8ba25-6646-41ab-aa09-2dfdf5e12abc","name":"Sticky Note5"},{"parameters":{"operation":"get","propertyName":"delete","key":"=DATOS_MEDICO:{{ $json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2720,2528],"id":"a8c0655d-c65f-444c-a743-3deed93a5f13","name":"Redis3","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"jsCode":"// Parsear el JSON que viene como string\nconst deleteData = JSON.parse($('Redis3').item.json.delete);\n\n// Convertir fecha Unix (milisegundos) a formato legible DD/MM/YYYY\nconst fechaUnix = deleteData.fecha;\nconst fechaObj = new Date(fechaUnix);\nconst dia = String(fechaObj.getDate()).padStart(2, '0');\nconst mes = String(fechaObj.getMonth() + 1).padStart(2, '0'); // Los meses empiezan en 0\nconst a√±o = fechaObj.getFullYear();\nconst fechaLegible = `${dia}/${mes}/${a√±o}`;\n\n// Convertir hora de \"1540\" a \"15:40\"\nconst horaString = deleteData.hora;\nconst horaLegible = horaString.slice(0, 2) + ':' + horaString.slice(2);\n\n// Retornar todos los datos formateados\nreturn [{\n  json: {\n    matricula: deleteData.matricula,\n    fechaOriginal: deleteData.fecha,\n    fecha: fechaLegible, // \"14/11/2025\"\n    horaOriginal: deleteData.hora,\n    hora: horaLegible, // \"15:40\"\n    horasDigitos: deleteData.horasDigitos,\n    fechaString: deleteData.fechaString,\n    nombreMedico: deleteData.nombreMedico,\n    nombrePaciente: deleteData.nombrePaciente,\n    celular: deleteData.celular,\n    especialidad: deleteData.especialidad,\n    dni: deleteData.dni,\n    obraSocial: deleteData.obraSocial\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3088,2528],"id":"d29fc7bb-b67d-4ed6-ab8a-fbc334c21ada","name":"Code4"},{"parameters":{"workflowId":{"__rl":true,"value":"xBZYzq5pKXYbUGV7","mode":"list","cachedResultName":"SUB - ETIQUETE: TURNO_ESTUDIO"},"workflowInputs":{"mappingMode":"defineBelow","value":{"humano":true,"accountId":"={{ $('Variables').item.json.accountId }}","conversationId":"={{ $('Variables').item.json.conversationId.toString() }}","contactId":"={{ $('Variables').item.json.contactId.toString() }}","message":"={{ $('Variables').item.json.message }}","inboxId":"={{ $('Variables').item.json.inboxId.toString() }}","chatwootUrlBase":"={{ $('Variables').item.json.chatwootUrl }}","tokenChatwoot":"={{ $('Variables').item.json.agenteBotTokenWhatsapp }}","tipoIntencion":"turnos-estudios"},"matchingColumns":[],"schema":[{"id":"accountId","displayName":"accountId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"conversationId","displayName":"conversationId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"contactId","displayName":"contactId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"message","displayName":"message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"inboxId","displayName":"inboxId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"humano","displayName":"humano","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"boolean"},{"id":"chatwootUrlBase","displayName":"chatwootUrlBase","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"tokenChatwoot","displayName":"tokenChatwoot","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"tipoIntencion","displayName":"tipoIntencion","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[2736,1872],"id":"015f8285-afdf-417f-be80-830149b7a071","name":"TURNOS ESTUDIO"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[-368,3344],"id":"fa6ae5fa-6dd4-4a93-9a0e-734ce6d9ea85","name":"OpenRouter Chat Model2","credentials":{"openRouterApi":{"id":"ZlcbniUoDvrFqCIJ","name":"OpenRouter ICLP"}}},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"m1kjf7ed0befl04","returnAll":true,"options":{}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[-816,3120],"id":"e255541d-a772-4489-9a22-090b4cd09b4a","name":"obrasociales","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"jsCode":"return {\n    total: $input.all().length,\n    obrasociales: $input.all().map(item => ({\n        Id_os: item.json.Id,\n        nombre_obrasocial: item.json.nombre_obrasocial,\n        obrasocial: item.json.obrasocial\n    }))\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-592,3120],"id":"14a6af61-e65e-473a-bf96-91ad96287ec9","name":"Code6"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('msg_clasificador').first().json.contactNumber }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"ü´Ä INSTITUTO DE CARDIOLOG√çA LA PLATA\"\n    },\n    \"body\": {\n      \"text\": \"*REGISTRO EXITOSO!* ‚úì\\n\\n*üìã TUS DATOS HAN SIDO GUARDADOS*\\n\\nINFORMACI√ìN REGISTRADA:\\n\\n‚ñ™Ô∏è *NOMBRE:* {{ $json.datos.paciente_nombre }}\\n\\n‚ñ™Ô∏è *DNI:* {{ $json.datos.paciente_dni }}\\n\\n‚ñ™Ô∏è *TEL√âFONO:* {{ $json.datos.paciente_celular }}\\n\\n‚ñ™Ô∏è *OBRA SOCIAL:* {{ $json.datos.nombre_obrasocial }}\\n\\n‚úì *PRESION√Å CONTINUAR PARA GESTIONAR TU TURNO CARDIOL√ìGICO*\\n\\nüí¨ *¬øDETECTASTE ALG√öN ERROR?*\\nCOMUNICATE AL *üìû (0221) 490-6310*\"\n    },\n    \"footer\": {\n      \"text\": \"LUN-VIE 8-20HS | S√ÅB 8-13HS\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"CONTINUAR\",\n            \"title\": \"CONTINUAR\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"MENU-PRINCIPAL\",\n            \"title\": \"MEN√ö PRINCIPAL\"\n          }\n        }\n      ]\n    }\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1008,3328],"id":"acccd95d-1cd8-4e2d-9bb2-c01a835d4c21","name":"‚úÖ DATOS VALIDADOS3","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"delete","key":"={{ $('msg_clasificador').first().json.contactNumber }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1232,3328],"id":"c93d5878-210c-4712-8d34-38949c1ceeb3","name":"ü§ñ RESET AGENTE","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[208,3520],"id":"7c6f510c-6bc5-4b75-90ea-80c03f2737ac","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"mE1IL02M9AnIg3tD","name":"OpenAi Credenciales ICLP"}}},{"parameters":{"workflowId":{"__rl":true,"value":"5yeTNub4mGFgBUpp","mode":"list","cachedResultName":"SUB - POST_PACIENTE"},"workflowInputs":{"mappingMode":"defineBelow","value":{"dni":"={{ $json.output.DNI.toString() }}","paciente":"={{ $json.output.NOMBRE }}","direccion":"={{ $json.output.DIRECCION }}","celular":"={{ $json.output.TELEFONO.toString() }}","obraSocial":"={{ $json.output.OBRA_SOCIAL }}","nombreobrasocial":"={{ $json.output.NOMBRE_OBRA_SOCIAL }}","whatsapp":"={{ $('msg_clasificador').first().json.contactNumber }}"},"matchingColumns":[],"schema":[{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"paciente","displayName":"paciente","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"direccion","displayName":"direccion","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"celular","displayName":"celular","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"obraSocial","displayName":"obraSocial","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"nombreobrasocial","displayName":"nombreobrasocial","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"whatsapp","displayName":"whatsapp","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[480,3216],"id":"bf69119d-39a0-4603-88bc-8c1ee69afa71","name":"POST_PACIENTE"},{"parameters":{"operation":"set","key":"=PACIENTE_REGISTRADO:{{ $('Preparar Redis').first().json.contactNumber }}","value":"={{ JSON.stringify($('POST_PACIENTE').item.json.datos) }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1456,3328],"id":"d7ed2c15-a395-47bb-9255-a8bd09d4a63a","name":"DATOS_PACIENTE REGISTRADO","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=status:{{ $('üîÄ ROUTER PRINCIPAL').first().json.contactNumber }}","value":"PACIENTE_NUEVO_REGISTRADO","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1680,3328],"id":"ced1ccd3-e325-4994-b7f6-33f2c675ff18","name":"STATUS=PACIENTE_NUEVO","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"068a964d-25b6-4a1f-8e05-c47dd2fea4b7","leftValue":"={{ $json.output.ERROR }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[256,3120],"id":"7633cafb-d0bc-4b2d-bbb9-451b91ca422c","name":"Error informacion de usuario1"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('msg_clasificador').first().json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"‚ö†Ô∏è {{ $json.output.ERROR_MESSAGE }}\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[480,3024],"id":"3422346f-6981-4c46-b4ca-7fe74cc3fc68","name":"‚ö†Ô∏è DATOS INCORRECTOS1","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"promptType":"define","text":"={{ $('üîÄ ROUTER PRINCIPAL').first().json.mensaje }}","hasOutputParser":true,"options":{"systemMessage":"=# ROL\nSos un colector/validador de datos cl√≠nicos. Siempre devolv√©s UN √∫nico objeto JSON. Sin texto extra ni markdown. No uses comillas en n√∫meros.\n\n# CONTEXTO\n$OBRAS_SOCIALES := {{ JSON.stringify($json.obrasociales) }}  // usar EXCLUSIVAMENTE este listado\nCada item: { obrasocial: string, nombre_obrasocial: string }\n\n# CONTRATO DE SALIDA\n{\n  \"status\": \"ASK\" | \"FINAL\",\n  \"ask\": \"string\",                      // UNA pregunta breve, natural y amigable por el dato que falta o hay que corregir\n  \"missing\": [\"NOMBRE\",\"DNI\",\"OBRA_SOCIAL\",\"DIRECCION\",\"TELEFONO\"],\n  \"data\": {\n    \"NOMBRE\": \"string\",\n    \"DNI\": number,\n    \"OBRA_SOCIAL\": \"string\",\n    \"NOMBRE_OBRA_SOCIAL\": \"string\",\n    \"DIRECCION\": \"string\",\n    \"TELEFONO\": number\n  },\n  \"ERROR\": true | false,\n  \"ERROR_MESSAGE\": \"string\"\n}\n\n# REGLAS DE CONVERSACI√ìN (ORDEN)\nValid√°/ped√≠ en este orden: NOMBRE ‚Üí DNI ‚Üí OBRA_SOCIAL ‚Üí DIRECCION ‚Üí TELEFONO.\n\n# REGLAS DE ERROR Y MENSAJES\n- En status=\"ASK\":\n  A) **Si existe alg√∫n dato inv√°lido YA PROVISTO** (seg√∫n el orden), entonces:\n     - ERROR=true\n     - ERROR_MESSAGE = mensaje natural y conversacional del primer inv√°lido\n     - ask = pregunta amigable para **corregir ese mismo dato** (no avanzar)\n  B) **Si NO hay inv√°lidos, pero faltan datos**, entonces:\n     - ERROR=true\n     - ERROR_MESSAGE = mensaje natural indicando qu√© datos faltan\n     - ask = pregunta amigable por el **pr√≥ximo** dato faltante (siguiendo el orden)\n- En status=\"FINAL\":\n  - Ejecut√° validaciones estrictas. Si algo falla ‚Üí ERROR=true y ERROR_MESSAGE natural con **solo** el primer error; si todo ok ‚Üí ERROR=false y ERROR_MESSAGE=\"\"\n\n# VALIDACIONES (estrictas, SOLO aplican cuando el campo YA fue provisto; en FINAL se aplican a todos)\n1) NOMBRE: al menos dos palabras alfab√©ticas\n   - error natural: \"Necesito su nombre completo (nombre y apellido) para registrarlo en el sistema\"\n   \n2) DNI: ^\\\\d{7,8}$ (solo n√∫meros, sin puntos/espacios)\n   - error natural: \"El DNI que me pas√≥ no es v√°lido. Por favor, env√≠eme solo los n√∫meros, sin puntos ni espacios (ejemplo: 35946257)\"\n   \n3) OBRA_SOCIAL:\n   - \"no/sin obra social/particular\" ‚áí OBRA_SOCIAL=\"PART\", NOMBRE_OBRA_SOCIAL=\"PARTICULAR\"\n   - nombre informado ‚áí normalizar y buscar en $OBRAS_SOCIALES (exacto o inclusi√≥n); si no hay match ‚Üí \"Disculpe, la obra social que mencion√≥ no figura en nuestro sistema. ¬øPodr√≠a verificar el nombre o indicar si es particular?\"\n   - si no se inform√≥ ‚áí se considera **faltante** (no inv√°lido)\n   \n4) DIRECCION: debe incluir calle y **al menos un d√≠gito**\n   - error natural: \"Me falta la direcci√≥n completa. Por favor, ind√≠queme calle y n√∫mero (ejemplo: Calle 50 N¬∞123)\"\n   \n5) TELEFONO: ^\\\\d{10}$ (solo n√∫meros)\n   - error natural: \"El tel√©fono debe tener 10 d√≠gitos. Por favor, env√≠elo completo con c√≥digo de √°rea, solo n√∫meros (ejemplo: 2214567890)\"\n\n# TONO DE LOS MENSAJES\n- Us√° tratamiento formal (usted) pero amigable\n- S√© conversacional, no rob√≥tico\n- Record√° y reconoc√© los datos que ya ten√©s (\"Perfecto, ya tengo su nombre...\")\n- Cuando pidas el siguiente dato, pod√©s hacer referencia a lo que ya obtuviste\n- Los mensajes deben ser breves pero claros\n\n# FORMATO\n- Strings faltantes = \"\" ; n√∫meros faltantes = 0\n- ERROR = true si falta o est√° inv√°lido **cualquier** campo. ERROR=false solo si los 5 est√°n completos y v√°lidos\n\n# EJEMPLOS (NO IMPRIMIR)\n\n## Caso: usuario solo env√≠a NOMBRE (\"Hector miralles\")\n{\n  \"status\":\"ASK\",\n  \"ask\":\"Perfecto, Hector. Ahora necesito su DNI, por favor (7 u 8 d√≠gitos, sin puntos)\",\n  \"missing\":[\"DNI\",\"OBRA_SOCIAL\",\"DIRECCION\",\"TELEFONO\"],\n  \"data\":{\"NOMBRE\":\"Hector miralles\",\"DNI\":0,\"OBRA_SOCIAL\":\"\",\"NOMBRE_OBRA_SOCIAL\":\"\",\"DIRECCION\":\"\",\"TELEFONO\":0},\n  \"ERROR\": true,\n  \"ERROR_MESSAGE\": \"A√∫n faltan algunos datos: DNI, obra social, direcci√≥n y tel√©fono\"\n}\n\n## Caso: DNI provisto pero con puntos (\"12.345.678\")\n{\n  \"status\":\"ASK\",\n  \"ask\":\"Disculpe, necesito el DNI sin puntos. ¬øPuede enviarlo solo con n√∫meros? Por ejemplo: 12345678\",\n  \"missing\":[\"OBRA_SOCIAL\",\"DIRECCION\",\"TELEFONO\"],\n  \"data\":{\"NOMBRE\":\"Hector miralles\",\"DNI\":0,\"OBRA_SOCIAL\":\"\",\"NOMBRE_OBRA_SOCIAL\":\"\",\"DIRECCION\":\"\",\"TELEFONO\":0},\n  \"ERROR\": true,\n  \"ERROR_MESSAGE\": \"El DNI que me pas√≥ no es v√°lido. Por favor, env√≠eme solo los n√∫meros, sin puntos ni espacios (ejemplo: 35946257)\"\n}\n\n## Caso: Ya tenemos nombre y DNI v√°lido, pedimos obra social\n{\n  \"status\":\"ASK\",\n  \"ask\":\"Excelente. ¬øTiene obra social o es particular?\",\n  \"missing\":[\"OBRA_SOCIAL\",\"DIRECCION\",\"TELEFONO\"],\n  \"data\":{\"NOMBRE\":\"Hector Miralles\",\"DNI\":12345678,\"OBRA_SOCIAL\":\"\",\"NOMBRE_OBRA_SOCIAL\":\"\",\"DIRECCION\":\"\",\"TELEFONO\":0},\n  \"ERROR\": true,\n  \"ERROR_MESSAGE\": \"Me faltan los siguientes datos: obra social, direcci√≥n y tel√©fono\"\n}\n\n## Caso: Obra social no encontrada\n{\n  \"status\":\"ASK\",\n  \"ask\":\"Disculpe, la obra social 'Medicus Plus' no figura en nuestro sistema. ¬øPodr√≠a verificar el nombre exacto o indicarme si es particular?\",\n  \"missing\":[\"DIRECCION\",\"TELEFONO\"],\n  \"data\":{\"NOMBRE\":\"Hector Miralles\",\"DNI\":12345678,\"OBRA_SOCIAL\":\"\",\"NOMBRE_OBRA_SOCIAL\":\"\",\"DIRECCION\":\"\",\"TELEFONO\":0},\n  \"ERROR\": true,\n  \"ERROR_MESSAGE\": \"Disculpe, la obra social que mencion√≥ no figura en nuestro sistema. ¬øPodr√≠a verificar el nombre o indicar si es particular?\"\n}\n\n## FINAL OK (todo completo y v√°lido)\n{\n  \"status\":\"FINAL\",\n  \"ask\":\"\",\n  \"missing\":[],\n  \"data\":{\"NOMBRE\":\"Hector Miralles\",\"DNI\":12345678,\"OBRA_SOCIAL\":\"1\",\"NOMBRE_OBRA_SOCIAL\":\"Ioma\",\"DIRECCION\":\"Calle 50 123\",\"TELEFONO\":2215551234},\n  \"ERROR\": false,\n  \"ERROR_MESSAGE\":\"\"\n}\n\n## Caso: Usuario env√≠a todo junto pero direcci√≥n incompleta\n{\n  \"status\":\"ASK\",\n  \"ask\":\"Casi listo. Me falta el n√∫mero de su direcci√≥n. ¬øEn qu√© n√∫mero de la Calle 50 vive?\",\n  \"missing\":[\"TELEFONO\"],\n  \"data\":{\"NOMBRE\":\"Hector Miralles\",\"DNI\":12345678,\"OBRA_SOCIAL\":\"1\",\"NOMBRE_OBRA_SOCIAL\":\"Ioma\",\"DIRECCION\":\"\",\"TELEFONO\":0},\n  \"ERROR\": true,\n  \"ERROR_MESSAGE\": \"Me falta la direcci√≥n completa. Por favor, ind√≠queme calle y n√∫mero (ejemplo: Calle 50 N¬∞123)\"\n}"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[-304,3120],"id":"b8679df5-af16-4c01-a464-e02120eb7de5","name":"AI Agent1"},{"parameters":{"jsonSchemaExample":"{\n  \"NOMBRE\": \"Juan P√©rez\",\n  \"DNI\": 0,\n  \"OBRA_SOCIAL\": \"724\",\n  \"NOMBRE_OBRA_SOCIAL\": \"Osde\",\n  \"DIRECCION\": \"Calle 50 N 123\",\n  \"TELEFONO\": 2215551234,\n  \"ERROR\": true,\n  \"ERROR_MESSAGE\": \"DNI inv√°lido. Debe tener 7 u 8 d√≠gitos sin puntos (ej: 12345678). Por favor, proporcion√° tu DNI sin puntos.\"\n}","autoFix":true},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-112,3344],"id":"a9538845-7115-44c2-b1ab-f98b217d046f","name":"Structured Output Parser"},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Variables').first().json.contactNumber }}","sessionTTL":600,"contextWindowLength":10},"type":"@n8n/n8n-nodes-langchain.memoryRedisChat","typeVersion":1.5,"position":[-240,3344],"id":"398b78bc-b58c-463d-bec6-187de65a2ff1","name":"Redis Chat Memory1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"content":"## POST TURNO","height":704,"width":1712,"color":5},"type":"n8n-nodes-base.stickyNote","position":[2688,2960],"typeVersion":1,"id":"3066c7bc-9a41-4287-acca-39b23f0446a2","name":"Sticky Note1"},{"parameters":{"content":"## ESPECIALIDADES Y MEDICOS","height":368,"width":976,"color":4},"type":"n8n-nodes-base.stickyNote","position":[2688,2064],"typeVersion":1,"id":"8c43fb6c-6edb-4cf5-ad25-a0a11f2a34c1","name":"Sticky Note4"},{"parameters":{"content":"## TURNOS ESTUDIO","height":288,"width":288,"color":7},"type":"n8n-nodes-base.stickyNote","position":[2688,1760],"typeVersion":1,"id":"36e0a104-dc42-4827-bcc7-933dcf0aa29c","name":"Sticky Note6"},{"parameters":{"operation":"set","key":"=status:{{ $('üîÄ ROUTER PRINCIPAL').first().json.contactNumber }}","value":"PACIENTE_NUEVO_ERROR","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[704,3024],"id":"6bddf718-91ed-4981-b1ba-4306dfcb081d","name":"STATUS=PACIENTE_NUEVO1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"0ff6738a-d69a-4bd6-9e26-fee07ed3e8f5","leftValue":"={{ $json.output.status_verificacion }}","rightValue":"no_encontrado","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[528,368],"id":"d8686278-24ff-4303-9f61-4f3b3d844b46","name":"no_encontrado?"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Variables').first().json.contactNumber }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"‚ö†Ô∏è {{ $('Get_Paciente1').item.json.output.mensaje_usuario }}\"\n  }\n}","options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[752,208],"id":"d83ee14a-604d-4c84-835c-139537aad595","name":"‚ö†Ô∏è DATOS INCORRECTOS2","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Variables').first().json.contactNumber }}","value":"PACIENTE_REGISTRADO_ERROR","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[976,208],"id":"a5e153f0-acad-4b29-b017-357747f87db5","name":"DATO_INCORRECTO1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"paciente","key":"=PACIENTE_REGISTRADO:{{ $('Filtro Tipo Mensaje').item.json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-4336,1632],"id":"e05236c3-329c-4c1f-acd6-836599031ed9","name":"PACIENTE","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"=DATOS_TURNO:{{ $('msg_clasificador').item.json.contactNumber }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3168,3472],"id":"4201baf8-aaac-4dc1-ae6f-27a9e78cfdba","name":"DATOS","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=DATOS_TURNO:{{ $('msg_clasificador').first().json.contactNumber }}","value":"={{ JSON.stringify($json.datos) }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[4240,3024],"id":"5adbc2ba-5ddc-4a2b-9169-9d75ccc1b12f","name":"DATOS1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"assignments":{"assignments":[{"id":"5243c907-4f75-4ea4-b100-d760922caf8d","name":"matricula","value":"={{ $json.datos.parseJson().matricula }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[2928,3248],"id":"6744092f-11d1-4bbe-b4bc-7304b567a63e","name":"matricula"},{"parameters":{"url":"http://iclp.ddns.net:7080/ws-turnos-rest-simple/api/turnos/lista-turnos-actuales","sendQuery":true,"queryParameters":{"parameters":[{"name":"usuario","value":"WSTRRED"},{"name":"password","value":"Y2xpb25lcw"},{"name":"dni","value":"={{ $json.datos.paciente_dni.toNumber() }}"},{"name":"fecha","value":"={{ $now.setZone('America/Argentina/Buenos_Aires').toFormat('yyyyLLdd') }}"}]},"options":{"response":{"response":{"neverError":true,"responseFormat":"json"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2960,3776],"id":"805c41dd-9470-41df-856a-3cedb1811504","name":"get_turnos_agendados2"},{"parameters":{"assignments":{"assignments":[{"id":"8c6cf375-6158-46f1-8b42-593cf42fff40","name":"lista","value":"={{ $json.lista[0] }}","type":"object"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[3184,3776],"id":"0916c59d-3100-4ce8-a179-83ae61261327","name":"datos3"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v24.0/835199793002705/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"messaging_product","value":"={{ $json.messaging_product }}"},{"name":"recipient_type","value":"={{ $json.recipient_type }}"},{"name":"to","value":"={{ $('msg_clasificador').first().json.contactNumber }}"},{"name":"type","value":"={{ $json.type }}"},{"name":"interactive","value":"={{ $json.interactive }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3632,3776],"id":"dd55b621-15a4-42d7-b2de-83658c334c53","name":"MIS TURNOS2","credentials":{"httpHeaderAuth":{"id":"dwoPrvAr64QWLGxK","name":"Whatsapp"}}},{"parameters":{"jsCode":"// Obtener el objeto lista (que es un objeto, no un array)\nconst turno = $input.first().json.lista;\n\n// Verificar si existe el turno\nif (!turno || Object.keys(turno).length === 0) {\n  return [{\n    json: {\n      messaging_product: \"whatsapp\",\n      recipient_type: \"individual\",\n      to: $('GET_PACIENTE1').first().json.datos.paciente_celular,\n      type: \"interactive\",\n      interactive: {\n        type: \"button\",\n        body: {\n          text: \"‚ùå NO TEN√âS TURNOS PROGRAMADOS EN ESTE MOMENTO\"\n        },\n        footer: {\n          text: \"üìÖ Lun-Vie 8-20hs\"\n        },\n        action: {\n          buttons: [\n            {\n              type: \"reply\",\n              reply: {\n                id: \"volver-atras\",\n                title: \"VOLVER ATR√ÅS\"\n              }\n            }\n          ]\n        }\n      }\n    }\n  }];\n}\n\n// Extraer datos del turno\nconst fechaString = turno.fechaString || 'Sin fecha'; // Ejemplo: \"20251016\"\nconst hora5digitos = turno.hora5digitos || 'Sin hora'; // Ejemplo: \"10:20\"\nconst nombreMedico = turno.nombreMedico || 'Sin nombre'; // Ejemplo: \"ERGOMETRIA BARBIERI\"\nconst matricula = turno.matricula || 'Sin matr√≠cula'; // Ejemplo: \"139\"\n\n// Separar apellido del m√©dico y tipo de estudio\n// Ejemplo: \"ERGOMETRIA BARBIERI\" -> apellido=\"BARBIERI\", estudio=\"ERGOMETRIA\"\nconst partes = nombreMedico.split(' ');\nconst apellido = partes.length > 1 ? partes[partes.length - 1] : nombreMedico;\nconst tipoEstudio = partes.length > 1 ? partes.slice(0, -1).join(' ') : 'CONSULTA';\n\n// Formatear fecha de \"20251016\" a \"16-10-2025\"\nlet fechaFormateada = fechaString;\nif (fechaString.length === 8) {\n  const a√±o = fechaString.substring(0, 4);\n  const mes = fechaString.substring(4, 6);\n  const dia = fechaString.substring(6, 8);\n  fechaFormateada = `${dia}-${mes}-${a√±o}`;\n}\n\n// Construir el mensaje con formato mejorado\nconst mensajeTurnos = `üìã *TUS TURNOS PROGRAMADOS:*\\n\\nüë®‚Äç‚öïÔ∏è *Turno con:* Dr. ${apellido} | Matr√≠cula ${matricula}\\nü©∫ *Tipo de estudio:* ${tipoEstudio}\\nüìÖ *Fecha:* ${fechaFormateada} a las ${hora5digitos}`;\n\n// Retornar el mensaje con bot√≥n\nreturn [{\n  json: {\n    messaging_product: \"whatsapp\",\n    recipient_type: \"individual\",\n    to: $('GET_PACIENTE1').first().json.datos.paciente_celular,\n    type: \"interactive\",\n    interactive: {\n      type: \"button\",\n      body: {\n        text: mensajeTurnos\n      },\n      footer: {\n        text: \"üìÖ Lun-Vie 8-20hs\"\n      },\n      action: {\n        buttons: [\n          {\n            type: \"reply\",\n            reply: {\n              id: \"volver-atras\",\n              title: \"VOLVER ATR√ÅS\"\n            }\n          }\n        ]\n      }\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3408,3776],"id":"c32391ff-4f6c-47a1-8a8b-5b7b47f77616","name":"üìã LISTAR TURNOS1"},{"parameters":{"operation":"get","propertyName":"datos","key":"=PACIENTE_REGISTRADO:{{ $('Variables').first().json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2720,3776],"id":"cbca3149-fe56-4b99-80fc-61dca5fdd68c","name":"GET_PACIENTE1","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"content":"## PRESIONAN \"MIS TURNOS\"","height":272,"width":1184,"color":7},"type":"n8n-nodes-base.stickyNote","position":[2688,3680],"typeVersion":1,"id":"b69c4505-861b-4f26-9293-ff1a4b357fa0","name":"Sticky Note7"},{"parameters":{"content":"## MENU\n* MIS TURNOS\n* Turnos estudio-TURNOS CONSULTORIO","height":480,"width":752,"color":2},"type":"n8n-nodes-base.stickyNote","position":[2688,1248],"typeVersion":1,"id":"0713ba16-20e6-4fbb-846a-213341899c85","name":"Sticky Note8"},{"parameters":{"content":"## CREAR PACIENTE O REGISTRARSE","height":464,"width":960,"color":5},"type":"n8n-nodes-base.stickyNote","position":[2688,768],"typeVersion":1,"id":"6832b90c-b150-41bc-8a55-18b011fd9d75","name":"Sticky Note10"},{"parameters":{"operation":"delete","key":"PACIENTE_REGISTRADO:+5492254596618"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-4048,2336],"id":"8cfe18da-e293-46ff-bdbe-1c3dcc80ad1e","name":"Redis4","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"PACIENTE_REGISTRADO:+5492254596618"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3792,2336],"id":"285ff510-cb29-4806-b1d1-72303f98851f","name":"Redis5","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3fd1ef0d-ded2-4bfa-b57f-4d7e151cfabe","leftValue":"={{ $json.statusCode }}","rightValue":"ERROR","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[768,3216],"id":"0a8920d5-2a6a-4009-9458-014810ad98e8","name":"error servidor","executeOnce":false},{"parameters":{"operation":"get","propertyName":"DATOS_TURNO","key":"=status:{{ $('msg_clasificador').item.json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2928,3024],"id":"0ad56f19-4d99-424c-bc1e-4c309751cefc","name":"DATOS_TURNO","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"7d168b67-4edc-44b8-bffa-a59133961fdb","leftValue":"={{ $('msg_clasificador').first().json.mensaje.includes('VER M√ÅS')  }}","rightValue":"=","operator":{"type":"boolean","operation":"true","singleValue":true}},{"id":"259614a6-d4f8-4386-9247-0d159aa32819","leftValue":"={{ $('msg_clasificador').first().json.mensaje.includes('INICIO')  }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"or"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[3616,2288],"id":"46b5f119-2adb-4268-a50e-f5f00584819e","name":"If2"},{"parameters":{"operation":"set","key":"=ESPECIALIDAD_SELECIONADA:{{ $('LISTA_MEDICOS').item.json.to }}","value":"={{ $('Preparar Redis').first().json.metadata.codigoEspecialidad }}","expire":true,"ttl":600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3840,2352],"id":"f45422f7-0a58-4f5d-8d30-5fdb9f8c60bc","name":"ü©∫ ESPECIALIDADES","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"especialidad","key":"=ESPECIALIDAD_SELECIONADA:{{ $('Filtro Tipo Mensaje').item.json.contactNumber }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-4560,1632],"id":"0781861c-306d-4c03-a2c8-c425d0910277","name":"ESPECIALIDAD","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"workflowId":{"__rl":true,"value":"gsbUq8JFSpw8U7yR","mode":"list","cachedResultName":"SUB - ETIQUETA: CONSULTA_RECLAMO"},"workflowInputs":{"mappingMode":"defineBelow","value":{"humano":true,"accountId":"={{ $('Filtro Tipo Mensaje').item.json.accountId }}","conversationId":"={{ $('Filtro Tipo Mensaje').item.json.conversationId.toString() }}","contactId":"={{ $('Filtro Tipo Mensaje').item.json.contactId.toString() }}","message":"={{ $('Filtro Tipo Mensaje').item.json.message }}","inboxId":"={{ $('Filtro Tipo Mensaje').item.json.inboxId.toString() }}","chatwootUrlBase":"={{ $('Filtro Tipo Mensaje').item.json.chatwootUrl }}","tokenChatwoot":"={{ $('Filtro Tipo Mensaje').item.json.agenteBotTokenWhatsapp }}","tipoIntencion":"consultas-reclamos"},"matchingColumns":[],"schema":[{"id":"accountId","displayName":"accountId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"conversationId","displayName":"conversationId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"contactId","displayName":"contactId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"message","displayName":"message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"inboxId","displayName":"inboxId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"humano","displayName":"humano","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"boolean"},{"id":"chatwootUrlBase","displayName":"chatwootUrlBase","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"tokenChatwoot","displayName":"tokenChatwoot","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"tipoIntencion","displayName":"tipoIntencion","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-224,1440],"id":"32c1a273-fbd4-48e4-9dec-d581bbbbb047","name":"ETIQUETA CONSULTA-RECLAMO1"}],"connections":{"Variables":{"main":[[{"node":"Filtrar n√∫meros de prueba","type":"main","index":0}]]},"Filtro Tipo Mensaje":{"main":[[],[{"node":"MSG ENVIADO?","type":"main","index":0}],[{"node":"HTTP Request4","type":"main","index":0}]]},"üîç Get Estado Actual":{"main":[[{"node":"Parsear Redis","type":"main","index":0}]]},"üì± Mensaje Menu Principal":{"main":[[{"node":"üíæ Set Estado MENU","type":"main","index":0}]]},"üíæ Set Estado MENU":{"main":[[{"node":"HTTP Request2","type":"main","index":0}]]},"üé´ Router Gesti√≥n Turnos":{"main":[[{"node":"CREAR PACIENTE","type":"main","index":0}]]},"üì± Mensaje Info General":{"main":[[{"node":"üíæ Set Estado MENU2","type":"main","index":0}]]},"üìÖ Turnos - PACIENTE NUEVO - PACIENTE REGISTRADO - ":{"main":[[{"node":"üíæ Set Estado MENU1","type":"main","index":0}]]},"üíæ Set Estado MENU1":{"main":[[{"node":"HTTP Request3","type":"main","index":0}]]},"‚è±Ô∏è STATUS PRIMERA VEZ":{"main":[[{"node":"HTTP Request5","type":"main","index":0}]]},"CREAR PACIENTE":{"main":[[{"node":"‚è±Ô∏è STATUS PRIMERA VEZ","type":"main","index":0}]]},"üíæ Set Estado MENU2":{"main":[[{"node":"HTTP Request1","type":"main","index":0}]]},"Code":{"main":[[{"node":"üîÄ SWITCH INFO FLUJOS","type":"main","index":0}]]},"Medicos":{"main":[[{"node":"‚è±Ô∏è STATUS PRIMERA VEZ1","type":"main","index":0}]]},"HTTP Request4":{"main":[[{"node":"ESPECIALIDAD","type":"main","index":0}]]},"msg_clasificador":{"main":[[{"node":"Preparar Redis","type":"main","index":0}]]},"üè¢ Administraci√≥n":{"main":[[{"node":"HTTP Request6","type":"main","index":0}]]},"HTTP Request6":{"main":[[{"node":"üíæ Set Estado MENU3","type":"main","index":0}]]},"Filtrar n√∫meros de prueba":{"main":[[{"node":"Filtro Tipo Mensaje","type":"main","index":0}]]},"üíæ Set Estado MENU3":{"main":[[{"node":"ETIQUETA CONSULTA-RECLAMO1","type":"main","index":0}]]},"ETIQUETA CONSULTA-RECLAMO":{"main":[[{"node":"HTTP Request7","type":"main","index":0}]]},"HTTP Request8":{"main":[[{"node":"sendRespondCw","type":"main","index":0}]]},"sendRespondCw":{"main":[[{"node":"contador","type":"main","index":0}]]},"MSG ENVIADO?":{"main":[[{"node":"If","type":"main","index":0}]]},"If":{"main":[[],[{"node":"HTTP Request8","type":"main","index":0}]]},"ESPECIALIDADES2":{"main":[[{"node":"ENVIA-> MENU-SACAR TURNO","type":"main","index":0}]]},"MEDICOS":{"main":[[{"node":"ENVIA-> MENU-SACAR TURNO1","type":"main","index":0}]]},"Msg preparado":{"main":[[{"node":"MEDICOS","type":"main","index":0}]]},"get_medicos1":{"main":[[{"node":"Msg preparado","type":"main","index":0}]]},"get_especialidades":{"main":[[{"node":"Msg preparado1","type":"main","index":0}]]},"Msg preparado1":{"main":[[{"node":"ESPECIALIDADES2","type":"main","index":0}]]},"üîÄ SWITCH INFO FLUJOS":{"main":[[{"node":"get_medicos1","type":"main","index":0}],[{"node":"get_especialidades","type":"main","index":0}],[{"node":"Medicos","type":"main","index":0}]]},"üé´ Router Gesti√≥n Turnos1":{"main":[[{"node":"PACIENTE REGISTRADO","type":"main","index":0}]]},"PACIENTE REGISTRADO":{"main":[[{"node":"‚è±Ô∏è STATUS PRIMERA VEZ2","type":"main","index":0}]]},"‚è±Ô∏è STATUS PRIMERA VEZ2":{"main":[[{"node":"PREPARAR_CONFIRMAR_TURNO","type":"main","index":0}]]},"üîÄ SWITCH DATOS PACIENTE":{"main":[[{"node":"üé´ Router Gesti√≥n Turnos1","type":"main","index":0}],[{"node":"obrasociales","type":"main","index":0}],[{"node":"obrasociales","type":"main","index":0}]]},"PACIENTE REGISTRADO1":{"main":[[{"node":"SOLICITAR DNI","type":"main","index":0}]]},"SOLICITAR DNI":{"main":[[{"node":"‚è±Ô∏è STATUS PRIMERA VEZ3","type":"main","index":0}]]},"Error informacion de usuario":{"main":[[{"node":"‚ö†Ô∏è DATOS INCORRECTOS","type":"main","index":0}],[{"node":"Get_Paciente1","type":"main","index":0}]]},"‚ö†Ô∏è DATOS INCORRECTOS":{"main":[[{"node":"DATO_INCORRECTO","type":"main","index":0}]]},"OpenRouter Chat Model1":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"Structured Output Parser1":{"ai_outputParser":[[{"node":"AI Agent","type":"ai_outputParser","index":0}]]},"AI Agent":{"main":[[{"node":"Error informacion de usuario","type":"main","index":0}]]},"Get_Paciente1":{"main":[[{"node":"no_encontrado?","type":"main","index":0}]]},"‚úÖ DATOS VALIDADOS":{"main":[[{"node":"DNI VERIFICADO","type":"main","index":0}]]},"obra_social1":{"main":[[{"node":"Code8","type":"main","index":0}]]},"Code8":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"Redis Chat Memory":{"ai_memory":[[{"node":"AI Agent","type":"ai_memory","index":0}]]},"DNI VERIFICADO":{"main":[[{"node":"PACIENTE_REGISTRADO","type":"main","index":0}]]},"msg":{"main":[[{"node":"[MENU] - GESTION MIS TURNOS","type":"main","index":0}]]},"ü©ª ESPECIALIDADES1":{"main":[[{"node":"ESPECIALIDADES1","type":"main","index":0}]]},"Get_Especialidades1":{"main":[[{"node":"LISTA_ESPECIALIDADES_BLOQUES","type":"main","index":0}]]},"LISTA_ESPECIALIDADES_BLOQUES":{"main":[[{"node":"ü©ª ESPECIALIDADES1","type":"main","index":0}]]},"get_medicos2":{"main":[[{"node":"LISTA_MEDICOS","type":"main","index":0}]]},"ü©∫ MEDICOS2":{"main":[[{"node":"If2","type":"main","index":0}]]},"LISTA_MEDICOS":{"main":[[{"node":"Medicos2","type":"main","index":0}]]},"Medicos2":{"main":[[{"node":"ü©∫ MEDICOS2","type":"main","index":0}]]},"üìÖ Horarios Proximos":{"main":[[{"node":"üïê LISTA-HORARIOS","type":"main","index":0}]]},"üïê Fechas disponibles ":{"main":[[{"node":"ü©∫ FECHA","type":"main","index":0}]]},"üïê LISTA-HORARIOS":{"main":[[{"node":"üïê Fechas disponibles ","type":"main","index":0}]]},"If1":{"main":[[],[{"node":"sendRespondCw1","type":"main","index":0}]]},"Parsear Redis":{"main":[[{"node":"msg_clasificador","type":"main","index":0}]]},"Preparar Redis":{"main":[[{"node":"üîÄ ROUTER PRINCIPAL","type":"main","index":0}]]},"Entrada":{"main":[[{"node":"Variables","type":"main","index":0}]]},"msg1":{"main":[[{"node":"[MENU] - TURNOS","type":"main","index":0}]]},"[MENU] - GESTION MIS TURNOS":{"main":[[{"node":"STATUS:MENU=1","type":"main","index":0}]]},"[MENU] - TURNOS":{"main":[[{"node":"STATUS:MENU=","type":"main","index":0}]]},"üîÄ ROUTER PRINCIPAL":{"main":[[{"node":"obra_social1","type":"main","index":0}],[{"node":"üì± Mensaje Menu Principal","type":"main","index":0}],[{"node":"üìÖ Turnos - PACIENTE NUEVO - PACIENTE REGISTRADO - ","type":"main","index":0}],[{"node":"üì± Mensaje Info General","type":"main","index":0}],[{"node":"üè¢ Administraci√≥n","type":"main","index":0}],[{"node":"ETIQUETA CONSULTA-RECLAMO","type":"main","index":0}],[{"node":"üîÄ SWITCH GESTI√ìN TURNOS","type":"main","index":0}],[{"node":"üîÄ SWITCH DATOS PACIENTE","type":"main","index":0}],[],[{"node":"Code","type":"main","index":0}]]},"SWITCH: Tipo Men√∫ Tomar Turno":{"main":[[{"node":"msg","type":"main","index":0}],[{"node":"msg1","type":"main","index":0}]]},"Code2":{"main":[[{"node":"Datos para confirmar turno","type":"main","index":0}]]},"MATRICULA":{"main":[[{"node":"Code2","type":"main","index":0}]]},"üìÖ Confirmar turno":{"main":[[{"node":"DATOS_COMBINADOS","type":"main","index":0}]]},"DATOS_PACIENTE":{"main":[[{"node":"MATRICULA","type":"main","index":0}]]},"Redis2":{"main":[[{"node":"DATOS_TURNO_PACIENTE","type":"main","index":0}]]},"ü©∫ FECHA":{"main":[[{"node":"Code3","type":"main","index":0}]]},"PREPARAR_CONFIRMAR_TURNO":{"main":[[{"node":"DATOS_PACIENTE","type":"main","index":0}]]},"üîÄ SWITCH GESTI√ìN TURNOS":{"main":[[{"node":"üé´ Router Gesti√≥n Turnos","type":"main","index":0}],[{"node":"PACIENTE REGISTRADO1","type":"main","index":0}],[{"node":"SWITCH: Tipo Men√∫ Tomar Turno","type":"main","index":0}],[],[{"node":"Get_Especialidades1","type":"main","index":0}],[{"node":"TURNOS ESTUDIO","type":"main","index":0}],[{"node":"Get_Especialidades1","type":"main","index":0}],[{"node":"get_medicos2","type":"main","index":0}],[{"node":"get_medicos2","type":"main","index":0}],[{"node":"GET_PACIENTE_REGISTRADO","type":"main","index":0}],[{"node":"datos","type":"main","index":0}],[{"node":"Datos para confirmar turno1","type":"main","index":0}],[{"node":"Redis3","type":"main","index":0}],[{"node":"DATOS_PACIENTE1","type":"main","index":0}],[{"node":"GET_PACIENTE1","type":"main","index":0}]]},"Datos para confirmar turno1":{"main":[[{"node":"EJECUTAR TURNO","type":"main","index":0}]]},"EJECUTAR TURNO":{"main":[[{"node":"DATOS","type":"main","index":0}]]},"datos":{"main":[[{"node":"matricula","type":"main","index":0}]]},"DATOS_PACIENTE_REGISTRADO":{"main":[[{"node":"üìÖ Confirmar turno","type":"main","index":0}]]},"DATOS_COMBINADOS":{"main":[[{"node":"Redis2","type":"main","index":0}]]},"GET_PACIENTE_REGISTRADO":{"main":[[{"node":"DATOS_TURNO","type":"main","index":0}]]},"Code3":{"main":[[{"node":"DATOS1","type":"main","index":0}]]},"get_turnos_agendados1":{"main":[[{"node":"datos1","type":"main","index":0}]]},"datos1":{"main":[[{"node":"üö´ CANCELAR TURNO","type":"main","index":0}]]},"MIS TURNOS1":{"main":[[{"node":"Datos turnos","type":"main","index":0}]]},"üö´ CANCELAR TURNO":{"main":[[{"node":"MIS TURNOS1","type":"main","index":0}]]},"Datos turnos":{"main":[[{"node":"STATUS=CANCELAR-TURNO","type":"main","index":0}]]},"DATOS_PACIENTE1":{"main":[[{"node":"get_turnos_agendados1","type":"main","index":0}]]},"DELETE_TURNO":{"main":[[{"node":"Code4","type":"main","index":0}]]},"Redis3":{"main":[[{"node":"DELETE_TURNO","type":"main","index":0}]]},"Code4":{"main":[[{"node":"DELETE - STATUS MENU2","type":"main","index":0}]]},"OpenRouter Chat Model2":{"ai_languageModel":[[{"node":"AI Agent1","type":"ai_languageModel","index":0}]]},"obrasociales":{"main":[[{"node":"Code6","type":"main","index":0}]]},"Code6":{"main":[[{"node":"AI Agent1","type":"main","index":0}]]},"‚úÖ DATOS VALIDADOS3":{"main":[[{"node":"ü§ñ RESET AGENTE","type":"main","index":0}]]},"ü§ñ RESET AGENTE":{"main":[[{"node":"DATOS_PACIENTE REGISTRADO","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"Structured Output Parser","type":"ai_languageModel","index":0}]]},"POST_PACIENTE":{"main":[[{"node":"error servidor","type":"main","index":0}]]},"DATOS_PACIENTE REGISTRADO":{"main":[[{"node":"STATUS=PACIENTE_NUEVO","type":"main","index":0}]]},"Error informacion de usuario1":{"main":[[{"node":"‚ö†Ô∏è DATOS INCORRECTOS1","type":"main","index":0}],[{"node":"POST_PACIENTE","type":"main","index":0}]]},"‚ö†Ô∏è DATOS INCORRECTOS1":{"main":[[{"node":"STATUS=PACIENTE_NUEVO1","type":"main","index":0}]]},"AI Agent1":{"main":[[{"node":"Error informacion de usuario1","type":"main","index":0}]]},"Structured Output Parser":{"ai_outputParser":[[{"node":"AI Agent1","type":"ai_outputParser","index":0}]]},"Redis Chat Memory1":{"ai_memory":[[{"node":"AI Agent1","type":"ai_memory","index":0}]]},"no_encontrado?":{"main":[[{"node":"‚ö†Ô∏è DATOS INCORRECTOS2","type":"main","index":0}],[{"node":"‚úÖ DATOS VALIDADOS","type":"main","index":0}]]},"‚ö†Ô∏è DATOS INCORRECTOS2":{"main":[[{"node":"DATO_INCORRECTO1","type":"main","index":0}]]},"PACIENTE":{"main":[[{"node":"üîç Get Estado Actual","type":"main","index":0}]]},"matricula":{"main":[[{"node":"DATOS_PACIENTE_REGISTRADO","type":"main","index":0}]]},"get_turnos_agendados2":{"main":[[{"node":"datos3","type":"main","index":0}]]},"datos3":{"main":[[{"node":"üìã LISTAR TURNOS1","type":"main","index":0}]]},"üìã LISTAR TURNOS1":{"main":[[{"node":"MIS TURNOS2","type":"main","index":0}]]},"GET_PACIENTE1":{"main":[[{"node":"get_turnos_agendados2","type":"main","index":0}]]},"error servidor":{"main":[[],[{"node":"‚úÖ DATOS VALIDADOS3","type":"main","index":0}]]},"DATOS_TURNO":{"main":[[{"node":"üìÖ Horarios Proximos","type":"main","index":0}]]},"If2":{"main":[[],[{"node":"ü©∫ ESPECIALIDADES","type":"main","index":0}]]},"ESPECIALIDAD":{"main":[[{"node":"PACIENTE","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","timezone":"America/Argentina/Buenos_Aires","callerPolicy":"workflowsFromSameOwner"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"94d861f6-2108-48d4-99c5-728e6aa91749","triggerCount":1,"shared":[{"createdAt":"2025-10-27T11:07:42.590Z","updatedAt":"2025-10-27T11:07:42.590Z","role":"workflow:owner","workflowId":"o9rLeUkItUVZNKxd","projectId":"R66ikVn5xqf0nYcA"}],"tags":[{"createdAt":"2025-10-18T05:48:24.047Z","updatedAt":"2025-10-18T05:48:24.047Z","id":"9MPkCQDvT4HFCUIK","name":"ClinicAI-v1.33"}]}