{"createdAt":"2025-07-08T04:17:51.396Z","updatedAt":"2025-10-08T12:07:14.683Z","id":"H4tsNj9SnsCxET4y","name":"ICLP - Subflujo_Tomar_Turno","active":false,"isArchived":false,"nodes":[{"parameters":{"workflowInputs":{"values":[{"name":"dni","type":"any"},{"name":"fecha","type":"any"},{"name":"medico"},{"name":"hora","type":"any"},{"name":"nombre_completo","type":"any"},{"name":"celular_paciente","type":"any"},{"name":"obraSocial"}]}},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-592,0],"id":"528c5881-8421-4b22-b58c-e7d734fb253f","name":"When Executed by Another Workflow"},{"parameters":{"method":"POST","url":"http://iclp.ddns.net:7080/ws-turnos-rest-simple/api/turnos/tomar-turno","sendQuery":true,"queryParameters":{"parameters":[{"name":"usuario","value":"WSTRRED"},{"name":"password","value":"Y2xpb25lcw"},{"name":"canal","value":"whatsapp"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"dni\": \"{{ $('When Executed by Another Workflow').item.json.dni }}\",\n  \"celular\": \"{{ $('When Executed by Another Workflow').item.json.celular_paciente }}\",\n  \"obraSocial\": \"{{ $('When Executed by Another Workflow').item.json.obraSocial }}\",\n  \"nombrePaciente\": \"{{ $('When Executed by Another Workflow').item.json.nombre_completo }}\",\n  \"fecha\":{{ new Date(`${$('When Executed by Another Workflow').item.json.fecha.slice(0,4)}-${$('When Executed by Another Workflow').item.json.fecha.slice(4,6)}-${$('When Executed by Another Workflow').item.json.fecha.slice(6,8)}T00:00:00-03:00`).getTime() }},\n  \"hora\": \"{{ $('When Executed by Another Workflow').item.json.hora }}\",\n  \"matricula\": {{$json.Matricula}},\n  \"sexo\": \"\",\n  \"estudios\": \"\",\n  \"equipo\": \"3\"\n}\n\n","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[416,0],"id":"1ab06ad5-5bfe-4953-8ec5-5a13565116e8","name":"HTTP Request"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"0469c9e6-ac9e-4b2a-a963-b76c834a5d4e","leftValue":"={{ $json.paciente }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}},{"id":"adfd5e8d-c1d3-4f93-8c70-b8ff7ba1fd7e","leftValue":"={{ $json.matricula }}","rightValue":"","operator":{"type":"number","operation":"exists","singleValue":true}},{"id":"59728643-bfea-4690-8b07-36a7c253e7dd","leftValue":"={{ $json.fecha }}","rightValue":"","operator":{"type":"number","operation":"exists","singleValue":true}},{"id":"e5277749-e586-4de3-8486-dd9f089afc34","leftValue":"={{ $json.hora }}","rightValue":"","operator":{"type":"dateTime","operation":"exists","singleValue":true}},{"id":"279edefe-91e0-432b-9149-5457936df49b","leftValue":"={{ $json.matFeHo }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}},{"id":"1bf9ca64-901e-4c95-b991-81a1055b214f","leftValue":"={{ $json.hora5digitos }}","rightValue":"","operator":{"type":"dateTime","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[640,0],"id":"5cfc5065-86bd-4cbf-b466-54d4dcfc1051","name":"Filter"},{"parameters":{"aggregate":"aggregateAllItemData","destinationFieldName":"turno_agendado","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[1056,0],"id":"72b7bda1-5032-4dbf-aadc-4b1daa86c2c5","name":"Aggregate"},{"parameters":{"assignments":{"assignments":[{"id":"33114951-3c4e-4a2f-b999-b06c07566240","name":"=fecha_y_hora","value":"=El dia {{ DateTime.fromMillis($json.fecha, { zone: 'utc' }).setZone('America/Buenos_Aires').toFormat('yyyy-MM-dd') }} a las {{ $json.hora }}","type":"string"},{"id":"8ebccc91-ecde-4e8f-8c40-57c2a6aad62f","name":"paciente","value":"={{ $json.paciente }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[832,0],"id":"dc151703-4dcc-45ed-940a-7dc3faade9e5","name":"Edit Fields1"},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"mhwp4qt6r2d7ymm","limit":1,"options":{"where":"=OR(\n  (Medico,like,%{{ $json.salida_unificada }}%),\n  (Medico,like,%{{ $json.variante_respaldo }}%)\n)"}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[208,0],"id":"1a05f3c0-9e23-48bf-a48c-387173567e5f","name":"Get many rows","alwaysOutputData":true,"credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}}},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"mhwp4qt6r2d7ymm","returnAll":true,"options":{"where":""}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[-336,-480],"id":"b7d4b689-6020-4265-a761-056204d8399b","name":"Get many rows1","credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}},"disabled":true},{"parameters":{"text":"={{ $json.medico }}","schemaType":"fromJson","jsonSchemaExample":"{\n\t\"nombre\": \"Fabian\",\n\t\"apellido\": \"Barba\"\n}","options":{"systemPromptTemplate":"=You are a precise information extraction tool.\n\nSTRICT RULES:\n- Extract ONLY information that is literally written in the text\n- DO NOT create, invent, or assume any data\n- If you don't see a clear first name, set nombre as empty \"\"\n- If you don't see a clear last name, set apellido as empty \"\"\n- When in doubt, leave it empty\n\nExtract from this text: \"{{ $json.medico }}\"\n\nFields to extract (only if explicitly present):\n- nombre: \"\"\n- apellido: \"\"\n\n"}},"type":"@n8n/n8n-nodes-langchain.informationExtractor","typeVersion":1.2,"position":[-384,0],"id":"10aa8759-2c53-42e2-9923-8af41e5c904c","name":"Information Extractor"},{"parameters":{"model":"openai/gpt-4.1","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[-336,224],"id":"e88016e4-f1cb-46e8-b994-500c37681226","name":"OpenRouter Chat Model","credentials":{"openRouterApi":{"id":"ZlcbniUoDvrFqCIJ","name":"OpenRouter ICLP"}}},{"parameters":{"jsCode":"// âœ… CÃ“DIGO MEJORADO: Case-insensitive + siempre invierte para casos simples\nconst inputData = $input.first().json.output;\nconst nombre = inputData?.nombre?.trim() || '';\nconst apellido = inputData?.apellido?.trim() || '';\n\nlet resultado;\nlet variante_respaldo;\n\nif (nombre && apellido) {\n    const palabrasNombre = nombre.split(' ');\n    const palabrasApellido = apellido.split(' ');\n    const totalPalabras = palabrasNombre.length + palabrasApellido.length;\n    \n    console.log(`ðŸ“ Analizando: \"${nombre}\" (${palabrasNombre.length}) + \"${apellido}\" (${palabrasApellido.length})`);\n    \n    if (totalPalabras === 2) {\n        // Para casos simples (2 palabras), SIEMPRE invertir como principal\n        resultado = `${apellido} ${nombre}`.toUpperCase();\n        variante_respaldo = `${nombre} ${apellido}`.toUpperCase();\n        console.log(`ðŸ”„ Caso simple, invirtiendo: \"${resultado}\"`);\n        \n    } else if (palabrasNombre.length > palabrasApellido.length) {\n        // MÃ¡s palabras en nombre â†’ invertir\n        resultado = `${apellido} ${nombre}`.toUpperCase();\n        variante_respaldo = `${nombre} ${apellido}`.toUpperCase();\n        console.log(`ðŸ”„ MÃ¡s palabras en nombre: \"${resultado}\"`);\n        \n    } else if (palabrasApellido.length > palabrasNombre.length) {\n        // MÃ¡s palabras en apellido â†’ invertir\n        resultado = `${apellido} ${nombre}`.toUpperCase();\n        variante_respaldo = `${nombre} ${apellido}`.toUpperCase();\n        console.log(`ðŸ”„ MÃ¡s palabras en apellido: \"${resultado}\"`);\n        \n    } else {\n        // Casos complejos â†’ mantener + generar variante\n        resultado = `${nombre} ${apellido}`.toUpperCase();\n        variante_respaldo = `${apellido} ${nombre}`.toUpperCase();\n        console.log(`ðŸ¤” Caso complejo: \"${resultado}\"`);\n    }\n} else if (apellido) {\n    resultado = apellido.toUpperCase();\n    variante_respaldo = apellido.toUpperCase();\n} else if (nombre) {\n    resultado = nombre.toUpperCase();\n    variante_respaldo = nombre.toUpperCase();\n} else {\n    resultado = '';\n    variante_respaldo = '';\n}\n\nreturn {\n    salida_unificada: resultado,\n    variante_respaldo: variante_respaldo,\n    debug_info: {\n        palabras_nombre: nombre ? nombre.split(' ').length : 0,\n        palabras_apellido: apellido ? apellido.split(' ').length : 0,\n        total_palabras: (nombre ? nombre.split(' ').length : 0) + (apellido ? apellido.split(' ').length : 0)\n    }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-32,0],"id":"78a75fb0-dd91-422a-98ad-91e96cb172b1","name":"Code"},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wfe9btuw","projectId":"p304m8tufpug3oy","table":"mhwp4qt6r2d7ymm","limit":1,"options":{"where":"=(Medico,like,%{{ $json.salida_unificada }}%)"}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[-576,-480],"id":"04c5cea5-fe85-4dcb-9b92-2283a5aef64b","name":"Get many rows2","alwaysOutputData":true,"credentials":{"nocoDbApiToken":{"id":"CERoQkqIgqq5Hzwe","name":"ICLP_MEDICOS"}},"disabled":true}],"connections":{"When Executed by Another Workflow":{"main":[[{"node":"Information Extractor","type":"main","index":0}]]},"HTTP Request":{"main":[[{"node":"Filter","type":"main","index":0}]]},"Edit Fields1":{"main":[[{"node":"Aggregate","type":"main","index":0}]]},"Filter":{"main":[[{"node":"Edit Fields1","type":"main","index":0}]]},"Get many rows":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]},"OpenRouter Chat Model":{"ai_languageModel":[[{"node":"Information Extractor","type":"ai_languageModel","index":0}]]},"Information Extractor":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"Get many rows","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"When Executed by Another Workflow":[{"json":{"dni":42028075,"fecha":"20251009","medico":"GENOVESI","hora":"1000","nombre_completo":"Nicolas Matias Lopez","celular_paciente":"+5492213994411","obraSocial":"SANCOR"}}]},"versionId":"a97d7952-ce0e-438a-b25a-5ae7b2e32f91","triggerCount":0,"shared":[{"createdAt":"2025-07-08T04:17:51.396Z","updatedAt":"2025-07-08T04:17:51.396Z","role":"workflow:owner","workflowId":"H4tsNj9SnsCxET4y","projectId":"R66ikVn5xqf0nYcA"}],"tags":[]}