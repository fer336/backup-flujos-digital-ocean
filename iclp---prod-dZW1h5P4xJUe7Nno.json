{"createdAt":"2025-06-23T21:22:09.904Z","updatedAt":"2025-06-25T18:35:22.042Z","id":"dZW1h5P4xJUe7Nno","name":"ICLP - PROD","active":false,"isArchived":false,"nodes":[{"parameters":{"assignments":{"assignments":[{"id":"bb31dc82-ebb8-4bca-bd8d-6b4760085673","name":"texto","value":"={{ $json.messages[0].text.body }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-100,1020],"id":"ebbd1360-fc52-4639-b8d9-9a80efae6702","name":"prompt_usuario_texto"},{"parameters":{"content":"## Recibe audio y lo transcribe\n","height":280,"width":840},"type":"n8n-nodes-base.stickyNote","position":[-690,700],"typeVersion":1,"id":"be739b19-f38b-4196-afdc-8f3c0b924b61","name":"Sticky Note"},{"parameters":{"assignments":{"assignments":[{"id":"bb31dc82-ebb8-4bca-bd8d-6b4760085673","name":"texto","value":"={{ $json.text }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-100,820],"id":"98d23607-9c68-44da-a265-3f9d0424ef6a","name":"prompt_usuario_audio"},{"parameters":{"content":"## Encolamiento de los mensajes","height":440,"width":1760,"color":5},"type":"n8n-nodes-base.stickyNote","position":[60,740],"typeVersion":1,"id":"9cf51b09-f59c-447e-8cde-38c9e145f594","name":"Sticky Note2"},{"parameters":{"name":"Flujo_padron","description":"Verifica si un paciente está registrado en el padrón médico mediante su DNI. Si no lo está, permite empadronarlo enviando nombre completo, DNI, obra social y teléfono. Usá esta herramienta en cualquier momento en que necesites validar si el paciente ya existe en el sistema.","workflowId":{"__rl":true,"value":"PfHIjdYRDTDUDBcT","mode":"list","cachedResultName":"ICLP - PROD - Agente_Padron"},"workflowInputs":{"mappingMode":"defineBelow","value":{"texto":"={{ $json.texto }}","user_id":"={{ $json.user_id }}","session":"={{ $json.session }}"},"matchingColumns":[],"schema":[{"id":"texto","displayName":"texto","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"session","displayName":"session","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"object","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.1,"position":[2120,1040],"id":"73936fe3-c1bd-4743-950c-7a2f3c1cc345","name":"Flujo_padron"},{"parameters":{"name":"flujo_especialidades_y_horarios","description":"=Devuelve las especialidades disponibles, los médicos correspondientes a cada especialidad y los horarios para cada médico. Usá esta herramienta para guiar al paciente paso a paso en la selección del turno: primero la especialidad, luego el médico, y por último el horario.","workflowId":{"__rl":true,"value":"WspJSa1Hb0Nj9WCn","mode":"list","cachedResultName":"ICLP - PROD - Agente_Medico"},"workflowInputs":{"mappingMode":"defineBelow","value":{"texto":"={{ $json.texto }}","user_id":"={{ $json.user_id }}","session":"={{ $json.session }}"},"matchingColumns":[],"schema":[{"id":"texto","displayName":"texto","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"session","displayName":"session","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"object"}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.1,"position":[2240,1040],"id":"09ac1bce-cb06-4f8d-a95a-8eaab63e5ca7","name":"flujo_especialidades_y_horarios"},{"parameters":{"name":"flujo_cancelar_reprogramar_turnos","description":"Permite cancelar un turno médico existente o solicitar uno nuevo si el paciente quiere reprogramar. Usá esta herramienta si el usuario menciona que desea cancelar o cambiar un turno.","workflowId":{"__rl":true,"value":"OZfHxE3wPYJxfNzP","mode":"list","cachedResultName":"ICLP - PROD - Agente cancela_reprograma_turnos"},"workflowInputs":{"mappingMode":"defineBelow","value":{"texto":"={{ $json.texto }}","user_id":"={{ $json.user_id }}","session":"={{ $json.session }}"},"matchingColumns":[],"schema":[{"id":"texto","displayName":"texto","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"session","displayName":"session","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"object","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.1,"position":[2360,1040],"id":"ce4ad40a-1db3-4d97-89a5-6067e4aeb35f","name":"flujo_cancelar_reprogramar_turnos"},{"parameters":{"promptType":"define","text":"={{ $json.texto }}","options":{"systemMessage":"=# Descripción general\nSos el asistente médico principal de ICLP. Tu trabajo es guiar al paciente a través del proceso de gestión de turnos médicos, de forma profesional, paso a paso, y con memoria persistente.\n\n## Información del usuario\n•⁠  ⁠ID: {{ $json.user_id }}\n•⁠  ⁠Mensaje actual: {{ $json.texto }}\n\n## Contexto de memoria disponible\n{{ JSON.stringify($json.memoria) }}\n\n## Análisis del mensaje actual\nEl usuario dice: \"{{ $json.texto }}\"\n\n## Herramientas disponibles (agentes)\n•⁠  ⁠*Flujo_padron*: Verifica si el paciente está empadronado o lo registra si no lo está.\n•⁠  ⁠*flujo_especialidades_y_horarios*: Devuelve especialidades, médicos y horarios disponibles.\n•⁠  ⁠*Flujo_tomar_turno*: Toma un turno médico, una vez confirmados todos los datos.\n•⁠  ⁠*flujo_cancelar_reprogramar_turnos*: Cancela o reprograma turnos existentes.\n\n## Reglas de uso de herramientas\n•⁠  ⁠SIEMPRE usa las herramientas disponibles, NO respondas solo con texto\n•⁠  ⁠Después de verificar padrón → LLAMA a flujo_especialidades_y_horarios\n•⁠  ⁠Después de seleccionar médico → LLAMA a Flujo_tomar_turno\n•⁠  ⁠NO hagas preguntas que las herramientas pueden resolver\n\n## Flujo obligatorio\n1.⁠ ⁠Usuario pide turno → Llama Flujo_padron\n2.⁠ ⁠Padrón confirmado → Llama flujo_especialidades_y_horarios \n3.⁠ ⁠Médico seleccionado → Llama Flujo_tomar_turno\n\n## Instrucciones inteligentes\n1.⁠ ⁠*ANALIZAR INTENCIÓN*: Si el usuario menciona una especialidad específica (como \"cardiólogo\"), NO preguntes por especialidades\n2.⁠ ⁠*DETECTAR DNI*: Si el usuario proporciona su DNI, úsalo directamente\n3.⁠ ⁠*FLUJO DIRECTO*: Si el usuario dice \"quiero un turno de cardiología con DNI X\", ve directo al flujo de padrón\n4.⁠ ⁠*SER EFICIENTE*: No hagas preguntas innecesarias si ya tienes la información\n\n## Reglas específicas\n•⁠  ⁠Si el usuario dice \"quiero un cardiólogo\" → Llama directamente a Flujo_padron\n•⁠  ⁠Si el usuario da su DNI → Usa esa información\n•⁠  ⁠Si el usuario es específico → Sé específico en tu respuesta\n•⁠  ⁠Revisa la memoria para entender el contexto de conversaciones anteriores\n\n## Contexto temporal\nFecha y hora actual: {{ new Date().toLocaleString('es-AR', { timeZone: 'America/Argentina/Buenos_Aires' }) }}"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.9,"position":[2152,820],"id":"cf2554bd-b1a5-4e2c-97fe-6cea0c8c8e8e","name":"Agente Padre"},{"parameters":{"assignments":{"assignments":[{"id":"extract_next_step","name":"next_step","value":"={{ $json.output.includes('DNI') ? 'solicitando_dni' : $json.output.includes('especialidad') ? 'solicitando_especialidad' : $json.output.includes('médico') ? 'seleccionando_medico' : $json.output.includes('horario') ? 'seleccionando_horario' : 'inicio' }}","type":"string"},{"id":"response_text","name":"response","value":"={{ $json.output }}","type":"string"},{"id":"user_id_pass","name":"user_id","value":"={{ $('combinar_contexto_conversacion').item.json.user_id }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[2800,820],"id":"824476c5-fb9f-44b4-82b3-59420c890aa9","name":"Extraer respuesta agente"},{"parameters":{"operation":"set","key":"=session:{{ $json.user_id }}","value":"={\n  \"step\": \"{{ $json.next_step }}\",\n  \"paciente_tipo\": \"{{ $('combinar_contexto_conversacion').item.json.session.paciente_tipo }}\",\n  \"datos_recopilados\": {{ JSON.stringify($('combinar_contexto_conversacion').item.json.session.datos_recopilados) }},\n  \"last_update\": \"{{ new Date().toISOString() }}\",\n  \"last_message\": \"{{ $json.response }}\"\n}","expire":true,"ttl":7200},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3020,820],"id":"0ddc4dd1-c7e1-4b1c-bd62-1feb0cdff394","name":"Guardar estado actualizado","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"push","list":"=memoria:{{ $json.user_id }}","messageData":"={\n  \"timestamp\": \"{{ new Date().toISOString() }}\",\n  \"role\": \"assistant\",\n  \"message\": \"{{ $json.response }}\",\n  \"step\": \"{{ $json.next_step }}\"\n}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3240,820],"id":"acbd17f5-8dc2-43f4-8e78-5b2c0f8de3c1","name":"Guardar respuesta bot en memoria","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"=debounce:{{ $json.user_id }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3460,820],"id":"07486f1b-6720-4a34-87aa-23eb5c4dfdc4","name":"Limpiar debounce","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"assignments":{"assignments":[{"id":"47528d62-f62d-4075-88bf-21080a9cb4dd","name":"text","value":"={{ $json.texto }}","type":"string"},{"id":"8dccd291-4ef0-4d9a-81a7-e40b301f7a52","name":"from","value":"={{ $('filtra_mensajes_por_categoria').item.json.messages[0].from }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[120,920],"id":"2a572714-6048-4e9c-ac07-ff9b3292cf66","name":"preparar_datos_entrada"},{"parameters":{"amount":10},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[560,820],"id":"8a2b1eca-3c12-4dc0-8bda-ddb777b5d247","name":"debounce_mensajes","webhookId":"68eb6c62-037a-4216-9429-92ec7ea2fc7d"},{"parameters":{"operation":"set","key":"=debounce:{{ $('entrada_mensaje').item.json.contacts[0].wa_id }}","value":"={{ $('preparar_datos_entrada').item.json.text }}","expire":true,"ttl":15},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[340,820],"id":"e591c372-7f3b-4c5a-af48-6834cf313be9","name":"almacenar_debounce","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"get","key":"=debounce:{{ $('preparar_datos_entrada').item.json.from }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[780,820],"id":"8abef100-943f-49f4-948e-8aba025fb8bc","name":"obtener_todos_los_mensajes","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"push","list":"=memoria:{{ $('entrada_mensaje').item.json.contacts[0].wa_id }}","messageData":"={\n  \"timestamp\": \"{{ new Date().toISOString() }}\",\n  \"role\": \"user\",\n  \"message\": \"{{ $('preparar_datos_entrada').item.json.text }}\",\n  \"from\": \"{{ $('entrada_mensaje').item.json.contacts[0].wa_id }}\",\n  \"message_id\": \"{{ $('entrada_mensaje').item.json.messages[0].id }}\"\n}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[340,1020],"id":"ff166125-f4ef-405d-b97d-1d57bc85c6e7","name":"almacenar_memoria","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"memoria_completa","key":"=memoria:{{ $('preparar_datos_entrada').item.json.from }}","keyType":"list","options":{"dotNotation":"={{ false }}"}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1220,820],"id":"98a5af70-750d-4aaf-82bf-e02c050bd23d","name":"obtener_memoria_conversacional","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"estado_sesion","key":"=session:{{ $('preparar_datos_entrada').item.json.from }}","keyType":"string","options":{"dotNotation":false}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1440,820],"id":"c569632e-7cce-4d7a-9dc8-ceedd7f526b8","name":"obtener_estado_sesión","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"debounce_check","leftValue":"={{ $('obtener_todos_los_mensajes').item.json }}","rightValue":"={{ $('preparar_datos_entrada').item.json.text }}","operator":{"type":"string","operation":"notEquals"}}],"combinator":"and"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[1000,820],"id":"dbce308b-546e-40aa-bb0f-489ae513a99a","name":"filtro_anti_duplicados"},{"parameters":{"assignments":{"assignments":[{"id":"texto_actual","name":"texto","value":"={{ $('preparar_datos_entrada').item.json.text }}","type":"string"},{"id":"memoria_completa","name":"memoria","value":"={{ $('obtener_memoria_conversacional').item.json }}","type":"object"},{"id":"estado_sesion","name":"session","value":"={{ $('obtener_estado_sesión').item.json || {\"step\": \"inicio\", \"paciente_tipo\": \"unknown\", \"datos_recopilados\": {}, \"conversacion_iniciada\": new Date().toISOString()} }}","type":"object"},{"id":"usuario_id","name":"user_id","value":"={{ $('preparar_datos_entrada').item.json.from }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1660,820],"id":"da10df3a-8142-4db8-b13e-26cf270d3e44","name":"combinar_contexto_conversacion"},{"parameters":{},"type":"@n8n/n8n-nodes-langchain.toolThink","typeVersion":1,"position":[2480,1040],"id":"3d4ae2c4-637f-4126-a0d3-ad05be1cd9cf","name":"Think"},{"parameters":{"name":"tomar_turno","description":"Permite confirmar un nuevo turno médico o consultar los turnos actuales del paciente. Usá esta herramienta cuando el paciente quiera agendar un nuevo turno (con todos los datos completos) o si solicita ver sus turnos ya asignados.","workflowId":{"__rl":true,"value":"sI7zELyP7TRD6fda","mode":"list","cachedResultName":"ICLP - PROD - Agente_tomar_turno"},"workflowInputs":{"mappingMode":"defineBelow","value":{"texto":"={{ $json.texto }}","user_id":"={{ $json.user_id }}","session":"={{ $json.session }}"},"matchingColumns":[],"schema":[{"id":"texto","displayName":"texto","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"session","displayName":"session","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"object","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.1,"position":[2600,1040],"id":"c87008b4-8d88-45d0-a1f9-e52b43c0ec56","name":"Flujo_tomar_turno"},{"parameters":{"name":"consultar_turnos_actuales","description":"Consulta los turnos actuales de un paciente mediante su DNI. Requiere dni (string sin puntos ni guiones). Devuelve una lista de turnos con fecha, hora, matrícula, médico y especialidad. Úsalo SIEMPRE antes de cancelar para obtener los datos exactos del turno.","workflowId":{"__rl":true,"value":"2Gh0G9J0ZSFdG4pD","mode":"list","cachedResultName":"ICLP - Consultar Turnos Actuales"},"workflowInputs":{"mappingMode":"defineBelow","value":{"dni":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('dni', ``, 'string') }}","fecha":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fecha', ``, 'string') }}"},"matchingColumns":[],"schema":[{"id":"dni","displayName":"dni","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"fecha","displayName":"fecha","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.1,"position":[-1860,1430],"id":"0cc5fbb1-e6a9-4354-a9a2-968e21e4170b","name":"flujo_consultar_turnos"},{"parameters":{"model":{"__rl":true,"value":"gpt-4.1-nano","mode":"list","cachedResultName":"gpt-4.1-nano"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[1880,1040],"id":"2630446b-9d8f-4b81-be27-90a04fc3e99d","name":"LLM - 4.1 - Nano","credentials":{"openAiApi":{"id":"mE1IL02M9AnIg3tD","name":"OpenAi Credenciales ICLP"}}},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Variables').item.json.whatsapp }}_historial_{{ $('Variables').item.json.nombre_negocio }}","contextWindowLength":10},"type":"@n8n/n8n-nodes-langchain.memoryRedisChat","typeVersion":1.5,"position":[2000,1040],"id":"234dbd9e-1f2d-4cb9-8064-e20184f71b89","name":"Historial","credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[3900,820],"id":"2c163243-fac4-4129-b6ce-8ea0d864cae9","name":"1 mensaje a la vez"},{"parameters":{"jsCode":"// Importar texto completo\nlet texto = $('Agente multimedia').first().json.output.salida;\n\n// Dividir texto si es necesario\nlet mensaje = texto.split(\"\\n\\n\").map(item => ({ mensaje: item }));\n\n// Devolver mensajes\nreturn mensaje"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3680,820],"id":"a0ebbe11-c194-4e06-8d2d-11d3ffa0a138","name":"Dividir texto"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fee09f3c-637a-4864-a7ed-1af87e72e30f","leftValue":"={{ $('Variables1').item.json.whatsapp }}","rightValue":"@g.us","operator":{"type":"string","operation":"notContains"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[-980,1095],"id":"5d281a38-9408-4245-9761-71a505d2b7d0","name":"Filtrar solo grupos"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('Variables1').item.json.mensaje_tipo }}","rightValue":"conversation","operator":{"type":"string","operation":"equals"},"id":"a14a0e87-4dc6-4b6b-b5c9-130df82cffb1"}],"combinator":"and"},"renameOutput":true,"outputKey":"texto"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c52c071e-3b41-4c1a-a29c-2d6205df78f1","leftValue":"={{ $('Variables1').item.json.mensaje_tipo }}","rightValue":"audioMessage","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"audio"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"76581f1f-514d-48b7-8f14-3700188cf9ba","leftValue":"={{ $('Variables1').item.json.mensaje_tipo }}","rightValue":"imageMessage","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"imagen"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"ff59f6c2-f2a4-4344-8d6e-5b6c68db58f1","leftValue":"={{ $('Variables1').item.json.mensaje_tipo }}","rightValue":"reactionMessage","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"reacción"}]},"options":{"fallbackOutput":"extra","renameFallbackOutput":"otro"}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-760,978],"id":"d322d382-7e43-43b5-8aa5-ea12ced688fc","name":"Tipo de mensaje"},{"parameters":{"queue":"variable_nombre_de_negocio.messages.upsert","options":{"acknowledge":"executionFinishesSuccessfully","durable":true,"jsonParseBody":true,"onlyContent":false}},"type":"n8n-nodes-base.rabbitmqTrigger","typeVersion":1,"position":[-1860,460],"id":"572533ff-1aa3-4354-bd21-22f7bbbc9bba","name":"Consumir fila1","credentials":{"rabbitmq":{"id":"KqX6qjNf9AdWDKxu","name":"RabbitMQ account"}}},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-540,1170],"id":"86d3a00f-a676-4ac6-ad8f-2224fc85d78e","name":"No Operation, do nothing1"},{"parameters":{"operation":"toBinary","sourceProperty":"data.base64","options":{}},"type":"n8n-nodes-base.convertToFile","typeVersion":1.1,"position":[-540,820],"id":"dc55434d-6615-4e55-8c21-faf216334ade","name":"Audio a binario"},{"parameters":{"resource":"audio","operation":"transcribe","options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[-320,820],"id":"72c1944d-b70c-419e-a7ac-29fed14b0246","name":"Transcribir audio","credentials":{"openAiApi":{"id":"mE1IL02M9AnIg3tD","name":"OpenAi Credenciales ICLP"}}},{"parameters":{"httpMethod":"POST","path":"nicotest","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1860,895],"id":"e6d4f85d-c7ab-4a46-a6a1-9915cf9836cf","name":"Webhook","webhookId":"d5c2bece-2323-4d9b-9115-70cfc9683afa"},{"parameters":{"assignments":{"assignments":[{"id":"915e8cae-80aa-4564-9b03-fc7936051b50","name":"evolution_url","value":"={{ $('Mensaje de entrada').item.json.body.server_url }}","type":"string"},{"id":"b1fac4cf-b394-40a4-a53e-6c1c8b0781a9","name":"evolution_instancia","value":"={{ $('Mensaje de entrada').item.json.body.instance }}","type":"string"},{"id":"d12ad259-1d61-490f-a383-aa0294f60752","name":"whatsapp","value":"=+{{ $('Mensaje de entrada').item.json.body.data.key.remoteJid.replaceAll(\"@s.whatsapp.net\",\"\") }}","type":"string"},{"id":"693e89ee-a42d-481a-980c-9fc813bb07bb","name":"enviado_por_mi","value":"={{ $('Mensaje de entrada').item.json.body.data.key.fromMe }}","type":"boolean"},{"id":"443aa937-5454-4f65-845b-344b8da65528","name":"mensaje_id","value":"={{ $('Mensaje de entrada').item.json.body.data.key.id }}","type":"string"},{"id":"a21e5305-570c-4153-8b22-b2d56d1f21ee","name":"mensaje_texto","value":"={{ $('Mensaje de entrada').item.json.body.data.message.conversation }}","type":"string"},{"id":"4d471303-5393-4ca4-a3bc-c6177b90812f","name":"mensaje_tipo","value":"={{ $('Mensaje de entrada').item.json.body.data.messageType }}","type":"string"},{"id":"70b3ac3c-1aeb-48a5-991c-6278f58a1ae4","name":"mensaje_reaccion","value":"={{ $('Mensaje de entrada').item.json.body.data.message.reactionMessage.text }}","type":"string"},{"id":"c4b4860b-27e5-4e10-821c-58c97382ec0a","name":"imagen_texto","value":"={{ $('Mensaje de entrada').item.json.body.data.message.imageMessage.caption }}","type":"string"},{"id":"be5f497b-c00c-4843-9d1f-02926b0cf077","name":"nombre_negocio","value":"iclp","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1420,895],"id":"9a2c2f91-583a-4eab-b66e-fba989cca675","name":"seteo_variables"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fee09f3c-637a-4864-a7ed-1af87e72e30f","leftValue":"={{ $('seteo_variables').item.json.whatsapp }}","rightValue":"+5492213994411","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"f93b5d30-5d64-436f-a4b2-766fac9338b1","leftValue":"={{ $('seteo_variables').item.json.whatsapp }}","rightValue":"+34695208760","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"or"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[-980,895],"id":"8938823e-220a-4c88-a9d4-569cd52d85d8","name":"Filtrar números de prueba1"},{"parameters":{"operation":"delete","key":"{{ $('Variables1').item.json.whatsapp }}_estado_bot_{{ $('Variables1').item.json.nombre_negocio }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-1200,895],"id":"2b182aa1-7069-48da-9f8a-1dd7b5b22bf0","name":"Resetear historial1","notesInFlow":false,"credentials":{"redis":{"id":"s0PM2Pw4qSCcT1SM","name":"Redis account"}}},{"parameters":{"keys":{"key":[{"currentKey":"content","newKey":"body"}]},"additionalOptions":{}},"type":"n8n-nodes-base.renameKeys","typeVersion":1,"position":[-1640,895],"id":"dc1432c3-3867-4974-9da5-8ba3de13b1d8","name":"Mensaje de entrada"}],"connections":{"prompt_usuario_texto":{"main":[[{"node":"preparar_datos_entrada","type":"main","index":0}]]},"prompt_usuario_audio":{"main":[[{"node":"preparar_datos_entrada","type":"main","index":0}]]},"Flujo_padron":{"ai_tool":[[{"node":"Agente Padre","type":"ai_tool","index":0}]]},"flujo_especialidades_y_horarios":{"ai_tool":[[{"node":"Agente Padre","type":"ai_tool","index":0}]]},"flujo_cancelar_reprogramar_turnos":{"ai_tool":[[{"node":"Agente Padre","type":"ai_tool","index":0}]]},"Agente Padre":{"main":[[{"node":"Extraer respuesta agente","type":"main","index":0}]]},"Extraer respuesta agente":{"main":[[{"node":"Guardar estado actualizado","type":"main","index":0}]]},"Guardar estado actualizado":{"main":[[{"node":"Guardar respuesta bot en memoria","type":"main","index":0}]]},"Guardar respuesta bot en memoria":{"main":[[{"node":"Limpiar debounce","type":"main","index":0}]]},"preparar_datos_entrada":{"main":[[{"node":"almacenar_debounce","type":"main","index":0},{"node":"almacenar_memoria","type":"main","index":0}]]},"debounce_mensajes":{"main":[[{"node":"obtener_todos_los_mensajes","type":"main","index":0}]]},"almacenar_debounce":{"main":[[{"node":"debounce_mensajes","type":"main","index":0}]]},"obtener_todos_los_mensajes":{"main":[[{"node":"filtro_anti_duplicados","type":"main","index":0}]]},"obtener_memoria_conversacional":{"main":[[{"node":"obtener_estado_sesión","type":"main","index":0}]]},"obtener_estado_sesión":{"main":[[{"node":"combinar_contexto_conversacion","type":"main","index":0}]]},"filtro_anti_duplicados":{"main":[[{"node":"obtener_memoria_conversacional","type":"main","index":0}]]},"combinar_contexto_conversacion":{"main":[[{"node":"Agente Padre","type":"main","index":0}]]},"Think":{"ai_tool":[[{"node":"Agente Padre","type":"ai_tool","index":0}]]},"Flujo_tomar_turno":{"ai_tool":[[{"node":"Agente Padre","type":"ai_tool","index":0}]]},"LLM - 4.1 - Nano":{"ai_languageModel":[[{"node":"Agente Padre","type":"ai_languageModel","index":0}]]},"Historial":{"ai_memory":[[{"node":"Agente Padre","type":"ai_memory","index":0}]]},"Dividir texto":{"main":[[{"node":"1 mensaje a la vez","type":"main","index":0}]]},"Limpiar debounce":{"main":[[{"node":"Dividir texto","type":"main","index":0}]]},"Filtrar solo grupos":{"main":[[{"node":"Tipo de mensaje","type":"main","index":0}]]},"Consumir fila1":{"main":[[]]},"Tipo de mensaje":{"main":[[{"node":"prompt_usuario_texto","type":"main","index":0}],[{"node":"Audio a binario","type":"main","index":0}],[{"node":"No Operation, do nothing1","type":"main","index":0}],[{"node":"No Operation, do nothing1","type":"main","index":0}],[{"node":"No Operation, do nothing1","type":"main","index":0}]]},"Audio a binario":{"main":[[{"node":"Transcribir audio","type":"main","index":0}]]},"Transcribir audio":{"main":[[{"node":"prompt_usuario_audio","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"Mensaje de entrada","type":"main","index":0}]]},"seteo_variables":{"main":[[{"node":"Resetear historial1","type":"main","index":0}]]},"Resetear historial1":{"main":[[{"node":"Filtrar números de prueba1","type":"main","index":0}]]},"Mensaje de entrada":{"main":[[{"node":"seteo_variables","type":"main","index":0}]]},"Filtrar números de prueba1":{"main":[[{"node":"Tipo de mensaje","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"82ed4769-4d03-4036-8a3f-4e2537116084","triggerCount":0,"shared":[{"createdAt":"2025-06-23T21:22:09.904Z","updatedAt":"2025-06-23T21:22:09.904Z","role":"workflow:owner","workflowId":"dZW1h5P4xJUe7Nno","projectId":"R66ikVn5xqf0nYcA"}],"tags":[]}